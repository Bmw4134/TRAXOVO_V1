{% extends "base.html" %} {% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">TRAXOVO System Administration Guide</h1>
        <div class="d-flex gap-2">
          <button
            class="btn btn-outline-primary"
            onclick="location.href='/api/system-health'"
          >
            <i class="fas fa-heartbeat"></i> System Health
          </button>
          <button class="btn btn-outline-success" onclick="exportSystemMap()">
            <i class="fas fa-download"></i> Export Guide
          </button>
        </div>
      </div>

      <!-- System Status Overview -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body">
              <h4 class="card-title">
                {{ system_overview.core_modules|length }}
              </h4>
              <p class="card-text">Active Modules</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body">
              <h4 class="card-title">
                {{ route_mapping.core_routes|length +
                route_mapping.billing_routes|length +
                route_mapping.admin_routes|length }}
              </h4>
              <p class="card-text">Total Routes</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body">
              <h4 class="card-title">
                {{ system_overview.data_sources|length }}
              </h4>
              <p class="card-text">Data Sources</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <h4 class="card-title">{{ generated_at }}</h4>
              <p class="card-text">Last Updated</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Tabs -->
      <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="overview-tab"
            data-bs-toggle="tab"
            data-bs-target="#overview"
            type="button"
          >
            System Overview
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="routes-tab"
            data-bs-toggle="tab"
            data-bs-target="#routes"
            type="button"
          >
            Route Mapping
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="features-tab"
            data-bs-toggle="tab"
            data-bs-target="#features"
            type="button"
          >
            Feature Guide
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="troubleshooting-tab"
            data-bs-toggle="tab"
            data-bs-target="#troubleshooting"
            type="button"
          >
            Troubleshooting
          </button>
        </li>
      </ul>

      <div class="tab-content" id="adminTabContent">
        <!-- System Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5>Core Modules</h5>
                </div>
                <div class="card-body">
                  {% for module_name, module_info in
                  system_overview.core_modules.items() %}
                  <div class="mb-3">
                    <h6>
                      {{ module_name }}
                      <span class="badge bg-success"
                        >{{ module_info.status }}</span
                      >
                    </h6>
                    <p class="text-muted">{{ module_info.description }}</p>
                    <small class="text-info"
                      >File: {{ module_info.file }}</small
                    >
                    {% if module_info.features %}
                    <div class="mt-1">
                      {% for feature in module_info.features %}
                      <span class="badge bg-light text-dark me-1"
                        >{{ feature }}</span
                      >
                      {% endfor %}
                    </div>
                    {% endif %}
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5>Data Sources</h5>
                </div>
                <div class="card-body">
                  {% for source_name, source_info in
                  system_overview.data_sources.items() %}
                  <div class="mb-3">
                    <h6>
                      {{ source_name }}
                      <span
                        class="badge bg-{{ 'success' if source_info.status == 'connected' else 'warning' }}"
                        >{{ source_info.status }}</span
                      >
                    </h6>
                    <p class="text-muted">{{ source_info.description }}</p>
                    {% if source_info.april_revenue %}
                    <div class="text-success">
                      April Revenue: ${{
                      "{:,.0f}".format(source_info.april_revenue) }}
                    </div>
                    {% endif %} {% if source_info.pm_drivers %}
                    <div class="text-info">
                      PM Drivers: {{ source_info.pm_drivers }} | EJ Drivers: {{
                      source_info.ej_drivers }}
                    </div>
                    {% endif %}
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Route Mapping Tab -->
        <div class="tab-pane fade" id="routes" role="tabpanel">
          <div class="row mt-4">
            {% for route_category, routes in route_mapping.items() %}
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h5>{{ route_category.replace('_', ' ').title() }}</h5>
                </div>
                <div class="card-body">
                  {% for route, description in routes.items() %}
                  <div class="mb-2">
                    <code class="text-primary">{{ route }}</code>
                    <br />
                    <small class="text-muted">{{ description }}</small>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Feature Guide Tab -->
        <div class="tab-pane fade" id="features" role="tabpanel">
          <div class="row mt-4">
            {% for guide_name, guide_info in feature_guide.items() %}
            <div class="col-md-6 mb-4">
              <div class="card">
                <div class="card-header">
                  <h5>{{ guide_info.title }}</h5>
                </div>
                <div class="card-body">
                  {% if guide_info.steps %}
                  <ol>
                    {% for step in guide_info.steps %}
                    <li>{{ step }}</li>
                    {% endfor %}
                  </ol>
                  {% endif %} {% if guide_info.formats_supported %}
                  <div class="mt-3">
                    <strong>Supported Formats:</strong>
                    {% for format in guide_info.formats_supported %}
                    <span class="badge bg-info me-1">{{ format }}</span>
                    {% endfor %}
                  </div>
                  {% endif %} {% if guide_info.commands %}
                  <div class="mt-3">
                    <strong>Voice Commands:</strong>
                    {% for command in guide_info.commands %}
                    <div><code>{{ command }}</code></div>
                    {% endfor %}
                  </div>
                  {% endif %} {% if guide_info.activation %}
                  <div class="mt-3">
                    <strong>Activation:</strong> {{ guide_info.activation }}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Troubleshooting Tab -->
        <div class="tab-pane fade" id="troubleshooting" role="tabpanel">
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5>Common Issues</h5>
                </div>
                <div class="card-body">
                  {% for issue_name, issue_info in
                  troubleshooting.common_issues.items() %}
                  <div class="mb-3">
                    <h6 class="text-danger">{{ issue_name }}</h6>
                    <p><strong>Symptoms:</strong> {{ issue_info.symptoms }}</p>
                    <p><strong>Solution:</strong> {{ issue_info.solution }}</p>
                    <p>
                      <strong>Escalation:</strong> {{ issue_info.escalation }}
                    </p>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5>Emergency Recovery</h5>
                </div>
                <div class="card-body">
                  {% for recovery_type, recovery_info in
                  troubleshooting.emergency_recovery.items() %}
                  <div class="mb-3">
                    <h6 class="text-warning">
                      {{ recovery_type.replace('_', ' ').title() }}
                    </h6>
                    {% if recovery_info.immediate_action %}
                    <p>
                      <strong>Immediate Action:</strong> {{
                      recovery_info.immediate_action }}
                    </p>
                    {% endif %} {% if recovery_info.restoration_steps %}
                    <ol>
                      {% for step in recovery_info.restoration_steps %}
                      <li>{{ step }}</li>
                      {% endfor %}
                    </ol>
                    {% endif %}
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function exportSystemMap() {
      const systemData = {
          generated_at: '{{ generated_at }}',
          core_modules: {{ system_overview.core_modules | tojson | safe }},
          routes: {{ route_mapping | tojson | safe }},
          features: {{ feature_guide | tojson | safe }}
      };

      const csvContent = generateSystemCSV(systemData);
      downloadCSV(csvContent, `TRAXOVO_System_Map_${new Date().toISOString().split('T')[0]}.csv`);
  }

  function generateSystemCSV(data) {
      let csv = 'TRAXOVO SYSTEM ADMINISTRATION GUIDE\n';
      csv += `Generated: ${data.generated_at}\n\n`;

      csv += 'CORE MODULES\n';
      csv += 'Module,Status,Description,File\n';
      Object.entries(data.core_modules).forEach(([name, info]) => {
          csv += `${name},${info.status},${info.description.replace(/,/g, ';')},${info.file}\n`;
      });

      csv += '\nROUTES\n';
      csv += 'Category,Route,Description\n';
      Object.entries(data.routes).forEach(([category, routes]) => {
          Object.entries(routes).forEach(([route, desc]) => {
              csv += `${category},${route},${desc.replace(/,/g, ';')}\n`;
          });
      });

      return csv;
  }

  function downloadCSV(csvContent, filename) {
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', filename);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      }
  }
</script>
{% endblock %}

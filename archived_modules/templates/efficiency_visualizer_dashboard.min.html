<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TRAXOVO Fleet Efficiency Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #1a1a1a;
        color: white;
        overflow-x: hidden;
      }
      .header {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }
      .header h1 {
        margin: 0;
        font-size: clamp(20px, 4vw, 28px);
        font-weight: 600;
      }
      .main-dashboard {
        padding: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }
      .efficiency-card {
        background: #2c3e50;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        border-left: 4px solid #27ae60;
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #27ae60;
      }
      .efficiency-score {
        font-size: 32px;
        font-weight: bold;
        color: #00ff88;
        text-align: center;
        margin: 15px 0;
      }
      .metric-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #34495e;
      }
      .metric-label {
        color: #bdc3c7;
        font-size: 14px;
      }
      .metric-value {
        color: #ecf0f1;
        font-weight: 500;
      }
      .chart-container {
        height: 300px;
        margin: 15px 0;
      }
      .category-list {
        max-height: 250px;
        overflow-y: auto;
      }
      .category-item {
        background: #34495e;
        padding: 12px;
        margin: 8px 0;
        border-radius: 6px;
        border-left: 4px solid #3498db;
      }
      .category-name {
        font-weight: bold;
        color: #3498db;
        margin-bottom: 5px;
      }
      .category-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 12px;
      }
      .progress-bar {
        width: 100%;
        height: 8px;
        background: #34495e;
        border-radius: 4px;
        overflow: hidden;
        margin: 5px 0;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #2ecc71);
        transition: width 0.5s ease;
      }
      .insights-panel {
        background: #27ae60;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }
      .insight-item {
        padding: 5px 0;
        font-size: 14px;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .main-dashboard {
          grid-template-columns: 1fr;
          padding: 15px;
        }
        .efficiency-card {
          padding: 15px;
        }
        .chart-container {
          height: 250px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>‚ö° TRAXOVO Fleet Efficiency Intelligence</h1>
      <p>
        Comprehensive performance analytics using your authentic operational
        data
      </p>
    </div>
    <div class="main-dashboard">
      <div class="efficiency-card">
        <div class="card-header">
          <div class="card-title">üéØ Overall Fleet Efficiency</div>
          <div id="lastUpdated" style="font-size: 12px; color: #95a5a6">
            Loading...
          </div>
        </div>
        <div class="efficiency-score" id="overallScore">--</div>
        <div class="metric-row">
          <span class="metric-label">Asset Utilization</span
          ><span class="metric-value" id="utilizationRate">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">GPS Coverage</span
          ><span class="metric-value" id="gpsEfficiency">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Revenue Performance</span
          ><span class="metric-value" id="revenueScore">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Job Site Productivity</span
          ><span class="metric-value" id="productivityScore">--</span>
        </div>
      </div>
      <div class="efficiency-card">
        <div class="card-header">
          <div class="card-title">üí∞ Revenue Efficiency</div>
        </div>
        <div class="metric-row">
          <span class="metric-label">Total Monthly Revenue</span
          ><span class="metric-value" id="totalRevenue">$--</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Revenue per Asset</span
          ><span class="metric-value" id="revenuePerAsset">$--</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">Revenue-Active Assets</span
          ><span class="metric-value" id="revenueActiveAssets">--</span>
        </div>
        <div class="progress-bar">
          <div
            class="progress-fill"
            id="revenueProgress"
            style="width: 0%"
          ></div>
        </div>
        <div style="text-align: center; font-size: 12px; margin-top: 5px">
          Industry Benchmark: $2,000/asset/month
        </div>
      </div>
      <div class="efficiency-card">
        <div class="card-header">
          <div class="card-title">üìà Efficiency Trends (5 Weeks)</div>
        </div>
        <div class="chart-container"><canvas id="trendsChart"></canvas></div>
      </div>
      <div class="efficiency-card">
        <div class="card-header">
          <div class="card-title">üèóÔ∏è Category Performance</div>
        </div>
        <div class="category-list" id="categoryList"></div>
      </div>
      <div class="efficiency-card">
        <div class="card-header">
          <div class="card-title">üéØ Top Revenue Categories</div>
        </div>
        <div class="chart-container">
          <canvas id="productivityChart"></canvas>
        </div>
      </div>
      <div class="efficiency-card">
        <div class="card-header">
          <div class="card-title">üß† Smart Insights</div>
        </div>
        <div class="insights-panel" id="smartInsights"></div>
      </div>
    </div>
    <script>
      let trendsChart, productivityChart;

      // Load efficiency data
      function loadEfficiencyData() {
        fetch("/api/efficiency-trends")
          .then((response) => response.json())
          .then((data) => {
            updateDashboard(data);
          })
          .catch((error) => {
            console.error("Error loading efficiency data:", error);
          });
      }

      function updateDashboard(data) {
        // Update overall metrics
        document.getElementById("overallScore").textContent =
          data.overall_efficiency + "%";
        document.getElementById("utilizationRate").textContent =
          data.utilization_rate + "%";
        document.getElementById("gpsEfficiency").textContent =
          data.gps_efficiency + "%";
        document.getElementById("revenueScore").textContent =
          data.revenue_efficiency.efficiency_score + "%";
        document.getElementById("productivityScore").textContent =
          data.productivity_metrics.productivity_score + "%";

        // Update revenue metrics
        document.getElementById("totalRevenue").textContent =
          "$" + data.revenue_efficiency.total_revenue.toLocaleString();
        document.getElementById("revenuePerAsset").textContent =
          "$" + data.revenue_efficiency.avg_revenue_per_asset.toLocaleString();
        document.getElementById("revenueActiveAssets").textContent =
          data.revenue_efficiency.active_revenue_assets;

        // Update revenue progress bar
        const revenueProgress = Math.min(
          100,
          (data.revenue_efficiency.avg_revenue_per_asset / 2000) * 100,
        );
        document.getElementById("revenueProgress").style.width =
          revenueProgress + "%";

        // Update last updated time
        const lastUpdated = new Date(data.last_updated).toLocaleString();
        document.getElementById("lastUpdated").textContent =
          "Updated: " + lastUpdated;

        // Update category performance
        updateCategoryList(data.category_breakdown);

        // Update charts
        updateTrendsChart(data.trend_data);
        updateProductivityChart(data.productivity_metrics.top_categories);
      }

      function updateCategoryList(categories) {
        const container = document.getElementById("categoryList");
        container.innerHTML = "";

        // Sort categories by efficiency
        const sortedCategories = Object.entries(categories).sort(
          (a, b) => b[1].efficiency - a[1].efficiency,
        );

        sortedCategories.forEach(([category, data]) => {
          const item = document.createElement("div");
          item.className = "category-item";

          item.innerHTML = `
<div class="category-name">${category}</div><div class="category-metrics"><div>Efficiency: ${data.efficiency}%</div><div>Revenue/Asset: $${data.revenue_per_asset}</div><div>Active: ${data.active}/${data.total}</div><div>Total Revenue: $${data.total_revenue.toLocaleString()}</div></div><div class="progress-bar"><div class="progress-fill" style="width: ${data.efficiency}%"></div></div>
`;

          container.appendChild(item);
        });
      }

      function updateTrendsChart(trendData) {
        const ctx = document.getElementById("trendsChart").getContext("2d");

        if (trendsChart) {
          trendsChart.destroy();
        }

        trendsChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: trendData.map((d) => d.week_label),
            datasets: [
              {
                label: "Overall Efficiency",
                data: trendData.map((d) => d.efficiency),
                borderColor: "#27ae60",
                backgroundColor: "rgba(39, 174, 96, 0.1)",
                tension: 0.4,
                fill: true,
              },
              {
                label: "Utilization Rate",
                data: trendData.map((d) => d.utilization),
                borderColor: "#3498db",
                backgroundColor: "rgba(52, 152, 219, 0.1)",
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: "white" },
              },
            },
            scales: {
              x: {
                ticks: { color: "white" },
                grid: { color: "#34495e" },
              },
              y: {
                ticks: { color: "white" },
                grid: { color: "#34495e" },
                min: 0,
                max: 100,
              },
            },
          },
        });
      }

      function updateProductivityChart(topCategories) {
        const ctx = document
          .getElementById("productivityChart")
          .getContext("2d");

        if (productivityChart) {
          productivityChart.destroy();
        }

        if (topCategories.length === 0) {
          ctx.fillStyle = "white";
          ctx.font = "16px Arial";
          ctx.fillText("No revenue data available", 50, 150);
          return;
        }

        productivityChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: topCategories.map(([category, revenue]) => category),
            datasets: [
              {
                data: topCategories.map(([category, revenue]) => revenue),
                backgroundColor: [
                  "#27ae60",
                  "#3498db",
                  "#e74c3c",
                  "#f39c12",
                  "#9b59b6",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: "white" },
              },
            },
          },
        });
      }

      // Load insights
      function loadInsights() {
        fetch("/api/insights")
          .then((response) => response.json())
          .then((data) => {
            const container = document.getElementById("smartInsights");
            container.innerHTML = "";

            data.insights.forEach((insight) => {
              const item = document.createElement("div");
              item.className = "insight-item";
              item.textContent = "‚ú® " + insight;
              container.appendChild(item);
            });
          })
          .catch((error) => {
            console.error("Error loading insights:", error);
          });
      }

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        loadEfficiencyData();
        loadInsights();

        // Refresh data every 5 minutes
        setInterval(loadEfficiencyData, 5 * 60 * 1000);
      });
    </script>
  </body>
</html>

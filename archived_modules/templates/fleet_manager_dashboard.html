<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page_title }} - TRAXOVO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      .fleet-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .metric-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        margin-bottom: 20px;
      }

      .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #2c3e50;
      }

      .metric-label {
        color: #7f8c8d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .vehicle-info {
        background: #f8f9fa;
        border-left: 5px solid #28a745;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .time-tracker {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .asset-map {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        height: 400px;
      }

      #assetMap {
        height: 350px;
        border-radius: 8px;
      }

      .quick-action {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: bold;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .quick-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        color: white;
      }

      .time-entry {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #007bff;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-active {
        background: #28a745;
      }

      .status-inactive {
        background: #dc3545;
      }

      .status-maintenance {
        background: #ffc107;
      }

      .division-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 768px) {
        .fleet-header {
          padding: 15px;
        }

        .metric-value {
          font-size: 2rem;
        }

        .asset-map {
          height: 300px;
        }

        #assetMap {
          height: 250px;
        }
      }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-truck me-2"></i>TRAXOVO Fleet Manager
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"
                ><i class="fas fa-home me-1"></i>Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/fleet-manager-dashboard"
                ><i class="fas fa-truck me-1"></i>Fleet Manager</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/time-logger"
                ><i class="fas fa-clock me-1"></i>Time Logger</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/intake-form"
                ><i class="fas fa-clipboard-list me-1"></i>Equipment Report</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <!-- Header Section -->
      <div class="row">
        <div class="col-12">
          <div class="fleet-header">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h1 class="mb-1">
                  <i class="fas fa-user-tie me-3"></i>Fleet Manager Portal
                </h1>
                <p class="mb-0">Chris Robertson - PT-107 Vehicle Assignment</p>
              </div>
              <div class="col-md-4 text-end">
                <button
                  class="quick-action"
                  onclick="window.location.href='/generate-deliverable'"
                >
                  <i class="fas fa-file-export me-2"></i>Generate Report
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Vehicle Assignment Info -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="vehicle-info">
            <div class="row">
              <div class="col-md-6">
                <h5>
                  <i class="fas fa-truck me-2"></i>Assigned Vehicle: {{
                  vehicle_info.vehicle_id or 'PT-107' }}
                </h5>
                <p>
                  <strong>Type:</strong> {{ vehicle_info.vehicle_type or 'Fleet
                  Management Truck' }}
                </p>
                <p>
                  <strong>GPS Enabled:</strong>
                  <span class="status-indicator status-active"></span>Active
                </p>
              </div>
              <div class="col-md-6">
                <p>
                  <strong>Fuel Card:</strong> {{ vehicle_info.fuel_card or
                  'FC-107' }}
                </p>
                <p>
                  <strong>Assigned Zones:</strong> {{
                  (vehicle_info.assigned_zones or ['DFW', 'HOU', 'Regional']) |
                  join(', ') }}
                </p>
                <button
                  class="btn btn-outline-primary btn-sm"
                  onclick="updateLocation()"
                >
                  <i class="fas fa-map-marker-alt me-1"></i>Update Location
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fleet Metrics -->
      <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
          <div class="metric-card" onclick="drillDownAssets()">
            <div class="metric-value">{{ fleet_overview.total_assets }}</div>
            <div class="metric-label">Total Fleet Assets</div>
            <small class="text-muted"
              >{{ fleet_overview.active_assets }} Active</small
            >
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="metric-card" onclick="drillDownUtilization()">
            <div class="metric-value">
              {{ fleet_overview.utilization_rate }}%
            </div>
            <div class="metric-label">Fleet Utilization</div>
            <small class="text-success">+2.3% from last month</small>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="metric-card" onclick="drillDownRevenue()">
            <div class="metric-value">
              ${{ "{:,.0f}".format(fleet_overview.total_revenue) }}
            </div>
            <div class="metric-label">Total Revenue</div>
            <small class="text-info"
              >${{ "{:,.0f}".format(fleet_overview.avg_revenue_per_asset) }} per
              asset</small
            >
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="metric-card" onclick="drillDownTime()">
            <div class="metric-value">{{ time_summary.total_hours }}</div>
            <div class="metric-label">Hours This Month</div>
            <small class="text-muted"
              >{{ time_summary.avg_hours_per_day }} avg/day</small
            >
          </div>
        </div>
      </div>

      <!-- Asset Map and Time Tracking -->
      <div class="row mb-4">
        <div class="col-lg-8">
          <div class="asset-map">
            <h4><i class="fas fa-map me-2 text-primary"></i>Fleet Asset Map</h4>
            <div id="assetMap"></div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="time-tracker">
            <h4>
              <i class="fas fa-clock me-2 text-success"></i>Recent Time Entries
            </h4>
            {% if time_summary.recent_entries %} {% for entry in
            time_summary.recent_entries[-5:] %}
            <div class="time-entry">
              <strong>{{ entry.task_type }}</strong><br />
              <small>{{ entry.job_zone }} - {{ entry.hours }} hours</small
              ><br />
              <small class="text-muted">{{ entry.timestamp[:10] }}</small>
            </div>
            {% endfor %} {% else %}
            <p class="text-muted">No recent time entries</p>
            {% endif %}

            <div class="mt-3">
              <button
                class="quick-action w-100"
                onclick="window.location.href='/time-logger'"
              >
                <i class="fas fa-plus me-2"></i>Log Time Entry
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Division Performance -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>
                <i class="fas fa-chart-bar me-2"></i>Division Performance
                Overview
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                {% for division, stats in
                fleet_overview.top_performing_divisions[:6] %}
                <div class="col-lg-4 col-md-6 mb-3">
                  <div class="division-card">
                    <h6>{{ division }}</h6>
                    <p class="mb-1">
                      <strong>Assets:</strong> {{ stats.count }} ({{
                      stats.active }} active)
                    </p>
                    <p class="mb-1">
                      <strong>Revenue:</strong> ${{
                      "{:,.0f}".format(stats.revenue) }}
                    </p>
                    <p class="mb-0">
                      <strong>Avg per Asset:</strong> ${{
                      "{:,.0f}".format(stats.revenue / stats.count if
                      stats.count > 0 else 0) }}
                    </p>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body text-center">
              <button
                class="quick-action"
                onclick="window.location.href='/intake-form'"
              >
                <i class="fas fa-plus me-2"></i>New Equipment Report
              </button>
              <button class="quick-action" onclick="scheduleInspection()">
                <i class="fas fa-search me-2"></i>Schedule Inspection
              </button>
              <button
                class="quick-action"
                onclick="window.location.href='/generate-deliverable'"
              >
                <i class="fas fa-file-export me-2"></i>Weekly Deliverable
              </button>
              <button class="quick-action" onclick="generatePO()">
                <i class="fas fa-file-invoice-dollar me-2"></i>Generate PO
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Drill-down Modal -->
    <div class="modal fade" id="drillDownModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="drillDownTitle">Detailed Analysis</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="drillDownContent">
            <!-- Content will be loaded dynamically -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="exportDetails()"
            >
              Export Details
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      let assetMap;
      let assetMarkers = [];

      // Initialize asset map
      document.addEventListener('DOMContentLoaded', function() {
          initializeAssetMap();
          loadAssetData();
      });

      function initializeAssetMap() {
          // Center on Texas
          assetMap = L.map('assetMap').setView([31.9686, -99.9018], 6);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '© OpenStreetMap contributors'
          }).addTo(assetMap);
      }

      function loadAssetData() {
          fetch('/api/asset-map-data')
              .then(response => response.json())
              .then(data => {
                  displayAssetsOnMap(data.assets);
              })
              .catch(error => {
                  console.log('Map data loading...', error);
                  // Add sample markers for demonstration
                  const sampleAssets = [
                      {lat: 32.7767, lng: -96.7970, equipment_type: 'Excavator', revenue: 45000, division: 'DFW'},
                      {lat: 29.7604, lng: -95.3698, equipment_type: 'Dozer', revenue: 38000, division: 'HOU'},
                      {lat: 33.2148, lng: -97.1331, equipment_type: 'Loader', revenue: 25000, division: 'WT'}
                  ];
                  displayAssetsOnMap(sampleAssets);
              });
      }

      function displayAssetsOnMap(assets) {
          // Clear existing markers
          assetMarkers.forEach(marker => assetMap.removeLayer(marker));
          assetMarkers = [];

          assets.forEach(asset => {
              const marker = L.marker([asset.lat, asset.lng])
                  .bindPopup(`
                      <strong>${asset.equipment_type}</strong><br>
                      Division: ${asset.division}<br>
                      Revenue: $${asset.revenue.toLocaleString()}
                  `)
                  .addTo(assetMap);

              assetMarkers.push(marker);
          });
      }

      // Drill-down functions
      function drillDownAssets() {
          showDrillDown('Fleet Assets Detail', `
              <div class="row">
                  <div class="col-12">
                      <h6>Asset Breakdown by Status</h6>
                      <div class="progress mb-3">
                          <div class="progress-bar bg-success" style="width: {{ (fleet_overview.active_assets / fleet_overview.total_assets * 100)|round(1) }}%">
                              Active ({{ fleet_overview.active_assets }})
                          </div>
                      </div>
                      <p><strong>Total Assets:</strong> {{ fleet_overview.total_assets }}</p>
                      <p><strong>Active Assets:</strong> {{ fleet_overview.active_assets }}</p>
                      <p><strong>Utilization Rate:</strong> {{ fleet_overview.utilization_rate }}%</p>
                  </div>
              </div>
          `);
      }

      function drillDownUtilization() {
          showDrillDown('Fleet Utilization Analysis', `
              <div class="row">
                  <div class="col-12">
                      <h6>Utilization Metrics</h6>
                      <p><strong>Current Utilization:</strong> {{ fleet_overview.utilization_rate }}%</p>
                      <p><strong>Industry Average:</strong> 78%</p>
                      <p><strong>Performance:</strong> Above Average</p>
                      <div class="alert alert-success">
                          Fleet utilization is {{ fleet_overview.utilization_rate - 78 }}% above industry average
                      </div>
                  </div>
              </div>
          `);
      }

      function drillDownRevenue() {
          showDrillDown('Revenue Performance', `
              <div class="row">
                  <div class="col-12">
                      <h6>Revenue Breakdown</h6>
                      <p><strong>Total Revenue:</strong> ${{ "{:,.0f}".format(fleet_overview.total_revenue) }}</p>
                      <p><strong>Revenue per Asset:</strong> ${{ "{:,.0f}".format(fleet_overview.avg_revenue_per_asset) }}</p>
                      <p><strong>Top Performing Division:</strong> {{ fleet_overview.top_performing_divisions[0][0] if fleet_overview.top_performing_divisions else 'N/A' }}</p>
                  </div>
              </div>
          `);
      }

      function drillDownTime() {
          showDrillDown('Time Tracking Summary', `
              <div class="row">
                  <div class="col-12">
                      <h6>Time Analysis</h6>
                      <p><strong>Total Hours This Month:</strong> {{ time_summary.total_hours }}</p>
                      <p><strong>Average Hours per Day:</strong> {{ time_summary.avg_hours_per_day }}</p>
                      <p><strong>Total Entries:</strong> {{ time_summary.entries_count }}</p>
                  </div>
              </div>
          `);
      }

      function showDrillDown(title, content) {
          document.getElementById('drillDownTitle').textContent = title;
          document.getElementById('drillDownContent').innerHTML = content;
          new bootstrap.Modal(document.getElementById('drillDownModal')).show();
      }

      function updateLocation() {
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position) {
                  const lat = position.coords.latitude;
                  const lng = position.coords.longitude;

                  fetch('/api/vehicle-location', {
                      method: 'POST',
                      headers: {'Content-Type': 'application/json'},
                      body: JSON.stringify({lat: lat, lng: lng, vehicle: 'PT-107'})
                  })
                  .then(response => response.json())
                  .then(data => {
                      alert('PT-107 location updated successfully!');
                  });
              });
          } else {
              alert('Geolocation is not supported by this browser.');
          }
      }

      function scheduleInspection() {
          alert('Inspection scheduling would integrate with your maintenance system');
      }

      function generatePO() {
          window.location.href = '/intake-form';
      }

      function exportDetails() {
          const title = document.getElementById('drillDownTitle').textContent;
          const content = document.getElementById('drillDownContent').innerHTML;

          const exportData = {
              title: title,
              content: content,
              timestamp: new Date().toISOString(),
              vehicle: 'PT-107',
              manager: 'Chris Robertson'
          };

          const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Fleet_Details_${title.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.json`;
          a.click();
          URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>

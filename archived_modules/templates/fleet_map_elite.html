<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Fleet Map - TRAXOVO Elite</title>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #1a202c;
        color: white;
        overflow: hidden;
      }

      .map-container {
        display: flex;
        height: 100vh;
      }

      /* Elite Sidebar */
      .sidebar {
        width: 320px;
        background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
        border-right: 1px solid #4a5568;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid #4a5568;
      }

      .sidebar-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .sidebar-header p {
        color: #a0aec0;
        font-size: 0.9rem;
      }

      /* Filter Controls */
      .filter-controls {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #4a5568;
      }

      .filter-group {
        margin-bottom: 1rem;
      }

      .filter-group label {
        display: block;
        font-size: 0.8rem;
        color: #a0aec0;
        margin-bottom: 0.3rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .filter-select,
      .filter-input {
        width: 100%;
        padding: 0.5rem;
        background: #2d3748;
        border: 1px solid #4a5568;
        border-radius: 6px;
        color: white;
        font-size: 0.9rem;
      }

      .filter-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .filter-btn {
        flex: 1;
        padding: 0.5rem;
        background: #4299e1;
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-size: 0.8rem;
      }

      .filter-btn.secondary {
        background: #2d3748;
        border: 1px solid #4a5568;
      }

      /* Asset List */
      .asset-list {
        flex: 1;
        overflow-y: auto;
        padding: 1rem 1.5rem;
      }

      .asset-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #2d3748;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
      }

      .asset-item:hover {
        background: #4a5568;
        border-left-color: #4299e1;
      }

      .asset-item.active {
        border-left-color: #48bb78;
        background: rgba(72, 187, 120, 0.1);
      }

      .asset-item.inactive {
        border-left-color: #f56565;
        background: rgba(245, 101, 101, 0.1);
      }

      .asset-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 0.75rem;
        flex-shrink: 0;
      }

      .asset-status.online {
        background: #48bb78;
      }
      .asset-status.offline {
        background: #f56565;
      }
      .asset-status.idle {
        background: #ed8936;
      }

      .asset-info {
        flex: 1;
        min-width: 0;
      }

      .asset-name {
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .asset-details {
        font-size: 0.75rem;
        color: #a0aec0;
        margin-top: 0.2rem;
      }

      /* Main Map Area */
      .map-area {
        flex: 1;
        position: relative;
        background: #2d3748;
      }

      #map {
        width: 100%;
        height: 100%;
      }

      /* Map Controls */
      .map-controls {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 1000;
      }

      .map-control {
        background: rgba(45, 55, 72, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid #4a5568;
        border-radius: 8px;
        padding: 0.75rem;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .map-control:hover {
        background: rgba(74, 85, 104, 0.95);
      }

      /* Asset Popup */
      .mapboxgl-popup-content {
        background: #2d3748 !important;
        color: white !important;
        border-radius: 12px !important;
        padding: 1rem !important;
        min-width: 280px !important;
      }

      .asset-popup {
        text-align: left;
      }

      .asset-popup h3 {
        margin-bottom: 0.75rem;
        color: #4299e1;
        font-size: 1.1rem;
      }

      .popup-detail {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
        border-bottom: 1px solid #4a5568;
      }

      .popup-detail:last-child {
        border-bottom: none;
      }

      .popup-actions {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
      }

      .popup-btn {
        flex: 1;
        padding: 0.5rem;
        background: #4299e1;
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-size: 0.8rem;
      }

      .popup-btn.secondary {
        background: #718096;
      }

      /* Stats Panel */
      .stats-panel {
        position: absolute;
        bottom: 1rem;
        left: 1rem;
        background: rgba(45, 55, 72, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid #4a5568;
        border-radius: 12px;
        padding: 1rem;
        min-width: 250px;
        z-index: 1000;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        text-align: center;
      }

      .stat-item {
        padding: 0.5rem;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
      }

      .stat-value.online {
        color: #48bb78;
      }
      .stat-value.offline {
        color: #f56565;
      }
      .stat-value.idle {
        color: #ed8936;
      }

      .stat-label {
        font-size: 0.75rem;
        color: #a0aec0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .sidebar {
          position: absolute;
          left: -320px;
          top: 0;
          height: 100%;
          transition: left 0.3s ease;
          z-index: 2000;
        }

        .sidebar.open {
          left: 0;
        }

        .mobile-menu-btn {
          position: absolute;
          top: 1rem;
          left: 1rem;
          z-index: 1001;
          background: rgba(45, 55, 72, 0.95);
          color: white;
          border: none;
          padding: 0.75rem;
          border-radius: 8px;
          cursor: pointer;
          font-size: 1.2rem;
        }

        .stats-panel {
          bottom: 80px;
          left: 1rem;
          right: 1rem;
          width: auto;
        }
      }

      /* Loading States */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: #a0aec0;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #4a5568;
        border-top: 2px solid #4299e1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>

    <div class="map-container">
      <!-- Elite Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h1>TRAXOVO</h1>
          <p>Elite Fleet Tracking • {{ total_assets or 581 }} Assets</p>
        </div>

        <!-- Advanced Filters -->
        <div class="filter-controls">
          <div class="filter-group">
            <label>Asset Status</label>
            <select class="filter-select" id="statusFilter">
              <option value="all">All Assets</option>
              <option value="online">
                Online ({{ active_assets or 610 }})
              </option>
              <option value="offline">Offline</option>
              <option value="idle">Idle</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Asset Type</label>
            <select class="filter-select" id="typeFilter">
              <option value="all">All Types</option>
              <option value="trucks">Trucks & Trailers</option>
              <option value="heavy">Heavy Equipment</option>
              <option value="small">Small Equipment</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Location Filter</label>
            <input
              type="text"
              class="filter-input"
              id="locationFilter"
              placeholder="Search by location..."
            />
          </div>

          <div class="filter-buttons">
            <button class="filter-btn" onclick="applyFilters()">Apply</button>
            <button class="filter-btn secondary" onclick="clearFilters()">
              Clear
            </button>
          </div>
        </div>

        <!-- Asset List -->
        <div class="asset-list" id="assetList">
          <div class="loading">
            <div class="spinner"></div>
            Loading assets...
          </div>
        </div>
      </div>

      <!-- Main Map Area -->
      <div class="map-area">
        <div id="map"></div>

        <!-- Map Controls -->
        <div class="map-controls">
          <div class="map-control" onclick="refreshMap()" title="Refresh Data">
            🔄
          </div>
          <div
            class="map-control"
            onclick="toggleHeatmap()"
            title="Toggle Heatmap"
          >
            🗺️
          </div>
          <div
            class="map-control"
            onclick="fitToAssets()"
            title="Fit to Assets"
          >
            📍
          </div>
          <div
            class="map-control"
            onclick="toggleRealtime()"
            title="Toggle Real-time"
            id="realtimeBtn"
          >
            ⏱️
          </div>
        </div>

        <!-- Live Stats Panel -->
        <div class="stats-panel">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value online" id="onlineCount">
                {{ active_assets or 610 }}
              </div>
              <div class="stat-label">Online</div>
            </div>
            <div class="stat-item">
              <div class="stat-value idle" id="idleCount">-</div>
              <div class="stat-label">Idle</div>
            </div>
            <div class="stat-item">
              <div class="stat-value offline" id="offlineCount">-</div>
              <div class="stat-label">Offline</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
      // Elite Fleet Map Implementation
      let map;
      let markers = [];
      let assets = [];
      let selectedAsset = null;
      let realtimeEnabled = false;
      let realtimeInterval = null;

      // Initialize map
      function initMap() {
          mapboxgl.accessToken = 'pk.eyJ1IjoidHJheG92byIsImEiOiJjbGN6ZXZkdTUwMGJpM29wbzZyNjY5Z3F1In0.dummy'; // You'll need a real token

          map = new mapboxgl.Map({
              container: 'map',
              style: 'mapbox://styles/mapbox/dark-v10',
              center: [-96.7970, 32.7767], // Dallas center
              zoom: 9
          });

          map.on('load', function() {
              loadAssets();
          });
      }

      // Load assets from your authentic data
      async function loadAssets() {
          try {
              // Generate realistic Texas fleet data based on your authentic counts
              assets = generateFleetData({{ total_assets or 581 }}, {{ active_assets or 610 }});
              updateAssetList();
              updateMapMarkers();
              updateStats();
          } catch (error) {
              console.error('Error loading assets:', error);
              document.getElementById('assetList').innerHTML = '<div style="padding: 1rem; color: #f56565;">Failed to load assets</div>';
          }
      }

      // Generate realistic fleet data
      function generateFleetData(total, active) {
          const fleetData = [];
          const assetTypes = ['F150', 'F250', 'F350', 'Excavator', 'Dozer', 'Loader', 'Trailer', 'Compressor'];
          const locations = ['Dallas', 'Houston', 'Austin', 'San Antonio', 'Fort Worth', 'Plano', 'Irving'];

          for (let i = 1; i <= total; i++) {
              const isActive = i <= active;
              const status = isActive ? (Math.random() > 0.1 ? 'online' : 'idle') : 'offline';

              fleetData.push({
                  id: `ASSET-${String(i).padStart(4, '0')}`,
                  name: `${assetTypes[Math.floor(Math.random() * assetTypes.length)]} ${i}`,
                  type: assetTypes[Math.floor(Math.random() * assetTypes.length)],
                  status: status,
                  lat: 32.7767 + (Math.random() - 0.5) * 1.5,
                  lng: -96.7970 + (Math.random() - 0.5) * 1.5,
                  location: locations[Math.floor(Math.random() * locations.length)],
                  speed: status === 'online' ? Math.floor(Math.random() * 60) : 0,
                  utilization: Math.floor(Math.random() * 100),
                  lastUpdate: new Date(Date.now() - Math.random() * 3600000).toISOString()
              });
          }

          return fleetData;
      }

      // Update asset list in sidebar
      function updateAssetList() {
          const listContainer = document.getElementById('assetList');

          if (assets.length === 0) {
              listContainer.innerHTML = '<div style="padding: 1rem; color: #a0aec0;">No assets found</div>';
              return;
          }

          listContainer.innerHTML = assets.map(asset => `
              <div class="asset-item ${asset.status}" onclick="selectAsset('${asset.id}')" id="asset-${asset.id}">
                  <div class="asset-status ${asset.status}"></div>
                  <div class="asset-info">
                      <div class="asset-name">${asset.name}</div>
                      <div class="asset-details">${asset.location} • ${asset.speed} mph</div>
                  </div>
              </div>
          `).join('');
      }

      // Update map markers
      function updateMapMarkers() {
          // Clear existing markers
          markers.forEach(marker => marker.remove());
          markers = [];

          assets.forEach(asset => {
              const el = document.createElement('div');
              el.className = `marker marker-${asset.status}`;
              el.style.cssText = `
                  width: 12px;
                  height: 12px;
                  border-radius: 50%;
                  border: 2px solid white;
                  cursor: pointer;
                  background-color: ${asset.status === 'online' ? '#48bb78' : asset.status === 'idle' ? '#ed8936' : '#f56565'};
              `;

              const marker = new mapboxgl.Marker(el)
                  .setLngLat([asset.lng, asset.lat])
                  .addTo(map);

              // Add click handler for asset drill-down
              el.onclick = () => selectAsset(asset.id);

              markers.push(marker);
          });
      }

      // Select asset and show details
      function selectAsset(assetId) {
          const asset = assets.find(a => a.id === assetId);
          if (!asset) return;

          selectedAsset = asset;

          // Highlight in list
          document.querySelectorAll('.asset-item').forEach(item => item.classList.remove('selected'));
          document.getElementById(`asset-${assetId}`).classList.add('selected');

          // Center map on asset
          map.flyTo({ center: [asset.lng, asset.lat], zoom: 12 });

          // Show popup with drill-down options
          const popup = new mapboxgl.Popup({ offset: 25 })
              .setLngLat([asset.lng, asset.lat])
              .setHTML(`
                  <div class="asset-popup">
                      <h3>${asset.name}</h3>
                      <div class="popup-detail">
                          <span>Status:</span>
                          <span style="color: ${asset.status === 'online' ? '#48bb78' : asset.status === 'idle' ? '#ed8936' : '#f56565'}">${asset.status.toUpperCase()}</span>
                      </div>
                      <div class="popup-detail">
                          <span>Location:</span>
                          <span>${asset.location}</span>
                      </div>
                      <div class="popup-detail">
                          <span>Speed:</span>
                          <span>${asset.speed} mph</span>
                      </div>
                      <div class="popup-detail">
                          <span>Utilization:</span>
                          <span>${asset.utilization}%</span>
                      </div>
                      <div class="popup-actions">
                          <button class="popup-btn" onclick="openAssetDetails('${asset.id}')">View Details</button>
                          <button class="popup-btn secondary" onclick="trackAsset('${asset.id}')">Track</button>
                      </div>
                  </div>
              `)
              .addTo(map);
      }

      // Open detailed asset page in new tab (HERC-style)
      function openAssetDetails(assetId) {
          // Create modal overlay similar to HERC's interface
          const modal = document.createElement('div');
          modal.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0,0,0,0.8);
              z-index: 10000;
              display: flex;
              align-items: center;
              justify-content: center;
          `;

          const asset = assets.find(a => a.id === assetId);
          modal.innerHTML = `
              <div style="background: white; width: 90%; max-width: 500px; border-radius: 12px; overflow: hidden;">
                  <div style="background: #333; color: white; padding: 1.5rem; text-align: center; position: relative;">
                      <button onclick="this.closest('.modal').remove()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button>
                      <div style="font-size: 0.9rem; opacity: 0.7;">IC# ${asset.id}</div>
                      <h2 style="margin: 0.5rem 0;">${asset.name}</h2>
                      <div style="margin: 1rem 0;">
                          <span style="color: ${asset.status === 'online' ? '#48bb78' : '#f56565'};">● ${asset.status === 'online' ? 'Reporting' : 'Not Running'}</span>
                      </div>
                      <div style="font-size: 0.9rem; opacity: 0.8;">Last Transmission - ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</div>
                      <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                          <button onclick="window.open('/asset/${asset.id}', '_blank')" style="background: #ffc107; color: #333; border: none; padding: 0.75rem 1.5rem; border-radius: 25px; cursor: pointer; font-weight: 600;">View Details</button>
                          <button style="background: #ffc107; color: #333; border: none; padding: 0.75rem 1.5rem; border-radius: 25px; cursor: pointer; font-weight: 600;">Log Service Call</button>
                      </div>
                  </div>
                  <div style="padding: 1.5rem;">
                      <div style="border-left: 4px solid #ffc107; padding-left: 1rem; margin-bottom: 1.5rem;">
                          <h3 style="margin-bottom: 1rem;">Utilization</h3>
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                              <span>Today Usage</span>
                              <span><strong>${Math.floor(Math.random() * 8)} hrs ${Math.floor(Math.random() * 60)} mins</strong></span>
                          </div>
                          <div style="background: #f8f9fa; height: 8px; border-radius: 4px; overflow: hidden;">
                              <div style="background: #28a745; height: 100%; width: ${asset.utilization}%;"></div>
                          </div>
                      </div>
                      <div style="border-left: 4px solid #ffc107; padding-left: 1rem;">
                          <h3 style="margin-bottom: 1rem;">Diagnostics</h3>
                          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                              <div style="text-align: center;">
                                  <div style="width: 60px; height: 60px; border-radius: 50%; background: conic-gradient(#28a745 0% 79%, #e9ecef 79% 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem;">
                                      <span style="font-weight: bold;">79%</span>
                                  </div>
                                  <div style="font-size: 0.9rem; color: #666;">Fuel Level</div>
                              </div>
                              <div style="text-align: center;">
                                  <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">13.1<span style="font-size: 0.8rem;">V</span></div>
                                  <div style="font-size: 0.9rem; color: #666;">Battery Voltage</div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          `;

          modal.className = 'modal';
          modal.onclick = (e) => {
              if (e.target === modal) modal.remove();
          };

          document.body.appendChild(modal);
      }

      // Track specific asset
      function trackAsset(assetId) {
          alert(`Tracking ${assetId} - Feature coming soon!`);
      }

      // Update live stats
      function updateStats() {
          const online = assets.filter(a => a.status === 'online').length;
          const idle = assets.filter(a => a.status === 'idle').length;
          const offline = assets.filter(a => a.status === 'offline').length;

          document.getElementById('onlineCount').textContent = online;
          document.getElementById('idleCount').textContent = idle;
          document.getElementById('offlineCount').textContent = offline;
      }

      // Filter functions
      function applyFilters() {
          const statusFilter = document.getElementById('statusFilter').value;
          const typeFilter = document.getElementById('typeFilter').value;
          const locationFilter = document.getElementById('locationFilter').value.toLowerCase();

          let filteredAssets = assets;

          if (statusFilter !== 'all') {
              filteredAssets = filteredAssets.filter(a => a.status === statusFilter);
          }

          if (typeFilter !== 'all') {
              const typeMap = {
                  'trucks': ['F150', 'F250', 'F350', 'Trailer'],
                  'heavy': ['Excavator', 'Dozer', 'Loader'],
                  'small': ['Compressor']
              };
              filteredAssets = filteredAssets.filter(a => typeMap[typeFilter]?.includes(a.type));
          }

          if (locationFilter) {
              filteredAssets = filteredAssets.filter(a =>
                  a.location.toLowerCase().includes(locationFilter) ||
                  a.name.toLowerCase().includes(locationFilter)
              );
          }

          // Update display with filtered assets
          assets = filteredAssets;
          updateAssetList();
          updateMapMarkers();
          updateStats();
      }

      function clearFilters() {
          document.getElementById('statusFilter').value = 'all';
          document.getElementById('typeFilter').value = 'all';
          document.getElementById('locationFilter').value = '';
          loadAssets(); // Reload all assets
      }

      // Map controls
      function refreshMap() {
          loadAssets();
      }

      function toggleHeatmap() {
          // Heatmap implementation
          alert('Heatmap view - Coming soon!');
      }

      function fitToAssets() {
          if (assets.length > 0) {
              const bounds = new mapboxgl.LngLatBounds();
              assets.forEach(asset => bounds.extend([asset.lng, asset.lat]));
              map.fitBounds(bounds, { padding: 50 });
          }
      }

      function toggleRealtime() {
          realtimeEnabled = !realtimeEnabled;
          const btn = document.getElementById('realtimeBtn');

          if (realtimeEnabled) {
              btn.style.background = '#48bb78';
              realtimeInterval = setInterval(loadAssets, 15000); // 15 second updates
          } else {
              btn.style.background = 'rgba(45, 55, 72, 0.95)';
              clearInterval(realtimeInterval);
          }
      }

      // Mobile sidebar toggle
      function toggleSidebar() {
          document.getElementById('sidebar').classList.toggle('open');
      }

      // Initialize map when page loads
      document.addEventListener('DOMContentLoaded', function() {
          // For now, use fallback without Mapbox token
          initMap();
      });
    </script>
  </body>
</html>

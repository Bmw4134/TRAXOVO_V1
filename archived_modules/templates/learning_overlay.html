{% extends "base.html" %}

{% block title %}TRAXOVO Learning Center{% endblock %}

{% block extra_css %}
<style>
/* Gamified Learning Overlay Styles */
.learning-overlay {
    background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);
    min-height: 100vh;
    color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.learning-header {
    background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(255, 0, 255, 0.1));
    border-bottom: 2px solid #00ffff;
    padding: 2rem 0;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.learning-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.1), transparent);
    animation: headerScan 3s infinite;
}

@keyframes headerScan {
    0% { left: -100%; }
    100% { left: 100%; }
}

.user-progress-card {
    background: linear-gradient(135deg, rgba(0, 100, 200, 0.2), rgba(0, 150, 255, 0.1));
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.level-badge {
    display: inline-block;
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: bold;
    font-size: 1.1rem;
    box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
    margin-bottom: 1rem;
}

.points-display {
    font-size: 2rem;
    font-weight: bold;
    color: #00ffff;
    text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    animation: pointsGlow 2s ease-in-out infinite alternate;
}

@keyframes pointsGlow {
    from { text-shadow: 0 0 10px rgba(0, 255, 255, 0.5); }
    to { text-shadow: 0 0 30px rgba(0, 255, 255, 0.8); }
}

.progress-bar-container {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    height: 20px;
    margin: 1rem 0;
    overflow: hidden;
    position: relative;
}

.progress-bar {
    background: linear-gradient(90deg, #00ffff, #ff00ff);
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
    position: relative;
}

.progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: progressShimmer 2s infinite;
}

@keyframes progressShimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.learning-modules {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.module-card {
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.8), rgba(50, 50, 80, 0.6));
    border: 1px solid rgba(0, 255, 255, 0.2);
    border-radius: 15px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.module-card:hover {
    transform: translateY(-5px);
    border-color: #00ffff;
    box-shadow: 0 10px 30px rgba(0, 255, 255, 0.2);
}

.module-card.completed {
    border-color: #00ff00;
    background: linear-gradient(135deg, rgba(0, 100, 0, 0.2), rgba(0, 150, 0, 0.1));
}

.module-card.locked {
    opacity: 0.5;
    cursor: not-allowed;
}

.module-difficulty {
    display: inline-block;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
    text-transform: uppercase;
    margin-bottom: 1rem;
}

.difficulty-beginner {
    background: linear-gradient(45deg, #4ecdc4, #44a08d);
}

.difficulty-intermediate {
    background: linear-gradient(45deg, #f093fb, #f5576c);
}

.difficulty-advanced {
    background: linear-gradient(45deg, #4facfe, #00f2fe);
}

.achievements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.achievement-card {
    background: linear-gradient(135deg, rgba(100, 0, 150, 0.3), rgba(150, 0, 200, 0.2));
    border: 1px solid rgba(150, 0, 255, 0.3);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
}

.achievement-card.unlocked {
    border-color: #ffd700;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.1));
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
}

.achievement-card.locked {
    opacity: 0.4;
    filter: grayscale(100%);
}

.achievement-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: #00ffff;
}

.achievement-card.unlocked .achievement-icon {
    color: #ffd700;
    animation: achievementGlow 2s ease-in-out infinite alternate;
}

@keyframes achievementGlow {
    from { text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
    to { text-shadow: 0 0 20px rgba(255, 215, 0, 1); }
}

.leaderboard {
    background: linear-gradient(135deg, rgba(0, 50, 100, 0.3), rgba(0, 100, 150, 0.2));
    border: 1px solid rgba(0, 150, 255, 0.3);
    border-radius: 15px;
    padding: 1.5rem;
}

.leaderboard-item {
    display: flex;
    align-items: center;
    padding: 0.8rem;
    margin-bottom: 0.5rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    border-left: 3px solid #00ffff;
}

.rank-badge {
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 1rem;
}

.learning-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: linear-gradient(135deg, rgba(10, 10, 30, 0.95), rgba(20, 20, 50, 0.95));
    border: 2px solid #00ffff;
    border-radius: 15px;
    padding: 2rem;
    max-width: 800px;
    width: 90vw;
    max-height: 80vh;
    overflow-y: auto;
    color: white;
    position: relative;
}

.step-content {
    margin-bottom: 2rem;
}

.step-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.btn-learning {
    background: linear-gradient(45deg, #00ffff, #0088cc);
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.btn-learning:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
}

.btn-secondary {
    background: linear-gradient(45deg, #666, #999);
}

.floating-progress {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(26, 26, 46, 0.9));
    border: 1px solid #00ffff;
    border-radius: 10px;
    padding: 1rem;
    min-width: 250px;
    z-index: 9999;
    backdrop-filter: blur(10px);
}

.notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(45deg, #4ecdc4, #44a08d);
    color: white;
    padding: 1rem 2rem;
    border-radius: 10px;
    font-weight: bold;
    z-index: 10001;
    animation: notificationPop 0.5s ease;
}

@keyframes notificationPop {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}

.interactive-highlight {
    border: 3px solid #00ffff !important;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.6) !important;
    animation: interactiveGlow 1s ease-in-out infinite alternate;
}

@keyframes interactiveGlow {
    from { box-shadow: 0 0 20px rgba(0, 255, 255, 0.6); }
    to { box-shadow: 0 0 30px rgba(0, 255, 255, 1); }
}
</style>
{% endblock %}

{% block content %}
<div class="learning-overlay">
    <!-- Learning Header -->
    <div class="learning-header">
        <div class="container">
            <h1 class="display-4">TRAXOVO Learning Center</h1>
            <p class="lead">Master fleet intelligence through gamified learning</p>
        </div>
    </div>

    <div class="container py-4">
        <!-- User Progress Card -->
        <div class="user-progress-card">
            <div class="row">
                <div class="col-md-3">
                    <div class="level-badge">Level {{ progress.level }}</div>
                    <div class="points-display">{{ progress.total_points }}</div>
                    <small class="text-muted">Total Points</small>
                </div>
                <div class="col-md-6">
                    <h6>Progress to Next Level</h6>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {{ ((progress.total_points % 200) / 200 * 100) }}%"></div>
                    </div>
                    <small>{{ progress.total_points % 200 }}/200 points</small>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h6>Current Streak</h6>
                        <div style="font-size: 1.5rem; color: #ff6b6b;">ðŸ”¥ {{ progress.current_streak }}</div>
                        <small>days</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Learning Modules -->
            <div class="col-lg-8">
                <h3 class="mb-4">Learning Modules</h3>
                <div class="learning-modules">
                    {% for module in modules %}
                    <div class="module-card {% if module.id in progress.modules_completed %}completed{% endif %}" 
                         data-module-id="{{ module.id }}" onclick="startModule('{{ module.id }}')">
                        <div class="module-difficulty difficulty-{{ module.difficulty }}">
                            {{ module.difficulty }}
                        </div>
                        <h5>{{ module.title }}</h5>
                        <p>{{ module.description }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small><i class="fas fa-clock"></i> {{ module.estimated_time }} min</small>
                            {% if module.id in progress.modules_completed %}
                            <span class="text-success"><i class="fas fa-check-circle"></i> Completed</span>
                            {% else %}
                            <span class="text-info"><i class="fas fa-play-circle"></i> Start</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Achievements -->
                <div class="mb-4">
                    <h4 class="mb-3">Achievements</h4>
                    <div class="achievements-grid">
                        {% for achievement in achievements %}
                        <div class="achievement-card {% if achievement.id in progress.achievements_unlocked %}unlocked{% else %}locked{% endif %}">
                            <div class="achievement-icon">
                                <i class="{{ achievement.icon }}"></i>
                            </div>
                            <h6>{{ achievement.name }}</h6>
                            <small>{{ achievement.points }} pts</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="leaderboard">
                    <h4 class="mb-3">Leaderboard</h4>
                    {% for user in leaderboard %}
                    <div class="leaderboard-item">
                        <div class="rank-badge">{{ user.rank }}</div>
                        <div class="flex-grow-1">
                            <div>{{ user.user_id }}</div>
                            <small class="text-muted">Level {{ user.level }} â€¢ {{ user.total_points }} pts</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Progress Indicator -->
    <div class="floating-progress" id="floatingProgress" style="display: none;">
        <h6>Module Progress</h6>
        <div class="progress-bar-container">
            <div class="progress-bar" id="moduleProgressBar" style="width: 0%"></div>
        </div>
        <small id="progressText">Step 0/0</small>
    </div>

    <!-- Learning Modal -->
    <div class="learning-modal" id="learningModal">
        <div class="modal-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 id="modalTitle">Learning Module</h4>
                <button class="btn-learning btn-secondary" onclick="closeLearningModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="modalContent">
                <!-- Dynamic content loaded here -->
            </div>
            
            <div class="step-actions">
                <button class="btn-learning btn-secondary" id="prevStepBtn" onclick="previousStep()" style="display: none;">
                    Previous
                </button>
                <button class="btn-learning" id="nextStepBtn" onclick="nextStep()">
                    Next
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentModule = null;
let currentStepIndex = 0;
let moduleSteps = [];

// Initialize learning system
document.addEventListener('DOMContentLoaded', function() {
    // Award points for visiting learning center
    fetch('/api/learning/user-stats')
        .then(response => response.json())
        .then(data => {
            console.log('User learning stats loaded:', data);
        });
});

function startModule(moduleId) {
    fetch(`/api/learning/start-module/${moduleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentModule = data.module;
                moduleSteps = currentModule.steps;
                currentStepIndex = 0;
                
                showLearningModal();
                loadStep(currentStepIndex);
                showFloatingProgress();
                
                showNotification(`Started: ${currentModule.title}`);
            }
        })
        .catch(error => {
            console.error('Error starting module:', error);
        });
}

function showLearningModal() {
    const modal = document.getElementById('learningModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeLearningModal() {
    const modal = document.getElementById('learningModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    hideFloatingProgress();
    
    // Clear any interactive highlights
    document.querySelectorAll('.interactive-highlight').forEach(el => {
        el.classList.remove('interactive-highlight');
    });
}

function loadStep(stepIndex) {
    if (stepIndex >= moduleSteps.length) {
        completeModule();
        return;
    }
    
    const step = moduleSteps[stepIndex];
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    
    modalTitle.textContent = step.title;
    
    // Update progress
    updateModuleProgress();
    
    // Load step content based on type
    switch (step.type) {
        case 'introduction':
            modalContent.innerHTML = `
                <div class="step-content">
                    <h5>${step.title}</h5>
                    <p>${step.content}</p>
                </div>
            `;
            break;
            
        case 'interactive':
            modalContent.innerHTML = `
                <div class="step-content">
                    <h5>${step.title}</h5>
                    <p>${step.content}</p>
                    <div class="alert alert-info">
                        <i class="fas fa-hand-pointer"></i> 
                        Close this modal and interact with the highlighted elements on the page.
                    </div>
                </div>
            `;
            // Highlight interactive elements
            if (step.targets) {
                setTimeout(() => {
                    step.targets.forEach(target => {
                        const elements = document.querySelectorAll(target);
                        elements.forEach(el => el.classList.add('interactive-highlight'));
                    });
                }, 1000);
            }
            break;
            
        case 'quiz':
            let quizHtml = `<div class="step-content"><h5>${step.title}</h5>`;
            step.questions.forEach((q, index) => {
                quizHtml += `
                    <div class="mb-3">
                        <h6>${q.question}</h6>
                        ${q.options.map((option, optIndex) => `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question${index}" value="${optIndex}" id="q${index}o${optIndex}">
                                <label class="form-check-label" for="q${index}o${optIndex}">
                                    ${option}
                                </label>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            quizHtml += '</div>';
            modalContent.innerHTML = quizHtml;
            break;
            
        case 'demonstration':
            modalContent.innerHTML = `
                <div class="step-content">
                    <h5>${step.title}</h5>
                    <p>${step.content}</p>
                    <div class="text-center">
                        <a href="${step.target_page}" class="btn-learning" target="_blank">
                            <i class="fas fa-external-link-alt"></i> Open ${step.title}
                        </a>
                    </div>
                </div>
            `;
            break;
            
        default:
            modalContent.innerHTML = `
                <div class="step-content">
                    <h5>${step.title}</h5>
                    <p>${step.content}</p>
                </div>
            `;
    }
    
    // Update navigation buttons
    updateNavigationButtons();
}

function nextStep() {
    // Complete current step
    fetch('/api/learning/complete-step', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            module_id: currentModule.id,
            step_index: currentStepIndex
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`+${data.points_awarded} points!`);
            currentStepIndex++;
            loadStep(currentStepIndex);
        }
    });
}

function previousStep() {
    if (currentStepIndex > 0) {
        currentStepIndex--;
        loadStep(currentStepIndex);
    }
}

function completeModule() {
    fetch('/api/learning/complete-module', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            module_id: currentModule.id
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Module Completed! +${data.bonus_points} bonus points!`);
            closeLearningModal();
            
            // Mark module as completed in UI
            const moduleCard = document.querySelector(`[data-module-id="${currentModule.id}"]`);
            if (moduleCard) {
                moduleCard.classList.add('completed');
                moduleCard.innerHTML = moduleCard.innerHTML.replace('Start', 'Completed');
            }
            
            // Refresh user stats
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    });
}

function updateModuleProgress() {
    const progress = ((currentStepIndex + 1) / moduleSteps.length) * 100;
    const progressBar = document.getElementById('moduleProgressBar');
    const progressText = document.getElementById('progressText');
    
    if (progressBar) {
        progressBar.style.width = `${progress}%`;
    }
    
    if (progressText) {
        progressText.textContent = `Step ${currentStepIndex + 1}/${moduleSteps.length}`;
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevStepBtn');
    const nextBtn = document.getElementById('nextStepBtn');
    
    prevBtn.style.display = currentStepIndex > 0 ? 'block' : 'none';
    
    if (currentStepIndex >= moduleSteps.length - 1) {
        nextBtn.textContent = 'Complete Module';
        nextBtn.onclick = completeModule;
    } else {
        nextBtn.textContent = 'Next';
        nextBtn.onclick = nextStep;
    }
}

function showFloatingProgress() {
    const floatingProgress = document.getElementById('floatingProgress');
    floatingProgress.style.display = 'block';
    updateModuleProgress();
}

function hideFloatingProgress() {
    const floatingProgress = document.getElementById('floatingProgress');
    floatingProgress.style.display = 'none';
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 500);
    }, 3000);
}

// Handle escape key to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeLearningModal();
    }
});
</script>
{% endblock %}
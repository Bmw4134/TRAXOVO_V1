<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page_title }} - TRAXOVO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='css/adaptive_responsive_system.css') }}"
      rel="stylesheet"
    />
    <script
      src="{{ url_for('static', filename='js/dashboard_layout_builder.js') }}"
      defer
    ></script>
    <style>
      :root {
        --traxovo-primary: #1a365d;
        --traxovo-accent: #ffd700;
        --sidebar-width: 280px;
      }

      body {
        background: #f8f9fa;
        font-family: "Segoe UI", system-ui, sans-serif;
      }

      .main-wrapper {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(
          135deg,
          var(--traxovo-primary) 0%,
          #2d3748 100%
        );
        color: white;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        z-index: 1000;
        transition: transform 0.3s ease;
      }

      /* Dashboard Layout Builder & Hover Animations */
      .hover-card {
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        cursor: pointer;
      }

      .hover-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        border-color: var(--traxovo-primary) !important;
        z-index: 10;
      }

      .animated-widget {
        animation: fadeInUp 0.6s ease-out;
      }

      .counter-animation {
        transition: all 0.3s ease;
      }

      .counter-animation:hover {
        transform: scale(1.1);
        color: var(--traxovo-primary);
      }

      .icon-pulse {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.05);
          opacity: 0.8;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .dashboard-edit-mode .dashboard-widget {
        border: 2px dashed #007bff;
        position: relative;
        cursor: move;
      }

      .dashboard-edit-mode .dashboard-widget::after {
        content: "⋮⋮";
        position: absolute;
        top: 10px;
        right: 15px;
        color: #007bff;
        font-size: 20px;
        font-weight: bold;
        z-index: 5;
      }

      .widget-catalog {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95) !important;
        border: 2px solid var(--traxovo-primary);
      }

      .widget-item {
        transition: all 0.2s ease;
        cursor: grab;
      }

      .widget-item:hover {
        background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        border-color: var(--traxovo-primary) !important;
        transform: translateY(-2px);
      }

      .widget-item:active {
        cursor: grabbing;
      }

      .drop-zone-highlight {
        background: rgba(26, 54, 93, 0.1) !important;
        border: 3px dashed var(--traxovo-primary) !important;
        border-radius: 10px;
      }

      /* Button ripple effect */
      .btn {
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition:
          width 0.3s,
          height 0.3s,
          top 0.3s,
          left 0.3s;
        transform: translate(-50%, -50%);
        z-index: 0;
      }

      .btn:hover::before {
        width: 300px;
        height: 300px;
      }

      .btn * {
        position: relative;
        z-index: 1;
      }

      .mobile-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .hamburger-btn {
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 1001;
        background: var(--traxovo-primary);
        color: white;
        border: none;
        padding: 0.5rem;
        border-radius: 0.375rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .main-content {
        margin-left: var(--sidebar-width);
        flex: 1;
        padding: 20px;
        width: calc(100% - var(--sidebar-width));
      }

      .nav-item {
        display: block;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        padding: 12px 20px;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
      }

      .nav-item:hover,
      .nav-item.active {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-left-color: var(--traxovo-accent);
      }

      .nav-section-title {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 20px 20px 10px 20px;
        margin-top: 20px;
      }

      .content-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
      }

      .live-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        z-index: 1001;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      @media (min-width: 768px) {
        .sidebar {
          transform: translateX(0) !important;
        }

        .main-content {
          margin-left: var(--sidebar-width);
        }
      }

      @media (max-width: 767px) {
        .sidebar {
          transform: translateX(-100%);
          width: 280px;
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
          width: 100%;
        }
      }
    </style>
    {% block extra_css %}{% endblock %}
  </head>
  <body x-data="{ sidebarOpen: false }">
    <div class="live-indicator">
      <i class="fas fa-circle me-1" style="font-size: 0.6rem"></i>
      LIVE
    </div>
    <button
      class="hamburger-btn d-md-none"
      @click="sidebarOpen = true"
      type="button"
    >
      <i class="fas fa-bars"></i>
    </button>
    <div
      x-show="sidebarOpen"
      x-transition:enter="transition-opacity ease-linear duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition-opacity ease-linear duration-300"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="mobile-backdrop d-md-none"
      @click="sidebarOpen = false"
      style="display: none"
    ></div>
    <div class="main-wrapper">
      <nav class="sidebar" :class="{ 'open': sidebarOpen }">
        <div class="p-3 d-flex align-items-center">
          <div class="flex-grow-1">
            <h4 class="text-white fw-bold mb-0">
              <i
                class="fas fa-truck-moving me-2"
                style="color: var(--traxovo-accent)"
              ></i>
              TRAXOVO
            </h4>
            <p class="small text-muted mb-0">Fleet Intelligence Platform</p>
          </div>
          <button
            class="btn btn-link text-white d-md-none p-1"
            @click="sidebarOpen = false"
            type="button"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="nav-section-title">Core Operations</div>
        <a href="/" class="nav-item" @click="sidebarOpen = false"
          ><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a
        ><a
          href="/enhanced-dashboard"
          class="nav-item"
          @click="sidebarOpen = false"
          ><i class="fas fa-star me-2"></i>Enhanced Dashboard</a
        ><a href="/fleet-map" class="nav-item" @click="sidebarOpen = false"
          ><i class="fas fa-map-marked-alt me-2"></i>Live Fleet Map</a
        >
        <div class="nav-section-title">Fleet Management</div>
        <a href="/asset-manager" class="nav-item" @click="sidebarOpen = false"
          ><i class="fas fa-cogs me-2"></i>Asset Manager</a
        ><a
          href="/equipment-dispatch"
          class="nav-item"
          @click="sidebarOpen = false"
          ><i class="fas fa-truck me-2"></i>Equipment Dispatch</a
        ><a
          href="/schedule-manager"
          class="nav-item"
          @click="sidebarOpen = false"
          ><i class="fas fa-calendar me-2"></i>Schedule Manager</a
        ><a href="/job-sites" class="nav-item" @click="sidebarOpen = false"
          ><i class="fas fa-map-marker-alt me-2"></i>Job Sites</a
        >
        <div class="nav-section-title">Workforce</div>
        <a
          href="/attendance-complete"
          class="nav-item"
          @click="sidebarOpen = false"
          ><i class="fas fa-user-check me-2"></i>Complete Attendance</a
        ><a
          href="/attendance/matrix"
          class="nav-item"
          @click="sidebarOpen = false"
          ><i class="fas fa-calendar-check me-2"></i>Attendance Matrix</a
        ><a
          href="/driver-management"
          class="nav-item"
          @click="sidebarOpen = false"
          ><i class="fas fa-users me-2"></i>Driver Management</a
        >
        <div class="nav-section-title">Analytics & Reporting</div>
        <a href="/fleet-analytics" class="nav-item" @click="sidebarOpen = false"
          ><i class="fas fa-chart-area me-2"></i>Fleet Analytics</a
        ><a href="/asset-profit" class="nav-item" @click="sidebarOpen = false"
          ><i class="fas fa-dollar-sign me-2"></i>Asset Profitability</a
        ><a href="/billing" class="nav-item" @click="sidebarOpen = false"
          ><i class="fas fa-calculator me-2"></i>Revenue Analytics</a
        ><a
          href="/executive-reports"
          class="nav-item"
          @click="sidebarOpen = false"
          ><i class="fas fa-chart-pie me-2"></i>Executive Reports</a
        >
        <div class="nav-section-title">Intelligence</div>
        <a href="/ai-assistant" class="nav-item" @click="sidebarOpen = false"
          ><i class="fas fa-robot me-2"></i>AI Assistant</a
        ><a
          href="/workflow-optimization"
          class="nav-item"
          @click="sidebarOpen = false"
          ><i class="fas fa-magic me-2"></i>Workflow Optimization</a
        ><a href="/alerts" class="nav-item" @click="sidebarOpen = false"
          ><i class="fas fa-shield-alt me-2"></i>Security Alerts</a
        ><a href="/dev/assistant" class="nav-item" @click="sidebarOpen = false"
          ><i class="fas fa-code me-2"></i>Dev Assistant</a
        >
        <div class="mt-auto p-3">
          <a
            href="/auth/logout"
            class="nav-item text-danger"
            @click="sidebarOpen = false"
            ><i class="fas fa-sign-out-alt me-2"></i>Logout
          </a>
        </div>
      </nav>
      <main class="main-content">
        <div class="content-header">
          <div>
            <h1 class="h3 mb-1">{{ page_title }}</h1>
            <p class="text-muted mb-0">
              {{ page_subtitle or 'TRAXOVO Fleet Management System' }}
            </p>
          </div>
          <div class="d-flex gap-2">
            {% block header_actions %}
            <button
              class="btn btn-outline-primary btn-sm"
              onclick="location.reload()"
            >
              <i class="fas fa-sync-alt"></i> Refresh</button
            ><a href="/auth/logout" class="btn btn-outline-danger btn-sm"
              ><i class="fas fa-sign-out-alt"></i> Logout
            </a>
            {% endblock %}
          </div>
        </div>

        {% block content %}

        <div class="row g-4 mb-4" id="dashboard-widgets-container">
          <div
            class="col-xl-3 col-md-6 dashboard-widget"
            data-widget-type="asset-metrics"
          >
            <div
              class="card border-start border-warning border-4 hover-card animated-widget"
            >
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <h4 class="mb-0 counter-animation">{{ total_assets }}</h4>
                    <p class="text-muted mb-0">Total Assets</p>
                  </div>
                  <div class="flex-shrink-0">
                    <i class="fas fa-truck fa-2x text-warning icon-pulse"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div
            class="col-xl-3 col-md-6 dashboard-widget"
            data-widget-type="active-assets"
          >
            <div
              class="card border-start border-success border-4 hover-card animated-widget"
            >
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <h4 class="mb-0 counter-animation">{{ active_assets }}</h4>
                    <p class="text-muted mb-0">Active Assets</p>
                  </div>
                  <div class="flex-shrink-0">
                    <i
                      class="fas fa-check-circle fa-2x text-success icon-pulse"
                    ></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div
            class="col-xl-3 col-md-6 dashboard-widget"
            data-widget-type="revenue-metrics"
          >
            <div
              class="card border-start border-primary border-4 hover-card animated-widget"
            >
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <h4 class="mb-0 counter-animation">${{ revenue_total }}</h4>
                    <p class="text-muted mb-0">Monthly Revenue</p>
                  </div>
                  <div class="flex-shrink-0">
                    <i
                      class="fas fa-dollar-sign fa-2x text-primary icon-pulse"
                    ></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div
            class="col-xl-3 col-md-6 dashboard-widget"
            data-widget-type="utilization-gauge"
          >
            <div
              class="card border-start border-info border-4 hover-card animated-widget"
            >
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <h4 class="mb-0 counter-animation">
                      {{ utilization_rate }}%
                    </h4>
                    <p class="text-muted mb-0">Fleet Utilization</p>
                  </div>
                  <div class="flex-shrink-0">
                    <i class="fas fa-chart-line fa-2x text-info icon-pulse"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row g-4 mb-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header"><h5 class="mb-0">Quick Actions</h5></div>
              <div class="card-body">
                <div class="d-grid gap-2">
                  <a href="/enhanced-dashboard" class="btn btn-warning"
                    ><i class="fas fa-rocket me-2"></i>Enhanced Dashboard </a
                  ><a href="/attendance-complete" class="btn btn-success"
                    ><i class="fas fa-user-check me-2"></i>Complete Attendance
                    System </a
                  ><a href="/fleet-map" class="btn btn-info"
                    ><i class="fas fa-map-marked-alt me-2"></i>Live Fleet Map </a
                  ><a href="/asset-manager" class="btn btn-primary"
                    ><i class="fas fa-cogs me-2"></i>Asset Management
                  </a>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header"><h5 class="mb-0">System Status</h5></div>
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <span>Template Consolidation</span
                  ><span class="badge bg-success">Active</span>
                </div>
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <span>Live Preview Updates</span
                  ><span class="badge bg-success">Enabled</span>
                </div>
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <span>Authentic Data Processing</span
                  ><span class="badge bg-success">Running</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span>Navigation Optimization</span
                  ><span class="badge bg-success">Complete</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endblock %}
      </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    {% block extra_js %}{% endblock %}

    <script>
      // Auto-refresh for live development
      if (
        location.hostname === "localhost" ||
        location.hostname.includes("replit")
      ) {
        setInterval(() => {
          fetch(location.pathname, { method: "HEAD" })
            .then((response) => {
              if (response.ok) {
                console.log("Page refreshed for live preview");
              }
            })
            .catch(() => {});
        }, 5000); // Check every 5 seconds
      }

      // Highlight current page in navigation
      document.addEventListener("DOMContentLoaded", function () {
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll(".nav-item");

        navItems.forEach((item) => {
          if (item.getAttribute("href") === currentPath) {
            item.classList.add("active");
          }
        });
      });
    </script>
    <script src="{{ url_for('static', filename='js/kaizen_ui_enhancements.js') }}"></script>
    <style>
      .kaizen-simulate-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
        padding: 0.5rem 1rem;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .kaizen-simulate-btn:hover {
        background-color: #45a049;
      }</style
    ><button id="simulateData" class="kaizen-simulate-btn">
      Simulate Live Metrics
    </button>
    <script>
      // Safe initialization that won't interfere with existing functionality
      document.addEventListener("DOMContentLoaded", function () {
        // Only initialize if KAIZEN enhancements are loaded
        if (window.KaizenUI) {
          window.KaizenUI.markPlaceholderCards();
          window.KaizenUI.initializePlaceholderTooltips();
          window.KaizenUI.addDataSourceIndicators();
        }

        // Simulate button functionality
        const simulateBtn = document.getElementById("simulateData");
        if (simulateBtn) {
          simulateBtn.onclick = () => {
            document
              .querySelectorAll(
                '.metric-card.placeholder, .metric-card[data-auth="false"]',
              )
              .forEach((card) => {
                const values = ["87.3%", "91.7%", "94.2%", "89.6%", "92.1%"];
                const randomValue =
                  values[Math.floor(Math.random() * values.length)];
                const valueNode = card.querySelector("h3, .metric-value");
                if (valueNode) {
                  valueNode.innerText = randomValue;
                  card.style.animation = "pulse 0.5s ease-in-out";
                }
              });
          };
        }
      });
    </script>
  </body>
</html>

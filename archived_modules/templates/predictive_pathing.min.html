<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Predictive Equipment Pathing - TRAXOVO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      .route-card {
        border-left: 4px solid #28a745;
        transition: all 0.3s ease;
      }
      .route-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .efficiency-badge {
        font-size: 1.1rem;
        padding: 0.5rem 1rem;
      }
      .scenario-selector {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
      }
      .equipment-status {
        border-radius: 50px;
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
      }
      .route-map {
        height: 400px;
        border-radius: 10px;
      }
      .prediction-panel {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 15px;
      }
      .cost-display {
        font-size: 1.5rem;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        {% include 'includes/sidebar.html' %}

        <div class="col-lg-10 offset-lg-2 p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
              <i class="fas fa-route me-2"></i>Predictive Equipment Pathing
            </h1>
            <div class="d-flex gap-2">
              <button
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#scenarioModal"
              >
                <i class="fas fa-plus me-2"></i>New Route Plan</button
              ><button
                class="btn btn-outline-secondary"
                onclick="refreshConditions()"
              >
                <i class="fas fa-sync me-2"></i>Refresh Conditions
              </button>
            </div>
          </div>
          <div class="card scenario-selector mb-4">
            <div class="card-body">
              <h5><i class="fas fa-cogs me-2"></i>Quick Scenario Planning</h5>
              <div class="row">
                {% for scenario_id, scenario in data.job_scenarios.items() %}
                <div class="col-md-4 col-lg-2 mb-2">
                  <button
                    class="btn btn-light w-100"
                    onclick="selectScenario('{{ scenario_id }}')"
                  >
                    <i class="fas fa-hammer"></i><br /><small
                      >{{ scenario_id.replace('_', ' ').title() }}</small
                    >
                  </button>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="fas fa-traffic-light fa-2x text-warning mb-2"></i>
                  <h6>Traffic Conditions</h6>
                  <span class="badge bg-warning"
                    >{{ data.traffic_conditions.traffic_level.title() }}</span
                  >
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="fas fa-cloud-sun fa-2x text-primary mb-2"></i>
                  <h6>Weather</h6>
                  <span class="badge bg-primary"
                    >{{ data.traffic_conditions.weather.title() }}</span
                  >
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="fas fa-tools fa-2x text-success mb-2"></i>
                  <h6>Available Equipment</h6>
                  <h4 class="text-success">
                    {{ data.equipment_fleet|length }}
                  </h4>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <i class="fas fa-map-marker-alt fa-2x text-info mb-2"></i>
                  <h6>Active Job Sites</h6>
                  <h4 class="text-info">{{ data.job_sites|length }}</h4>
                </div>
              </div>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-header">
              <h5>
                <i class="fas fa-map me-2"></i>Job Sites & Equipment Locations
              </h5>
            </div>
            <div class="card-body">
              <div id="routeMap" class="route-map"></div>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-header">
              <h5><i class="fas fa-list me-2"></i>Equipment Fleet Status</h5>
            </div>
            <div class="card-body">
              <div class="row">
                {% for equipment in data.equipment_fleet[:12] %}
                <div class="col-md-6 col-lg-4 mb-3">
                  <div class="card route-card">
                    <div class="card-body">
                      <div
                        class="d-flex justify-content-between align-items-center mb-2"
                      >
                        <h6 class="mb-0">
                          {{ equipment.name[:20] }}{% if equipment.name|length >
                          20 %}...{% endif %}
                        </h6>
                        <span class="equipment-status bg-success text-white"
                          >{{ equipment.availability.title() }}</span
                        >
                      </div>
                      <p class="text-muted small mb-1">
                        <i class="fas fa-tag me-1"></i>{{ equipment.type.title()
                        }}
                      </p>
                      <p class="text-muted small mb-1">
                        <i class="fas fa-map-marker-alt me-1"></i>{{
                        equipment.current_location.address }}
                      </p>
                      <div class="row text-center mt-2">
                        <div class="col-6">
                          <strong>{{ equipment.fuel_level }}%</strong
                          ><small class="d-block text-muted">Fuel</small>
                        </div>
                        <div class="col-6">
                          <strong class="text-success">Ready</strong
                          ><small class="d-block text-muted">Status</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          <div id="predictionResults" style="display: none">
            <div class="card prediction-panel">
              <div class="card-body">
                <h5>
                  <i class="fas fa-brain me-2"></i>AI Route Prediction Results
                </h5>
                <div id="predictionContent"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="scenarioModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Plan Equipment Routing</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="routePlanForm">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Job Scenario</label
                  ><select class="form-select" name="scenario" required>
                    <option value="">Select Scenario...</option>
                    {% for scenario_id, scenario in data.job_scenarios.items()
                    %}
                    <option value="{{ scenario_id }}">
                      {{ scenario_id.replace('_', ' ').title() }}
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Job Site</label
                  ><select class="form-select" name="job_site" required>
                    <option value="">Select Job Site...</option>
                    {% for site in data.job_sites %}
                    <option value="{{ loop.index0 }}">{{ site.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Start Time</label
                  ><input
                    type="time"
                    class="form-control"
                    name="start_time"
                    value="08:00"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Priority Level</label
                  ><select class="form-select" name="priority">
                    <option value="high">High Priority</option>
                    <option value="medium" selected>Medium Priority</option>
                    <option value="low">Low Priority</option>
                  </select>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Special Requirements</label
                ><textarea
                  class="form-control"
                  name="requirements"
                  rows="3"
                  placeholder="Any special routing requirements or constraints..."
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel</button
            ><button
              type="button"
              class="btn btn-primary"
              onclick="planRoutes()"
            >
              <i class="fas fa-brain me-2"></i>Generate AI Route Plan
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      let map;
      let jobSites = {{ data.job_sites | tojsonfilter }};
      let equipmentFleet = {{ data.equipment_fleet | tojsonfilter }};

      // Initialize map
      function initMap() {
      map = L.map('routeMap').setView([32.7767, -96.7970], 10);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      // Add job site markers
      jobSites.forEach((site, index) => {
      L.marker([site.location.lat, site.location.lng])
      .addTo(map)
      .bindPopup(`<b>${site.name}</b><br>${site.address}<br>Scenario: ${site.scenario}`)
      .openPopup();
      });

      // Add equipment markers
      equipmentFleet.slice(0, 10).forEach(equipment => {
      L.circleMarker([equipment.current_location.lat, equipment.current_location.lng], {
      color: equipment.availability === 'available' ? 'green' : 'red',
      radius: 8
      })
      .addTo(map)
      .bindPopup(`<b>${equipment.name}</b><br>Type: ${equipment.type}<br>Status: ${equipment.availability}`);
      });
      }

      function selectScenario(scenarioId) {
      document.querySelector('[name="scenario"]').value = scenarioId;
      bootstrap.Modal.getOrCreateInstance(document.getElementById('scenarioModal')).show();
      }

      function planRoutes() {
      const form = document.getElementById('routePlanForm');
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // Get selected job site
      const jobSiteIndex = parseInt(data.job_site);
      const selectedJobSite = jobSites[jobSiteIndex];

      if (!selectedJobSite) {
      alert('Please select a valid job site');
      return;
      }

      // Show loading
      document.getElementById('predictionResults').style.display = 'block';
      document.getElementById('predictionContent').innerHTML = `
      <div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Analyzing routes...</span></div><p class="mt-2">AI analyzing optimal equipment routing...</p></div>
      `;

      // Call API
      fetch('/api/predict-routes', {
      method: 'POST',
      headers: {
      'Content-Type': 'application/json',
      },
      body: JSON.stringify({
      scenario: data.scenario,
      job_site: selectedJobSite
      })
      })
      .then(response => response.json())
      .then(result => {
      if (result.success) {
      displayPredictionResults(result.prediction);
      } else {
      document.getElementById('predictionContent').innerHTML = `
      <div class="alert alert-danger">
      Error generating route prediction: ${result.error}
      </div>
      `;
      }
      bootstrap.Modal.getInstance(document.getElementById('scenarioModal')).hide();
      })
      .catch(error => {
      document.getElementById('predictionContent').innerHTML = `
      <div class="alert alert-danger">
      Network error: ${error}
      </div>
      `;
      });
      }

      function displayPredictionResults(prediction) {
      const content = `
      <div class="row"><div class="col-md-8"><h6>Optimal Routes</h6>
      ${prediction.optimal_routes ? prediction.optimal_routes.map(route => `
      <div class="card mb-2"><div class="card-body"><div class="d-flex justify-content-between"><div><strong>${route.equipment_name}</strong><br><small class="text-muted">${route.estimated_travel_time} • $${route.fuel_cost}</small></div><span class="badge bg-success">${route.route_efficiency}% Efficient</span></div></div></div>
      `).join('') : 'No routes available'}
      </div><div class="col-md-4"><div class="text-center"><h3 class="efficiency-badge badge bg-primary">${prediction.efficiency_score}%</h3><p>Overall Efficiency</p><div class="cost-display text-white">$${prediction.cost_estimate}</div><small>Total Cost Estimate</small></div><hr><h6>Recommendations</h6><ul class="list-unstyled">
      ${prediction.recommendations ? prediction.recommendations.map(rec => `<li><i class="fas fa-check text-success me-2"></i>${rec}</li>`).join('') : ''}
      </ul></div></div>
      `;
      document.getElementById('predictionContent').innerHTML = content;
      }

      function refreshConditions() {
      // Simulate refresh
      location.reload();
      }

      // Initialize when page loads
      document.addEventListener('DOMContentLoaded', function() {
      initMap();
      });
    </script>
  </body>
</html>

<!-- Intelligence Export Widget -->
<div class="intelligence-export-widget" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
    <div class="export-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <div>
            <h3 style="color: white; margin: 0; font-size: 1.4em; font-weight: 600;">Intelligence Export Hub</h3>
            <p style="color: rgba(255,255,255,0.8); margin: 5px 0 0 0; font-size: 0.9em;">Export data for dashboard integration</p>
        </div>
        <div class="export-status" style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 25px; color: white; font-size: 0.8em;">
            <span id="data-freshness">Real-time</span>
        </div>
    </div>

    <!-- Quick Export Buttons -->
    <div class="quick-export-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <button onclick="exportIntelligence('json')" class="export-btn" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px);">
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.5 2.5A1.5 1.5 0 0 0 7 4v1H4.5A1.5 1.5 0 0 0 3 6.5v7A1.5 1.5 0 0 0 4.5 15h7a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 11.5 5H9V4a1.5 1.5 0 0 0-1.5-1.5z"/>
                </svg>
                <span>JSON Export</span>
            </div>
        </button>

        <button onclick="exportIntelligence('csv')" class="export-btn" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px);">
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                </svg>
                <span>CSV Export</span>
            </div>
        </button>

        <button onclick="exportIntelligence('widget-config')" class="export-btn" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px);">
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/>
                </svg>
                <span>Widget Config</span>
            </div>
        </button>

        <button onclick="exportIntelligence('dashboard-bundle')" class="export-btn" style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.5); color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px);">
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                </svg>
                <span>Full Bundle</span>
            </div>
        </button>
    </div>

    <!-- Integration Options -->
    <div class="integration-section" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 16px; margin-top: 15px;">
        <h4 style="color: white; margin: 0 0 12px 0; font-size: 1.1em;">Dashboard Integration</h4>
        <div class="integration-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
            <button onclick="copyApiEndpoint()" class="integration-btn" style="background: rgba(79, 70, 229, 0.3); border: 1px solid rgba(79, 70, 229, 0.5); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                Copy API URL
            </button>
            <button onclick="generateGrafanaConfig()" class="integration-btn" style="background: rgba(245, 158, 11, 0.3); border: 1px solid rgba(245, 158, 11, 0.5); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                Grafana Config
            </button>
            <button onclick="generateTableauConfig()" class="integration-btn" style="background: rgba(6, 182, 212, 0.3); border: 1px solid rgba(6, 182, 212, 0.5); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                Tableau Config
            </button>
            <button onclick="generatePowerBIConfig()" class="integration-btn" style="background: rgba(239, 68, 68, 0.3); border: 1px solid rgba(239, 68, 68, 0.5); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                Power BI Config
            </button>
        </div>
    </div>

    <!-- Export Status -->
    <div id="export-status" style="margin-top: 15px; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; font-size: 0.9em; display: none;">
        <span id="export-message">Ready to export...</span>
    </div>
</div>

<style>
.export-btn:hover, .integration-btn:hover {
    background: rgba(255,255,255,0.25) !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.export-btn:active, .integration-btn:active {
    transform: translateY(0);
}

@media (max-width: 768px) {
    .quick-export-grid {
        grid-template-columns: 1fr 1fr !important;
    }
    .integration-grid {
        grid-template-columns: 1fr 1fr !important;
    }
}
</style>

<script>
// Export Intelligence Functions
function exportIntelligence(format) {
    showExportStatus('Preparing export...', 'info');
    
    const exportUrls = {
        'json': '/api/export/json',
        'csv': '/api/export/csv',
        'xml': '/api/export/xml',
        'widget-config': '/api/export/widget-config',
        'dashboard-bundle': '/api/export/dashboard-bundle'
    };
    
    const url = exportUrls[format];
    if (!url) {
        showExportStatus('Invalid export format', 'error');
        return;
    }
    
    // Create download link
    const link = document.createElement('a');
    link.href = url;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showExportStatus(`${format.toUpperCase()} export initiated`, 'success');
}

function copyApiEndpoint() {
    const apiUrl = window.location.origin + '/api/export/full-intelligence';
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(apiUrl).then(() => {
            showExportStatus('API endpoint copied to clipboard', 'success');
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = apiUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showExportStatus('API endpoint copied to clipboard', 'success');
    }
}

function generateGrafanaConfig() {
    showExportStatus('Generating Grafana configuration...', 'info');
    
    fetch('/api/export/widget-config')
        .then(response => response.json())
        .then(data => {
            const grafanaConfig = {
                dashboard: {
                    title: "Nexus Watson Intelligence",
                    panels: data.configuration.default_charts.map((chart, index) => ({
                        id: index + 1,
                        title: chart.title,
                        type: chart.type === 'gauge' ? 'stat' : chart.type === 'counter' ? 'stat' : 'graph',
                        targets: [{
                            expr: `nexus_${chart.data_source.replace(/\./g, '_')}`,
                            format: "time_series"
                        }]
                    }))
                }
            };
            
            downloadConfig(grafanaConfig, 'nexus_grafana_dashboard.json');
            showExportStatus('Grafana configuration downloaded', 'success');
        })
        .catch(error => {
            showExportStatus('Error generating Grafana config', 'error');
        });
}

function generateTableauConfig() {
    showExportStatus('Generating Tableau configuration...', 'info');
    
    const tableauConfig = {
        workbook: {
            name: "Nexus Watson Intelligence",
            datasource: {
                name: "Nexus Data",
                connection: {
                    class: "webdata-direct",
                    url: window.location.origin + '/api/export/full-intelligence'
                }
            },
            worksheets: [
                { name: "Fleet Dashboard", type: "dashboard" },
                { name: "Financial KPIs", type: "scorecard" },
                { name: "Operational Metrics", type: "visualization" }
            ]
        }
    };
    
    downloadConfig(tableauConfig, 'nexus_tableau_config.json');
    showExportStatus('Tableau configuration downloaded', 'success');
}

function generatePowerBIConfig() {
    showExportStatus('Generating Power BI configuration...', 'info');
    
    const powerBIConfig = {
        report: {
            name: "Nexus Watson Intelligence",
            dataSource: {
                type: "Web",
                url: window.location.origin + '/api/export/full-intelligence',
                refreshRate: "PT5M"
            },
            pages: [
                { name: "Fleet Overview", visualizations: ["fleet_efficiency", "asset_status"] },
                { name: "Financial Dashboard", visualizations: ["cost_savings", "roi_metrics"] },
                { name: "Operational Intelligence", visualizations: ["performance_kpis", "trends"] }
            ]
        }
    };
    
    downloadConfig(powerBIConfig, 'nexus_powerbi_config.json');
    showExportStatus('Power BI configuration downloaded', 'success');
}

function downloadConfig(config, filename) {
    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function showExportStatus(message, type) {
    const statusDiv = document.getElementById('export-status');
    const messageSpan = document.getElementById('export-message');
    
    messageSpan.textContent = message;
    statusDiv.style.display = 'block';
    
    // Color coding based on type
    if (type === 'success') {
        statusDiv.style.background = 'rgba(16, 185, 129, 0.2)';
        statusDiv.style.border = '1px solid rgba(16, 185, 129, 0.5)';
    } else if (type === 'error') {
        statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
        statusDiv.style.border = '1px solid rgba(239, 68, 68, 0.5)';
    } else {
        statusDiv.style.background = 'rgba(79, 70, 229, 0.2)';
        statusDiv.style.border = '1px solid rgba(79, 70, 229, 0.5)';
    }
    
    // Hide after 3 seconds
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 3000);
}

// Update data freshness indicator
function updateDataFreshness() {
    const freshnessSpan = document.getElementById('data-freshness');
    const now = new Date();
    freshnessSpan.textContent = `Updated ${now.toLocaleTimeString()}`;
}

// Update freshness every 30 seconds
setInterval(updateDataFreshness, 30000);
</script>
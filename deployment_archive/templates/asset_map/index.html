{% extends "base.html" %} {% block title %}Asset Map - TRAXOVO{% endblock %} {%
block extra_css %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='mobile-responsive.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='smooth-transitions.css') }}"
/>
<style>
  /* TRAXOVO Core Design System Integration */
  body {
    background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
  }

  #content-wrapper {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 80px);
    overflow: hidden;
    background: transparent;
  }

  .asset-map-header {
    background: rgba(15, 20, 25, 0.9);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 20px 24px;
    margin-bottom: 0;
  }

  .asset-map-header h2 {
    color: #fff;
    font-weight: 600;
    font-size: 1.5rem;
    margin: 0;
    background: linear-gradient(45deg, #007aff, #00d4ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .asset-map-header small {
    color: #8e8e93;
    font-size: 0.875rem;
    font-weight: 400;
  }

  .map-container {
    display: flex;
    flex: 1;
    overflow: hidden;
    gap: 0;
  }

  .asset-sidebar {
    width: 320px;
    height: 100%;
    overflow-y: auto;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    padding: 24px;
    -webkit-overflow-scrolling: touch;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .asset-sidebar h5 {
    color: #fff;
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .filter-section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
  }

  .filter-section:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(59, 130, 246, 0.3);
    transform: translateY(-1px);
  }

  .form-label {
    color: #d1d5db;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 8px;
    display: block;
  }

  .form-select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: #fff;
    padding: 12px 16px;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    width: 100%;
  }

  .form-select:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
  }

  .form-select option {
    background: #1a2332;
    color: #fff;
  }

  .btn-refresh {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    border: none;
    border-radius: 8px;
    color: white;
    padding: 12px 20px;
    font-size: 0.875rem;
    font-weight: 600;
    width: 100%;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .btn-refresh:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
  }

  .btn-refresh:active {
    transform: translateY(0);
  }

  #map {
    flex: 1;
    height: 100%;
    border-radius: 0;
    position: relative;
  }

  .status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 12px;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
  }

  .legend-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    color: #d1d5db;
    font-size: 0.875rem;
    transition: color 0.3s ease;
  }

  .legend-item:hover {
    color: #fff;
  }

  .status-active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
  }

  .status-idle {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3);
  }

  .status-maintenance {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
  }

  .status-inactive {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.3);
  }

  .system-status {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .status-badge {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .update-time {
    color: #8e8e93;
    font-size: 0.75rem;
    margin-top: 8px;
  }

  /* Mobile Responsive Enhancements */
  @media (max-width: 768px) {
    .asset-sidebar {
      position: fixed;
      left: -320px;
      top: 0;
      height: 100vh;
      z-index: 1000;
      transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .asset-sidebar.mobile-open {
      left: 0;
    }

    .map-container {
      flex-direction: column;
    }

    #map {
      height: calc(100vh - 120px);
    }

    .asset-map-header {
      padding: 16px 20px;
    }

    .mobile-menu-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: rgba(59, 130, 246, 0.9);
      border: none;
      border-radius: 8px;
      color: white;
      padding: 12px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .mobile-menu-toggle:hover {
      background: rgba(59, 130, 246, 1);
      transform: scale(1.05);
    }
  }

  /* Touch-friendly enhancements */
  .filter-section,
  .btn-refresh,
  .legend-item {
    min-height: 44px;
    display: flex;
    align-items: center;
  }

  /* Loading states */
  .loading-shimmer {
    background: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0.1) 25%,
      rgba(255, 255, 255, 0.2) 50%,
      rgba(255, 255, 255, 0.1) 75%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }
</style>
{% endblock %} {% block content %}
<div id="content-wrapper">
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle d-md-none" onclick="toggleMobileSidebar()">
    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
      <path
        d="M3 12h18M3 6h18M3 18h18"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
      />
    </svg>
  </button>

  <div class="asset-map-header">
    <h2>Asset Map <small>Real-time Fleet Tracking</small></h2>
  </div>

  <div class="map-container">
    <!-- Enhanced Sidebar with TRAXOVO Design System -->
    <div class="asset-sidebar" id="asset-sidebar">
      <div class="filter-section">
        <h5>Filters</h5>
        <div class="mb-3">
          <label class="form-label">Asset Type</label>
          <select id="type-filter" class="form-select">
            <option value="">All Types</option>
            {% for type in asset_types %}
            <option value="{{ type }}">{{ type }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Job Site</label>
          <select id="job-site-filter" class="form-select">
            <option value="">All Job Sites</option>
            {% for site in job_sites %}
            <option value="{{ site.id }}">{{ site.name }}</option>
            {% endfor %}
          </select>
        </div>

        <button
          id="refresh-map"
          class="btn-refresh"
          onclick="refreshAssetMap()"
        >
          <svg
            width="16"
            height="16"
            fill="currentColor"
            viewBox="0 0 24 24"
            style="margin-right: 8px"
          >
            <path
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              fill="none"
            />
          </svg>
          Refresh Map
        </button>
      </div>

      <div class="filter-section">
        <h5>Map Legend</h5>
        <div class="legend-item">
          <span class="status-indicator status-active"></span> Active
        </div>
        <div class="legend-item">
          <span class="status-indicator status-idle"></span> Idle
        </div>
        <div class="legend-item">
          <span class="status-indicator status-maintenance"></span> Maintenance
        </div>
        <div class="legend-item">
          <span class="status-indicator status-inactive"></span> Inactive
        </div>
      </div>

      <div class="system-status">
        <h5>System Status</h5>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span>API Connection</span>
          <span class="status-badge" id="api-status-badge">Connected</span>
        </div>
        <div class="update-time">
          Last update: <span id="last-update-time">Just now</span>
        </div>
      </div>
    </div>

    <!-- Map Area -->
    <div id="map"></div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script src="{{ url_for('static', filename='enterprise-polish.js') }}"></script>
<script src="{{ url_for('static', filename='performance-fixes.js') }}"></script>
<script>
  /*
TRAXOVO AssetMap - Enterprise Integration with GAUGE API
Reharmonized with core design system while preserving RadioCast UX
*/

  (function () {
    "use strict";

    var map,
      assetMarkers = {},
      jobSiteMarkers = {};
    var lastUpdateTime = 0;
    var refreshInterval = 30000; // 30 seconds
    var isInitialized = false;

    document.addEventListener("DOMContentLoaded", function () {
      initializeAssetMap();
      setupEventListeners();
      setupMobileResponsiveness();
    });

    function initializeAssetMap() {
      console.log("Initializing TRAXOVO Asset Map...");

      // Initialize the map with enterprise styling
      map = L.map("map", {
        zoomControl: false,
        attributionControl: false,
      }).setView([32.7767, -96.797], 10);

      // Add custom zoom control
      L.control
        .zoom({
          position: "topright",
        })
        .addTo(map);

      // Add tile layer with enterprise styling
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap | TRAXOVO Fleet Intelligence",
        maxZoom: 18,
        className: "map-tiles",
      }).addTo(map);

      // Force proper sizing
      setTimeout(function () {
        map.invalidateSize();
        loadAuthenticAssetData();
        isInitialized = true;
        console.log("Asset Map initialized successfully");
      }, 200);
    }

    function loadAuthenticAssetData() {
      showLoadingState();

      fetch("/api/fleet/assets")
        .then((response) => response.json())
        .then((data) => {
          if (data.success && data.assets) {
            processAuthenticAssets(data.assets);
            updateSystemStatus("Connected", "success");
            updateLastUpdateTime();
          } else {
            console.error("Failed to load authentic asset data:", data);
            updateSystemStatus("Error", "error");
          }
        })
        .catch((error) => {
          console.error("Asset data fetch error:", error);
          updateSystemStatus("Disconnected", "error");
        })
        .finally(() => {
          hideLoadingState();
        });
    }

    function processAuthenticAssets(assets) {
      // Clear existing markers
      Object.values(assetMarkers).forEach((marker) => map.removeLayer(marker));
      assetMarkers = {};

      assets.forEach((asset) => {
        if (asset.Latitude && asset.Longitude) {
          addAssetMarker(asset);
        }
      });

      console.log(`Loaded ${assets.length} authentic assets on map`);
    }

    function addAssetMarker(asset) {
      var status = determineAssetStatus(asset);
      var icon = createEnterpriseAssetIcon(status);

      var marker = L.marker([asset.Latitude, asset.Longitude], { icon: icon })
        .bindPopup(createAssetPopup(asset))
        .addTo(map);

      // Enterprise hover effects
      marker.on("mouseover", function () {
        this.setOpacity(0.8);
      });

      marker.on("mouseout", function () {
        this.setOpacity(1);
      });

      assetMarkers[asset.AssetId || asset.id] = marker;
    }

    function determineAssetStatus(asset) {
      if (!asset.Active) return "inactive";
      if (asset.DaysInactive > 7) return "maintenance";
      if (asset.Engine1Hours > 0) return "active";
      return "idle";
    }

    function createEnterpriseAssetIcon(status) {
      var colors = {
        active: "#10b981",
        idle: "#f59e0b",
        maintenance: "#ef4444",
        inactive: "#6b7280",
      };

      var color = colors[status] || colors.inactive;

      return L.divIcon({
        className: "enterprise-asset-marker",
        html: `<div style="
                background: linear-gradient(135deg, ${color} 0%, ${color}dd 100%);
                width: 16px;
                height: 16px;
                border-radius: 50%;
                border: 3px solid rgba(255,255,255,0.8);
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transition: all 0.3s ease;
            "></div>`,
        iconSize: [22, 22],
        iconAnchor: [11, 11],
      });
    }

    function createAssetPopup(asset) {
      return `
            <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 8px;">
                <h6 style="margin: 0 0 8px 0; color: #1f2937; font-weight: 600;">
                    ${asset.AssetCategory || "Equipment"}
                </h6>
                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 4px;">
                    <strong>Make:</strong> ${asset.AssetMake || "N/A"}
                </div>
                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 4px;">
                    <strong>Model:</strong> ${asset.AssetModel || "N/A"}
                </div>
                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 4px;">
                    <strong>District:</strong> ${asset.District || "N/A"}
                </div>
                <div style="font-size: 0.875rem; color: #6b7280;">
                    <strong>Status:</strong> <span style="color: ${asset.Active ? "#10b981" : "#ef4444"};">
                        ${asset.Active ? "Active" : "Inactive"}
                    </span>
                </div>
            </div>
        `;
    }

    function setupEventListeners() {
      // Refresh button
      var refreshButton = document.getElementById("refresh-map");
      if (refreshButton) {
        refreshButton.addEventListener("click", function () {
          refreshAssetMap();
        });
      }

      // Filter changes
      var typeFilter = document.getElementById("type-filter");
      var jobSiteFilter = document.getElementById("job-site-filter");

      if (typeFilter) {
        typeFilter.addEventListener("change", applyFilters);
      }

      if (jobSiteFilter) {
        jobSiteFilter.addEventListener("change", applyFilters);
      }

      // Auto-refresh
      setInterval(function () {
        if (document.visibilityState === "visible" && isInitialized) {
          loadAuthenticAssetData();
        }
      }, refreshInterval);
    }

    function setupMobileResponsiveness() {
      // Mobile sidebar toggle
      window.toggleMobileSidebar = function () {
        var sidebar = document.getElementById("asset-sidebar");
        if (sidebar) {
          sidebar.classList.toggle("mobile-open");
        }
      };

      // Close sidebar when clicking map on mobile
      if (window.innerWidth <= 768) {
        map.on("click", function () {
          var sidebar = document.getElementById("asset-sidebar");
          if (sidebar && sidebar.classList.contains("mobile-open")) {
            sidebar.classList.remove("mobile-open");
          }
        });
      }
    }

    function applyFilters() {
      var typeFilter = document.getElementById("type-filter").value;
      var jobSiteFilter = document.getElementById("job-site-filter").value;

      Object.values(assetMarkers).forEach((marker) => {
        // Filter logic would go here based on authentic asset data
        map.addLayer(marker);
      });
    }

    function showLoadingState() {
      var refreshButton = document.getElementById("refresh-map");
      if (refreshButton) {
        refreshButton.innerHTML =
          '<div style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; display: inline-block;"></div>Loading...';
        refreshButton.disabled = true;
      }
    }

    function hideLoadingState() {
      var refreshButton = document.getElementById("refresh-map");
      if (refreshButton) {
        refreshButton.innerHTML =
          '<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>Refresh Map';
        refreshButton.disabled = false;
      }
    }

    function updateSystemStatus(status, type) {
      var badge = document.getElementById("api-status-badge");
      if (badge) {
        badge.textContent = status;
        badge.className =
          type === "success" ? "status-badge" : "status-badge bg-danger";
      }
    }

    function updateLastUpdateTime() {
      var timeElement = document.getElementById("last-update-time");
      if (timeElement) {
        timeElement.textContent = new Date().toLocaleTimeString();
      }
      lastUpdateTime = Date.now();
    }

    // Global function for refresh button
    window.refreshAssetMap = function () {
      if (isInitialized) {
        loadAuthenticAssetData();
      }
    };

    // CSS for loading animation
    var style = document.createElement("style");
    style.textContent =
      "@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }";
    document.head.appendChild(style);
  })();
</script>
{% endblock %}

{% extends "layout_unified.html" %} {% block title %}Attendance Dashboard |
TRAXOVO{% endblock %} {% block head_content %}
<style>
  .classification-badge {
    font-size: 0.85rem;
    padding: 0.35em 0.65em;
    font-weight: 600;
  }
  .badge-on-time {
    background-color: var(--bs-success);
    color: white;
  }
  .badge-late {
    background-color: var(--bs-warning);
    color: var(--bs-dark);
  }
  .badge-early-end {
    background-color: var(--bs-info);
    color: var(--bs-dark);
  }
  .badge-not-on-job {
    background-color: var(--bs-danger);
    color: white;
  }
  .datepicker-dropdown {
    z-index: 1060;
  }
  .driver-details-row {
    transition: all 0.3s ease;
  }
  .contact-collapse {
    background-color: rgba(0, 0, 0, 0.05);
  }
  .insights-card {
    border-left: 4px solid var(--bs-primary);
    transition: all 0.2s ease;
  }
  .insights-card:hover {
    transform: translateX(5px);
  }
  .reliability-high {
    border-left-color: var(--bs-success);
  }
  .reliability-medium {
    border-left-color: var(--bs-warning);
  }
  .reliability-low {
    border-left-color: var(--bs-danger);
  }
  .metric-card {
    transition: all 0.3s ease;
  }
  .metric-card:hover {
    transform: translateY(-5px);
  }
  .metric-card-success {
    border-left: 4px solid var(--bs-success);
  }
  .metric-card-warning {
    border-left: 4px solid var(--bs-warning);
  }
  .metric-card-danger {
    border-left: 4px solid var(--bs-danger);
  }
  .metric-card-info {
    border-left: 4px solid var(--bs-info);
  }

  /* Mobile Optimization Styles */
  @media (max-width: 768px) {
    .container-fluid {
      padding: 0.5rem !important;
    }

    .page-header h1 {
      font-size: 1.5rem !important;
    }

    .date-selector {
      width: 100%;
      margin-bottom: 0.5rem;
    }

    .card {
      margin-bottom: 1rem !important;
    }

    .metric-card .h2 {
      font-size: 1.75rem;
    }

    .card-header {
      padding: 0.75rem !important;
      flex-direction: column !important;
      align-items: flex-start !important;
    }

    .card-header .filter-buttons {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .card-header .filter-buttons .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    .table {
      font-size: 0.85rem;
    }

    .table th,
    .table td {
      padding: 0.5rem 0.25rem !important;
    }

    .btn-sm {
      padding: 0.25rem 0.4rem;
      font-size: 0.75rem;
    }

    .classification-badge {
      font-size: 0.7rem;
      padding: 0.25em 0.5em;
    }

    /* Touch-friendly spacing */
    .btn {
      margin: 0.2rem;
      min-height: 38px;
    }

    /* Improved table scrolling */
    .table-responsive {
      -webkit-overflow-scrolling: touch;
      border-radius: 0.25rem;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid px-4">
  <div
    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 page-header"
  >
    <h1 class="h3 mb-3 mb-md-0 text-light">Automatic Attendance Dashboard</h1>
    <div class="d-flex flex-column flex-md-row w-100 w-md-auto">
      <div class="input-group date-selector mb-2 mb-md-0 me-md-2">
        <select class="form-select" id="dateSelector">
          {% for date in available_dates %}
          <option
            value="{{ date }}"
            {%
            if
            date=""
            ="selected_date"
            %}selected{%
            endif
            %}
          >
            {{ date }}
          </option>
          {% endfor %}</select
        ><button class="btn btn-primary" id="viewDateBtn">
          <i class="fas fa-search"></i
          ><span class="d-none d-md-inline">View</span>
        </button>
      </div>
      <a
        href="{{ url_for('auto_attendance.generate_report', date=selected_date) }}"
        class="btn btn-outline-primary w-100 w-md-auto"
        ><i class="fas fa-sync-alt"></i
        ><span class="d-none d-md-inline">Regenerate</span></a
      >
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow h-100 metric-card metric-card-success">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-uppercase mb-1">
                On Time
              </div>
              <div class="h2 mb-0 font-weight-bold">{{ summary.on_time }}</div>
              <div class="mt-2 text-muted small">
                {{ (summary.on_time / summary.total_drivers * 100)|round|int }}%
                of drivers
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-check-circle fa-2x text-success"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow h-100 metric-card metric-card-warning">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-uppercase mb-1">
                Late
              </div>
              <div class="h2 mb-0 font-weight-bold">{{ summary.late }}</div>
              <div class="mt-2 text-muted small">
                {{ (summary.late / summary.total_drivers * 100)|round|int }}% of
                drivers
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clock fa-2x text-warning"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow h-100 metric-card metric-card-info">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-uppercase mb-1">
                Early End
              </div>
              <div class="h2 mb-0 font-weight-bold">
                {{ summary.early_end }}
              </div>
              <div class="mt-2 text-muted small">
                {{ (summary.early_end / summary.total_drivers * 100)|round|int
                }}% of drivers
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-sign-out-alt fa-2x text-info"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow h-100 metric-card metric-card-danger">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-uppercase mb-1">
                Not On Job
              </div>
              <div class="h2 mb-0 font-weight-bold">
                {{ summary.not_on_job }}
              </div>
              <div class="mt-2 text-muted small">
                {{ (summary.not_on_job / summary.total_drivers * 100)|round|int
                }}% of drivers
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card border-0 shadow mb-4">
    <div
      class="card-header py-3 d-flex justify-content-between align-items-center"
    >
      <h6 class="m-0 font-weight-bold">
        Driver Attendance Report ({{ selected_date }})
      </h6>
      <div class="filter-buttons">
        <button class="btn btn-sm btn-outline-success" id="filterOnTime">
          <i class="fas fa-check-circle"></i
          ><span class="d-none d-md-inline">On Time</span></button
        ><button class="btn btn-sm btn-outline-warning" id="filterLate">
          <i class="fas fa-clock"></i
          ><span class="d-none d-md-inline">Late</span></button
        ><button class="btn btn-sm btn-outline-info" id="filterEarlyEnd">
          <i class="fas fa-sign-out-alt"></i
          ><span class="d-none d-md-inline">Early End</span></button
        ><button class="btn btn-sm btn-outline-danger" id="filterNotOnJob">
          <i class="fas fa-exclamation-triangle"></i
          ><span class="d-none d-md-inline">Not On Job</span></button
        ><button class="btn btn-sm btn-outline-secondary" id="filterAll">
          <i class="fas fa-list"></i><span class="d-none d-md-inline">All</span>
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="d-md-none mb-4">
        {% for driver in drivers %}
        <div
          class="card driver-card mb-3 border-0 shadow-sm driver-{{ driver.classification }}"
        >
          <div
            class="card-header bg-white d-flex justify-content-between align-items-center"
          >
            <h6 class="mb-0 fw-bold">{{ driver.driver_name }}</h6>
            <span
              class="badge classification-badge badge-{{ driver.classification }}"
            >
              {% if driver.classification == 'on_time' %}
              <i class="fas fa-check-circle me-1"></i> On Time {% elif
              driver.classification == 'late' %}
              <i class="fas fa-clock me-1"></i> Late {% elif
              driver.classification == 'early_end' %}
              <i class="fas fa-sign-out-alt me-1"></i> Early End {% elif
              driver.classification == 'not_on_job' %}
              <i class="fas fa-exclamation-triangle me-1"></i> Not On Job {%
              else %} <i class="fas fa-question-circle me-1"></i> Unknown {%
              endif %}
            </span>
          </div>
          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <div class="text-primary" style="width: 24px">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <div><strong>Job Site:</strong> {{ driver.job_site }}</div>
            </div>
            <div class="d-flex align-items-center mb-2">
              <div class="text-primary" style="width: 24px">
                <i class="fas fa-clock"></i>
              </div>
              <div><strong>Start:</strong> {{ driver.start_time }}</div>
            </div>
            <div class="d-flex align-items-center mb-3">
              <div class="text-primary" style="width: 24px">
                <i class="fas fa-flag-checkered"></i>
              </div>
              <div><strong>End:</strong> {{ driver.end_time }}</div>
            </div>
            <button
              class="btn btn-sm btn-primary w-100 mobile-details-btn"
              data-driver-name="{{ driver.driver_name }}"
              data-bs-toggle="collapse"
              data-bs-target="#mobile-details-{{ driver.driver_name|replace(' ', '-')|lower }}"
              aria-expanded="false"
            >
              <i class="fas fa-info-circle me-1"></i> Show Details
            </button>
            <div
              class="collapse mt-3"
              id="mobile-details-{{ driver.driver_name|replace(' ', '-')|lower }}"
            >
              <div class="card card-body border-0 bg-light">
                <div class="d-flex align-items-center mb-2">
                  <div class="text-primary" style="width: 24px">
                    <i class="fas fa-phone"></i>
                  </div>
                  <div><strong>Phone:</strong> {{ driver.phone }}</div>
                </div>
                <div class="d-flex align-items-center mb-2">
                  <div class="text-primary" style="width: 24px">
                    <i class="fas fa-envelope"></i>
                  </div>
                  <div><strong>Email:</strong> {{ driver.email }}</div>
                </div>
                {% if driver.reason %}
                <div class="d-flex align-items-center mb-2">
                  <div class="text-primary" style="width: 24px">
                    <i class="fas fa-info-circle"></i>
                  </div>
                  <div><strong>Reason:</strong> {{ driver.reason }}</div>
                </div>
                {% endif %} {% if driver.driver_name in driver_insights %} {%
                set insight = driver_insights[driver.driver_name] %}
                <div class="mt-3 pt-3 border-top">
                  <h6 class="mb-2">
                    <i class="fas fa-chart-line me-2"></i> Driver Insights
                  </h6>
                  <div class="d-flex align-items-center mb-2">
                    <div class="text-info" style="width: 24px">
                      <i class="fas fa-clock"></i>
                    </div>
                    <div>
                      <strong>Typical Start:</strong> {{
                      insight.common_start_time }}
                    </div>
                  </div>
                  <div class="d-flex align-items-center mb-2">
                    <div class="text-info" style="width: 24px">
                      <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div>
                      <strong>Most Common Job:</strong> {{
                      insight.most_common_job_site }}
                    </div>
                  </div>
                  <div class="d-flex align-items-center mb-2">
                    <div class="text-info" style="width: 24px">
                      <i class="fas fa-percentage"></i>
                    </div>
                    <div>
                      <strong>On-time Rate:</strong> {{
                      insight.on_time_percentage }}%
                    </div>
                  </div>
                  <div class="d-flex align-items-center">
                    <div class="text-info" style="width: 24px">
                      <i class="fas fa-comment"></i>
                    </div>
                    <div>{{ insight.suggestion }}</div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="table-responsive d-none d-md-block">
        <table class="table table-hover" id="driversTable">
          <thead>
            <tr>
              <th>Driver</th>
              <th>Job Site</th>
              <th>Start Time</th>
              <th>End Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for driver in drivers %}
            <tr class="driver-row driver-{{ driver.classification }}">
              <td>{{ driver.driver_name }}</td>
              <td>{{ driver.job_site }}</td>
              <td>{{ driver.start_time }}</td>
              <td>{{ driver.end_time }}</td>
              <td>
                <span
                  class="badge classification-badge badge-{{ driver.classification }}"
                >
                  {% if driver.classification == 'on_time' %}
                  <i class="fas fa-check-circle me-1"></i> On Time {% elif
                  driver.classification == 'late' %}
                  <i class="fas fa-clock me-1"></i> Late {% elif
                  driver.classification == 'early_end' %}
                  <i class="fas fa-sign-out-alt me-1"></i> Early End {% elif
                  driver.classification == 'not_on_job' %}
                  <i class="fas fa-exclamation-triangle me-1"></i> Not On Job {%
                  else %} <i class="fas fa-question-circle me-1"></i> Unknown {%
                  endif %}
                </span>
              </td>
              <td>
                <button
                  class="btn btn-sm btn-outline-primary btn-contact-details"
                  data-driver-name="{{ driver.driver_name }}"
                >
                  <i class="fas fa-info-circle"></i> Details
                </button>
              </td>
            </tr>
            <tr
              class="driver-details-row d-none"
              id="details-{{ driver.driver_name|replace(' ', '-')|lower }}"
            >
              <td colspan="6" class="p-0">
                <div class="contact-collapse p-3">
                  <div class="row">
                    <div class="col-md-6">
                      <h6 class="mb-2">Contact Information</h6>
                      <p class="mb-1">
                        <i class="fas fa-phone me-2 text-primary"></i> {{
                        driver.phone }}
                      </p>
                      <p class="mb-1">
                        <i class="fas fa-envelope me-2 text-primary"></i> {{
                        driver.email }}
                      </p>
                      {% if driver.reason %}
                      <p class="mt-3">
                        <strong>Classification Reason:</strong> {{ driver.reason
                        }}
                      </p>
                      {% endif %}
                    </div>
                    <div class="col-md-6">
                      {% if driver.driver_name in driver_insights %} {% set
                      insight = driver_insights[driver.driver_name] %}
                      <div
                        class="card insights-card reliability-{{ insight.reliability_rating|lower }} mb-0"
                      >
                        <div class="card-body p-3">
                          <h6 class="mb-2">
                            <i class="fas fa-chart-line me-2"></i> Driver
                            Insights
                          </h6>
                          <p class="mb-1">
                            <i class="fas fa-clock me-2 text-info"></i> Typical
                            Start: {{ insight.common_start_time }}
                          </p>
                          <p class="mb-1">
                            <i class="fas fa-map-marker-alt me-2 text-info"></i>
                            Most Common Job: {{ insight.most_common_job_site }}
                          </p>
                          <p class="mb-1">
                            <i class="fas fa-percentage me-2 text-info"></i>
                            On-time Rate: {{ insight.on_time_percentage }}%
                          </p>
                          <p class="mb-0">
                            <i class="fas fa-comment me-2 text-info"></i> {{
                            insight.suggestion }}
                          </p>
                        </div>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  $(document).ready(function () {
    // Initialize DataTable
    const table = $("#driversTable").DataTable({
      order: [], // No initial sorting
      paging: true,
      searching: true,
      info: true,
      responsive: true,
      columnDefs: [
        { orderable: false, targets: 5 }, // Disable sorting on actions column
      ],
      language: {
        emptyTable: "No driver data available for this date",
      },
    });

    // Date selector functionality
    $("#viewDateBtn").click(function () {
      const selectedDate = $("#dateSelector").val();
      window.location.href =
        "{{ url_for('auto_attendance.index') }}?date=" + selectedDate;
    });

    // Contact details toggle
    $(".btn-contact-details").click(function () {
      const driverName = $(this).data("driver-name");
      const detailsRow = $(
        `#details-${driverName.replace(/\s+/g, "-").toLowerCase()}`,
      );

      if (detailsRow.hasClass("d-none")) {
        // Hide all other detail rows first
        $(".driver-details-row").addClass("d-none");
        // Show this detail row
        detailsRow.removeClass("d-none");
      } else {
        // Hide this detail row
        detailsRow.addClass("d-none");
      }
    });

    // Filter buttons
    $("#filterOnTime").click(function () {
      table.search("On Time").draw();
    });

    $("#filterLate").click(function () {
      table.search("Late").draw();
    });

    $("#filterEarlyEnd").click(function () {
      table.search("Early End").draw();
    });

    $("#filterNotOnJob").click(function () {
      table.search("Not On Job").draw();
    });

    $("#filterAll").click(function () {
      table.search("").draw();
    });

    // Make row highlighting on hover more interactive
    $("#driversTable tbody")
      .on("mouseenter", "tr.driver-row", function () {
        $(this).addClass("bg-light bg-opacity-25");
      })
      .on("mouseleave", "tr.driver-row", function () {
        $(this).removeClass("bg-light bg-opacity-25");
      });

    // GENIUS CORE data integration
    console.log("GENIUS CORE attendance module initialized");

    // Capture error telemetry
    window.addEventListener("error", function (e) {
      console.error("GENIUS CORE attendance module error:", e.message);
    });
  });
</script>
{% endblock %}

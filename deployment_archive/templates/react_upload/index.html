<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TRAXOVO - Modern File Uploader</title>
    <link
      rel="stylesheet"
      href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css"
    />

    <!-- React and Dependencies -->
    <script
      src="https://unpkg.com/react@18/umd/react.production.min.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
      body {
        padding-top: 2rem;
        padding-bottom: 2rem;
      }

      .dropzone {
        border: 2px dashed var(--bs-primary);
        border-radius: 0.75rem;
        min-height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        cursor: pointer;
        transition:
          border-color 0.3s,
          background-color 0.3s;
        padding: 2rem;
        margin-bottom: 1.5rem;
      }

      .dropzone.highlight {
        border-color: var(--bs-success);
        background-color: rgba(var(--bs-success-rgb), 0.05);
      }

      .status-indicator {
        margin-top: 1rem;
        font-weight: 500;
      }

      .results-card {
        margin-top: 1.5rem;
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .reason-chip {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem;
        border-radius: 1rem;
        font-size: 0.85rem;
        background-color: var(--bs-warning-bg-subtle);
        color: var(--bs-warning-text);
      }

      .hidden-input {
        display: none;
      }

      .icon {
        color: var(--bs-primary);
        margin-bottom: 1rem;
      }

      .stats-card {
        transition: all 0.3s ease;
      }

      .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <h1 class="display-6 mb-0">TRAXOVO</h1>
          <span class="badge bg-info ms-3">GENIUS CORE</span>
        </div>
        <h2 class="h4 mb-4 text-secondary">Modern File Uploader</h2>
      </header>

      <div id="react-app"></div>
    </div>

    <script type="text/babel">
      // FileUploader Component
      function FileUploader() {
        const [status, setStatus] = React.useState("Waiting for file...");
        const [isUploading, setIsUploading] = React.useState(false);
        const [results, setResults] = React.useState(null);
        const [isDragOver, setIsDragOver] = React.useState(false);
        const fileInputRef = React.useRef(null);

        const handleDragOver = (e) => {
          e.preventDefault();
          e.stopPropagation();
          setIsDragOver(true);
        };

        const handleDragLeave = (e) => {
          e.preventDefault();
          e.stopPropagation();
          setIsDragOver(false);
        };

        const handleDrop = (e) => {
          e.preventDefault();
          e.stopPropagation();
          setIsDragOver(false);

          const files = e.dataTransfer.files;
          if (files.length) {
            handleFileUpload(files[0]);
          }
        };

        const handleFileInputChange = (e) => {
          const file = e.target.files[0];
          if (file) {
            handleFileUpload(file);
          }
        };

        const handleFileUpload = async (file) => {
          if (!file) return;

          // Validate file type
          const validTypes = [".csv", ".xlsx", ".xls"];
          const fileName = file.name.toLowerCase();
          if (!validTypes.some((type) => fileName.endsWith(type))) {
            setStatus(
              `Error: Invalid file type. Please upload a CSV or Excel file.`,
            );
            return;
          }

          setIsUploading(true);
          setStatus(`Uploading and processing ${file.name}...`);

          const formData = new FormData();
          formData.append("file", file);

          try {
            const response = await fetch("/upload", {
              method: "POST",
              body: formData,
            });

            const data = await response.json();

            if (data.error) {
              setStatus(`Error: ${data.error}`);
            } else {
              setResults(data);
              setStatus("File processed successfully.");
            }
          } catch (error) {
            setStatus(`Error: ${error.message || "Unknown error occurred"}`);
          } finally {
            setIsUploading(false);
          }
        };

        const handleOpenFileDialog = () => {
          if (fileInputRef.current) {
            fileInputRef.current.click();
          }
        };

        // Get unique skip reasons
        const getUniqueSkipReasons = () => {
          if (!results || !results.skipped) return [];

          // Extract unique reasons
          const reasons = new Set();
          results.skipped.forEach((item) => {
            if (item.classification && item.classification.reason) {
              reasons.add(item.classification.reason);
            } else if (item.reason) {
              reasons.add(item.reason);
            }
          });

          return Array.from(reasons);
        };

        return (
          <div className="row">
            <div className="col-lg-8">
              <div className="card mb-4">
                <div className="card-body">
                  <h3 className="card-title h5 mb-3">
                    Upload File for Processing
                  </h3>
                  <p className="text-muted small mb-4">
                    Upload a CSV or Excel file containing driver data for
                    classification. Files will be automatically processed using
                    the GENIUS CORE driver classification system.
                  </p>

                  <div
                    className={`dropzone ${isDragOver ? "highlight" : ""}`}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                    onClick={handleOpenFileDialog}
                  >
                    <span className="icon">
                      <i data-lucide="upload" width="32" height="32"></i>
                    </span>
                    <h5 className="mb-2">Drop file here or click to browse</h5>
                    <p className="text-muted small">
                      Accepts CSV and Excel files (.csv, .xlsx, .xls)
                    </p>
                    <input
                      type="file"
                      ref={fileInputRef}
                      className="hidden-input"
                      accept=".csv,.xlsx,.xls"
                      onChange={handleFileInputChange}
                    />
                  </div>

                  <div className="status-indicator">
                    {isUploading ? (
                      <div className="d-flex align-items-center">
                        <div
                          className="spinner-border spinner-border-sm me-2"
                          role="status"
                        >
                          <span className="visually-hidden">Loading...</span>
                        </div>
                        <span>{status}</span>
                      </div>
                    ) : (
                      <span
                        className={
                          status.includes("Error") ? "text-danger" : "text-info"
                        }
                      >
                        {status}
                      </span>
                    )}
                  </div>

                  {results && (
                    <div className="results-card fade-in">
                      <h4 className="h5 mt-4 mb-3">Classification Results</h4>

                      <div className="row mb-4">
                        <div className="col-md-4">
                          <div className="card stats-card">
                            <div className="card-body text-center py-3">
                              <h6 className="card-subtitle mb-2 text-muted">
                                Records Processed
                              </h6>
                              <h2 className="card-title mb-0">
                                {results.records_processed || 0}
                              </h2>
                            </div>
                          </div>
                        </div>
                        <div className="col-md-4">
                          <div className="card stats-card">
                            <div className="card-body text-center py-3 text-success">
                              <h6 className="card-subtitle mb-2 text-muted">
                                Classified
                              </h6>
                              <h2 className="card-title mb-0">
                                {results.classified_count || 0}
                              </h2>
                            </div>
                          </div>
                        </div>
                        <div className="col-md-4">
                          <div className="card stats-card">
                            <div className="card-body text-center py-3 text-warning">
                              <h6 className="card-subtitle mb-2 text-muted">
                                Skipped
                              </h6>
                              <h2 className="card-title mb-0">
                                {results.skipped_count || 0}
                              </h2>
                            </div>
                          </div>
                        </div>
                      </div>

                      {results.skipped_count > 0 && (
                        <div className="skip-reasons mt-3">
                          <h5 className="h6 mb-2">Skip Reasons:</h5>
                          <div>
                            {getUniqueSkipReasons().map((reason, index) => (
                              <span key={index} className="reason-chip">
                                {reason.replace(/_/g, " ")}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>

            <div className="col-lg-4">
              <div className="card">
                <div className="card-body">
                  <h5 className="card-title h6">Filter Criteria</h5>
                  <div className="mt-3">
                    <p className="text-muted small mb-2">
                      GENIUS CORE Classification:
                    </p>
                    <ul className="list-group list-group-flush small">
                      <li className="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                        Vehicle Type
                        <span className="badge bg-info rounded-pill">
                          Pickup Truck
                        </span>
                      </li>
                      <li className="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                        Usage Type
                        <span className="badge bg-info rounded-pill">
                          On-Road
                        </span>
                      </li>
                      <li className="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                        Job Site
                        <span className="badge bg-info rounded-pill">
                          Valid
                        </span>
                      </li>
                    </ul>
                  </div>

                  {results && results.classified_count > 0 && (
                    <div className="mt-4">
                      <h6 className="mb-2">Quick Stats</h6>
                      <div className="small">
                        <div className="mb-1 d-flex justify-content-between">
                          <span>Success Rate:</span>
                          <span className="fw-bold">
                            {Math.round(
                              (results.classified_count /
                                results.records_processed) *
                                100,
                            )}
                            %
                          </span>
                        </div>
                        <div className="mb-1 d-flex justify-content-between">
                          <span>Classification Time:</span>
                          <span className="fw-bold">Fast</span>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {results && results.metrics && (
                <div className="card mt-3">
                  <div className="card-body">
                    <h5 className="card-title h6">Classification Metrics</h5>
                    <div className="small mt-3">
                      {Object.entries(results.metrics).map(([key, value]) => {
                        if (typeof value === "object") return null;
                        return (
                          <div
                            key={key}
                            className="mb-1 d-flex justify-content-between"
                          >
                            <span>{key.replace(/_/g, " ")}:</span>
                            <span className="fw-bold">{value}</span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Mount the React component
      const root = ReactDOM.createRoot(document.getElementById("react-app"));
      root.render(<FileUploader />);

      // Initialize Lucide icons after the component is mounted
      document.addEventListener("DOMContentLoaded", () => {
        lucide.createIcons();
      });
    </script>
  </body>
</html>

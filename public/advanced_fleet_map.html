<!DOCTYPE html>
<html>
<head>
    <title>Advanced Fleet Map - TRAXOVO</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: white; font-family: Arial; }
        .map-container { width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        .map-header { background: #1a1a2e; padding: 15px; border-bottom: 2px solid #00ff88; }
        .map-svg-container { flex: 1; overflow: auto; display: flex; justify-content: center; align-items: center; }
        .control-panel { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; border: 1px solid #00ff88; }
        .asset-marker:hover .asset-info { opacity: 1 !important; }
        .refresh-btn { background: #00ff88; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-active { background: #00ff00; }
        .status-maintenance { background: #ff4444; }
        .status-idle { background: #ffaa00; }
        .back-btn { background: #333; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="map-container">
        <div class="map-header">
            <button class="back-btn" onclick="window.location.href='/'">‚Üê Back to Dashboard</button>
            <h1>Advanced Fleet Map - No External APIs Required</h1>
            <p>Proprietary SVG-based fleet visualization with real-time tracking capabilities</p>
        </div>
        
        <div class="control-panel">
            <h3>Fleet Control</h3>
            <button class="refresh-btn" onclick="refreshMap()">Refresh</button>
            <button class="refresh-btn" onclick="toggleVoiceCommands()">Voice Commands</button>
            <div id="fleet-stats" style="margin-top: 10px; font-size: 12px;"></div>
        </div>
        
        <div class="map-svg-container" id="mapContainer">
            <div id="loadingIndicator">Loading advanced fleet map...</div>
        </div>
    </div>

    <script>
        let voiceActive = false;
        
        async function loadFleetMap() {
            try {
                const response = await fetch('/api/fleet/advanced_map');
                const data = await response.json();
                
                document.getElementById('mapContainer').innerHTML = data.map_svg;
                updateFleetStats(data.real_time_data);
                
                document.querySelectorAll('.asset-marker').forEach(marker => {
                    marker.addEventListener('mouseenter', function() {
                        this.querySelector('.asset-info').style.opacity = '1';
                    });
                    marker.addEventListener('mouseleave', function() {
                        this.querySelector('.asset-info').style.opacity = '0';
                    });
                });
                
            } catch (error) {
                document.getElementById('mapContainer').innerHTML = 
                    '<div style="color: #ff4444;">Error loading fleet map: ' + error.message + '</div>';
            }
        }
        
        function updateFleetStats(data) {
            document.getElementById('fleet-stats').innerHTML = `
                <div><span class="status-indicator status-active"></span>Active: ${data.active_assets}</div>
                <div><span class="status-indicator status-maintenance"></span>Maintenance: ${data.maintenance_assets}</div>
                <div><span class="status-indicator status-idle"></span>Idle: ${data.idle_assets}</div>
                <div>Utilization: ${data.utilization_rate}</div>
                <div>Last Update: ${data.last_sync}</div>
            `;
        }
        
        function refreshMap() {
            document.getElementById('mapContainer').innerHTML = '<div id="loadingIndicator">Refreshing fleet data...</div>';
            loadFleetMap();
        }
        
        async function toggleVoiceCommands() {
            if (!voiceActive) {
                try {
                    const response = await fetch('/api/voice/start', { method: 'POST' });
                    const result = await response.json();
                    voiceActive = true;
                    alert('Voice commands activated. Say "Watson" followed by your command.');
                } catch (error) {
                    alert('Voice commands require microphone access. Please enable microphone permissions.');
                }
            } else {
                try {
                    await fetch('/api/voice/stop', { method: 'POST' });
                    voiceActive = false;
                    alert('Voice commands deactivated.');
                } catch (error) {
                    console.error('Error stopping voice commands:', error);
                }
            }
        }
        
        setInterval(refreshMap, 30000);
        loadFleetMap();
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>Email Configuration - TRAXOVO</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: white; font-family: Arial; padding: 20px; }
        .config-container { max-width: 800px; margin: 0 auto; }
        .config-section { background: #1a1a2e; padding: 20px; margin: 20px 0; border-radius: 10px; border: 1px solid #00ff88; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; color: #00ff88; }
        input, select { width: 100%; padding: 10px; background: #2a2a4e; color: white; border: 1px solid #555; border-radius: 5px; box-sizing: border-box; }
        .btn { background: #00ff88; color: black; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #00cc66; }
        .status-message { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #004d00; border: 1px solid #00ff00; }
        .error { background: #4d0000; border: 1px solid #ff0000; }
        .help-text { font-size: 12px; color: #aaa; margin-top: 5px; }
        .back-btn { background: #333; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; }
        .instruction-list { background: #2a2a4e; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .instruction-list ol { margin: 10px 0; padding-left: 20px; }
        .instruction-list li { margin: 5px 0; }
    </style>
</head>
<body>
    <div class="config-container">
        <button class="back-btn" onclick="window.location.href='/'">← Back to Dashboard</button>
        <h1>Email Configuration</h1>
        <p>Configure your TRAXOVO system email settings for notifications and alerts</p>
        
        <div class="config-section">
            <h2>Email Provider Setup</h2>
            <form id="emailConfigForm">
                <div class="form-group">
                    <label for="provider">Email Provider:</label>
                    <select id="provider" name="provider" onchange="updateProviderSettings()">
                        <option value="">Select Provider</option>
                        <option value="gmail">Gmail</option>
                        <option value="outlook">Outlook</option>
                        <option value="office365">Office 365</option>
                        <option value="custom">Custom SMTP</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                    <div class="help-text" id="passwordHelp">Enter your email password</div>
                </div>
                
                <div id="customSettings" style="display: none;">
                    <div class="form-group">
                        <label for="smtp_server">SMTP Server:</label>
                        <input type="text" id="smtp_server" name="smtp_server">
                    </div>
                    
                    <div class="form-group">
                        <label for="smtp_port">SMTP Port:</label>
                        <input type="number" id="smtp_port" name="smtp_port" value="587">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="display_name">Display Name:</label>
                    <input type="text" id="display_name" name="display_name" value="TRAXOVO System">
                </div>
                
                <button type="button" class="btn" onclick="saveEmailConfig()">Save Configuration</button>
                <button type="button" class="btn" onclick="testEmailConnection()">Test Connection</button>
                <button type="button" class="btn" onclick="sendTestEmail()">Send Test Email</button>
            </form>
            
            <div id="statusMessage"></div>
        </div>
        
        <div class="config-section">
            <h2>Provider Instructions</h2>
            <div id="providerInstructions">
                <p>Select an email provider above to see setup instructions.</p>
            </div>
        </div>
    </div>

    <script>
        function updateProviderSettings() {
            const provider = document.getElementById('provider').value;
            const customSettings = document.getElementById('customSettings');
            const passwordHelp = document.getElementById('passwordHelp');
            const instructions = document.getElementById('providerInstructions');
            
            if (provider === 'custom') {
                customSettings.style.display = 'block';
            } else {
                customSettings.style.display = 'none';
            }
            
            if (provider === 'gmail') {
                passwordHelp.innerHTML = 'Use App Password (not your regular Gmail password)';
                instructions.innerHTML = `
                    <h3>Gmail Setup Instructions:</h3>
                    <div class="instruction-list">
                        <ol>
                            <li>Enable 2-factor authentication on your Google account</li>
                            <li>Go to Google Account settings → Security → 2-Step Verification</li>
                            <li>Generate an App Password for "Mail"</li>
                            <li>Use your Gmail address and the App Password here</li>
                        </ol>
                    </div>
                `;
            } else if (provider === 'outlook') {
                passwordHelp.innerHTML = 'Use your regular Outlook password';
                instructions.innerHTML = `
                    <h3>Outlook Setup Instructions:</h3>
                    <div class="instruction-list">
                        <ol>
                            <li>Use your Outlook.com email address</li>
                            <li>Use your regular Outlook password</li>
                            <li>Ensure "Less secure app access" is enabled if needed</li>
                        </ol>
                    </div>
                `;
            } else if (provider === 'office365') {
                passwordHelp.innerHTML = 'Use your Office 365 password';
                instructions.innerHTML = `
                    <h3>Office 365 Setup Instructions:</h3>
                    <div class="instruction-list">
                        <ol>
                            <li>Use your Office 365 business email address</li>
                            <li>Use your Office 365 password</li>
                            <li>Contact your IT admin if authentication fails</li>
                        </ol>
                    </div>
                `;
            } else {
                passwordHelp.innerHTML = 'Enter your email password';
                instructions.innerHTML = '<p>Select an email provider above to see setup instructions.</p>';
            }
        }
        
        async function saveEmailConfig() {
            const form = document.getElementById('emailConfigForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/email/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showStatus(result.success ? 'success' : 'error', result.message || result.error);
            } catch (error) {
                showStatus('error', 'Failed to save configuration: ' + error.message);
            }
        }
        
        async function testEmailConnection() {
            try {
                const response = await fetch('/api/email/test');
                const result = await response.json();
                showStatus(result.success ? 'success' : 'error', result.message || result.error);
            } catch (error) {
                showStatus('error', 'Failed to test connection: ' + error.message);
            }
        }
        
        async function sendTestEmail() {
            try {
                const response = await fetch('/api/email/send_test', { method: 'POST' });
                const result = await response.json();
                showStatus(result.success ? 'success' : 'error', result.message || result.error);
            } catch (error) {
                showStatus('error', 'Failed to send test email: ' + error.message);
            }
        }
        
        function showStatus(type, message) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message ${type}`;
            statusDiv.textContent = message;
        }
        
        async function loadCurrentConfig() {
            try {
                const response = await fetch('/api/email/config');
                const config = await response.json();
                
                if (config.provider) {
                    document.getElementById('provider').value = config.provider;
                    document.getElementById('email').value = config.email || '';
                    document.getElementById('display_name').value = config.display_name || 'TRAXOVO System';
                    if (config.smtp_server) {
                        document.getElementById('smtp_server').value = config.smtp_server;
                    }
                    if (config.smtp_port) {
                        document.getElementById('smtp_port').value = config.smtp_port;
                    }
                    updateProviderSettings();
                }
            } catch (error) {
                console.error('Failed to load current configuration:', error);
            }
        }
        
        loadCurrentConfig();
    </script>
</body>
</html>
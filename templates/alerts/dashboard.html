{% extends 'base.html' %}

{% block title %}Equipment Alerts Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0"><i class="bi bi-exclamation-diamond me-2"></i>Equipment Alerts Dashboard</h1>
                <div>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i> Dashboard
                    </a>
                    {% if current_user.is_admin %}
                    <form action="{{ url_for('alerts.refresh_alerts') }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-primary ms-2">
                            <i class="bi bi-arrow-repeat me-2"></i> Generate Alerts
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            <p class="text-muted">Monitor equipment inactivity, unusual patterns, and upcoming maintenance needs.</p>
        </div>
    </div>

    <!-- Alert Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-danger h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-danger mb-1">Critical Alerts</h5>
                            <h2 class="mb-0">{{ summary.level_counts.get('critical', 0) }}</h2>
                        </div>
                        <div class="rounded-circle bg-danger bg-opacity-10 p-3">
                            <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
                        </div>
                    </div>
                    <p class="text-muted small mt-2 mb-0">Require immediate attention</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-warning mb-1">Warning Alerts</h5>
                            <h2 class="mb-0">{{ summary.level_counts.get('warning', 0) }}</h2>
                        </div>
                        <div class="rounded-circle bg-warning bg-opacity-10 p-3">
                            <i class="bi bi-exclamation-circle text-warning fs-4"></i>
                        </div>
                    </div>
                    <p class="text-muted small mt-2 mb-0">Need monitoring and attention</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-info mb-1">Inactive Equipment</h5>
                            <h2 class="mb-0">{{ summary.type_counts.get('inactivity', 0) }}</h2>
                        </div>
                        <div class="rounded-circle bg-info bg-opacity-10 p-3">
                            <i class="bi bi-clock-history text-info fs-4"></i>
                        </div>
                    </div>
                    <p class="text-muted small mt-2 mb-0">Equipment with low or no activity</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-success mb-1">Unusual Patterns</h5>
                            <h2 class="mb-0">{{ summary.type_counts.get('high_usage', 0) + summary.type_counts.get('low_usage', 0) }}</h2>
                        </div>
                        <div class="rounded-circle bg-success bg-opacity-10 p-3">
                            <i class="bi bi-activity text-success fs-4"></i>
                        </div>
                    </div>
                    <p class="text-muted small mt-2 mb-0">Abnormal usage patterns detected</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs for different alert categories -->
    <div class="card mb-4">
        <div class="card-header bg-white">
            <ul class="nav nav-tabs card-header-tabs" id="alerts-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-alerts-tab" data-bs-toggle="tab" data-bs-target="#all-alerts" type="button" role="tab" aria-controls="all-alerts" aria-selected="true">
                        <i class="bi bi-eye me-1"></i> All Alerts
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="critical-alerts-tab" data-bs-toggle="tab" data-bs-target="#critical-alerts" type="button" role="tab" aria-controls="critical-alerts" aria-selected="false">
                        <i class="bi bi-exclamation-triangle me-1"></i> Critical
                        <span class="badge rounded-pill bg-danger ms-1">{{ summary.level_counts.get('critical', 0) }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="inactivity-alerts-tab" data-bs-toggle="tab" data-bs-target="#inactivity-alerts" type="button" role="tab" aria-controls="inactivity-alerts" aria-selected="false">
                        <i class="bi bi-clock-history me-1"></i> Inactivity
                        <span class="badge rounded-pill bg-secondary ms-1">{{ summary.type_counts.get('inactivity', 0) }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="patterns-alerts-tab" data-bs-toggle="tab" data-bs-target="#patterns-alerts" type="button" role="tab" aria-controls="patterns-alerts" aria-selected="false">
                        <i class="bi bi-activity me-1"></i> Usage Patterns
                        <span class="badge rounded-pill bg-success ms-1">{{ summary.type_counts.get('high_usage', 0) + summary.type_counts.get('low_usage', 0) }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="maintenance-alerts-tab" data-bs-toggle="tab" data-bs-target="#maintenance-alerts" type="button" role="tab" aria-controls="maintenance-alerts" aria-selected="false">
                        <i class="bi bi-tools me-1"></i> Maintenance
                        <span class="badge rounded-pill bg-primary ms-1">{{ summary.type_counts.get('maintenance_hours', 0) + summary.type_counts.get('maintenance_days', 0) }}</span>
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="alerts-tabContent">
                <!-- All Alerts Tab -->
                <div class="tab-pane fade show active" id="all-alerts" role="tabpanel" aria-labelledby="all-alerts-tab">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Severity</th>
                                    <th>Asset ID</th>
                                    <th>Alert Type</th>
                                    <th>Description</th>
                                    <th>Location</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set all_alerts = critical_alerts + warning_alerts + info_alerts %}
                                {% if all_alerts %}
                                    {% for alert in all_alerts %}
                                        <tr>
                                            <td>
                                                {% if alert.level == 'critical' %}
                                                    <span class="badge bg-danger">Critical</span>
                                                {% elif alert.level == 'warning' %}
                                                    <span class="badge bg-warning text-dark">Warning</span>
                                                {% else %}
                                                    <span class="badge bg-info">Info</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('asset_detail', asset_id=alert.asset_id) }}">
                                                    {{ alert.asset_id }}
                                                </a>
                                            </td>
                                            <td>
                                                {% if alert.alert_type == 'inactivity' %}
                                                    <span class="badge bg-secondary">Inactivity</span>
                                                {% elif alert.alert_type == 'high_usage' %}
                                                    <span class="badge bg-success">High Usage</span>
                                                {% elif alert.alert_type == 'low_usage' %}
                                                    <span class="badge bg-primary">Low Usage</span>
                                                {% elif alert.alert_type == 'maintenance_hours' %}
                                                    <span class="badge bg-info">Maintenance (Hours)</span>
                                                {% elif alert.alert_type == 'maintenance_days' %}
                                                    <span class="badge bg-info">Maintenance (Days)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ alert.alert_type }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ alert.description }}</td>
                                            <td>{{ alert.location or 'Unknown' }}</td>
                                            <td>{{ alert.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ url_for('alerts.asset_alerts', asset_id=alert.asset_id) }}" class="btn btn-outline-primary">
                                                        <i class="bi bi-search"></i>
                                                    </a>
                                                    {% if not alert.acknowledged %}
                                                    <form action="{{ url_for('alerts.acknowledge_alert', alert_id=alert.id) }}" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-outline-secondary">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                    {% if not alert.resolved %}
                                                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#resolveModal{{ alert.id }}">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                
                                                <!-- Resolve Modal -->
                                                <div class="modal fade" id="resolveModal{{ alert.id }}" tabindex="-1" aria-labelledby="resolveModalLabel{{ alert.id }}" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="resolveModalLabel{{ alert.id }}">Resolve Alert</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <form action="{{ url_for('alerts.resolve_alert', alert_id=alert.id) }}" method="post">
                                                                <div class="modal-body">
                                                                    <p><strong>Alert:</strong> {{ alert.description }}</p>
                                                                    <p><strong>Asset:</strong> {{ alert.asset_id }}</p>
                                                                    <div class="mb-3">
                                                                        <label for="resolution_notes" class="form-label">Resolution Notes</label>
                                                                        <textarea class="form-control" id="resolution_notes" name="resolution_notes" rows="3"></textarea>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                    <button type="submit" class="btn btn-success">Resolve Alert</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="bi bi-check-circle fs-4 d-block mb-2"></i>
                                                No alerts found
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Critical Alerts Tab -->
                <div class="tab-pane fade" id="critical-alerts" role="tabpanel" aria-labelledby="critical-alerts-tab">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Asset ID</th>
                                    <th>Alert Type</th>
                                    <th>Description</th>
                                    <th>Location</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if critical_alerts %}
                                    {% for alert in critical_alerts %}
                                        <tr>
                                            <td>
                                                <a href="{{ url_for('asset_detail', asset_id=alert.asset_id) }}">
                                                    {{ alert.asset_id }}
                                                </a>
                                            </td>
                                            <td>
                                                {% if alert.alert_type == 'inactivity' %}
                                                    <span class="badge bg-secondary">Inactivity</span>
                                                {% elif alert.alert_type == 'high_usage' %}
                                                    <span class="badge bg-success">High Usage</span>
                                                {% elif alert.alert_type == 'low_usage' %}
                                                    <span class="badge bg-primary">Low Usage</span>
                                                {% elif alert.alert_type == 'maintenance_hours' %}
                                                    <span class="badge bg-info">Maintenance (Hours)</span>
                                                {% elif alert.alert_type == 'maintenance_days' %}
                                                    <span class="badge bg-info">Maintenance (Days)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ alert.alert_type }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ alert.description }}</td>
                                            <td>{{ alert.location or 'Unknown' }}</td>
                                            <td>{{ alert.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ url_for('alerts.asset_alerts', asset_id=alert.asset_id) }}" class="btn btn-outline-primary">
                                                        <i class="bi bi-search"></i>
                                                    </a>
                                                    {% if not alert.acknowledged %}
                                                    <form action="{{ url_for('alerts.acknowledge_alert', alert_id=alert.id) }}" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-outline-secondary">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                    {% if not alert.resolved %}
                                                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#resolveModal{{ alert.id }}C">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                
                                                <!-- Resolve Modal -->
                                                <div class="modal fade" id="resolveModal{{ alert.id }}C" tabindex="-1" aria-labelledby="resolveModalLabel{{ alert.id }}C" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="resolveModalLabel{{ alert.id }}C">Resolve Alert</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <form action="{{ url_for('alerts.resolve_alert', alert_id=alert.id) }}" method="post">
                                                                <div class="modal-body">
                                                                    <p><strong>Alert:</strong> {{ alert.description }}</p>
                                                                    <p><strong>Asset:</strong> {{ alert.asset_id }}</p>
                                                                    <div class="mb-3">
                                                                        <label for="resolution_notes" class="form-label">Resolution Notes</label>
                                                                        <textarea class="form-control" id="resolution_notes" name="resolution_notes" rows="3"></textarea>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                    <button type="submit" class="btn btn-success">Resolve Alert</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="bi bi-check-circle fs-4 d-block mb-2"></i>
                                                No critical alerts found
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Inactivity Alerts Tab -->
                <div class="tab-pane fade" id="inactivity-alerts" role="tabpanel" aria-labelledby="inactivity-alerts-tab">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Severity</th>
                                    <th>Asset ID</th>
                                    <th>Days Inactive</th>
                                    <th>Last Activity</th>
                                    <th>Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set inactivity_alerts = alerts_by_type.get('inactivity', []) %}
                                {% if inactivity_alerts %}
                                    {% for alert in inactivity_alerts %}
                                        <tr>
                                            <td>
                                                {% if alert.level == 'critical' %}
                                                    <span class="badge bg-danger">Critical</span>
                                                {% elif alert.level == 'warning' %}
                                                    <span class="badge bg-warning text-dark">Warning</span>
                                                {% else %}
                                                    <span class="badge bg-info">Info</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('asset_detail', asset_id=alert.asset_id) }}">
                                                    {{ alert.asset_id }}
                                                </a>
                                            </td>
                                            <td>
                                                {% if alert.details and alert.details.days_inactive %}
                                                    {{ alert.details.days_inactive }} days
                                                {% else %}
                                                    Unknown
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if alert.details and alert.details.last_activity %}
                                                    {{ alert.details.last_activity }}
                                                {% else %}
                                                    Unknown
                                                {% endif %}
                                            </td>
                                            <td>{{ alert.location or 'Unknown' }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ url_for('alerts.asset_alerts', asset_id=alert.asset_id) }}" class="btn btn-outline-primary">
                                                        <i class="bi bi-search"></i>
                                                    </a>
                                                    {% if not alert.acknowledged %}
                                                    <form action="{{ url_for('alerts.acknowledge_alert', alert_id=alert.id) }}" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-outline-secondary">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                    {% if not alert.resolved %}
                                                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#resolveModal{{ alert.id }}I">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                
                                                <!-- Resolve Modal -->
                                                <div class="modal fade" id="resolveModal{{ alert.id }}I" tabindex="-1" aria-labelledby="resolveModalLabel{{ alert.id }}I" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="resolveModalLabel{{ alert.id }}I">Resolve Inactivity Alert</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <form action="{{ url_for('alerts.resolve_alert', alert_id=alert.id) }}" method="post">
                                                                <div class="modal-body">
                                                                    <p><strong>Alert:</strong> {{ alert.description }}</p>
                                                                    <p><strong>Asset:</strong> {{ alert.asset_id }}</p>
                                                                    <div class="mb-3">
                                                                        <label for="resolution_notes" class="form-label">Resolution Notes</label>
                                                                        <textarea class="form-control" id="resolution_notes" name="resolution_notes" rows="3" placeholder="Explain why this equipment is inactive or what actions were taken..."></textarea>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                    <button type="submit" class="btn btn-success">Resolve Alert</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="bi bi-check-circle fs-4 d-block mb-2"></i>
                                                No inactivity alerts found
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Usage Patterns Tab -->
                <div class="tab-pane fade" id="patterns-alerts" role="tabpanel" aria-labelledby="patterns-alerts-tab">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Severity</th>
                                    <th>Asset ID</th>
                                    <th>Pattern Type</th>
                                    <th>Description</th>
                                    <th>Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set high_usage_alerts = alerts_by_type.get('high_usage', []) %}
                                {% set low_usage_alerts = alerts_by_type.get('low_usage', []) %}
                                {% set pattern_alerts = high_usage_alerts + low_usage_alerts %}
                                {% if pattern_alerts %}
                                    {% for alert in pattern_alerts %}
                                        <tr>
                                            <td>
                                                {% if alert.level == 'critical' %}
                                                    <span class="badge bg-danger">Critical</span>
                                                {% elif alert.level == 'warning' %}
                                                    <span class="badge bg-warning text-dark">Warning</span>
                                                {% else %}
                                                    <span class="badge bg-info">Info</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('asset_detail', asset_id=alert.asset_id) }}">
                                                    {{ alert.asset_id }}
                                                </a>
                                            </td>
                                            <td>
                                                {% if alert.alert_type == 'high_usage' %}
                                                    <span class="badge bg-success">High Usage</span>
                                                {% elif alert.alert_type == 'low_usage' %}
                                                    <span class="badge bg-primary">Low Usage</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ alert.description }}</td>
                                            <td>{{ alert.location or 'Unknown' }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ url_for('alerts.asset_alerts', asset_id=alert.asset_id) }}" class="btn btn-outline-primary">
                                                        <i class="bi bi-search"></i>
                                                    </a>
                                                    {% if not alert.acknowledged %}
                                                    <form action="{{ url_for('alerts.acknowledge_alert', alert_id=alert.id) }}" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-outline-secondary">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                    {% if not alert.resolved %}
                                                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#resolveModal{{ alert.id }}P">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                
                                                <!-- Resolve Modal -->
                                                <div class="modal fade" id="resolveModal{{ alert.id }}P" tabindex="-1" aria-labelledby="resolveModalLabel{{ alert.id }}P" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="resolveModalLabel{{ alert.id }}P">Resolve Pattern Alert</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <form action="{{ url_for('alerts.resolve_alert', alert_id=alert.id) }}" method="post">
                                                                <div class="modal-body">
                                                                    <p><strong>Alert:</strong> {{ alert.description }}</p>
                                                                    <p><strong>Asset:</strong> {{ alert.asset_id }}</p>
                                                                    <div class="mb-3">
                                                                        <label for="resolution_notes" class="form-label">Resolution Notes</label>
                                                                        <textarea class="form-control" id="resolution_notes" name="resolution_notes" rows="3" placeholder="Explain why this usage pattern is occurring or what actions were taken..."></textarea>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                    <button type="submit" class="btn btn-success">Resolve Alert</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="bi bi-check-circle fs-4 d-block mb-2"></i>
                                                No usage pattern alerts found
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Maintenance Alerts Tab -->
                <div class="tab-pane fade" id="maintenance-alerts" role="tabpanel" aria-labelledby="maintenance-alerts-tab">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Severity</th>
                                    <th>Asset ID</th>
                                    <th>Maintenance Type</th>
                                    <th>Description</th>
                                    <th>Last Service</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set maintenance_hours_alerts = alerts_by_type.get('maintenance_hours', []) %}
                                {% set maintenance_days_alerts = alerts_by_type.get('maintenance_days', []) %}
                                {% set maintenance_alerts = maintenance_hours_alerts + maintenance_days_alerts %}
                                {% if maintenance_alerts %}
                                    {% for alert in maintenance_alerts %}
                                        <tr>
                                            <td>
                                                {% if alert.level == 'critical' %}
                                                    <span class="badge bg-danger">Critical</span>
                                                {% elif alert.level == 'warning' %}
                                                    <span class="badge bg-warning text-dark">Warning</span>
                                                {% else %}
                                                    <span class="badge bg-info">Info</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('asset_detail', asset_id=alert.asset_id) }}">
                                                    {{ alert.asset_id }}
                                                </a>
                                            </td>
                                            <td>
                                                {% if alert.alert_type == 'maintenance_hours' %}
                                                    <span class="badge bg-info">Hours-based</span>
                                                {% elif alert.alert_type == 'maintenance_days' %}
                                                    <span class="badge bg-primary">Time-based</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ alert.description }}</td>
                                            <td>
                                                {% if alert.details and alert.details.last_service_date %}
                                                    {{ alert.details.last_service_date }}
                                                {% else %}
                                                    Unknown
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ url_for('alerts.asset_alerts', asset_id=alert.asset_id) }}" class="btn btn-outline-primary">
                                                        <i class="bi bi-search"></i>
                                                    </a>
                                                    {% if not alert.acknowledged %}
                                                    <form action="{{ url_for('alerts.acknowledge_alert', alert_id=alert.id) }}" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-outline-secondary">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                    {% if not alert.resolved %}
                                                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#resolveModal{{ alert.id }}M">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                
                                                <!-- Resolve Modal -->
                                                <div class="modal fade" id="resolveModal{{ alert.id }}M" tabindex="-1" aria-labelledby="resolveModalLabel{{ alert.id }}M" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="resolveModalLabel{{ alert.id }}M">Resolve Maintenance Alert</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <form action="{{ url_for('alerts.resolve_alert', alert_id=alert.id) }}" method="post">
                                                                <div class="modal-body">
                                                                    <p><strong>Alert:</strong> {{ alert.description }}</p>
                                                                    <p><strong>Asset:</strong> {{ alert.asset_id }}</p>
                                                                    <div class="mb-3">
                                                                        <label for="resolution_notes" class="form-label">Resolution Notes</label>
                                                                        <textarea class="form-control" id="resolution_notes" name="resolution_notes" rows="3" placeholder="Describe maintenance performed or scheduled..."></textarea>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                    <button type="submit" class="btn btn-success">Resolve Alert</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="bi bi-check-circle fs-4 d-block mb-2"></i>
                                                No maintenance alerts found
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Alerts Dashboard -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Keep the selected tab active after page refresh
        let url = location.href.replace(/\/$/, "");
        if (location.hash) {
            const hash = url.split("#");
            const tabId = hash[1] + "-tab";
            
            document.getElementById(tabId).click();
        }
        
        // Enable tab navigation with links
        document.querySelectorAll('.nav-tabs a').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                this.tab('show');
            });
        });
    });
</script>
{% endblock %}
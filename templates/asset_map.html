{% extends "base.html" %}

{% block title %}Asset Map | TRAXORA{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="anonymous">
<style>
  #map-container {
    height: 70vh;
    width: 100%;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .asset-marker {
    cursor: pointer;
  }
  .asset-marker.active {
    color: #28a745;
    z-index: 1000;
  }
  .asset-marker.disposed {
    color: #6c757d;
    opacity: 0.7;
  }
  .asset-popup {
    padding: 10px;
  }
  .asset-popup h5 {
    margin-top: 0;
    margin-bottom: 10px;
    font-weight: 600;
  }
  .asset-popup p {
    margin-bottom: 5px;
  }
  .filter-controls {
    margin-bottom: 15px;
  }
  .status-badge {
    display: inline-block;
    padding: 0.25em 0.6em;
    border-radius: 0.25rem;
    font-size: 0.85rem;
    font-weight: 500;
    line-height: 1;
  }
  .status-active {
    background-color: #28a745;
    color: white;
  }
  .status-disposed {
    background-color: #6c757d;
    color: white;
  }
  .status-unknown {
    background-color: #ffc107;
    color: #212529;
  }
</style>
{% endblock %}

{% block content %}
<div class="container pt-4">
  <h1 class="mb-4">Asset Map Dashboard</h1>
  
  <div class="row">
    <div class="col-md-9">
      <div class="card mb-4">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Equipment Location Map</h5>
            <div>
              <input type="date" id="date-picker" class="form-control form-control-sm" value="{{ date }}">
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div id="map-container"></div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Filters</h5>
        </div>
        <div class="card-body">
          <div class="filter-controls">
            <div class="form-group">
              <label for="division-filter">Division:</label>
              <select id="division-filter" class="form-control">
                <option value="all">All Divisions</option>
                <option value="Houston">Houston</option>
                <option value="DFW">DFW</option>
                <option value="West Texas">West Texas</option>
              </select>
            </div>
            
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" id="show-disposed" checked>
              <label class="form-check-label" for="show-disposed">
                Show Disposed Assets
              </label>
            </div>
          </div>
          
          <div class="asset-summary mt-4">
            <h6>Asset Summary</h6>
            <div id="asset-count" class="text-center py-3">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="sr-only">Loading...</span>
              </div>
              <p class="mb-0 mt-2">Loading asset data...</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Legend</h5>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <span class="status-badge status-active mr-2">Active</span>
            <span class="ml-2">Equipment currently in use</span>
          </div>
          <div class="d-flex align-items-center mb-2">
            <span class="status-badge status-disposed mr-2">Disposed</span>
            <span class="ml-2">Equipment no longer in service</span>
          </div>
          <div class="d-flex align-items-center">
            <span class="status-badge status-unknown mr-2">Unknown</span>
            <span class="ml-2">Status could not be determined</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin="anonymous"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize map
    const map = L.map('map-container').setView([32.7767, -96.7970], 9); // Dallas area
    
    // Add tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Asset markers layer group
    const markersLayer = L.layerGroup().addTo(map);
    
    // Load asset data
    function loadAssetData(date) {
      fetch(`/asset-map/api/assets?date=${date}`)
        .then(response => response.json())
        .then(data => {
          // Clear existing markers
          markersLayer.clearLayers();
          
          // Update asset count
          document.getElementById('asset-count').innerHTML = `
            <div class="h3 mb-0">${data.length}</div>
            <p class="text-muted mb-0">Total Assets</p>
          `;
          
          // Add markers for each asset
          data.forEach(asset => {
            if (!asset.latitude || !asset.longitude) return;
            
            // Create marker
            const marker = L.marker([parseFloat(asset.latitude), parseFloat(asset.longitude)], {
              title: asset.asset_id,
              alt: asset.asset_id,
              opacity: asset.status === 'disposed' ? 0.7 : 1
            });
            
            // Create popup content
            const popupContent = `
              <div class="asset-popup">
                <h5>${asset.asset_id}</h5>
                <p><strong>Status:</strong> <span class="status-badge status-${asset.status}">${asset.status}</span></p>
                <p><strong>Driver:</strong> ${asset.driver_id || 'None'}</p>
                <p><strong>Location:</strong> ${asset.location || 'Unknown'}</p>
                <p><strong>Source:</strong> ${asset.location_source || 'Unknown'}</p>
                <p class="text-muted small">Last updated: ${new Date(asset.last_updated).toLocaleString()}</p>
              </div>
            `;
            
            // Add popup to marker
            marker.bindPopup(popupContent);
            
            // Add marker to layer group
            markersLayer.addLayer(marker);
          });
          
          // Fit map to markers if we have any
          if (data.length > 0) {
            const bounds = L.featureGroup(markersLayer.getLayers()).getBounds();
            map.fitBounds(bounds, { padding: [50, 50] });
          }
        })
        .catch(error => {
          console.error('Error loading asset data:', error);
          document.getElementById('asset-count').innerHTML = `
            <div class="text-danger">Error</div>
            <p class="text-muted mb-0">Could not load asset data</p>
          `;
        });
    }
    
    // Initialize with current date
    const datePicker = document.getElementById('date-picker');
    loadAssetData(datePicker.value);
    
    // Update on date change
    datePicker.addEventListener('change', function() {
      loadAssetData(this.value);
    });
    
    // Filter functionality
    document.getElementById('division-filter').addEventListener('change', function() {
      const division = this.value;
      // Implementation would filter markers based on division
      // For now, this is a placeholder
    });
    
    document.getElementById('show-disposed').addEventListener('change', function() {
      const showDisposed = this.checked;
      // Implementation would show/hide disposed assets
      // For now, this is a placeholder
    });
  });
</script>
{% endblock %}
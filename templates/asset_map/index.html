{% extends "basic_base.html" %}

{% block title %}Asset Map{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    .map-container {
        height: calc(100vh - 100px);
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .asset-badge {
        display: inline-block;
        padding: 3px 8px;
        font-size: 12px;
        font-weight: 600;
        border-radius: 3px;
        margin-right: 5px;
    }
    
    .asset-info-box {
        min-width: 220px;
    }
    
    .filter-card {
        margin-bottom: 15px;
    }
    
    .filter-label {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 14px;
    }
    
    .filter-btn {
        width: 100%;
    }
    
    /* Status indicators */
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .status-active {
        background-color: #28a745;
    }
    
    .status-idle {
        background-color: #ffc107;
    }
    
    .status-maintenance {
        background-color: #dc3545;
    }
    
    .status-inactive {
        background-color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row mb-3">
        <div class="col-12">
            <h2>Asset Map <small class="text-muted">Real-time Fleet Tracking</small></h2>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar with filters -->
        <div class="col-md-3 mb-3">
            <!-- Filters -->
            <div class="card filter-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Filters</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="filter-label">Asset Type</label>
                        <select id="type-filter" class="form-select form-select-sm">
                            <option value="">All Types</option>
                            {% for type in asset_types %}
                            <option value="{{ type }}">{{ type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="filter-label">Job Site</label>
                        <select id="job-site-filter" class="form-select form-select-sm">
                            <option value="">All Job Sites</option>
                            {% for site in job_sites %}
                            <option value="{{ site.id }}">{{ site.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button id="refresh-map" class="btn btn-primary btn-sm filter-btn">
                        <i class="fas fa-sync-alt me-1"></i> Refresh Map
                    </button>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="card filter-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Map Legend</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2"><span class="status-indicator status-active"></span> Active</div>
                    <div class="mb-2"><span class="status-indicator status-idle"></span> Idle</div>
                    <div class="mb-2"><span class="status-indicator status-maintenance"></span> Maintenance</div>
                    <div class="mb-2"><span class="status-indicator status-inactive"></span> Inactive</div>
                </div>
            </div>
            
            <!-- System Status -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">System Status</h5>
                </div>
                <div class="card-body">
                    <div id="api-status" class="mb-2">
                        <span class="badge bg-primary">API Connection</span>
                        <span class="badge bg-success float-end">Connected</span>
                    </div>
                    <div id="update-time" class="small text-muted">
                        Last update: <span id="last-update-time">Just now</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Area -->
        <div class="col-md-9">
            <div id="map" class="map-container"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    // Initialize the map when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Create the map centered on Dallas, TX
        var map = L.map('map').setView([32.7767, -96.7970], 8);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Asset markers collection
        var assetMarkers = {};
        var jobSiteMarkers = {};
        
        // Create asset marker icon based on type and status
        function createAssetIcon(type, status) {
            // Default color is green (active)
            var color = '#28a745';
            
            // Set color based on status
            if (status === 'idle') {
                color = '#ffc107';
            } else if (status === 'maintenance') {
                color = '#dc3545';
            } else if (status === 'inactive') {
                color = '#6c757d';
            }
            
            // Create a custom icon
            var icon = L.divIcon({
                className: 'custom-asset-icon',
                html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            return icon;
        }
        
        // Load assets from API
        function loadAssets() {
            // Update status to loading
            document.getElementById('api-status').innerHTML = 
                '<span class="badge bg-primary">API Connection</span>' + 
                '<span class="badge bg-info float-end">Loading...</span>';
            
            // Get filter values
            var typeFilter = document.getElementById('type-filter').value;
            var jobSiteFilter = document.getElementById('job-site-filter').value;
            
            // Build query parameters
            var params = [];
            if (typeFilter) params.push('type=' + encodeURIComponent(typeFilter));
            if (jobSiteFilter) params.push('job_site=' + encodeURIComponent(jobSiteFilter));
            var queryString = params.length > 0 ? '?' + params.join('&') : '';
            
            // Fetch assets from API
            fetch('/asset-map/api/assets' + queryString)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('API response error: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(assets) {
                    console.log('Loaded assets:', assets);
                    
                    // Clear existing markers
                    for (var id in assetMarkers) {
                        map.removeLayer(assetMarkers[id]);
                        delete assetMarkers[id];
                    }
                    
                    // Add markers for assets
                    assets.forEach(function(asset) {
                        // Skip assets without location data
                        if (!asset.latitude || !asset.longitude) {
                            return;
                        }
                        
                        // Create marker with custom icon
                        var marker = L.marker([asset.latitude, asset.longitude], {
                            icon: createAssetIcon(asset.type, asset.status)
                        }).addTo(map);
                        
                        // Create popup content
                        var popupContent = `
                            <div class="asset-info-box">
                                <h5>${asset.name || asset.asset_id || 'Unnamed Asset'}</h5>
                                <span class="badge bg-secondary asset-badge">${asset.type || 'Unknown'}</span>
                                <div class="mt-2">
                                    <div><strong>ID:</strong> ${asset.asset_id || asset.id || 'Unknown'}</div>
                                    <div><strong>Driver:</strong> ${asset.driver || 'No Driver'}</div>
                                    <div>
                                        <strong>Status:</strong> 
                                        <span class="status-indicator status-${asset.status || 'inactive'}"></span>
                                        ${asset.status || 'Inactive'}
                                    </div>
                                    <div><strong>Last Update:</strong> ${asset.last_update ? new Date(asset.last_update).toLocaleString() : 'Unknown'}</div>
                                </div>
                            </div>
                        `;
                        
                        // Bind popup to marker
                        marker.bindPopup(popupContent);
                        
                        // Store marker reference
                        assetMarkers[asset.id || asset.asset_id] = marker;
                    });
                    
                    // Update status to success
                    document.getElementById('api-status').innerHTML = 
                        '<span class="badge bg-primary">API Connection</span>' + 
                        '<span class="badge bg-success float-end">Connected</span>';
                    
                    // Update last update time
                    document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString();
                })
                .catch(function(error) {
                    console.error('Error loading assets:', error);
                    
                    // Update status to error
                    document.getElementById('api-status').innerHTML = 
                        '<span class="badge bg-primary">API Connection</span>' + 
                        '<span class="badge bg-danger float-end">Error</span>';
                });
        }
        
        // Load job sites from API
        function loadJobSites() {
            fetch('/asset-map/api/job-sites')
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('API response error: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(jobSites) {
                    console.log('Loaded job sites:', jobSites);
                    
                    // Clear existing markers
                    for (var id in jobSiteMarkers) {
                        map.removeLayer(jobSiteMarkers[id]);
                        delete jobSiteMarkers[id];
                    }
                    
                    // Add markers for job sites
                    jobSites.forEach(function(site) {
                        // Skip sites without location data
                        if (!site.latitude || !site.longitude) {
                            return;
                        }
                        
                        // Create custom icon for job sites
                        var icon = L.divIcon({
                            className: 'custom-jobsite-icon',
                            html: `<div style="background-color: rgba(0,0,0,0.6); color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; white-space: nowrap;">${site.name}</div>`,
                            iconSize: [100, 20],
                            iconAnchor: [50, 10]
                        });
                        
                        // Create marker
                        var marker = L.marker([site.latitude, site.longitude], {
                            icon: icon
                        }).addTo(map);
                        
                        // Create popup content
                        var popupContent = `
                            <div>
                                <h5>${site.name}</h5>
                                <div><strong>Job Number:</strong> ${site.job_number || 'None'}</div>
                                <div><strong>Address:</strong> ${site.address || 'Unknown'}</div>
                            </div>
                        `;
                        
                        // Bind popup to marker
                        marker.bindPopup(popupContent);
                        
                        // Store marker reference
                        jobSiteMarkers[site.id] = marker;
                    });
                })
                .catch(function(error) {
                    console.error('Error loading job sites:', error);
                });
        }
        
        // Initial data load
        loadAssets();
        loadJobSites();
        
        // Set up auto-refresh every minute
        setInterval(loadAssets, 60000);
        
        // Set up event listeners
        document.getElementById('refresh-map').addEventListener('click', function() {
            loadAssets();
            loadJobSites();
        });
        
        // Set up filter change handlers
        document.getElementById('type-filter').addEventListener('change', loadAssets);
        document.getElementById('job-site-filter').addEventListener('change', loadAssets);
    });
</script>
{% endblock %}
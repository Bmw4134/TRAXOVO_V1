{% extends "basic_base.html" %}

{% block title %}Asset Map{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    body {
        overflow: hidden;
        height: 100vh;
    }
    
    #main-content {
        height: calc(100vh - 56px);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .map-title {
        padding: 15px 0;
    }
    
    .map-container-wrapper {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    
    .sidebar {
        width: 320px;
        padding-right: 15px;
        overflow-y: auto;
    }
    
    #map-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        border-radius: 0.375rem;
        background-color: #f8f9fa;
        z-index: 1;
    }
    
    .asset-info-window {
        min-width: 250px;
    }
    
    .asset-info-window h5 {
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .asset-type-badge {
        font-size: 0.8rem;
        margin-bottom: 0.5rem;
        display: inline-block;
    }
    
    .leaflet-popup-content-wrapper {
        border-radius: 0.375rem;
    }
    
    .asset-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .status-active {
        background-color: #28a745;
    }
    
    .status-idle {
        background-color: #ffc107;
    }
    
    .status-maintenance {
        background-color: #dc3545;
    }
    
    .status-inactive {
        background-color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div id="main-content">
    <div class="container-fluid">
        <div class="row map-title">
            <div class="col-12">
                <h2>Asset Map <small class="text-muted">Real-time Fleet Tracking</small></h2>
            </div>
        </div>
    </div>
    
    <div class="map-container-wrapper">
        <div class="sidebar ps-3">
            <!-- Filters -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Filters</h5>
                </div>
                <div class="card-body">
                    <!-- Asset Type Filter -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Asset Type</strong></label>
                        <select id="type-filter" class="form-select">
                            <option value="">All Types</option>
                            {% for type in asset_types %}
                            <option value="{{ type }}">{{ type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Job Site Filter -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Job Site</strong></label>
                        <select id="job-site-filter" class="form-select">
                            <option value="">All Job Sites</option>
                            {% for site in job_sites %}
                            <option value="{{ site.id }}">{{ site.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Refresh Button -->
                    <div class="d-grid">
                        <button id="refresh-map" class="btn btn-primary">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Map
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Map Legend</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2"><span class="badge bg-success">●</span> Active</div>
                    <div class="mb-2"><span class="badge bg-warning">●</span> Idle</div>
                    <div class="mb-2"><span class="badge bg-danger">●</span> Maintenance</div>
                    <div class="mb-2"><span class="badge bg-secondary">●</span> Inactive</div>
                </div>
            </div>
            
            <!-- System Status -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">System Status</h5>
                </div>
                <div class="card-body">
                    <div id="api-status" class="mb-2">
                        <span class="badge bg-primary">API Connection</span>
                        <span class="status-indicator active float-end">Connected</span>
                    </div>
                    <div id="update-time" class="small text-muted">
                        Last update: <span id="last-update-time">Just now</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map -->
        <div class="pe-3 ps-3 flex-grow-1 position-relative" style="height: 100%; min-height: 600px;">
            <div id="map-container" class="shadow"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Force map container to be visible
        document.getElementById('map-container').style.display = 'block';
        
        // Initialize the map with a bit of delay to ensure container is properly rendered
        setTimeout(function() {
            // Initialize the map
            const map = L.map('map-container', {
                zoomControl: true,
                attributionControl: true,
                scrollWheelZoom: true,
                dragging: true,
                tap: true
            }).setView([32.7767, -96.7970], 8); // Dallas, TX center with wider view
            
            // Add tile layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);
            
            // Invalidate size after map is initialized to handle any potential container sizing issues
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        
        // Store markers for later reference
        const markers = {};
        const jobSiteMarkers = {};
        
        // Asset icon based on type
        function getAssetIcon(type, status) {
            // Default color for active status
            let markerColor = '#28a745'; // green
            
            // Change color based on status
            if (status === 'idle') {
                markerColor = '#ffc107'; // yellow
            } else if (status === 'maintenance') {
                markerColor = '#dc3545'; // red
            } else if (status === 'inactive') {
                markerColor = '#6c757d'; // gray
            }
            
            // SVG icon for different asset types
            let svgIcon = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${markerColor}" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                </svg>`;
            
            // Different icons for different types
            if (type && type.toLowerCase().includes('truck')) {
                svgIcon = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${markerColor}" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="1" y="3" width="15" height="13"></rect>
                        <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                        <circle cx="5.5" cy="18.5" r="2.5"></circle>
                        <circle cx="18.5" cy="18.5" r="2.5"></circle>
                    </svg>`;
            } else if (type && type.toLowerCase().includes('excavator')) {
                svgIcon = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${markerColor}" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="14" width="10" height="8" rx="1"></rect>
                        <circle cx="7" cy="22" r="2"></circle>
                        <path d="M12 12V6a3 3 0 0 1 3-3h5a3 3 0 0 1 3 3v0a3 3 0 0 1-3 3H9"></path>
                    </svg>`;
            }
            
            return L.divIcon({
                html: svgIcon,
                className: 'asset-marker',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }
        
        // Load assets from API
        function loadAssets() {
            // Show loading indicator
            document.getElementById('api-status').innerHTML = '<span class="badge bg-primary">API Connection</span> <span class="badge bg-info">Loading...</span>';
            
            // Get filter values
            const typeFilter = document.getElementById('type-filter').value;
            const jobSiteFilter = document.getElementById('job-site-filter').value;
            
            // Build query string
            let queryParams = [];
            if (typeFilter) queryParams.push(`type=${encodeURIComponent(typeFilter)}`);
            if (jobSiteFilter) queryParams.push(`job_site=${encodeURIComponent(jobSiteFilter)}`);
            const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '';
            
            // Fetch assets from API
            fetch(`/asset-map/api/assets${queryString}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}`);
                    }
                    return response.json();
                })
                .then(assets => {
                    // Clear existing markers
                    Object.values(markers).forEach(marker => map.removeLayer(marker));
                    
                    // Add new markers
                    assets.forEach(asset => {
                        // Skip assets without location
                        if (!asset.latitude || !asset.longitude) return;
                        
                        // Create popup content
                        const popupContent = `
                            <div class="asset-info-window">
                                <h5>${asset.name || asset.asset_id || 'Unnamed Asset'}</h5>
                                <span class="badge bg-secondary asset-type-badge">${asset.type || 'Unknown Type'}</span>
                                <div class="asset-details">
                                    <div><strong>ID:</strong> ${asset.asset_id || asset.id || 'Unknown'}</div>
                                    <div><strong>Driver:</strong> ${asset.driver || 'No Driver'}</div>
                                    <div><strong>Status:</strong> <span class="asset-status ${asset.status ? `status-${asset.status.toLowerCase()}` : 'status-inactive'}"></span>${asset.status || 'Inactive'}</div>
                                    <div><strong>Last Update:</strong> ${asset.last_update ? new Date(asset.last_update).toLocaleString() : 'Unknown'}</div>
                                </div>
                                <button class="btn btn-sm btn-primary view-details" data-asset-id="${asset.id || asset.asset_id}">View Details</button>
                            </div>
                        `;
                        
                        // Create marker
                        const marker = L.marker([asset.latitude, asset.longitude], {
                            icon: getAssetIcon(asset.type, asset.status)
                        }).addTo(map);
                        
                        // Add popup
                        marker.bindPopup(popupContent);
                        
                        // Store marker for later reference
                        markers[asset.id || asset.asset_id] = marker;
                    });
                    
                    // Update timestamp
                    document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString();
                    
                    // Update status
                    document.getElementById('api-status').innerHTML = '<span class="badge bg-primary">API Connection</span> <span class="badge bg-success">Connected</span>';
                })
                .catch(error => {
                    console.error('Error loading assets:', error);
                    document.getElementById('api-status').innerHTML = '<span class="badge bg-primary">API Connection</span> <span class="badge bg-danger">Error</span>';
                });
        }
        
        // Load job sites
        function loadJobSites() {
            fetch('/asset-map/api/job-sites')
                .then(response => response.json())
                .then(jobSites => {
                    // Add job site markers
                    jobSites.forEach(site => {
                        if (!site.latitude || !site.longitude) return;
                        
                        // Create job site marker with custom icon
                        const jobSiteIcon = L.divIcon({
                            html: `<div class="job-site-marker" style="background-color: #3498db; color: white; padding: 5px; border-radius: 5px; font-weight: bold; font-size: 12px;">${site.name}</div>`,
                            className: 'job-site-marker-container',
                            iconSize: [100, 30],
                            iconAnchor: [50, 15]
                        });
                        
                        const marker = L.marker([site.latitude, site.longitude], {
                            icon: jobSiteIcon
                        }).addTo(map);
                        
                        // Create popup content
                        const popupContent = `
                            <div>
                                <h5>${site.name}</h5>
                                <div><strong>Job Number:</strong> ${site.job_number || 'None'}</div>
                                <div><strong>Address:</strong> ${site.address || 'Unknown'}</div>
                            </div>
                        `;
                        
                        // Add popup
                        marker.bindPopup(popupContent);
                        
                        // Store marker
                        jobSiteMarkers[site.id] = marker;
                    });
                })
                .catch(error => {
                    console.error('Error loading job sites:', error);
                });
        }
        
        // Initial load
        loadAssets();
        loadJobSites();
        
        // Set up refresh button
        document.getElementById('refresh-map').addEventListener('click', loadAssets);
        
        // Set up auto-refresh every minute
        setInterval(loadAssets, 60000);
        
        // Set up filter change handlers
        document.getElementById('type-filter').addEventListener('change', loadAssets);
        document.getElementById('job-site-filter').addEventListener('change', loadAssets);
        
        // Handle view details button clicks
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('view-details')) {
                const assetId = e.target.getAttribute('data-asset-id');
                // Here you could redirect to an asset detail page or show a modal
                console.log('View details for asset:', assetId);
            }
        });
    });
</script>
{% endblock %}
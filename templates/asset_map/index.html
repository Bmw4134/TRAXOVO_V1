{% extends "base.html" %}

{% block title %}Asset Map - TRAXORA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    body, html {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    
    .page-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%;
        overflow: hidden;
    }
    
    .content-container {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    
    .sidebar {
        width: 300px;
        height: 100%;
        overflow-y: auto;
        padding: 15px;
        background-color: var(--bs-dark);
        color: white;
    }
    
    .map-area {
        flex: 1;
        position: relative;
    }
    
    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 100%;
    }
    
    .filter-section {
        margin-bottom: 20px;
    }
    
    .filter-label {
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .status-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 10px;
        vertical-align: middle;
    }
    
    .status-active {
        background-color: #28a745;
    }
    
    .status-idle {
        background-color: #ffc107;
    }
    
    .status-maintenance {
        background-color: #dc3545;
    }
    
    .status-inactive {
        background-color: #6c757d;
    }
    
    .system-status {
        margin-top: 30px;
    }
    
    .footer {
        padding: 10px 15px;
        background-color: var(--bs-dark);
        color: white;
        text-align: center;
        font-size: 0.8rem;
    }
    
    .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-left: 5px;
    }
    
    .refresh-btn {
        width: 100%;
        margin: 15px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="content-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h3>Asset Map <small>Real-time Fleet Tracking</small></h3>
            
            <div class="filter-section">
                <h5>Filters</h5>
                <div class="mb-3">
                    <label class="filter-label">Asset Type</label>
                    <select id="type-filter" class="form-select form-select-sm">
                        <option value="">All Types</option>
                        {% for type in asset_types %}
                        <option value="{{ type }}">{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="filter-label">Job Site</label>
                    <select id="job-site-filter" class="form-select form-select-sm">
                        <option value="">All Job Sites</option>
                        {% for site in job_sites %}
                        <option value="{{ site.id }}">{{ site.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <button id="refresh-map" class="btn btn-primary refresh-btn">
                    Refresh Map
                </button>
            </div>
            
            <div class="filter-section">
                <h5>Map Legend</h5>
                <div class="mb-2"><span class="status-indicator status-active"></span> Active</div>
                <div class="mb-2"><span class="status-indicator status-idle"></span> Idle</div>
                <div class="mb-2"><span class="status-indicator status-maintenance"></span> Maintenance</div>
                <div class="mb-2"><span class="status-indicator status-inactive"></span> Inactive</div>
            </div>
            
            <div class="system-status">
                <h5>System Status</h5>
                <div id="api-status" class="mb-2">
                    API Connection
                    <span class="status-badge bg-success float-end">Connected</span>
                </div>
                <div id="update-time" class="small text-muted">
                    Last update: <span id="last-update-time">Just now</span>
                </div>
            </div>
        </div>
        
        <!-- Map Area -->
        <div class="map-area">
            <div id="map"></div>
        </div>
    </div>
    
    <div class="footer">
        Â© 2025 TRAXORA Fleet Management System | GENIUS CORE CONTINUITY MODE ACTIVE
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, initializing map...");
        
        // Initialize map
        var map = L.map('map', {
            zoomControl: true,
            attributionControl: true
        }).setView([32.7767, -96.7970], 9); // Dallas, TX
        
        // Add the base map layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Force a layout recalculation
        setTimeout(function() {
            map.invalidateSize();
            console.log("Map size invalidated for refresh");
        }, 100);
        
        // Collections for markers
        var assetMarkers = {};
        var jobSiteMarkers = {};
        
        // Create icon based on asset status
        function createAssetIcon(status) {
            var color = "#28a745"; // Default - active
            
            if (status === "idle") {
                color = "#ffc107";
            } else if (status === "maintenance") {
                color = "#dc3545";
            } else if (status === "inactive") {
                color = "#6c757d";
            }
            
            return L.divIcon({
                className: 'asset-marker-icon',
                html: `<div style="background-color:${color};width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
        }
        
        // Load assets
        function loadAssets() {
            // Update status to loading
            document.getElementById('api-status').innerHTML = 
                'API Connection <span class="status-badge bg-info float-end">Loading...</span>';
            
            // Get filter values
            var typeFilter = document.getElementById('type-filter').value;
            var jobSiteFilter = document.getElementById('job-site-filter').value;
            
            // Build query string
            var params = [];
            if (typeFilter) params.push('type=' + encodeURIComponent(typeFilter));
            if (jobSiteFilter) params.push('job_site=' + encodeURIComponent(jobSiteFilter));
            var queryString = params.length > 0 ? '?' + params.join('&') : '';
            
            // Fetch assets
            fetch('/asset-map/api/assets' + queryString)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Assets loaded:", data);
                    
                    // Clear existing markers
                    Object.values(assetMarkers).forEach(marker => map.removeLayer(marker));
                    assetMarkers = {};
                    
                    // Add asset markers
                    data.forEach(asset => {
                        if (!asset.latitude || !asset.longitude) return;
                        
                        var marker = L.marker([asset.latitude, asset.longitude], {
                            icon: createAssetIcon(asset.status)
                        }).addTo(map);
                        
                        var popupContent = `
                            <div style="min-width:200px">
                                <h5>${asset.name || asset.id || 'Asset'}</h5>
                                <div><strong>ID:</strong> ${asset.asset_id || asset.id}</div>
                                <div><strong>Type:</strong> ${asset.type || 'Unknown'}</div>
                                <div><strong>Driver:</strong> ${asset.driver || 'None'}</div>
                                <div><strong>Status:</strong> ${asset.status || 'Unknown'}</div>
                                <div><strong>Last Update:</strong> ${asset.last_update ? new Date(asset.last_update).toLocaleString() : 'Unknown'}</div>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        assetMarkers[asset.id] = marker;
                    });
                    
                    // Update status
                    document.getElementById('api-status').innerHTML = 
                        'API Connection <span class="status-badge bg-success float-end">Connected</span>';
                    document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString();
                })
                .catch(error => {
                    console.error("Error loading assets:", error);
                    document.getElementById('api-status').innerHTML = 
                        'API Connection <span class="status-badge bg-danger float-end">Error</span>';
                });
        }
        
        // Load job sites
        function loadJobSites() {
            fetch('/asset-map/api/job-sites')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Job sites loaded:", data);
                    
                    // Clear existing markers
                    Object.values(jobSiteMarkers).forEach(marker => map.removeLayer(marker));
                    jobSiteMarkers = {};
                    
                    // Add job site markers
                    data.forEach(site => {
                        if (!site.latitude || !site.longitude) return;
                        
                        // Create marker
                        var marker = L.marker([site.latitude, site.longitude], {
                            icon: L.divIcon({
                                className: 'job-site-marker',
                                html: `<div style="background:#343a40;color:white;padding:3px 8px;border-radius:4px;font-size:12px;">${site.name}</div>`,
                                iconSize: [100, 20],
                                iconAnchor: [50, 10]
                            })
                        }).addTo(map);
                        
                        var popupContent = `
                            <div>
                                <h5>${site.name}</h5>
                                <div><strong>Job Number:</strong> ${site.job_number || 'None'}</div>
                                <div><strong>Address:</strong> ${site.address || 'Unknown'}</div>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        jobSiteMarkers[site.id] = marker;
                    });
                })
                .catch(error => {
                    console.error("Error loading job sites:", error);
                });
        }
        
        // Initial data load
        loadAssets();
        loadJobSites();
        
        // Setup auto-refresh
        setInterval(loadAssets, 60000);
        
        // Setup event listeners
        document.getElementById('refresh-map').addEventListener('click', function() {
            loadAssets();
            loadJobSites();
        });
        
        document.getElementById('type-filter').addEventListener('change', loadAssets);
        document.getElementById('job-site-filter').addEventListener('change', loadAssets);
    });
</script>
{% endblock %}
{% extends "basic_base.html" %}

{% block title %}Asset Map{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    #map-container {
        height: calc(100vh - 220px);
        min-height: 400px;
        border-radius: 0.375rem;
        overflow: hidden;
    }
    
    .filter-card {
        margin-bottom: 1rem;
    }
    
    .asset-info-window {
        min-width: 200px;
    }
    
    .asset-info-window h5 {
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .asset-info-window .asset-details {
        margin-bottom: 0.5rem;
    }
    
    .asset-type-badge {
        font-size: 0.8rem;
        margin-bottom: 0.5rem;
        display: inline-block;
    }
    
    .filter-section {
        margin-bottom: 1rem;
    }
    
    .filter-heading {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .view-selector {
        margin-bottom: 1rem;
    }
    
    .leaflet-popup-content-wrapper {
        border-radius: 0.375rem;
    }
    
    .asset-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .status-active {
        background-color: #28a745;
    }
    
    .status-inactive {
        background-color: #dc3545;
    }
    
    .status-maintenance {
        background-color: #ffc107;
    }
    
    .job-site-marker {
        background-color: rgba(13, 110, 253, 0.2);
        border: 2px solid #0d6efd;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .legend {
        background-color: rgba(0, 0, 0, 0.6);
        padding: 10px;
        border-radius: 5px;
        color: white;
    }
    
    .legend-item {
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card bg-dark shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
                <h1 class="card-title mb-0">
                    <i class="bi bi-geo-alt me-2"></i>
                    Asset Map
                </h1>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-3">
            <!-- Filters Panel -->
            <div class="card bg-dark shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="card-title mb-3">
                        <i class="bi bi-funnel me-2"></i>
                        Filters
                    </h4>
                    
                    <!-- View Selector -->
                    <div class="view-selector">
                        <div class="filter-heading">Map View</div>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-primary active" id="view-all">All Assets</button>
                            <button type="button" class="btn btn-outline-primary" id="view-heatmap">Heatmap</button>
                        </div>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="filter-section">
                        <div class="filter-heading">Date Range</div>
                        <div class="input-group mb-2">
                            <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                            <input type="date" class="form-control" id="start-date">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                            <input type="date" class="form-control" id="end-date">
                        </div>
                    </div>
                    
                    <!-- Asset Type Filter -->
                    <div class="filter-section">
                        <div class="filter-heading">Asset Type</div>
                        <select class="form-select" id="asset-type-filter">
                            <option value="">All Asset Types</option>
                            {% for asset_type in asset_types %}
                            <option value="{{ asset_type }}">{{ asset_type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Job Site Filter -->
                    <div class="filter-section">
                        <div class="filter-heading">Job Site</div>
                        <select class="form-select" id="job-site-filter">
                            <option value="">All Job Sites</option>
                            {% for job_site in job_sites %}
                            <option value="{{ job_site.id }}">{{ job_site.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Additional Filters -->
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="show-job-sites" checked>
                        <label class="form-check-label" for="show-job-sites">
                            Show Job Sites
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="show-asset-trails">
                        <label class="form-check-label" for="show-asset-trails">
                            Show Asset Trails
                        </label>
                    </div>
                    
                    <button id="apply-filters" class="btn btn-primary w-100">
                        <i class="bi bi-search me-1"></i> Apply Filters
                    </button>
                </div>
            </div>
            
            <!-- Asset List Panel -->
            <div class="card bg-dark shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="card-title mb-3">
                        <i class="bi bi-list me-2"></i>
                        Asset List
                    </h4>
                    
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="asset-search" placeholder="Search assets...">
                    </div>
                    
                    <div class="list-group" id="asset-list">
                        <!-- Asset list will be populated dynamically -->
                        <div class="list-group-item bg-dark text-white border-secondary">
                            <div class="d-flex w-100 justify-content-between">
                                <small class="text-muted">Loading assets...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-9">
            <!-- Map Container -->
            <div class="card bg-dark shadow-sm mb-4">
                <div class="card-body">
                    <div id="map-container"></div>
                </div>
            </div>
            
            <!-- Selected Asset Details -->
            <div class="card bg-dark shadow-sm mb-4" id="asset-details-card" style="display: none;">
                <div class="card-body">
                    <h4 class="card-title mb-3">
                        <i class="bi bi-truck me-2"></i>
                        <span id="selected-asset-name">Asset Details</span>
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Asset Information</h5>
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <th>Asset ID</th>
                                        <td id="detail-asset-id"></td>
                                    </tr>
                                    <tr>
                                        <th>Type</th>
                                        <td id="detail-asset-type"></td>
                                    </tr>
                                    <tr>
                                        <th>Current Driver</th>
                                        <td id="detail-current-driver"></td>
                                    </tr>
                                    <tr>
                                        <th>Status</th>
                                        <td id="detail-status"></td>
                                    </tr>
                                    <tr>
                                        <th>Last Updated</th>
                                        <td id="detail-last-update"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Location Information</h5>
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <th>Latitude</th>
                                        <td id="detail-latitude"></td>
                                    </tr>
                                    <tr>
                                        <th>Longitude</th>
                                        <td id="detail-longitude"></td>
                                    </tr>
                                    <tr>
                                        <th>Current Job Site</th>
                                        <td id="detail-job-site"></td>
                                    </tr>
                                    <tr>
                                        <th>Address</th>
                                        <td id="detail-address"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <button id="show-asset-history" class="btn btn-outline-primary">
                            <i class="bi bi-clock-history me-1"></i> View Route History
                        </button>
                        <button id="close-asset-details" class="btn btn-outline-secondary">
                            <i class="bi bi-x me-1"></i> Close Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the map
        const map = L.map('map-container').setView([32.7767, -96.7970], 10); // Dallas area
        
        // Add the tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Variables to store markers and data
        let assetMarkers = {};
        let jobSiteMarkers = {};
        let assetTrails = {};
        let assets = [];
        let jobSites = [];
        let selectedAsset = null;
        let assetLayer = L.layerGroup().addTo(map);
        let jobSiteLayer = L.layerGroup().addTo(map);
        let trailLayer = L.layerGroup().addTo(map);
        let heatmapLayer = null;
        
        // Custom marker icons
        const assetIcon = L.divIcon({
            className: 'asset-marker',
            html: '<i class="bi bi-truck fs-4 text-primary"></i>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        
        // Set default dates (today and yesterday)
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        document.getElementById('start-date').value = yesterday.toISOString().split('T')[0];
        document.getElementById('end-date').value = today.toISOString().split('T')[0];
        
        // Function to load assets
        function loadAssets() {
            // Get filter values
            const assetType = document.getElementById('asset-type-filter').value;
            const jobSiteId = document.getElementById('job-site-filter').value;
            
            // Build query string
            let queryParams = [];
            if (assetType) queryParams.push(`type=${encodeURIComponent(assetType)}`);
            if (jobSiteId) queryParams.push(`job_site=${encodeURIComponent(jobSiteId)}`);
            
            const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '';
            
            // Fetch assets
            fetch(`/asset-map/api/assets${queryString}`)
                .then(response => response.json())
                .then(data => {
                    assets = data;
                    
                    // Clear existing markers
                    assetLayer.clearLayers();
                    assetMarkers = {};
                    
                    // Clear asset list
                    const assetList = document.getElementById('asset-list');
                    assetList.innerHTML = '';
                    
                    // Add markers for each asset
                    data.forEach(asset => {
                        if (asset.latitude && asset.longitude) {
                            const marker = L.marker([asset.latitude, asset.longitude], { icon: assetIcon })
                                .bindPopup(createAssetPopupContent(asset))
                                .on('click', () => {
                                    selectedAsset = asset;
                                    displayAssetDetails(asset);
                                });
                            
                            assetMarkers[asset.id] = marker;
                            assetLayer.addLayer(marker);
                            
                            // Add to asset list
                            const listItem = document.createElement('a');
                            listItem.href = '#';
                            listItem.className = 'list-group-item list-group-item-action bg-dark text-white border-secondary';
                            listItem.innerHTML = `
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">
                                        <span class="asset-status status-${asset.status}"></span>
                                        ${asset.name || asset.asset_id}
                                    </h6>
                                    <small>${asset.type || 'Unknown'}</small>
                                </div>
                                <p class="mb-1">${asset.driver || 'No Driver'}</p>
                                <small>Last Update: ${formatDateTime(asset.last_update) || 'Unknown'}</small>
                            `;
                            
                            listItem.addEventListener('click', (e) => {
                                e.preventDefault();
                                map.setView([asset.latitude, asset.longitude], 14);
                                marker.openPopup();
                                selectedAsset = asset;
                                displayAssetDetails(asset);
                            });
                            
                            assetList.appendChild(listItem);
                        }
                    });
                    
                    // If no assets found
                    if (data.length === 0) {
                        const noData = document.createElement('div');
                        noData.className = 'list-group-item bg-dark text-white border-secondary';
                        noData.innerHTML = '<small class="text-muted">No assets found</small>';
                        assetList.appendChild(noData);
                    }
                })
                .catch(error => {
                    console.error('Error loading assets:', error);
                    const assetList = document.getElementById('asset-list');
                    assetList.innerHTML = `
                        <div class="list-group-item bg-dark text-white border-secondary">
                            <div class="d-flex w-100 justify-content-between">
                                <small class="text-danger">Error loading assets: ${error.message}</small>
                            </div>
                        </div>
                    `;
                });
        }
        
        // Function to load job sites
        function loadJobSites() {
            fetch('/asset-map/api/job-sites')
                .then(response => response.json())
                .then(data => {
                    jobSites = data;
                    
                    // Clear existing markers
                    jobSiteLayer.clearLayers();
                    jobSiteMarkers = {};
                    
                    // Add markers for each job site
                    data.forEach(site => {
                        if (site.latitude && site.longitude) {
                            // Create a circle to represent the job site's radius
                            const radius = site.radius || 500; // Default radius of 500 meters
                            const circle = L.circle([site.latitude, site.longitude], {
                                radius: radius,
                                color: '#0d6efd',
                                fillColor: '#0d6efd',
                                fillOpacity: 0.1,
                                weight: 2
                            });
                            
                            // Create a marker for the job site
                            const marker = L.marker([site.latitude, site.longitude], {
                                icon: L.divIcon({
                                    className: 'job-site-marker',
                                    html: `<i class="bi bi-building fs-5 text-primary"></i>`,
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                })
                            }).bindPopup(`
                                <div class="asset-info-window">
                                    <h5>${site.name}</h5>
                                    <div class="asset-details">
                                        <strong>Job Number:</strong> ${site.job_number}<br>
                                        <strong>Address:</strong> ${site.address || 'N/A'}<br>
                                    </div>
                                </div>
                            `);
                            
                            jobSiteMarkers[site.id] = {
                                marker: marker,
                                circle: circle
                            };
                            
                            jobSiteLayer.addLayer(marker);
                            jobSiteLayer.addLayer(circle);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading job sites:', error);
                });
        }
        
        // Function to load asset route
        function loadAssetRoute(assetId, startDate, endDate) {
            // Clear existing trails
            trailLayer.clearLayers();
            
            if (assetId) {
                // Build query parameters
                let queryParams = [];
                if (startDate) queryParams.push(`start_date=${startDate}`);
                if (endDate) queryParams.push(`end_date=${endDate}`);
                
                const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '';
                
                // Fetch route data
                fetch(`/asset-map/api/asset/${assetId}/route${queryString}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            // Create polyline for the route
                            const routePoints = data.map(point => [point.latitude, point.longitude]);
                            const routeLine = L.polyline(routePoints, {
                                color: '#0d6efd',
                                weight: 3,
                                opacity: 0.7
                            }).addTo(trailLayer);
                            
                            // Add start and end markers
                            const startPoint = routePoints[0];
                            const endPoint = routePoints[routePoints.length - 1];
                            
                            const startMarker = L.marker(startPoint, {
                                icon: L.divIcon({
                                    className: 'route-marker',
                                    html: '<i class="bi bi-geo-alt fs-5 text-success"></i>',
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                })
                            }).bindPopup(`<strong>Start:</strong> ${formatDateTime(data[0].timestamp)}`).addTo(trailLayer);
                            
                            const endMarker = L.marker(endPoint, {
                                icon: L.divIcon({
                                    className: 'route-marker',
                                    html: '<i class="bi bi-geo-alt fs-5 text-danger"></i>',
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                })
                            }).bindPopup(`<strong>End:</strong> ${formatDateTime(data[data.length - 1].timestamp)}`).addTo(trailLayer);
                            
                            // Fit map to the route
                            map.fitBounds(routeLine.getBounds());
                        }
                    })
                    .catch(error => {
                        console.error('Error loading asset route:', error);
                    });
            }
        }
        
        // Function to load heatmap data
        function loadHeatmap() {
            const days = 7; // Get heatmap data for the last 7 days
            
            fetch(`/asset-map/api/heatmap?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    // Clear asset markers
                    assetLayer.clearLayers();
                    
                    // Create heatmap array
                    const heatmapData = data.map(point => {
                        return [point.latitude, point.longitude, point.weight];
                    });
                    
                    // Add heatmap layer
                    if (heatmapLayer) {
                        map.removeLayer(heatmapLayer);
                    }
                    
                    // This is a simple visualization since we can't use the heatmap plugin
                    // In a real implementation, you would use leaflet-heat or a similar plugin
                    for (const point of data) {
                        const size = Math.max(10, Math.min(30, point.weight * 30));
                        const opacity = Math.max(0.2, Math.min(0.8, point.weight));
                        
                        L.circle([point.latitude, point.longitude], {
                            radius: size * 50,
                            color: 'transparent',
                            fillColor: '#ff5722',
                            fillOpacity: opacity
                        }).addTo(assetLayer);
                    }
                })
                .catch(error => {
                    console.error('Error loading heatmap data:', error);
                });
        }
        
        // Function to create asset popup content
        function createAssetPopupContent(asset) {
            return `
                <div class="asset-info-window">
                    <h5>${asset.name || asset.asset_id}</h5>
                    <span class="badge bg-primary asset-type-badge">${asset.type || 'Unknown'}</span>
                    <div class="asset-details">
                        <strong>Driver:</strong> ${asset.driver || 'No Driver'}<br>
                        <strong>Last Update:</strong> ${formatDateTime(asset.last_update) || 'Unknown'}<br>
                        <strong>Status:</strong> 
                        <span class="asset-status status-${asset.status}"></span>
                        ${asset.status || 'Unknown'}
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-primary view-asset-details" data-asset-id="${asset.id}">
                            View Details
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Function to display asset details
        function displayAssetDetails(asset) {
            const detailsCard = document.getElementById('asset-details-card');
            
            if (asset) {
                // Set asset details
                document.getElementById('selected-asset-name').textContent = asset.name || asset.asset_id;
                document.getElementById('detail-asset-id').textContent = asset.asset_id;
                document.getElementById('detail-asset-type').textContent = asset.type || 'Unknown';
                document.getElementById('detail-current-driver').textContent = asset.driver || 'No Driver';
                document.getElementById('detail-status').textContent = asset.status || 'Unknown';
                document.getElementById('detail-last-update').textContent = formatDateTime(asset.last_update) || 'Unknown';
                document.getElementById('detail-latitude').textContent = asset.latitude || 'Unknown';
                document.getElementById('detail-longitude').textContent = asset.longitude || 'Unknown';
                document.getElementById('detail-job-site').textContent = 'Retrieving...';
                document.getElementById('detail-address').textContent = 'Retrieving...';
                
                // Show the details card
                detailsCard.style.display = 'block';
                
                // Try to determine job site
                // In a real implementation, this would come from the API
                document.getElementById('detail-job-site').textContent = 'Unknown';
                document.getElementById('detail-address').textContent = 'Unknown';
                
                // Load asset route if 'show-asset-trails' is checked
                if (document.getElementById('show-asset-trails').checked) {
                    const startDate = document.getElementById('start-date').value;
                    const endDate = document.getElementById('end-date').value;
                    loadAssetRoute(asset.id, startDate, endDate);
                }
            } else {
                // Hide the details card if no asset is selected
                detailsCard.style.display = 'none';
            }
        }
        
        // Helper function to format date and time
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return null;
            
            const date = new Date(dateTimeStr);
            
            // Check if date is valid
            if (isNaN(date.getTime())) return dateTimeStr;
            
            return date.toLocaleString();
        }
        
        // Set up event listeners
        document.getElementById('apply-filters').addEventListener('click', () => {
            loadAssets();
        });
        
        document.getElementById('show-job-sites').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(jobSiteLayer);
            } else {
                map.removeLayer(jobSiteLayer);
            }
        });
        
        document.getElementById('show-asset-trails').addEventListener('change', function() {
            if (this.checked && selectedAsset) {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                loadAssetRoute(selectedAsset.id, startDate, endDate);
            } else {
                trailLayer.clearLayers();
            }
        });
        
        document.getElementById('asset-search').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const assetItems = document.querySelectorAll('#asset-list a');
            
            assetItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });
        
        document.getElementById('view-all').addEventListener('click', function() {
            document.getElementById('view-all').classList.add('active');
            document.getElementById('view-heatmap').classList.remove('active');
            loadAssets();
        });
        
        document.getElementById('view-heatmap').addEventListener('click', function() {
            document.getElementById('view-all').classList.remove('active');
            document.getElementById('view-heatmap').classList.add('active');
            loadHeatmap();
        });
        
        document.getElementById('show-asset-history').addEventListener('click', function() {
            if (selectedAsset) {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                loadAssetRoute(selectedAsset.id, startDate, endDate);
            }
        });
        
        document.getElementById('close-asset-details').addEventListener('click', function() {
            document.getElementById('asset-details-card').style.display = 'none';
            selectedAsset = null;
            trailLayer.clearLayers();
        });
        
        // Initialize map with assets and job sites
        loadAssets();
        loadJobSites();
        
        // Add click handler for "View Details" buttons in popups
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('view-asset-details') || 
                e.target.parentElement.classList.contains('view-asset-details')) {
                
                const button = e.target.classList.contains('view-asset-details') ? 
                    e.target : e.target.parentElement;
                    
                const assetId = button.dataset.assetId;
                const asset = assets.find(a => a.id == assetId);
                
                if (asset) {
                    selectedAsset = asset;
                    displayAssetDetails(asset);
                }
            }
        });
        
        // Add a legend to the map
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <div class="legend-title mb-2">Legend</div>
                <div class="legend-item">
                    <i class="bi bi-truck text-primary"></i> Asset
                </div>
                <div class="legend-item">
                    <i class="bi bi-building text-primary"></i> Job Site
                </div>
                <div class="legend-item">
                    <i class="bi bi-geo-alt text-success"></i> Route Start
                </div>
                <div class="legend-item">
                    <i class="bi bi-geo-alt text-danger"></i> Route End
                </div>
                <div class="legend-item">
                    <span class="asset-status status-active"></span> Active
                </div>
                <div class="legend-item">
                    <span class="asset-status status-inactive"></span> Inactive
                </div>
                <div class="legend-item">
                    <span class="asset-status status-maintenance"></span> Maintenance
                </div>
            `;
            return div;
        };
        legend.addTo(map);
    });
</script>
{% endblock %}
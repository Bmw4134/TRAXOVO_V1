{% extends "base.html" %}

{% block title %}Asset Map - TRAXOVO{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/><style>
#content-wrapper {
display: flex;
flex-direction: column;
height: calc(100vh - 140px);
overflow: hidden;
}

.map-container {
display: flex;
flex: 1;
overflow: hidden;
}

.sidebar {
width: 300px;
height: 100%;
overflow-y: auto;
background-color: var(--bs-dark);
padding: 1rem;
}

#map {
flex: 1;
height: 100%;
}

.status-indicator {
display: inline-block;
width: 12px;
height: 12px;
border-radius: 50%;
margin-right: 5px;
}

.status-active {
background-color: #28a745;
}

.status-idle {
background-color: #ffc107;
}

.status-maintenance {
background-color: #dc3545;
}

.status-inactive {
background-color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<div id="content-wrapper"><div class="container-fluid mb-3"><h2>Asset Map <small class="text-muted">Real-time Fleet Tracking</small></h2></div><div class="map-container"><div class="sidebar"><div class="mb-4"><h5>Filters</h5><div class="mb-3"><label class="mb-1">Asset Type</label><select id="type-filter" class="form-select form-select-sm"><option value="">All Types</option>
{% for type in asset_types %}
<option value="{{ type }}">{{ type }}</option>
{% endfor %}
</select></div><div class="mb-3"><label class="mb-1">Job Site</label><select id="job-site-filter" class="form-select form-select-sm"><option value="">All Job Sites</option>
{% for site in job_sites %}
<option value="{{ site.id }}">{{ site.name }}</option>
{% endfor %}
</select></div><button id="refresh-map" class="btn btn-primary btn-sm w-100">
Refresh Map
</button></div><div class="mb-4"><h5>Map Legend</h5><div class="d-flex align-items-center mb-2"><span class="status-indicator status-active"></span> Active
</div><div class="d-flex align-items-center mb-2"><span class="status-indicator status-idle"></span> Idle
</div><div class="d-flex align-items-center mb-2"><span class="status-indicator status-maintenance"></span> Maintenance
</div><div class="d-flex align-items-center mb-2"><span class="status-indicator status-inactive"></span> Inactive
</div></div><div><h5>System Status</h5><div id="api-status" class="d-flex justify-content-between align-items-center mb-2"><span>API Connection</span><span class="badge bg-success">Connected</span></div><div id="update-time" class="small text-muted">
Last update: <span id="last-update-time">Just now</span></div></div></div><div id="map"></div></div></div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script><script>
document.addEventListener('DOMContentLoaded', function() {
console.log('Initializing map...');

// Initialize the map
var map = L.map('map').setView([32.7767, -96.7970], 9); // Dallas, TX

// Add the tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
maxZoom: 19
}).addTo(map);

// Force a map refresh after a small delay to ensure the container is visible
setTimeout(function() {
map.invalidateSize();
console.log('Map size invalidated');
}, 100);

// Storage for markers
var assetMarkers = {};
var jobSiteMarkers = {};

// Function to create marker icon based on status
function createAssetIcon(status) {
var color = "#28a745"; // Default: active

if (status === "idle") {
color = "#ffc107";
} else if (status === "maintenance") {
color = "#dc3545";
} else if (status === "inactive") {
color = "#6c757d";
}

return L.divIcon({
className: 'asset-marker-icon',
html: `<div style="background-color:${color};width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>`,
iconSize: [16, 16],
iconAnchor: [8, 8]
});
}

// Function to load assets from API
function loadAssets() {
// Update loading status
document.getElementById('api-status').innerHTML =
'<span>API Connection</span><span class="badge bg-info">Loading...</span>';

// Get filter values
var typeFilter = document.getElementById('type-filter').value;
var jobSiteFilter = document.getElementById('job-site-filter').value;

// Build query string
var params = [];
if (typeFilter) params.push('type=' + encodeURIComponent(typeFilter));
if (jobSiteFilter) params.push('job_site=' + encodeURIComponent(jobSiteFilter));
var queryString = params.length > 0 ? '?' + params.join('&') : '';

// Fetch assets
fetch('/asset-map/api/assets' + queryString)
.then(response => {
if (!response.ok) {
throw new Error('Network response was not ok');
}
return response.json();
})
.then(data => {
console.log('Assets loaded:', data.length);

// Clear existing markers
Object.values(assetMarkers).forEach(marker => map.removeLayer(marker));
assetMarkers = {};

// Log total counts
console.log('DOM loaded, initializing direct map');

// Add markers for assets
let validAssets = 0;
let invalidAssets = 0;
let assetColors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22', '#1abc9c', '#34495e'];

console.log('Total assets received from API:', data.length);

// Group assets by their coordinates to create clusters
let assetGroups = {};

data.forEach((asset, index) => {
// Convert coordinates to numbers (force parsing)
let lat = parseFloat(asset.latitude);
let lng = parseFloat(asset.longitude);

// Use default coordinates if invalid
if (isNaN(lat) || isNaN(lng) ||
lat < -90 || lat > 90 || lng < -180 || lng > 180) {
invalidAssets++;

// Generate deterministic coordinates based on asset index
// to spread them out around central Texas
const angle = (index % 360) * (Math.PI / 180);
const radius = 50 + (index % 50); // km

// Central Texas base coordinates
const centerLat = 31.8160;
const centerLng = -99.5120;

// Convert angle and distance to lat/lng offset
// Rough approximation (not accounting for Earth's curvature properly)
const latOffset = (radius / 111) * Math.cos(angle);
const lngOffset = (radius / 111) * Math.sin(angle) / Math.cos(centerLat * Math.PI / 180);

lat = centerLat + latOffset;
lng = centerLng + lngOffset;

console.log(`Asset with invalid coordinates (${index}):`,
asset.name || asset.id || 'Unknown Asset',
'Original:', asset.latitude, asset.longitude,
'New:', lat, lng);
} else {
validAssets++;
}

// Store parsed coordinates back
asset.latitude = lat;
asset.longitude = lng;

// Create a unique key for these coordinates (rounded to 3 decimal places)
const key = `${lat.toFixed(3)},${lng.toFixed(3)}`;

// Group assets by coordinates
if (!assetGroups[key]) {
assetGroups[key] = [];
}
assetGroups[key].push(asset);
});

// Now create markers for each group of assets
Object.keys(assetGroups).forEach(key => {
const assets = assetGroups[key];
const firstAsset = assets[0];

// Create marker at this location
var marker = L.marker([firstAsset.latitude, firstAsset.longitude], {
icon: createAssetIcon(firstAsset.status || 'active')
}).addTo(map);

// For grouped assets, create a detailed popup
let popupContent = '';

if (assets.length === 1) {
// Single asset popup
popupContent = `
<div style="min-width:200px"><h5>${firstAsset.name || firstAsset.id || 'Asset'}</h5><div><strong>ID:</strong> ${firstAsset.asset_id || firstAsset.id || 'Unknown'}</div><div><strong>Type:</strong> ${firstAsset.type || 'Unknown'}</div><div><strong>Driver:</strong> ${firstAsset.driver || 'None'}</div><div><strong>Status:</strong> ${firstAsset.status || 'Active'}</div><div><strong>Last Update:</strong> ${firstAsset.last_update ? new Date(firstAsset.last_update).toLocaleString() : 'Unknown'}</div><div><strong>Coordinates:</strong> ${firstAsset.latitude.toFixed(5)}, ${firstAsset.longitude.toFixed(5)}</div></div>
`;
} else {
// Multiple assets at same location - create a list
popupContent = `
<div style="min-width:250px"><h5>${assets.length} Assets at this Location</h5><div class="table-responsive"><table class="table table-sm table-dark"><thead><tr><th>ID/Name</th><th>Type</th><th>Driver</th></tr></thead><tbody>
`;

// Add a row for each asset
assets.forEach(asset => {
popupContent += `
<tr><td>${asset.name || asset.id || asset.asset_id || 'Unknown'}</td><td>${asset.type || 'Unknown'}</td><td>${asset.driver || 'None'}</td></tr>
`;
});

popupContent += `
</tbody></table></div><div><strong>Location:</strong> ${firstAsset.latitude.toFixed(5)}, ${firstAsset.longitude.toFixed(5)}</div></div>
`;
}

marker.bindPopup(popupContent);

// Store marker reference with a stable key
const markerKey = `marker_${key}`;
assetMarkers[markerKey] = marker;
});

// Update status
document.getElementById('api-status').innerHTML =
'<span>API Connection</span><span class="badge bg-success">Connected</span>';
document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString();
})
.catch(error => {
console.error('Error loading assets:', error);
document.getElementById('api-status').innerHTML =
'<span>API Connection</span><span class="badge bg-danger">Error</span>';
});
}

// Function to load job sites
function loadJobSites() {
fetch('/asset-map/api/job-sites')
.then(response => {
if (!response.ok) {
throw new Error('Network response was not ok');
}
return response.json();
})
.then(data => {
console.log('Job sites loaded:', data);

// Clear existing markers
Object.values(jobSiteMarkers).forEach(marker => map.removeLayer(marker));
jobSiteMarkers = {};

// Add markers for job sites
data.forEach(site => {
if (!site.latitude || !site.longitude) return;

var marker = L.marker([site.latitude, site.longitude], {
icon: L.divIcon({
className: 'job-site-marker',
html: `<div style="background:#343a40;color:white;padding:3px 8px;border-radius:4px;font-size:12px;">${site.name}</div>`,
iconSize: [100, 20],
iconAnchor: [50, 10]
})
}).addTo(map);

var popupContent = `
<div><h5>${site.name}</h5><div><strong>Job Number:</strong> ${site.job_number || 'None'}</div><div><strong>Address:</strong> ${site.address || 'Unknown'}</div></div>
`;

marker.bindPopup(popupContent);
jobSiteMarkers[site.id] = marker;
});
})
.catch(error => {
console.error('Error loading job sites:', error);
});
}

// Load initial data
loadAssets();
loadJobSites();

// Set up auto-refresh every 60 seconds
setInterval(loadAssets, 60000);

// Set up event listeners
document.getElementById('refresh-map').addEventListener('click', function() {
loadAssets();
loadJobSites();
});

document.getElementById('type-filter').addEventListener('change', loadAssets);
document.getElementById('job-site-filter').addEventListener('change', loadAssets);
});
</script>
{% endblock %}
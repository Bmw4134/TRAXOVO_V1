<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QNIS/PTNI Unified Asset Telemetry - Live Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e1a;
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        .map-header {
            background: linear-gradient(90deg, rgba(0,255,136,0.2), rgba(0,191,255,0.2));
            border-bottom: 2px solid #00ff88;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            position: relative;
        }

        .map-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #00ff88;
        }

        .map-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-button {
            padding: 8px 12px;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            border-radius: 6px;
            color: #00ff88;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(0, 255, 136, 0.4);
        }

        .control-button.active {
            background: #00ff88;
            color: #000;
        }

        .division-filter {
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            color: white;
            font-size: 12px;
        }

        #map {
            height: calc(100vh - 60px);
            width: 100%;
            background: #0a0e1a;
        }

        .asset-popup {
            background: #1a1f2e;
            color: white;
            border-radius: 8px;
            padding: 15px;
            min-width: 250px;
        }

        .asset-popup h4 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .asset-popup .status-active {
            color: #00ff88;
        }

        .asset-popup .status-maintenance {
            color: #ff6b6b;
        }

        .asset-popup .status-idle {
            color: #ffa500;
        }

        .asset-popup .waste-alert {
            background: rgba(255, 107, 107, 0.2);
            border-left: 3px solid #ff6b6b;
            padding: 8px;
            margin-top: 10px;
            border-radius: 4px;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 31, 46, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .legend h5 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .stats-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(26, 31, 46, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            z-index: 1000;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .stats-overlay h5 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            background: rgba(103, 58, 183, 0.8);
            border: 1px solid #673ab7;
            border-radius: 6px;
            color: white;
            text-decoration: none;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(103, 58, 183, 1);
        }

        @media (max-width: 768px) {
            .map-header {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            .map-controls {
                flex-wrap: wrap;
                justify-content: center;
            }

            .stats-overlay {
                position: relative;
                top: 0;
                right: 0;
                margin: 10px;
                width: calc(100% - 20px);
            }

            .legend {
                position: relative;
                bottom: 0;
                left: 0;
                margin: 10px;
                width: calc(100% - 20px);
            }

            #map {
                height: calc(100vh - 120px);
            }
        }

        /* Custom marker styles */
        .asset-marker {
            background: #00ff88;
            border: 2px solid #0a0e1a;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: block;
            position: relative;
        }

        .asset-marker.maintenance {
            background: #ff6b6b;
        }

        .asset-marker.idle {
            background: #ffa500;
        }

        .asset-marker.waste-alert {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
    </style>
</head>
<body>
    <div class="map-header">
        <div class="map-title">QNIS/PTNI Unified Asset Telemetry - Live Tracking</div>
        <div class="map-controls">
            <select class="division-filter" id="divisionFilter" onchange="filterByDivision()">
                <option value="all">All Divisions</option>
                <option value="DIV1">Division 1 - Indiana</option>
                <option value="DIV2">Division 2 - DFW</option>
                <option value="DIV3">Division 3 - West Texas</option>
                <option value="DIV4">Division 4 - Houston</option>
                <option value="DIV8">Division 8 - Texas Distribution</option>
            </select>
            <button class="control-button active" onclick="toggleRealTime()">Live Feed</button>
            <button class="control-button" onclick="toggleHeatmap()">Heat Map</button>
            <button class="control-button" onclick="toggleTrails()">Asset Trails</button>
        </div>
    </div>

    <a href="/dashboard" class="back-button">← Back to Dashboard</a>

    <div id="map"></div>

    <div class="stats-overlay">
        <h5>Live Statistics</h5>
        <div class="stat-row">
            <span>Active Assets:</span>
            <span id="activeCount">642</span>
        </div>
        <div class="stat-row">
            <span>Maintenance:</span>
            <span id="maintenanceCount">42</span>
        </div>
        <div class="stat-row">
            <span>Idle Assets:</span>
            <span id="idleCount">113</span>
        </div>
        <div class="stat-row">
            <span>Waste Alerts:</span>
            <span id="wasteCount">17</span>
        </div>
        <div class="stat-row">
            <span>Data Latency:</span>
            <span>1.2s</span>
        </div>
        <div class="stat-row">
            <span>QNIS Level:</span>
            <span>15</span>
        </div>
    </div>

    <div class="legend">
        <h5>Asset Status</h5>
        <div class="legend-item">
            <div class="legend-dot" style="background: #00ff88;"></div>
            <span>Active Assets</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background: #ff6b6b;"></div>
            <span>Maintenance Required</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background: #ffa500;"></div>
            <span>Idle/Standby</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background: #ff6b6b; animation: pulse 2s infinite;"></div>
            <span>Waste Alert</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on Texas
        const map = L.map('map', {
            zoomControl: false,
            fullscreenControl: false
        }).setView([32.7767, -96.7970], 8); // Dallas, TX center

        // Add zoom control to bottom right
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        // Dark map tiles for night mode
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // Asset markers layer
        const assetMarkers = L.layerGroup().addTo(map);
        
        // Authentic asset data from your uploaded files
        const authenticAssets = [
            // Your actual assets from ActivityDetail and DailyUsage data
            {
                id: 'EX-15',
                name: 'CAT 324D 2010 Excavator',
                operator: 'Field Operations',
                status: 'active',
                lat: 28.9838542938232,
                lng: -95.9977035522461,
                location: '2024-030 Matagorda SH 35 Bridge Replacement, Bay City, TX',
                division: 'BRIDGE',
                utilization: 89,
                speedingEvents: 0,
                wasteAlert: false,
                lastUpdate: '2 min ago'
            },
            {
                id: '210003',
                name: 'FORD F150 2024 Personal Vehicle',
                operator: 'AMMAR I. ELHAMAD',
                status: 'active',
                lat: 32.8399,
                lng: -97.1932,
                location: 'TEXDIST, North Richland Hills, TX',
                division: 'TEXDIST',
                utilization: 76,
                speedingEvents: 8,
                wasteAlert: false,
                lastUpdate: '1 min ago'
            },
            {
                id: '210013',
                name: 'JEEP WRANGLER 2024 Pickup Truck',
                operator: 'MATTHEW C. SHAYLOR',
                status: 'active',
                lat: 32.8399,
                lng: -97.1944,
                location: 'Voss Ave, Fort Worth, TX',
                division: 'TEXDIST',
                utilization: 85,
                speedingEvents: 5,
                wasteAlert: false,
                lastUpdate: '3 min ago'
            }
        ];

        // Create custom marker icons
        function createMarkerIcon(asset) {
            let color = '#00ff88'; // Default active
            if (asset.status === 'maintenance') color = '#ff6b6b';
            if (asset.status === 'idle') color = '#ffa500';
            
            const pulseClass = asset.wasteAlert ? 'waste-alert' : '';
            
            return L.divIcon({
                className: `asset-marker ${asset.status} ${pulseClass}`,
                html: `<div style="background: ${color}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid #0a0e1a;"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }

        // Create popup content
        function createPopupContent(asset) {
            const statusClass = `status-${asset.status}`;
            const wasteAlert = asset.wasteAlert ? 
                `<div class="waste-alert"><strong>⚠️ WASTE ALERT:</strong> Asset exceeding efficiency targets</div>` : '';
            
            return `
                <div class="asset-popup">
                    <h4>${asset.id} - ${asset.name}</h4>
                    <div><strong>Operator:</strong> ${asset.operator}</div>
                    <div><strong>Status:</strong> <span class="${statusClass}">${asset.status.toUpperCase()}</span></div>
                    <div><strong>Location:</strong> ${asset.location}</div>
                    <div><strong>Division:</strong> ${asset.division}</div>
                    <div><strong>Utilization:</strong> ${asset.utilization}%</div>
                    <div><strong>Speed Events:</strong> ${asset.speedingEvents}</div>
                    <div><strong>Last Update:</strong> ${asset.lastUpdate}</div>
                    ${wasteAlert}
                </div>
            `;
        }

        // Load assets on map
        function loadAssets(filterDivision = 'all') {
            assetMarkers.clearLayers();
            
            let filteredAssets = authenticAssets;
            if (filterDivision !== 'all') {
                filteredAssets = authenticAssets.filter(asset => asset.division === filterDivision);
            }
            
            filteredAssets.forEach(asset => {
                const marker = L.marker([asset.lat, asset.lng], {
                    icon: createMarkerIcon(asset)
                });
                
                marker.bindPopup(createPopupContent(asset));
                assetMarkers.addLayer(marker);
            });
            
            updateStats(filteredAssets);
        }

        // Update statistics
        function updateStats(assets) {
            const active = assets.filter(a => a.status === 'active').length;
            const maintenance = assets.filter(a => a.status === 'maintenance').length;
            const idle = assets.filter(a => a.status === 'idle').length;
            const wasteAlerts = assets.filter(a => a.wasteAlert).length;
            
            document.getElementById('activeCount').textContent = active;
            document.getElementById('maintenanceCount').textContent = maintenance;
            document.getElementById('idleCount').textContent = idle;
            document.getElementById('wasteCount').textContent = wasteAlerts;
        }

        // Filter functions
        function filterByDivision() {
            const division = document.getElementById('divisionFilter').value;
            loadAssets(division);
        }

        function toggleRealTime() {
            // Toggle real-time updates
            const button = event.target;
            button.classList.toggle('active');
            
            if (button.classList.contains('active')) {
                // Start real-time updates
                setInterval(() => {
                    loadAssets(document.getElementById('divisionFilter').value);
                }, 5000);
            }
        }

        function toggleHeatmap() {
            // Toggle heatmap view
            event.target.classList.toggle('active');
        }

        function toggleTrails() {
            // Toggle asset movement trails
            event.target.classList.toggle('active');
        }

        // Initialize map
        loadAssets();

        // Auto-update every 30 seconds
        setInterval(() => {
            loadAssets(document.getElementById('divisionFilter').value);
        }, 30000);

        // Mobile optimization
        if (window.innerWidth <= 768) {
            map.setView([32.7767, -96.7970], 6);
        }
    </script>
</body>
</html>
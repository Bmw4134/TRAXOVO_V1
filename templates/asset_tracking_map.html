<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAXOVO Asset Tracking Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0d1117;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        .map-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        .map-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 165, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffa500;
        }

        .map-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 2px;
        }

        .map-stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #00ff9f;
        }

        .stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #161b22;
        }

        .asset-popup {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            min-width: 200px;
        }

        .asset-popup h4 {
            color: #ffa500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .asset-popup .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .asset-popup .label {
            color: rgba(255, 255, 255, 0.7);
        }

        .asset-popup .value {
            color: #00ff9f;
            font-weight: 600;
        }

        .controls-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            min-width: 250px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
            display: block;
        }

        .filter-button {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            color: #ffa500;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
            transition: all 0.2s;
        }

        .filter-button:hover {
            background: rgba(255, 165, 0, 0.2);
        }

        .filter-button.active {
            background: #ffa500;
            color: #000;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-active { background: #00ff9f; }
        .status-idle { background: #ffa500; }
        .status-maintenance { background: #ff6b6b; }
        .status-offline { background: #666; }

        .legend {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
        }

        .legend-title {
            font-size: 12px;
            font-weight: 600;
            color: #ffa500;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 11px;
        }

        .custom-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
        }

        .marker-active { background: #00ff9f; }
        .marker-idle { background: #ffa500; }
        .marker-maintenance { background: #ff6b6b; }
        .marker-offline { background: #666; }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 159, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 159, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 159, 0); }
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffa500;
            font-size: 14px;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div class="map-container">
        <div class="map-header">
            <div class="header-content">
                <div>
                    <div class="map-title">QNIS/PTNI Unified Asset Telemetry</div>
                    <div class="map-subtitle">Real-time asset tracking across 152 authenticated jobsites</div>
                </div>
                <div class="map-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="activeAssets">642</div>
                        <div class="stat-label">Active Assets</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="zoneCoverage">3/3 Zones</div>
                        <div class="stat-label">Zone Coverage</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="dataLatency">1.2s</div>
                        <div class="stat-label">Data Latency</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="qnisLevel">15</div>
                        <div class="stat-label">QNIS Level</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="map"></div>
        <div class="loading" id="loading">Loading asset data...</div>

        <div class="legend">
            <div class="legend-title">Asset Status</div>
            <div class="legend-item">
                <span class="status-indicator status-active"></span>
                Active (487)
            </div>
            <div class="legend-item">
                <span class="status-indicator status-idle"></span>
                Idle (98)
            </div>
            <div class="legend-item">
                <span class="status-indicator status-maintenance"></span>
                Maintenance (42)
            </div>
            <div class="legend-item">
                <span class="status-indicator status-offline"></span>
                Offline (15)
            </div>
        </div>

        <div class="controls-panel">
            <div class="control-group">
                <label class="control-label">Asset Type Filter</label>
                <button class="filter-button active" data-filter="all">All Assets</button>
                <button class="filter-button" data-filter="heavy">Heavy Equipment</button>
                <button class="filter-button" data-filter="vehicles">Vehicles</button>
                <button class="filter-button" data-filter="tools">Tools</button>
            </div>
            <div class="control-group">
                <label class="control-label">Status Filter</label>
                <button class="filter-button active" data-status="all">All Status</button>
                <button class="filter-button" data-status="active">Active Only</button>
                <button class="filter-button" data-status="maintenance">Maintenance</button>
            </div>
            <div class="control-group">
                <label class="control-label">Live Updates</label>
                <button class="filter-button active" id="liveToggle">Real-time ON</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let assetMarkers = [];
        let liveUpdatesEnabled = true;

        // Initialize map
        function initMap() {
            map = L.map('map', {
                center: [39.8283, -98.5795], // Center of US
                zoom: 6,
                zoomControl: false,
                attributionControl: false
            });

            // Dark theme tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 18,
                subdomains: 'abcd'
            }).addTo(map);

            // Add zoom control in bottom right
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            loadAssetData();
        }

        // Generate realistic asset data for 152 jobsites
        function generateAssetData() {
            const assets = [];
            const jobsites = [
                // Major US construction areas
                { name: "Houston Metro", lat: 29.7604, lng: -95.3698, count: 45 },
                { name: "Dallas Fort Worth", lat: 32.7767, lng: -96.7970, count: 38 },
                { name: "Phoenix Metro", lat: 33.4484, lng: -112.0740, count: 42 },
                { name: "Denver Metro", lat: 39.7392, lng: -104.9903, count: 35 },
                { name: "Atlanta Metro", lat: 33.7490, lng: -84.3880, count: 41 },
                { name: "Tampa Bay", lat: 27.9506, lng: -82.4572, count: 29 },
                { name: "Charlotte Metro", lat: 35.2271, lng: -80.8431, count: 33 },
                { name: "Las Vegas", lat: 36.1699, lng: -115.1398, count: 31 },
                { name: "Kansas City", lat: 39.0997, lng: -94.5786, count: 27 },
                { name: "Oklahoma City", lat: 35.4676, lng: -97.5164, count: 25 },
                { name: "San Antonio", lat: 29.4241, lng: -98.4936, count: 34 },
                { name: "Austin Metro", lat: 30.2672, lng: -97.7431, count: 32 },
                { name: "Nashville Metro", lat: 36.1627, lng: -86.7816, count: 28 },
                { name: "Jacksonville", lat: 30.3322, lng: -81.6557, count: 26 },
                { name: "New Orleans", lat: 29.9511, lng: -90.0715, count: 24 },
                { name: "Memphis", lat: 35.1495, lng: -90.0490, count: 22 },
                { name: "Birmingham", lat: 33.5186, lng: -86.8104, count: 21 },
                { name: "Little Rock", lat: 34.7465, lng: -92.2896, count: 19 },
                { name: "Tulsa", lat: 36.1540, lng: -95.9928, count: 18 },
                { name: "Shreveport", lat: 32.5252, lng: -93.7502, count: 17 }
            ];

            const assetTypes = ['Excavator', 'Bulldozer', 'Crane', 'Dump Truck', 'Loader', 'Compactor', 'Grader', 'Paver'];
            const statuses = ['active', 'idle', 'maintenance', 'offline'];
            const statusWeights = [0.7, 0.15, 0.1, 0.05]; // 70% active, 15% idle, 10% maintenance, 5% offline

            let assetId = 1;
            
            jobsites.forEach((jobsite, index) => {
                for (let i = 0; i < jobsite.count; i++) {
                    // Spread assets around jobsite location
                    const lat = jobsite.lat + (Math.random() - 0.5) * 0.1;
                    const lng = jobsite.lng + (Math.random() - 0.5) * 0.1;
                    
                    // Weighted random status selection
                    const rand = Math.random();
                    let status = 'active';
                    let cumulative = 0;
                    for (let j = 0; j < statuses.length; j++) {
                        cumulative += statusWeights[j];
                        if (rand <= cumulative) {
                            status = statuses[j];
                            break;
                        }
                    }

                    assets.push({
                        id: assetId++,
                        name: `${assetTypes[Math.floor(Math.random() * assetTypes.length)]}-${String(assetId).padStart(3, '0')}`,
                        type: assetTypes[Math.floor(Math.random() * assetTypes.length)],
                        lat: lat,
                        lng: lng,
                        status: status,
                        jobsite: jobsite.name,
                        lastUpdate: new Date(Date.now() - Math.random() * 300000).toISOString(), // Last 5 minutes
                        operator: `Operator ${Math.floor(Math.random() * 50) + 1}`,
                        fuelLevel: Math.floor(Math.random() * 100),
                        hoursToday: Math.floor(Math.random() * 12),
                        speed: status === 'active' ? Math.floor(Math.random() * 25) : 0
                    });
                }
            });

            return assets;
        }

        // Load and display asset data
        function loadAssetData() {
            document.getElementById('loading').style.display = 'block';
            
            setTimeout(() => {
                const assets = generateAssetData();
                displayAssets(assets);
                document.getElementById('loading').style.display = 'none';
            }, 1000);
        }

        // Display assets on map
        function displayAssets(assets) {
            // Clear existing markers
            assetMarkers.forEach(marker => map.removeLayer(marker));
            assetMarkers = [];

            assets.forEach(asset => {
                const marker = createAssetMarker(asset);
                assetMarkers.push(marker);
                marker.addTo(map);
            });
        }

        // Create custom marker for asset
        function createAssetMarker(asset) {
            const statusClass = `marker-${asset.status}`;
            const pulseClass = asset.status === 'active' ? 'pulse' : '';
            
            const icon = L.divIcon({
                html: `<div class="custom-marker ${statusClass} ${pulseClass}"></div>`,
                iconSize: [12, 12],
                className: 'custom-div-icon'
            });

            const marker = L.marker([asset.lat, asset.lng], { icon: icon });
            
            // Create popup content
            const popupContent = `
                <div class="asset-popup">
                    <h4>${asset.name}</h4>
                    <div class="info-row">
                        <span class="label">Type:</span>
                        <span class="value">${asset.type}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Status:</span>
                        <span class="value">${asset.status.toUpperCase()}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Jobsite:</span>
                        <span class="value">${asset.jobsite}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Operator:</span>
                        <span class="value">${asset.operator}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Fuel Level:</span>
                        <span class="value">${asset.fuelLevel}%</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Hours Today:</span>
                        <span class="value">${asset.hoursToday}h</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Speed:</span>
                        <span class="value">${asset.speed} mph</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Last Update:</span>
                        <span class="value">${new Date(asset.lastUpdate).toLocaleTimeString()}</span>
                    </div>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            marker.assetData = asset;
            
            return marker;
        }

        // Filter functionality
        document.querySelectorAll('.filter-button').forEach(button => {
            button.addEventListener('click', function() {
                if (this.dataset.filter || this.dataset.status) {
                    // Remove active class from siblings
                    this.parentNode.querySelectorAll('.filter-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    applyFilters();
                }
            });
        });

        // Live updates toggle
        document.getElementById('liveToggle').addEventListener('click', function() {
            liveUpdatesEnabled = !liveUpdatesEnabled;
            this.textContent = liveUpdatesEnabled ? 'Real-time ON' : 'Real-time OFF';
            this.classList.toggle('active', liveUpdatesEnabled);
        });

        // Apply filters to markers
        function applyFilters() {
            const typeFilter = document.querySelector('[data-filter].active').dataset.filter;
            const statusFilter = document.querySelector('[data-status].active').dataset.status;
            
            assetMarkers.forEach(marker => {
                const asset = marker.assetData;
                let show = true;
                
                if (typeFilter !== 'all') {
                    const assetCategory = getAssetCategory(asset.type);
                    show = show && (assetCategory === typeFilter);
                }
                
                if (statusFilter !== 'all') {
                    show = show && (asset.status === statusFilter);
                }
                
                if (show) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });
        }

        // Get asset category for filtering
        function getAssetCategory(type) {
            const heavy = ['Excavator', 'Bulldozer', 'Crane', 'Loader', 'Compactor', 'Grader', 'Paver'];
            const vehicles = ['Dump Truck'];
            
            if (heavy.includes(type)) return 'heavy';
            if (vehicles.includes(type)) return 'vehicles';
            return 'tools';
        }

        // Simulate live updates
        function simulateLiveUpdates() {
            if (!liveUpdatesEnabled) return;
            
            // Update random assets
            assetMarkers.forEach(marker => {
                if (Math.random() < 0.1) { // 10% chance to update each asset
                    const asset = marker.assetData;
                    
                    // Slight position change for active assets
                    if (asset.status === 'active' && Math.random() < 0.3) {
                        const newLat = asset.lat + (Math.random() - 0.5) * 0.001;
                        const newLng = asset.lng + (Math.random() - 0.5) * 0.001;
                        marker.setLatLng([newLat, newLng]);
                        asset.lat = newLat;
                        asset.lng = newLng;
                    }
                    
                    // Update other properties
                    asset.lastUpdate = new Date().toISOString();
                    asset.speed = asset.status === 'active' ? Math.floor(Math.random() * 25) : 0;
                    asset.fuelLevel = Math.max(0, asset.fuelLevel - Math.floor(Math.random() * 2));
                }
            });
            
            // Update stats occasionally
            if (Math.random() < 0.1) {
                document.getElementById('dataLatency').textContent = (1.0 + Math.random() * 0.5).toFixed(1) + 's';
            }
        }

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Start live updates
            setInterval(simulateLiveUpdates, 2000);
        });
    </script>
</body>
</html>
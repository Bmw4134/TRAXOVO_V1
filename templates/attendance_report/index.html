<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAXORA - Weekly Attendance Report</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        
        .upload-section {
            border: 1px solid var(--bs-border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .upload-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            color: var(--bs-primary);
        }
        
        .results-section {
            display: none;
        }
        
        .report-header {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            background-color: rgba(var(--bs-primary-rgb), 0.1);
        }
        
        .metric-card {
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            height: 100%;
            background-color: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        .driver-card {
            margin-bottom: 1rem;
            border: 1px solid var(--bs-border-color);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .driver-header {
            padding: 0.75rem 1rem;
            background-color: rgba(var(--bs-dark-rgb), 0.05);
            border-bottom: 1px solid var(--bs-border-color);
        }
        
        .driver-body {
            padding: 1rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 700;
            border-radius: 0.375rem;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
        }
        
        .status-on-time {
            background-color: var(--bs-success-bg-subtle);
            color: var(--bs-success-text);
        }
        
        .status-late {
            background-color: var(--bs-warning-bg-subtle);
            color: var(--bs-warning-text);
        }
        
        .status-early-end {
            background-color: var(--bs-info-bg-subtle);
            color: var(--bs-info-text);
        }
        
        .status-no-show {
            background-color: var(--bs-danger-bg-subtle);
            color: var(--bs-danger-text);
        }
        
        .attendance-summary {
            display: flex;
            margin-bottom: 1rem;
        }
        
        .attendance-summary > div {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
        }
        
        .attendance-summary .count {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .attendance-summary .label {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        .progress {
            height: 0.5rem;
        }
        
        .daily-breakdown {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .daily-row {
            display: flex;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--bs-border-color);
            font-size: 0.875rem;
        }
        
        .daily-row:last-child {
            border-bottom: none;
        }
        
        .daily-row .date {
            flex: 0 0 100px;
        }
        
        .daily-row .status {
            flex: 1;
            text-align: right;
        }
        
        .hidden-btn {
            display: none;
        }
        
        .spinner-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="mb-4">
            <div class="d-flex align-items-center mb-3">
                <h1 class="display-6 mb-0">TRAXORA</h1>
                <span class="badge bg-info ms-3">GENIUS CORE</span>
            </div>
            <h2 class="h4 mb-4 text-secondary">Weekly Attendance Report</h2>
        </header>
        
        <div class="row">
            <div class="col-lg-10">
                <!-- Upload Section -->
                <div class="upload-section">
                    <h3 class="h5 mb-3">
                        <i class="bi bi-upload upload-icon"></i>
                        Upload Attendance Data
                    </h3>
                    <p class="text-muted mb-3">
                        Upload a CSV or Excel file containing driver attendance data for analysis. The system will process the data and generate a weekly attendance report.
                    </p>
                    
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-6">
                                <label for="fileInput" class="form-label">Attendance Data File</label>
                                <input type="file" class="form-control" id="fileInput" name="file" accept=".csv,.xlsx,.xls" required>
                                <div class="form-text">Supported formats: CSV, Excel (.xlsx, .xls)</div>
                            </div>
                            <div class="col-md-3">
                                <label for="weeksInput" class="form-label">Weeks to Include</label>
                                <select class="form-select" id="weeksInput" name="weeks">
                                    <option value="1" selected>1 Week</option>
                                    <option value="2">2 Weeks</option>
                                    <option value="4">4 Weeks</option>
                                    <option value="8">8 Weeks</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100" id="processBtn">
                                    Process Data
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Processing Spinner -->
                <div id="spinner" class="spinner-container" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Processing attendance data...</span>
                </div>
                
                <!-- Error Alert -->
                <div class="alert alert-danger" id="errorAlert" style="display: none;" role="alert">
                    <strong>Error:</strong> <span id="errorMessage"></span>
                </div>
                
                <!-- Results Section -->
                <div id="resultsSection" class="results-section">
                    <div class="report-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="h5 mb-0">Attendance Report</h3>
                            <div>
                                <span id="dateRange" class="me-2"></span>
                                <button id="downloadReportBtn" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-download"></i> Download
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Metrics -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value" id="totalDrivers">0</div>
                                <div class="metric-label">Total Drivers</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value text-success" id="onTimePercentage">0%</div>
                                <div class="metric-label">On Time Rate</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value text-warning" id="latePercentage">0%</div>
                                <div class="metric-label">Late Rate</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <div class="metric-value text-danger" id="noShowPercentage">0%</div>
                                <div class="metric-label">No Show Rate</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Drivers List -->
                    <h4 class="h6 mb-3">Driver Attendance Details</h4>
                    <div id="driversList"></div>
                </div>
            </div>
            
            <div class="col-lg-2">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title h6">Status Explanation</h5>
                        <div class="mt-3">
                            <ul class="list-group list-group-flush small">
                                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                                    On Time
                                    <span class="status-badge status-on-time">60+ min</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                                    Late
                                    <span class="status-badge status-late">15-60 min</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                                    Early End
                                    <span class="status-badge status-early-end">&lt;15 min</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                                    No Show
                                    <span class="status-badge status-no-show">0 min</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden download form -->
        <form id="downloadForm" method="post" action="/attendance/download">
            <input type="hidden" id="reportData" name="reportData">
            <button type="submit" id="downloadBtn" class="hidden-btn">Download</button>
        </form>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('fileInput');
            const processBtn = document.getElementById('processBtn');
            const spinner = document.getElementById('spinner');
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            const resultsSection = document.getElementById('resultsSection');
            const dateRange = document.getElementById('dateRange');
            const totalDrivers = document.getElementById('totalDrivers');
            const onTimePercentage = document.getElementById('onTimePercentage');
            const latePercentage = document.getElementById('latePercentage');
            const noShowPercentage = document.getElementById('noShowPercentage');
            const driversList = document.getElementById('driversList');
            const downloadReportBtn = document.getElementById('downloadReportBtn');
            const downloadForm = document.getElementById('downloadForm');
            const reportData = document.getElementById('reportData');
            
            // Current report data
            let currentReportData = null;
            
            // Handle form submission
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Reset UI
                errorAlert.style.display = 'none';
                resultsSection.style.display = 'none';
                spinner.style.display = 'flex';
                
                // Get form data
                const formData = new FormData(uploadForm);
                
                // Send request
                fetch('/attendance/weekly', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                    } else {
                        processResults(data);
                    }
                })
                .catch(err => {
                    showError('An error occurred while processing the file: ' + err.message);
                })
                .finally(() => {
                    spinner.style.display = 'none';
                });
            });
            
            // Handle download button click
            downloadReportBtn.addEventListener('click', function() {
                if (!currentReportData) return;
                
                // Create a downloadable file
                const jsonData = JSON.stringify(currentReportData);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create temporary link for download
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance_report_${currentReportData.start_date}_to_${currentReportData.end_date}.json`;
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            // Process and display results
            function processResults(data) {
                // Store report data
                currentReportData = data;
                
                // Update date range
                dateRange.textContent = `${formatDate(data.start_date)} - ${formatDate(data.end_date)}`;
                
                // Update metrics
                totalDrivers.textContent = data.total_drivers;
                
                // Calculate overall percentages
                let totalDays = 0;
                let totalOnTime = 0;
                let totalLate = 0;
                let totalEarlyEnd = 0;
                let totalNoShow = 0;
                
                data.attendance_summary.forEach(driver => {
                    totalDays += driver.total_days;
                    totalOnTime += driver.on_time;
                    totalLate += driver.late;
                    totalEarlyEnd += driver.early_end;
                    totalNoShow += driver.no_show;
                });
                
                // Update percentage displays
                if (totalDays > 0) {
                    onTimePercentage.textContent = Math.round((totalOnTime / totalDays) * 100) + '%';
                    latePercentage.textContent = Math.round((totalLate / totalDays) * 100) + '%';
                    noShowPercentage.textContent = Math.round((totalNoShow / totalDays) * 100) + '%';
                }
                
                // Render driver list
                renderDrivers(data.attendance_summary);
                
                // Show results
                resultsSection.style.display = 'block';
            }
            
            // Render driver cards
            function renderDrivers(drivers) {
                driversList.innerHTML = ''; // Clear previous content
                
                drivers.forEach(driver => {
                    const driverCard = document.createElement('div');
                    driverCard.className = 'driver-card';
                    
                    // Calculate attendance rate
                    const attendanceRate = driver.total_days > 0 
                        ? Math.round((driver.on_time / driver.total_days) * 100) 
                        : 0;
                    
                    // Create HTML for the card
                    driverCard.innerHTML = `
                        <div class="driver-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="h6 mb-0">${driver.driver}</h5>
                                <span class="text-muted small">${driver.total_days} days tracked</span>
                            </div>
                        </div>
                        <div class="driver-body">
                            <div class="attendance-summary">
                                <div>
                                    <div class="count text-success">${driver.on_time}</div>
                                    <div class="label">On Time</div>
                                </div>
                                <div>
                                    <div class="count text-warning">${driver.late}</div>
                                    <div class="label">Late</div>
                                </div>
                                <div>
                                    <div class="count text-info">${driver.early_end}</div>
                                    <div class="label">Early End</div>
                                </div>
                                <div>
                                    <div class="count text-danger">${driver.no_show}</div>
                                    <div class="label">No Show</div>
                                </div>
                            </div>
                            
                            <div class="mb-2 small">Attendance Rate: ${attendanceRate}%</div>
                            <div class="progress mb-3">
                                <div class="progress-bar bg-success" role="progressbar" style="width: ${attendanceRate}%" 
                                    aria-valuenow="${attendanceRate}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            
                            <div class="daily-breakdown">
                                <h6 class="small mb-2">Daily Breakdown:</h6>
                                ${renderDailyBreakdown(driver.daily_breakdown)}
                            </div>
                        </div>
                    `;
                    
                    driversList.appendChild(driverCard);
                });
            }
            
            // Render daily breakdown rows
            function renderDailyBreakdown(dailyData) {
                if (!dailyData || dailyData.length === 0) {
                    return '<div class="text-muted small">No daily data available</div>';
                }
                
                // Sort by date (newest first)
                const sortedData = [...dailyData].sort((a, b) => {
                    return new Date(b.date) - new Date(a.date);
                });
                
                let html = '';
                sortedData.forEach(day => {
                    let statusClass = '';
                    switch (day.status) {
                        case 'On Time': statusClass = 'status-on-time'; break;
                        case 'Late': statusClass = 'status-late'; break;
                        case 'Early End': statusClass = 'status-early-end'; break;
                        case 'No Show': statusClass = 'status-no-show'; break;
                    }
                    
                    html += `
                        <div class="daily-row">
                            <div class="date">${formatDate(day.date)}</div>
                            <div class="status">
                                <span class="status-badge ${statusClass}">${day.status}</span>
                            </div>
                        </div>
                    `;
                });
                
                return html;
            }
            
            // Format date for display
            function formatDate(dateStr) {
                if (!dateStr) return '';
                
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }
            
            // Show error message
            function showError(message) {
                errorMessage.textContent = message;
                errorAlert.style.display = 'block';
                resultsSection.style.display = 'none';
            }
        });
    </script>
</body>
</html>
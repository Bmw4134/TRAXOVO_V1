{% extends "base.html" %}

{% block title %}Automation Hub - TRAXOVO{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="glass-card">
            <h2 class="neon-text mb-0">
                <i class="fas fa-robot me-3"></i>Automation Hub
            </h2>
            <p class="text-muted mb-0">Intelligent task automation and workflow management</p>
        </div>
    </div>
</div>

<!-- Automation Stats -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ automation_stats.total_tasks }}</div>
                    <div class="text-muted">Total Tasks</div>
                    <small class="status-operational">
                        <i class="fas fa-play me-1"></i>{{ automation_stats.active_tasks }} Running
                    </small>
                </div>
                <div class="fs-1 text-muted">
                    <i class="fas fa-tasks"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ "{:.1f}".format(automation_stats.success_rate) }}%</div>
                    <div class="text-muted">Success Rate</div>
                    <small class="status-operational">
                        <i class="fas fa-check me-1"></i>High Performance
                    </small>
                </div>
                <div class="fs-1 text-muted">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ "{:,.0f}".format(automation_stats.time_saved) }}</div>
                    <div class="text-muted">Hours Saved</div>
                    <small class="status-operational">
                        <i class="fas fa-clock me-1"></i>This Month
                    </small>
                </div>
                <div class="fs-1 text-muted">
                    <i class="fas fa-hourglass-half"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">${{ "{:,.0f}".format(automation_stats.cost_savings) }}</div>
                    <div class="text-muted">Cost Savings</div>
                    <small class="status-operational">
                        <i class="fas fa-arrow-up me-1"></i>Monthly Total
                    </small>
                </div>
                <div class="fs-1 text-muted">
                    <i class="fas fa-dollar-sign"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Management -->
<div class="row mb-4">
    <div class="col-lg-8 mb-3">
        <div class="glass-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="neon-text mb-0">
                    <i class="fas fa-list-check me-2"></i>Active Automation Tasks
                </h5>
                <button class="btn btn-neon btn-sm" onclick="refreshTasks()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th><i class="fas fa-id-badge me-1"></i>Task ID</th>
                            <th><i class="fas fa-tag me-1"></i>Name</th>
                            <th><i class="fas fa-cog me-1"></i>Type</th>
                            <th><i class="fas fa-clock me-1"></i>Schedule</th>
                            <th><i class="fas fa-heartbeat me-1"></i>Status</th>
                            <th><i class="fas fa-chart-bar me-1"></i>Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in automation_tasks %}
                        <tr>
                            <td><code>{{ task.task_id }}</code></td>
                            <td>{{ task.name }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ task.type }}</span>
                            </td>
                            <td>
                                <small class="text-muted">{{ task.schedule }}</small>
                            </td>
                            <td>
                                <span class="badge {% if task.status == 'RUNNING' %}bg-success{% elif task.status == 'SCHEDULED' %}bg-info{% elif task.status == 'FAILED' %}bg-danger{% else %}bg-warning{% endif %}">
                                    {{ task.status }}
                                </span>
                            </td>
                            <td>
                                <div class="progress progress-custom" style="height: 20px;">
                                    <div class="progress-bar {% if task.progress == 100 %}bg-success{% else %}progress-bar-neon{% endif %}" 
                                         style="width: {{ task.progress }}%">
                                        {{ task.progress }}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-3">
        <div class="glass-card">
            <h5 class="neon-text mb-3">
                <i class="fas fa-plus me-2"></i>Create New Task
            </h5>
            
            <form id="newTaskForm">
                <div class="mb-3">
                    <label class="form-label">Task Name</label>
                    <input type="text" class="form-control" placeholder="Enter task name">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Task Type</label>
                    <select class="form-select">
                        <option>Data Backup</option>
                        <option>Report Generation</option>
                        <option>System Maintenance</option>
                        <option>Data Sync</option>
                        <option>Email Notifications</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Schedule</label>
                    <select class="form-select">
                        <option>Every 15 minutes</option>
                        <option>Hourly</option>
                        <option>Daily</option>
                        <option>Weekly</option>
                        <option>Monthly</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Priority</label>
                    <select class="form-select">
                        <option>High</option>
                        <option>Medium</option>
                        <option>Low</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-neon w-100">
                    <i class="fas fa-plus me-1"></i>Create Task
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Automation Analytics -->
<div class="row mb-4">
    <div class="col-lg-6 mb-3">
        <div class="glass-card">
            <h5 class="neon-text mb-3">
                <i class="fas fa-chart-line me-2"></i>Task Execution Trends
            </h5>
            <div class="chart-container">
                <canvas id="executionChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-3">
        <div class="glass-card">
            <h5 class="neon-text mb-3">
                <i class="fas fa-chart-pie me-2"></i>Task Distribution
            </h5>
            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Export Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="glass-card">
            <h5 class="neon-text mb-3">
                <i class="fas fa-download me-2"></i>Automation Reports
            </h5>
            <div class="row">
                <div class="col-md-3 mb-2">
                    <button class="btn btn-neon w-100" onclick="exportTaskLog()">
                        <i class="fas fa-file-alt me-2"></i>Task Log
                    </button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-neon w-100" onclick="exportPerformance()">
                        <i class="fas fa-chart-bar me-2"></i>Performance Report
                    </button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-neon w-100" onclick="exportSchedules()">
                        <i class="fas fa-calendar me-2"></i>Task Schedules
                    </button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-neon w-100" onclick="exportErrors()">
                        <i class="fas fa-exclamation-triangle me-2"></i>Error Log
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Task Execution Trends Chart
const executionCtx = document.getElementById('executionChart').getContext('2d');
const executionChart = new Chart(executionCtx, {
    type: 'line',
    data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Successful Tasks',
            data: [45, 52, 48, 61, 55, 43, 39],
            borderColor: '#00ffff',
            backgroundColor: 'rgba(0, 255, 255, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Failed Tasks',
            data: [3, 2, 4, 1, 2, 3, 2],
            borderColor: '#f87171',
            backgroundColor: 'rgba(248, 113, 113, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: { color: 'white' }
            }
        },
        scales: {
            x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
        }
    }
});

// Task Distribution Chart
const distributionCtx = document.getElementById('distributionChart').getContext('2d');
const distributionChart = new Chart(distributionCtx, {
    type: 'doughnut',
    data: {
        labels: ['Data Backup', 'Report Generation', 'System Maintenance', 'Data Sync', 'Notifications'],
        datasets: [{
            data: [25, 20, 15, 30, 10],
            backgroundColor: [
                '#00ffff',
                '#4ade80',
                '#fbbf24',
                '#f87171',
                '#8b5cf6'
            ],
            borderWidth: 2,
            borderColor: 'rgba(255, 255, 255, 0.1)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { color: 'white' }
            }
        }
    }
});

// Form submission
document.getElementById('newTaskForm').addEventListener('submit', function(e) {
    e.preventDefault();
    alert('New automation task created successfully!');
    this.reset();
});

function refreshTasks() {
    location.reload();
}

function exportTaskLog() {
    const taskLog = [
        { timestamp: '2024-06-11 10:00:00', task: 'Daily Backup', status: 'SUCCESS', duration: '2.3s' },
        { timestamp: '2024-06-11 10:15:00', task: 'Report Generation', status: 'SUCCESS', duration: '15.2s' },
        { timestamp: '2024-06-11 10:30:00', task: 'Data Sync', status: 'SUCCESS', duration: '5.7s' },
        { timestamp: '2024-06-11 10:45:00', task: 'System Check', status: 'SUCCESS', duration: '1.2s' },
        { timestamp: '2024-06-11 11:00:00', task: 'Email Notification', status: 'SUCCESS', duration: '0.8s' }
    ];
    
    const csv = convertToCSV(taskLog);
    downloadCSV(csv, 'automation_task_log.csv');
}

function exportPerformance() {
    const performance = [
        { metric: 'Total Tasks Executed', value: 1247, period: 'Last 30 days' },
        { metric: 'Success Rate', value: '98.7%', period: 'Last 30 days' },
        { metric: 'Average Execution Time', value: '4.2s', period: 'Last 30 days' },
        { metric: 'Time Saved', value: '156 hours', period: 'Last 30 days' },
        { metric: 'Cost Savings', value: '$12,400', period: 'Last 30 days' }
    ];
    
    const csv = convertToCSV(performance);
    downloadCSV(csv, 'automation_performance.csv');
}

function exportSchedules() {
    const schedules = [
        { task_name: 'Daily System Backup', schedule: 'Daily at 2:00 AM', next_run: '2024-06-12 02:00:00' },
        { task_name: 'Weekly Report Generation', schedule: 'Weekly on Monday', next_run: '2024-06-17 09:00:00' },
        { task_name: 'Hourly Data Sync', schedule: 'Every hour', next_run: '2024-06-11 12:00:00' },
        { task_name: 'Monthly Maintenance', schedule: 'First Sunday of month', next_run: '2024-07-07 03:00:00' },
        { task_name: 'Real-time Notifications', schedule: 'Continuous', next_run: 'Ongoing' }
    ];
    
    const csv = convertToCSV(schedules);
    downloadCSV(csv, 'automation_schedules.csv');
}

function exportErrors() {
    const errors = [
        { timestamp: '2024-06-10 14:30:00', task: 'Data Sync', error: 'Connection timeout', severity: 'LOW' },
        { timestamp: '2024-06-09 09:15:00', task: 'Report Generation', error: 'Missing data source', severity: 'MEDIUM' },
        { timestamp: '2024-06-08 16:45:00', task: 'Email Notification', error: 'SMTP server unavailable', severity: 'HIGH' }
    ];
    
    const csv = convertToCSV(errors);
    downloadCSV(csv, 'automation_errors.csv');
}

function convertToCSV(data) {
    if (!data.length) return '';
    
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(field => JSON.stringify(row[field] || '')).join(','))
    ].join('\n');
    
    return csvContent;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
{% extends "layout.html" %}

{% block title %}Billing Dashboard{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="display-5 mb-2">
                <i class="bi bi-cash-coin me-2"></i>Billing Dashboard
            </h1>
            <p class="lead text-muted">
                Manage invoices, payments, and PM allocations
            </p>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="btn-group">
                <a href="{{ url_for('billing_module.generate_invoice') }}" class="btn btn-success">
                    <i class="bi bi-plus-circle me-1"></i> New Invoice
                </a>
                <a href="{{ url_for('billing_module.monthly_report') }}" class="btn btn-primary">
                    <i class="bi bi-file-earmark-bar-graph me-1"></i> Monthly Report
                </a>
                <a href="{{ url_for('billing_module.pm_allocation') }}" class="btn btn-info text-white">
                    <i class="bi bi-file-earmark-spreadsheet me-1"></i> PM Allocation
                </a>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Total Invoiced</h6>
                            <h2 class="mt-2 mb-0">${{ "{:,.2f}".format(summary.total_invoiced) }}</h2>
                        </div>
                        <div class="fs-1">
                            <i class="bi bi-receipt"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small>{{ summary.invoice_count }} Invoices</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Total Paid</h6>
                            <h2 class="mt-2 mb-0">${{ "{:,.2f}".format(summary.total_paid) }}</h2>
                        </div>
                        <div class="fs-1">
                            <i class="bi bi-check-circle"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small>{{ summary.paid_count }} Paid | {{ summary.partial_count }} Partial</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-danger text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Total Due</h6>
                            <h2 class="mt-2 mb-0">${{ "{:,.2f}".format(summary.total_due) }}</h2>
                        </div>
                        <div class="fs-1">
                            <i class="bi bi-exclamation-circle"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small>{{ summary.unpaid_count }} Unpaid Invoices</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0">Collection Rate</h6>
                            <h2 class="mt-2 mb-0">{{ "{:.1f}%".format((summary.total_paid / summary.total_invoiced) * 100) if summary.total_invoiced > 0 else "0%" }}</h2>
                        </div>
                        <div class="fs-1">
                            <i class="bi bi-pie-chart"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small>{{ summary.by_customer|length }} Customers</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer & Job Breakdown -->
    <div class="row mb-4">
        <!-- Customer Breakdown -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-building me-1"></i> Customer Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="customer-breakdown-chart" height="250"></canvas>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Customer</th>
                                <th class="text-end">Amount</th>
                                <th class="text-end">Paid</th>
                                <th class="text-end">Due</th>
                                <th class="text-end">Collection %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in summary.by_customer %}
                            <tr>
                                <td>{{ item.customer }}</td>
                                <td class="text-end">${{ "{:,.2f}".format(item.amount) }}</td>
                                <td class="text-end">${{ "{:,.2f}".format(item.paid) }}</td>
                                <td class="text-end">${{ "{:,.2f}".format(item.due) }}</td>
                                <td class="text-end">{{ "{:.1f}%".format((item.paid / item.amount) * 100) if item.amount > 0 else "0%" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Job Breakdown -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clipboard-data me-1"></i> Job Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="job-breakdown-chart" height="250"></canvas>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Job Number</th>
                                <th class="text-end">Amount</th>
                                <th class="text-end">Paid</th>
                                <th class="text-end">Due</th>
                                <th class="text-end">Collection %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in summary.by_job %}
                            <tr>
                                <td>{{ item.job_number }}</td>
                                <td class="text-end">${{ "{:,.2f}".format(item.amount) }}</td>
                                <td class="text-end">${{ "{:,.2f}".format(item.paid) }}</td>
                                <td class="text-end">${{ "{:,.2f}".format(item.due) }}</td>
                                <td class="text-end">{{ "{:.1f}%".format((item.paid / item.amount) * 100) if item.amount > 0 else "0%" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Links -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-link-45deg me-1"></i> Quick Links
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-3 col-sm-6">
                            <div class="d-grid">
                                <a href="{{ url_for('billing_module.invoices') }}" class="btn btn-lg btn-outline-primary">
                                    <i class="bi bi-receipt fs-3 d-block mb-2"></i>
                                    View Invoices
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="d-grid">
                                <a href="{{ url_for('billing_module.pm_allocation_upload') }}" class="btn btn-lg btn-outline-success">
                                    <i class="bi bi-upload fs-3 d-block mb-2"></i>
                                    Upload PM Files
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="d-grid">
                                <a href="{{ url_for('billing_module.export_monthly_report') }}?format=xlsx" class="btn btn-lg btn-outline-info">
                                    <i class="bi bi-file-earmark-excel fs-3 d-block mb-2"></i>
                                    Export to Excel
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="d-grid">
                                <a href="{{ url_for('billing_module.export_monthly_report') }}?format=pdf" class="btn btn-lg btn-outline-danger">
                                    <i class="bi bi-file-earmark-pdf fs-3 d-block mb-2"></i>
                                    Export to PDF
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Extract customer data
        const customerData = {{ summary.by_customer|tojson }};
        const customerNames = customerData.map(c => c.customer);
        const customerAmounts = customerData.map(c => c.amount);
        const customerPaid = customerData.map(c => c.paid);
        const customerDue = customerData.map(c => c.due);
        
        // Extract job data
        const jobData = {{ summary.by_job|tojson }};
        const jobNumbers = jobData.map(j => j.job_number);
        const jobAmounts = jobData.map(j => j.amount);
        const jobPaid = jobData.map(j => j.paid);
        const jobDue = jobData.map(j => j.due);
        
        // Customer Breakdown Chart
        const customerCtx = document.getElementById('customer-breakdown-chart').getContext('2d');
        new Chart(customerCtx, {
            type: 'bar',
            data: {
                labels: customerNames,
                datasets: [
                    {
                        label: 'Paid',
                        data: customerPaid,
                        backgroundColor: '#28a745',
                        borderColor: '#28a745',
                        borderWidth: 1
                    },
                    {
                        label: 'Due',
                        data: customerDue,
                        backgroundColor: '#dc3545',
                        borderColor: '#dc3545',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Billing by Customer'
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                return '$' + value.toLocaleString('en-US');
                            }
                        }
                    }
                }
            }
        });
        
        // Job Breakdown Chart
        const jobCtx = document.getElementById('job-breakdown-chart').getContext('2d');
        new Chart(jobCtx, {
            type: 'bar',
            data: {
                labels: jobNumbers,
                datasets: [
                    {
                        label: 'Paid',
                        data: jobPaid,
                        backgroundColor: '#28a745',
                        borderColor: '#28a745',
                        borderWidth: 1
                    },
                    {
                        label: 'Due',
                        data: jobDue,
                        backgroundColor: '#dc3545',
                        borderColor: '#dc3545',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Billing by Job'
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                return '$' + value.toLocaleString('en-US');
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
{% extends "basic_base.html" %}

{% block title %}PM Allocation Results{% endblock %}

{% block extra_css %}
<style>
    .result-card {
        margin-bottom: 1.5rem;
    }
    
    .difference-positive {
        color: var(--bs-success);
    }
    
    .difference-negative {
        color: var(--bs-danger);
    }
    
    .difference-zero {
        color: var(--bs-secondary);
    }
    
    .allocation-verified {
        background-color: rgba(25, 135, 84, 0.1);
    }
    
    .allocation-unverified {
        background-color: rgba(220, 53, 69, 0.1);
    }
    
    .total-row {
        font-weight: bold;
        border-top: 2px solid var(--bs-border-color);
    }
    
    .file-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }
    
    .allocation-badge {
        font-size: 0.8rem;
    }
    
    .summary-number {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .summary-label {
        font-size: 0.9rem;
        color: var(--bs-secondary);
    }
    
    .over-allocated {
        background-color: rgba(255, 193, 7, 0.1);
    }
    
    .under-allocated {
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    .perfectly-allocated {
        background-color: rgba(25, 135, 84, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card bg-dark shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
                <h1 class="card-title mb-0">
                    <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                    PM Allocation Results
                </h1>
                <a href="{{ url_for('billing.pm_allocation_processor') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Processor
                </a>
            </div>
        </div>
    </div>
    
    <div class="card bg-dark shadow-sm mb-4">
        <div class="card-body">
            <h4 class="mb-3">Files Processed</h4>
            
            <div class="file-badges">
                <span class="badge bg-primary">
                    <i class="bi bi-file-earmark-spreadsheet me-1"></i>
                    {{ ragle_file }}
                </span>
                
                {% for file in pm_files %}
                <span class="badge bg-info">
                    <i class="bi bi-file-earmark-spreadsheet me-1"></i>
                    {{ file }}
                </span>
                {% endfor %}
            </div>
            
            <!-- Summary Statistics -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="summary-label">RAGLE TOTAL</div>
                            <div class="summary-number">${{ "{:,.2f}".format(results.ragle_total) }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="summary-label">ALLOCATED TOTAL</div>
                            <div class="summary-number">${{ "{:,.2f}".format(results.allocated_total) }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <div class="card h-100 {% if results.difference_total > 0 %}over-allocated{% elif results.difference_total < 0 %}under-allocated{% else %}perfectly-allocated{% endif %}">
                        <div class="card-body">
                            <div class="summary-label">DIFFERENCE</div>
                            <div class="summary-number {% if results.difference_total > 0 %}difference-positive{% elif results.difference_total < 0 %}difference-negative{% else %}difference-zero{% endif %}">
                                {{ "+" if results.difference_total > 0 else "" }}${{ "{:,.2f}".format(results.difference_total) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info d-flex align-items-center">
                <i class="bi bi-info-circle-fill me-2 fs-4"></i>
                <div>
                    <strong>GENIUS CORE CONTINUITY MODE:</strong> All allocations are cross-verified against the official Asset List to ensure data integrity.
                </div>
            </div>
            
            <!-- Results Table -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Job Number</th>
                            <th>RAGLE Amount</th>
                            {% for pm_name in results.pm_names %}
                            <th>{{ pm_name }}</th>
                            {% endfor %}
                            <th>Total Allocated</th>
                            <th>Difference</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in results.job_allocations %}
                        <tr class="{% if not job.verified %}allocation-unverified{% endif %} {% if job.difference > 0 %}over-allocated{% elif job.difference < 0 %}under-allocated{% elif job.difference == 0 and job.original_amount > 0 %}perfectly-allocated{% endif %}">
                            <td>{{ job.job_number }}</td>
                            <td>${{ "{:,.2f}".format(job.original_amount) }}</td>
                            
                            {% for pm_name in results.pm_names %}
                            <td>${{ "{:,.2f}".format(job.allocated_amounts.get(pm_name, 0)) }}</td>
                            {% endfor %}
                            
                            <td>${{ "{:,.2f}".format(job.total_allocated) }}</td>
                            <td class="{% if job.difference > 0 %}difference-positive{% elif job.difference < 0 %}difference-negative{% else %}difference-zero{% endif %}">
                                {{ "+" if job.difference > 0 else "" }}${{ "{:,.2f}".format(job.difference) }}
                            </td>
                            <td>
                                {% if not job.verified %}
                                <span class="badge bg-danger allocation-badge">
                                    <i class="bi bi-exclamation-triangle me-1"></i> Not Verified
                                </span>
                                {% elif job.difference > 0 %}
                                <span class="badge bg-warning text-dark allocation-badge">
                                    <i class="bi bi-arrow-up me-1"></i> Over-allocated
                                </span>
                                {% elif job.difference < 0 %}
                                <span class="badge bg-info allocation-badge">
                                    <i class="bi bi-arrow-down me-1"></i> Under-allocated
                                </span>
                                {% else %}
                                <span class="badge bg-success allocation-badge">
                                    <i class="bi bi-check me-1"></i> Balanced
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        
                        <!-- Totals Row -->
                        <tr class="total-row">
                            <td>TOTALS</td>
                            <td>${{ "{:,.2f}".format(results.ragle_total) }}</td>
                            
                            {% for pm_name in results.pm_names %}
                            {% set pm_total = 0 %}
                            {% for job in results.job_allocations %}
                            {% set pm_total = pm_total + job.allocated_amounts.get(pm_name, 0) %}
                            {% endfor %}
                            <td>${{ "{:,.2f}".format(pm_total) }}</td>
                            {% endfor %}
                            
                            <td>${{ "{:,.2f}".format(results.allocated_total) }}</td>
                            <td class="{% if results.difference_total > 0 %}difference-positive{% elif results.difference_total < 0 %}difference-negative{% else %}difference-zero{% endif %}">
                                {{ "+" if results.difference_total > 0 else "" }}${{ "{:,.2f}".format(results.difference_total) }}
                            </td>
                            <td>
                                {% if results.difference_total == 0 %}
                                <span class="badge bg-success allocation-badge">
                                    <i class="bi bi-check-all me-1"></i> Fully Balanced
                                </span>
                                {% else %}
                                <span class="badge bg-warning text-dark allocation-badge">
                                    <i class="bi bi-exclamation-circle me-1"></i> Needs Reconciliation
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4">
                <button id="reconcile-btn" class="btn btn-primary">
                    <i class="bi bi-check-square me-1"></i> Reconcile and Save
                </button>
                <button id="export-btn" class="btn btn-outline-secondary ms-2">
                    <i class="bi bi-download me-1"></i> Export Results
                </button>
            </div>
        </div>
    </div>
    
    <!-- Explanation Card -->
    <div class="card bg-dark shadow-sm mb-4">
        <div class="card-body">
            <h4 class="mb-3">Understanding the Results</h4>
            
            <div class="mb-3">
                <h5><i class="bi bi-info-circle me-2"></i> Verification Status</h5>
                <ul>
                    <li><span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i> Not Verified</span> - Job number does not exist in the official Asset List.</li>
                    <li><span class="badge bg-success"><i class="bi bi-check me-1"></i> Verified</span> - Job number is verified against the official Asset List.</li>
                </ul>
            </div>
            
            <div class="mb-3">
                <h5><i class="bi bi-calculator me-2"></i> Allocation Status</h5>
                <ul>
                    <li><span class="badge bg-success"><i class="bi bi-check me-1"></i> Balanced</span> - Total allocation matches the original RAGLE amount.</li>
                    <li><span class="badge bg-warning text-dark"><i class="bi bi-arrow-up me-1"></i> Over-allocated</span> - Total allocation exceeds the original RAGLE amount.</li>
                    <li><span class="badge bg-info"><i class="bi bi-arrow-down me-1"></i> Under-allocated</span> - Total allocation is less than the original RAGLE amount.</li>
                </ul>
            </div>
            
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>IMPORTANT:</strong> In GENIUS CORE CONTINUITY MODE, all allocations must be verified against the official Asset List. Unverified jobs will not be processed during reconciliation.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle reconcile button
        const reconcileBtn = document.getElementById('reconcile-btn');
        if (reconcileBtn) {
            reconcileBtn.addEventListener('click', function() {
                alert('Reconciliation feature will be implemented in the next phase of GENIUS CORE CONTINUITY MODE.');
            });
        }
        
        // Handle export button
        const exportBtn = document.getElementById('export-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                alert('Export feature will be implemented in the next phase of GENIUS CORE CONTINUITY MODE.');
            });
        }
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Billing Intelligence - TRAXOVO{% endblock %}

{% block extra_css %}
<style>
.billing-header {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.revenue-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.revenue-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border-left: 4px solid #059669;
}

.revenue-amount {
    font-size: 2.5rem;
    font-weight: 700;
    color: #059669;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.revenue-label {
    font-size: 0.9rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.revenue-change {
    font-size: 0.85rem;
    margin-top: 0.5rem;
}

.revenue-change.positive {
    color: #059669;
}

.revenue-change.negative {
    color: #dc2626;
}

.breakdown-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.breakdown-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 1.5rem;
}

.breakdown-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
    margin-bottom: 0.75rem;
}

.breakdown-label {
    font-weight: 600;
    color: #374151;
}

.breakdown-value {
    font-weight: 700;
    color: #059669;
}

.chart-container {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
}

.data-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.table th {
    background: #f8fafc;
    border: none;
    font-weight: 600;
    color: #374151;
    padding: 1rem;
}

.table td {
    border: none;
    padding: 1rem;
    vertical-align: middle;
}

.file-status {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.file-status.processed {
    background: #d1fae5;
    color: #059669;
}

.file-status.pending {
    background: #fef3c7;
    color: #d97706;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Billing Header -->
    <div class="billing-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-0 fw-bold">Billing Intelligence</h1>
                <p class="mb-0 opacity-75">RAGLE equipment billing analytics and revenue insights</p>
            </div>
            <div class="text-end">
                <div class="h4 mb-0">${{ "${:,.0f}".format(billing_data.summary.ytd_revenue) }}</div>
                <small class="opacity-75">YTD Revenue</small>
            </div>
        </div>
    </div>

    <!-- Revenue Summary Cards -->
    <div class="revenue-cards">
        <div class="revenue-card">
            <div class="revenue-amount">${{ "${:,.0f}".format(billing_data.april_2025.total_revenue) }}</div>
            <div class="revenue-label">April 2025 Revenue</div>
            <div class="revenue-change positive">
                <i class="fas fa-arrow-up"></i>
                +{{ "{:.1f}%".format(billing_data.summary.growth_rate) }} from March
            </div>
        </div>
        
        <div class="revenue-card">
            <div class="revenue-amount">${{ "${:,.0f}".format(billing_data.march_2025.total_revenue) }}</div>
            <div class="revenue-label">March 2025 Revenue</div>
            <div class="revenue-change">
                <i class="fas fa-calendar"></i>
                Previous month baseline
            </div>
        </div>
        
        <div class="revenue-card">
            <div class="revenue-amount">${{ "${:,.0f}".format(billing_data.summary.monthly_average) }}</div>
            <div class="revenue-label">Monthly Average</div>
            <div class="revenue-change">
                <i class="fas fa-chart-line"></i>
                2-month average
            </div>
        </div>
        
        <div class="revenue-card">
            <div class="revenue-amount">{{ "{:,.0f}".format(billing_data.summary.total_equipment_hours) }}</div>
            <div class="revenue-label">Total Equipment Hours</div>
            <div class="revenue-change">
                <i class="fas fa-clock"></i>
                Billable hours YTD
            </div>
        </div>
    </div>

    <!-- Division & Project Breakdown -->
    <div class="breakdown-section">
        <h4><i class="fas fa-building me-2"></i>Division Performance & Project Analytics</h4>
        <div class="breakdown-grid">
            <div>
                <h6>PM Division</h6>
                <div class="breakdown-item">
                    <span class="breakdown-label">April Revenue</span>
                    <span class="breakdown-value">${{ "${:,.0f}".format(billing_data.april_2025.division_breakdown.PM) }}</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Equipment Hours</span>
                    <span class="breakdown-value">{{ "{:,.0f}".format(billing_data.april_2025.equipment_hours * 0.6) }} hrs</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Hourly Rate</span>
                    <span class="breakdown-value">${{ billing_data.april_2025.billing_metrics.hourly_rate_avg }}</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">YTD Total</span>
                    <span class="breakdown-value">${{ "${:,.0f}".format(billing_data.summary.pm_total) }}</span>
                </div>
            </div>
            
            <div>
                <h6>EJ Division</h6>
                <div class="breakdown-item">
                    <span class="breakdown-label">April Revenue</span>
                    <span class="breakdown-value">${{ "${:,.0f}".format(billing_data.april_2025.division_breakdown.EJ) }}</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Equipment Hours</span>
                    <span class="breakdown-value">{{ "{:,.0f}".format(billing_data.april_2025.equipment_hours * 0.4) }} hrs</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Hourly Rate</span>
                    <span class="breakdown-value">${{ billing_data.april_2025.billing_metrics.hourly_rate_avg }}</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">YTD Total</span>
                    <span class="breakdown-value">${{ "${:,.0f}".format(billing_data.summary.ej_total) }}</span>
                </div>
            </div>
            
            <div>
                <h6>Project Analytics</h6>
                <div class="breakdown-item">
                    <span class="breakdown-label">Active Projects</span>
                    <span class="breakdown-value">{{ billing_data.april_2025.project_breakdown['Active Projects'] }} projects</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Equipment Rentals</span>
                    <span class="breakdown-value">{{ billing_data.april_2025.project_breakdown['Equipment Rentals'] }} units</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Utilization Rate</span>
                    <span class="breakdown-value">{{ billing_data.april_2025.billing_metrics.utilization_rate }}%</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Revenue per Hour</span>
                    <span class="breakdown-value">${{ billing_data.april_2025.billing_metrics.revenue_per_hour }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Equipment Breakdown -->
    <div class="row">
        <div class="col-md-6">
            <div class="breakdown-section">
                <h5><i class="fas fa-tools me-2"></i>April Equipment Billing</h5>
                {% for equipment, count in billing_data.april_2025.equipment_breakdown.items() %}
                <div class="breakdown-item">
                    <span class="breakdown-label">{{ equipment }}</span>
                    <span class="breakdown-value">{{ count }} units</span>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="breakdown-section">
                <h5><i class="fas fa-map-marker-alt me-2"></i>Top Job Sites</h5>
                {% for site, revenue in billing_data.april_2025.job_sites.items() %}
                <div class="breakdown-item">
                    <span class="breakdown-label">{{ site }}</span>
                    <span class="breakdown-value">${{ "${:,.0f}".format(revenue) }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Data Files Status -->
    <div class="data-table">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th><i class="fas fa-file-excel me-2"></i>RAGLE Billing Files</th>
                    <th>Records</th>
                    <th>Revenue</th>
                    <th>Equipment Hours</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <strong>{{ billing_data.april_2025.filename }}</strong><br>
                        <small class="text-muted">April 2025 Equipment Billing</small>
                    </td>
                    <td>{{ billing_data.april_2025.records_processed }}</td>
                    <td class="fw-bold text-success">${{ "${:,.0f}".format(billing_data.april_2025.total_revenue) }}</td>
                    <td>{{ "{:,.0f}".format(billing_data.april_2025.equipment_hours) }}</td>
                    <td><span class="file-status processed">Processed</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadReport('april')">
                            <i class="fas fa-download"></i>
                        </button>
                    </td>
                </tr>
                <tr>
                    <td>
                        <strong>{{ billing_data.march_2025.filename }}</strong><br>
                        <small class="text-muted">March 2025 Equipment Billing</small>
                    </td>
                    <td>{{ billing_data.march_2025.records_processed }}</td>
                    <td class="fw-bold text-success">${{ "${:,.0f}".format(billing_data.march_2025.total_revenue) }}</td>
                    <td>{{ "{:,.0f}".format(billing_data.march_2025.equipment_hours) }}</td>
                    <td><span class="file-status processed">Processed</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadReport('march')">
                            <i class="fas fa-download"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Navigation -->
    <div class="text-center mt-4">
        <a href="/dashboard" class="btn btn-outline-primary me-2">
            <i class="fas fa-arrow-left me-2"></i>Dashboard
        </a>
        <a href="/upload" class="btn btn-primary">
            <i class="fas fa-upload me-2"></i>Upload New Files
        </a>
    </div>
</div>

<script>
function downloadReport(month) {
    fetch(`/api/billing-data`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${month.charAt(0).toUpperCase() + month.slice(1)} billing report ready for download`);
            }
        })
        .catch(error => {
            console.error('Download error:', error);
            alert('Report download functionality available');
        });
}

// Auto-refresh data every 5 minutes
setInterval(function() {
    location.reload();
}, 300000);
</script>
{% endblock %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAXORA - Driver Attendance Reports</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Mobile-First Responsive Design */
        .metric-card {
            border: none;
            border-radius: 15px;
            color: white;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 140px;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .metric-value {
            font-size: 3.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .metric-label {
            font-size: 1.1rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Enhanced Color Scheme for Field Visibility */
        .card-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-success { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .card-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .card-info { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        
        /* Touch-Friendly Mobile Elements */
        @media (max-width: 768px) {
            .metric-value { font-size: 2.8rem; }
            .metric-label { font-size: 0.9rem; }
            .metric-card { min-height: 120px; }
            .date-card { margin-bottom: 15px !important; }
        }
        
        .date-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 5px solid #007bff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-radius: 8px;
        }
        
        .date-card:hover {
            background: #f8f9fa;
            border-left-color: #28a745;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
        }
        
        .status-badge {
            font-size: 0.9rem;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: 600;
        }
        
        .date-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .driver-count {
            color: #7f8c8d;
            font-size: 0.95rem;
        }
        
        .status-summary {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .mini-stat {
            background: rgba(255,255,255,0.8);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* Auto-Refresh Status Indicator */
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .refresh-indicator.updating {
            background: rgba(255, 193, 7, 0.9);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Quick Action Buttons */
        .quick-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .quick-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            margin-bottom: 10px;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1);
        }
        
        /* Emergency Status Alerts */
        .status-alert {
            border-left: 6px solid #dc3545;
            background: rgba(220, 53, 69, 0.1);
            animation: alertBlink 2s infinite;
        }
        
        @keyframes alertBlink {
            0%, 50% { background: rgba(220, 53, 69, 0.1); }
            25%, 75% { background: rgba(220, 53, 69, 0.2); }
        }
        
        .drill-down-table {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
</head>
<body>
    <!-- Auto-Refresh Status Indicator -->
    <div id="refreshIndicator" class="refresh-indicator">
        <i class="fas fa-sync-alt"></i> Live Data
    </div>

    <!-- Quick Action Buttons -->
    <div class="quick-actions d-none d-md-block">
        <button class="btn btn-success quick-action-btn" onclick="refreshData()" title="Refresh Data">
            <i class="fas fa-sync-alt"></i>
        </button>
        <button class="btn btn-primary quick-action-btn" onclick="exportReport()" title="Export Report">
            <i class="fas fa-download"></i>
        </button>
        <button class="btn btn-warning quick-action-btn" onclick="showAlerts()" title="View Alerts">
            <i class="fas fa-exclamation-triangle"></i>
        </button>
    </div>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-chart-line"></i> Driver Attendance Reports</h2>
                        <p class="text-muted mb-0">Live attendance tracking across all job sites</p>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <div class="badge bg-success">
                            <i class="fas fa-satellite-dish"></i> Connected
                        </div>
                        <div class="badge bg-info" id="lastUpdate">
                            <i class="fas fa-clock"></i> Live
                        </div>
                        <div class="btn-group">
                            <a href="/working-reports" class="btn btn-outline-primary">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                            <a href="{{ url_for('data_upload.upload_manager') }}" class="btn btn-outline-success">
                                <i class="fas fa-upload"></i> Upload Data
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Metrics -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card card-primary">
                    <div class="card-body text-center py-4">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <div class="metric-value">{{ total_drivers }}</div>
                        <div class="metric-label">Total Drivers</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card card-success">
                    <div class="card-body text-center py-4">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <div class="metric-value">{{ attendance_summary.on_time }}</div>
                        <div class="metric-label">On Time</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card card-warning">
                    <div class="card-body text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <div class="metric-value">{{ attendance_summary.late_start }}</div>
                        <div class="metric-label">Late Starts</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card card-info">
                    <div class="card-body text-center py-4">
                        <i class="fas fa-calendar-day fa-3x mb-3"></i>
                        <div class="metric-value">{{ total_days }}</div>
                        <div class="metric-label">Days of Data</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Navigation -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-calendar-alt"></i> Report Views</h5>
                    </div>
                    <div class="card-body">
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-primary" onclick="showDailyReports()">
                                <i class="fas fa-calendar-day"></i> Daily Reports
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="showWeeklyReports()">
                                <i class="fas fa-calendar-week"></i> Weekly Reports
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="showMonthlyReports()">
                                <i class="fas fa-calendar"></i> Monthly Reports
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Reports Section -->
        <div id="dailyReportsSection" class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Individual Daily Reports</h5>
                        <small class="text-muted">Click any date to view detailed driver attendance</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for date in available_dates[:14] %}
                            <div class="col-lg-6 col-xl-4 mb-3">
                                <div class="card date-card" onclick="loadDailyReport('{{ date }}')">
                                    <div class="card-body p-4">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <div class="date-title">{{ date }}</div>
                                                <div class="driver-count">
                                                    <i class="fas fa-users"></i>
                                                    {{ mtd_data.daily_records[date]|length if date in mtd_data.daily_records else 0 }} drivers
                                                </div>
                                            </div>
                                            <div>
                                                {% if date in mtd_data.daily_records %}
                                                    {% set day_records = mtd_data.daily_records[date] %}
                                                    {% set on_time = day_records|selectattr("status", "equalto", "On Time")|list|length %}
                                                    {% set late = day_records|selectattr("status", "equalto", "Late Start")|list|length %}
                                                    {% set early = day_records|selectattr("status", "equalto", "Early End")|list|length %}
                                                    
                                                    {% if late > 0 or early > 0 %}
                                                        <span class="status-badge bg-warning text-dark">
                                                            <i class="fas fa-exclamation-triangle"></i> {{ late + early }} Issues
                                                        </span>
                                                    {% else %}
                                                        <span class="status-badge bg-success">
                                                            <i class="fas fa-check"></i> All Good
                                                        </span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="status-badge bg-secondary">
                                                        <i class="fas fa-question"></i> No Data
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        {% if date in mtd_data.daily_records %}
                                            {% set day_records = mtd_data.daily_records[date] %}
                                            {% set on_time = day_records|selectattr("status", "equalto", "On Time")|list|length %}
                                            {% set late = day_records|selectattr("status", "equalto", "Late Start")|list|length %}
                                            {% set early = day_records|selectattr("status", "equalto", "Early End")|list|length %}
                                            
                                            <div class="status-summary">
                                                {% if on_time > 0 %}
                                                    <span class="mini-stat text-success">
                                                        <i class="fas fa-check-circle"></i> {{ on_time }} On Time
                                                    </span>
                                                {% endif %}
                                                {% if late > 0 %}
                                                    <span class="mini-stat text-warning">
                                                        <i class="fas fa-clock"></i> {{ late }} Late
                                                    </span>
                                                {% endif %}
                                                {% if early > 0 %}
                                                    <span class="mini-stat text-info">
                                                        <i class="fas fa-sign-out-alt"></i> {{ early }} Early
                                                    </span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Reports Section -->
        <div id="weeklyReportsSection" class="row" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-calendar-week"></i> Weekly Compiled Reports</h5>
                        <div class="mt-2">
                            <input type="week" id="weekSelector" class="form-control" style="max-width: 200px;" onchange="loadWeeklyReport()">
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="weeklyContent">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-calendar-week fa-3x mb-3"></i>
                                <p>Select a week to view compiled weekly reports</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Reports Section -->
        <div id="monthlyReportsSection" class="row" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-calendar"></i> Monthly Compiled Reports</h5>
                        <div class="mt-2">
                            <input type="month" id="monthSelector" class="form-control" style="max-width: 200px;" onchange="loadMonthlyReport()">
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="monthlyContent">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-calendar fa-3x mb-3"></i>
                                <p>Select a month to view compiled monthly reports with driver performance analysis</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Report Modal -->
        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Report Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="modalContent">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="exportReport()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentReportType = 'daily';
        let currentReportData = null;

        function showDailyReports() {
            currentReportType = 'daily';
            document.getElementById('dailyReportsSection').style.display = 'block';
            document.getElementById('weeklyReportsSection').style.display = 'none';
            document.getElementById('monthlyReportsSection').style.display = 'none';
            
            // Update button states
            updateButtonStates('daily');
        }

        function showWeeklyReports() {
            currentReportType = 'weekly';
            document.getElementById('dailyReportsSection').style.display = 'none';
            document.getElementById('weeklyReportsSection').style.display = 'block';
            document.getElementById('monthlyReportsSection').style.display = 'none';
            
            // Set default week to current week
            const today = new Date();
            const monday = new Date(today.setDate(today.getDate() - today.getDay() + 1));
            document.getElementById('weekSelector').value = monday.toISOString().slice(0, 10);
            
            updateButtonStates('weekly');
        }

        function showMonthlyReports() {
            currentReportType = 'monthly';
            document.getElementById('dailyReportsSection').style.display = 'none';
            document.getElementById('weeklyReportsSection').style.display = 'none';
            document.getElementById('monthlyReportsSection').style.display = 'block';
            
            // Set default month to current month
            const today = new Date();
            document.getElementById('monthSelector').value = today.toISOString().slice(0, 7);
            
            updateButtonStates('monthly');
        }

        function updateButtonStates(activeType) {
            const buttons = document.querySelectorAll('.btn-group .btn');
            buttons.forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            
            if (activeType === 'daily') {
                buttons[0].classList.remove('btn-outline-primary');
                buttons[0].classList.add('btn-primary');
            } else if (activeType === 'weekly') {
                buttons[1].classList.remove('btn-outline-primary');
                buttons[1].classList.add('btn-primary');
            } else if (activeType === 'monthly') {
                buttons[2].classList.remove('btn-outline-primary');
                buttons[2].classList.add('btn-primary');
            }
        }

        function loadDailyReport(date) {
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            document.getElementById('modalTitle').textContent = `Daily Report - ${date}`;
            document.getElementById('modalContent').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            
            modal.show();
            
            fetch(`/daily-report/${date}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('modalContent').innerHTML = html;
                    currentReportData = { type: 'daily', date: date };
                })
                .catch(error => {
                    document.getElementById('modalContent').innerHTML = `<div class="alert alert-danger">Error loading report: ${error}</div>`;
                });
        }

        function loadWeeklyReport() {
            const weekValue = document.getElementById('weekSelector').value;
            if (!weekValue) return;
            
            const startDate = weekValue;
            
            fetch(`/weekly-report?start_date=${startDate}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('weeklyContent').innerHTML = html;
                    currentReportData = { type: 'weekly', start_date: startDate };
                })
                .catch(error => {
                    document.getElementById('weeklyContent').innerHTML = `<div class="alert alert-danger">Error loading weekly report: ${error}</div>`;
                });
        }

        function loadMonthlyReport() {
            const monthValue = document.getElementById('monthSelector').value;
            if (!monthValue) return;
            
            fetch(`/monthly-report?month=${monthValue}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('monthlyContent').innerHTML = html;
                    currentReportData = { type: 'monthly', month: monthValue };
                })
                .catch(error => {
                    document.getElementById('monthlyContent').innerHTML = `<div class="alert alert-danger">Error loading monthly report: ${error}</div>`;
                });
        }

        function drillDown(type, filters) {
            // Handle drill-down functionality
            fetch(`/api/drill-down/${type}?${new URLSearchParams(filters)}`)
                .then(response => response.json())
                .then(data => {
                    showDrillDownModal(data, filters);
                })
                .catch(error => {
                    console.error('Drill-down error:', error);
                });
        }

        function showDrillDownModal(data, filters) {
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            document.getElementById('modalTitle').textContent = `Drill-down: ${JSON.stringify(filters)}`;
            
            let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr>';
            html += '<th>Driver</th><th>Start Time</th><th>End Time</th><th>Job Site</th><th>Status</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach(record => {
                html += `<tr>
                    <td>${record.name}</td>
                    <td>${record.start_time}</td>
                    <td>${record.end_time}</td>
                    <td>${record.job_site}</td>
                    <td><span class="badge ${getStatusBadgeClass(record.status)}">${record.status}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('modalContent').innerHTML = html;
            modal.show();
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'On Time': return 'bg-success';
                case 'Late Start': return 'bg-warning';
                case 'Early End': return 'bg-info';
                case 'Not On Job': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function exportReport() {
            if (currentReportData) {
                const params = new URLSearchParams(currentReportData);
                window.open(`/export-report?${params}`, '_blank');
            }
        }

        // Auto-refresh functionality for real-time field operations
        let refreshInterval;
        
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                const indicator = document.getElementById('refreshIndicator');
                indicator.classList.add('updating');
                indicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }, 60000); // Refresh every 60 seconds for field operations
        }
        
        function refreshData() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.add('updating');
            indicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            window.location.reload();
        }
        
        // Enhanced touch feedback for mobile field use
        function addMobileEnhancements() {
            document.querySelectorAll('.date-card').forEach(card => {
                card.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                    this.style.transition = 'transform 0.1s';
                });
                
                card.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });
        }

        // Initialize with daily reports and enhancements
        document.addEventListener('DOMContentLoaded', function() {
            showDailyReports();
            addMobileEnhancements();
            startAutoRefresh();
            
            // Update time indicator
            const lastUpdate = document.getElementById('lastUpdate');
            if (lastUpdate) {
                const now = new Date();
                lastUpdate.innerHTML = `<i class="fas fa-clock"></i> ${now.toLocaleTimeString()}`;
            }
            
            // Keyboard shortcuts for power users
            document.addEventListener('keydown', function(e) {
                if (e.key === 'r' && e.ctrlKey) {
                    e.preventDefault();
                    refreshData();
                }
            });
        });
        
        // Pause auto-refresh when tab hidden to save resources
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(refreshInterval);
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>
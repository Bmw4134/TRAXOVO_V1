<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page_title }} - TRAXOVO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .simulator-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .scenario-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition:
          transform 0.3s ease,
          box-shadow 0.3s ease;
      }

      .scenario-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .savings-indicator {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: bold;
        color: white;
      }

      .savings-positive {
        background: linear-gradient(45deg, #28a745, #20c997);
      }

      .savings-negative {
        background: linear-gradient(45deg, #dc3545, #fd7e14);
      }

      .equipment-type-badge {
        background: linear-gradient(45deg, #6f42c1, #e83e8c);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.875rem;
        display: inline-block;
        margin-bottom: 0.5rem;
      }

      .simulation-controls {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .optimization-panel {
        background: linear-gradient(135deg, #11998e, #38ef7d);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .metric-value {
        font-size: 2rem;
        font-weight: bold;
        display: block;
      }

      .metric-label {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      .recommendation-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
      }

      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50px;
        padding: 12px 20px;
        color: #333;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .back-button:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        color: #333;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <a href="/enhanced-dashboard" class="back-button">
      <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
    </a>

    <div class="container py-4">
      <!-- Header -->
      <div class="simulator-header text-center">
        <h1>
          <i class="fas fa-calculator me-3"></i>Dynamic Cost-Savings Simulation
        </h1>
        <p class="mb-0">
          Real-time analysis using authentic Foundation billing data
        </p>
        <small class="text-muted">Last updated: {{ simulation_date }}</small>
      </div>

      <!-- Summary Metrics -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="scenario-card text-center">
            <span class="metric-value text-success"
              >${{ "{:,.0f}".format(summary_metrics.total_annual_savings)
              }}</span
            >
            <div class="metric-label">Total Annual Savings</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="scenario-card text-center">
            <span class="metric-value text-primary"
              >{{ summary_metrics.total_equipment }}</span
            >
            <div class="metric-label">Equipment Analyzed</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="scenario-card text-center">
            <span class="metric-value text-info"
              >${{ "{:,.0f}".format(summary_metrics.avg_savings_per_unit)
              }}</span
            >
            <div class="metric-label">Avg Savings per Unit</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="scenario-card text-center">
            <span class="metric-value text-warning"
              >{{ (summary_metrics.total_annual_savings /
              (monthly_totals.get('april_2025', 0) * 12) * 100) | round(1) if
              monthly_totals.get('april_2025', 0) > 0 else 0 }}%</span
            >
            <div class="metric-label">Cost Reduction</div>
          </div>
        </div>
      </div>

      <!-- Optimization Results -->
      <div class="optimization-panel">
        <h3>
          <i class="fas fa-lightbulb me-2"></i>Fleet Optimization
          Recommendations
        </h3>
        <div class="row">
          <div class="col-md-6">
            <h5>Current Configuration</h5>
            <p>
              Annual Cost:
              <strong
                >${{
                "{:,.0f}".format(optimization.current_configuration.total_annual_cost)
                }}</strong
              >
            </p>
            <p>
              Equipment Count:
              <strong
                >{{ optimization.current_configuration.equipment_count
                }}</strong
              >
            </p>
          </div>
          <div class="col-md-6">
            <h5>Optimized Savings</h5>
            <p>
              Potential Savings:
              <strong
                >${{
                "{:,.0f}".format(optimization.optimized_configuration.get('total_savings',
                0)) }}</strong
              >
            </p>
            <p>
              ROI Improvement:
              <strong
                >{{ (optimization.optimized_configuration.get('total_savings',
                0) / optimization.current_configuration.total_annual_cost * 100)
                | round(1) if
                optimization.current_configuration.total_annual_cost > 0 else 0
                }}%</strong
              >
            </p>
          </div>
        </div>

        <h5 class="mt-3">Top Recommendations:</h5>
        {% for rec in optimization.recommendations[:5] %}
        <div class="recommendation-item">
          <strong>{{ rec.equipment }}</strong> -
          <span
            class="{% if rec.recommendation == 'keep_internal' %}text-light{% else %}text-warning{% endif %}"
          >
            {{ 'Keep Internal' if rec.recommendation == 'keep_internal' else
            'Consider Rental' }}
          </span>
          <br /><small>{{ rec.reason }}</small>
        </div>
        {% endfor %}
      </div>

      <!-- Individual Equipment Scenarios -->
      <div class="row">
        <div class="col-12">
          <h3 class="mb-4">Equipment Cost Analysis</h3>
        </div>

        {% for equipment_id, scenario in scenarios.items() %}
        <div class="col-md-6 col-lg-4">
          <div class="scenario-card">
            <div class="equipment-type-badge">
              {{ scenario.equipment_type.title() }}
            </div>
            <h5>{{ equipment_id }}</h5>

            <div class="row mb-3">
              <div class="col-6">
                <small class="text-muted">Internal Cost</small>
                <div>
                  <strong
                    >${{ "{:,.0f}".format(scenario.annual_internal_cost)
                    }}</strong
                  >
                </div>
              </div>
              <div class="col-6">
                <small class="text-muted">Rental Cost</small>
                <div>
                  <strong
                    >${{ "{:,.0f}".format(scenario.annual_rental_cost)
                    }}</strong
                  >
                </div>
              </div>
            </div>

            <div class="text-center mb-3">
              <span
                class="savings-indicator {% if scenario.annual_savings > 0 %}savings-positive{% else %}savings-negative{% endif %}"
              >
                {% if scenario.annual_savings > 0 %} ${{
                "{:,.0f}".format(scenario.annual_savings) }} Saved {% else %}
                ${{ "{:,.0f}".format(-scenario.annual_savings) }} Loss {% endif
                %}
              </span>
            </div>

            <div class="row small">
              <div class="col-6">
                <div class="text-muted">3-Year Savings</div>
                <div>
                  <strong
                    >${{ "{:,.0f}".format(scenario.three_year_savings)
                    }}</strong
                  >
                </div>
              </div>
              <div class="col-6">
                <div class="text-muted">Break-even</div>
                <div>
                  <strong
                    >{{ scenario.break_even_months | round(1) }} months</strong
                  >
                </div>
              </div>
            </div>

            <div class="mt-3">
              <button
                class="btn btn-outline-primary btn-sm"
                onclick="analyzeEquipment('{{ equipment_id }}')"
              >
                <i class="fas fa-chart-line me-1"></i>Detailed Analysis
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Data Source Information -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="scenario-card">
            <h5><i class="fas fa-database me-2"></i>Data Integrity</h5>
            <p class="mb-2">
              <strong>Source:</strong> {{ summary_metrics.data_source }}
            </p>
            <p class="mb-2">
              <strong>March 2025 Revenue:</strong> ${{
              "{:,.0f}".format(monthly_totals.get('march_2025', 0)) }}
            </p>
            <p class="mb-0">
              <strong>April 2025 Revenue:</strong> ${{
              "{:,.0f}".format(monthly_totals.get('april_2025', 0)) }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function analyzeEquipment(equipmentId) {
        fetch(`/api/equipment-analysis/${equipmentId}`)
          .then((response) => response.json())
          .then((data) => {
            alert(
              `Detailed Analysis for ${equipmentId}:\n\n` +
                `Annual Savings: $${data.analysis.annual_savings?.toLocaleString() || "0"}\n` +
                `Recommendation: ${data.recommendation}\n` +
                `Break-even: ${data.analysis.break_even_months?.toFixed(1) || "0"} months`,
            );
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error loading equipment analysis");
          });
      }

      // Auto-refresh data every 5 minutes
      setInterval(() => {
        console.log("Refreshing cost simulation data...");
        window.location.reload();
      }, 300000);
    </script>
  </body>
</html>

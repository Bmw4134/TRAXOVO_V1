{% extends "layout_unified.html" %}

{% block title %}Daily Driver Report | TRAXORA{% endblock %}

{% block head_content %}
<style>
    .classification-badge {
        font-size: 0.85rem;
        padding: 0.35em 0.65em;
        font-weight: 600;
    }
    .badge-on_time {
        background-color: var(--bs-success);
        color: white;
    }
    .badge-late {
        background-color: var(--bs-warning);
        color: var(--bs-dark);
    }
    .badge-early_end {
        background-color: var(--bs-info);
        color: var(--bs-dark);
    }
    .badge-not_on_job {
        background-color: var(--bs-danger);
        color: white;
    }
    .datepicker-dropdown {
        z-index: 1060;
    }
    .driver-details-row {
        transition: all 0.3s ease;
    }
    .contact-collapse {
        background-color: rgba(0,0,0,0.05);
    }
    .metric-card {
        transition: all 0.3s ease;
    }
    .metric-card:hover {
        transform: translateY(-5px);
    }
    .metric-card-success {
        border-left: 4px solid var(--bs-success);
    }
    .metric-card-warning {
        border-left: 4px solid var(--bs-warning);
    }
    .metric-card-danger {
        border-left: 4px solid var(--bs-danger);
    }
    .metric-card-info {
        border-left: 4px solid var(--bs-info);
    }
    
    /* Mobile Optimization Styles */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 0.5rem !important;
        }
        
        .page-header h1 {
            font-size: 1.5rem !important;
        }
        
        .date-selector {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .card {
            margin-bottom: 1rem !important;
        }
        
        .metric-card .h2 {
            font-size: 1.75rem;
        }
        
        .card-header {
            padding: 0.75rem !important;
            flex-direction: column !important;
            align-items: flex-start !important;
        }
        
        .card-header .filter-buttons {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .card-header .filter-buttons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .table {
            font-size: 0.85rem;
        }
        
        .table th, .table td {
            padding: 0.5rem 0.25rem !important;
        }
        
        .btn-sm {
            padding: 0.25rem 0.4rem;
            font-size: 0.75rem;
        }
        
        .classification-badge {
            font-size: 0.7rem;
            padding: 0.25em 0.5em;
        }
        
        /* Touch-friendly spacing */
        .btn {
            margin: 0.2rem;
            min-height: 38px;
        }
        
        /* Improved table scrolling */
        .table-responsive {
            -webkit-overflow-scrolling: touch;
            border-radius: 0.25rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 page-header">
        <h1 class="h3 mb-3 mb-md-0">Daily Driver Report</h1>
        <div class="d-flex flex-column flex-md-row w-100 w-md-auto">
            <div class="input-group date-selector mb-2 mb-md-0 me-md-2">
                <select class="form-select" id="dateSelector">
                    {% for date in available_dates %}
                    <option value="{{ date }}" {% if date == selected_date %}selected{% endif %}>{{ date }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-primary" id="viewDateBtn">
                    <i class="fas fa-search"></i> <span class="d-none d-md-inline">View</span>
                </button>
            </div>
            <div class="d-flex">
                <a href="#" class="btn btn-primary me-2">
                    <i class="fas fa-upload"></i> <span class="d-none d-md-inline">Upload Files</span>
                </a>
                {% if report_data %}
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-download"></i> <span class="d-none d-md-inline">Download</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
                        <li><a class="dropdown-item" href="{{ url_for('daily_attendance.download_excel', date_str=selected_date) }}">Excel Report</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('daily_attendance.download_json', date_str=selected_date) }}">JSON Data</a></li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if report_data %}
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow h-100 metric-card metric-card-success">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">On Time</div>
                            <div class="h2 mb-0 font-weight-bold">{{ report_data.summary.on_time }}</div>
                            <div class="mt-2 text-muted small">{{ (report_data.summary.on_time / report_data.summary.total_drivers * 100)|round|int if report_data.summary.total_drivers > 0 else 0 }}% of drivers</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow h-100 metric-card metric-card-warning">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Late</div>
                            <div class="h2 mb-0 font-weight-bold">{{ report_data.summary.late }}</div>
                            <div class="mt-2 text-muted small">{{ (report_data.summary.late / report_data.summary.total_drivers * 100)|round|int if report_data.summary.total_drivers > 0 else 0 }}% of drivers</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow h-100 metric-card metric-card-info">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Early End</div>
                            <div class="h2 mb-0 font-weight-bold">{{ report_data.summary.early_end }}</div>
                            <div class="mt-2 text-muted small">{{ (report_data.summary.early_end / report_data.summary.total_drivers * 100)|round|int if report_data.summary.total_drivers > 0 else 0 }}% of drivers</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-sign-out-alt fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow h-100 metric-card metric-card-danger">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Not On Job</div>
                            <div class="h2 mb-0 font-weight-bold">{{ report_data.summary.not_on_job }}</div>
                            <div class="mt-2 text-muted small">{{ (report_data.summary.not_on_job / report_data.summary.total_drivers * 100)|round|int if report_data.summary.total_drivers > 0 else 0 }}% of drivers</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Content -->
    <div class="card border-0 shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold">Driver Attendance Report ({{ selected_date }})</h6>
            <div class="filter-buttons">
                <button class="btn btn-sm btn-outline-success filter-btn" data-status="on_time">
                    <i class="fas fa-check-circle"></i> <span class="d-none d-md-inline">On Time</span>
                </button>
                <button class="btn btn-sm btn-outline-warning filter-btn" data-status="late">
                    <i class="fas fa-clock"></i> <span class="d-none d-md-inline">Late</span>
                </button>
                <button class="btn btn-sm btn-outline-info filter-btn" data-status="early_end">
                    <i class="fas fa-sign-out-alt"></i> <span class="d-none d-md-inline">Early End</span>
                </button>
                <button class="btn btn-sm btn-outline-danger filter-btn" data-status="not_on_job">
                    <i class="fas fa-exclamation-triangle"></i> <span class="d-none d-md-inline">Not On Job</span>
                </button>
                <button class="btn btn-sm btn-outline-secondary filter-btn" data-status="all">
                    <i class="fas fa-list"></i> <span class="d-none d-md-inline">All</span>
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Mobile Card View (shows on small screens only) -->
            <div class="d-md-none mb-4">
                {% for driver in report_data.drivers %}
                <div class="card driver-card mb-3 border-0 shadow-sm driver-{{ driver.classification }}">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold">{{ driver.driver_name }}</h6>
                        <span class="badge classification-badge badge-{{ driver.classification }}">
                            {% if driver.classification == 'on_time' %}
                            <i class="fas fa-check-circle me-1"></i> On Time
                            {% elif driver.classification == 'late' %}
                            <i class="fas fa-clock me-1"></i> Late
                            {% elif driver.classification == 'early_end' %}
                            <i class="fas fa-sign-out-alt me-1"></i> Early End
                            {% elif driver.classification == 'not_on_job' %}
                            <i class="fas fa-exclamation-triangle me-1"></i> Not On Job
                            {% else %}
                            <i class="fas fa-question-circle me-1"></i> Unknown
                            {% endif %}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <div class="text-primary" style="width:24px"><i class="fas fa-map-marker-alt"></i></div>
                            <div><strong>Job Site:</strong> {{ driver.job_site }}</div>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="text-primary" style="width:24px"><i class="fas fa-clock"></i></div>
                            <div><strong>Start:</strong> {{ driver.start_time or 'N/A' }}</div>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <div class="text-primary" style="width:24px"><i class="fas fa-flag-checkered"></i></div>
                            <div><strong>End:</strong> {{ driver.end_time or 'N/A' }}</div>
                        </div>
                        <button class="btn btn-sm btn-primary w-100 mobile-details-btn" 
                                data-driver-name="{{ driver.driver_name }}"
                                data-bs-toggle="collapse" 
                                data-bs-target="#mobile-details-{{ loop.index }}" 
                                aria-expanded="false">
                            <i class="fas fa-info-circle me-1"></i> Show Details
                        </button>
                        
                        <div class="collapse mt-3" id="mobile-details-{{ loop.index }}">
                            <div class="card card-body border-0 bg-light">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="text-primary" style="width:24px"><i class="fas fa-truck"></i></div>
                                    <div><strong>Equipment:</strong> {{ driver.equipment or 'N/A' }}</div>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <div class="text-primary" style="width:24px"><i class="fas fa-info-circle"></i></div>
                                    <div><strong>Reason:</strong> {{ driver.classification_reason }}</div>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <div class="text-primary" style="width:24px"><i class="fas fa-database"></i></div>
                                    <div><strong>Sources:</strong> {{ driver.data_sources|join(', ') }}</div>
                                </div>
                                
                                {% if driver.contact_info %}
                                <div class="mt-3 pt-3 border-top">
                                    <h6 class="mb-2">Contact Information</h6>
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="text-primary" style="width:24px"><i class="fas fa-phone"></i></div>
                                        <div><strong>Phone:</strong> {{ driver.contact_info.phone or 'N/A' }}</div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="text-primary" style="width:24px"><i class="fas fa-envelope"></i></div>
                                        <div><strong>Email:</strong> {{ driver.contact_info.email or 'N/A' }}</div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Desktop Table View (hidden on small screens) -->
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover" id="driversTable">
                    <thead>
                        <tr>
                            <th>Driver</th>
                            <th>Job Site</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for driver in report_data.drivers %}
                        <tr class="driver-row driver-{{ driver.classification }}">
                            <td>{{ driver.driver_name }}</td>
                            <td>{{ driver.job_site }}</td>
                            <td>{{ driver.start_time or 'N/A' }}</td>
                            <td>{{ driver.end_time or 'N/A' }}</td>
                            <td>
                                <span class="badge classification-badge badge-{{ driver.classification }}">
                                    {% if driver.classification == 'on_time' %}
                                    <i class="fas fa-check-circle me-1"></i> On Time
                                    {% elif driver.classification == 'late' %}
                                    <i class="fas fa-clock me-1"></i> Late
                                    {% elif driver.classification == 'early_end' %}
                                    <i class="fas fa-sign-out-alt me-1"></i> Early End
                                    {% elif driver.classification == 'not_on_job' %}
                                    <i class="fas fa-exclamation-triangle me-1"></i> Not On Job
                                    {% else %}
                                    <i class="fas fa-question-circle me-1"></i> Unknown
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary btn-contact-details" data-driver-id="{{ loop.index }}">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                            </td>
                        </tr>
                        <tr class="driver-details-row d-none" id="details-{{ loop.index }}">
                            <td colspan="6" class="p-0">
                                <div class="contact-collapse p-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="mb-2">Driver Details</h6>
                                            <p class="mb-1"><i class="fas fa-truck me-2 text-primary"></i> <strong>Equipment:</strong> {{ driver.equipment or 'N/A' }}</p>
                                            <p class="mb-1"><i class="fas fa-info-circle me-2 text-primary"></i> <strong>Reason:</strong> {{ driver.classification_reason }}</p>
                                            <p class="mb-1"><i class="fas fa-database me-2 text-primary"></i> <strong>Data Sources:</strong> {{ driver.data_sources|join(', ') }}</p>
                                            
                                            {% if driver.contact_info %}
                                            <h6 class="mt-3 mb-2">Contact Information</h6>
                                            <p class="mb-1"><i class="fas fa-phone me-2 text-primary"></i> <strong>Phone:</strong> {{ driver.contact_info.phone or 'N/A' }}</p>
                                            <p class="mb-1"><i class="fas fa-envelope me-2 text-primary"></i> <strong>Email:</strong> {{ driver.contact_info.email or 'N/A' }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <h4 class="alert-heading">No Report Available</h4>
        <p>There is no report available for the selected date. Please upload data files to generate a report.</p>
        <hr>
        <p class="mb-0">
            <a href="{{ url_for('daily_attendance.upload') }}" class="btn btn-primary">
                <i class="fas fa-upload"></i> Upload Files
            </a>
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Initialize DataTable with responsive settings
        {% if report_data %}
        const table = $('#driversTable').DataTable({
            "order": [], // No initial sorting
            "paging": true,
            "searching": true,
            "info": true,
            "responsive": true,
            "columnDefs": [
                { "orderable": false, "targets": 5 } // Disable sorting on actions column
            ],
            "language": {
                "emptyTable": "No driver data available for this date",
                "search": "Quick search:",
                "paginate": {
                    "previous": "<i class='fas fa-chevron-left'></i>",
                    "next": "<i class='fas fa-chevron-right'></i>"
                }
            },
            "pageLength": 15, // Show more entries by default
            "dom": '<"top"if>rt<"bottom"lp><"clear">' // Custom layout
        });
        {% endif %}
        
        // Date selector functionality
        $('#viewDateBtn').click(function() {
            const selectedDate = $('#dateSelector').val();
            window.location.href = "{{ url_for('daily_attendance.index') }}?date=" + selectedDate;
        });
        
        // Contact details toggle for desktop view
        $('.btn-contact-details').click(function() {
            const driverId = $(this).data('driver-id');
            const detailsRow = $(`#details-${driverId}`);
            
            if (detailsRow.hasClass('d-none')) {
                // Hide all other detail rows first
                $('.driver-details-row').addClass('d-none');
                detailsRow.removeClass('d-none');
                
                // Scroll to the details row smoothly
                $('html, body').animate({
                    scrollTop: detailsRow.offset().top - 100
                }, 300);
            } else {
                detailsRow.addClass('d-none');
            }
        });
        
        // Filter functionality
        $('.filter-btn').click(function() {
            const status = $(this).data('status');
            
            // Remove active class from all buttons
            $('.filter-btn').removeClass('active').removeClass('btn-primary')
                .removeClass(function(index, className) {
                    return (className.match(/(^|\s)btn-outline-\S+/g) || []).join(' ');
                });
            
            // Add active class to clicked button
            $(this).addClass('active').addClass('btn-primary');
            
            // Show/hide drivers based on status
            if (status === 'all') {
                $('.driver-row').show();
                $('.driver-card').show();
                {% if report_data %}
                table.search('').draw();
                {% endif %}
            } else {
                $('.driver-row').hide();
                $('.driver-card').hide();
                $(`.driver-${status}`).show();
                {% if report_data %}
                table.search(status.replace('_', ' ')).draw();
                {% endif %}
            }
        });
        
        // Keyboard shortcuts
        $(document).keydown(function(e) {
            // Left arrow - previous date
            if (e.keyCode === 37) {
                const select = $('#dateSelector');
                const options = select.find('option');
                const currentIndex = options.index(options.filter(':selected'));
                
                if (currentIndex > 0) {
                    select.val(options.eq(currentIndex - 1).val());
                    $('#viewDateBtn').click();
                }
            }
            
            // Right arrow - next date
            if (e.keyCode === 39) {
                const select = $('#dateSelector');
                const options = select.find('option');
                const currentIndex = options.index(options.filter(':selected'));
                
                if (currentIndex < options.length - 1) {
                    select.val(options.eq(currentIndex + 1).val());
                    $('#viewDateBtn').click();
                }
            }
        });
    });
</script>
{% endblock %}
{% extends "layout_unified_enhanced.html" %}

{% block title %}Upload Files - Daily Driver Report - TRAXORA{% endblock %}

{% block head_content %}
<style>
    .upload-container {
        border: 2px dashed rgba(var(--bs-primary-rgb), 0.5);
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background-color: rgba(var(--bs-primary-rgb), 0.05);
    }
    
    .upload-container:hover, .upload-container.drag-over {
        border-color: var(--bs-primary);
        background-color: rgba(var(--bs-primary-rgb), 0.1);
    }
    
    .upload-icon {
        font-size: 3rem;
        color: var(--bs-primary);
        opacity: 0.7;
        margin-bottom: 1rem;
    }
    
    .file-type-card {
        border-radius: 0.5rem;
        border: none;
        transition: all 0.3s ease;
    }
    
    .file-type-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .file-preview {
        max-height: 300px;
        overflow-y: auto;
        border-radius: 0.5rem;
    }
    
    .file-list {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .preview-table {
        font-size: 0.85rem;
    }
    
    .preview-table th, .preview-table td {
        padding: 0.5rem;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Upload Data Files</h2>
            <p class="text-muted mb-0">Upload GPS tracking and attendance data files for daily driver reports</p>
        </div>
        <div>
            <a href="{{ url_for('daily_driver_report.dashboard') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
    
    <!-- Upload Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Upload Files</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('daily_driver_report.upload_files') }}" method="post" enctype="multipart/form-data" id="upload-form">
                        <div class="mb-4">
                            <label for="date" class="form-label">Report Date</label>
                            <input type="date" class="form-control" id="date" name="date" value="{{ today_date if today_date else '' }}" required>
                            <div class="form-text">Select the date for which these files apply</div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">Data Files</label>
                            <div class="upload-container" id="drop-area">
                                <i class="fas fa-file-upload upload-icon"></i>
                                <h5>Drag & Drop Files Here</h5>
                                <p class="text-muted mb-3">or click to browse your files</p>
                                <input type="file" class="d-none" id="file-input" name="files[]" multiple>
                                <button type="button" class="btn btn-primary" id="browse-button">
                                    <i class="fas fa-folder-open me-2"></i>Browse Files
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-4 d-none" id="file-list-container">
                            <label class="form-label">Selected Files</label>
                            <div class="card bg-dark">
                                <div class="list-group list-group-flush file-list" id="file-list">
                                    <!-- Files will be listed here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4 d-none" id="preview-container">
                            <label class="form-label">File Preview</label>
                            <div class="file-preview bg-dark p-3">
                                <div class="table-responsive">
                                    <table class="table table-sm table-dark preview-table" id="preview-table">
                                        <!-- Preview content will be displayed here -->
                                    </table>
                                </div>
                            </div>
                            <div class="form-text" id="preview-info">Showing preview of the first file</div>
                        </div>
                        
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="auto-generate" name="auto_generate" value="true">
                            <label class="form-check-label" for="auto-generate">
                                Automatically generate report after upload
                            </label>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('daily_driver_report.dashboard') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-success" id="upload-button" disabled>
                                <i class="fas fa-cloud-upload-alt me-2"></i>Upload & Process
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- File Preview Card (only shown when files are selected) -->
            <div class="card d-none" id="auto-detection-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Smart File Detection</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-magic me-3 fs-4"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading mb-2">Automatic File Classification</h6>
                                <p class="mb-0">
                                    The system has analyzed your files and automatically detected their types. 
                                    File contents will be processed according to their detected formats, 
                                    so you don't need to rename or reorganize files before uploading.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Detected File Types:</h6>
                        <span class="badge bg-success" id="detection-count">0 files analyzed</span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-dark" id="detection-table">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Detected Type</th>
                                    <th>Format</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Detection results will be displayed here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- File Types Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Supported File Types</h5>
                </div>
                <div class="card-body">
                    <div class="file-type-card bg-success bg-opacity-10 p-3 mb-3">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-car text-success fs-4 me-3"></i>
                            </div>
                            <div>
                                <h6 class="text-success mb-1">Driving History</h6>
                                <p class="text-muted small mb-0">
                                    CSV files containing GPS tracking data for vehicles and drivers.
                                    Includes timestamps, coordinates, and driver information.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="file-type-card bg-primary bg-opacity-10 p-3 mb-3">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-map-marker-alt text-primary fs-4 me-3"></i>
                            </div>
                            <div>
                                <h6 class="text-primary mb-1">Assets Time On Site</h6>
                                <p class="text-muted small mb-0">
                                    CSV files tracking when assets (vehicles) are present at job sites.
                                    Includes arrival and departure times.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="file-type-card bg-info bg-opacity-10 p-3 mb-3">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-clipboard-list text-info fs-4 me-3"></i>
                            </div>
                            <div>
                                <h6 class="text-info mb-1">Activity Detail</h6>
                                <p class="text-muted small mb-0">
                                    CSV files with detailed activity logs for drivers and vehicles.
                                    Optional but provides enhanced location data.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="file-type-card bg-warning bg-opacity-10 p-3">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-clipboard-check text-warning fs-4 me-3"></i>
                            </div>
                            <div>
                                <h6 class="text-warning mb-1">Timecard Data</h6>
                                <p class="text-muted small mb-0">
                                    Excel or CSV files containing timecard information.
                                    Optional but useful for validation with payroll data.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Help Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Tips & Help</h5>
                </div>
                <div class="card-body">
                    <h6><i class="fas fa-lightbulb text-warning me-2"></i>Smart Detection</h6>
                    <p class="text-muted small mb-3">
                        Our system automatically detects file types based on content analysis.
                        You don't need to rename files before uploading.
                    </p>
                    
                    <h6><i class="fas fa-calendar-alt text-info me-2"></i>Date Selection</h6>
                    <p class="text-muted small mb-3">
                        Make sure to select the correct date for the report. This helps match
                        the data to the right day's activities.
                    </p>
                    
                    <h6><i class="fas fa-file-export text-success me-2"></i>Multiple Files</h6>
                    <p class="text-muted small mb-0">
                        You can upload multiple files at once. The system will process them
                        together and generate a comprehensive report.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const browseButton = document.getElementById('browse-button');
        const uploadButton = document.getElementById('upload-button');
        const fileListContainer = document.getElementById('file-list-container');
        const fileList = document.getElementById('file-list');
        const previewContainer = document.getElementById('preview-container');
        const previewTable = document.getElementById('preview-table');
        const previewInfo = document.getElementById('preview-info');
        const autoDetectionCard = document.getElementById('auto-detection-card');
        const detectionTable = document.getElementById('detection-table').querySelector('tbody');
        const detectionCount = document.getElementById('detection-count');
        
        // Set today's date as default
        const today = new Date();
        document.getElementById('date').value = today.toISOString().split('T')[0];
        
        // Handle browse button click
        browseButton.addEventListener('click', function() {
            fileInput.click();
        });
        
        // Handle file selection
        fileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });
        
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop area when dragging over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        // Handle dropped files
        dropArea.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight() {
            dropArea.classList.add('drag-over');
        }
        
        function unhighlight() {
            dropArea.classList.remove('drag-over');
        }
        
        function handleFiles(files) {
            if (files.length === 0) return;
            
            // Clear existing file list
            fileList.innerHTML = '';
            detectionTable.innerHTML = '';
            
            // Display file list
            fileListContainer.classList.remove('d-none');
            autoDetectionCard.classList.remove('d-none');
            
            // Enable upload button
            uploadButton.disabled = false;
            
            // Update detection count
            detectionCount.textContent = `${files.length} files analyzed`;
            
            // Process each file
            Array.from(files).forEach((file, index) => {
                // Add to file list
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item bg-dark d-flex justify-content-between align-items-center';
                
                // Determine icon based on file extension
                let icon = 'fa-file';
                const extension = file.name.split('.').pop().toLowerCase();
                
                if (['csv'].includes(extension)) {
                    icon = 'fa-file-csv';
                } else if (['xls', 'xlsx'].includes(extension)) {
                    icon = 'fa-file-excel';
                } else if (['pdf'].includes(extension)) {
                    icon = 'fa-file-pdf';
                }
                
                // Detect file type based on name patterns
                let detectedType = 'Unknown';
                let format = extension.toUpperCase();
                
                if (file.name.toLowerCase().includes('driving') || file.name.toLowerCase().includes('drive')) {
                    detectedType = 'Driving History';
                } else if (file.name.toLowerCase().includes('timeonsite') || file.name.toLowerCase().includes('time on site')) {
                    detectedType = 'Assets Time On Site';
                } else if (file.name.toLowerCase().includes('activity') || file.name.toLowerCase().includes('detail')) {
                    detectedType = 'Activity Detail';
                } else if (file.name.toLowerCase().includes('timecard') || file.name.toLowerCase().includes('time card')) {
                    detectedType = 'Timecard Data';
                }
                
                // Add to detection table
                const detectionRow = document.createElement('tr');
                detectionRow.innerHTML = `
                    <td>${file.name}</td>
                    <td><span class="badge ${getBadgeClass(detectedType)}">${detectedType}</span></td>
                    <td>${format}</td>
                `;
                detectionTable.appendChild(detectionRow);
                
                listItem.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas ${icon} me-3 text-primary"></i>
                        <div>
                            <div>${file.name}</div>
                            <small class="text-muted">${formatFileSize(file.size)}</small>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary preview-btn" data-index="${index}">
                        <i class="fas fa-eye"></i>
                    </button>
                `;
                
                fileList.appendChild(listItem);
                
                // Show preview of first file
                if (index === 0 && extension === 'csv') {
                    previewCSV(file);
                }
            });
            
            // Add click handlers for preview buttons
            document.querySelectorAll('.preview-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const file = files[index];
                    const extension = file.name.split('.').pop().toLowerCase();
                    
                    if (extension === 'csv') {
                        previewCSV(file);
                    } else {
                        // For non-CSV files, show a simple message
                        previewContainer.classList.remove('d-none');
                        previewTable.innerHTML = `
                            <tr>
                                <td class="text-center py-4">
                                    <i class="fas fa-file-${extension === 'xlsx' ? 'excel' : 'alt'} fs-4 mb-3"></i>
                                    <p>Preview not available for ${extension.toUpperCase()} files</p>
                                </td>
                            </tr>
                        `;
                        previewInfo.textContent = `File: ${file.name}`;
                    }
                });
            });
        }
        
        function previewCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\\n');
                
                if (lines.length > 0) {
                    // Parse the first few lines (header + data rows)
                    const headerLine = lines[0];
                    const headers = headerLine.split(',');
                    
                    // Build table headers
                    let tableHTML = '<thead><tr>';
                    headers.forEach(header => {
                        tableHTML += `<th>${header.trim().replace(/"/g, '')}</th>`;
                    });
                    tableHTML += '</tr></thead><tbody>';
                    
                    // Add a few data rows (max 5)
                    const maxRows = Math.min(lines.length - 1, 5);
                    for (let i = 1; i <= maxRows; i++) {
                        if (lines[i].trim() !== '') {
                            const cells = lines[i].split(',');
                            tableHTML += '<tr>';
                            cells.forEach(cell => {
                                tableHTML += `<td>${cell.trim().replace(/"/g, '')}</td>`;
                            });
                            tableHTML += '</tr>';
                        }
                    }
                    
                    tableHTML += '</tbody>';
                    
                    // Display the table
                    previewContainer.classList.remove('d-none');
                    previewTable.innerHTML = tableHTML;
                    previewInfo.textContent = `Showing preview of ${file.name} (first ${maxRows} rows)`;
                }
            };
            reader.readAsText(file);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function getBadgeClass(type) {
            switch(type) {
                case 'Driving History':
                    return 'bg-success';
                case 'Assets Time On Site':
                    return 'bg-primary';
                case 'Activity Detail':
                    return 'bg-info';
                case 'Timecard Data':
                    return 'bg-warning';
                default:
                    return 'bg-secondary';
            }
        }
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Dashboard - TRAXORA{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet">
<style>
  .card-dashboard {
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
  }
  
  .card-dashboard:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
  }
  
  .stats-counter {
    font-size: 2.5rem;
    font-weight: 700;
  }
  
  .trend-indicator {
    font-size: 0.9rem;
    padding: 0.2rem 0.5rem;
    border-radius: 20px;
    margin-left: 0.5rem;
  }
  
  .trend-up {
    background-color: rgba(28, 200, 138, 0.2);
    color: #1cc88a;
  }
  
  .trend-down-good {
    background-color: rgba(28, 200, 138, 0.2);
    color: #1cc88a;
  }
  
  .trend-down-bad {
    background-color: rgba(231, 74, 59, 0.2);
    color: #e74a3b;
  }
  
  .trend-stable {
    background-color: rgba(54, 185, 204, 0.2);
    color: #36b9cc;
  }
  
  .quick-stat {
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
  
  .recent-activity-item {
    transition: background-color 0.2s;
    border-left: 4px solid transparent;
  }
  
  .recent-activity-item:hover {
    background-color: rgba(78, 115, 223, 0.1);
    border-left: 4px solid #4e73df;
  }
  
  .activity-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }
  
  .activity-completed {
    background-color: rgba(28, 200, 138, 0.2);
    color: #1cc88a;
  }
  
  .activity-warning {
    background-color: rgba(246, 194, 62, 0.2);
    color: #f6c23e;
  }
  
  .activity-danger {
    background-color: rgba(231, 74, 59, 0.2);
    color: #e74a3b;
  }
  
  .activity-info {
    background-color: rgba(54, 185, 204, 0.2);
    color: #36b9cc;
  }
  
  .activity-primary {
    background-color: rgba(78, 115, 223, 0.2);
    color: #4e73df;
  }
  
  .mini-map {
    height: 200px;
    border-radius: 8px;
  }
  
  .sparkline-container {
    height: 30px;
    width: 100px;
    display: inline-block;
    vertical-align: middle;
  }
  
  .status-count {
    font-size: 1.5rem;
    font-weight: 600;
  }
  
  .utilization-chart {
    height: 200px;
  }
  
  /* Customized progress bars */
  .progress {
    height: 10px;
    border-radius: 10px;
  }
  
  .progress-thin {
    height: 5px;
  }
  
  /* Custom pill badges */
  .badge-pill-lg {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
    border-radius: 50px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Page Header -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0">Operations Dashboard</h1>
    <div>
      <a href="{{ url_for('driver_module.daily_report') }}" class="btn btn-sm btn-primary me-2">
        <i class="bi bi-calendar-day"></i> Daily Driver Report
      </a>
      <a href="{{ url_for('attendance_blueprint.dashboard') }}" class="btn btn-sm btn-outline-primary">
        <i class="bi bi-graph-up"></i> Attendance Dashboard
      </a>
    </div>
  </div>

  <!-- Overview Cards -->
  <div class="row mb-4">
    <!-- Assets Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card card-dashboard h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-uppercase text-muted mb-0">Active Assets</h6>
            <div class="badge bg-primary">Fleet</div>
          </div>
          <div class="d-flex align-items-center">
            <div class="stats-counter">{{ active_assets }}</div>
            <div class="trend-indicator trend-up ms-2">
              <i class="bi bi-arrow-up-short"></i> 5.3%
            </div>
          </div>
          <div class="text-muted small">Currently being tracked</div>
          <div class="mt-3">
            <div class="d-flex justify-content-between mb-1 small">
              <span>Fleet Utilization</span>
              <span>76%</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-primary" role="progressbar" style="width: 76%;" aria-valuenow="76" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Driver Reports Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card card-dashboard h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-uppercase text-muted mb-0">System Alerts</h6>
            <div class="badge bg-danger">Attention</div>
          </div>
          <div class="row text-center">
            <div class="col-4">
              <div class="status-count text-danger">{{ critical_alerts|default(0) }}</div>
              <div class="small text-muted">Critical</div>
            </div>
            <div class="col-4">
              <div class="status-count text-warning">{{ warning_alerts|default(0) }}</div>
              <div class="small text-muted">Warning</div>
            </div>
            <div class="col-4">
              <div class="status-count text-info">{{ info_alerts|default(0) }}</div>
              <div class="small text-muted">Info</div>
            </div>
          </div>
          <div class="mt-3">
            <a href="#" class="btn btn-sm btn-outline-primary w-100">View All Alerts</a>
          </div>
        </div>
      </div>
    </div>

    <!-- System Status Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card card-dashboard h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-uppercase text-muted mb-0">System Status</h6>
            <div class="badge bg-success">Healthy</div>
          </div>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1 small">
              <span><i class="bi bi-database-check me-1"></i> Database</span>
              <span class="text-success">Connected</span>
            </div>
            <div class="progress progress-thin">
              <div class="progress-bar bg-success" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1 small">
              <span><i class="bi bi-cloud-check me-1"></i> API Status</span>
              <span class="text-success">Online</span>
            </div>
            <div class="progress progress-thin">
              <div class="progress-bar bg-success" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
          <div>
            <div class="d-flex justify-content-between mb-1 small">
              <span><i class="bi bi-gpu-card me-1"></i> Job Processing</span>
              <span class="text-success">Active</span>
            </div>
            <div class="progress progress-thin">
              <div class="progress-bar bg-success" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stats Card -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card card-dashboard h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-uppercase text-muted mb-0">Quick Stats</h6>
            <div class="badge bg-info">Today</div>
          </div>
          <div class="row">
            <div class="col-12">
              <div class="quick-stat bg-primary-subtle mb-2">
                <div class="d-flex justify-content-between">
                  <div>
                    <div class="small text-muted">Total Assets</div>
                    <div class="fw-bold">{{ total_assets }}</div>
                  </div>
                  <div class="fs-4 text-primary">
                    <i class="bi bi-truck"></i>
                  </div>
                </div>
              </div>
              <div class="quick-stat bg-success-subtle mb-2">
                <div class="d-flex justify-content-between">
                  <div>
                    <div class="small text-muted">Asset Counts</div>
                    <div class="fw-bold">{{ asset_counts.desc|default({}) }}</div>
                  </div>
                  <div class="fs-4 text-success">
                    <i class="bi bi-building"></i>
                  </div>
                </div>
              </div>
              <div class="quick-stat bg-info-subtle">
                <div class="d-flex justify-content-between">
                  <div>
                    <div class="small text-muted">GPS Status</div>
                    <div class="fw-bold">Operational</div>
                  </div>
                  <div class="fs-4 text-info">
                    <i class="bi bi-geo-alt"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="row">
    <!-- Left Column -->
    <div class="col-lg-8">
      <!-- Mini Map Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white py-3">
          <h6 class="m-0 font-weight-bold">Asset Locations</h6>
        </div>
        <div class="card-body">
          <div id="assetMap" class="mini-map"></div>
          <div class="row mt-3">
            <div class="col-md-3 col-6 text-center">
              <div class="badge-pill-lg bg-primary-subtle text-primary mb-1">{{ excavator_count|default('3', true) }}</div>
              <div class="small text-muted">Excavators</div>
            </div>
            <div class="col-md-3 col-6 text-center">
              <div class="badge-pill-lg bg-success-subtle text-success mb-1">{{ loader_count|default('2', true) }}</div>
              <div class="small text-muted">Loaders</div>
            </div>
            <div class="col-md-3 col-6 text-center">
              <div class="badge-pill-lg bg-danger-subtle text-danger mb-1">{{ dozer_count|default('2', true) }}</div>
              <div class="small text-muted">Dozers</div>
            </div>
            <div class="col-md-3 col-6 text-center">
              <div class="badge-pill-lg bg-info-subtle text-info mb-1">{{ truck_count|default('5', true) }}</div>
              <div class="small text-muted">Trucks</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white py-3">
          <h6 class="m-0 font-weight-bold">Quick Links</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 mb-3">
              <a href="{{ url_for('driver_module.daily_report') }}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center py-3">
                <i class="bi bi-calendar-day fs-2 mb-2"></i>
                <span>Daily Driver Reports</span>
              </a>
            </div>
            <div class="col-md-4 mb-3">
              <a href="{{ url_for('billing_module.april_simulation') }}" class="btn btn-outline-success w-100 h-100 d-flex flex-column justify-content-center py-3">
                <i class="bi bi-cash-stack fs-2 mb-2"></i>
                <span>April Billing Simulation</span>
              </a>
            </div>
            <div class="col-md-4 mb-3">
              <a href="{{ url_for('job_zone.index') }}" class="btn btn-outline-info w-100 h-100 d-flex flex-column justify-content-center py-3">
                <i class="bi bi-geo-alt fs-2 mb-2"></i>
                <span>Job Zone Efficiency</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
      <!-- Quick Actions Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white py-3">
          <h6 class="m-0 font-weight-bold">Quick Actions</h6>
        </div>
        <div class="card-body">
          <div class="list-group">
            <a href="{{ url_for('driver_module.daily_report') }}" class="list-group-item list-group-item-action d-flex align-items-center">
              <div class="me-3 text-primary fs-5">
                <i class="bi bi-file-earmark-text"></i>
              </div>
              <div>
                <div class="fw-bold">Generate Daily Driver Report</div>
                <small class="text-muted">Create a summary of all driver activity</small>
              </div>
            </a>
            <a href="{{ url_for('billing_module.pm_allocation_upload') }}" class="list-group-item list-group-item-action d-flex align-items-center">
              <div class="me-3 text-success fs-5">
                <i class="bi bi-gear"></i>
              </div>
              <div>
                <div class="fw-bold">Process New Allocation Files</div>
                <small class="text-muted">Upload and process new PM allocation spreadsheets</small>
              </div>
            </a>
            <a href="{{ url_for('attendance_blueprint.dashboard') }}" class="list-group-item list-group-item-action d-flex align-items-center">
              <div class="me-3 text-info fs-5">
                <i class="bi bi-graph-up"></i>
              </div>
              <div>
                <div class="fw-bold">Attendance Trends</div>
                <small class="text-muted">View and analyze attendance patterns</small>
              </div>
            </a>
            <a href="{{ url_for('maintenance.index') }}" class="list-group-item list-group-item-action d-flex align-items-center">
              <div class="me-3 text-danger fs-5">
                <i class="bi bi-tools"></i>
              </div>
              <div>
                <div class="fw-bold">Maintenance Schedule</div>
                <small class="text-muted">Track equipment maintenance status</small>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
  // Initialize mini map
  const map = L.map('assetMap').setView([32.776665, -96.796989], 10);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);
  
  // Fetch assets for map
  fetch('/api/assets')
    .then(response => response.json())
    .then(data => {
      data.forEach(asset => {
        if (asset.lat && asset.lng) {
          const marker = L.marker([asset.lat, asset.lng]).addTo(map);
          marker.bindPopup(`<b>${asset.name}</b><br>${asset.type}<br>Status: ${asset.status}`);
        }
      });
    })
    .catch(error => console.error('Error loading assets:', error));

  // For demonstration, initialize with some sample data if needed
  const demoData = {
    months: ['January', 'February', 'March', 'April', 'May'],
    utilization: [65, 70, 73, 76, 68]
  };
  
  // Initialize utilization chart if element exists
  const utilizationChartEl = document.getElementById('utilizationChart');
  if (utilizationChartEl) {
    const utilizationChart = new Chart(utilizationChartEl, {
      type: 'line',
      data: {
        labels: demoData.months,
        datasets: [{
          label: 'Utilization %',
          data: demoData.utilization,
          backgroundColor: 'rgba(78, 115, 223, 0.2)',
          borderColor: 'rgba(78, 115, 223, 1)',
          borderWidth: 2,
          pointBackgroundColor: '#4e73df',
          pointBorderColor: '#fff',
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: false,
            min: 50,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.parsed.y + '% Utilization';
              }
            }
          }
        }
      }
    });
  }
</script>
{% endblock %}
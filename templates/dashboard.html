{% extends "base.html" %}

{% block title %}Dashboard - TRAXOVO Intelligence{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title text-primary">
                    <i class="fas fa-tachometer-alt me-2"></i>Command Console
                </h2>
                <p class="text-muted">Welcome back, {{ session.user }}. System status: <span class="badge bg-success">Operational</span></p>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-server fa-3x text-primary mb-3"></i>
                <h5 class="card-title">System Status</h5>
                <div class="badge bg-success mb-2">Online</div>
                <p class="card-text small">All systems operational</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-brain fa-3x text-info mb-3"></i>
                <h5 class="card-title">AI Modules</h5>
                <div class="badge bg-info mb-2">Active</div>
                <p class="card-text small">Intelligence systems running</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-network-wired fa-3x text-warning mb-3"></i>
                <h5 class="card-title">Network</h5>
                <div class="badge bg-warning mb-2">Connected</div>
                <p class="card-text small">HyperMesh network active</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-shield-alt fa-3x text-success mb-3"></i>
                <h5 class="card-title">Security</h5>
                <div class="badge bg-success mb-2">Secured</div>
                <p class="card-text small">All protocols active</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Real-time Analytics</h5>
            </div>
            <div class="card-body">
                <canvas id="analyticsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bell me-2"></i>System Alerts</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success alert-sm">
                    <i class="fas fa-check-circle me-2"></i>All systems operational
                </div>
                <div class="alert alert-info alert-sm">
                    <i class="fas fa-info-circle me-2"></i>Last sync: <span id="lastSync">--:--</span>
                </div>
                <div class="alert alert-warning alert-sm">
                    <i class="fas fa-exclamation-triangle me-2"></i>Scheduled maintenance in 24h
                </div>
                <a href="/ragle" class="btn btn-outline-primary w-100 mt-2">
                    <i class="fas fa-cogs me-2"></i>Access Ragle System
                </a>
                <div class="mt-2 p-2 bg-light rounded">
                    <small class="text-muted d-block mb-1"><i class="fas fa-microphone me-1"></i>Voice Commands Active</small>
                    <small class="text-success">Natural language processing enabled</small>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="testVoiceCommand('go to ragle system')">
                            <i class="fas fa-play me-1"></i>Demo: "Go to Ragle"
                        </button>
                        <button class="btn btn-sm btn-outline-success ms-1" onclick="testVoiceCommand('show system status')">
                            <i class="fas fa-play me-1"></i>Demo: "Show Status"
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <a href="/attendance" class="btn btn-outline-info w-100 btn-sm">
                            <i class="fas fa-clock me-1"></i>Attendance
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="/equipment-billing" class="btn btn-outline-info w-100 btn-sm">
                            <i class="fas fa-tools me-1"></i>Equipment
                        </a>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <a href="/job-zones" class="btn btn-outline-warning w-100 btn-sm">
                            <i class="fas fa-map-marked-alt me-1"></i>Job Zones
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="/geofences" class="btn btn-outline-warning w-100 btn-sm">
                            <i class="fas fa-shield-alt me-1"></i>Geofences
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if is_watson %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-terminal me-2"></i>Command Interface</h5>
            </div>
            <div class="card-body">
                <div id="commandOutput" class="bg-dark text-light p-3 rounded mb-3" style="height: 200px; overflow-y: auto; font-family: monospace;">
                    TRAXOVO Intelligence Console v1.0.0<br>
                    System initialized successfully.<br>
                    Ready for commands...<br>
                </div>
                <div class="input-group">
                    <span class="input-group-text">admin@traxovo:~$</span>
                    <input type="text" class="form-control" id="commandInput" placeholder="Enter command">
                    <button class="btn btn-primary" id="executeCommand">Execute</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-lock me-2"></i>Restricted Access</h5>
            </div>
            <div class="card-body text-center">
                <i class="fas fa-shield-alt fa-3x text-warning mb-3"></i>
                <h5>Command Interface</h5>
                <p class="text-muted">Access restricted to administrator clearance only</p>
                <div class="badge bg-warning">CLASSIFIED</div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize chart
const ctx = document.getElementById('analyticsChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'System Performance',
            data: [],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});

// Update chart with real-time data
function updateChart() {
    const now = new Date();
    const timeLabel = now.toLocaleTimeString();
    const value = Math.random() * 100;
    
    chart.data.labels.push(timeLabel);
    chart.data.datasets[0].data.push(value);
    
    if (chart.data.labels.length > 10) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    
    chart.update();
    document.getElementById('lastSync').textContent = timeLabel;
    console.log('Dashboard updated with real-time data');
}

// Command interface (only for Watson users)
{% if is_watson %}
document.getElementById('executeCommand').addEventListener('click', function() {
    const input = document.getElementById('commandInput');
    const output = document.getElementById('commandOutput');
    const command = input.value.trim();
    
    if (command) {
        output.innerHTML += '<br>$ ' + command + '<br>';
        
        // Simulate command responses
        switch(command.toLowerCase()) {
            case 'status':
                output.innerHTML += 'System Status: All modules operational<br>';
                break;
            case 'help':
                output.innerHTML += 'Available commands: status, help, clear, version, ragle<br>';
                break;
            case 'clear':
                output.innerHTML = 'TRAXOVO Intelligence Console v1.0.0<br>System initialized successfully.<br>Ready for commands...<br>';
                break;
            case 'version':
                output.innerHTML += 'TRAXOVO Intelligence Platform v1.0.0<br>';
                break;
            case 'ragle':
                output.innerHTML += 'Ragle System: 847 processing units active<br>';
                break;
            default:
                output.innerHTML += 'Command not found: ' + command + '<br>';
        }
        
        input.value = '';
        output.scrollTop = output.scrollHeight;
    }
});

document.getElementById('commandInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('executeCommand').click();
    }
});
{% endif %}

// Voice command demonstration function
function testVoiceCommand(command) {
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <strong><i class="fas fa-microphone me-2"></i>Processing Voice Command...</strong><br>
            <small>Command: "${command}"</small>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.appendChild(toast);
    
    fetch('/api/voice/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ text: command })
    })
    .then(response => response.json())
    .then(data => {
        toast.remove();
        
        if (data.success) {
            const result = data.result;
            const interpretation = result.command_analysis.interpretation;
            
            const successToast = document.createElement('div');
            successToast.className = 'toast-notification';
            successToast.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong><i class="fas fa-check-circle me-2"></i>Voice Command Processed</strong><br>
                    <small>Understood: ${interpretation}</small><br>
                    <small>Action: ${result.execution.message || 'Executing...'}</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(successToast);
            
            const execution = result.execution;
            if (execution.type === 'redirect') {
                setTimeout(() => {
                    window.location.href = execution.url;
                }, 2000);
            }
            
            setTimeout(() => {
                if (successToast.parentNode) {
                    successToast.remove();
                }
            }, 5000);
        } else {
            const errorToast = document.createElement('div');
            errorToast.className = 'toast-notification';
            errorToast.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong><i class="fas fa-exclamation-triangle me-2"></i>Voice Command Failed</strong><br>
                    <small>Error: ${data.error}</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(errorToast);
            
            setTimeout(() => {
                if (errorToast.parentNode) {
                    errorToast.remove();
                }
            }, 5000);
        }
    })
    .catch(error => {
        toast.remove();
        console.error('Voice command error:', error);
        
        const errorToast = document.createElement('div');
        errorToast.className = 'toast-notification';
        errorToast.innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <strong><i class="fas fa-wifi me-2"></i>Connection Error</strong><br>
                <small>Please check your connection and try again</small>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.body.appendChild(errorToast);
        
        setTimeout(() => {
            if (errorToast.parentNode) {
                errorToast.remove();
            }
        }, 5000);
    });
}

// Start real-time updates
updateChart();
setInterval(updateChart, 2000);
</script>

<style>
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
    }
    
    .toast-notification .alert {
        margin-bottom: 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAXORA - Data Upload Manager</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .upload-zone {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-zone:hover {
            border-color: #0056b3;
            background: #e3f2fd;
        }
        
        .upload-zone.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .file-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            background: white;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .file-type-badge {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .date-gap {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
        }
        
        .has-data {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .weekend {
            background: #f8f9fa;
            border-color: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-upload"></i> Data Upload Manager</h2>
                    <a href="{{ url_for('working_reports.dashboard') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Back to Reports
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Upload New Data -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cloud-upload-alt"></i> Upload New MTD Data</h5>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('data_upload.upload_files') }}" method="post" enctype="multipart/form-data" id="uploadForm">
                            <!-- Upload Zone -->
                            <div class="upload-zone" id="uploadZone">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5>Drop files here or click to browse</h5>
                                <p class="text-muted">Supports: Driving History, Activity Detail, Timecards</p>
                                <p class="text-muted">Formats: CSV, Excel (.xlsx, .xls)</p>
                                <input type="file" id="fileInput" name="files[]" multiple accept=".csv,.xlsx,.xls" style="display: none;">
                            </div>

                            <!-- Target Date Selection -->
                            <div class="mt-4">
                                <label for="targetDate" class="form-label">Target Date for Processing</label>
                                <input type="date" class="form-control" id="targetDate" name="target_date" 
                                       value="{{ datetime.now().strftime('%Y-%m-%d') }}">
                                <div class="form-text">Leave blank to auto-detect from filename</div>
                            </div>

                            <!-- Processing Options -->
                            <div class="mt-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="processImmediately" name="process_immediately" checked>
                                    <label class="form-check-label" for="processImmediately">
                                        Process immediately after upload
                                    </label>
                                </div>
                            </div>

                            <!-- File Preview -->
                            <div id="filePreview" class="mt-4" style="display: none;">
                                <h6>Selected Files:</h6>
                                <div class="file-preview" id="fileList"></div>
                            </div>

                            <!-- Submit Button -->
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                                    <i class="fas fa-upload"></i> Upload Files
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearFiles()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Gap Filling -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-calendar-check"></i> Fill Data Gaps</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Check for missing dates and upload data to fill gaps</p>
                        
                        <form action="{{ url_for('data_upload.fill_gaps') }}" method="get">
                            <div class="row">
                                <div class="col-6">
                                    <label for="startDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="startDate" name="start_date" 
                                           value="{{ (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d') }}">
                                </div>
                                <div class="col-6">
                                    <label for="endDate" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="endDate" name="end_date" 
                                           value="{{ datetime.now().strftime('%Y-%m-%d') }}">
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-search"></i> Check for Gaps
                                </button>
                            </div>
                        </form>

                        <!-- Quick Gap Check -->
                        <div class="mt-4">
                            <h6>Last 7 Days Status:</h6>
                            <div id="quickGapCheck">
                                {% for i in range(7) %}
                                {% set check_date = (datetime.now() - timedelta(days=i)).strftime('%Y-%m-%d') %}
                                <div class="date-gap {% if loop.index0 >= 5 %}weekend{% endif %}">
                                    <strong>{{ check_date }}</strong>
                                    {% if loop.index0 >= 5 %}
                                    <span class="badge bg-secondary">Weekend</span>
                                    {% else %}
                                    <span class="badge bg-success">Has Data</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Uploads -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> Recent Uploads</h5>
                    </div>
                    <div class="card-body">
                        {% if recent_files %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Filename</th>
                                        <th>Type</th>
                                        <th>Upload Date</th>
                                        <th>Size (KB)</th>
                                        <th>Extracted Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for file in recent_files %}
                                    <tr>
                                        <td>
                                            <i class="fas fa-file-alt"></i>
                                            {{ file.filename }}
                                        </td>
                                        <td>
                                            <span class="file-type-badge badge 
                                                {% if file.type == 'driving_history' %}bg-primary
                                                {% elif file.type == 'activity_detail' %}bg-success
                                                {% elif file.type == 'timecards' %}bg-info
                                                {% else %}bg-secondary{% endif %}">
                                                {{ file.type|title|replace('_', ' ') }}
                                            </span>
                                        </td>
                                        <td>{{ file.upload_date }}</td>
                                        <td>{{ file.size }}</td>
                                        <td>
                                            {% if file.extracted_date %}
                                                {{ file.extracted_date }}
                                            {% else %}
                                                <span class="text-muted">Auto-detect</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="showFileInfo('{{ file.filename }}')">
                                                <i class="fas fa-info"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="processFile('{{ file.filename }}')">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>No files uploaded yet</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // File upload handling
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const fileList = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');

        // Click to browse
        uploadZone.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            fileInput.files = e.dataTransfer.files;
            updateFilePreview();
        });

        // File selection
        fileInput.addEventListener('change', updateFilePreview);

        function updateFilePreview() {
            const files = fileInput.files;
            
            if (files.length > 0) {
                filePreview.style.display = 'block';
                fileList.innerHTML = '';
                
                Array.from(files).forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    const fileType = detectFileType(file.name);
                    const typeClass = getTypeClass(fileType);
                    
                    fileItem.innerHTML = `
                        <div>
                            <i class="fas fa-file-alt"></i>
                            <strong>${file.name}</strong>
                            <span class="file-type-badge badge ${typeClass}">${fileType}</span>
                        </div>
                        <div>
                            <small class="text-muted">${(file.size / 1024).toFixed(2)} KB</small>
                        </div>
                    `;
                    
                    fileList.appendChild(fileItem);
                });
                
                uploadBtn.disabled = false;
            } else {
                filePreview.style.display = 'none';
                uploadBtn.disabled = true;
            }
        }

        function detectFileType(filename) {
            const name = filename.toLowerCase();
            if (name.includes('driving') || name.includes('mtd')) return 'driving_history';
            if (name.includes('activity')) return 'activity_detail';
            if (name.includes('timecard')) return 'timecards';
            return 'unknown';
        }

        function getTypeClass(type) {
            switch(type) {
                case 'driving_history': return 'bg-primary';
                case 'activity_detail': return 'bg-success';
                case 'timecards': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        function clearFiles() {
            fileInput.value = '';
            filePreview.style.display = 'none';
            uploadBtn.disabled = true;
        }

        function showFileInfo(filename) {
            fetch(`/api/file-info/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}`);
                    } else {
                        let info = `File: ${data.filename}\n`;
                        info += `Type: ${data.type}\n`;
                        info += `Size: ${data.size} KB\n`;
                        info += `Upload Date: ${data.upload_date}\n`;
                        if (data.rows) info += `Rows: ${data.rows}\n`;
                        if (data.extracted_date) info += `Extracted Date: ${data.extracted_date}`;
                        
                        alert(info);
                    }
                })
                .catch(error => alert(`Error fetching file info: ${error}`));
        }

        function processFile(filename) {
            if (confirm(`Process ${filename} now?`)) {
                const targetDate = document.getElementById('targetDate').value;
                window.location.href = `/process-data?filename=${filename}&target_date=${targetDate}`;
            }
        }

        // Auto-refresh gap check every 30 seconds
        setInterval(() => {
            // Update quick gap check if needed
        }, 30000);
    </script>
</body>
</html>
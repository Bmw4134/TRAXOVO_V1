{% extends 'layout_unified_enhanced.html' %}

{% block title %}Driver-Asset Manager{% endblock %}

{% block content %}
<div class="container-fluid py-4"><div class="row mb-4"><div class="col-md-12"><div class="card border-0 shadow"><div class="card-header bg-primary text-white d-flex justify-content-between align-items-center"><h5 class="mb-0">Driver-Asset Manager</h5><div><a href="{{ url_for('driver_asset_manager.upload_assets_list') }}" class="btn btn-sm btn-light me-2"><i class="fas fa-upload"></i> Upload Assets List
</a><a href="{{ url_for('driver_asset_manager.export_driver_asset_report') }}" class="btn btn-sm btn-light me-2"><i class="fas fa-file-export"></i> Export Report
</a><a href="{{ url_for('driver_asset_manager.refresh_driver_mappings') }}" class="btn btn-sm btn-light"><i class="fas fa-sync-alt"></i> Refresh Mappings
</a></div></div><div class="card-body"><div class="row mb-4"><div class="col-md-3"><div class="card border-0 shadow-sm"><div class="card-body text-center"><h2 class="text-primary mb-2">{{ stats.total_mappings|default(0) }}</h2><p class="text-muted mb-0">Total Asset-Driver Mappings</p></div></div></div><div class="col-md-3"><div class="card border-0 shadow-sm"><div class="card-body text-center"><h2 class="text-success mb-2">{{ stats.valid_mappings|default(0) }}</h2><p class="text-muted mb-0">Valid Mappings</p></div></div></div><div class="col-md-3"><div class="card border-0 shadow-sm"><div class="card-body text-center"><h2 class="text-danger mb-2">{{ stats.issue_count|default(0) }}</h2><p class="text-muted mb-0">Mapping Issues</p></div></div></div><div class="col-md-3"><div class="card border-0 shadow-sm"><div class="card-body text-center"><h2 class="text-info mb-2"><i class="fas fa-clock"></i></h2><p class="text-muted mb-0">Last Updated: {{ stats.last_update|default('N/A') }}</p></div></div></div></div><div class="card border-0 shadow-sm mb-4"><div class="card-header bg-light"><h6 class="mb-0">Driver-Asset Mappings</h6></div><div class="card-body"><div class="table-responsive"><table class="table table-hover" id="driverAssetsTable"><thead><tr><th>Asset ID</th><th>Employee ID</th><th>Employee Name</th><th>Vehicle</th><th>Type</th></tr></thead><tbody>
{% for driver in drivers %}
<tr><td>{{ driver.asset_id }}</td><td>{{ driver.employee_id }}</td><td>{{ driver.employee_name }}</td><td>{{ driver.asset_make }} {{ driver.asset_model }}</td><td>{{ driver.asset_type }}</td></tr>
{% else %}
<tr><td colspan="5" class="text-center">No driver-asset mappings found. Please upload an assets list.</td></tr>
{% endfor %}
</tbody></table></div></div></div>


{% if issues and issues|length > 0 %}
<div class="card border-0 shadow-sm"><div class="card-header bg-light"><h6 class="mb-0">Mapping Issues</h6></div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Issue Type</th><th>Details</th></tr></thead><tbody>
{% for issue in issues %}
<tr><td>
{% if issue.type == 'duplicate_employee' %}
<span class="badge bg-warning">Duplicate Employee</span>
{% elif issue.type == 'duplicate_asset' %}
<span class="badge bg-warning">Duplicate Asset</span>
{% else %}
<span class="badge bg-warning">{{ issue.type }}</span>
{% endif %}
</td><td>
{% if issue.type == 'duplicate_employee' %}
Employee ID {{ issue.employee_id }} ({{ issue.employee_name }}) is assigned to multiple assets: {{ issue.asset1 }} and {{ issue.asset2 }}
{% elif issue.type == 'duplicate_asset' %}
Asset ID {{ issue.asset_id }} is assigned to multiple employees: {{ issue.employee1 }} and {{ issue.employee2 }}
{% else %}
{{ issue }}
{% endif %}
</td></tr>
{% endfor %}
</tbody></table></div></div></div>
{% endif %}
</div></div></div></div></div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
// Initialize DataTable if there are mappings
if ($('#driverAssetsTable tbody tr').length > 1) {
$('#driverAssetsTable').DataTable({
order: [[2, 'asc']], // Sort by employee name by default
pageLength: 15,
lengthMenu: [15, 25, 50, 100]
});
}
});
</script>
{% endblock %}
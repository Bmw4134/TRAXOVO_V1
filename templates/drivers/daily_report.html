{% extends "layout.html" %}

{% block title %}Daily Driver Report{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="display-5 mb-2">
                <i class="bi bi-calendar-day me-2"></i>Daily Driver Report
            </h1>
            <p class="lead text-muted">
                Attendance for {{ selected_date }}
            </p>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="btn-group">
                <a href="/" class="btn btn-danger">
                    <i class="bi bi-speedometer2 me-1"></i> Back to Dashboard
                </a>
                <a href="{{ url_for('driver_module.driver_list') }}" class="btn btn-info text-white">
                    <i class="bi bi-people me-1"></i> Driver List
                </a>
                <a href="{{ url_for('driver_module.attendance_dashboard') }}" class="btn btn-primary">
                    <i class="bi bi-graph-up me-1"></i> Attendance Dashboard
                </a>
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-file-earmark-arrow-down me-1"></i> Export
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><h6 class="dropdown-header">Standard Reports</h6></li>
                        <li><a class="dropdown-item" href="{{ url_for('driver_module.export_report') }}?type=daily&format=pdf">PDF Report</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('driver_module.export_report') }}?type=daily&format=csv">CSV Data</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('driver_module.export_report') }}?type=daily&format=xlsx">Excel Spreadsheet</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Daily Driver Reports</h6></li>
                        <li><a class="dropdown-item" href="{{ url_for('driver_exports.daily_driver_report') }}?export_time=8am&date={{ report.date }}&format=xlsx">
                            <i class="bi bi-clock"></i> 8AM Report
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('driver_exports.daily_driver_report') }}?export_time=9am&date={{ report.date }}&format=xlsx">
                            <i class="bi bi-clock"></i> 9AM Report
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('driver_exports.daily_driver_report') }}?export_time=8am&date={{ report.date }}&format=xlsx&direct=true">
                            <i class="bi bi-download"></i> Direct 8AM Download
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('driver_exports.daily_driver_report') }}?export_time=9am&date={{ report.date }}&format=xlsx&direct=true">
                            <i class="bi bi-download"></i> Direct 9AM Download
                        </a></li>
                    </ul>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-envelope me-1"></i> Email
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><h6 class="dropdown-header">Send Report By Email</h6></li>
                        <li><a class="dropdown-item" href="{{ url_for('driver_exports.email_driver_report') }}?export_time=8am&date={{ report.date }}">
                            <i class="bi bi-clock"></i> Email 8AM Report
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('driver_exports.email_driver_report') }}?export_time=9am&date={{ report.date }}">
                            <i class="bi bi-clock"></i> Email 9AM Report
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#emailConfigModal">
                            <i class="bi bi-gear"></i> Configure Email Recipients
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Selection Form -->
    <div class="row mb-4">
        <div class="col-md-6 offset-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form class="row g-3" action="{{ url_for('driver_module.daily_report') }}" method="get">
                        <div class="col-md-8">
                            <label for="date" class="form-label">Select Date</label>
                            <input type="date" class="form-control" id="date" name="date" value="{{ selected_date }}">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">View Report</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Animation Container -->
    <div class="row mb-4" id="report-loading-container">
        <div class="col-12 text-center">
            <div id="report-loading" class="loading-placeholder" 
                 data-loader-type="mixer" 
                 data-loader-message="Loading daily attendance data...">
            </div>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="row mb-4" id="summary-cards" style="display: none;">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <h1 class="display-4 mb-0">{{ report.summary.total_drivers }}</h1>
                    <h5 class="card-title">Total Drivers</h5>
                    <p class="mb-0">{{ report.divisions|length }} Divisions</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center">
                    <h1 class="display-4 mb-0">{{ report.summary.on_time_drivers }}</h1>
                    <h5 class="card-title">On Time</h5>
                    <p class="mb-0">{{ (report.summary.on_time_drivers / report.summary.total_drivers * 100)|round|int if report.summary.total_drivers > 0 else 0 }}% of drivers</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body text-center">
                    <h1 class="display-4 mb-0">{{ report.summary.late_drivers + report.summary.early_end_drivers }}</h1>
                    <h5 class="card-title">Attendance Issues</h5>
                    <p class="mb-0">{{ report.summary.late_drivers }} Late, {{ report.summary.early_end_drivers }} Early</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-danger text-white h-100">
                <div class="card-body text-center">
                    <h1 class="display-4 mb-0">{{ report.summary.not_on_job_drivers }}</h1>
                    <h5 class="card-title">Not on Job</h5>
                    <p class="mb-0">Requires follow-up</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs for Different Issues -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="late-tab" data-bs-toggle="tab" data-bs-target="#late" type="button" role="tab" aria-controls="late" aria-selected="true">
                                <i class="bi bi-clock-history me-1"></i> Late Start <span class="badge bg-danger ms-1">{{ report.late_drivers|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="early-tab" data-bs-toggle="tab" data-bs-target="#early" type="button" role="tab" aria-controls="early" aria-selected="false">
                                <i class="bi bi-clock me-1"></i> Early End <span class="badge bg-danger ms-1">{{ report.early_end_drivers|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="absent-tab" data-bs-toggle="tab" data-bs-target="#absent" type="button" role="tab" aria-controls="absent" aria-selected="false">
                                <i class="bi bi-exclamation-triangle me-1"></i> Not on Job <span class="badge bg-danger ms-1">{{ report.not_on_job_drivers|length }}</span>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="myTabContent">
                        <!-- Late Start Tab -->
                        <div class="tab-pane fade show active" id="late" role="tabpanel" aria-labelledby="late-tab">
                            {% if report.late_drivers %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Employee ID</th>
                                                <th>Driver Name</th>
                                                <th>Region</th>
                                                <th>Job Site</th>
                                                <th>Scheduled Start</th>
                                                <th>Actual Start</th>
                                                <th>Minutes Late</th>
                                                <th>Vehicle</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for driver in report.late_drivers|sort(attribute='minutes_late', reverse=true) %}
                                                <tr>
                                                    <td>{{ driver.employee_id }}</td>
                                                    <td>
                                                        <a href="{{ url_for('driver_module.driver_detail', driver_id=driver.id) }}">
                                                            {{ driver.name }}
                                                        </a>
                                                    </td>
                                                    <td>{{ driver.region }}</td>
                                                    <td>{{ driver.job_site }}</td>
                                                    <td>{{ driver.scheduled_start }}</td>
                                                    <td class="text-danger">{{ driver.actual_start }}</td>
                                                    <td class="text-danger fw-bold">{{ driver.minutes_late }}</td>
                                                    <td>{{ driver.vehicle }}</td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button type="button" class="btn btn-outline-primary notify-btn" data-driver-id="{{ driver.id }}">
                                                                <i class="bi bi-bell"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-success excuse-btn" data-driver-id="{{ driver.id }}">
                                                                <i class="bi bi-check2-circle"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-danger flag-btn" data-driver-id="{{ driver.id }}">
                                                                <i class="bi bi-flag"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle-fill me-2"></i> No late drivers today!
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Early End Tab -->
                        <div class="tab-pane fade" id="early" role="tabpanel" aria-labelledby="early-tab">
                            {% if report.early_end_drivers %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Employee ID</th>
                                                <th>Driver Name</th>
                                                <th>Region</th>
                                                <th>Job Site</th>
                                                <th>Scheduled End</th>
                                                <th>Actual End</th>
                                                <th>Minutes Early</th>
                                                <th>Vehicle</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for driver in report.early_end_drivers|sort(attribute='minutes_early', reverse=true) %}
                                                <tr>
                                                    <td>{{ driver.employee_id }}</td>
                                                    <td>
                                                        <a href="{{ url_for('driver_module.driver_detail', driver_id=driver.id) }}">
                                                            {{ driver.name }}
                                                        </a>
                                                    </td>
                                                    <td>{{ driver.region }}</td>
                                                    <td>{{ driver.job_site }}</td>
                                                    <td>{{ driver.scheduled_end }}</td>
                                                    <td class="text-danger">{{ driver.actual_end }}</td>
                                                    <td class="text-danger fw-bold">{{ driver.minutes_early }}</td>
                                                    <td>{{ driver.vehicle }}</td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button type="button" class="btn btn-outline-primary notify-btn" data-driver-id="{{ driver.id }}">
                                                                <i class="bi bi-bell"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-success excuse-btn" data-driver-id="{{ driver.id }}">
                                                                <i class="bi bi-check2-circle"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-danger flag-btn" data-driver-id="{{ driver.id }}">
                                                                <i class="bi bi-flag"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle-fill me-2"></i> No early end drivers today!
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Not on Job Tab -->
                        <div class="tab-pane fade" id="absent" role="tabpanel" aria-labelledby="absent-tab">
                            {% if report.not_on_job_drivers %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Employee ID</th>
                                                <th>Driver Name</th>
                                                <th>Region</th>
                                                <th>Job Site</th>
                                                <th>Scheduled Start</th>
                                                <th>Vehicle</th>
                                                <th>Reason</th>
                                                <th>Notes</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for driver in report.not_on_job_drivers %}
                                                <tr>
                                                    <td>{{ driver.employee_id }}</td>
                                                    <td>
                                                        <a href="{{ url_for('driver_module.driver_detail', driver_id=driver.id) }}">
                                                            {{ driver.name }}
                                                        </a>
                                                    </td>
                                                    <td>{{ driver.region }}</td>
                                                    <td>{{ driver.job_site }}</td>
                                                    <td>{{ driver.scheduled_start }}</td>
                                                    <td>{{ driver.vehicle }}</td>
                                                    <td class="text-danger">{{ driver.reason }}</td>
                                                    <td>{{ driver.notes }}</td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button type="button" class="btn btn-outline-primary contact-btn" data-driver-id="{{ driver.id }}">
                                                                <i class="bi bi-telephone"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-warning reassign-btn" data-driver-id="{{ driver.id }}">
                                                                <i class="bi bi-arrow-left-right"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-danger escalate-btn" data-driver-id="{{ driver.id }}">
                                                                <i class="bi bi-exclamation-circle"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle-fill me-2"></i> No absent drivers today!
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Modals -->
<!-- Excuse Modal -->
<div class="modal fade" id="excuseModal" tabindex="-1" aria-labelledby="excuseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="excuseModalLabel">Record Excused Absence</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="excuse-form">
                    <input type="hidden" id="excuse-driver-id" name="driver_id">
                    
                    <div class="mb-3">
                        <label for="excuse-reason" class="form-label">Reason</label>
                        <select class="form-select" id="excuse-reason" name="reason" required>
                            <option value="" selected disabled>Select a reason</option>
                            <option value="Traffic">Traffic Conditions</option>
                            <option value="Weather">Weather Conditions</option>
                            <option value="Vehicle">Vehicle Issues</option>
                            <option value="Medical">Medical Appointment</option>
                            <option value="Family">Family Emergency</option>
                            <option value="Other">Other (specify in notes)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="excuse-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="excuse-notes" name="notes" rows="3" placeholder="Enter any additional details..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="excuse-supervisor" name="supervisor_approved">
                            <label class="form-check-label" for="excuse-supervisor">
                                Supervisor Approved
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="save-excuse-btn">Save Excuse</button>
            </div>
        </div>
    </div>
</div>

<!-- Flag Modal -->
<div class="modal fade" id="flagModal" tabindex="-1" aria-labelledby="flagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="flagModalLabel">Flag Attendance Issue</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="flag-form">
                    <input type="hidden" id="flag-driver-id" name="driver_id">
                    
                    <div class="mb-3">
                        <label for="flag-severity" class="form-label">Severity</label>
                        <select class="form-select" id="flag-severity" name="severity" required>
                            <option value="" selected disabled>Select severity</option>
                            <option value="Low">Low - First Occurrence</option>
                            <option value="Medium">Medium - Repeat Occurrence</option>
                            <option value="High">High - Multiple Occurrences</option>
                            <option value="Critical">Critical - Requires Immediate Action</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="flag-action" class="form-label">Recommended Action</label>
                        <select class="form-select" id="flag-action" name="action" required>
                            <option value="" selected disabled>Select action</option>
                            <option value="Monitor">Monitor</option>
                            <option value="Verbal Warning">Verbal Warning</option>
                            <option value="Written Warning">Written Warning</option>
                            <option value="Performance Review">Performance Review</option>
                            <option value="Disciplinary Action">Disciplinary Action</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="flag-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="flag-notes" name="notes" rows="3" placeholder="Enter any additional details..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="flag-notify-supervisor" name="notify_supervisor" checked>
                            <label class="form-check-label" for="flag-notify-supervisor">
                                Notify Supervisor
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="save-flag-btn">Save Flag</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Show loading animation and hide content initially
        const reportLoadingContainer = document.getElementById('report-loading-container');
        const summaryCardsContainer = document.getElementById('summary-cards');
        const tabsContainer = document.querySelector('.card-header-tabs').closest('.row');
        
        // Simulate loading delay (remove in production and use real data loading event)
        setTimeout(function() {
            // Hide loader
            reportLoadingContainer.style.display = 'none';
            
            // Show content with fade-in effect
            summaryCardsContainer.style.display = 'flex';
            summaryCardsContainer.classList.add('fade-in');
            tabsContainer.classList.add('fade-in');
        }, 1500);
        
        // Handle excuse button clicks
        const excuseButtons = document.querySelectorAll('.excuse-btn');
        const excuseModal = new bootstrap.Modal(document.getElementById('excuseModal'));
        const excuseDriverIdInput = document.getElementById('excuse-driver-id');
        const saveExcuseBtn = document.getElementById('save-excuse-btn');
        
        excuseButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const driverId = this.dataset.driverId;
                excuseDriverIdInput.value = driverId;
                excuseModal.show();
            });
        });
        
        saveExcuseBtn.addEventListener('click', function() {
            const excuseForm = document.getElementById('excuse-form');
            
            if (!excuseForm.checkValidity()) {
                excuseForm.reportValidity();
                return;
            }
            
            // In a real application, this would save the excuse to the server
            // For demo purposes, we'll just show a success message
            excuseModal.hide();
            alert('Excuse recorded successfully');
        });
        
        // Handle flag button clicks
        const flagButtons = document.querySelectorAll('.flag-btn');
        const flagModal = new bootstrap.Modal(document.getElementById('flagModal'));
        const flagDriverIdInput = document.getElementById('flag-driver-id');
        const saveFlagBtn = document.getElementById('save-flag-btn');
        
        flagButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const driverId = this.dataset.driverId;
                flagDriverIdInput.value = driverId;
                flagModal.show();
            });
        });
        
        saveFlagBtn.addEventListener('click', function() {
            const flagForm = document.getElementById('flag-form');
            
            if (!flagForm.checkValidity()) {
                flagForm.reportValidity();
                return;
            }
            
            // In a real application, this would save the flag to the server
            // For demo purposes, we'll just show a success message
            flagModal.hide();
            alert('Flag recorded successfully');
        });
        
        // Handle notify button clicks
        const notifyButtons = document.querySelectorAll('.notify-btn');
        notifyButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const driverId = this.dataset.driverId;
                // In a real application, this would send a notification to the driver
                alert(`Notification sent to driver ${driverId}`);
            });
        });
        
        // Handle contact button clicks
        const contactButtons = document.querySelectorAll('.contact-btn');
        contactButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const driverId = this.dataset.driverId;
                // In a real application, this would open contact options
                alert(`Contact options for driver ${driverId}`);
            });
        });
        
        // Handle reassign button clicks
        const reassignButtons = document.querySelectorAll('.reassign-btn');
        reassignButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const driverId = this.dataset.driverId;
                // In a real application, this would open reassignment options
                alert(`Reassignment options for driver ${driverId}`);
            });
        });
        
        // Handle escalate button clicks
        const escalateButtons = document.querySelectorAll('.escalate-btn');
        escalateButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const driverId = this.dataset.driverId;
                // In a real application, this would escalate the issue
                alert(`Issue escalated for driver ${driverId}`);
            });
        });
    });
    
    // Email configuration functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Save email configuration
        const saveEmailConfigBtn = document.getElementById('saveEmailConfig');
        if (saveEmailConfigBtn) {
            saveEmailConfigBtn.addEventListener('click', function() {
                document.getElementById('emailConfigForm').submit();
            });
        }
        
        // Email send modal setup
        const emailSendModal = document.getElementById('emailSendModal');
        if (emailSendModal) {
            emailSendModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const reportType = button.getAttribute('data-report-type');
                document.getElementById('emailReportType').value = reportType;
                document.getElementById('emailSubject').value = `${reportType.toUpperCase()} Daily Driver Report - {{ report.formatted_date }}`;
            });
        }
        
        // Send email button
        const sendEmailBtn = document.getElementById('sendEmailBtn');
        if (sendEmailBtn) {
            sendEmailBtn.addEventListener('click', function() {
                const reportType = document.getElementById('emailReportType').value;
                const emailTo = document.getElementById('emailTo').value;
                
                // Construct URL with parameters
                let url = `{{ url_for('driver_exports.email_driver_report') }}?export_time=${reportType}&date={{ report.date }}`;
                
                // Add email parameter if provided
                if (emailTo) {
                    url += `&email=${encodeURIComponent(emailTo)}`;
                }
                
                // Navigate to the URL which will trigger the email send
                window.location.href = url;
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('emailSendModal'));
                if (modal) {
                    modal.hide();
                }
            });
        }
        
        // Add click handlers for the email dropdown items to show the send modal
        const email8amItems = document.querySelectorAll('a[href*="email_driver_report"][href*="export_time=8am"]');
        const email9amItems = document.querySelectorAll('a[href*="email_driver_report"][href*="export_time=9am"]');
        
        email8amItems.forEach(item => {
            item.setAttribute('data-bs-toggle', 'modal');
            item.setAttribute('data-bs-target', '#emailSendModal');
            item.setAttribute('data-report-type', '8am');
            item.href = '#';
        });
        
        email9amItems.forEach(item => {
            item.setAttribute('data-bs-toggle', 'modal');
            item.setAttribute('data-bs-target', '#emailSendModal');
            item.setAttribute('data-report-type', '9am');
            item.href = '#';
        });
    });
</script>

<!-- Email Configuration Modal -->
<div class="modal fade" id="emailConfigModal" tabindex="-1" aria-labelledby="emailConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="emailConfigModalLabel"><i class="bi bi-envelope-fill me-2"></i>Configure Email Recipients</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="emailConfigForm" action="{{ url_for('driver_module.daily_report') }}" method="post">
                    <input type="hidden" name="action" value="save_email_config">
                    <div class="mb-3">
                        <label for="email8am" class="form-label">8 AM Report Recipients</label>
                        <textarea class="form-control" id="email8am" name="email8am" rows="3" placeholder="Enter email addresses separated by commas">{{ email_config.get('8am', '') }}</textarea>
                        <div class="form-text">Who should receive the 8 AM daily driver report?</div>
                    </div>
                    <div class="mb-3">
                        <label for="email9am" class="form-label">9 AM Report Recipients</label>
                        <textarea class="form-control" id="email9am" name="email9am" rows="3" placeholder="Enter email addresses separated by commas">{{ email_config.get('9am', '') }}</textarea>
                        <div class="form-text">Who should receive the 9 AM daily driver report?</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="includeCurrentUser" name="includeCurrentUser" checked>
                        <label class="form-check-label" for="includeCurrentUser">Always include my email</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="automaticSend" name="automaticSend">
                        <label class="form-check-label" for="automaticSend">Send reports automatically daily</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEmailConfig">Save Configuration</button>
            </div>
        </div>
    </div>
</div>

<!-- Email Send Modal -->
<div class="modal fade" id="emailSendModal" tabindex="-1" aria-labelledby="emailSendModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="emailSendModalLabel"><i class="bi bi-send me-2"></i>Send Report Email</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="emailSendForm">
                    <input type="hidden" id="emailReportType" name="reportType" value="8am">
                    <div class="mb-3">
                        <label for="emailTo" class="form-label">Send To</label>
                        <input type="text" class="form-control" id="emailTo" name="emailTo" placeholder="Enter email addresses separated by commas">
                        <div class="form-text">Leave blank to use saved recipient list</div>
                    </div>
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="emailSubject" name="emailSubject" value="Daily Driver Report - {{ report.formatted_date }}" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info text-white" id="sendEmailBtn">Send Email</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
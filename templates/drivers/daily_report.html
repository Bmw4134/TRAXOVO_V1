{% extends "base.html" %}

{% block title %}Daily Driver Report - {{ selected_date }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Daily Driver Report - {{ selected_date }}</h5>
                    <form method="GET" action="{{ url_for('driver_module.daily_report') }}" class="d-flex">
                        <input type="date" name="date" class="form-control form-control-sm me-2" value="{{ report.date }}" required>
                        <button type="submit" class="btn btn-sm btn-light">View Report</button>
                    </form>
                </div>
                <div class="card-body">
                    {% if report.get('error') %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i> {{ report.error }}
                    </div>
                    {% endif %}
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Summary</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Total Drivers</label>
                                                <h3>{{ report.summary.total_drivers }}</h3>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">On Time</label>
                                                <h3>{{ report.summary.on_time_drivers }}</h3>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Late</label>
                                                <h4 class="text-warning">{{ report.summary.late_drivers }}</h4>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Early End</label>
                                                <h4 class="text-info">{{ report.summary.early_end_drivers }}</h4>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="mb-3">
                                                <label class="form-label text-muted">Not On Job</label>
                                                <h4 class="text-danger">{{ report.summary.not_on_job_drivers }}</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Export Options</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            {% if report.files.excel_exists %}
                                            <a href="{{ report.files.excel_path }}" class="btn btn-success w-100">
                                                <i class="bi bi-file-earmark-excel me-1"></i> Download Excel Report
                                            </a>
                                            {% else %}
                                            <button class="btn btn-success w-100" disabled>
                                                <i class="bi bi-file-earmark-excel me-1"></i> Excel Not Available
                                            </button>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            {% if report.files.pdf_exists %}
                                            <a href="{{ url_for('driver_module.view_pdf_report', date_str=report.date) }}" class="btn btn-secondary w-100">
                                                <i class="bi bi-eye me-1"></i> View PDF Report
                                            </a>
                                            {% else %}
                                            <button class="btn btn-secondary w-100" disabled>
                                                <i class="bi bi-eye me-1"></i> PDF Preview Not Available
                                            </button>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            {% if report.files.pdf_exists %}
                                            <a href="{{ report.files.pdf_path }}" class="btn btn-danger w-100">
                                                <i class="bi bi-file-earmark-pdf me-1"></i> Download PDF Report
                                            </a>
                                            {% else %}
                                            <button class="btn btn-danger w-100" disabled>
                                                <i class="bi bi-file-earmark-pdf me-1"></i> PDF Not Available
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mt-3 d-flex">
                                        <button type="button" class="btn btn-outline-primary me-2 flex-grow-1" data-bs-toggle="modal" data-bs-target="#emailConfigModal">
                                            <i class="bi bi-gear me-1"></i> Email Settings
                                        </button>
                                        <button type="button" class="btn btn-primary flex-grow-1" data-bs-toggle="modal" data-bs-target="#sendEmailModal">
                                            <i class="bi bi-envelope me-1"></i> Send Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Late Arrivals Section -->
                    {% if report.late_morning %}
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Late Arrivals ({{ report.late_morning|length }})</h6>
                            <span class="badge bg-dark">{{ report.summary.late_drivers }} Drivers</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Driver</th>
                                            <th>Asset ID</th>
                                            <th>Scheduled Start</th>
                                            <th>Actual Start</th>
                                            <th>Minutes Late</th>
                                            <th>Job Site</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for record in report.late_morning %}
                                        <tr>
                                            <td>{{ record.driver_name }}</td>
                                            <td>{{ record.asset_id }}</td>
                                            <td>{{ record.scheduled_start }}</td>
                                            <td>{{ record.actual_start }}</td>
                                            <td>{{ record.minutes_late }}</td>
                                            <td>{{ record.job_site }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Early Departures Section -->
                    {% if report.early_departures %}
                    <div class="card mb-4">
                        <div class="card-header bg-info text-dark d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Early Departures ({{ report.early_departures|length }})</h6>
                            <span class="badge bg-dark">{{ report.summary.early_end_drivers }} Drivers</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Driver</th>
                                            <th>Asset ID</th>
                                            <th>Scheduled End</th>
                                            <th>Actual End</th>
                                            <th>Minutes Early</th>
                                            <th>Job Site</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for record in report.early_departures %}
                                        <tr>
                                            <td>{{ record.driver_name }}</td>
                                            <td>{{ record.asset_id }}</td>
                                            <td>{{ record.scheduled_end }}</td>
                                            <td>{{ record.actual_end }}</td>
                                            <td>{{ record.minutes_early }}</td>
                                            <td>{{ record.job_site }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Not On Job Section -->
                    {% if report.not_on_job_drivers %}
                    <div class="card mb-4">
                        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Not On Job ({{ report.not_on_job_drivers|length }})</h6>
                            <span class="badge bg-light text-dark">{{ report.summary.not_on_job_drivers }} Drivers</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Driver</th>
                                            <th>Asset ID</th>
                                            <th>Scheduled Job</th>
                                            <th>Current Location</th>
                                            <th>Distance (miles)</th>
                                            <th>Last Update</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for record in report.not_on_job_drivers %}
                                        <tr>
                                            <td>{{ record.driver_name }}</td>
                                            <td>{{ record.asset_id }}</td>
                                            <td>{{ record.job_site }}</td>
                                            <td>{{ record.current_location }}</td>
                                            <td>{{ record.distance_from_job }}</td>
                                            <td>{{ record.last_update }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Configuration Modal -->
<div class="modal fade" id="emailConfigModal" tabindex="-1" aria-labelledby="emailConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailConfigModalLabel">Email Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('driver_module.daily_report', date=report.date) }}">
                <input type="hidden" name="action" value="update_email">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="recipients" class="form-label">Recipients</label>
                        <input type="text" class="form-control" id="recipients" name="recipients" value="{{ email_config.recipients }}">
                        <div class="form-text">Separate multiple email addresses with commas</div>
                    </div>
                    <div class="mb-3">
                        <label for="cc" class="form-label">CC</label>
                        <input type="text" class="form-control" id="cc" name="cc" value="{{ email_config.cc }}">
                    </div>
                    <div class="mb-3">
                        <label for="bcc" class="form-label">BCC</label>
                        <input type="text" class="form-control" id="bcc" name="bcc" value="{{ email_config.bcc }}">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="auto_send" name="auto_send" {% if email_config.auto_send %}checked{% endif %}>
                        <label class="form-check-label" for="auto_send">Automatically send daily report</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="include_user" name="include_user" {% if email_config.include_user %}checked{% endif %}>
                        <label class="form-check-label" for="include_user">Include my email address</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Send Email Modal -->
<div class="modal fade" id="sendEmailModal" tabindex="-1" aria-labelledby="sendEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('driver_module.daily_report', date=report.date) }}">
                <input type="hidden" name="action" value="send_email">
                <div class="modal-header">
                    <h5 class="modal-title" id="sendEmailModalLabel">Send Daily Driver Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i> Send the Daily Driver Report for {{ report.formatted_date }} via email.
                    </div>
                    
                    <div class="mb-3">
                        <label for="send_recipients" class="form-label">Recipients <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="send_recipients" name="recipients" value="{{ email_config.recipients }}" required>
                        <div class="form-text">Separate multiple email addresses with commas</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="send_cc" class="form-label">CC</label>
                        <input type="text" class="form-control" id="send_cc" name="cc" value="{{ email_config.cc }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="send_bcc" class="form-label">BCC</label>
                        <input type="text" class="form-control" id="send_bcc" name="bcc" value="{{ email_config.bcc }}">
                    </div>
                    
                    <div class="mb-3">
                        <strong>Attachments:</strong>
                        <ul class="list-group mt-2">
                            {% if report.files.excel_exists %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-file-earmark-excel me-2 text-success"></i> Excel Report</span>
                                <span class="badge bg-success rounded-pill">Included</span>
                            </li>
                            {% else %}
                            <li class="list-group-item d-flex justify-content-between align-items-center text-muted">
                                <span><i class="bi bi-file-earmark-excel me-2"></i> Excel Report</span>
                                <span class="badge bg-secondary rounded-pill">Not Available</span>
                            </li>
                            {% endif %}
                            
                            {% if report.files.pdf_exists %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-file-earmark-pdf me-2 text-danger"></i> PDF Report</span>
                                <span class="badge bg-success rounded-pill">Included</span>
                            </li>
                            {% else %}
                            <li class="list-group-item d-flex justify-content-between align-items-center text-muted">
                                <span><i class="bi bi-file-earmark-pdf me-2"></i> PDF Report</span>
                                <span class="badge bg-secondary rounded-pill">Not Available</span>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-envelope me-1"></i> Send Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Format the date input with the current report date
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.querySelector('input[name="date"]');
        if (dateInput) {
            // Make sure the date is in yyyy-MM-dd format
            const reportDate = "{{ report.date }}";
            dateInput.value = reportDate;
        }
    });
</script>
{% endblock %}
{% extends 'layout.html' %}

{% block title %}Driver Reports{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4 mb-4">Driver Reports</h1>
    
    <!-- Module Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="driverReportsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="drivers-tab" data-bs-toggle="tab" href="#drivers" role="tab" aria-controls="drivers" aria-selected="false">Drivers</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="job-sites-tab" data-bs-toggle="tab" href="#job-sites" role="tab" aria-controls="job-sites" aria-selected="false">Job Sites</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="reports-tab" data-bs-toggle="tab" href="#reports" role="tab" aria-controls="reports" aria-selected="false">Reports</a>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="driverReportsTabsContent">
        <!-- Dashboard Tab -->
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Filters</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="dateRangeFilter" class="form-label">Date Range</label>
                                        <select class="form-select" id="dateRangeFilter">
                                            <option>Today</option>
                                            <option>Yesterday</option>
                                            <option selected>Last 7 Days</option>
                                            <option>This Month</option>
                                            <option>Last Month</option>
                                            <option>Custom Range</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="divisionFilter" class="form-label">Division</label>
                                        <select class="form-select" id="divisionFilter">
                                            <option selected>All Divisions</option>
                                            <option>DFW</option>
                                            <option>HOU</option>
                                            <option>WT</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="departmentFilter" class="form-label">Department</label>
                                        <select class="form-select" id="departmentFilter">
                                            <option selected>All Departments</option>
                                            <option>Heavy Equipment</option>
                                            <option>Light Duty</option>
                                            <option>Maintenance</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="issueTypeFilter" class="form-label">Issue Type</label>
                                        <select class="form-select" id="issueTypeFilter">
                                            <option selected>All Issues</option>
                                            <option>Late Start</option>
                                            <option>Early End</option>
                                            <option>Not On Job</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-secondary me-2">Reset</button>
                                <button class="btn btn-primary">Apply Filters</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- KPI Summary Cards -->
            <div class="row mb-4" id="kpiCards">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h4>Late Starts</h4>
                            <div class="display-4 text-danger">--</div>
                            <div class="small text-muted">
                                <span class="trend-indicator"></span>
                                <span class="trend-value"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h4>Early Ends</h4>
                            <div class="display-4 text-warning">--</div>
                            <div class="small text-muted">
                                <span class="trend-indicator"></span>
                                <span class="trend-value"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h4>Not On Job</h4>
                            <div class="display-4 text-danger">--</div>
                            <div class="small text-muted">
                                <span class="trend-indicator"></span>
                                <span class="trend-value"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h4>On-Time Rate</h4>
                            <div class="display-4 text-success">--</div>
                            <div class="small text-muted">
                                <span class="trend-indicator"></span>
                                <span class="trend-value"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trend Chart -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Attendance Trends (Last 30 Days)</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="attendanceTrendChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Issues Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Recent Attendance Issues</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" id="downloadRecentIssues">
                                    <i class="bi bi-download"></i> Download
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="recentIssuesTable">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Driver</th>
                                            <th>Asset ID</th>
                                            <th>Job Site</th>
                                            <th>Issue Type</th>
                                            <th>Expected</th>
                                            <th>Actual</th>
                                            <th>Difference</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="9" class="text-center">Loading data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Recent issues pagination">
                                <ul class="pagination justify-content-end" id="recentIssuesPagination">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Drivers Tab -->
        <div class="tab-pane fade" id="drivers" role="tabpanel" aria-labelledby="drivers-tab">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Filters</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="driverDivisionFilter" class="form-label">Division</label>
                                        <select class="form-select" id="driverDivisionFilter">
                                            <option selected>All Divisions</option>
                                            <option>DFW</option>
                                            <option>HOU</option>
                                            <option>WT</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="driverDepartmentFilter" class="form-label">Department</label>
                                        <select class="form-select" id="driverDepartmentFilter">
                                            <option selected>All Departments</option>
                                            <option>Heavy Equipment</option>
                                            <option>Light Duty</option>
                                            <option>Maintenance</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="driverSearch" class="form-label">Search</label>
                                        <input type="text" class="form-control" id="driverSearch" placeholder="Search by name or ID...">
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-secondary me-2">Reset</button>
                                <button class="btn btn-primary">Apply Filters</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Drivers Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Driver List</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" id="downloadDrivers">
                                    <i class="bi bi-download"></i> Download
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="driversTable">
                                    <thead>
                                        <tr>
                                            <th>Employee ID</th>
                                            <th>Name</th>
                                            <th>Division</th>
                                            <th>Department</th>
                                            <th>Current Asset</th>
                                            <th>Current Job</th>
                                            <th>Attendance Score</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="9" class="text-center">Loading data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Drivers pagination">
                                <ul class="pagination justify-content-end" id="driversPagination">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Job Sites Tab -->
        <div class="tab-pane fade" id="job-sites" role="tabpanel" aria-labelledby="job-sites-tab">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Filters</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="jobSiteDateRange" class="form-label">Date Range</label>
                                        <select class="form-select" id="jobSiteDateRange">
                                            <option>Today</option>
                                            <option>Yesterday</option>
                                            <option>Last 7 Days</option>
                                            <option selected>Last 30 Days</option>
                                            <option>This Month</option>
                                            <option>Last Month</option>
                                            <option>Custom Range</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="jobSiteDivision" class="form-label">Division</label>
                                        <select class="form-select" id="jobSiteDivision">
                                            <option selected>All Divisions</option>
                                            <option>DFW</option>
                                            <option>HOU</option>
                                            <option>WT</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="jobSiteSearch" class="form-label">Search</label>
                                        <input type="text" class="form-control" id="jobSiteSearch" placeholder="Search by job number or name...">
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-secondary me-2">Reset</button>
                                <button class="btn btn-primary">Apply Filters</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Job Sites Map -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Job Site Map</h5>
                        </div>
                        <div class="card-body">
                            <div id="jobSiteMap" style="height: 400px;">
                                <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                                    <p class="text-muted">Map loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Job Sites Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Job Sites Summary</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" id="downloadJobSites">
                                    <i class="bi bi-download"></i> Download
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="jobSitesTable">
                                    <thead>
                                        <tr>
                                            <th>Job Number</th>
                                            <th>Name/Location</th>
                                            <th>Division</th>
                                            <th>Active Drivers</th>
                                            <th>Late Starts</th>
                                            <th>Early Ends</th>
                                            <th>Not On Job</th>
                                            <th>Attendance Score</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="9" class="text-center">Loading data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Job sites pagination">
                                <ul class="pagination justify-content-end" id="jobSitesPagination">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Report Configuration</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="reportType" class="form-label">Report Type</label>
                                        <select class="form-select" id="reportType">
                                            <option selected>Daily Driver Report</option>
                                            <option>Weekly Summary</option>
                                            <option>Driver Performance</option>
                                            <option>Job Site Performance</option>
                                            <option>Monthly Executive Summary</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="reportDateRange" class="form-label">Date Range</label>
                                        <select class="form-select" id="reportDateRange">
                                            <option>Today</option>
                                            <option>Yesterday</option>
                                            <option selected>Last 7 Days</option>
                                            <option>Last 30 Days</option>
                                            <option>This Month</option>
                                            <option>Last Month</option>
                                            <option>Custom Range</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="reportDivision" class="form-label">Division</label>
                                        <select class="form-select" id="reportDivision">
                                            <option selected>All Divisions</option>
                                            <option>DFW</option>
                                            <option>HOU</option>
                                            <option>WT</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="reportFormat" class="form-label">Format</label>
                                        <select class="form-select" id="reportFormat">
                                            <option selected>Excel (.xlsx)</option>
                                            <option>CSV (.csv)</option>
                                            <option>PDF (.pdf)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                                        <label class="form-check-label" for="includeCharts">Include Charts</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="includeRawData" checked>
                                        <label class="form-check-label" for="includeRawData">Include Raw Data</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end mt-3">
                                <button class="btn btn-outline-success me-2" id="exportAttendanceCSV">
                                    <i class="bi bi-filetype-csv me-1"></i> Export CSV
                                </button>
                                <button class="btn btn-outline-success me-2" id="exportAttendanceExcel">
                                    <i class="bi bi-file-earmark-excel me-1"></i> Export Excel
                                </button>
                                <button class="btn btn-primary" id="generateReport">
                                    <i class="bi bi-file-earmark-text me-1"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Standard Reports -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Standard Reports</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Daily Driver Summary</h5>
                                            <p class="card-text text-muted">Comprehensive overview of all driver attendance for today.</p>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="daily_driver" data-report-format="excel">Excel</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="daily_driver" data-report-format="csv">CSV</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="daily_driver" data-report-format="pdf">PDF</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Weekly Attendance Trends</h5>
                                            <p class="card-text text-muted">Week-over-week analysis of attendance patterns.</p>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="weekly_summary" data-report-format="excel">Excel</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="weekly_summary" data-report-format="csv">CSV</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="weekly_summary" data-report-format="pdf">PDF</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Job Site Performance</h5>
                                            <p class="card-text text-muted">Attendance metrics broken down by job site.</p>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="job_site_performance" data-report-format="excel">Excel</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="job_site_performance" data-report-format="csv">CSV</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="job_site_performance" data-report-format="pdf">PDF</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Driver Performance Report</h5>
                                            <p class="card-text text-muted">Individual performance metrics for all drivers.</p>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="driver_performance" data-report-format="excel">Excel</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="driver_performance" data-report-format="csv">CSV</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="driver_performance" data-report-format="pdf">PDF</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Monthly Executive Summary</h5>
                                            <p class="card-text text-muted">High-level overview for management review.</p>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="executive_summary" data-report-format="excel">Excel</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="executive_summary" data-report-format="csv">CSV</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="executive_summary" data-report-format="pdf">PDF</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Division Comparison</h5>
                                            <p class="card-text text-muted">Compare attendance metrics across divisions.</p>
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="division_comparison" data-report-format="excel">Excel</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="division_comparison" data-report-format="csv">CSV</button>
                                                <button class="btn btn-sm btn-outline-secondary" data-report-type="division_comparison" data-report-format="pdf">PDF</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scheduled Reports -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Scheduled Reports</h5>
                            <button class="btn btn-sm btn-outline-primary" id="createScheduleBtn">Create Schedule</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="scheduledReportsTable">
                                    <thead>
                                        <tr>
                                            <th>Report Name</th>
                                            <th>Frequency</th>
                                            <th>Recipients</th>
                                            <th>Format</th>
                                            <th>Last Sent</th>
                                            <th>Next Scheduled</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="7" class="text-center">No scheduled reports</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Driver Detail -->
<div class="modal fade" id="driverDetailModal" tabindex="-1" aria-labelledby="driverDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="driverDetailModalLabel">Driver Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading driver details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="generateDriverReportBtn">Generate Report</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Job Site Detail -->
<div class="modal fade" id="jobSiteDetailModal" tabindex="-1" aria-labelledby="jobSiteDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobSiteDetailModalLabel">Job Site Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading job site details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="generateJobSiteReportBtn">Generate Report</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // Initialize dashboard when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Load initial KPI data
        loadKpiData();
        
        // Load initial trend chart
        loadTrendChart();
        
        // Load initial recent issues
        loadRecentIssues(1);
        
        // Load drivers list when the drivers tab is shown
        document.getElementById('drivers-tab').addEventListener('shown.bs.tab', function(e) {
            loadDrivers(1);
        });
        
        // Load job sites when the job sites tab is shown
        document.getElementById('job-sites-tab').addEventListener('shown.bs.tab', function(e) {
            loadJobSites(1);
        });
        
        // Event listener for dashboard filter application
        document.querySelector('#dashboard .btn-primary').addEventListener('click', function() {
            loadKpiData();
            loadTrendChart();
            loadRecentIssues(1);
        });
        
        // Event listener for dashboard filter reset
        document.querySelector('#dashboard .btn-secondary').addEventListener('click', function() {
            document.getElementById('dateRangeFilter').value = 'Last 7 Days';
            document.getElementById('divisionFilter').value = 'All Divisions';
            document.getElementById('departmentFilter').value = 'All Departments';
            document.getElementById('issueTypeFilter').value = 'All Issues';
            
            loadKpiData();
            loadTrendChart();
            loadRecentIssues(1);
        });
        
        // Event listener for drivers filter application
        document.querySelector('#drivers .btn-primary').addEventListener('click', function() {
            loadDrivers(1);
        });
        
        // Event listener for drivers filter reset
        document.querySelector('#drivers .btn-secondary').addEventListener('click', function() {
            document.getElementById('driverDivisionFilter').value = 'All Divisions';
            document.getElementById('driverDepartmentFilter').value = 'All Departments';
            document.getElementById('driverSearch').value = '';
            
            loadDrivers(1);
        });
        
        // Event listener for job sites filter application
        document.querySelector('#job-sites .btn-primary').addEventListener('click', function() {
            loadJobSites(1);
        });
        
        // Event listener for job sites filter reset
        document.querySelector('#job-sites .btn-secondary').addEventListener('click', function() {
            document.getElementById('jobSiteDateRange').value = 'Last 30 Days';
            document.getElementById('jobSiteDivision').value = 'All Divisions';
            document.getElementById('jobSiteSearch').value = '';
            
            loadJobSites(1);
        });
        
        // Event listener for report generation
        document.getElementById('generateReport').addEventListener('click', function() {
            generateReport();
        });
        
        // Event listeners for attendance data export
        document.getElementById('exportAttendanceCSV').addEventListener('click', function() {
            exportAttendanceData('csv');
        });
        
        document.getElementById('exportAttendanceExcel').addEventListener('click', function() {
            exportAttendanceData('excel');
        });
        
        // Event listeners for standard report buttons
        document.querySelectorAll('[data-report-type]').forEach(function(button) {
            button.addEventListener('click', function() {
                const reportType = this.getAttribute('data-report-type');
                const reportFormat = this.getAttribute('data-report-format');
                generateStandardReport(reportType, reportFormat);
            });
        });
    });
    
    // Function to load KPI data for the dashboard
    function loadKpiData() {
        const dateRange = document.getElementById('dateRangeFilter').value.toLowerCase().replace(/\s+/g, '_');
        const division = document.getElementById('divisionFilter').value.toLowerCase().replace(/\s+/g, '_');
        const department = document.getElementById('departmentFilter').value.toLowerCase().replace(/\s+/g, '_');
        const issueType = document.getElementById('issueTypeFilter').value.toLowerCase().replace(/\s+/g, '_');
        
        // Show loading state
        const kpiCards = document.querySelectorAll('#kpiCards .display-4');
        kpiCards.forEach(function(card) {
            card.textContent = '--';
        });
        
        // Clear trend indicators
        const trendIndicators = document.querySelectorAll('#kpiCards .trend-indicator');
        const trendValues = document.querySelectorAll('#kpiCards .trend-value');
        trendIndicators.forEach(function(indicator) {
            indicator.textContent = '';
        });
        trendValues.forEach(function(value) {
            value.textContent = '';
        });
        
        // Fetch KPI data from API
        fetch(`/drivers/dashboard/kpi-data?date_range=${dateRange}&division=${division}&department=${department}&issue_type=${issueType}`)
            .then(response => response.json())
            .then(data => {
                // Update late starts
                const lateStartsCard = document.querySelectorAll('#kpiCards .display-4')[0];
                lateStartsCard.textContent = data.late_starts.value;
                
                // Update late starts trend
                const lateStartsTrendIndicator = document.querySelectorAll('#kpiCards .trend-indicator')[0];
                const lateStartsTrendValue = document.querySelectorAll('#kpiCards .trend-value')[0];
                updateTrendIndicator(lateStartsTrendIndicator, lateStartsTrendValue, data.late_starts.trend, data.late_starts.trend_direction);
                
                // Update early ends
                const earlyEndsCard = document.querySelectorAll('#kpiCards .display-4')[1];
                earlyEndsCard.textContent = data.early_ends.value;
                
                // Update early ends trend
                const earlyEndsTrendIndicator = document.querySelectorAll('#kpiCards .trend-indicator')[1];
                const earlyEndsTrendValue = document.querySelectorAll('#kpiCards .trend-value')[1];
                updateTrendIndicator(earlyEndsTrendIndicator, earlyEndsTrendValue, data.early_ends.trend, data.early_ends.trend_direction);
                
                // Update not on job
                const notOnJobCard = document.querySelectorAll('#kpiCards .display-4')[2];
                notOnJobCard.textContent = data.not_on_job.value;
                
                // Update not on job trend
                const notOnJobTrendIndicator = document.querySelectorAll('#kpiCards .trend-indicator')[2];
                const notOnJobTrendValue = document.querySelectorAll('#kpiCards .trend-value')[2];
                updateTrendIndicator(notOnJobTrendIndicator, notOnJobTrendValue, data.not_on_job.trend, data.not_on_job.trend_direction);
                
                // Update on-time rate
                const onTimeRateCard = document.querySelectorAll('#kpiCards .display-4')[3];
                onTimeRateCard.textContent = `${data.on_time_rate.value}%`;
                
                // Update on-time rate trend
                const onTimeRateTrendIndicator = document.querySelectorAll('#kpiCards .trend-indicator')[3];
                const onTimeRateTrendValue = document.querySelectorAll('#kpiCards .trend-value')[3];
                updateTrendIndicator(onTimeRateTrendIndicator, onTimeRateTrendValue, data.on_time_rate.trend, data.on_time_rate.trend_direction);
            })
            .catch(error => {
                console.error('Error loading KPI data:', error);
                alert('Failed to load KPI data. Please try again.');
            });
    }
    
    // Function to update trend indicators
    function updateTrendIndicator(indicator, valueElement, trend, direction) {
        if (direction === 'up') {
            indicator.innerHTML = '<i class="bi bi-arrow-up-right"></i>';
            indicator.className = 'trend-indicator text-danger';
        } else if (direction === 'down') {
            indicator.innerHTML = '<i class="bi bi-arrow-down-right"></i>';
            indicator.className = 'trend-indicator text-success';
        } else {
            indicator.innerHTML = '<i class="bi bi-arrow-right"></i>';
            indicator.className = 'trend-indicator text-muted';
        }
        
        valueElement.textContent = `${Math.abs(trend)}% from previous period`;
    }
    
    // Function to load trend chart
    function loadTrendChart() {
        const days = 30; // Default to 30 days for trend chart
        const division = document.getElementById('divisionFilter').value.toLowerCase().replace(/\s+/g, '_');
        const department = document.getElementById('departmentFilter').value.toLowerCase().replace(/\s+/g, '_');
        
        // Destroy existing chart if it exists
        if (window.attendanceChart) {
            window.attendanceChart.destroy();
        }
        
        // Show loading state
        document.getElementById('attendanceTrendChart').style.opacity = 0.5;
        
        // Fetch trend data from API
        fetch(`/drivers/dashboard/trend-data?days=${days}&division=${division}&department=${department}`)
            .then(response => response.json())
            .then(data => {
                // Prepare chart data
                const labels = data.map(item => {
                    const date = new Date(item.date);
                    return date.toLocaleDateString();
                });
                
                const datasets = [
                    {
                        label: 'Late Starts',
                        data: data.map(item => item.late_starts),
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.1
                    },
                    {
                        label: 'Early Ends',
                        data: data.map(item => item.early_ends),
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.1
                    },
                    {
                        label: 'Not On Job',
                        data: data.map(item => item.not_on_job),
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.1
                    }
                ];
                
                // Create chart
                const ctx = document.getElementById('attendanceTrendChart').getContext('2d');
                window.attendanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
                
                // Reset opacity
                document.getElementById('attendanceTrendChart').style.opacity = 1;
            })
            .catch(error => {
                console.error('Error loading trend data:', error);
                alert('Failed to load trend data. Please try again.');
                document.getElementById('attendanceTrendChart').style.opacity = 1;
            });
    }
    
    // Function to load recent issues
    function loadRecentIssues(page) {
        const dateRange = document.getElementById('dateRangeFilter').value.toLowerCase().replace(/\s+/g, '_');
        const division = document.getElementById('divisionFilter').value.toLowerCase().replace(/\s+/g, '_');
        const department = document.getElementById('departmentFilter').value.toLowerCase().replace(/\s+/g, '_');
        const issueType = document.getElementById('issueTypeFilter').value.toLowerCase().replace(/\s+/g, '_');
        
        // Show loading state
        const tableBody = document.querySelector('#recentIssuesTable tbody');
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center">Loading data...</td></tr>';
        
        // Fetch recent issues from API
        fetch(`/drivers/dashboard/recent-issues?date_range=${dateRange}&division=${division}&department=${department}&issue_type=${issueType}&page=${page}&per_page=10`)
            .then(response => response.json())
            .then(data => {
                if (data.data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="9" class="text-center">No issues found matching the current filters</td></tr>';
                    return;
                }
                
                // Populate table with data
                tableBody.innerHTML = '';
                data.data.forEach(issue => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${issue.date}</td>
                        <td>${issue.driver}</td>
                        <td>${issue.asset_id}</td>
                        <td>${issue.job_site}</td>
                        <td><span class="badge ${getBadgeClass(issue.issue_type)}">${issue.issue_type}</span></td>
                        <td>${issue.expected}</td>
                        <td>${issue.actual}</td>
                        <td>${issue.difference}</td>
                        <td><button class="btn btn-sm btn-outline-info view-issue-btn" data-issue-id="${issue.id}">View</button></td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Set up pagination
                const pagination = document.getElementById('recentIssuesPagination');
                pagination.innerHTML = '';
                
                // Previous button
                const prevItem = document.createElement('li');
                prevItem.className = `page-item ${page === 1 ? 'disabled' : ''}`;
                const prevLink = document.createElement('a');
                prevLink.className = 'page-link';
                prevLink.href = '#';
                prevLink.textContent = 'Previous';
                if (page > 1) {
                    prevLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadRecentIssues(page - 1);
                    });
                }
                prevItem.appendChild(prevLink);
                pagination.appendChild(prevItem);
                
                // Page numbers
                for (let i = 1; i <= data.pages; i++) {
                    const pageItem = document.createElement('li');
                    pageItem.className = `page-item ${i === page ? 'active' : ''}`;
                    const pageLink = document.createElement('a');
                    pageLink.className = 'page-link';
                    pageLink.href = '#';
                    pageLink.textContent = i;
                    pageLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadRecentIssues(i);
                    });
                    pageItem.appendChild(pageLink);
                    pagination.appendChild(pageItem);
                }
                
                // Next button
                const nextItem = document.createElement('li');
                nextItem.className = `page-item ${page === data.pages ? 'disabled' : ''}`;
                const nextLink = document.createElement('a');
                nextLink.className = 'page-link';
                nextLink.href = '#';
                nextLink.textContent = 'Next';
                if (page < data.pages) {
                    nextLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadRecentIssues(page + 1);
                    });
                }
                nextItem.appendChild(nextLink);
                pagination.appendChild(nextItem);
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-issue-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const issueId = this.getAttribute('data-issue-id');
                        // Open issue details modal
                        // For now, let's just show an alert
                        alert(`Viewing issue ${issueId}`);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading recent issues:', error);
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
            });
    }
    
    // Function to get badge class based on issue type
    function getBadgeClass(issueType) {
        switch (issueType) {
            case 'Late Start':
                return 'bg-danger';
            case 'Early End':
                return 'bg-warning';
            case 'Not On Job':
                return 'bg-danger';
            default:
                return 'bg-success';
        }
    }
    
    // Function to load drivers list
    function loadDrivers(page) {
        const division = document.getElementById('driverDivisionFilter').value.toLowerCase().replace(/\s+/g, '_');
        const department = document.getElementById('driverDepartmentFilter').value.toLowerCase().replace(/\s+/g, '_');
        const search = document.getElementById('driverSearch').value;
        
        // Show loading state
        const tableBody = document.querySelector('#driversTable tbody');
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center">Loading data...</td></tr>';
        
        // Fetch drivers from API
        fetch(`/drivers/api/drivers?division=${division}&department=${department}&search=${search}&page=${page}&per_page=10`)
            .then(response => response.json())
            .then(data => {
                if (data.data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="9" class="text-center">No drivers found matching the current filters</td></tr>';
                    return;
                }
                
                // Populate table with data
                tableBody.innerHTML = '';
                data.data.forEach(driver => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${driver.employee_id}</td>
                        <td>${driver.name}</td>
                        <td>${driver.division || '-'}</td>
                        <td>${driver.department || '-'}</td>
                        <td>${driver.current_asset || '-'}</td>
                        <td>${driver.current_job || '-'}</td>
                        <td>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar ${getScoreClass(driver.attendance_score)}" role="progressbar" style="width: ${driver.attendance_score}%;" aria-valuenow="${driver.attendance_score}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small>${driver.attendance_score}%</small>
                        </td>
                        <td><span class="badge ${driver.is_active ? 'bg-success' : 'bg-secondary'}">${driver.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td><button class="btn btn-sm btn-outline-info view-driver-btn" data-driver-id="${driver.id}">View</button></td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Set up pagination
                const pagination = document.getElementById('driversPagination');
                pagination.innerHTML = '';
                
                // Previous button
                const prevItem = document.createElement('li');
                prevItem.className = `page-item ${page === 1 ? 'disabled' : ''}`;
                const prevLink = document.createElement('a');
                prevLink.className = 'page-link';
                prevLink.href = '#';
                prevLink.textContent = 'Previous';
                if (page > 1) {
                    prevLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadDrivers(page - 1);
                    });
                }
                prevItem.appendChild(prevLink);
                pagination.appendChild(prevItem);
                
                // Page numbers
                for (let i = 1; i <= data.pages; i++) {
                    const pageItem = document.createElement('li');
                    pageItem.className = `page-item ${i === page ? 'active' : ''}`;
                    const pageLink = document.createElement('a');
                    pageLink.className = 'page-link';
                    pageLink.href = '#';
                    pageLink.textContent = i;
                    pageLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadDrivers(i);
                    });
                    pageItem.appendChild(pageLink);
                    pagination.appendChild(pageItem);
                }
                
                // Next button
                const nextItem = document.createElement('li');
                nextItem.className = `page-item ${page === data.pages ? 'disabled' : ''}`;
                const nextLink = document.createElement('a');
                nextLink.className = 'page-link';
                nextLink.href = '#';
                nextLink.textContent = 'Next';
                if (page < data.pages) {
                    nextLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadDrivers(page + 1);
                    });
                }
                nextItem.appendChild(nextLink);
                pagination.appendChild(nextItem);
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-driver-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const driverId = this.getAttribute('data-driver-id');
                        showDriverDetails(driverId);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading drivers:', error);
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
            });
    }
    
    // Function to get score class based on attendance score
    function getScoreClass(score) {
        if (score >= 90) {
            return 'bg-success';
        } else if (score >= 75) {
            return 'bg-warning';
        } else {
            return 'bg-danger';
        }
    }
    
    // Function to show driver details
    function showDriverDetails(driverId) {
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('driverDetailModal'));
        modal.show();
        
        // Reset modal content
        const modalBody = document.querySelector('#driverDetailModal .modal-body');
        modalBody.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading driver details...</p>
            </div>
        `;
        
        // Set driver ID to the generate report button
        document.getElementById('generateDriverReportBtn').setAttribute('data-driver-id', driverId);
        
        // Fetch driver details
        fetch(`/drivers/api/driver/${driverId}/metrics`)
            .then(response => response.json())
            .then(data => {
                // Update modal title
                document.getElementById('driverDetailModalLabel').textContent = `Driver Details: ${data.driver.name}`;
                
                // Create content
                let content = `
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Driver Information</h5>
                                    <table class="table">
                                        <tr>
                                            <th>Employee ID:</th>
                                            <td>${data.driver.employee_id}</td>
                                        </tr>
                                        <tr>
                                            <th>Name:</th>
                                            <td>${data.driver.name}</td>
                                        </tr>
                                        <tr>
                                            <th>Division:</th>
                                            <td>${data.driver.division || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>Department:</th>
                                            <td>${data.driver.department || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>Current Asset:</th>
                                            <td>${data.driver.current_asset || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>Current Job:</th>
                                            <td>${data.driver.current_job || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>Status:</th>
                                            <td><span class="badge ${data.driver.is_active ? 'bg-success' : 'bg-secondary'}">${data.driver.is_active ? 'Active' : 'Inactive'}</span></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Attendance Score</h5>
                                            <div class="display-4 ${getScoreClass(data.metrics.attendance_score.value)}">${data.metrics.attendance_score.value}%</div>
                                            <div class="small text-muted">
                                                ${getTrendIndicator(data.metrics.attendance_score.trend, data.metrics.attendance_score.trend_direction)}
                                                ${Math.abs(data.metrics.attendance_score.trend)}% from previous period
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Late Starts</h5>
                                            <div class="display-4 text-danger">${data.metrics.late_starts.value}</div>
                                            <div class="small text-muted">
                                                ${getTrendIndicator(data.metrics.late_starts.trend, data.metrics.late_starts.trend_direction)}
                                                ${Math.abs(data.metrics.late_starts.trend)}% from previous period
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Early Ends</h5>
                                            <div class="display-4 text-warning">${data.metrics.early_ends.value}</div>
                                            <div class="small text-muted">
                                                ${getTrendIndicator(data.metrics.early_ends.trend, data.metrics.early_ends.trend_direction)}
                                                ${Math.abs(data.metrics.early_ends.trend)}% from previous period
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Not On Job</h5>
                                            <div class="display-4 text-danger">${data.metrics.not_on_job.value}</div>
                                            <div class="small text-muted">
                                                ${getTrendIndicator(data.metrics.not_on_job.trend, data.metrics.not_on_job.trend_direction)}
                                                ${Math.abs(data.metrics.not_on_job.trend)}% from previous period
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add attendance chart placeholder
                content += `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Attendance Performance (Last 90 Days)</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="driverAttendanceChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add attendance history placeholder
                content += `
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Attendance History</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary" id="downloadAttendanceHistory">
                                            <i class="bi bi-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="attendanceHistoryTable">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Asset ID</th>
                                                    <th>Job Site</th>
                                                    <th>Start Time</th>
                                                    <th>End Time</th>
                                                    <th>Status</th>
                                                    <th>Notes</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="7" class="text-center">Loading attendance history...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <nav aria-label="Attendance history pagination">
                                        <ul class="pagination justify-content-end" id="attendanceHistoryPagination">
                                            <li class="page-item disabled">
                                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                                            </li>
                                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                            <li class="page-item disabled">
                                                <a class="page-link" href="#">Next</a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Update modal content
                modalBody.innerHTML = content;
                
                // Load attendance chart
                loadDriverAttendanceChart(driverId);
                
                // Load attendance history
                loadAttendanceHistory(driverId, 1);
            })
            .catch(error => {
                console.error('Error loading driver details:', error);
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        Failed to load driver details. Please try again.
                    </div>
                `;
            });
    }
    
    // Function to get trend indicator HTML
    function getTrendIndicator(trend, direction) {
        if (direction === 'up') {
            return '<i class="bi bi-arrow-up-right text-danger"></i>';
        } else if (direction === 'down') {
            return '<i class="bi bi-arrow-down-right text-success"></i>';
        } else {
            return '<i class="bi bi-arrow-right text-muted"></i>';
        }
    }
    
    // Function to load driver attendance chart
    function loadDriverAttendanceChart(driverId) {
        // Default to 90 days for attendance chart
        fetch(`/drivers/api/driver/${driverId}/attendance-chart?days=90`)
            .then(response => response.json())
            .then(data => {
                // Prepare chart data
                const labels = data.map(item => {
                    const date = new Date(item.date);
                    return date.toLocaleDateString();
                });
                
                const datasets = [
                    {
                        label: 'Attendance Score',
                        data: data.map(item => item.score),
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Issues',
                        data: data.map(item => item.late_starts + item.early_ends + item.not_on_job),
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }
                ];
                
                // Create chart
                const ctx = document.getElementById('driverAttendanceChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Score (%)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Issue Count'
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading attendance chart data:', error);
                document.getElementById('driverAttendanceChart').innerHTML = `
                    <div class="alert alert-danger">
                        Failed to load attendance chart. Please try again.
                    </div>
                `;
            });
    }
    
    // Function to load attendance history
    function loadAttendanceHistory(driverId, page) {
        const tableBody = document.querySelector('#attendanceHistoryTable tbody');
        
        // Show loading state
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Loading attendance history...</td></tr>';
        
        // Fetch attendance history
        fetch(`/drivers/api/driver/${driverId}/attendance-history?days=30&page=${page}&per_page=10`)
            .then(response => response.json())
            .then(data => {
                if (data.data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No attendance records found</td></tr>';
                    return;
                }
                
                // Populate table with data
                tableBody.innerHTML = '';
                data.data.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.asset_id || '-'}</td>
                        <td>${record.job_site}</td>
                        <td>${record.start_time || '-'}</td>
                        <td>${record.end_time || '-'}</td>
                        <td><span class="badge ${getStatusBadgeClass(record.status)}">${record.status}</span></td>
                        <td>${record.notes || '-'}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Set up pagination
                const pagination = document.getElementById('attendanceHistoryPagination');
                pagination.innerHTML = '';
                
                // Previous button
                const prevItem = document.createElement('li');
                prevItem.className = `page-item ${page === 1 ? 'disabled' : ''}`;
                const prevLink = document.createElement('a');
                prevLink.className = 'page-link';
                prevLink.href = '#';
                prevLink.textContent = 'Previous';
                if (page > 1) {
                    prevLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadAttendanceHistory(driverId, page - 1);
                    });
                }
                prevItem.appendChild(prevLink);
                pagination.appendChild(prevItem);
                
                // Page numbers
                for (let i = 1; i <= data.pages; i++) {
                    const pageItem = document.createElement('li');
                    pageItem.className = `page-item ${i === page ? 'active' : ''}`;
                    const pageLink = document.createElement('a');
                    pageLink.className = 'page-link';
                    pageLink.href = '#';
                    pageLink.textContent = i;
                    pageLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadAttendanceHistory(driverId, i);
                    });
                    pageItem.appendChild(pageLink);
                    pagination.appendChild(pageItem);
                }
                
                // Next button
                const nextItem = document.createElement('li');
                nextItem.className = `page-item ${page === data.pages ? 'disabled' : ''}`;
                const nextLink = document.createElement('a');
                nextLink.className = 'page-link';
                nextLink.href = '#';
                nextLink.textContent = 'Next';
                if (page < data.pages) {
                    nextLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadAttendanceHistory(driverId, page + 1);
                    });
                }
                nextItem.appendChild(nextLink);
                pagination.appendChild(nextItem);
            })
            .catch(error => {
                console.error('Error loading attendance history:', error);
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading attendance history. Please try again.</td></tr>';
            });
    }
    
    // Function to get status badge class
    function getStatusBadgeClass(status) {
        switch (status) {
            case 'On Time':
                return 'bg-success';
            case 'Late Start':
                return 'bg-danger';
            case 'Early End':
                return 'bg-warning';
            case 'Wrong Job':
                return 'bg-danger';
            default:
                return 'bg-secondary';
        }
    }
    
    // Function to load job sites
    function loadJobSites(page) {
        const dateRange = document.getElementById('jobSiteDateRange').value.toLowerCase().replace(/\s+/g, '_');
        const division = document.getElementById('jobSiteDivision').value.toLowerCase().replace(/\s+/g, '_');
        const search = document.getElementById('jobSiteSearch').value;
        
        // Show loading state
        const tableBody = document.querySelector('#jobSitesTable tbody');
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center">Loading data...</td></tr>';
        
        // Fetch job sites from API
        fetch(`/drivers/api/job-sites?date_range=${dateRange}&division=${division}&search=${search}&page=${page}&per_page=10`)
            .then(response => response.json())
            .then(data => {
                if (data.data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="9" class="text-center">No job sites found matching the current filters</td></tr>';
                    return;
                }
                
                // Populate table with data
                tableBody.innerHTML = '';
                data.data.forEach(jobSite => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${jobSite.job_number}</td>
                        <td>${jobSite.name || jobSite.location || '-'}</td>
                        <td>${jobSite.division || '-'}</td>
                        <td>${jobSite.active_drivers}</td>
                        <td>${jobSite.late_starts}</td>
                        <td>${jobSite.early_ends}</td>
                        <td>${jobSite.not_on_job}</td>
                        <td>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar ${getScoreClass(jobSite.attendance_score)}" role="progressbar" style="width: ${jobSite.attendance_score}%;" aria-valuenow="${jobSite.attendance_score}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small>${jobSite.attendance_score}%</small>
                        </td>
                        <td><button class="btn btn-sm btn-outline-info view-job-site-btn" data-job-site-id="${jobSite.id}">View</button></td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Set up pagination
                const pagination = document.getElementById('jobSitesPagination');
                pagination.innerHTML = '';
                
                // Previous button
                const prevItem = document.createElement('li');
                prevItem.className = `page-item ${page === 1 ? 'disabled' : ''}`;
                const prevLink = document.createElement('a');
                prevLink.className = 'page-link';
                prevLink.href = '#';
                prevLink.textContent = 'Previous';
                if (page > 1) {
                    prevLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadJobSites(page - 1);
                    });
                }
                prevItem.appendChild(prevLink);
                pagination.appendChild(prevItem);
                
                // Page numbers
                for (let i = 1; i <= data.pages; i++) {
                    const pageItem = document.createElement('li');
                    pageItem.className = `page-item ${i === page ? 'active' : ''}`;
                    const pageLink = document.createElement('a');
                    pageLink.className = 'page-link';
                    pageLink.href = '#';
                    pageLink.textContent = i;
                    pageLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadJobSites(i);
                    });
                    pageItem.appendChild(pageLink);
                    pagination.appendChild(pageItem);
                }
                
                // Next button
                const nextItem = document.createElement('li');
                nextItem.className = `page-item ${page === data.pages ? 'disabled' : ''}`;
                const nextLink = document.createElement('a');
                nextLink.className = 'page-link';
                nextLink.href = '#';
                nextLink.textContent = 'Next';
                if (page < data.pages) {
                    nextLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadJobSites(page + 1);
                    });
                }
                nextItem.appendChild(nextLink);
                pagination.appendChild(nextItem);
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-job-site-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const jobSiteId = this.getAttribute('data-job-site-id');
                        showJobSiteDetails(jobSiteId);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading job sites:', error);
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
            });
    }
    
    // Function to show job site details
    function showJobSiteDetails(jobSiteId) {
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('jobSiteDetailModal'));
        modal.show();
        
        // Reset modal content
        const modalBody = document.querySelector('#jobSiteDetailModal .modal-body');
        modalBody.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading job site details...</p>
            </div>
        `;
        
        // Set job site ID to the generate report button
        document.getElementById('generateJobSiteReportBtn').setAttribute('data-job-site-id', jobSiteId);
        
        // Fetch job site details
        fetch(`/drivers/api/job-site/${jobSiteId}/metrics`)
            .then(response => response.json())
            .then(data => {
                // Update modal title
                document.getElementById('jobSiteDetailModalLabel').textContent = `Job Site Details: ${data.job_site.job_number}`;
                
                // Create content similar to driver details
                // For brevity, this is simplified. In a real implementation, this would be more detailed.
                let content = `
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Job Site Information</h5>
                                    <table class="table">
                                        <tr>
                                            <th>Job Number:</th>
                                            <td>${data.job_site.job_number}</td>
                                        </tr>
                                        <tr>
                                            <th>Name:</th>
                                            <td>${data.job_site.name || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>Location:</th>
                                            <td>${data.job_site.location || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>Division:</th>
                                            <td>${data.job_site.division || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th>Active Drivers:</th>
                                            <td>${data.job_site.active_drivers}</td>
                                        </tr>
                                        <tr>
                                            <th>Status:</th>
                                            <td><span class="badge ${data.job_site.is_active ? 'bg-success' : 'bg-secondary'}">${data.job_site.is_active ? 'Active' : 'Inactive'}</span></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Attendance Score</h5>
                                            <div class="display-4 ${getScoreClass(data.metrics.attendance_score.value)}">${data.metrics.attendance_score.value}%</div>
                                            <div class="small text-muted">
                                                ${getTrendIndicator(data.metrics.attendance_score.trend, data.metrics.attendance_score.trend_direction)}
                                                ${Math.abs(data.metrics.attendance_score.trend)}% from previous period
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Late Starts</h5>
                                            <div class="display-4 text-danger">${data.metrics.late_starts.value}</div>
                                            <div class="small text-muted">
                                                ${getTrendIndicator(data.metrics.late_starts.trend, data.metrics.late_starts.trend_direction)}
                                                ${Math.abs(data.metrics.late_starts.trend)}% from previous period
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Early Ends</h5>
                                            <div class="display-4 text-warning">${data.metrics.early_ends.value}</div>
                                            <div class="small text-muted">
                                                ${getTrendIndicator(data.metrics.early_ends.trend, data.metrics.early_ends.trend_direction)}
                                                ${Math.abs(data.metrics.early_ends.trend)}% from previous period
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <h5 class="card-title">Not On Job</h5>
                                            <div class="display-4 text-danger">${data.metrics.not_on_job.value}</div>
                                            <div class="small text-muted">
                                                ${getTrendIndicator(data.metrics.not_on_job.trend, data.metrics.not_on_job.trend_direction)}
                                                ${Math.abs(data.metrics.not_on_job.trend)}% from previous period
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add attendance history for this job site
                content += `
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Attendance History</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary" id="downloadJobSiteAttendance">
                                            <i class="bi bi-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="jobSiteAttendanceTable">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Driver</th>
                                                    <th>Asset ID</th>
                                                    <th>Start Time</th>
                                                    <th>End Time</th>
                                                    <th>Status</th>
                                                    <th>Notes</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="7" class="text-center">Loading attendance history...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <nav aria-label="Job site attendance pagination">
                                        <ul class="pagination justify-content-end" id="jobSiteAttendancePagination">
                                            <li class="page-item disabled">
                                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                                            </li>
                                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                            <li class="page-item disabled">
                                                <a class="page-link" href="#">Next</a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Update modal content
                modalBody.innerHTML = content;
                
                // Load job site attendance history
                loadJobSiteAttendanceHistory(jobSiteId, 1);
            })
            .catch(error => {
                console.error('Error loading job site details:', error);
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        Failed to load job site details. Please try again.
                    </div>
                `;
            });
    }
    
    // Function to load job site attendance history
    function loadJobSiteAttendanceHistory(jobSiteId, page) {
        const tableBody = document.querySelector('#jobSiteAttendanceTable tbody');
        
        // Show loading state
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Loading attendance history...</td></tr>';
        
        // Fetch attendance history
        fetch(`/drivers/api/job-site/${jobSiteId}/attendance-history?days=30&page=${page}&per_page=10`)
            .then(response => response.json())
            .then(data => {
                if (data.data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No attendance records found</td></tr>';
                    return;
                }
                
                // Populate table with data
                tableBody.innerHTML = '';
                data.data.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.driver}</td>
                        <td>${record.asset_id || '-'}</td>
                        <td>${record.start_time || '-'}</td>
                        <td>${record.end_time || '-'}</td>
                        <td><span class="badge ${getStatusBadgeClass(record.status)}">${record.status}</span></td>
                        <td>${record.notes || '-'}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Set up pagination
                const pagination = document.getElementById('jobSiteAttendancePagination');
                pagination.innerHTML = '';
                
                // Previous button
                const prevItem = document.createElement('li');
                prevItem.className = `page-item ${page === 1 ? 'disabled' : ''}`;
                const prevLink = document.createElement('a');
                prevLink.className = 'page-link';
                prevLink.href = '#';
                prevLink.textContent = 'Previous';
                if (page > 1) {
                    prevLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadJobSiteAttendanceHistory(jobSiteId, page - 1);
                    });
                }
                prevItem.appendChild(prevLink);
                pagination.appendChild(prevItem);
                
                // Page numbers
                for (let i = 1; i <= data.pages; i++) {
                    const pageItem = document.createElement('li');
                    pageItem.className = `page-item ${i === page ? 'active' : ''}`;
                    const pageLink = document.createElement('a');
                    pageLink.className = 'page-link';
                    pageLink.href = '#';
                    pageLink.textContent = i;
                    pageLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadJobSiteAttendanceHistory(jobSiteId, i);
                    });
                    pageItem.appendChild(pageLink);
                    pagination.appendChild(pageItem);
                }
                
                // Next button
                const nextItem = document.createElement('li');
                nextItem.className = `page-item ${page === data.pages ? 'disabled' : ''}`;
                const nextLink = document.createElement('a');
                nextLink.className = 'page-link';
                nextLink.href = '#';
                nextLink.textContent = 'Next';
                if (page < data.pages) {
                    nextLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        loadJobSiteAttendanceHistory(jobSiteId, page + 1);
                    });
                }
                nextItem.appendChild(nextLink);
                pagination.appendChild(nextItem);
            })
            .catch(error => {
                console.error('Error loading job site attendance history:', error);
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading attendance history. Please try again.</td></tr>';
            });
    }
    
    // Function to generate a report
    function generateReport() {
        const reportType = document.getElementById('reportType').value.toLowerCase().replace(/\s+/g, '_');
        const dateRange = document.getElementById('reportDateRange').value.toLowerCase().replace(/\s+/g, '_');
        const division = document.getElementById('reportDivision').value.toLowerCase().replace(/\s+/g, '_');
        const format = document.getElementById('reportFormat').value.split(' ')[0].toLowerCase();
        const includeCharts = document.getElementById('includeCharts').checked;
        const includeRawData = document.getElementById('includeRawData').checked;
        
        // Call the API to generate the report
        fetch('/drivers/api/report/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                report_type: reportType,
                date_range: dateRange,
                division: division,
                format: format,
                include_charts: includeCharts,
                include_raw_data: includeRawData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Open the report in a new tab
                window.open(data.file_url, '_blank');
            } else {
                alert('Failed to generate report: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error generating report:', error);
            alert('Failed to generate report. Please try again.');
        });
    }
    
    // Function to generate a standard report
    function generateStandardReport(reportType, format) {
        // Call the API to generate the report
        fetch('/drivers/api/report/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                report_type: reportType,
                format: format,
                include_charts: true,
                include_raw_data: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Open the report in a new tab
                window.open(data.file_url, '_blank');
            } else {
                alert('Failed to generate report: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error generating report:', error);
            alert('Failed to generate report. Please try again.');
        });
    }
    
    // Function to export attendance data as CSV or Excel
    function exportAttendanceData(format) {
        // Get all filter values from the Reports tab
        const dateRange = document.getElementById('reportDateRange').value.toLowerCase().replace(/\s+/g, '_');
        const division = document.getElementById('reportDivision').value.toLowerCase().replace(/\s+/g, '_');
        
        // Show a loading notification
        const loadingToast = document.createElement('div');
        loadingToast.className = 'position-fixed bottom-0 end-0 p-3';
        loadingToast.style.zIndex = '5';
        loadingToast.innerHTML = `
            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Export</strong>
                    <small>Just now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    Preparing ${format.toUpperCase()} export... Please wait.
                </div>
            </div>
        `;
        document.body.appendChild(loadingToast);
        
        // Construct the export URL with query parameters
        const exportUrl = `/drivers/export-attendance?date_range=${dateRange}&division=${division}&format=${format}`;
        
        // Navigate to the URL which will trigger the file download
        window.location.href = exportUrl;
        
        // Remove the toast after 3 seconds
        setTimeout(() => {
            document.body.removeChild(loadingToast);
        }, 3000);
    }
</script>
{% endblock %}
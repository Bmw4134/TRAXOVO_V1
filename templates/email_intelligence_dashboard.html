<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} | TRAXOVO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .email-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .email-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .upload-zone {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-zone:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .upload-zone.dragover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        
        .response-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #00ff88;
        }
        
        .analysis-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .confidence-high { color: #00ff88; }
        .confidence-medium { color: #ffd700; }
        .confidence-low { color: #ff6b6b; }
        
        .copy-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 20px;
            padding: 8px 20px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .copy-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .navbar-email {
            background: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(10px);
        }
        
        .processing-indicator {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #00ff88;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark navbar-email fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-envelope-open-text"></i> TRAXOVO Email Intelligence
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user-shield me-1"></i>Watson Admin
                </span>
                <a class="nav-link" href="/watson-admin">
                    <i class="fas fa-arrow-left"></i> Back to Admin
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-5 pt-5">
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert" style="background: rgba(102, 126, 234, 0.2); border: 1px solid rgba(102, 126, 234, 0.3); color: #fff;">
                    <i class="fas fa-robot me-2"></i>
                    <strong>AI Email Assistant Active:</strong> Upload email screenshots to get intelligent analysis and auto-generated responses using your TRAXOVO dashboard context.
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="email-card p-4">
                    <h4><i class="fas fa-cloud-upload-alt me-2"></i>Email Screenshot Upload</h4>
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('emailFile').click()">
                        <i class="fas fa-image fa-3x mb-3" style="opacity: 0.6;"></i>
                        <h5>Drop email screenshot here or click to browse</h5>
                        <p>Supports: PNG, JPG, JPEG files</p>
                        <input type="file" id="emailFile" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                    </div>
                    
                    <div class="processing-indicator" id="processingIndicator">
                        <div class="spinner"></div>
                        <p>Analyzing email with AI vision...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Results -->
        <div class="row mb-4" id="analysisSection" style="display: none;">
            <div class="col-md-6">
                <div class="email-card p-4">
                    <h4><i class="fas fa-search me-2"></i>Email Analysis</h4>
                    <div id="analysisResults">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="email-card p-4">
                    <h4><i class="fas fa-cogs me-2"></i>TRAXOVO Context Used</h4>
                    <div id="contextUsed">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Generated Response -->
        <div class="row mb-4" id="responseSection" style="display: none;">
            <div class="col-12">
                <div class="email-card p-4">
                    <h4><i class="fas fa-reply me-2"></i>Generated Response</h4>
                    <div class="response-box">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="badge bg-success">Ready to Send</span>
                            <div>
                                <button class="copy-button" onclick="copyResponse()">
                                    <i class="fas fa-copy me-1"></i>Copy Response
                                </button>
                                <button class="copy-button" onclick="editResponse()">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </button>
                            </div>
                        </div>
                        <div id="generatedResponse" style="white-space: pre-wrap; font-family: 'Courier New', monospace; background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px;">
                            <!-- Response content -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Database Reference -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="email-card p-4">
                    <h4><i class="fas fa-database me-2"></i>Equipment Database Reference</h4>
                    <div class="row" id="equipmentDatabase">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAnalysis = null;
        let currentResponse = null;
        
        // Load equipment database on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadEquipmentDatabase();
        });
        
        // Drag and drop functionality
        const uploadZone = document.getElementById('uploadZone');
        
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file (PNG, JPG, JPEG)');
                return;
            }
            
            // Show processing indicator
            document.getElementById('processingIndicator').style.display = 'block';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('responseSection').style.display = 'none';
            
            // Create FormData for upload
            const formData = new FormData();
            formData.append('email_image', file);
            
            // Send to analysis endpoint
            fetch('/api/analyze-email', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('processingIndicator').style.display = 'none';
                
                if (data.success) {
                    displayAnalysisResults(data);
                } else {
                    alert('Analysis failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                document.getElementById('processingIndicator').style.display = 'none';
                console.error('Analysis error:', error);
                alert('Error analyzing email: ' + error.message);
            });
        }
        
        function displayAnalysisResults(data) {
            currentAnalysis = data.analysis;
            currentResponse = data.generated_response;
            
            // Display analysis results
            const analysisDiv = document.getElementById('analysisResults');
            analysisDiv.innerHTML = `
                <div class="analysis-item">
                    <strong>Sender:</strong> ${currentAnalysis.sender || 'Not detected'}
                </div>
                <div class="analysis-item">
                    <strong>Request Type:</strong> ${currentAnalysis.request_type || 'General inquiry'}
                </div>
                <div class="analysis-item">
                    <strong>Equipment Mentioned:</strong> ${currentAnalysis.equipment_mentioned ? currentAnalysis.equipment_mentioned.join(', ') : 'None detected'}
                </div>
                <div class="analysis-item">
                    <strong>Urgency Level:</strong> <span class="confidence-${currentAnalysis.urgency || 'medium'}">${currentAnalysis.urgency || 'Medium'}</span>
                </div>
                <div class="analysis-item">
                    <strong>Key Details:</strong> ${currentAnalysis.key_details || 'Processing...'}
                </div>
            `;
            
            // Display context used
            const contextDiv = document.getElementById('contextUsed');
            contextDiv.innerHTML = `
                <div class="analysis-item">
                    <strong>Equipment Database:</strong> ${Object.keys(data.generated_response.context_used?.equipment_data || {}).length} items loaded
                </div>
                <div class="analysis-item">
                    <strong>TRAXOVO Services:</strong> Fleet management, billing, tracking
                </div>
                <div class="analysis-item">
                    <strong>Response Confidence:</strong> <span class="confidence-${currentResponse.confidence}">${currentResponse.confidence.toUpperCase()}</span>
                </div>
                <div class="analysis-item">
                    <strong>AI Model:</strong> GPT-4o Vision + TRAXOVO Context
                </div>
            `;
            
            // Display generated response
            document.getElementById('generatedResponse').textContent = currentResponse.generated_response;
            
            // Show sections
            document.getElementById('analysisSection').style.display = 'block';
            document.getElementById('responseSection').style.display = 'block';
        }
        
        function copyResponse() {
            const responseText = document.getElementById('generatedResponse').textContent;
            navigator.clipboard.writeText(responseText).then(function() {
                // Temporarily change button text
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            });
        }
        
        function editResponse() {
            const responseDiv = document.getElementById('generatedResponse');
            const currentText = responseDiv.textContent;
            
            // Create textarea for editing
            const textarea = document.createElement('textarea');
            textarea.value = currentText;
            textarea.style.width = '100%';
            textarea.style.height = '200px';
            textarea.style.background = 'rgba(255, 255, 255, 0.1)';
            textarea.style.color = '#fff';
            textarea.style.border = '1px solid rgba(255, 255, 255, 0.3)';
            textarea.style.borderRadius = '8px';
            textarea.style.padding = '15px';
            textarea.style.fontFamily = 'Courier New, monospace';
            
            // Replace content with textarea
            responseDiv.innerHTML = '';
            responseDiv.appendChild(textarea);
            
            // Add save button
            const saveButton = document.createElement('button');
            saveButton.className = 'copy-button mt-2';
            saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Save Changes';
            saveButton.onclick = function() {
                responseDiv.textContent = textarea.value;
                currentResponse.generated_response = textarea.value;
            };
            responseDiv.appendChild(saveButton);
        }
        
        function loadEquipmentDatabase() {
            fetch('/api/email-templates')
            .then(response => response.json())
            .then(data => {
                const equipmentDiv = document.getElementById('equipmentDatabase');
                equipmentDiv.innerHTML = '';
                
                Object.entries(data.equipment_database || {}).forEach(([code, details]) => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 mb-2';
                    col.innerHTML = `
                        <div class="analysis-item">
                            <strong>${code}</strong><br>
                            <small>${details.type} - ${details.current_rate}</small><br>
                            <span class="badge bg-success">${details.status}</span>
                        </div>
                    `;
                    equipmentDiv.appendChild(col);
                });
            })
            .catch(error => {
                console.error('Error loading equipment database:', error);
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Dispatch Center - TRAXOVO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <style>
        .dispatch-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
        }
        .equipment-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: move;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        .equipment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .equipment-card.dragging {
            opacity: 0.7;
            transform: rotate(5deg);
        }
        .site-column {
            min-height: 400px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            border: 2px dashed #dee2e6;
        }
        .site-column.drag-over {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .equipment-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-available { background: #28a745; }
        .status-on-site { background: #007bff; }
        .status-maintenance { background: #ffc107; }
        .status-rental { background: #6f42c1; }
        
        .rental-badge {
            background: linear-gradient(45deg, #6f42c1, #e83e8c);
            color: white;
            font-size: 0.75rem;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .report-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .fuel-indicator {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .fuel-level {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .fuel-high { background: #28a745; }
        .fuel-medium { background: #ffc107; }
        .fuel-low { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            {% include 'includes/sidebar.html' %}
            
            <!-- Main Content -->
            <div class="col-lg-10 offset-lg-2 p-4">
                <!-- Header -->
                <div class="dispatch-header mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1><i class="fas fa-truck-moving me-2"></i>Equipment Dispatch Center</h1>
                            <p class="mb-0">Real-time equipment scheduling and dispatch management</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#sendReportModal">
                                <i class="fas fa-paper-plane me-2"></i>Send Reports
                            </button>
                            <button class="btn btn-outline-light" onclick="refreshDispatch()">
                                <i class="fas fa-sync me-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary">{{ data.summary_metrics.total_equipment }}</h3>
                                <p class="mb-0">Total Equipment</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success">{{ data.summary_metrics.equipment_on_site }}</h3>
                                <p class="mb-0">On Site</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning">{{ data.summary_metrics.total_rentals }}</h3>
                                <p class="mb-0">Rental Units</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-info">${{ "{:,.0f}".format(data.summary_metrics.monthly_rental_cost) }}</h3>
                                <p class="mb-0">Monthly Rental Cost</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Equipment Scheduling Grid -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-calendar-alt me-2"></i>Equipment Assignment Board</h5>
                        <small class="text-muted">Drag equipment between job sites to reassign</small>
                    </div>
                    <div class="card-body">
                        <div class="schedule-grid">
                            <!-- Available Equipment Pool -->
                            <div class="site-column" data-site="available">
                                <h6 class="text-center mb-3">
                                    <i class="fas fa-warehouse me-2"></i>Available Equipment
                                </h6>
                                <div id="available-equipment">
                                    {% for equipment in data.equipment_fleet %}
                                    {% if equipment.status == 'available' %}
                                    <div class="equipment-card" draggable="true" data-equipment-id="{{ equipment.equipment_id }}">
                                        <div class="card-body p-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="equipment-status status-available"></span>
                                                    <strong>{{ equipment.name[:15] }}{% if equipment.name|length > 15 %}...{% endif %}</strong>
                                                    {% if equipment.is_rental %}
                                                    <span class="badge rental-badge ms-1">RENTAL</span>
                                                    {% endif %}
                                                </div>
                                                <small class="text-muted">{{ equipment.type }}</small>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">Operator: {{ equipment.operator }}</small>
                                                <div class="fuel-indicator mt-1">
                                                    <div class="fuel-level fuel-{% if equipment.fuel_level > 60 %}high{% elif equipment.fuel_level > 30 %}medium{% else %}low{% endif %}" 
                                                         style="width: {{ equipment.fuel_level }}%"></div>
                                                </div>
                                                <small class="text-muted">Fuel: {{ equipment.fuel_level }}%</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Job Site Columns -->
                            {% for site in data.job_sites %}
                            <div class="site-column" data-site="{{ site.site_id }}">
                                <h6 class="text-center mb-3">
                                    <i class="fas fa-map-marker-alt me-2"></i>{{ site.name }}
                                </h6>
                                <p class="text-center text-muted small">PM: {{ site.project_manager }}</p>
                                
                                <div class="site-equipment">
                                    {% for equipment in data.equipment_fleet %}
                                    {% if equipment.current_site == site.name %}
                                    <div class="equipment-card" draggable="true" data-equipment-id="{{ equipment.equipment_id }}">
                                        <div class="card-body p-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="equipment-status status-on-site"></span>
                                                    <strong>{{ equipment.name[:15] }}{% if equipment.name|length > 15 %}...{% endif %}</strong>
                                                    {% if equipment.is_rental %}
                                                    <span class="badge rental-badge ms-1">RENTAL</span>
                                                    {% endif %}
                                                </div>
                                                <small class="text-muted">{{ equipment.type }}</small>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">{{ equipment.operator }}</small>
                                                <br>
                                                <small class="text-success">{{ equipment.hours_today }}h today</small>
                                                <div class="fuel-indicator mt-1">
                                                    <div class="fuel-level fuel-{% if equipment.fuel_level > 60 %}high{% elif equipment.fuel_level > 30 %}medium{% else %}low{% endif %}" 
                                                         style="width: {{ equipment.fuel_level }}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Rental Tracking Section -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="report-section">
                            <h5><i class="fas fa-credit-card me-2"></i>Rental Equipment Tracking</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Equipment</th>
                                            <th>Vendor</th>
                                            <th>Daily Rate</th>
                                            <th>Days On Rent</th>
                                            <th>Current Cost</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rental in data.rental_tracking %}
                                        <tr>
                                            <td>{{ rental.equipment_name[:20] }}</td>
                                            <td>{{ rental.vendor }}</td>
                                            <td>${{ rental.daily_rate }}</td>
                                            <td>{{ rental.total_days }}</td>
                                            <td><strong>${{ "{:,.0f}".format(rental.monthly_cost) }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="report-section">
                            <h5><i class="fas fa-chart-line me-2"></i>Site Utilization Summary</h5>
                            {% for report in data.weekly_reports %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <strong>{{ report.site_name }}</strong>
                                    <br><small class="text-muted">{{ report.equipment_count }} equipment</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-{% if report.avg_utilization > 80 %}success{% elif report.avg_utilization > 60 %}warning{% else %}danger{% endif %}">
                                        {{ "{:.1f}".format(report.avg_utilization) }}%
                                    </span>
                                    <br><small class="text-muted">{{ "{:.1f}".format(report.total_hours) }}h</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Report Modal -->
    <div class="modal fade" id="sendReportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Equipment Reports</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Daily Reports</h6>
                            {% for report in data.daily_reports %}
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ report.site_name }}</strong>
                                            <br><small class="text-muted">{{ report.equipment_count }} equipment • {{ "{:.1f}".format(report.total_hours_today) }}h today</small>
                                        </div>
                                        <button class="btn btn-sm btn-primary" onclick="sendDailyReport('{{ report.site_name }}')">
                                            <i class="fas fa-paper-plane"></i> Send
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Weekly Reports</h6>
                            {% for report in data.weekly_reports %}
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ report.site_name }}</strong>
                                            <br><small class="text-muted">{{ report.equipment_count }} equipment • {{ "{:.1f}".format(report.total_hours) }}h week</small>
                                        </div>
                                        <button class="btn btn-sm btn-success" onclick="sendWeeklyReport('{{ report.site_name }}')">
                                            <i class="fas fa-paper-plane"></i> Send
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Email Recipients (comma separated)</label>
                        <textarea class="form-control" id="emailRecipients" rows="2" placeholder="chris@raglecontracting.com, dispatch@raglecontracting.com"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script>
        // Drag and Drop Functionality
        let draggedElement = null;

        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
        });

        function setupDragAndDrop() {
            // Make equipment cards draggable
            const equipmentCards = document.querySelectorAll('.equipment-card');
            equipmentCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            // Make site columns drop targets
            const siteColumns = document.querySelectorAll('.site-column');
            siteColumns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            draggedElement = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            e.target.classList.remove('drag-over');

            if (draggedElement !== e.target) {
                const equipmentId = draggedElement.getAttribute('data-equipment-id');
                const newSite = e.target.closest('.site-column').getAttribute('data-site');
                
                // Move the element
                const targetContainer = e.target.closest('.site-column').querySelector('.site-equipment, #available-equipment');
                if (targetContainer) {
                    targetContainer.appendChild(draggedElement);
                    
                    // Update assignment
                    updateEquipmentAssignment(equipmentId, newSite);
                }
            }

            return false;
        }

        function updateEquipmentAssignment(equipmentId, newSite) {
            // Show success message
            showNotification(`Equipment ${equipmentId} assigned to ${newSite}`, 'success');
            
            // Here you would typically make an API call to update the backend
            // fetch('/api/update-assignment', { ... })
        }

        function sendDailyReport(siteName) {
            const emails = document.getElementById('emailRecipients').value.split(',').map(email => email.trim());
            
            if (!emails[0]) {
                alert('Please enter email recipients');
                return;
            }

            fetch('/api/send-daily-report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    site_name: siteName,
                    emails: emails
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification(`Daily report sent for ${siteName}`, 'success');
                } else {
                    showNotification(`Error sending report: ${result.error}`, 'error');
                }
            })
            .catch(error => {
                showNotification(`Network error: ${error}`, 'error');
            });
        }

        function sendWeeklyReport(siteName) {
            const emails = document.getElementById('emailRecipients').value.split(',').map(email => email.trim());
            
            if (!emails[0]) {
                alert('Please enter email recipients');
                return;
            }

            fetch('/api/send-weekly-report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    site_name: siteName,
                    emails: emails
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification(`Weekly report sent for ${siteName}`, 'success');
                } else {
                    showNotification(`Error sending report: ${result.error}`, 'error');
                }
            })
            .catch(error => {
                showNotification(`Network error: ${error}`, 'error');
            });
        }

        function refreshDispatch() {
            location.reload();
        }

        function showNotification(message, type) {
            // Create and show a toast notification
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            // Add to page and show
            const toastContainer = document.createElement('div');
            toastContainer.className = 'position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '1055';
            toastContainer.innerHTML = toastHtml;
            document.body.appendChild(toastContainer);
            
            const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
            toast.show();
            
            // Remove after hiding
            toastContainer.querySelector('.toast').addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toastContainer);
            });
        }
    </script>
</body>
</html>
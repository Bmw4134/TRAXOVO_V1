<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAXOVO Executive Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% include 'components/unified_design_system.html' %}
    <style>
        .kpi-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--dark-surface-2);
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
        }
        
        .kpi-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-green);
        }
        
        .kpi-trend {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
        }
        
        .trend-up {
            background: var(--accent-green);
            color: white;
        }
        
        .trend-down {
            background: var(--error-red);
            color: white;
        }
        
        .executive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin: 1rem 0;
        }
        
        .benchmark-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
        }
        
        .benchmark-excellent {
            background: var(--accent-green);
            color: white;
        }
        
        .benchmark-good {
            background: var(--primary-blue);
            color: white;
        }
        
        .benchmark-warning {
            background: var(--warning-yellow);
            color: var(--dark-bg);
        }
    </style>
</head>
<body>
    <div class="unified-container">
        <!-- Unified Sidebar -->
        {% include 'components/unified_navigation.html' %}
        
        <!-- Main Content -->
        <div class="unified-main">
            <!-- Executive Header -->
            <div class="unified-header">
                <div>
                    <h1 class="unified-title" style="margin: 0;">Executive Dashboard</h1>
                    <p class="unified-text-small" style="margin: 0;">VP-level KPIs and Strategic Analytics</p>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="unified-btn unified-btn-primary" onclick="exportReport('excel')">
                        <i class="fas fa-file-excel"></i>
                        Export Excel
                    </button>
                    <button class="unified-btn unified-btn-secondary" onclick="refreshKPIs()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Data
                    </button>
                    <button class="unified-btn unified-btn-secondary" onclick="togglePredictive()">
                        <i class="fas fa-chart-line"></i>
                        Predictive View
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="unified-content">
                <!-- KPI Overview Cards -->
                <div class="executive-grid">
                    <!-- Fleet Efficiency -->
                    <div class="unified-card">
                        <div class="unified-card-header">
                            <h3 class="unified-card-title">
                                <i class="fas fa-tractor" style="color: var(--primary-blue); margin-right: 0.5rem;"></i>
                                Fleet Efficiency
                            </h3>
                            <button class="unified-btn unified-btn-small" onclick="drillDown('fleet_efficiency')">
                                <i class="fas fa-search-plus"></i>
                                Drill Down
                            </button>
                        </div>
                        <div class="unified-card-body" id="fleet-efficiency-kpis">
                            <div class="loading-state">Loading KPIs...</div>
                        </div>
                    </div>

                    <!-- Financial Performance -->
                    <div class="unified-card">
                        <div class="unified-card-header">
                            <h3 class="unified-card-title">
                                <i class="fas fa-chart-bar" style="color: var(--accent-green); margin-right: 0.5rem;"></i>
                                Financial Performance
                            </h3>
                            <button class="unified-btn unified-btn-small" onclick="drillDown('financial_performance')">
                                <i class="fas fa-search-plus"></i>
                                Drill Down
                            </button>
                        </div>
                        <div class="unified-card-body" id="financial-performance-kpis">
                            <div class="loading-state">Loading KPIs...</div>
                        </div>
                    </div>

                    <!-- Operational Excellence -->
                    <div class="unified-card">
                        <div class="unified-card-header">
                            <h3 class="unified-card-title">
                                <i class="fas fa-award" style="color: var(--warning-yellow); margin-right: 0.5rem;"></i>
                                Operational Excellence
                            </h3>
                            <button class="unified-btn unified-btn-small" onclick="drillDown('operational_excellence')">
                                <i class="fas fa-search-plus"></i>
                                Drill Down
                            </button>
                        </div>
                        <div class="unified-card-body" id="operational-excellence-kpis">
                            <div class="loading-state">Loading KPIs...</div>
                        </div>
                    </div>

                    <!-- Workforce Productivity -->
                    <div class="unified-card">
                        <div class="unified-card-header">
                            <h3 class="unified-card-title">
                                <i class="fas fa-users" style="color: var(--accent-purple); margin-right: 0.5rem;"></i>
                                Workforce Productivity
                            </h3>
                            <button class="unified-btn unified-btn-small" onclick="drillDown('workforce_productivity')">
                                <i class="fas fa-search-plus"></i>
                                Drill Down
                            </button>
                        </div>
                        <div class="unified-card-body" id="workforce-productivity-kpis">
                            <div class="loading-state">Loading KPIs...</div>
                        </div>
                    </div>
                </div>

                <!-- Predictive Analytics Section -->
                <div id="predictive-section" style="display: none;">
                    <div class="unified-grid unified-grid-2" style="margin-bottom: 2rem;">
                        <div class="unified-card">
                            <div class="unified-card-header">
                                <h3 class="unified-card-title">
                                    <i class="fas fa-chart-line" style="margin-right: 0.5rem;"></i>
                                    Predictive Trends
                                </h3>
                            </div>
                            <div class="unified-card-body" id="predictive-trends">
                                <div class="chart-container">
                                    <canvas id="trendsChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="unified-card">
                            <div class="unified-card-header">
                                <h3 class="unified-card-title">
                                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                                    Risk Indicators
                                </h3>
                            </div>
                            <div class="unified-card-body" id="risk-indicators">
                                <div class="loading-state">Loading risk analysis...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Drill-Down Modal Area -->
                <div id="drill-down-modal" class="unified-card" style="display: none; margin-top: 2rem;">
                    <div class="unified-card-header">
                        <h3 class="unified-card-title" id="drill-down-title">Detailed Analysis</h3>
                        <button class="unified-btn unified-btn-small" onclick="closeDrillDown()">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                    <div class="unified-card-body" id="drill-down-content">
                        <!-- Dynamic drill-down content -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        let currentKPIs = {};
        let predictiveData = {};
        let trendsChart = null;

        function loadKPIs() {
            fetch('/api/executive/kpi-summary')
                .then(response => response.json())
                .then(data => {
                    currentKPIs = data;
                    renderKPIs(data);
                })
                .catch(error => {
                    console.error('Error loading KPIs:', error);
                });
        }

        function loadPredictiveData() {
            fetch('/api/executive/predictive-analysis')
                .then(response => response.json())
                .then(data => {
                    predictiveData = data;
                    renderPredictiveAnalysis(data);
                })
                .catch(error => {
                    console.error('Error loading predictive data:', error);
                });
        }

        function renderKPIs(data) {
            // Render Fleet Efficiency KPIs
            const fleetHTML = Object.entries(data.fleet_efficiency).map(([key, metric]) => `
                <div class="kpi-metric">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 0.25rem;">${key.replace(/_/g, ' ').toUpperCase()}</div>
                        <div class="kpi-value">${metric.current}${key.includes('cost') ? '$' : '%'}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="kpi-trend trend-${metric.trend === 'increasing' ? 'up' : 'down'}">
                            ${metric.trend === 'increasing' ? '↗' : '↘'} ${Math.abs(metric.current - metric.previous).toFixed(1)}
                        </div>
                        <div class="benchmark-badge benchmark-${getBenchmarkClass(metric.benchmark)}" style="margin-top: 0.25rem;">
                            ${metric.benchmark.replace(/_/g, ' ')}
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('fleet-efficiency-kpis').innerHTML = fleetHTML;

            // Render Financial Performance KPIs
            const financialHTML = Object.entries(data.financial_performance).map(([key, metric]) => `
                <div class="kpi-metric">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 0.25rem;">${key.replace(/_/g, ' ').toUpperCase()}</div>
                        <div class="kpi-value">${key.includes('revenue') ? '$' + metric.current.toLocaleString() : metric.current + '%'}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="kpi-trend trend-${metric.trend === 'increasing' ? 'up' : 'down'}">
                            ${metric.trend === 'increasing' ? '↗' : '↘'} ${Math.abs(metric.current - metric.previous).toFixed(1)}
                        </div>
                        <div class="benchmark-badge benchmark-${getBenchmarkClass(metric.benchmark)}" style="margin-top: 0.25rem;">
                            ${metric.benchmark.replace(/_/g, ' ')}
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('financial-performance-kpis').innerHTML = financialHTML;

            // Render Operational Excellence KPIs
            const operationalHTML = Object.entries(data.operational_excellence).map(([key, metric]) => `
                <div class="kpi-metric">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 0.25rem;">${key.replace(/_/g, ' ').toUpperCase()}</div>
                        <div class="kpi-value">${metric.current}${key.includes('satisfaction') ? '/5' : key.includes('incidents') ? '' : '%'}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="kpi-trend trend-${metric.trend === 'increasing' || metric.trend === 'decreasing' && key.includes('incidents') ? 'up' : 'down'}">
                            ${metric.trend === 'increasing' || (metric.trend === 'decreasing' && key.includes('incidents')) ? '↗' : '↘'} 
                            ${Math.abs(metric.current - metric.previous).toFixed(1)}
                        </div>
                        <div class="benchmark-badge benchmark-${getBenchmarkClass(metric.benchmark)}" style="margin-top: 0.25rem;">
                            ${metric.benchmark}
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('operational-excellence-kpis').innerHTML = operationalHTML;

            // Render Workforce Productivity KPIs
            const workforceHTML = Object.entries(data.workforce_productivity).map(([key, metric]) => `
                <div class="kpi-metric">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 0.25rem;">${key.replace(/_/g, ' ').toUpperCase()}</div>
                        <div class="kpi-value">${metric.current}%</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="kpi-trend trend-${metric.trend === 'increasing' || (metric.trend === 'decreasing' && key.includes('overtime')) ? 'up' : 'down'}">
                            ${metric.trend === 'increasing' || (metric.trend === 'decreasing' && key.includes('overtime')) ? '↗' : '↘'} 
                            ${Math.abs(metric.current - metric.previous).toFixed(1)}
                        </div>
                        <div class="benchmark-badge benchmark-${getBenchmarkClass(metric.benchmark)}" style="margin-top: 0.25rem;">
                            ${metric.benchmark.replace(/_/g, ' ')}
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('workforce-productivity-kpis').innerHTML = workforceHTML;
        }

        function getBenchmarkClass(benchmark) {
            if (benchmark.includes('excellent') || benchmark.includes('leading')) return 'excellent';
            if (benchmark.includes('good') || benchmark.includes('above')) return 'good';
            return 'warning';
        }

        function renderPredictiveAnalysis(data) {
            // Render risk indicators
            const riskHTML = `
                <div class="kpi-metric">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 0.25rem;">HIGH RISK EQUIPMENT</div>
                        <div class="kpi-value" style="color: var(--error-red);">${data.risk_indicators.equipment_aging.high_risk_units}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.875rem; color: var(--dark-text-muted);">
                            Budget needed: $${data.risk_indicators.equipment_aging.replacement_budget_needed.toLocaleString()}
                        </div>
                    </div>
                </div>
                <div class="kpi-metric">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 0.25rem;">ACTIVE ALERTS</div>
                        <div class="kpi-value" style="color: var(--warning-yellow);">${data.risk_indicators.operational_risks.active_alerts}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="benchmark-badge benchmark-excellent">
                            ${data.risk_indicators.operational_risks.critical_issues} Critical
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('risk-indicators').innerHTML = riskHTML;

            // Create trends chart
            createTrendsChart(data.trends);
        }

        function createTrendsChart(trends) {
            const ctx = document.getElementById('trendsChart');
            if (!ctx) return;

            if (trendsChart) {
                trendsChart.destroy();
            }

            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Current', 'Next Month', 'Next Quarter'],
                    datasets: [{
                        label: 'Revenue Forecast',
                        data: [187500, trends.revenue_forecast.next_month, trends.revenue_forecast.next_quarter],
                        borderColor: 'var(--accent-green)',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'var(--dark-text)'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: 'var(--dark-text-muted)',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'var(--dark-border)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'var(--dark-text-muted)'
                            },
                            grid: {
                                color: 'var(--dark-border)'
                            }
                        }
                    }
                }
            });
        }

        function drillDown(category) {
            fetch(`/api/executive/drill-down/${category}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('drill-down-title').textContent = 
                        category.replace(/_/g, ' ').toUpperCase() + ' - Detailed Analysis';
                    
                    let content = '<div class="unified-grid unified-grid-2">';
                    
                    Object.entries(data).forEach(([key, value]) => {
                        if (Array.isArray(value)) {
                            content += `
                                <div>
                                    <h4 style="margin-bottom: 1rem; color: var(--primary-blue);">${key.replace(/_/g, ' ').toUpperCase()}</h4>
                                    <div class="unified-table-wrapper">
                                        <table class="unified-table">
                                            <thead>
                                                <tr>${Object.keys(value[0]).map(k => `<th>${k.replace(/_/g, ' ').toUpperCase()}</th>`).join('')}</tr>
                                            </thead>
                                            <tbody>
                                                ${value.map(item => `
                                                    <tr>${Object.values(item).map(v => `<td>${v}</td>`).join('')}</tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    content += '</div>';
                    document.getElementById('drill-down-content').innerHTML = content;
                    document.getElementById('drill-down-modal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading drill-down data:', error);
                });
        }

        function closeDrillDown() {
            document.getElementById('drill-down-modal').style.display = 'none';
        }

        function togglePredictive() {
            const section = document.getElementById('predictive-section');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                loadPredictiveData();
            } else {
                section.style.display = 'none';
            }
        }

        function refreshKPIs() {
            document.querySelectorAll('.loading-state').forEach(el => {
                el.textContent = 'Refreshing...';
            });
            loadKPIs();
            if (document.getElementById('predictive-section').style.display !== 'none') {
                loadPredictiveData();
            }
        }

        function exportReport(format) {
            window.open(`/api/executive/export/${format}`, '_blank');
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadKPIs();
        });
    </script>
</body>
</html>
{% extends "layout_unified.html" %}

{% block title %}Smart File Organizer{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-dark text-white">
        <div class="card-body">
          <h2 class="card-title">Smart File Organizer</h2>
          <p class="card-text">
            Organize your CSV and Excel files using intelligent categorization and sorting.
            The system will automatically detect file types, extract dates, and organize files into a structured directory.
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card bg-dark text-white">
        <div class="card-header">
          <h4>Quick Organization</h4>
        </div>
        <div class="card-body">
          <p>
            Quickly organize weekly report files into categories. This process takes only a few seconds.
          </p>
          <form action="/file-organizer/quick-organize" method="post" id="quickOrganizeForm">
            <div class="mb-3">
              <label for="quickSourceDir" class="form-label">Source Directory</label>
              <input type="text" class="form-control" id="quickSourceDir" name="source_dir" value="attached_assets" required>
            </div>
            <div class="mb-3">
              <label for="quickTargetDir" class="form-label">Target Directory</label>
              <input type="text" class="form-control" id="quickTargetDir" name="target_dir" value="weekly_report_files" required>
            </div>
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary" id="quickOrganizeBtn">
                <i class="fas fa-folder-tree me-2"></i> Quick Organize
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card bg-dark text-white">
        <div class="card-header">
          <h4>Advanced Organization</h4>
        </div>
        <div class="card-body">
          <p>
            Run a deep analysis to organize files by content type, extract dates, and detect duplicates.
            This process may take several minutes for large file collections.
          </p>
          <form action="/file-organizer/organize" method="post" id="advancedOrganizeForm">
            <div class="mb-3">
              <label for="sourceDir" class="form-label">Source Directory</label>
              <input type="text" class="form-control" id="sourceDir" name="source_dir" value="attached_assets" required>
            </div>
            <div class="mb-3">
              <label for="targetDir" class="form-label">Target Directory</label>
              <input type="text" class="form-control" id="targetDir" name="target_dir" value="organized_data" required>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="createSymlinks" name="create_symlinks" value="true">
              <label class="form-check-label" for="createSymlinks">Create symlinks instead of copying files</label>
            </div>
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-success" id="advancedOrganizeBtn">
                <i class="fas fa-brain me-2"></i> Analyze & Organize
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card bg-dark text-white">
        <div class="card-header">
          <h4>Organization Results</h4>
        </div>
        <div class="card-body">
          <div id="results">
            <p class="text-muted">Results will appear here after organizing files...</p>
          </div>
          
          <!-- Section to display the organization report when available -->
          {% if report %}
          <div class="mt-4">
            <h5>Organization Report</h5>
            <div class="table-responsive">
              <table class="table table-dark table-striped">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Files Count</th>
                  </tr>
                </thead>
                <tbody>
                  {% for category, count in report.categories.items() %}
                  <tr>
                    <td>{{ category }}</td>
                    <td>{{ count }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            {% if report.dates %}
            <h5 class="mt-3">Files by Date</h5>
            <div class="table-responsive">
              <table class="table table-dark table-striped">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Files Count</th>
                  </tr>
                </thead>
                <tbody>
                  {% for date, count in report.dates.items() %}
                  <tr>
                    <td>{{ date }}</td>
                    <td>{{ count }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background: rgba(0,0,0,0.7); z-index: 9999;" id="loadingOverlay">
  <div class="position-absolute top-50 start-50 translate-middle text-center text-white">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <h5 id="loadingMessage">Organizing files...</h5>
    <p class="text-muted" id="loadingSubMessage">This may take a few moments</p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Quick organize form submission
    document.getElementById('quickOrganizeForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const loadingOverlay = document.getElementById('loadingOverlay');
      const loadingMessage = document.getElementById('loadingMessage');
      const loadingSubMessage = document.getElementById('loadingSubMessage');
      
      loadingMessage.textContent = 'Quick organizing files...';
      loadingSubMessage.textContent = 'This should only take a few seconds';
      loadingOverlay.classList.remove('d-none');
      
      // Get form data
      const formData = new FormData(this);
      
      // Send AJAX request
      fetch('/file-organizer/quick-organize', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        loadingOverlay.classList.add('d-none');
        
        // Display results
        const resultsDiv = document.getElementById('results');
        if (data.status === 'success') {
          resultsDiv.innerHTML = `
            <div class="alert alert-success">
              <h5><i class="fas fa-check-circle me-2"></i> Organization Complete!</h5>
              <p>Successfully organized ${data.file_count} files into ${Object.keys(data.categories).length} categories.</p>
              <p>Files organized in: <code>${data.target_dir}</code></p>
              <a href="/file-organizer/report" class="btn btn-primary btn-sm mt-2">View Detailed Report</a>
            </div>
            
            <div class="mt-3">
              <h5>Categories Summary</h5>
              <ul class="list-group">
                ${Object.entries(data.categories).map(([category, count]) => 
                  `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${category}
                    <span class="badge bg-primary rounded-pill">${count}</span>
                  </li>`
                ).join('')}
              </ul>
            </div>
          `;
        } else {
          resultsDiv.innerHTML = `
            <div class="alert alert-danger">
              <h5><i class="fas fa-exclamation-triangle me-2"></i> Error</h5>
              <p>${data.message}</p>
            </div>
          `;
        }
      })
      .catch(error => {
        loadingOverlay.classList.add('d-none');
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="fas fa-exclamation-triangle me-2"></i> Error</h5>
            <p>An unexpected error occurred: ${error.message}</p>
          </div>
        `;
      });
    });
    
    // Advanced organize form submission
    document.getElementById('advancedOrganizeForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const loadingOverlay = document.getElementById('loadingOverlay');
      const loadingMessage = document.getElementById('loadingMessage');
      const loadingSubMessage = document.getElementById('loadingSubMessage');
      
      loadingMessage.textContent = 'Analyzing and organizing files...';
      loadingSubMessage.textContent = 'This may take several minutes for large collections';
      loadingOverlay.classList.remove('d-none');
      
      // Get form data
      const formData = new FormData(this);
      
      // Send AJAX request
      fetch('/file-organizer/organize', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        loadingOverlay.classList.add('d-none');
        
        // Display results
        const resultsDiv = document.getElementById('results');
        if (data.status === 'success') {
          resultsDiv.innerHTML = `
            <div class="alert alert-success">
              <h5><i class="fas fa-check-circle me-2"></i> Advanced Organization Complete!</h5>
              <p>Successfully analyzed and organized ${data.report.total_files} files.</p>
              <p>Files organized in: <code>${formData.get('target_dir')}</code></p>
              <a href="/file-organizer/report" class="btn btn-primary btn-sm mt-2">View Detailed Report</a>
            </div>
            
            <div class="mt-3">
              <h5>Categories Summary</h5>
              <ul class="list-group">
                ${Object.entries(data.report.categories).map(([category, count]) => 
                  `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${category}
                    <span class="badge bg-primary rounded-pill">${count}</span>
                  </li>`
                ).join('')}
              </ul>
            </div>
            
            <div class="mt-3">
              <h5>Files by Date (Top 5)</h5>
              <ul class="list-group">
                ${Object.entries(data.report.dates).slice(0, 5).map(([date, count]) => 
                  `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${date}
                    <span class="badge bg-info rounded-pill">${count}</span>
                  </li>`
                ).join('')}
              </ul>
            </div>
          `;
        } else {
          resultsDiv.innerHTML = `
            <div class="alert alert-danger">
              <h5><i class="fas fa-exclamation-triangle me-2"></i> Error</h5>
              <p>${data.message}</p>
            </div>
          `;
        }
      })
      .catch(error => {
        loadingOverlay.classList.add('d-none');
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="fas fa-exclamation-triangle me-2"></i> Error</h5>
            <p>An unexpected error occurred: ${error.message}</p>
          </div>
        `;
      });
    });
  });
</script>
{% endblock %}
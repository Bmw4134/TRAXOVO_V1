<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page_title }} - TRAXOVO</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
      .financial-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .financial-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
      }

      .kpi-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .kpi-card:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .kpi-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #2c3e50;
        animation: countUp 1.5s ease-out;
      }

      .kpi-label {
        color: #7f8c8d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .trend-indicator {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .trend-up {
        background: #27ae60;
        color: white;
      }

      .trend-down {
        background: #e74c3c;
        color: white;
      }

      .trend-stable {
        background: #f39c12;
        color: white;
      }

      .forecast-chart {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .opportunity-item {
        background: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
      }

      .risk-item {
        background: #fff5f5;
        border-left: 4px solid #e74c3c;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
      }

      .recommendation-item {
        background: #f0fff4;
        border-left: 4px solid #27ae60;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
      }

      .export-btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        color: white;
      }

      .mobile-responsive {
        display: grid;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .mobile-responsive {
          grid-template-columns: 1fr;
        }

        .kpi-value {
          font-size: 2rem;
        }

        .financial-card {
          padding: 15px;
        }
      }

      @media (min-width: 769px) {
        .mobile-responsive {
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
      }

      @keyframes countUp {
        from {
          opacity: 0;
          transform: scale(0.5);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .prediction-highlight {
        background: linear-gradient(90deg, #ffecd2 0%, #fcb69f 100%);
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        border-left: 5px solid #ff6b6b;
      }

      .interactive-drill {
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .interactive-drill:hover {
        background-color: #e3f2fd;
        border-radius: 8px;
        padding: 10px;
      }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-chart-line me-2"></i>TRAXOVO Financial Intelligence
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"
                ><i class="fas fa-home me-1"></i>Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/executive-billing"
                ><i class="fas fa-dollar-sign me-1"></i>Billing Intelligence</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/financial-forecasting"
                ><i class="fas fa-chart-trend-up me-1"></i>Forecasting</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <!-- Header Section -->
      <div class="row">
        <div class="col-12">
          <div class="financial-card">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h1 class="mb-1">
                  <i class="fas fa-crystal-ball me-3"></i>Predictive Financial
                  Forecasting
                </h1>
                <p class="mb-0">
                  Advanced revenue analytics using Equipment Amount × UNITS
                  allocation methodology
                </p>
              </div>
              <div class="col-md-4 text-end">
                <button class="export-btn" onclick="exportFinancialInsights()">
                  <i class="fas fa-download me-2"></i>Export Insights
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Flash Cards -->
      <div class="row mobile-responsive mb-4">
        <div class="col">
          <div class="kpi-card" onclick="drillDownRevenue()">
            <div class="kpi-value" id="currentRevenue">
              ${{ "{:,.0f}".format(insights.current_metrics.monthly_revenue) }}
            </div>
            <div class="kpi-label">Current Monthly Revenue</div>
            <div class="trend-indicator trend-up mt-2">
              <i class="fas fa-arrow-up me-1"></i>Active
            </div>
          </div>
        </div>
        <div class="col">
          <div class="kpi-card" onclick="drillDownAssets()">
            <div class="kpi-value" id="billableAssets">
              {{ insights.current_metrics.billable_assets }}
            </div>
            <div class="kpi-label">Billable Assets</div>
            <div class="trend-indicator trend-stable mt-2">
              <i class="fas fa-minus me-1"></i>Stable
            </div>
          </div>
        </div>
        <div class="col">
          <div class="kpi-card" onclick="drillDownPerformance()">
            <div class="kpi-value" id="avgRevenue">
              ${{
              "{:,.0f}".format(insights.current_metrics.avg_revenue_per_asset)
              }}
            </div>
            <div class="kpi-label">Avg Revenue/Asset</div>
            <div class="trend-indicator trend-up mt-2">
              <i class="fas fa-arrow-up me-1"></i>Growth
            </div>
          </div>
        </div>
      </div>

      <!-- Forecast Chart and Trend Analysis -->
      <div class="row mb-4">
        <div class="col-lg-8">
          <div class="forecast-chart">
            <h3>
              <i class="fas fa-chart-line me-2 text-primary"></i>Revenue
              Forecast Trend
            </h3>
            <canvas id="forecastChart" height="300"></canvas>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="prediction-highlight">
            <h5><i class="fas fa-lightbulb me-2"></i>Trend Analysis</h5>
            {% if insights.forecast.trend_analysis %}
            <p>
              <strong>Direction:</strong> {{
              insights.forecast.trend_analysis.direction.replace('_', '
              ').title() }}
            </p>
            <p>
              <strong>Monthly Change:</strong> {{
              insights.forecast.trend_analysis.avg_monthly_change }}%
            </p>
            <p>
              <strong>Consistency:</strong> {{
              (insights.forecast.trend_analysis.consistency * 100)|round(1) }}%
            </p>
            {% endif %}
            <hr />
            <small class="text-muted"
              >Based on {{ insights.current_metrics.calculation_method }}</small
            >
          </div>

          <div class="card mt-3">
            <div class="card-header">
              <h6><i class="fas fa-cogs me-2"></i>Model Accuracy</h6>
            </div>
            <div class="card-body">
              {% if insights.forecast.model_accuracy %}
              <p>
                <strong>Linear R²:</strong> {{
                insights.forecast.model_accuracy.linear_r2 }}
              </p>
              <p>
                <strong>Polynomial R²:</strong> {{
                insights.forecast.model_accuracy.polynomial_r2 }}
              </p>
              <p>
                <strong>Recommended:</strong> {{
                insights.forecast.model_accuracy.recommended_model.title() }}
              </p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Revenue Opportunities -->
      <div class="row mb-4">
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-bullseye me-2"></i>Revenue Opportunities
              </h5>
            </div>
            <div class="card-body">
              {% for opportunity in insights.opportunities %}
              <div
                class="opportunity-item interactive-drill"
                onclick="drillDownOpportunity('{{ opportunity.type }}')"
              >
                <h6><strong>{{ opportunity.type }}</strong></h6>
                {% if opportunity.division %}
                <p><strong>Division:</strong> {{ opportunity.division }}</p>
                {% endif %}
                <p>
                  <strong>Potential Increase:</strong> ${{
                  "{:,.0f}".format(opportunity.potential_monthly_increase)
                  }}/month
                </p>
                <small class="text-muted"
                  >{{ opportunity.implementation }}</small
                >
              </div>
              {% endfor %} {% if not insights.opportunities %}
              <div class="text-center text-muted py-3">
                <i class="fas fa-search fa-2x mb-2"></i>
                <p>No immediate opportunities identified</p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>Risk Factors
              </h5>
            </div>
            <div class="card-body">
              {% for risk in insights.risk_factors %}
              <div class="risk-item">
                <h6><strong>{{ risk.type }}</strong></h6>
                <p>{{ risk.description }}</p>
                <p><strong>Impact:</strong> {{ risk.impact }}</p>
                <small class="text-muted"
                  ><strong>Mitigation:</strong> {{ risk.mitigation }}</small
                >
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Strategic Recommendations -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="fas fa-lightbulb me-2"></i>Strategic Recommendations
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                {% for recommendation in insights.recommendations %}
                <div class="col-md-6 mb-3">
                  <div class="recommendation-item">
                    <div
                      class="d-flex justify-content-between align-items-start mb-2"
                    >
                      <h6><strong>{{ recommendation.title }}</strong></h6>
                      <span
                        class="badge bg-{{ 'danger' if recommendation.priority == 'High' else 'warning' if recommendation.priority == 'Medium' else 'info' }}"
                      >
                        {{ recommendation.priority }}
                      </span>
                    </div>
                    <p>{{ recommendation.description }}</p>
                    <ul class="mb-0">
                      {% for action in recommendation.actions %}
                      <li>{{ action }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Drill-down Modal -->
    <div class="modal fade" id="drillDownModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="drillDownTitle">Detailed Analysis</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="drillDownContent">
            <!-- Content will be loaded dynamically -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="exportDrillDown()"
            >
              Export Details
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Initialize forecast chart
      const ctx = document.getElementById('forecastChart').getContext('2d');
      const forecastData = {{ insights.forecast | tojson }};

      const chart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: forecastData.dates || [],
              datasets: [{
                  label: 'Seasonal Adjusted Forecast',
                  data: forecastData.seasonal_adjusted || [],
                  borderColor: '#667eea',
                  backgroundColor: 'rgba(102, 126, 234, 0.1)',
                  fill: true,
                  tension: 0.4
              }, {
                  label: 'Linear Trend',
                  data: forecastData.linear_forecast || [],
                  borderColor: '#764ba2',
                  backgroundColor: 'transparent',
                  borderDash: [5, 5]
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'top'
                  },
                  tooltip: {
                      mode: 'index',
                      intersect: false,
                      callbacks: {
                          label: function(context) {
                              return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                          }
                      }
                  }
              },
              scales: {
                  y: {
                      beginAtZero: false,
                      ticks: {
                          callback: function(value) {
                              return '$' + value.toLocaleString();
                          }
                      }
                  }
              },
              interaction: {
                  mode: 'nearest',
                  axis: 'x',
                  intersect: false
              }
          }
      });

      // Interactive drill-down functions
      function drillDownRevenue() {
          showDrillDown('Revenue Analysis', `
              <div class="row">
                  <div class="col-md-6">
                      <h6>Current Revenue Breakdown</h6>
                      <p><strong>Monthly Total:</strong> ${{ "{:,.2f}".format(insights.current_metrics.monthly_revenue) }}</p>
                      <p><strong>Calculation Method:</strong> {{ insights.current_metrics.calculation_method }}</p>
                      <p><strong>Billable Assets:</strong> {{ insights.current_metrics.billable_assets }}</p>
                  </div>
                  <div class="col-md-6">
                      <h6>Performance Metrics</h6>
                      <p><strong>Revenue per Asset:</strong> ${{ "{:,.2f}".format(insights.current_metrics.avg_revenue_per_asset) }}</p>
                      <p><strong>Utilization Rate:</strong> 94.6%</p>
                      <p><strong>GPS Correlation:</strong> 97.2%</p>
                  </div>
              </div>
          `);
      }

      function drillDownAssets() {
          showDrillDown('Asset Analysis', `
              <div class="row">
                  <div class="col-12">
                      <h6>Asset Utilization Breakdown</h6>
                      <div class="progress mb-3">
                          <div class="progress-bar bg-success" style="width: 94.6%">Billable (94.6%)</div>
                      </div>
                      <p><strong>Total Fleet:</strong> 701 assets</p>
                      <p><strong>Active Assets:</strong> 601 assets</p>
                      <p><strong>Billable Assets:</strong> {{ insights.current_metrics.billable_assets }} assets</p>
                      <p><strong>Underutilized:</strong> {{ 570 - insights.current_metrics.billable_assets }} assets</p>
                  </div>
              </div>
          `);
      }

      function drillDownPerformance() {
          showDrillDown('Performance Analysis', `
              <div class="row">
                  <div class="col-12">
                      <h6>Revenue Performance Trends</h6>
                      <p><strong>Average Revenue per Asset:</strong> ${{ "{:,.2f}".format(insights.current_metrics.avg_revenue_per_asset) }}</p>
                      <p><strong>Trend Direction:</strong> {{ insights.forecast.trend_analysis.direction.replace('_', ' ').title() if insights.forecast.trend_analysis else 'Analyzing...' }}</p>
                      <p><strong>Monthly Change:</strong> {{ insights.forecast.trend_analysis.avg_monthly_change if insights.forecast.trend_analysis else 'Calculating...' }}%</p>
                      <p><strong>Forecast Confidence:</strong> {{ (insights.forecast.trend_analysis.consistency * 100)|round(1) if insights.forecast.trend_analysis else 'N/A' }}%</p>
                  </div>
              </div>
          `);
      }

      function drillDownOpportunity(type) {
          const opportunity = {{ insights.opportunities | tojson }}.find(opp => opp.type === type);
          if (opportunity) {
              showDrillDown('Opportunity: ' + type, `
                  <div class="row">
                      <div class="col-12">
                          <h6>Opportunity Details</h6>
                          <p><strong>Type:</strong> ${opportunity.type}</p>
                          ${opportunity.division ? `<p><strong>Division:</strong> ${opportunity.division}</p>` : ''}
                          <p><strong>Potential Monthly Increase:</strong> $${opportunity.potential_monthly_increase.toLocaleString()}</p>
                          <p><strong>Implementation:</strong> ${opportunity.implementation}</p>
                          ${opportunity.asset_count ? `<p><strong>Assets Affected:</strong> ${opportunity.asset_count}</p>` : ''}
                      </div>
                  </div>
              `);
          }
      }

      function showDrillDown(title, content) {
          document.getElementById('drillDownTitle').textContent = title;
          document.getElementById('drillDownContent').innerHTML = content;
          new bootstrap.Modal(document.getElementById('drillDownModal')).show();
      }

      function exportFinancialInsights() {
          // Create comprehensive export data
          const exportData = {
              timestamp: new Date().toISOString(),
              current_metrics: {{ insights.current_metrics | tojson }},
              forecast: {{ insights.forecast | tojson }},
              opportunities: {{ insights.opportunities | tojson }},
              risk_factors: {{ insights.risk_factors | tojson }},
              recommendations: {{ insights.recommendations | tojson }}
          };

          // Download as JSON
          const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `TRAXOVO_Financial_Insights_${new Date().toISOString().slice(0,10)}.json`;
          a.click();
          URL.revokeObjectURL(url);
      }

      function exportDrillDown() {
          const title = document.getElementById('drillDownTitle').textContent;
          const content = document.getElementById('drillDownContent').innerHTML;

          const exportData = {
              title: title,
              content: content,
              timestamp: new Date().toISOString()
          };

          const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `TRAXOVO_DrillDown_${title.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.json`;
          a.click();
          URL.revokeObjectURL(url);
      }

      // Animate KPI values on load
      document.addEventListener('DOMContentLoaded', function() {
          const kpiValues = document.querySelectorAll('.kpi-value');
          kpiValues.forEach(element => {
              const finalValue = element.textContent;
              element.textContent = '0';

              setTimeout(() => {
                  element.textContent = finalValue;
              }, 500);
          });
      });
    </script>
  </body>
</html>

{% extends "base.html" %}

{% block title %}Fleet Map - TRAXOVO{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        {% include "includes/sidebar.html" %}
        
        <div class="col-md-9">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">Live Fleet Map</h2>
                    <p class="text-muted">Real-time GPS tracking and asset monitoring</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshMap()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Map
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="text-primary">{{ total_assets }}</h5>
                            <small class="text-muted">Total Assets</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="text-success">{{ active_assets }}</h5>
                            <small class="text-muted">Active Equipment</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="text-info">{{ gps_enabled_count }}</h5>
                            <small class="text-muted">GPS Enabled</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="text-warning">0</h5>
                            <small class="text-muted">Alerts</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simplified Map Container -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Equipment Locations</h5>
                </div>
                <div class="card-body">
                    <div id="map" style="height: 500px; width: 100%;"></div>
                </div>
            </div>

            <!-- Asset List -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Asset Details</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Asset ID</th>
                                    <th>Equipment</th>
                                    <th>Status</th>
                                    <th>Location</th>
                                    <th>Last Update</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asset in assets %}
                                <tr>
                                    <td><strong>{{ asset.id }}</strong></td>
                                    <td>{{ asset.name }}</td>
                                    <td>
                                        {% if asset.status == 'active' %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-warning">Idle</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if asset.lat and asset.lng %}
                                            {{ "%.4f"|format(asset.lat) }}, {{ "%.4f"|format(asset.lng) }}
                                        {% else %}
                                            No GPS Data
                                        {% endif %}
                                    </td>
                                    <td>{{ asset.last_update }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
// Fast-loading map implementation
let map;
let markerCluster;

document.addEventListener('DOMContentLoaded', function() {
    initMap();
});

function initMap() {
    console.log('Initializing map...');
    
    // Initialize map with Austin coordinates
    map = L.map('map').setView([30.2672, -97.7431], 10);
    
    // Add OpenStreetMap tiles (reliable and fast)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
    
    console.log('Map tiles added');
    
    // Initialize marker cluster
    markerCluster = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    
    // Add assets to map
    addAssets();
    
    // Add cluster to map
    map.addLayer(markerCluster);
    
    console.log('Map initialization complete');
}

function addAssets() {
    console.log('Adding assets to map...');
    const assets = {{ assets | tojson | safe }};
    console.log('Assets data:', assets);
    
    if (!assets || assets.length === 0) {
        console.log('No assets to display');
        return;
    }
    
    assets.forEach((asset, index) => {
        console.log(`Adding asset ${index + 1}:`, asset);
        
        // Create marker with custom icon based on status
        let iconColor = 'blue';
        if (asset.status === 'active') iconColor = 'green';
        else if (asset.status === 'maintenance') iconColor = 'red';
        else if (asset.status === 'idle') iconColor = 'orange';
        
        const marker = L.marker([asset.lat, asset.lng]);
        
        const popupContent = `
            <div style="min-width: 250px;">
                <h6><strong>${asset.name}</strong></h6>
                <p><strong>Asset ID:</strong> ${asset.id}<br>
                <strong>Category:</strong> ${asset.category || 'Equipment'}<br>
                <strong>Status:</strong> <span style="color: ${iconColor};">${asset.status}</span><br>
                <strong>Location:</strong> ${asset.location || 'Unknown'}<br>
                <strong>Hours:</strong> ${asset.hours || 0}<br>
                <strong>Last Update:</strong> ${asset.last_update}</p>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        markerCluster.addLayer(marker);
    });
    
    console.log(`Added ${assets.length} assets to cluster`);
}

function refreshMap() {
    // Simple refresh - in production this would fetch new data
    console.log('Map refreshed');
    
    // Show brief loading indicator
    const btn = event.target.closest('button');
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }, 1000);
}
</script>
{% endblock %}
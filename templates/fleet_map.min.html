{% extends "base.html" %}

{% block title %}Fleet Map - TRAXOVO{% endblock %}

{% block head %}
<style>
.fleet-header {
background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
color: white;
border-bottom: 1px solid rgba(255,255,255,0.1);
}

.text-white-25 {
opacity: 0.25;
}

.text-white-50 {
opacity: 0.7;
}

.map-container {
background: white;
border-radius: 16px;
box-shadow: 0 4px 24px rgba(0,0,0,0.1);
overflow: hidden;
border: none;
}

.map-controls {
background: #f8f9fa;
padding: 1rem;
border-bottom: 1px solid #e9ecef;
}

.filter-btn {
background: white;
border: 1px solid #e9ecef;
border-radius: 8px;
padding: 0.5rem 1rem;
margin-right: 0.5rem;
color: #495057;
transition: all 0.2s;
}

.filter-btn:hover, .filter-btn.active {
background: #007bff;
color: white;
border-color: #007bff;
transform: translateY(-1px);
}

.map-loading {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: rgba(255,255,255,0.95);
padding: 2rem;
border-radius: 12px;
box-shadow: 0 4px 20px rgba(0,0,0,0.15);
z-index: 1000;
}

.zone-toggle {
position: absolute;
top: 80px;
right: 10px;
z-index: 1000;
background: white;
border-radius: 8px;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
padding: 0.5rem;
}

#map {
border-radius: 0;
}

.asset-info-panel {
background: white;
border-radius: 12px;
box-shadow: 0 2px 12px rgba(0,0,0,0.08);
border: none;
}

.legend-item {
display: inline-flex;
align-items: center;
margin-right: 1rem;
font-size: 0.9rem;
color: #6c757d;
}

.legend-dot {
width: 12px;
height: 12px;
border-radius: 50%;
margin-right: 0.5rem;
}

.pulse-active {
animation: pulse 2s infinite;
}

@keyframes pulse {
0% { box-shadow: 0 3px 10px rgba(0,0,0,0.4), 0 0 0 0 rgba(40, 167, 69, 0.7); }
70% { box-shadow: 0 3px 10px rgba(0,0,0,0.4), 0 0 0 10px rgba(40, 167, 69, 0); }
100% { box-shadow: 0 3px 10px rgba(0,0,0,0.4), 0 0 0 0 rgba(40, 167, 69, 0); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0"><div class="fleet-header"><div class="container-fluid px-4 py-3"><div class="d-flex justify-content-between align-items-center"><div><h1 class="h3 mb-0 fw-bold text-white">Fleet Operations</h1><small class="text-white-50">Live asset tracking & monitoring</small></div><div class="d-flex align-items-center gap-3"><div class="d-flex gap-4 text-white"><div class="text-center"><div class="h5 mb-0 fw-bold">{{ total_assets }}</div><small class="text-white-50">Total</small></div><div class="text-center"><div class="h5 mb-0 fw-bold text-success">{{ active_assets }}</div><small class="text-white-50">Active</small></div><div class="text-center"><div class="h5 mb-0 fw-bold text-info">{{ gps_enabled_count }}</div><small class="text-white-50">GPS</small></div></div><div class="vr text-white-25"></div><div class="d-flex gap-2"><button class="btn btn-outline-light btn-sm" onclick="refreshMap()"><i class="fas fa-sync-alt"></i></button><button class="btn btn-outline-light btn-sm"><i class="fas fa-download"></i></button></div></div></div></div></div><div class="map-container"><div class="map-controls"><div class="d-flex justify-content-between align-items-center"><div><button class="filter-btn active" onclick="filterAssets('all')">All Equipment</button><button class="filter-btn" onclick="filterAssets('excavator')">Excavators</button><button class="filter-btn" onclick="filterAssets('truck')">Trucks</button><button class="filter-btn" onclick="filterAssets('active')">Active Only</button><button class="filter-btn" onclick="toggleGeofences()">Toggle Zones</button></div><div class="d-flex align-items-center"><div class="legend-item"><div class="legend-dot bg-success"></div>
Active
</div><div class="legend-item"><div class="legend-dot bg-warning"></div>
Idle
</div><div class="legend-item"><div class="legend-dot bg-danger"></div>
Offline
</div></div></div></div><div id="map" style="position: relative;"><div id="map-loading" class="map-loading" style="display: none;"><div class="text-center"><i class="fas fa-spinner fa-spin fa-2x text-primary mb-2"></i><p class="mb-0">Loading fleet data...</p></div></div><div class="zone-toggle"><button class="btn btn-sm btn-outline-secondary" onclick="toggleJobZones()" title="Toggle Job Zones"><i class="fas fa-map-marked-alt"></i></button><button class="btn btn-sm btn-outline-secondary" onclick="toggleOperationalZones()" title="Toggle Operational Areas"><i class="fas fa-draw-polygon"></i></button></div></div></div></div></div><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /><link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" /><link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" /><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script><script>
// Fast-loading map implementation
let map;
let markerCluster;
let jobZoneLayer;
let geofenceLayer;
let currentFilter = 'all';
let showJobZones = false;

document.addEventListener('DOMContentLoaded', function() {
initMap();
});

function initMap() {
// Initialize map centered on DFW area
map = L.map('map', {
zoomControl: false
}).setView([32.7767, -96.7970], 9);

// Add custom zoom control
L.control.zoom({
position: 'topright'
}).addTo(map);

// Use satellite/hybrid tiles for professional look
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
attribution: 'Â© Esri',
maxZoom: 18
}).addTo(map);

// Add street overlay
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
opacity: 0.3,
maxZoom: 18
}).addTo(map);

// Initialize marker cluster with custom styling
markerCluster = L.markerClusterGroup({
maxClusterRadius: 40,
spiderfyOnMaxZoom: true,
showCoverageOnHover: false,
zoomToBoundsOnClick: true,
iconCreateFunction: function(cluster) {
var count = cluster.getChildCount();
var size = count < 10 ? 'small' : count < 100 ? 'medium' : 'large';
return new L.DivIcon({
html: '<div><span>' + count + '</span></div>',
className: 'marker-cluster marker-cluster-' + size,
iconSize: new L.Point(40, 40)
});
}
});

// Initialize layers
jobZoneLayer = L.layerGroup();
geofenceLayer = L.layerGroup();

// Add operational geofences (always visible but subtle)
addOperationalGeofences();

// Add assets to map
addAssets();

// Add cluster to map
map.addLayer(markerCluster);
}

function addAssets() {
const assets = {{ assets | tojson | safe }};

if (!assets || assets.length === 0) {
return;
}

assets.forEach((asset) => {
// Skip assets without valid coordinates
if (!asset.lat || !asset.lng || asset.lat === 0 || asset.lng === 0) {
return;
}

// Apply current filter
if (currentFilter !== 'all') {
if (currentFilter === 'active' && asset.status !== 'active') return;
if (currentFilter === 'excavator' && !asset.category.toLowerCase().includes('excavator')) return;
if (currentFilter === 'truck' && !asset.category.toLowerCase().includes('truck')) return;
}

// Create enhanced marker based on status and category
let markerColor = asset.status === 'active' ? '#28a745' : '#ffc107';
let markerIcon = getEquipmentIcon(asset.category);
let pulseClass = asset.status === 'active' ? 'pulse-active' : '';

const customIcon = L.divIcon({
className: 'custom-marker',
html: `<div class="${pulseClass}" style="background-color: ${markerColor}; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 500;"><i class="fas ${markerIcon}"></i></div>`,
iconSize: [34, 34],
iconAnchor: [17, 17]
});

const marker = L.marker([asset.lat, asset.lng], { icon: customIcon });

const popupContent = `
<div style="min-width: 300px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;"><div style="background: linear-gradient(135deg, ${markerColor}22 0%, ${markerColor}11 100%); margin: -12px -12px 12px -12px; padding: 12px; border-radius: 8px 8px 0 0;"><h6 style="margin: 0; color: #343a40; font-weight: 600; font-size: 16px;">${asset.name}</h6><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;"><small style="color: #6c757d; font-weight: 500;">${asset.id}</small><span style="background: ${markerColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">${asset.status.toUpperCase()}</span></div></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px; margin-bottom: 12px;"><div><strong style="color: #495057;">Category:</strong><br><span style="color: #6c757d;">${asset.category || 'Equipment'}</span></div><div><strong style="color: #495057;">Hours:</strong><br><span style="color: #6c757d;">${asset.hours || 'N/A'}</span></div></div><div style="border-top: 1px solid #e9ecef; padding-top: 12px;"><div style="margin-bottom: 8px;"><strong style="color: #495057;">Location:</strong><br><span style="color: #6c757d; font-size: 13px;">${asset.location || 'Unknown'}</span></div><div style="font-size: 12px; color: #6c757d;"><strong>Last Update:</strong> ${asset.last_update}</div></div></div>
`;

marker.bindPopup(popupContent);
markerCluster.addLayer(marker);
});
}

function getEquipmentIcon(category) {
const iconMap = {
'Excavator': 'fa-shovel',
'Truck': 'fa-truck',
'Heavy Truck': 'fa-truck',
'Pickup Truck': 'fa-truck-pickup',
'Personal Vehicle': 'fa-car',
'Wheel Loader': 'fa-cogs',
'Message Board': 'fa-sign',
'Vacuum': 'fa-wind',
'Sweeper': 'fa-broom',
'Flatbed Trailer': 'fa-trailer'
};
return iconMap[category] || 'fa-cog';
}

function addOperationalGeofences() {
const geofences = {{ geofences | tojson | safe }};

geofences.forEach(geofence => {
if (geofence.type === 'polygon') {
const polygon = L.polygon(geofence.coordinates, {
color: '#007bff',
fillColor: '#007bff',
fillOpacity: 0.05,
weight: 1,
opacity: 0.3,
dashArray: '3, 3'
});

polygon.bindPopup(`
<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;"><h6 style="margin: 0 0 0.5rem 0; color: #343a40;">${geofence.name}</h6><small style="color: #6c757d;">Primary Service Area</small></div>
`);

geofenceLayer.addLayer(polygon);
}
});

map.addLayer(geofenceLayer);
}

function addJobZones() {
const jobZones = {{ job_zones | tojson | safe }};

// Clear existing job zones
jobZoneLayer.clearLayers();

jobZones.forEach(zone => {
const zoneColor = zone.type === 'project' ? '#dc3545' : zone.type === 'yard' ? '#ffc107' : '#17a2b8';

const circle = L.circle([zone.lat, zone.lng], {
radius: zone.radius,
color: zoneColor,
fillColor: zoneColor,
fillOpacity: 0.15,
weight: 2,
dashArray: '8, 4'
});

// Add zone label
const zoneIcon = L.divIcon({
className: 'zone-label',
html: `<div style="background: ${zoneColor}; color: white; padding: 4px 10px; border-radius: 16px; font-size: 12px; font-weight: 600; white-space: nowrap; box-shadow: 0 3px 10px rgba(0,0,0,0.3); border: 2px solid white;">
${zone.name.length > 20 ? zone.name.substring(0, 20) + '...' : zone.name}
</div>`,
iconSize: [0, 0],
iconAnchor: [0, 0]
});

const marker = L.marker([zone.lat, zone.lng], { icon: zoneIcon });

const popup = `
<div style="min-width: 280px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;"><div style="border-bottom: 1px solid #e9ecef; padding-bottom: 0.75rem; margin-bottom: 0.75rem;"><h6 style="margin: 0; color: #343a40; font-weight: 600;">${zone.name}</h6><span style="background: ${zoneColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; text-transform: uppercase; font-weight: 500;">${zone.type}</span></div><div style="font-size: 0.875rem; color: #495057;"><div style="margin-bottom: 0.5rem;"><strong>Zone Radius:</strong> ${zone.radius}m</div><div><strong>Coordinates:</strong> ${zone.lat.toFixed(4)}, ${zone.lng.toFixed(4)}</div></div></div>
`;

circle.bindPopup(popup);
marker.bindPopup(popup);

jobZoneLayer.addLayer(circle);
jobZoneLayer.addLayer(marker);
});
}

function toggleJobZones() {
showJobZones = !showJobZones;

if (showJobZones) {
addJobZones();
map.addLayer(jobZoneLayer);
event.target.closest('button').classList.add('active');
} else {
map.removeLayer(jobZoneLayer);
event.target.closest('button').classList.remove('active');
}
}

function filterAssets(type) {
currentFilter = type;

// Update button states
document.querySelectorAll('.filter-btn').forEach(btn => {
if (btn.onclick && btn.onclick.toString().includes(type)) {
btn.classList.add('active');
} else if (!btn.onclick.toString().includes('toggleGeofences')) {
btn.classList.remove('active');
}
});

// Clear and re-add filtered assets
markerCluster.clearLayers();
addAssets();
}

function refreshMap() {
const btn = event.target.closest('button');
const originalContent = btn.innerHTML;
btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
btn.disabled = true;

setTimeout(() => {
btn.innerHTML = originalContent;
btn.disabled = false;
// Re-apply current filter
filterAssets(currentFilter);
}, 1200);
}
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Fleet Map - TRAXOVO{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /><style>
.fleet-header {
background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
color: white;
border-bottom: 1px solid rgba(255,255,255,0.1);
}

.filter-btn {
background: #f8f9fa;
border: 1px solid #dee2e6;
border-radius: 6px;
padding: 0.4rem 0.8rem;
color: #495057;
font-size: 0.875rem;
font-weight: 500;
transition: all 0.15s ease;
margin-right: 0.5rem;
}

.filter-btn:hover, .filter-btn.active {
background: #007bff;
color: white;
border-color: #007bff;
}

#map {
height: 70vh;
width: 100%;
border: 1px solid #ddd;
}

.asset-list {
max-height: 400px;
overflow-y: auto;
background: #f8f9fa;
border-radius: 8px;
padding: 1rem;
}

.asset-item {
padding: 0.5rem;
border-bottom: 1px solid #e9ecef;
cursor: pointer;
font-size: 0.9rem;
}

.asset-item:hover {
background-color: #e3f2fd;
}

.status-active { color: #28a745; }
.status-idle { color: #ffc107; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0"><div class="fleet-header"><div class="container-fluid px-4 py-3"><div class="d-flex justify-content-between align-items-center"><div><h1 class="h3 mb-0 fw-bold text-white">Fleet Operations</h1><small style="opacity: 0.7;">Live asset tracking & monitoring</small></div><div class="d-flex align-items-center gap-3"><div class="d-flex gap-4 text-white"><div class="text-center"><div class="h5 mb-0 fw-bold">{{ total_assets }}</div><small style="opacity: 0.7;">Total</small></div><div class="text-center"><div class="h5 mb-0 fw-bold text-success">{{ active_assets }}</div><small style="opacity: 0.7;">Active</small></div><div class="text-center"><div class="h5 mb-0 fw-bold text-info">{{ gps_enabled_count }}</div><small style="opacity: 0.7;">GPS</small></div></div></div></div></div></div><div class="bg-white border-bottom shadow-sm py-3"><div class="container-fluid px-4"><div class="d-flex justify-content-between align-items-center"><div><button class="filter-btn active" onclick="filterAssets('all')">All Equipment</button><button class="filter-btn" onclick="filterAssets('excavator')">Excavators</button><button class="filter-btn" onclick="filterAssets('truck')">Trucks</button><button class="filter-btn" onclick="filterAssets('active')">Active Only</button></div><div class="d-flex gap-3"><span class="small"><i class="fas fa-circle text-success me-1"></i>Active ({{ active_assets }})</span><span class="small"><i class="fas fa-circle text-warning me-1"></i>Idle ({{ total_assets - active_assets }})</span></div></div></div></div><div class="container-fluid py-4"><div class="row"><div class="col-md-9"><div id="map"></div></div><div class="col-md-3"><div class="asset-list"><h6 class="fw-bold mb-3">Equipment List</h6><div id="asset-items"></div></div></div></div></div></div><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script>
let map;
let markers = [];
let allAssets = {{ assets | tojson | safe }};
let currentFilter = 'all';

// Initialize map
function initMap() {
map = L.map('map').setView([32.7767, -96.7970], 9);

L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
attribution: 'Â© Esri',
maxZoom: 18
}).addTo(map);

displayAssets();
populateAssetList();
}

// Display assets on map
function displayAssets() {
// Clear existing markers
markers.forEach(marker => map.removeLayer(marker));
markers = [];

const filteredAssets = allAssets.filter(asset => {
if (currentFilter === 'all') return true;
if (currentFilter === 'active') return asset.status === 'active';
if (currentFilter === 'excavator') return asset.category.toLowerCase().includes('excavator');
if (currentFilter === 'truck') return asset.category.toLowerCase().includes('truck');
return true;
});

filteredAssets.forEach(asset => {
if (!asset.lat || !asset.lng || asset.lat === 0 || asset.lng === 0) return;

const markerColor = asset.status === 'active' ? '#28a745' : '#ffc107';

const marker = L.circleMarker([asset.lat, asset.lng], {
radius: 8,
fillColor: markerColor,
color: '#fff',
weight: 2,
opacity: 1,
fillOpacity: 0.8
});

marker.bindPopup(`
<div style="min-width: 250px;"><h6><strong>${asset.name}</strong></h6><p><strong>ID:</strong> ${asset.id}<br><strong>Status:</strong><span style="color: ${markerColor};">${asset.status.toUpperCase()}</span><br><strong>Category:</strong> ${asset.category}<br><strong>Location:</strong> ${asset.location}<br><strong>Last Update:</strong> ${asset.last_update}</p></div>
`);

marker.addTo(map);
markers.push(marker);
});

console.log(`Displayed ${filteredAssets.length} assets on map`);
}

// Populate asset list
function populateAssetList() {
const container = document.getElementById('asset-items');
const filteredAssets = allAssets.filter(asset => {
if (currentFilter === 'all') return true;
if (currentFilter === 'active') return asset.status === 'active';
if (currentFilter === 'excavator') return asset.category.toLowerCase().includes('excavator');
if (currentFilter === 'truck') return asset.category.toLowerCase().includes('truck');
return true;
});

container.innerHTML = filteredAssets.map(asset => `
<div class="asset-item" onclick="centerOnAsset('${asset.id}')"><div class="fw-bold">${asset.name}</div><div class="text-muted small">${asset.id}</div><div class="small status-${asset.status}">${asset.status.toUpperCase()}</div></div>
`).join('');
}

// Filter assets
function filterAssets(type) {
currentFilter = type;

document.querySelectorAll('.filter-btn').forEach(btn => {
btn.classList.remove('active');
});
event.target.classList.add('active');

displayAssets();
populateAssetList();
}

// Center map on asset
function centerOnAsset(assetId) {
const asset = allAssets.find(a => a.id === assetId);
if (asset && asset.lat && asset.lng) {
map.setView([asset.lat, asset.lng], 15);

// Find and open popup for this asset
markers.forEach(marker => {
const latLng = marker.getLatLng();
if (Math.abs(latLng.lat - asset.lat) < 0.0001 && Math.abs(latLng.lng - asset.lng) < 0.0001) {
marker.openPopup();
}
});
}
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
initMap();
});
</script>
{% endblock %}
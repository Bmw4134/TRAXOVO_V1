{% extends "base.html" %}

{% block title %}Fleet Map - TRAXOVO{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /><link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" /><style>
.fleet-header {
background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
color: white;
border-bottom: 1px solid rgba(255,255,255,0.1);
}

.filter-btn {
background: #f8f9fa;
border: 1px solid #dee2e6;
border-radius: 6px;
padding: 0.4rem 0.8rem;
color: #495057;
font-size: 0.875rem;
font-weight: 500;
transition: all 0.15s ease;
margin-right: 0.5rem;
}

.filter-btn:hover, .filter-btn.active {
background: #007bff;
color: white;
border-color: #007bff;
box-shadow: 0 2px 4px rgba(0,123,255,0.25);
}

#map {
width: 100%;
height: 100%;
}

.asset-item {
padding: 0.75rem;
border-bottom: 1px solid #e9ecef;
cursor: pointer;
transition: background-color 0.15s ease;
}

.asset-item:hover {
background-color: #f8f9fa;
}

.asset-item.selected {
background-color: #e3f2fd;
border-left: 3px solid #2196f3;
}

.status-dot {
width: 8px;
height: 8px;
border-radius: 50%;
display: inline-block;
margin-right: 0.5rem;
}

.btn-group-vertical .btn {
border-radius: 0;
}

.btn-group-vertical .btn:first-child {
border-top-left-radius: 0.375rem;
border-top-right-radius: 0.375rem;
}

.btn-group-vertical .btn:last-child {
border-bottom-left-radius: 0.375rem;
border-bottom-right-radius: 0.375rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0"><div class="fleet-header"><div class="container-fluid px-4 py-3"><div class="d-flex justify-content-between align-items-center"><div><h1 class="h3 mb-0 fw-bold text-white">Fleet Operations</h1><small style="opacity: 0.7;">Live asset tracking & monitoring</small></div><div class="d-flex align-items-center gap-3"><div class="d-flex gap-4 text-white"><div class="text-center"><div class="h5 mb-0 fw-bold">{{ total_assets }}</div><small style="opacity: 0.7;">Total</small></div><div class="text-center"><div class="h5 mb-0 fw-bold text-success">{{ active_assets }}</div><small style="opacity: 0.7;">Active</small></div><div class="text-center"><div class="h5 mb-0 fw-bold text-info">{{ gps_enabled_count }}</div><small style="opacity: 0.7;">GPS</small></div></div></div></div></div></div><div class="bg-white border-bottom shadow-sm py-3"><div class="container-fluid px-4"><div class="row align-items-center"><div class="col-md-8"><div class="d-flex flex-wrap gap-2"><button class="filter-btn active" onclick="filterAssets('all')"><i class="fas fa-th me-1"></i>All Equipment
</button><button class="filter-btn" onclick="filterAssets('excavator')"><i class="fas fa-shovel me-1"></i>Excavators
</button><button class="filter-btn" onclick="filterAssets('truck')"><i class="fas fa-truck me-1"></i>Trucks
</button><button class="filter-btn" onclick="filterAssets('active')"><i class="fas fa-play me-1"></i>Active Only
</button><div class="vr mx-2"></div><button class="filter-btn" onclick="toggleJobZones()"><i class="fas fa-map-marked-alt me-1"></i>Job Zones
</button><button class="filter-btn" onclick="toggleTrails()"><i class="fas fa-route me-1"></i>Trails
</button><button class="filter-btn" onclick="toggleOffline()"><i class="fas fa-wifi-slash me-1"></i>Offline
</button></div></div><div class="col-md-4"><div class="d-flex justify-content-end align-items-center gap-3"><div class="d-flex gap-3 small"><span><i class="fas fa-circle text-success me-1"></i>Active ({{ active_assets }})</span><span><i class="fas fa-circle text-warning me-1"></i>Idle ({{ total_assets - active_assets }})</span><span><i class="fas fa-circle text-danger me-1"></i>Offline (0)</span></div><div class="dropdown"><button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown"><i class="fas fa-cog me-1"></i>View
</button><ul class="dropdown-menu"><li><a class="dropdown-item" href="#" onclick="changeMapView('satellite')">Satellite</a></li><li><a class="dropdown-item" href="#" onclick="changeMapView('terrain')">Terrain</a></li><li><a class="dropdown-item" href="#" onclick="changeMapView('street')">Street</a></li></ul></div></div></div></div></div></div><div class="container-fluid p-0" style="height: calc(100vh - 200px);"><div class="row h-100 g-0"><div class="col-md-3"><div class="asset-sidebar h-100 bg-light border-end p-3" style="overflow-y: auto;"><div class="d-flex justify-content-between align-items-center mb-3"><h6 class="mb-0 fw-bold">Asset List</h6><button class="btn btn-sm btn-outline-secondary" onclick="refreshAssets()"><i class="fas fa-sync-alt"></i></button></div><div class="mb-3"><input type="text" class="form-control form-control-sm" placeholder="Search assets..." onkeyup="searchAssets(this.value)"></div><div id="asset-list"></div></div></div><div class="col-md-9"><div class="position-relative h-100"><div id="map" style="height: 100%; width: 100%; z-index: 1;"></div><div class="position-absolute top-0 end-0 m-3"><div class="btn-group-vertical" role="group"><button class="btn btn-light btn-sm" onclick="map.zoomIn()" title="Zoom In"><i class="fas fa-plus"></i></button><button class="btn btn-light btn-sm" onclick="map.zoomOut()" title="Zoom Out"><i class="fas fa-minus"></i></button><button class="btn btn-light btn-sm" onclick="centerMap()" title="Center View"><i class="fas fa-crosshairs"></i></button><button class="btn btn-light btn-sm" onclick="fullscreenMap()" title="Fullscreen"><i class="fas fa-expand"></i></button></div></div><div class="position-absolute bottom-0 start-0 m-3"><div class="card" style="min-width: 250px;"><div class="card-body p-2"><div class="d-flex justify-content-between small"><span>Last Update:</span><span id="last-update">{{ "5/30/2025 2:21 PM CT" }}</span></div><div class="d-flex justify-content-between small"><span>Data Source:</span><span class="text-success">Gauge API</span></div></div></div></div></div></div></div></div></div><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script><script>
let map;
let markerCluster;
let currentFilter = 'all';
let jobZoneLayer;
let selectedAsset = null;
let allAssets = [];

document.addEventListener('DOMContentLoaded', function() {
// Add a small delay to ensure DOM is fully rendered
setTimeout(() => {
initMap();
}, 250);
});

// Also initialize if window loads
window.addEventListener('load', function() {
if (!map) {
setTimeout(() => {
initMap();
}, 100);
}
});

function initMap() {
// Force map container size
const mapElement = document.getElementById('map');
if (mapElement) {
mapElement.style.height = '100%';
mapElement.style.width = '100%';
}

map = L.map('map', {
zoomControl: false,
preferCanvas: true
}).setView([32.7767, -96.7970], 9);

// Add tile layer with error handling
const tileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
attribution: '© Esri',
maxZoom: 18,
errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
});

tileLayer.on('tileerror', function(error) {
console.log('Tile loading error:', error);
});

tileLayer.addTo(map);

markerCluster = L.markerClusterGroup({
maxClusterRadius: 40,
spiderfyOnMaxZoom: true,
chunkedLoading: true
});

jobZoneLayer = L.layerGroup();

// Wait for map to be ready
map.whenReady(function() {
console.log('Map is ready');
addAssets();
populateAssetList();
map.addLayer(markerCluster);

// Force map invalidate size after a short delay
setTimeout(() => {
map.invalidateSize();
}, 100);
});
}

function addAssets() {
const assets = {{ assets | tojson | safe }};
allAssets = assets;

if (!assets || assets.length === 0) {
console.log('No assets to display');
return;
}

assets.forEach((asset) => {
if (!asset.lat || !asset.lng || asset.lat === 0 || asset.lng === 0) {
return;
}

if (currentFilter !== 'all') {
if (currentFilter === 'active' && asset.status !== 'active') return;
if (currentFilter === 'excavator' && !asset.category.toLowerCase().includes('excavator')) return;
if (currentFilter === 'truck' && !asset.category.toLowerCase().includes('truck')) return;
}

let markerColor = asset.status === 'active' ? '#28a745' : '#ffc107';
let icon = getEquipmentIcon(asset.category);

const customIcon = L.divIcon({
className: 'custom-marker',
html: `<div style="background-color: ${markerColor}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: white; font-size: 11px;"><i class="fas ${icon}"></i></div>`,
iconSize: [28, 28],
iconAnchor: [14, 14]
});

const marker = L.marker([asset.lat, asset.lng], {
icon: customIcon,
assetId: asset.id
});

marker.bindPopup(`
<div style="min-width: 280px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;"><div style="border-bottom: 1px solid #e9ecef; padding-bottom: 0.75rem; margin-bottom: 0.75rem;"><h6 style="margin: 0; color: #343a40; font-weight: 600;">${asset.name}</h6><small style="color: #6c757d;">${asset.id}</small></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.875rem; margin-bottom: 0.75rem;"><div><strong>Status:</strong><br><span style="color: ${markerColor};">${asset.status.toUpperCase()}</span></div><div><strong>Category:</strong><br>${asset.category}</div><div><strong>Hours:</strong><br>${asset.hours || 'N/A'}</div><div><strong>Serial:</strong><br>${asset.serial || 'N/A'}</div></div><div style="border-top: 1px solid #e9ecef; padding-top: 0.75rem;"><div style="margin-bottom: 0.5rem;"><strong>Location:</strong><br>${asset.location}</div><div style="font-size: 0.8rem; color: #6c757d;"><strong>Last Update:</strong> ${asset.last_update}</div></div></div>
`);

marker.on('click', function() {
selectAsset(asset.id);
});

markerCluster.addLayer(marker);
});

console.log(`Added ${assets.length} assets to map`);
}

function populateAssetList() {
const assetListElement = document.getElementById('asset-list');
const assets = allAssets.filter(asset => {
if (currentFilter === 'all') return true;
if (currentFilter === 'active') return asset.status === 'active';
if (currentFilter === 'excavator') return asset.category.toLowerCase().includes('excavator');
if (currentFilter === 'truck') return asset.category.toLowerCase().includes('truck');
return true;
});

assetListElement.innerHTML = assets.map(asset => `
<div class="asset-item" onclick="selectAsset('${asset.id}')" data-asset-id="${asset.id}"><div class="d-flex justify-content-between align-items-start"><div class="flex-grow-1"><div class="fw-bold small">${asset.name}</div><div class="text-muted small">${asset.id}</div><div class="small"><span class="status-dot ${asset.status === 'active' ? 'bg-success' : 'bg-warning'}"></span>
${asset.status.toUpperCase()}
</div></div><div class="text-end small text-muted">
${asset.hours || 0}h
</div></div></div>
`).join('');
}

function getEquipmentIcon(category) {
const iconMap = {
'Excavator': 'fa-shovel',
'Truck': 'fa-truck',
'Heavy Truck': 'fa-truck',
'Pickup Truck': 'fa-truck-pickup',
'Personal Vehicle': 'fa-car',
'Wheel Loader': 'fa-cogs',
'Message Board': 'fa-sign',
'Vacuum': 'fa-wind',
'Sweeper': 'fa-broom',
'Flatbed Trailer': 'fa-trailer'
};
return iconMap[category] || 'fa-cog';
}

function filterAssets(type) {
currentFilter = type;

document.querySelectorAll('.filter-btn').forEach(btn => {
btn.classList.remove('active');
});
event.target.classList.add('active');

markerCluster.clearLayers();
addAssets();
populateAssetList();
}

function selectAsset(assetId) {
selectedAsset = assetId;

// Update sidebar selection
document.querySelectorAll('.asset-item').forEach(item => {
item.classList.remove('selected');
});
document.querySelector(`[data-asset-id="${assetId}"]`)?.classList.add('selected');

// Find and center on asset
const asset = allAssets.find(a => a.id === assetId);
if (asset && asset.lat && asset.lng) {
map.setView([asset.lat, asset.lng], 15);
}
}

function searchAssets(query) {
const items = document.querySelectorAll('.asset-item');
items.forEach(item => {
const text = item.textContent.toLowerCase();
if (text.includes(query.toLowerCase())) {
item.style.display = 'block';
} else {
item.style.display = 'none';
}
});
}

function toggleJobZones() {
// Add job zones functionality
console.log('Job zones toggle clicked');
}

function toggleTrails() {
console.log('Trails toggle clicked');
}

function toggleOffline() {
console.log('Offline toggle clicked');
}

function changeMapView(type) {
map.eachLayer(layer => {
if (layer._url) {
map.removeLayer(layer);
}
});

if (type === 'satellite') {
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
attribution: '© Esri'
}).addTo(map);
} else if (type === 'street') {
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '© OpenStreetMap'
}).addTo(map);
} else if (type === 'terrain') {
L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', {
attribution: 'Map tiles by Stamen Design'
}).addTo(map);
}
}

function centerMap() {
map.setView([32.7767, -96.7970], 9);
}

function fullscreenMap() {
const mapElement = document.getElementById('map');
if (mapElement.requestFullscreen) {
mapElement.requestFullscreen();
}
}

function refreshAssets() {
location.reload();
}
</script>
{% endblock %}
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>TRAXOVO GPS Tracking - Real-Time Fleet Map</title><link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.5.2/ol.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"><style>
body {
background: #1a1a1a;
color: #ffffff;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.main-container {
height: 100vh;
overflow: hidden;
}

.header-bar {
background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
padding: 12px 20px;
box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.header-title {
font-size: 1.5rem;
font-weight: 600;
margin: 0;
color: white;
}

.stats-row {
display: flex;
justify-content: space-between;
align-items: center;
margin-top: 8px;
}

.stat-item {
display: flex;
align-items: center;
gap: 8px;
color: rgba(255,255,255,0.9);
font-size: 0.9rem;
}

.stat-value {
font-weight: 600;
color: #2ecc71;
}

.map-container {
height: calc(100vh - 100px);
position: relative;
}

#map {
height: 100%;
width: 100%;
}

.sidebar {
position: absolute;
top: 0;
left: 0;
width: 300px;
height: 100%;
background: rgba(26, 26, 26, 0.95);
backdrop-filter: blur(10px);
border-right: 1px solid rgba(255,255,255,0.1);
z-index: 1000;
padding: 20px;
overflow-y: auto;
transform: translateX(-100%);
transition: transform 0.3s ease;
}

.sidebar.open {
transform: translateX(0);
}

.sidebar-toggle {
position: absolute;
top: 20px;
left: 20px;
z-index: 1001;
background: rgba(26, 26, 26, 0.9);
border: 1px solid rgba(255,255,255,0.2);
color: white;
padding: 10px;
border-radius: 5px;
cursor: pointer;
transition: all 0.3s ease;
}

.sidebar-toggle:hover {
background: rgba(52, 152, 219, 0.8);
}

.asset-list {
max-height: 400px;
overflow-y: auto;
}

.asset-item {
background: rgba(255,255,255,0.05);
border: 1px solid rgba(255,255,255,0.1);
border-radius: 8px;
padding: 12px;
margin-bottom: 10px;
cursor: pointer;
transition: all 0.3s ease;
}

.asset-item:hover {
background: rgba(52, 152, 219, 0.2);
border-color: #3498db;
}

.asset-name {
font-weight: 600;
color: #3498db;
margin-bottom: 4px;
}

.asset-status {
font-size: 0.85rem;
color: rgba(255,255,255,0.7);
}

.status-active { color: #2ecc71; }
.status-idle { color: #f39c12; }
.status-maintenance { color: #e74c3c; }

.asset-popup {
min-width: 250px;
}

.asset-popup h5 {
color: #3498db;
margin-bottom: 10px;
}

.popup-info {
display: flex;
justify-content: space-between;
margin-bottom: 5px;
font-size: 0.9rem;
}

.popup-label {
font-weight: 600;
color: rgba(255,255,255,0.8);
}

.popup-value {
color: white;
}

.map-controls {
position: absolute;
top: 80px;
right: 20px;
z-index: 1000;
display: flex;
flex-direction: column;
gap: 10px;
}

.control-btn {
background: rgba(26, 26, 26, 0.9);
border: 1px solid rgba(255,255,255,0.2);
color: white;
padding: 10px;
border-radius: 5px;
cursor: pointer;
transition: all 0.3s ease;
width: 45px;
height: 45px;
display: flex;
align-items: center;
justify-content: center;
}

.control-btn:hover {
background: rgba(52, 152, 219, 0.8);
}

.refresh-indicator {
position: absolute;
top: 80px;
left: 50%;
transform: translateX(-50%);
background: rgba(46, 204, 113, 0.9);
color: white;
padding: 8px 16px;
border-radius: 20px;
font-size: 0.9rem;
z-index: 1000;
opacity: 0;
transition: opacity 0.3s ease;
}

.refresh-indicator.show {
opacity: 1;
}

/* Custom marker styles */
.asset-marker {
border-radius: 50%;
border: 2px solid white;
box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.marker-active {
background: #2ecc71;
}

.marker-idle {
background: #f39c12;
}

.marker-maintenance {
background: #e74c3c;
}

.marker-unknown {
background: #95a5a6;
}
</style></head><body><div class="main-container"><div class="header-bar"><h1 class="header-title"><i class="fas fa-map-marker-alt me-2"></i>
TRAXOVO GPS Tracking
</h1><div class="stats-row"><div class="stat-item"><i class="fas fa-truck"></i><span>Total Assets: <span class="stat-value">{{ total_assets }}</span></span></div><div class="stat-item"><i class="fas fa-satellite"></i><span>GPS Online: <span class="stat-value">{{ online_assets }}</span></span></div><div class="stat-item"><i class="fas fa-percentage"></i><span>Coverage: <span class="stat-value">{{ coverage_percentage }}%</span></span></div><div class="stat-item"><i class="fas fa-clock"></i><span>Last Update: <span class="stat-value">{{ last_update }}</span></span></div></div></div><div class="map-container"><button class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button><div class="sidebar" id="sidebar"><h5><i class="fas fa-list me-2"></i>Asset List</h5><div class="asset-list" id="assetList"></div><hr style="border-color: rgba(255,255,255,0.2);"><h6><i class="fas fa-filter me-2"></i>Filters</h6><div class="mb-3"><label class="form-label">Status</label><select class="form-select" id="statusFilter" onchange="filterAssets()"><option value="">All Status</option><option value="active">Active</option><option value="idle">Idle</option><option value="maintenance">Maintenance</option></select></div><div class="mb-3"><label class="form-label">Region</label><select class="form-select" id="regionFilter" onchange="filterAssets()"><option value="">All Regions</option><option value="dfw">DFW</option><option value="houston">Houston</option><option value="west-texas">West Texas</option></select></div></div><div class="map-controls"><button class="control-btn" onclick="refreshMap()" title="Refresh"><i class="fas fa-sync-alt"></i></button><button class="control-btn" onclick="fitAllAssets()" title="Fit All"><i class="fas fa-expand-arrows-alt"></i></button><button class="control-btn" onclick="toggleSatellite()" title="Satellite"><i class="fas fa-satellite"></i></button></div><div class="refresh-indicator" id="refreshIndicator"><i class="fas fa-sync-alt fa-spin me-2"></i>Updating locations...
</div><div id="map"></div></div></div><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script>
// Global variables
let map;
let assetsData = [];
let assetMarkers = {};
let sidebarOpen = false;
let satelliteView = true;

// Initialize map
function initializeMap() {
try {
// Center on North Texas (Dallas area)
map = L.map('map').setView([32.7767, -96.7970], 7);

// Add OpenStreetMap tiles (more reliable)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: 'Â© OpenStreetMap contributors',
maxZoom: 18
}).addTo(map);

// Load asset data from your authentic Gauge API
loadAssetData();

// Set up auto-refresh every 30 seconds
setInterval(refreshMap, 30000);

console.log('Map initialized successfully');
} catch (error) {
console.error('Error initializing map:', error);
document.getElementById('map').innerHTML = '<div style="padding: 20px; text-align: center; color: white;">Map loading error. Please refresh the page.</div>';
}
}

// Update map layer
function updateMapLayer() {
map.eachLayer(function(layer) {
if (layer._url) {
map.removeLayer(layer);
}
});

if (satelliteView) {
// Satellite view like Gauge/Samsara
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
attribution: '&copy; Esri',
maxZoom: 18
}).addTo(map);

// Add labels overlay
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', {
attribution: '',
maxZoom: 18
}).addTo(map);
} else {
// Street view
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors',
maxZoom: 18
}).addTo(map);
}
}

// Load asset data from API
async function loadAssetData() {
try {
const response = await fetch('/gps/api/assets');
assetsData = await response.json();
updateMap();
updateSidebar();
} catch (error) {
console.error('Error loading asset data:', error);
// Show error in UI but don't use fallback data
showError('Unable to connect to GPS tracking system. Please check your connection.');
}
}

// Update map with asset markers
function updateMap() {
// Clear existing markers
Object.values(assetMarkers).forEach(marker => {
map.removeLayer(marker);
});
assetMarkers = {};

// Add new markers
assetsData.forEach(asset => {
const marker = createAssetMarker(asset);
assetMarkers[asset.id] = marker;
marker.addTo(map);
});
}

// Create marker for asset
function createAssetMarker(asset) {
const statusClass = `marker-${asset.status}`;

// Create custom icon based on asset type and status
const icon = L.divIcon({
className: `asset-marker ${statusClass}`,
html: `<i class="fas fa-truck" style="color: white; font-size: 12px; margin-top: 3px;"></i>`,
iconSize: [24, 24],
iconAnchor: [12, 12]
});

const marker = L.marker([asset.latitude, asset.longitude], { icon: icon });

// Create detailed popup
const popupContent = `
<div class="asset-popup"><h5><i class="fas fa-truck me-2"></i>${asset.name}</h5><div class="popup-info"><span class="popup-label">Asset #:</span><span class="popup-value">${asset.asset_number}</span></div><div class="popup-info"><span class="popup-label">Status:</span><span class="popup-value status-${asset.status}">${asset.status.toUpperCase()}</span></div><div class="popup-info"><span class="popup-label">Driver:</span><span class="popup-value">${asset.driver}</span></div><div class="popup-info"><span class="popup-label">Job Site:</span><span class="popup-value">${asset.job_site}</span></div><div class="popup-info"><span class="popup-label">Engine Hours:</span><span class="popup-value">${asset.engine_hours}</span></div><div class="popup-info"><span class="popup-label">Last Update:</span><span class="popup-value">${asset.last_update}</span></div></div>
`;

marker.bindPopup(popupContent);

return marker;
}

// Update sidebar with asset list
function updateSidebar() {
const assetList = document.getElementById('assetList');
assetList.innerHTML = '';

assetsData.forEach(asset => {
const assetItem = document.createElement('div');
assetItem.className = 'asset-item';
assetItem.onclick = () => focusOnAsset(asset);

assetItem.innerHTML = `
<div class="asset-name">${asset.name}</div><div class="asset-status"><span class="status-${asset.status}">${asset.status.toUpperCase()}</span> |
${asset.driver} | ${asset.job_site}
</div>
`;

assetList.appendChild(assetItem);
});
}

// Focus on specific asset
function focusOnAsset(asset) {
map.setView([asset.latitude, asset.longitude], 15);
assetMarkers[asset.id].openPopup();
}

// Toggle sidebar
function toggleSidebar() {
const sidebar = document.getElementById('sidebar');
sidebarOpen = !sidebarOpen;
sidebar.classList.toggle('open', sidebarOpen);
}

// Refresh map with real data
async function refreshMap() {
const indicator = document.getElementById('refreshIndicator');
indicator.classList.add('show');

await loadAssetData();

setTimeout(() => {
indicator.classList.remove('show');
}, 1000);
}

// Fit all assets in view
function fitAllAssets() {
if (assetsData.length === 0) return;

const group = new L.featureGroup(Object.values(assetMarkers));
map.fitBounds(group.getBounds(), { padding: [20, 20] });
}

// Toggle satellite/street view
function toggleSatellite() {
satelliteView = !satelliteView;
updateMapLayer();
}

// Filter assets (implementation for real filtering)
function filterAssets() {
const statusFilter = document.getElementById('statusFilter').value;
const regionFilter = document.getElementById('regionFilter').value;

// Filter markers based on criteria
Object.values(assetMarkers).forEach(marker => {
const asset = assetsData.find(a =>
assetMarkers[a.id] === marker
);

let show = true;

if (statusFilter && asset.status !== statusFilter) {
show = false;
}

if (regionFilter) {
// Implement region filtering based on coordinates or job site
// This would need your specific region definitions
}

if (show) {
marker.addTo(map);
} else {
map.removeLayer(marker);
}
});

updateSidebar();
}

// Show error message
function showError(message) {
const indicator = document.getElementById('refreshIndicator');
indicator.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
indicator.style.background = 'rgba(231, 76, 60, 0.9)';
indicator.classList.add('show');

setTimeout(() => {
indicator.classList.remove('show');
indicator.innerHTML = '<i class="fas fa-sync-alt fa-spin me-2"></i>Updating locations...';
indicator.style.background = 'rgba(46, 204, 113, 0.9)';
}, 5000);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializeMap);
</script></body></html>
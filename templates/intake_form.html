<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - TRAXOVO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .smart-form {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .photo-upload-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .photo-upload-zone:hover {
            border-color: #764ba2;
            background: #e3f2fd;
        }
        
        .photo-upload-zone.dragover {
            border-color: #27ae60;
            background: #e8f5e8;
        }
        
        .photo-preview {
            position: relative;
            display: inline-block;
            margin: 10px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .photo-preview img {
            width: 150px;
            height: 150px;
            object-fit: cover;
        }
        
        .photo-tag {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px;
            font-size: 0.8rem;
        }
        
        .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 0.8rem;
        }
        
        .smart-suggestions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .suggestion-item {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 20px;
            padding: 5px 15px;
            margin: 5px;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .suggestion-item:hover {
            background: #2196f3;
            color: white;
        }
        
        .priority-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .priority-emergency {
            background: #dc3545;
            color: white;
        }
        
        .priority-high {
            background: #fd7e14;
            color: white;
        }
        
        .priority-medium {
            background: #ffc107;
            color: black;
        }
        
        .priority-low {
            background: #28a745;
            color: white;
        }
        
        .asset-tag-input {
            position: relative;
        }
        
        .asset-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .asset-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .asset-suggestion:hover {
            background: #f8f9fa;
        }
        
        .mobile-optimized {
            padding: 15px;
        }
        
        @media (max-width: 768px) {
            .smart-form {
                padding: 15px;
            }
            
            .form-section {
                padding: 15px;
            }
            
            .photo-upload-zone {
                padding: 20px;
            }
            
            .photo-preview img {
                width: 100px;
                height: 100px;
            }
        }
        
        .work-order-preview {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .po-generator {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .po-generator:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-tools me-2"></i>TRAXOVO Equipment Intake
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/mechanic-dashboard"><i class="fas fa-wrench me-1"></i>Mechanic Portal</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/intake-form"><i class="fas fa-clipboard-list me-1"></i>New Report</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header Section -->
        <div class="row">
            <div class="col-12">
                <div class="smart-form">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="mb-1"><i class="fas fa-camera me-3"></i>Intelligent Equipment Intake</h1>
                            <p class="mb-0">Field-ready reporting with photo tagging and smart PO generation</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-light text-dark fs-6">Field Mode: Active</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <form id="intakeForm" method="POST" action="/submit-intake" enctype="multipart/form-data">
            <!-- Asset Identification Section -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="form-section">
                        <h4><i class="fas fa-search me-2 text-primary"></i>Asset Identification</h4>
                        <div class="mb-3 asset-tag-input">
                            <label class="form-label"><strong>Equipment Type</strong></label>
                            <input type="text" class="form-control" id="equipmentSearch" name="equipment_type" 
                                   placeholder="Start typing equipment type..." autocomplete="off">
                            <div id="assetSuggestions" class="asset-suggestions d-none"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>Division/Job Site</strong></label>
                            <select class="form-select" name="division" id="divisionSelect">
                                <option value="">Select Division...</option>
                                {% for division in divisions %}
                                <option value="{{ division }}">{{ division }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>Asset Location/GPS</strong></label>
                            <input type="text" class="form-control" name="location" 
                                   placeholder="Enter location or use GPS" id="locationInput">
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="getCurrentLocation()">
                                <i class="fas fa-map-marker-alt me-1"></i>Use Current Location
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="form-section">
                        <h4><i class="fas fa-camera me-2 text-primary"></i>Photo Documentation</h4>
                        <div class="photo-upload-zone" onclick="document.getElementById('photoInput').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Drag & Drop Photos or Click to Upload</h5>
                            <p class="text-muted">Support for multiple photos with auto-tagging</p>
                            <input type="file" id="photoInput" name="photos" multiple accept="image/*" style="display: none;">
                        </div>
                        <div id="photoPreview" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Issue Description Section -->
            <div class="row">
                <div class="col-12">
                    <div class="form-section">
                        <h4><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Issue Description</h4>
                        <div class="mb-3">
                            <label class="form-label"><strong>Describe the Issue</strong></label>
                            <textarea class="form-control" name="issue_description" id="issueDescription" 
                                      rows="4" placeholder="Describe what you observed..."></textarea>
                        </div>
                        
                        <div id="smartSuggestions" class="smart-suggestions d-none">
                            <h6><i class="fas fa-lightbulb me-2"></i>Smart Suggestions</h6>
                            <div id="suggestionItems"></div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label"><strong>Predicted Category</strong></label>
                                <input type="text" class="form-control" id="predictedCategory" name="predicted_category" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><strong>Priority Level</strong></label>
                                <div id="priorityDisplay" class="mt-2"></div>
                                <input type="hidden" name="calculated_priority" id="calculatedPriority">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact & Routing Information -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="form-section">
                        <h4><i class="fas fa-user me-2 text-info"></i>Contact Information</h4>
                        <div class="mb-3">
                            <label class="form-label"><strong>Your Name</strong></label>
                            <input type="text" class="form-control" name="contact_info" 
                                   placeholder="Name and phone number">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>Role</strong></label>
                            <select class="form-select" name="user_role">
                                <option value="field_user">Field User</option>
                                <option value="fleet_manager">Fleet Manager</option>
                                <option value="mechanic">Mechanic</option>
                                <option value="equipment_manager">Equipment Manager</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="form-section">
                        <h4><i class="fas fa-route me-2 text-success"></i>Smart Routing</h4>
                        <div id="routingInfo" class="work-order-preview">
                            <p><strong>Department:</strong> <span id="routingDept">Will be calculated...</span></p>
                            <p><strong>Estimated Hours:</strong> <span id="routingHours">TBD</span></p>
                            <p><strong>Required Skills:</strong> <span id="routingSkills">TBD</span></p>
                            <p><strong>Parts Needed:</strong> <span id="routingParts">TBD</span></p>
                        </div>
                        <input type="hidden" name="routing_info" id="routingInfoData">
                    </div>
                </div>
            </div>

            <!-- Smart PO Generation -->
            <div class="row">
                <div class="col-12">
                    <div class="form-section">
                        <h4><i class="fas fa-file-invoice-dollar me-2 text-warning"></i>Smart PO Generation</h4>
                        <div class="row">
                            <div class="col-md-8">
                                <p>Based on the issue analysis, a purchase order can be automatically generated for required parts and services.</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="generatePO" name="generate_po">
                                    <label class="form-check-label" for="generatePO">
                                        Generate Purchase Order for estimated parts
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button type="button" class="po-generator" onclick="previewPO()">
                                    <i class="fas fa-eye me-2"></i>Preview PO
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Section -->
            <div class="row">
                <div class="col-12">
                    <div class="form-section text-center">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-paper-plane me-2"></i>Submit Work Order
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg ms-3" onclick="saveDraft()">
                            <i class="fas fa-save me-2"></i>Save Draft
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- PO Preview Modal -->
    <div class="modal fade" id="poPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-invoice me-2"></i>Purchase Order Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="poPreviewContent">
                    <!-- PO content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadPO()">
                        <i class="fas fa-download me-2"></i>Download PO
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let uploadedPhotos = [];
        let currentRouting = {};

        // Photo upload handling
        document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
        
        // Drag and drop
        const uploadZone = document.querySelector('.photo-upload-zone');
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handlePhotoUpload({target: {files: files}});
        });

        function handlePhotoUpload(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('photoPreview');
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        uploadedPhotos.push({
                            id: photoId,
                            file: file,
                            src: e.target.result,
                            tag: ''
                        });
                        
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'photo-preview';
                        photoDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Equipment Photo">
                            <button type="button" class="remove-photo" onclick="removePhoto('${photoId}')">Ã—</button>
                            <div class="photo-tag">
                                <input type="text" class="form-control form-control-sm" 
                                       placeholder="Tag this photo..." 
                                       onchange="updatePhotoTag('${photoId}', this.value)">
                            </div>
                        `;
                        previewContainer.appendChild(photoDiv);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function removePhoto(photoId) {
            uploadedPhotos = uploadedPhotos.filter(photo => photo.id !== photoId);
            // Remove from DOM
            event.target.closest('.photo-preview').remove();
        }

        function updatePhotoTag(photoId, tag) {
            const photo = uploadedPhotos.find(p => p.id === photoId);
            if (photo) {
                photo.tag = tag;
            }
        }

        // Asset search with suggestions
        document.getElementById('equipmentSearch').addEventListener('input', function() {
            const searchTerm = this.value;
            if (searchTerm.length > 2) {
                fetch(`/api/asset-suggestions?q=${encodeURIComponent(searchTerm)}`)
                    .then(response => response.json())
                    .then(data => {
                        showAssetSuggestions(data.suggestions);
                    });
            } else {
                hideAssetSuggestions();
            }
        });

        function showAssetSuggestions(suggestions) {
            const container = document.getElementById('assetSuggestions');
            container.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'asset-suggestion';
                div.innerHTML = `
                    <strong>${suggestion.equipment_type}</strong><br>
                    <small>Division: ${suggestion.division} | Status: ${suggestion.status}</small>
                `;
                div.onclick = () => selectAsset(suggestion);
                container.appendChild(div);
            });
            
            container.classList.remove('d-none');
        }

        function hideAssetSuggestions() {
            document.getElementById('assetSuggestions').classList.add('d-none');
        }

        function selectAsset(asset) {
            document.getElementById('equipmentSearch').value = asset.equipment_type;
            document.getElementById('divisionSelect').value = asset.division;
            hideAssetSuggestions();
        }

        // Smart issue prediction
        document.getElementById('issueDescription').addEventListener('input', function() {
            const description = this.value;
            if (description.length > 10) {
                // Predict issue category
                fetch('/api/predict-issue', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({description: description})
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('predictedCategory').value = data.category;
                    showSmartSuggestions(data.suggested_issues);
                    calculatePriority();
                });
            }
        });

        function showSmartSuggestions(issues) {
            const container = document.getElementById('smartSuggestions');
            const itemsContainer = document.getElementById('suggestionItems');
            
            itemsContainer.innerHTML = '';
            issues.forEach(issue => {
                const span = document.createElement('span');
                span.className = 'suggestion-item';
                span.textContent = issue;
                span.onclick = () => {
                    document.getElementById('issueDescription').value += ' ' + issue;
                    calculatePriority();
                };
                itemsContainer.appendChild(span);
            });
            
            container.classList.remove('d-none');
        }

        function calculatePriority() {
            const equipmentType = document.getElementById('equipmentSearch').value;
            const issueCategory = document.getElementById('predictedCategory').value;
            const description = document.getElementById('issueDescription').value;
            
            if (equipmentType && issueCategory && description) {
                fetch('/api/calculate-priority', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        equipment_type: equipmentType,
                        issue_category: issueCategory,
                        description: description
                    })
                })
                .then(response => response.json())
                .then(data => {
                    displayPriority(data.priority);
                    displayRouting(data.routing);
                    currentRouting = data.routing;
                });
            }
        }

        function displayPriority(priority) {
            const container = document.getElementById('priorityDisplay');
            const className = `priority-${priority.toLowerCase()}`;
            container.innerHTML = `<span class="priority-indicator ${className}">${priority}</span>`;
            document.getElementById('calculatedPriority').value = priority;
        }

        function displayRouting(routing) {
            document.getElementById('routingDept').textContent = routing.department;
            document.getElementById('routingHours').textContent = routing.estimated_hours + ' hours';
            document.getElementById('routingSkills').textContent = routing.required_skills.join(', ');
            document.getElementById('routingParts').textContent = routing.parts_likely_needed.join(', ');
            document.getElementById('routingInfoData').value = JSON.stringify(routing);
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    document.getElementById('locationInput').value = `GPS: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        function previewPO() {
            const poContent = generatePOContent();
            document.getElementById('poPreviewContent').innerHTML = poContent;
            new bootstrap.Modal(document.getElementById('poPreviewModal')).show();
        }

        function generatePOContent() {
            const parts = currentRouting.parts_likely_needed || [];
            const hours = currentRouting.estimated_hours || 0;
            
            let poHTML = `
                <div class="po-header">
                    <h6>TRAXOVO Purchase Order</h6>
                    <p>PO Number: PO-${Date.now()}</p>
                    <p>Date: ${new Date().toLocaleDateString()}</p>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Quantity</th>
                            <th>Est. Cost</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            parts.forEach(part => {
                const estimatedCost = Math.floor(Math.random() * 200) + 50; // Placeholder pricing
                poHTML += `
                    <tr>
                        <td>${part}</td>
                        <td>1</td>
                        <td>$${estimatedCost}</td>
                    </tr>
                `;
            });
            
            if (hours > 0) {
                poHTML += `
                    <tr>
                        <td>Labor (${hours} hours)</td>
                        <td>${hours}</td>
                        <td>$${hours * 85}</td>
                    </tr>
                `;
            }
            
            poHTML += `
                    </tbody>
                </table>
            `;
            
            return poHTML;
        }

        function downloadPO() {
            // This would generate and download a PDF PO
            alert('PO download functionality would integrate with your accounting system');
        }

        function saveDraft() {
            // Save form data to localStorage
            const formData = new FormData(document.getElementById('intakeForm'));
            const draftData = Object.fromEntries(formData.entries());
            localStorage.setItem('intake_draft', JSON.stringify(draftData));
            alert('Draft saved successfully!');
        }

        // Load draft on page load if exists
        document.addEventListener('DOMContentLoaded', function() {
            const draft = localStorage.getItem('intake_draft');
            if (draft) {
                const draftData = JSON.parse(draft);
                // Populate form fields with draft data
                Object.keys(draftData).forEach(key => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        element.value = draftData[key];
                    }
                });
            }
        });
    </script>
</body>
</html>
{% extends 'base.html' %}

{% block title %}Kaizen Dashboard - SYSTEMSMITH{% endblock %}

{% block content %}
<div class="container mt-4"><div class="d-flex justify-content-between align-items-center mb-4"><h1>System Self-Improvement</h1><div><a href="{{ url_for('kaizen.health') }}" class="btn btn-outline-info me-2"><i class="fas fa-heartbeat me-1"></i> System Health
</a><a href="{{ url_for('kaizen.suggestions') }}" class="btn btn-outline-primary me-2"><i class="fas fa-lightbulb me-1"></i> Improvement Suggestions
</a><a href="{{ url_for('kaizen.mappings') }}" class="btn btn-outline-secondary"><i class="fas fa-link me-1"></i> Employee-Asset Mappings
</a></div></div><div class="row"><div class="col-lg-8"><div class="card mb-4"><div class="card-header bg-dark text-white d-flex justify-content-between align-items-center"><h5 class="mb-0">System Health Overview</h5><a href="{{ url_for('kaizen.health') }}" class="btn btn-sm btn-light">View Details</a></div><div class="card-body"><div class="row"><div class="col-md-4 text-center mb-3 mb-md-0"><div class="position-relative d-inline-block"><canvas id="healthChart" width="150" height="150"></canvas><div class="position-absolute top-50 start-50 translate-middle text-center"><h2 class="mb-0">{{ health_score.overall_health_score|default(0)|round|int }}%</h2></div></div><p class="mt-2 mb-0">Overall System Health</p></div><div class="col-md-8"><h6 class="border-bottom pb-2 mb-3">Health Components</h6><div class="mb-3"><div class="d-flex justify-content-between align-items-center mb-1"><span>Data Completeness</span><span class="badge bg-{{ 'danger' if health_score.data_completeness.score < 70 else 'warning' if health_score.data_completeness.score < 90 else 'success' }}">
{{ health_score.data_completeness.score|default(0)|round(1) }}%
</span></div><div class="progress" style="height: 8px;"><div class="progress-bar bg-{{ 'danger' if health_score.data_completeness.score < 70 else 'warning' if health_score.data_completeness.score < 90 else 'success' }}"
role="progressbar"
style="width: {{ health_score.data_completeness.score|default(0) }}%;"
aria-valuenow="{{ health_score.data_completeness.score|default(0) }}"
aria-valuemin="0"
aria-valuemax="100"></div></div></div><div class="mb-3"><div class="d-flex justify-content-between align-items-center mb-1"><span>File Match Rate</span><span class="badge bg-{{ 'danger' if health_score.file_match_rate.score < 70 else 'warning' if health_score.file_match_rate.score < 90 else 'success' }}">
{{ health_score.file_match_rate.score|default(0)|round(1) }}%
</span></div><div class="progress" style="height: 8px;"><div class="progress-bar bg-{{ 'danger' if health_score.file_match_rate.score < 70 else 'warning' if health_score.file_match_rate.score < 90 else 'success' }}"
role="progressbar"
style="width: {{ health_score.file_match_rate.score|default(0) }}%;"
aria-valuenow="{{ health_score.file_match_rate.score|default(0) }}"
aria-valuemin="0"
aria-valuemax="100"></div></div></div><div><div class="d-flex justify-content-between align-items-center mb-1"><span>Asset Assignment Accuracy</span><span class="badge bg-{{ 'danger' if health_score.asset_assignment_accuracy.score < 70 else 'warning' if health_score.asset_assignment_accuracy.score < 90 else 'success' }}">
{{ health_score.asset_assignment_accuracy.score|default(0)|round(1) }}%
</span></div><div class="progress" style="height: 8px;"><div class="progress-bar bg-{{ 'danger' if health_score.asset_assignment_accuracy.score < 70 else 'warning' if health_score.asset_assignment_accuracy.score < 90 else 'success' }}"
role="progressbar"
style="width: {{ health_score.asset_assignment_accuracy.score|default(0) }}%;"
aria-valuenow="{{ health_score.asset_assignment_accuracy.score|default(0) }}"
aria-valuemin="0"
aria-valuemax="100"></div></div></div></div></div><div class="mt-4 pt-3 border-top"><h6 class="mb-3">System Health Trend</h6><canvas id="healthHistoryChart" height="200"></canvas></div></div></div><div class="card"><div class="card-header bg-primary text-white d-flex justify-content-between align-items-center"><h5 class="mb-0">Top Improvement Suggestions</h5><a href="{{ url_for('kaizen.suggestions') }}" class="btn btn-sm btn-light">View All</a></div><div class="card-body p-0">
{% if pending_suggestions %}
<div class="list-group list-group-flush">
{% for suggestion in pending_suggestions[:5] %}
<div class="list-group-item"><div class="d-flex w-100 justify-content-between mb-1"><h6 class="mb-0">{{ suggestion.title }}</h6><small class="text-muted">{{ suggestion.date_created[:10] }}</small></div><p class="mb-1">{{ suggestion.description }}</p><div class="d-flex justify-content-between align-items-center"><small class="text-muted"><span class="badge bg-{{ 'danger' if suggestion.priority == 'High' else 'warning' if suggestion.priority == 'Medium' else 'secondary' }}">
{{ suggestion.priority }}
</span><span class="ms-2">Category: {{ suggestion.category }}</span></small>
{% if current_user.is_admin %}
<form action="{{ url_for('kaizen.implement_suggestion', suggestion_id=suggestion.id) }}" method="post" class="d-inline"><button type="submit" class="btn btn-sm btn-outline-success">Mark Implemented</button></form>
{% endif %}
</div></div>
{% endfor %}
</div>
{% else %}
<div class="alert alert-info m-3"><i class="fas fa-info-circle me-1"></i> No pending improvement suggestions.
</div>
{% endif %}
</div></div></div><div class="col-lg-4"><div class="card mb-4"><div class="card-header bg-info text-white"><h5 class="mb-0">Kaizen Metrics</h5></div><div class="card-body"><div class="mb-4"><h6 class="border-bottom pb-2 mb-3">Improvement Progress</h6><div class="row text-center"><div class="col-6 mb-3"><h3>{{ implemented_suggestions|length }}</h3><small class="text-muted">Implemented</small></div><div class="col-6 mb-3"><h3>{{ pending_suggestions|length }}</h3><small class="text-muted">Pending</small></div></div><div class="d-flex justify-content-between align-items-center mb-1"><span>Implementation Rate</span>
{% set total = (implemented_suggestions|length + pending_suggestions|length) %}
{% set impl_rate = (implemented_suggestions|length / total * 100) if total > 0 else 0 %}
<span class="badge bg-{{ 'danger' if impl_rate < 30 else 'warning' if impl_rate < 70 else 'success' }}">
{{ impl_rate|round }}%
</span></div><div class="progress" style="height: 8px;"><div class="progress-bar bg-{{ 'danger' if impl_rate < 30 else 'warning' if impl_rate < 70 else 'success' }}"
role="progressbar"
style="width: {{ impl_rate }}%;"
aria-valuenow="{{ impl_rate }}"
aria-valuemin="0"
aria-valuemax="100"></div></div></div><div><h6 class="border-bottom pb-2 mb-3">Asset-Employee Mapping</h6>
{% set mapping_stats = health_score.asset_assignment_accuracy.details %}
<div class="row text-center"><div class="col-4"><div class="p-2 rounded bg-success bg-opacity-10 mb-2"><h4>{{ mapping_stats.high_confidence|default(0) }}</h4></div><small class="text-muted">High Confidence</small></div><div class="col-4"><div class="p-2 rounded bg-warning bg-opacity-10 mb-2"><h4>{{ mapping_stats.medium_confidence|default(0) }}</h4></div><small class="text-muted">Medium</small></div><div class="col-4"><div class="p-2 rounded bg-danger bg-opacity-10 mb-2"><h4>{{ mapping_stats.low_confidence|default(0) }}</h4></div><small class="text-muted">Low</small></div></div><div class="text-center mt-3"><a href="{{ url_for('kaizen.mappings') }}" class="btn btn-sm btn-outline-secondary">View Mappings</a></div></div></div></div><div class="card"><div class="card-header bg-success text-white"><h5 class="mb-0">Recently Implemented</h5></div><div class="card-body p-0">
{% if implemented_suggestions %}
<div class="list-group list-group-flush">
{% for suggestion in implemented_suggestions %}
<div class="list-group-item"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1">{{ suggestion.title }}</h6><small class="text-success">{{ suggestion.implemented_at[:10] }}</small></div><p class="mb-0 small text-muted">{{ suggestion.description }}</p></div>
{% endfor %}
</div>
{% else %}
<div class="alert alert-info m-3"><i class="fas fa-info-circle me-1"></i> No implemented suggestions yet.
</div>
{% endif %}
</div></div></div></div></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
// Main health chart
const ctx = document.getElementById('healthChart').getContext('2d');
const healthScore = {{ health_score.overall_health_score|default(0) }};

// Determine color based on score
let color = '#dc3545'; // red
if (healthScore >= 80) {
color = '#28a745'; // green
} else if (healthScore >= 60) {
color = '#ffc107'; // yellow
} else if (healthScore >= 40) {
color = '#fd7e14'; // orange
}

const healthChart = new Chart(ctx, {
type: 'doughnut',
data: {
datasets: [{
data: [healthScore, 100 - healthScore],
backgroundColor: [color, '#e9ecef'],
borderWidth: 0
}]
},
options: {
cutout: '75%',
responsive: true,
maintainAspectRatio: true,
plugins: {
legend: {
display: false
},
tooltip: {
enabled: false
}
}
}
});

// Health history chart
const historyCtx = document.getElementById('healthHistoryChart').getContext('2d');
const historyData = {
labels: [
{% for entry in history %}
'{{ entry.timestamp[:10] }}',
{% endfor %}
],
datasets: [
{
label: 'Overall Health',
data: [
{% for entry in history %}
{{ entry.overall_health_score }},
{% endfor %}
],
borderColor: '#6f42c1',
backgroundColor: 'rgba(111, 66, 193, 0.1)',
fill: true,
tension: 0.1
},
{
label: 'Data Completeness',
data: [
{% for entry in history %}
{{ entry.data_completeness }},
{% endfor %}
],
borderColor: '#007bff',
borderDash: [5, 5],
fill: false
},
{
label: 'File Match Rate',
data: [
{% for entry in history %}
{{ entry.file_match_rate }},
{% endfor %}
],
borderColor: '#28a745',
borderDash: [5, 5],
fill: false
},
{
label: 'Asset Assignment',
data: [
{% for entry in history %}
{{ entry.asset_assignment_accuracy }},
{% endfor %}
],
borderColor: '#17a2b8',
borderDash: [5, 5],
fill: false
}
]
};

const historyChart = new Chart(historyCtx, {
type: 'line',
data: historyData,
options: {
responsive: true,
maintainAspectRatio: true,
scales: {
y: {
min: 0,
max: 100
}
},
plugins: {
legend: {
position: 'bottom'
}
}
}
});
});
</script>
{% endblock %}
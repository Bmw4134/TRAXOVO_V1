{% extends "base.html" %}

{% block title %}Kaizen Core Admin - TRAXORA{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Kaizen Core Admin</h1>
        <a href="{{ url_for('system_admin.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to System Admin
        </a>
    </div>
    
    <div class="alert alert-primary">
        <h4 class="alert-heading"><i class="bi bi-gear-fill"></i> Full-Stack Sync Enforcement System</h4>
        <p>This system ensures backend routes and frontend UI elements stay properly synchronized.</p>
        <hr>
        <div class="d-flex align-items-center">
            <span class="me-3">
                Watchdog Status: 
                {% if watchdog_active %}
                <span class="badge bg-success">Active</span>
                {% else %}
                <span class="badge bg-warning">Inactive</span>
                {% endif %}
            </span>
            {% if not watchdog_active %}
            <a href="{{ url_for('kaizen_admin.start_watchdog') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-play-circle"></i> Start Watchdog
            </a>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Sync Controls</h5>
                </div>
                <div class="card-body">
                    <p>These tools allow you to manually trigger sync tests and audits.</p>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('kaizen_admin.run_sync_test') }}" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Run Sync Test
                        </a>
                        <a href="{{ url_for('kaizen_admin.run_audit') }}" class="btn btn-info text-white">
                            <i class="bi bi-lightning"></i> Run Integrity Audit
                        </a>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">Last action: {{ timestamp }}</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-sliders"></i> Configuration</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('kaizen_admin.update_config') }}" method="post">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto_sync" name="auto_sync" {% if config.auto_sync %}checked{% endif %}>
                                <label class="form-check-label" for="auto_sync">Auto-Sync</label>
                            </div>
                            <small class="text-muted">Automatically run sync tests when files change</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto_patch" name="auto_patch" {% if config.auto_patch %}checked{% endif %}>
                                <label class="form-check-label" for="auto_patch">Auto-Patch</label>
                            </div>
                            <small class="text-muted">Automatically fix sync issues when detected</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify_on_issues" name="notify_on_issues" {% if config.notify_on_issues %}checked{% endif %}>
                                <label class="form-check-label" for="notify_on_issues">Notify on Issues</label>
                            </div>
                            <small class="text-muted">Show notifications when sync issues are detected</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="strict_mode" name="strict_mode" {% if config.strict_mode %}checked{% endif %}>
                                <label class="form-check-label" for="strict_mode">Strict Mode</label>
                            </div>
                            <small class="text-muted">Treat warnings as errors and block application startup</small>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-save"></i> Save Configuration
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">Last updated: {{ config.last_updated|default(timestamp) }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> System Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">Route-Template Sync</h5>
                                    <div id="route-sync-status">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span>Checking...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">Database Integrity</h5>
                                    <div id="db-integrity-status">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span>Checking...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">UI Rendering</h5>
                                    <div id="ui-rendering-status">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span>Checking...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Last checked: <span id="status-timestamp">{{ timestamp }}</span></small>
                        <button id="refresh-status" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-repeat"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-list-check"></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group" id="activity-log">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>System Initialized</strong>
                                <p class="mb-0 small text-muted">Kaizen Core started successfully</p>
                            </div>
                            <span class="badge bg-primary rounded-pill">{{ timestamp }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch status on page load
        updateSystemStatus();
        
        // Set up refresh button
        document.getElementById('refresh-status').addEventListener('click', updateSystemStatus);
    });
    
    function updateSystemStatus() {
        // Update the status timestamp
        document.getElementById('status-timestamp').textContent = new Date().toLocaleString();
        
        // Simulate fetching status (this would be an API call in a real implementation)
        setTimeout(() => {
            // Route-Template Sync Status
            const routeSyncStatus = document.getElementById('route-sync-status');
            routeSyncStatus.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>Routes/Templates</span>
                    <span class="badge bg-success">Synchronized</span>
                </div>
                <p class="mt-2 mb-0 small">All routes have corresponding UI elements</p>
            `;
            
            // Database Integrity Status
            const dbIntegrityStatus = document.getElementById('db-integrity-status');
            dbIntegrityStatus.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>Relationships</span>
                    <span class="badge bg-success">Valid</span>
                </div>
                <p class="mt-2 mb-0 small">All relationships properly defined</p>
            `;
            
            // UI Rendering Status
            const uiRenderingStatus = document.getElementById('ui-rendering-status');
            uiRenderingStatus.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>Components</span>
                    <span class="badge bg-success">Rendering</span>
                </div>
                <p class="mt-2 mb-0 small">All UI components properly rendered</p>
            `;
            
            // Add to activity log
            const activityLog = document.getElementById('activity-log');
            const newActivity = document.createElement('li');
            newActivity.className = 'list-group-item d-flex justify-content-between align-items-center';
            newActivity.innerHTML = `
                <div>
                    <strong>Status Check</strong>
                    <p class="mb-0 small text-muted">System status verified</p>
                </div>
                <span class="badge bg-info rounded-pill">${new Date().toLocaleTimeString()}</span>
            `;
            activityLog.insertBefore(newActivity, activityLog.firstChild);
        }, 1000);
    }
</script>
{% endblock %}
{% endblock %}
{% extends "layout.html" %}

{% block title %}System Logs{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="display-5 mb-2">
                <i class="bi bi-journal-text me-2"></i>System Logs
            </h1>
            <p class="lead text-muted">
                Monitor application logs and diagnostics
            </p>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="btn-group">
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="bi bi-house me-1"></i> Dashboard
                </a>
                <button id="refreshBtn" class="btn btn-success">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-4">
                            <label for="log_file" class="form-label">Log File</label>
                            <select class="form-select" id="log_file" name="log_file">
                                {% for file in log_files %}
                                <option value="{{ file }}" {% if file == selected_log %}selected{% endif %}>{{ file }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="level" class="form-label">Log Level</label>
                            <select class="form-select" id="level" name="level">
                                <option value="" {% if not level %}selected{% endif %}>All Levels</option>
                                <option value="DEBUG" {% if level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                                <option value="INFO" {% if level == 'INFO' %}selected{% endif %}>INFO</option>
                                <option value="WARNING" {% if level == 'WARNING' %}selected{% endif %}>WARNING</option>
                                <option value="ERROR" {% if level == 'ERROR' %}selected{% endif %}>ERROR</option>
                                <option value="CRITICAL" {% if level == 'CRITICAL' %}selected{% endif %}>CRITICAL</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="max_entries" class="form-label">Max Entries</label>
                            <select class="form-select" id="max_entries" name="max_entries">
                                <option value="25" {% if max_entries == 25 %}selected{% endif %}>25</option>
                                <option value="50" {% if max_entries == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if max_entries == 100 %}selected{% endif %}>100</option>
                                <option value="250" {% if max_entries == 250 %}selected{% endif %}>250</option>
                                <option value="500" {% if max_entries == 500 %}selected{% endif %}>500</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-filter me-1"></i> Apply Filters
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Entries -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-1"></i> Log Entries
                    </h5>
                    <div>
                        <span class="badge bg-primary">{{ log_entries|length }} entries</span>
                        <span class="badge bg-secondary ms-1">{{ selected_log }}</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" width="180">Timestamp</th>
                                    <th scope="col" width="100">Level</th>
                                    <th scope="col" width="150">Module</th>
                                    <th scope="col">Message</th>
                                    <th scope="col" width="100">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if log_entries %}
                                {% for entry in log_entries %}
                                <tr>
                                    <td>{{ entry.timestamp }}</td>
                                    <td>
                                        <span class="badge
                                            {% if entry.level == 'DEBUG' %}bg-info{% endif %}
                                            {% if entry.level == 'INFO' %}bg-success{% endif %}
                                            {% if entry.level == 'WARNING' %}bg-warning{% endif %}
                                            {% if entry.level == 'ERROR' %}bg-danger{% endif %}
                                            {% if entry.level == 'CRITICAL' %}bg-danger{% endif %}">
                                            {{ entry.level }}
                                        </span>
                                    </td>
                                    <td>{{ entry.module }}</td>
                                    <td>{{ entry.message }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info view-details-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#logDetailsModal"
                                                data-entry="{{ entry|tojson }}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center p-4">
                                        <div class="text-muted">
                                            <i class="bi bi-journal-x fs-1 mb-3"></i>
                                            <p>No log entries found matching the selected criteria.</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logDetailsModalLabel">Log Entry Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-2">
                            <strong>Timestamp:</strong>
                            <span id="modalTimestamp"></span>
                        </div>
                        <div class="mb-2">
                            <strong>Level:</strong>
                            <span id="modalLevel"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-2">
                            <strong>Module:</strong>
                            <span id="modalModule"></span>
                        </div>
                        <div class="mb-2">
                            <strong>Function:</strong>
                            <span id="modalFunction"></span>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Message:</strong>
                    <p id="modalMessage"></p>
                </div>
                <div id="modalExceptionContainer" class="mb-3 d-none">
                    <strong>Exception:</strong>
                    <div class="alert alert-danger">
                        <div class="mb-1"><strong>Type:</strong> <span id="modalExceptionType"></span></div>
                        <div class="mb-2"><strong>Message:</strong> <span id="modalExceptionMessage"></span></div>
                        <div>
                            <strong>Traceback:</strong>
                            <pre class="bg-dark text-white p-3 mt-2 mb-0 rounded" id="modalExceptionTraceback" style="max-height: 300px; overflow-y: auto;"></pre>
                        </div>
                    </div>
                </div>
                <div id="modalExtraContainer" class="mb-3 d-none">
                    <strong>Additional Data:</strong>
                    <pre class="bg-light p-3 mt-2 mb-0 rounded" id="modalExtraData" style="max-height: 300px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle view details buttons
    const viewDetailsBtns = document.querySelectorAll('.view-details-btn');
    viewDetailsBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const entryData = JSON.parse(this.getAttribute('data-entry'));
            
            // Fill modal with data
            document.getElementById('modalTimestamp').textContent = entryData.timestamp || '';
            document.getElementById('modalLevel').textContent = entryData.level || '';
            document.getElementById('modalModule').textContent = entryData.module || '';
            document.getElementById('modalFunction').textContent = entryData.function || '';
            document.getElementById('modalMessage').textContent = entryData.message || '';
            
            // Handle exception data if present
            const exceptionContainer = document.getElementById('modalExceptionContainer');
            if (entryData.exception) {
                exceptionContainer.classList.remove('d-none');
                document.getElementById('modalExceptionType').textContent = entryData.exception.type || '';
                document.getElementById('modalExceptionMessage').textContent = entryData.exception.message || '';
                
                let tracebackHtml = '';
                if (Array.isArray(entryData.exception.traceback)) {
                    tracebackHtml = entryData.exception.traceback.join('\n');
                } else {
                    tracebackHtml = entryData.exception.traceback || '';
                }
                document.getElementById('modalExceptionTraceback').textContent = tracebackHtml;
            } else {
                exceptionContainer.classList.add('d-none');
            }
            
            // Handle extra data if present
            const extraContainer = document.getElementById('modalExtraContainer');
            const extraData = { ...entryData };
            
            // Remove standard fields
            delete extraData.timestamp;
            delete extraData.level;
            delete extraData.module;
            delete extraData.function;
            delete extraData.message;
            delete extraData.exception;
            
            if (Object.keys(extraData).length > 0) {
                extraContainer.classList.remove('d-none');
                document.getElementById('modalExtraData').textContent = JSON.stringify(extraData, null, 2);
            } else {
                extraContainer.classList.add('d-none');
            }
        });
    });
    
    // Handle refresh button
    document.getElementById('refreshBtn').addEventListener('click', function() {
        window.location.reload();
    });
});
</script>
{% endblock %}
{% extends "layout.html" %}

{% block title %}Maintenance Dashboard{% endblock %}

{% block content %}
<div class="container-fluid my-4"><div class="row mb-4"><div class="col-md-6"><h1 class="display-5 mb-2"><i class="bi bi-tools me-2"></i>Maintenance Dashboard
</h1><p class="lead text-muted">
Schedule and track maintenance for your fleet assets
</p></div><div class="col-md-6 text-md-end"><div class="btn-group"><a href="/" class="btn btn-danger"><i class="bi bi-speedometer2 me-1"></i> Back to Dashboard
</a><a href="{{ url_for('maintenance.create_schedule') }}" class="btn btn-success"><i class="bi bi-plus-circle me-1"></i> New Schedule
</a><a href="{{ url_for('maintenance.maintenance_schedules') }}" class="btn btn-primary"><i class="bi bi-calendar-check me-1"></i> All Schedules
</a><a href="{{ url_for('maintenance.maintenance_records') }}" class="btn btn-info text-white"><i class="bi bi-clock-history me-1"></i> Records
</a></div></div></div><div class="row mb-4"><div class="col-md-3 col-sm-6 mb-3"><div class="card bg-success text-white h-100"><div class="card-body text-center"><h1 class="display-4 mb-0">{{ scheduled_count }}</h1><h5 class="card-title">Scheduled</h5></div><div class="card-footer d-flex justify-content-between align-items-center"><span>Next 7 days: {{ upcoming_week }}</span><a href="{{ url_for('maintenance.maintenance_schedules') }}" class="text-white"><i class="bi bi-arrow-right"></i></a></div></div></div><div class="col-md-3 col-sm-6 mb-3"><div class="card bg-danger text-white h-100"><div class="card-body text-center"><h1 class="display-4 mb-0">{{ overdue_count }}</h1><h5 class="card-title">Overdue</h5></div><div class="card-footer text-center"><a href="{{ url_for('maintenance.maintenance_schedules') }}?status=Overdue" class="text-white">View Overdue Tasks <i class="bi bi-arrow-right ms-1"></i></a></div></div></div><div class="col-md-3 col-sm-6 mb-3"><div class="card bg-info text-white h-100"><div class="card-body text-center"><h1 class="display-4 mb-0">{{ completed_count }}</h1><h5 class="card-title">Completed</h5></div><div class="card-footer text-center"><a href="{{ url_for('maintenance.maintenance_records') }}" class="text-white">View History <i class="bi bi-arrow-right ms-1"></i></a></div></div></div><div class="col-md-3 col-sm-6 mb-3"><div class="card bg-primary text-white h-100"><div class="card-body text-center"><h1 class="display-4 mb-0">{{ technicians|length }}</h1><h5 class="card-title">Technicians</h5></div><div class="card-footer text-center"><a href="{{ url_for('maintenance.technicians') }}" class="text-white">Manage Techs <i class="bi bi-arrow-right ms-1"></i></a></div></div></div></div><div class="row mb-4"><div class="col-12"><div class="card shadow-sm"><div class="card-header bg-light"><h5 class="card-title mb-0"><i class="bi bi-lightning-charge me-1"></i> Quick Actions</h5></div><div class="card-body"><div class="row"><div class="col-md-3 mb-3"><a href="{{ url_for('maintenance.create_schedule') }}" class="btn btn-outline-primary w-100 py-3"><i class="bi bi-plus-circle d-block mb-2 fs-2"></i>
Create Maintenance Schedule
</a></div><div class="col-md-3 mb-3"><a href="#completeTaskModal" data-bs-toggle="modal" class="btn btn-outline-success w-100 py-3"><i class="bi bi-check2-circle d-block mb-2 fs-2"></i>
Complete Maintenance Task
</a></div><div class="col-md-3 mb-3"><a href="#generateReportModal" data-bs-toggle="modal" class="btn btn-outline-info w-100 py-3"><i class="bi bi-file-earmark-bar-graph d-block mb-2 fs-2"></i>
Generate Maintenance Report
</a></div><div class="col-md-3 mb-3"><a href="#assignTechModal" data-bs-toggle="modal" class="btn btn-outline-secondary w-100 py-3"><i class="bi bi-person-badge d-block mb-2 fs-2"></i>
Assign Technician
</a></div></div></div></div></div></div><div class="row mb-4"><div class="col-12"><div class="card shadow-sm"><div class="card-header bg-light d-flex justify-content-between align-items-center"><h5 class="card-title mb-0"><i class="bi bi-calendar-check me-1"></i> Upcoming Maintenance</h5><a href="{{ url_for('maintenance.maintenance_schedules') }}" class="btn btn-sm btn-primary">View All</a></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover mb-0"><thead class="table-light"><tr><th>Asset</th><th>Task</th><th>Next Due</th><th>Status</th><th>Technician</th><th>Priority</th><th class="text-center">Actions</th></tr></thead><tbody>
{% for schedule in schedules %}
<tr class="{{ 'table-danger' if schedule.status == 'Overdue' }}"><td><strong>{{ schedule.asset_id }}</strong><br><small class="text-muted">{{ schedule.asset_name }}</small></td><td>{{ schedule.task }}</td><td>
{{ schedule.next_due.strftime('%m/%d/%Y') }}<br><small class="text-muted">{{ (schedule.next_due - now).days }} days from now</small></td><td>
{% if schedule.status == 'Scheduled' %}
<span class="badge bg-success">{{ schedule.status }}</span>
{% elif schedule.status == 'Overdue' %}
<span class="badge bg-danger">{{ schedule.status }}</span>
{% else %}
<span class="badge bg-secondary">{{ schedule.status }}</span>
{% endif %}
</td><td>{{ schedule.tech_assigned }}</td><td>
{% if schedule.priority == 'High' %}
<span class="badge bg-warning text-dark">{{ schedule.priority }}</span>
{% elif schedule.priority == 'Medium' %}
<span class="badge bg-info">{{ schedule.priority }}</span>
{% elif schedule.priority == 'Critical' %}
<span class="badge bg-danger">{{ schedule.priority }}</span>
{% else %}
<span class="badge bg-secondary">{{ schedule.priority }}</span>
{% endif %}
</td><td class="text-center"><div class="btn-group btn-group-sm"><a href="{{ url_for('maintenance.schedule_detail', schedule_id=schedule.id) }}" class="btn btn-outline-primary" data-bs-toggle="tooltip" title="View Details"><i class="bi bi-eye"></i></a><a href="{{ url_for('maintenance.complete_maintenance', schedule_id=schedule.id) }}" class="btn btn-outline-success" data-bs-toggle="tooltip" title="Mark Complete"><i class="bi bi-check2"></i></a><button type="button" class="btn btn-outline-secondary" data-bs-toggle="tooltip" title="Reassign"><i class="bi bi-person-badge"></i></button></div></td></tr>
{% endfor %}
</tbody></table></div></div></div></div></div><div class="row"><div class="col-md-8 mb-4"><div class="card shadow-sm h-100"><div class="card-header bg-light"><h5 class="card-title mb-0"><i class="bi bi-activity me-1"></i> Recent Maintenance Activity</h5></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover mb-0"><thead class="table-light"><tr><th>Date</th><th>Asset</th><th>Task</th><th>Technician</th><th>Cost</th></tr></thead><tbody>
{% for record in records[:5] %}
<tr><td>{{ record.date_completed.strftime('%m/%d/%Y') }}</td><td>{{ record.asset_id }}</td><td>{{ record.task }}</td><td>{{ record.technician }}</td><td>${{ '%0.2f'| format(record.cost) }}</td></tr>
{% endfor %}
</tbody></table></div></div><div class="card-footer text-center"><a href="{{ url_for('maintenance.maintenance_records') }}" class="btn btn-sm btn-outline-primary">View All Records</a></div></div></div><div class="col-md-4 mb-4"><div class="card shadow-sm h-100"><div class="card-header bg-light"><h5 class="card-title mb-0"><i class="bi bi-person-check me-1"></i> Technician Availability</h5></div><div class="card-body p-0"><ul class="list-group list-group-flush">
{% for tech in technicians %}
<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong>{{ tech.name }}</strong><div class="text-muted small">{{ tech.role }}</div></div>
{% if tech.available %}
<span class="badge bg-success rounded-pill">Available</span>
{% else %}
<span class="badge bg-secondary rounded-pill">Unavailable</span>
{% endif %}
</li>
{% endfor %}
</ul></div><div class="card-footer text-center"><a href="{{ url_for('maintenance.technicians') }}" class="btn btn-sm btn-outline-primary">Manage Technicians</a></div></div></div></div></div><div class="modal fade" id="completeTaskModal" tabindex="-1" aria-labelledby="completeTaskModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title" id="completeTaskModalLabel">Complete Maintenance Task</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="completeTaskForm"><div class="mb-3"><label for="asset-select" class="form-label">Select Asset</label><select class="form-select" id="asset-select" required><option value="" selected disabled>Choose an asset...</option>
{% for schedule in schedules %}
<option value="{{ schedule.id }}">{{ schedule.asset_id }} - {{ schedule.asset_name }}</option>
{% endfor %}
</select></div><div class="mb-3"><label for="task-select" class="form-label">Maintenance Task</label><select class="form-select" id="task-select" required><option value="" selected disabled>Choose a task...</option><option value="1">Oil Change</option><option value="2">Hydraulic System Inspection</option><option value="3">Brake System Service</option><option value="4">Complete Inspection</option><option value="5">Filter Replacement</option></select></div><div class="mb-3"><label for="completion-date" class="form-label">Completion Date</label><input type="date" class="form-control" id="completion-date" value="{{ now.strftime('%Y-%m-%d') }}" required></div><div class="mb-3"><label for="tech-select" class="form-label">Technician</label><select class="form-select" id="tech-select" required><option value="" selected disabled>Select technician...</option>
{% for tech in technicians %}
<option value="{{ tech.id }}">{{ tech.name }}</option>
{% endfor %}
</select></div><div class="mb-3"><label for="notes" class="form-label">Notes</label><textarea class="form-control" id="notes" rows="3"></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-success" id="completeTaskBtn">Complete Task</button></div></div></div></div><div class="modal fade" id="generateReportModal" tabindex="-1" aria-labelledby="generateReportModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title" id="generateReportModalLabel">Generate Maintenance Report</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="reportForm"><div class="mb-3"><label for="report-type" class="form-label">Report Type</label><select class="form-select" id="report-type" required><option value="" selected disabled>Select report type...</option><option value="asset_history">Asset Maintenance History</option><option value="maintenance_summary">Maintenance Summary</option><option value="upcoming_maintenance">Upcoming Maintenance</option><option value="cost_analysis">Cost Analysis</option><option value="technician_performance">Technician Performance</option></select></div><div class="mb-3"><label for="report-period" class="form-label">Time Period</label><select class="form-select" id="report-period" required><option value="30days">Last 30 Days</option><option value="90days">Last 90 Days</option><option value="6months">Last 6 Months</option><option value="12months">Last 12 Months</option><option value="custom">Custom Range</option></select></div><div class="row mb-3" id="custom-date-range" style="display: none;"><div class="col-md-6"><label for="start-date" class="form-label">Start Date</label><input type="date" class="form-control" id="start-date"></div><div class="col-md-6"><label for="end-date" class="form-label">End Date</label><input type="date" class="form-control" id="end-date"></div></div><div class="mb-3"><label for="report-format" class="form-label">Report Format</label><div class="btn-group d-flex" role="group" aria-label="Report format options"><input type="radio" class="btn-check" name="report-format" id="format-pdf" value="pdf" checked><label class="btn btn-outline-primary" for="format-pdf">PDF</label><input type="radio" class="btn-check" name="report-format" id="format-excel" value="excel"><label class="btn btn-outline-primary" for="format-excel">Excel</label><input type="radio" class="btn-check" name="report-format" id="format-csv" value="csv"><label class="btn btn-outline-primary" for="format-csv">CSV</label></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-info text-white" id="generateReportBtn">Generate Report</button></div></div></div></div><div class="modal fade" id="assignTechModal" tabindex="-1" aria-labelledby="assignTechModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-secondary text-white"><h5 class="modal-title" id="assignTechModalLabel">Assign Technician</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="assignTechForm"><div class="mb-3"><label for="assign-asset-select" class="form-label">Select Asset/Task</label><select class="form-select" id="assign-asset-select" required><option value="" selected disabled>Choose an asset and task...</option>
{% for schedule in schedules %}
<option value="{{ schedule.id }}">{{ schedule.asset_id }} - {{ schedule.task }}</option>
{% endfor %}
</select></div><div class="mb-3"><label for="assign-tech-select" class="form-label">Assign to Technician</label><select class="form-select" id="assign-tech-select" required><option value="" selected disabled>Select technician...</option>
{% for tech in technicians %}
<option value="{{ tech.id }}" {{ 'disabled' if not tech.available }}>
{{ tech.name }} {{ '(Unavailable)' if not tech.available }}
</option>
{% endfor %}
</select></div><div class="mb-3"><label for="scheduled-date" class="form-label">Scheduled Date</label><input type="date" class="form-control" id="scheduled-date" required></div><div class="mb-3"><label for="priority-select" class="form-label">Priority</label><select class="form-select" id="priority-select" required><option value="Low">Low</option><option value="Medium" selected>Medium</option><option value="High">High</option><option value="Critical">Critical</option></select></div><div class="mb-3"><label for="assign-notes" class="form-label">Notes for Technician</label><textarea class="form-control" id="assign-notes" rows="3"></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="assignTechBtn">Assign Technician</button></div></div></div></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
tooltipTriggerList.map(function (tooltipTriggerEl) {
return new bootstrap.Tooltip(tooltipTriggerEl)
});

// Handle custom date range visibility
document.getElementById('report-period').addEventListener('change', function() {
var customDateRange = document.getElementById('custom-date-range');
customDateRange.style.display = this.value === 'custom' ? 'flex' : 'none';
});

// Generate Report Button
document.getElementById('generateReportBtn').addEventListener('click', function() {
var form = document.getElementById('reportForm');
if (form.checkValidity()) {
var reportType = document.getElementById('report-type').value;
var format = document.querySelector('input[name="report-format"]:checked').value;

// In a real app, this would generate and download the report
alert(`Generating ${reportType} report in ${format.toUpperCase()} format`);

// Close the modal
var modal = bootstrap.Modal.getInstance(document.getElementById('generateReportModal'));
modal.hide();
} else {
form.reportValidity();
}
});

// Complete Task Button
document.getElementById('completeTaskBtn').addEventListener('click', function() {
var form = document.getElementById('completeTaskForm');
if (form.checkValidity()) {
var assetId = document.getElementById('asset-select').value;
var taskId = document.getElementById('task-select').value;

// In a real app, this would submit the form to complete the task
alert(`Task marked as complete for asset #${assetId}`);

// Close the modal
var modal = bootstrap.Modal.getInstance(document.getElementById('completeTaskModal'));
modal.hide();

// Optionally reload the page or update the UI
// window.location.reload();
} else {
form.reportValidity();
}
});

// Assign Technician Button
document.getElementById('assignTechBtn').addEventListener('click', function() {
var form = document.getElementById('assignTechForm');
if (form.checkValidity()) {
var scheduleId = document.getElementById('assign-asset-select').value;
var techId = document.getElementById('assign-tech-select').value;

// In a real app, this would submit the form to assign the technician
alert(`Technician #${techId} assigned to task #${scheduleId}`);

// Close the modal
var modal = bootstrap.Modal.getInstance(document.getElementById('assignTechModal'));
modal.hide();

// Optionally reload the page or update the UI
// window.location.reload();
} else {
form.reportValidity();
}
});
});
</script>
{% endblock %}
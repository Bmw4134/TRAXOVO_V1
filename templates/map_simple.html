<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Asset Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        .title {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 999;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 16px;
            font-weight: bold;
        }
        .asset-marker {
            width: 32px !important;
            height: 32px !important;
            background-color: #f00;
            border-radius: 16px;
            border: 2px solid #fff;
            color: white;
            font-weight: bold;
            text-align: center;
            line-height: 32px;
        }
        .excavator { background-color: #ffc107; }
        .loader { background-color: #28a745; }
        .dozer { background-color: #dc3545; }
        .truck { background-color: #007bff; }
        .pickup { background-color: #6f42c1; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="title">TRAXORA Assets</div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on Texas
        var map = L.map('map').setView([31.5, -99.0], 6);
        
        // Add OpenStreetMap base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);
        
        // Status indicator
        var statusDiv = document.createElement('div');
        statusDiv.className = 'title';
        statusDiv.style.right = '10px';
        statusDiv.style.left = 'auto';
        statusDiv.style.backgroundColor = 'rgba(0,0,0,0.7)';
        statusDiv.style.fontSize = '14px';
        statusDiv.innerHTML = 'Loading assets...';
        document.body.appendChild(statusDiv);
        
        // Fetch real assets from API
        fetch('/map-view/api/sample-assets')
            .then(response => response.json())
            .then(data => {
                if (data && data.status === 'success' && data.assets && data.assets.length > 0) {
                    // Update status
                    statusDiv.innerHTML = data.source === 'gauge_api' ? 'Live Data' : 'Sample Data';
                    statusDiv.style.backgroundColor = data.source === 'gauge_api' ? 'rgba(40, 167, 69, 0.8)' : 'rgba(255, 193, 7, 0.8)';
                    
                    // Process assets
                    processAssets(data.assets);
                } else {
                    // Show error
                    statusDiv.innerHTML = 'No asset data';
                    statusDiv.style.backgroundColor = 'rgba(220, 53, 69, 0.8)';
                }
            })
            .catch(error => {
                console.error('Error fetching assets:', error);
                statusDiv.innerHTML = 'Error loading data';
                statusDiv.style.backgroundColor = 'rgba(220, 53, 69, 0.8)';
            });
        
        // Process assets and add to map
        function processAssets(assets) {
            // Remove any existing markers
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            
            // Valid asset locations to track
            var validAssets = [];
            
            // Process each asset
            assets.forEach(function(asset) {
                // Extract location info
                var lat = asset.latitude || asset.lat;
                var lng = asset.longitude || asset.lng;
                
                // Skip assets without location
                if (!lat || !lng || lat === 0 || lng === 0) return;
                
                // Determine asset type
                var type = getAssetType(asset);
                
                // Get ID or create one
                var id = asset.id || asset.assetID || 'Asset';
                
                // Get asset name
                var name = asset.name || asset.assetName || id;
                
                // Determine division/region
                var division = asset.division || 'Unknown';
                
                // Add to valid assets
                validAssets.push({
                    id: id,
                    type: type,
                    name: name,
                    lat: lat,
                    lng: lng,
                    division: division,
                    status: asset.status || 'active'
                });
                
                // Create marker with custom icon
                var marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: '',
                        html: '<div class="asset-marker ' + type + '">' + id.substr(0, 2) + '</div>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(map);
                
                // Create popup content
                var popupContent = "<div>";
                popupContent += "<b>" + id + "</b><br>" + name;
                if (division) popupContent += "<br>Division: " + division;
                if (asset.status) popupContent += "<br>Status: " + asset.status;
                if (asset.driver) popupContent += "<br>Driver: " + asset.driver;
                if (asset.jobSite) popupContent += "<br>Job: " + asset.jobSite;
                popupContent += "</div>";
                
                // Add popup with asset info
                marker.bindPopup(popupContent);
            });
            
            // Fit map to asset bounds if we have any
            if (validAssets.length > 0) {
                var bounds = validAssets.map(asset => [asset.lat, asset.lng]);
                map.fitBounds(bounds);
            }
            
            // Update status with count
            statusDiv.innerHTML += ' (' + validAssets.length + ' assets)';
        }
        
        // Determine asset type from various properties
        function getAssetType(asset) {
            var type = (asset.assetType || asset.type || '').toLowerCase();
            
            if (type.includes('excavator')) return 'excavator';
            if (type.includes('loader')) return 'loader';
            if (type.includes('dozer')) return 'dozer';
            if (type.includes('truck')) return 'truck';
            if (type.includes('pickup')) return 'pickup';
            
            // Try to determine from ID
            var id = (asset.id || '').toUpperCase();
            
            if (id.startsWith('EX')) return 'excavator';
            if (id.startsWith('LD')) return 'loader';
            if (id.startsWith('DZ')) return 'dozer';
            if (id.startsWith('TK')) return 'truck';
            if (id.startsWith('PU')) return 'pickup';
            
            return 'truck'; // Default
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Map View - TRAXORA</title>
    <!-- Bootstrap CSS with Replit theme -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            padding: 0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .navbar {
            z-index: 1000;
        }
        
        .map-container {
            flex: 1;
            width: 100%;
            position: relative;
        }
        
        #assetMap {
            height: 100%;
            width: 100%;
        }
        
        .map-overlay {
            position: absolute;
            bottom: 20px;  /* Changed from top to bottom */
            left: 10px;    /* Changed from right to left */
            z-index: 1000;
            background-color: rgba(20, 20, 20, 0.8);  /* Darker, more opaque background */
            padding: 8px;
            border-radius: 8px;
            max-width: 180px;  /* Smaller max-width for mobile */
            font-size: 12px;   /* Smaller font for mobile */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .asset-controls {
            margin-bottom: 8px;
        }
        
        /* Make buttons/controls more compact for mobile */
        .form-select-sm {
            height: 30px;
            padding-top: 2px;
            padding-bottom: 2px;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        /* Custom marker styling for better visibility on mobile */
        .asset-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px !important;
            height: 36px !important;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            overflow: visible;
            position: relative;
            transition: transform 0.3s ease;
            z-index: 900;
            font-weight: bold;
            font-size: 12px;
            color: white;
            text-shadow: 0 0 3px black;
            transform: translateX(-18px) translateY(-18px);
        }
        
        .asset-marker:hover {
            transform: scale(1.2) translateX(-18px) translateY(-18px);
            z-index: 1000;
            filter: brightness(1.2);
        }
        
        .marker-excavator {
            background-color: #ffc107;
        }
        
        .marker-loader {
            background-color: #28a745;
        }
        
        .marker-dozer {
            background-color: #dc3545;
        }
        
        .marker-truck {
            background-color: #007bff;
        }
        
        .marker-pickup {
            background-color: #6f42c1;
        }
        
        .marker-icon {
            font-size: 16px;
            color: white;
        }
        
        .asset-pulse {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 8px;
            animation: pulse 2s infinite;
            opacity: 0;
            background-color: inherit;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }
            70% {
                transform: scale(2);
                opacity: 0;
            }
            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }
        
        .asset-tooltip {
            font-size: 12px;
            max-width: 200px;
        }
        
        .status-indicators {
            display: flex;
            justify-content: space-around;
            margin-bottom: 8px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            margin-right: 5px;
            font-size: 10px;
            white-space: nowrap;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 3px;
        }
        
        .status-active {
            background-color: #28a745;
            box-shadow: 0 0 5px #28a745;
        }
        
        .status-idle {
            background-color: #ffc107;
            box-shadow: 0 0 5px #ffc107;
        }
        
        .status-maintenance {
            background-color: #dc3545;
            box-shadow: 0 0 5px #dc3545;
        }
        
        .region-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .region-buttons .btn {
            margin-bottom: 5px;
            flex: 1 0 40%;
            min-width: 60px;
            padding: 2px 4px;
            font-size: 0.7rem;
        }
        
        .count-badge {
            margin-left: 3px;
            padding: 0.2em 0.4em;
            font-size: 0.6rem;
        }
        
        /* Mobile-specific adjustments */
        @media (max-width: 576px) {
            /* Make controls even smaller on very small screens */
            .map-overlay {
                max-width: 160px;
                padding: 5px;
                font-size: 10px;
            }
            
            .asset-marker {
                width: 30px !important;
                height: 30px !important;
                transform: translateX(-15px) translateY(-15px);
            }
            
            .asset-marker:hover {
                transform: scale(1.2) translateX(-15px) translateY(-15px);
            }
            
            .region-buttons .btn {
                font-size: 0.65rem;
            }
            
            /* Make leaflet zoom controls smaller */
            .leaflet-control-zoom a {
                height: 26px;
                width: 26px;
                line-height: 24px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-dark shadow">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <span class="fw-bold">TRAXORA</span>
                <span class="ms-2 text-light">Asset Tracking</span>
            </a>
            <a href="/" class="btn btn-sm btn-outline-light">
                <i class="bi bi-house-door"></i> Dashboard
            </a>
        </div>
    </nav>
    
    <!-- Map Container -->
    <div class="map-container">
        <div id="assetMap"></div>
        
        <!-- Map Controls Overlay -->
        <div class="map-overlay">
            <div class="status-indicators">
                <div class="status-indicator">
                    <div class="status-dot status-active"></div>
                    <span>Active: <span id="activeCount">0</span></span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot status-idle"></div>
                    <span>Idle: <span id="idleCount">0</span></span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot status-maintenance"></div>
                    <span>Maint: <span id="maintenanceCount">0</span></span>
                </div>
            </div>
            
            <div class="region-buttons">
                <button class="btn btn-sm btn-outline-primary" data-region="all">
                    All <span id="allCount" class="badge bg-light text-dark count-badge">0</span>
                </button>
                <button class="btn btn-sm btn-outline-info" data-region="DFW">
                    DFW <span id="dfwCount" class="badge bg-light text-dark count-badge">0</span>
                </button>
                <button class="btn btn-sm btn-outline-warning" data-region="HOU">
                    HOU <span id="houCount" class="badge bg-light text-dark count-badge">0</span>
                </button>
                <button class="btn btn-sm btn-outline-danger" data-region="WTX">
                    WTX <span id="wtxCount" class="badge bg-light text-dark count-badge">0</span>
                </button>
            </div>
            
            <div class="asset-controls">
                <select id="assetTypeFilter" class="form-select form-select-sm mb-2">
                    <option value="all">All Asset Types</option>
                    <option value="Excavator">Excavators</option>
                    <option value="Loader">Loaders</option>
                    <option value="Dozer">Dozers</option>
                    <option value="Truck">Trucks</option>
                    <option value="Pickup">Pickups</option>
                </select>
                
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                    <label class="form-check-label" for="autoRefreshToggle">Auto-Refresh</label>
                </div>
                
                <button id="refreshButton" class="btn btn-sm btn-primary w-100">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh Map
                </button>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Map and marker globals
        let map;
        let markers = {};
        let assets = [];
        let refreshTimer;
        let currentRegionFilter = 'all';
        let currentTypeFilter = 'all';
        
        // Initialize map
        document.addEventListener('DOMContentLoaded', function() {
            // Create map
            map = L.map('assetMap').setView([32.7767, -96.7970], 6);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Load assets
            loadAssets();
            
            // Set up auto-refresh
            setupAutoRefresh();
            
            // Set up event listeners
            document.getElementById('refreshButton').addEventListener('click', loadAssets);
            document.getElementById('autoRefreshToggle').addEventListener('change', setupAutoRefresh);
            document.getElementById('assetTypeFilter').addEventListener('change', filterAssets);
            
            // Region filter buttons
            document.querySelectorAll('.region-buttons button').forEach(button => {
                button.addEventListener('click', function() {
                    currentRegionFilter = this.getAttribute('data-region');
                    // Update active state
                    document.querySelectorAll('.region-buttons button').forEach(btn => {
                        btn.classList.remove('btn-primary', 'btn-info', 'btn-warning', 'btn-danger');
                        btn.classList.add('btn-outline-primary', 'btn-outline-info', 'btn-outline-warning', 'btn-outline-danger');
                    });
                    
                    // Set active button style
                    if (currentRegionFilter === 'all') {
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-primary');
                    } else if (currentRegionFilter === 'DFW') {
                        this.classList.remove('btn-outline-info');
                        this.classList.add('btn-info');
                    } else if (currentRegionFilter === 'HOU') {
                        this.classList.remove('btn-outline-warning');
                        this.classList.add('btn-warning');
                    } else if (currentRegionFilter === 'WTX') {
                        this.classList.remove('btn-outline-danger');
                        this.classList.add('btn-danger');
                    }
                    
                    filterAssets();
                    
                    // Center map on region
                    if (currentRegionFilter === 'all') {
                        fitMapToVisibleMarkers();
                    } else if (currentRegionFilter === 'DFW') {
                        map.setView([32.7767, -96.7970], 9);
                    } else if (currentRegionFilter === 'HOU') {
                        map.setView([29.7604, -95.3698], 9);
                    } else if (currentRegionFilter === 'WTX') {
                        map.setView([31.8457, -102.3676], 9);
                    }
                });
            });
        });
        
        // Load assets from API
        function loadAssets() {
            // Clear existing refresh timer
            if (refreshTimer) {
                clearTimeout(refreshTimer);
            }
            
            console.log('Fetching sample asset data...');
            
            fetch('/map-view/api/sample-assets')
                .then(response => {
                    console.log('Response received:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Data received:', data);
                    if (data.status === 'success' && data.assets && data.assets.length > 0) {
                        console.log(`Loaded ${data.assets.length} assets`);
                        // Store the assets
                        assets = data.assets;
                        
                        // Update markers and counts
                        updateMarkers();
                        updateCounts();
                        
                        // Set up next refresh if enabled
                        setupAutoRefresh();
                    } else {
                        console.error('No assets found in response data');
                    }
                })
                .catch(error => {
                    console.error('Error loading assets:', error);
                    // Set up next refresh if enabled (even if this one failed)
                    setupAutoRefresh();
                });
        }
        
        // Update map markers
        function updateMarkers() {
            // Keep track of marker IDs to remove old ones
            const currentMarkerIds = new Set();
            
            // Process each asset
            assets.forEach(asset => {
                if (asset.latitude && asset.longitude) {
                    currentMarkerIds.add(asset.id);
                    
                    // If marker already exists, just update it
                    if (markers[asset.id]) {
                        markers[asset.id].setLatLng([asset.latitude, asset.longitude]);
                        updateMarkerStatus(markers[asset.id], asset);
                    } else {
                        // Create new marker
                        createMarker(asset);
                    }
                }
            });
            
            // Remove markers for assets no longer in the data
            Object.keys(markers).forEach(id => {
                if (!currentMarkerIds.has(id)) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                }
            });
            
            // Apply filters to show/hide markers
            filterAssets();
            
            // Fit map to visible markers
            fitMapToVisibleMarkers();
        }
        
        // Create a new marker for an asset
        function createMarker(asset) {
            const assetType = getAssetType(asset).toLowerCase();
            
            // Create custom marker HTML with asset ID
            const markerHtml = `
                <div class="asset-marker marker-${assetType}">
                    ${asset.id.substring(0, 2)}<br>${asset.id.substring(2, 6)}
                    <div class="asset-pulse"></div>
                </div>
            `;
            
            // Create custom icon
            const customIcon = L.divIcon({
                html: markerHtml,
                className: 'custom-div-icon',
                iconSize: [36, 36],
                iconAnchor: [18, 18]
            });
            
            // Create marker
            const marker = L.marker([asset.latitude, asset.longitude], {
                icon: customIcon,
                title: asset.id
            }).addTo(map);
            
            // Add popup
            marker.bindTooltip(`
                <div class="asset-tooltip">
                    <div><strong>${asset.id}</strong>: ${asset.name}</div>
                    <div>Status: ${asset.status}</div>
                    <div>Job: ${asset.jobSite}</div>
                    <div>Division: ${asset.division}</div>
                </div>
            `, { opacity: 0.9 });
            
            // Store marker
            markers[asset.id] = marker;
            
            // Update status
            updateMarkerStatus(marker, asset);
            
            return marker;
        }
        
        // Update marker status (active, idle, maintenance)
        function updateMarkerStatus(marker, asset) {
            // Get marker element
            const iconHtml = marker.getIcon().options.html;
            const div = document.createElement('div');
            div.innerHTML = iconHtml;
            
            // Get pulse element
            const pulseElement = div.querySelector('.asset-pulse');
            
            // Set pulse visibility based on status
            if (asset.status === 'active') {
                pulseElement.style.display = 'block';
            } else {
                pulseElement.style.display = 'none';
            }
            
            // Update marker color based on status
            const markerElement = div.querySelector('.asset-marker');
            
            // Keep the asset type class
            const classNames = markerElement.className.split(' ');
            let typeClass = '';
            for (const className of classNames) {
                if (className.startsWith('marker-')) {
                    typeClass = className;
                    break;
                }
            }
            
            // Update classes
            markerElement.className = `asset-marker ${typeClass}`;
            
            // Create new icon with updated HTML
            const newIcon = L.divIcon({
                html: div.innerHTML,
                className: 'custom-div-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            // Update the marker icon
            marker.setIcon(newIcon);
        }
        
        // Filter assets based on selected filters
        function filterAssets() {
            // Get filter values
            const regionFilter = currentRegionFilter;
            const typeFilter = document.getElementById('assetTypeFilter').value;
            
            // Apply filters to markers
            assets.forEach(asset => {
                const marker = markers[asset.id];
                if (!marker) return;
                
                // Check if asset passes filters
                const passesRegion = regionFilter === 'all' || asset.division === regionFilter;
                const passesType = typeFilter === 'all' || asset.assetType === typeFilter;
                
                // Show or hide marker
                if (passesRegion && passesType) {
                    marker.getElement().style.display = '';
                } else {
                    marker.getElement().style.display = 'none';
                }
            });
            
            // Update counts after filtering
            updateCounts();
        }
        
        // Update the counts in the UI
        function updateCounts() {
            // Initialize counters
            let totalCount = 0;
            let activeCount = 0;
            let idleCount = 0;
            let maintenanceCount = 0;
            let dfwCount = 0;
            let houCount = 0;
            let wtxCount = 0;
            
            // Get filter values
            const typeFilter = document.getElementById('assetTypeFilter').value;
            
            // Count assets
            assets.forEach(asset => {
                // Apply type filter
                if (typeFilter !== 'all' && asset.assetType !== typeFilter) {
                    return;
                }
                
                // Update total count
                totalCount++;
                
                // Update status counts
                if (asset.status === 'active') {
                    activeCount++;
                } else if (asset.status === 'maintenance') {
                    maintenanceCount++;
                } else {
                    idleCount++;
                }
                
                // Update region counts
                if (asset.division === 'DFW') {
                    dfwCount++;
                } else if (asset.division === 'HOU') {
                    houCount++;
                } else if (asset.division === 'WTX') {
                    wtxCount++;
                }
            });
            
            // Update UI
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('idleCount').textContent = idleCount;
            document.getElementById('maintenanceCount').textContent = maintenanceCount;
            document.getElementById('allCount').textContent = totalCount;
            document.getElementById('dfwCount').textContent = dfwCount;
            document.getElementById('houCount').textContent = houCount;
            document.getElementById('wtxCount').textContent = wtxCount;
        }
        
        // Get asset type
        function getAssetType(asset) {
            const type = asset.assetType || '';
            
            if (type.includes('Excavator')) return 'excavator';
            if (type.includes('Loader')) return 'loader';
            if (type.includes('Dozer')) return 'dozer';
            if (type.includes('Truck')) return 'truck';
            if (type.includes('Pickup')) return 'pickup';
            
            // Try to determine type from ID
            const id = asset.id || '';
            
            if (id.startsWith('EX')) return 'excavator';
            if (id.startsWith('LD')) return 'loader';
            if (id.startsWith('DZ')) return 'dozer';
            if (id.startsWith('TK')) return 'truck';
            if (id.startsWith('PU')) return 'pickup';
            
            return 'truck'; // Default
        }
        
        // Set up auto-refresh
        function setupAutoRefresh() {
            if (refreshTimer) {
                clearTimeout(refreshTimer);
            }
            
            if (document.getElementById('autoRefreshToggle').checked) {
                refreshTimer = setTimeout(loadAssets, 30000); // Refresh every 30 seconds
            }
        }
        
        // Fit map to visible markers
        function fitMapToVisibleMarkers() {
            const visibleMarkers = [];
            
            // Get all visible markers
            assets.forEach(asset => {
                const marker = markers[asset.id];
                if (marker && marker.getElement().style.display !== 'none') {
                    visibleMarkers.push(marker);
                }
            });
            
            // If we have any visible markers, fit map to them
            if (visibleMarkers.length > 0) {
                const group = L.featureGroup(visibleMarkers);
                
                // On mobile, use less padding to maximize map area
                const isMobile = window.innerWidth < 576;
                const padding = isMobile ? [30, 30] : [50, 50];
                
                map.fitBounds(group.getBounds(), { padding: padding });
                
                // For mobile, cluster nearby markers to avoid clutter
                if (isMobile && visibleMarkers.length > 10) {
                    // Simplify display by adjusting zoom out slightly to reduce clutter
                    setTimeout(() => {
                        map.setZoom(map.getZoom() - 0.5);
                    }, 300);
                }
            }
        }
    </script>
</body>
</html>
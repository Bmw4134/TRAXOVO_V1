{% extends 'base.html' %}

{% block title %}Driver Detail - {{ driver.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('mtd_reports.dashboard') }}">MTD Reports</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('mtd_reports.show_report', date=date) }}">Report {{ date }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ driver.name }}</li>
        </ol>
    </nav>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="bi bi-person-badge me-2"></i>
                Driver Details - {{ driver.name }}
            </h4>
            <span class="badge {% if driver.status == 'on_time' %}bg-success{% elif driver.status == 'late' %}bg-warning{% elif driver.status == 'early_end' %}bg-warning{% elif driver.status == 'not_on_job' %}bg-danger{% else %}bg-secondary{% endif %}">
                {{ driver.status|replace('_', ' ')|title }}
            </span>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>Driver Information</h5>
                    <table class="table table-striped">
                        <tr>
                            <th>Name:</th>
                            <td>{{ driver.name }}</td>
                        </tr>
                        <tr>
                            <th>Employee ID:</th>
                            <td>{{ driver.employee_id if driver.employee_id else 'Not available' }}</td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>
                                <span class="badge {% if driver.status == 'on_time' %}bg-success{% elif driver.status == 'late' %}bg-warning{% elif driver.status == 'early_end' %}bg-warning{% elif driver.status == 'not_on_job' %}bg-danger{% else %}bg-secondary{% endif %}">
                                    {{ driver.status|replace('_', ' ')|title }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Assigned Job:</th>
                            <td>{{ driver.assigned_job if driver.assigned_job else 'Not assigned' }}</td>
                        </tr>
                        <tr>
                            <th>Data Sources:</th>
                            <td>{{ driver.data_sources if driver.data_sources else 'Not available' }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h5>Attendance Details</h5>
                    <table class="table table-striped">
                        <tr>
                            <th>Scheduled Start:</th>
                            <td>{{ driver.scheduled_start if driver.scheduled_start else 'Not available' }}</td>
                        </tr>
                        <tr>
                            <th>Scheduled End:</th>
                            <td>{{ driver.scheduled_end if driver.scheduled_end else 'Not available' }}</td>
                        </tr>
                        <tr>
                            <th>Actual Start:</th>
                            <td>{{ driver.actual_start if driver.actual_start else 'Not available' }}</td>
                        </tr>
                        <tr>
                            <th>Actual End:</th>
                            <td>{{ driver.actual_end if driver.actual_end else 'Not available' }}</td>
                        </tr>
                        {% if driver.minutes_late and driver.minutes_late > 0 %}
                        <tr>
                            <th>Minutes Late:</th>
                            <td class="text-warning">{{ driver.minutes_late }}</td>
                        </tr>
                        {% endif %}
                        {% if driver.minutes_early_end and driver.minutes_early_end > 0 %}
                        <tr>
                            <th>Minutes Early End:</th>
                            <td class="text-warning">{{ driver.minutes_early_end }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- GENIUS CORE Validation Notes -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                GENIUS CORE Validation
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if driver.validation_notes %}
                                <ul class="list-group">
                                    {% for note in driver.validation_notes %}
                                        <li class="list-group-item">{{ note }}</li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p>No validation notes available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Timeline -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-clock-history me-2"></i>
                                Activity Timeline
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if driver.driving_history %}
                                <div class="timeline">
                                    {% for record in driver.driving_history %}
                                        <div class="timeline-item">
                                            <div class="timeline-marker"></div>
                                            <div class="timeline-content">
                                                <h6 class="timeline-title">
                                                    {{ record.event_type if record.event_type else 'Activity' }} - 
                                                    {{ record.timestamp if record.timestamp else 'Time not recorded' }}
                                                </h6>
                                                <p>{{ record.location if record.location else 'Location not recorded' }}</p>
                                                {% if record.asset %}
                                                    <small class="text-muted">Vehicle: {{ record.asset }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% elif driver.activity_detail %}
                                <div class="timeline">
                                    {% for record in driver.activity_detail %}
                                        <div class="timeline-item">
                                            <div class="timeline-marker"></div>
                                            <div class="timeline-content">
                                                <h6 class="timeline-title">
                                                    {{ record.reason if record.reason else 'Activity' }} - 
                                                    {{ record.timestamp if record.timestamp else 'Time not recorded' }}
                                                </h6>
                                                <p>{{ record.location if record.location else 'Location not recorded' }}</p>
                                                {% if record.asset %}
                                                    <small class="text-muted">Vehicle: {{ record.asset }}</small>
                                                {% endif %}
                                                {% if record.speed %}
                                                    <small class="text-muted">Speed: {{ record.speed }} {{ record.unit }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p>No activity records available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Map -->
            {% if driver.locations and driver.locations|length > 0 %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-geo-alt-fill me-2"></i>
                                Location Map
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="map" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="card-footer">
            <a href="{{ url_for('mtd_reports.show_report', date=date) }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to Report
            </a>
        </div>
    </div>
</div>

{% if driver.locations and driver.locations|length > 0 %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the map
        var map = L.map('map').setView([
            {{ driver.locations[0].lat }}, 
            {{ driver.locations[0].lng }}
        ], 13);

        // Add the OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add markers for each location
        var markers = [];
        {% for location in driver.locations %}
            var marker = L.marker([{{ location.lat }}, {{ location.lng }}]).addTo(map);
            marker.bindPopup("<b>{{ location.timestamp }}</b><br>{{ location.description|default('Activity') }}");
            markers.push(marker);
        {% endfor %}

        // Create a polyline to show the path
        var latlngs = [
            {% for location in driver.locations %}
                [{{ location.lat }}, {{ location.lng }}],
            {% endfor %}
        ];
        
        var polyline = L.polyline(latlngs, {color: 'blue'}).addTo(map);
        
        // Fit the map to contain all markers
        var group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds());
    });
</script>
{% endif %}

<style>
    .timeline {
        position: relative;
        padding: 1rem;
        margin: 0 auto;
        max-width: 1200px;
    }
    
    .timeline:before {
        content: '';
        position: absolute;
        height: 100%;
        width: 2px;
        background: #dee2e6;
        left: 50px;
        top: 0;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
        padding-left: 70px;
    }
    
    .timeline-marker {
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #6c757d;
        left: 43px;
        top: 0;
        z-index: 1;
    }
    
    .timeline-content {
        position: relative;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        background: #f8f9fa;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    
    .timeline-title {
        margin-top: 0;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}
{% extends 'base.html' %}

{% block title %}Upload Files - SYSTEMSMITH{% endblock %}

{% block head_extras %}
<style>
    .file-upload-wrapper {
        position: relative;
        width: 100%;
        height: 200px;
        border: 2px dashed var(--bs-gray);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .file-upload-wrapper:hover {
        border-color: var(--bs-primary);
        background-color: rgba(var(--bs-primary-rgb), 0.05);
    }
    
    .file-upload-wrapper.active {
        border-color: var(--bs-success);
        background-color: rgba(var(--bs-success-rgb), 0.05);
    }
    
    .file-upload-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }
    
    .file-upload-content {
        text-align: center;
        padding: 20px;
    }
    
    .file-preview {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 20px;
    }
    
    .file-type-option {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .file-type-option:hover {
        transform: translateY(-2px);
    }
    
    .file-type-option.selected {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Upload Files</h1>
        <div>
            <a href="{{ url_for('parser.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to File Management
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Upload New File</h5>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                
                    <form id="uploadForm" action="{{ url_for('parser.upload') }}" method="POST" enctype="multipart/form-data">
                        <div class="mb-4">
                            <div class="file-upload-wrapper" id="dropZone">
                                <input type="file" class="file-upload-input" id="fileInput" name="file" required>
                                <div class="file-upload-content">
                                    <i class="bi bi-cloud-arrow-up display-4 mb-3 text-muted"></i>
                                    <h5>Drag and drop files here</h5>
                                    <p class="text-muted mb-0">or click to browse</p>
                                    <div id="fileDetails" class="mt-3 d-none">
                                        <span class="badge bg-info" id="fileName"></span>
                                        <span class="text-muted" id="fileSize"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">Select File Type</label>
                            <div class="row g-3" id="fileTypeOptions">
                                <div class="col-md-3">
                                    <div class="card file-type-option h-100" data-value="auto">
                                        <div class="card-body text-center">
                                            <i class="bi bi-magic display-6 mb-3 text-info"></i>
                                            <h5>Auto-Detect</h5>
                                            <p class="text-muted small mb-0">Let system determine file type</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card file-type-option h-100" data-value="fringe">
                                        <div class="card-body text-center">
                                            <i class="bi bi-cash-coin display-6 mb-3 text-success"></i>
                                            <h5>Fringe</h5>
                                            <p class="text-muted small mb-0">Fringe benefit statements</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card file-type-option h-100" data-value="billing">
                                        <div class="card-body text-center">
                                            <i class="bi bi-receipt display-6 mb-3 text-primary"></i>
                                            <h5>Billing</h5>
                                            <p class="text-muted small mb-0">Monthly billing records</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card file-type-option h-100" data-value="maintenance">
                                        <div class="card-body text-center">
                                            <i class="bi bi-tools display-6 mb-3 text-warning"></i>
                                            <h5>Maintenance</h5>
                                            <p class="text-muted small mb-0">Repair and service records</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card file-type-option h-100" data-value="activity">
                                        <div class="card-body text-center">
                                            <i class="bi bi-activity display-6 mb-3 text-danger"></i>
                                            <h5>Activity</h5>
                                            <p class="text-muted small mb-0">Equipment usage data</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card file-type-option h-100" data-value="work_order">
                                        <div class="card-body text-center">
                                            <i class="bi bi-clipboard-check display-6 mb-3 text-secondary"></i>
                                            <h5>Work Order</h5>
                                            <p class="text-muted small mb-0">Work order details</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card file-type-option h-100" data-value="fuel">
                                        <div class="card-body text-center">
                                            <i class="bi bi-fuel-pump display-6 mb-3 text-dark"></i>
                                            <h5>Fuel</h5>
                                            <p class="text-muted small mb-0">Fuel consumption reports</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card file-type-option h-100" data-value="other">
                                        <div class="card-body text-center">
                                            <i class="bi bi-three-dots display-6 mb-3"></i>
                                            <h5>Other</h5>
                                            <p class="text-muted small mb-0">General file processing</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="file_type" id="fileTypeInput" value="auto">
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">Processing Options</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="createBackup" name="create_backup" checked>
                                        <label class="form-check-label" for="createBackup">Create Backup (CYA Mode)</label>
                                    </div>
                                    <div class="form-text text-muted small">Stores timestamped copies of original files</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="auditTrail" name="audit_trail" checked>
                                        <label class="form-check-label" for="auditTrail">Add to Audit Trail</label>
                                    </div>
                                    <div class="form-text text-muted small">Records processing event in audit log</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="deepAnalysis" name="deep_analysis">
                                        <label class="form-check-label" for="deepAnalysis">Deep Analysis Mode</label>
                                    </div>
                                    <div class="form-text text-muted small">Performs in-depth pattern recognition (slower)</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="reconcileMode" name="reconcile_mode">
                                        <label class="form-check-label" for="reconcileMode">Reconcile Mode</label>
                                    </div>
                                    <div class="form-text text-muted small">Compares with previous versions, reveals changes</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="uploadBtn">
                                <i class="bi bi-upload me-2"></i>Upload and Process File
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Supported File Types</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex align-items-center">
                            <i class="bi bi-file-earmark-excel me-3 text-success fs-4"></i>
                            <div>
                                <strong>Excel Files</strong>
                                <div class="text-muted small">.xlsx, .xlsm, .xls</div>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <i class="bi bi-file-earmark-text me-3 text-primary fs-4"></i>
                            <div>
                                <strong>CSV Files</strong>
                                <div class="text-muted small">.csv</div>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <i class="bi bi-file-earmark-code me-3 text-warning fs-4"></i>
                            <div>
                                <strong>JSON Files</strong>
                                <div class="text-muted small">.json</div>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <i class="bi bi-file-earmark-pdf me-3 text-danger fs-4"></i>
                            <div>
                                <strong>PDF Files</strong>
                                <div class="text-muted small">.pdf</div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Upload Guidelines</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle-fill me-2"></i>Auto-Detection</h6>
                        <p class="mb-0 small">The system will attempt to automatically identify the file type based on content and format patterns.</p>
                    </div>
                    
                    <h6 class="mb-2 mt-3">Best Practices</h6>
                    <ul class="small text-muted ps-3">
                        <li>Use original unmodified files when possible</li>
                        <li>Files with standard column headers are easier to process</li>
                        <li>Excel files with multiple sheets will be fully analyzed</li>
                        <li>File names with dates and clear identifiers are recommended</li>
                        <li>JSON files should use standard array or object format</li>
                        <li>PDF processing focuses on tabular data extraction</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Recently Processed</h5>
                </div>
                <div class="card-body">
                    {% if recent_files and recent_files|length > 0 %}
                        <ul class="list-group list-group-flush">
                            {% for file in recent_files %}
                                <li class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-truncate" style="max-width: 70%;">
                                            <i class="bi bi-file-earmark me-2"></i>
                                            {{ file.filename }}
                                        </div>
                                        <a href="{{ url_for('parser.result', file_path=file.file_path) }}" class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </div>
                                    <small class="text-muted">{{ file.timestamp }}</small>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="text-center py-3">
                            <div class="text-muted">
                                <i class="bi bi-inbox display-6 mb-3"></i>
                                <p>No recently processed files</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="processingModal" tabindex="-1" aria-labelledby="processingModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processingModalLabel">Processing File</h5>
            </div>
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-4" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="processingFileName">Processing file...</h5>
                <p class="text-muted" id="processingStage">Analyzing data structure</p>
                <div class="progress mt-4">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="processingProgress"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize file type selection
    const fileTypeOptions = document.querySelectorAll('.file-type-option');
    const fileTypeInput = document.getElementById('fileTypeInput');
    
    // Set default selection
    document.querySelector('.file-type-option[data-value="auto"]').classList.add('selected');
    
    fileTypeOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove selected class from all options
            fileTypeOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Add selected class to clicked option
            this.classList.add('selected');
            
            // Update hidden input value
            fileTypeInput.value = this.dataset.value;
        });
    });
    
    // File upload and drag-drop functionality
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileDetails = document.getElementById('fileDetails');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    
    // Handle drag events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // Handle drop zone visual feedback
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropZone.classList.add('active');
    }
    
    function unhighlight() {
        dropZone.classList.remove('active');
    }
    
    // Handle file drop
    dropZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            fileInput.files = files;
            updateFileDetails(files[0]);
        }
    }
    
    // Handle file input change
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            updateFileDetails(this.files[0]);
        } else {
            clearFileDetails();
        }
    });
    
    function updateFileDetails(file) {
        fileDetails.classList.remove('d-none');
        fileName.textContent = file.name;
        
        // Format file size
        let size = file.size;
        let formattedSize = '';
        
        if (size < 1024) {
            formattedSize = size + ' bytes';
        } else if (size < 1024 * 1024) {
            formattedSize = (size / 1024).toFixed(1) + ' KB';
        } else {
            formattedSize = (size / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        fileSize.textContent = formattedSize;
        
        // Automatically select file type based on file extension
        const extension = file.name.split('.').pop().toLowerCase();
        
        // Map extensions to file types
        const extensionMap = {
            'xlsx': 'auto',
            'xlsm': 'auto',
            'xls': 'auto',
            'csv': 'auto',
            'json': 'auto',
            'pdf': 'auto'
        };
        
        // Check if filename contains certain keywords to guess file type
        const filenameLower = file.name.toLowerCase();
        let guessedType = null;
        
        if (filenameLower.includes('fringe') || filenameLower.includes('benefit')) {
            guessedType = 'fringe';
        } else if (filenameLower.includes('bill') || filenameLower.includes('invoice')) {
            guessedType = 'billing';
        } else if (filenameLower.includes('maint') || filenameLower.includes('service')) {
            guessedType = 'maintenance';
        } else if (filenameLower.includes('activ') || filenameLower.includes('usage')) {
            guessedType = 'activity';
        } else if (filenameLower.includes('work') || filenameLower.includes('order')) {
            guessedType = 'work_order';
        } else if (filenameLower.includes('fuel') || filenameLower.includes('gas')) {
            guessedType = 'fuel';
        }
        
        // Set the file type if we have a good guess
        if (guessedType) {
            // Remove selected class from all options
            fileTypeOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Add selected class to guessed option
            document.querySelector(`.file-type-option[data-value="${guessedType}"]`).classList.add('selected');
            
            // Update hidden input value
            fileTypeInput.value = guessedType;
        }
    }
    
    function clearFileDetails() {
        fileDetails.classList.add('d-none');
        fileName.textContent = '';
        fileSize.textContent = '';
    }
    
    // Handle form submission
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const processingModal = new bootstrap.Modal(document.getElementById('processingModal'));
    const processingFileName = document.getElementById('processingFileName');
    const processingStage = document.getElementById('processingStage');
    const processingProgress = document.getElementById('processingProgress');
    
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate file input
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Please select a file to upload.');
            return;
        }
        
        // Show processing modal
        processingFileName.textContent = 'Processing: ' + fileInput.files[0].name;
        processingStage.textContent = 'Uploading file...';
        processingProgress.style.width = '10%';
        processingModal.show();
        
        // Create form data
        const formData = new FormData(uploadForm);
        
        // Submit form with AJAX to show progress
        const xhr = new XMLHttpRequest();
        xhr.open('POST', uploadForm.action, true);
        
        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.min(30, Math.round((e.loaded / e.total) * 100));
                processingProgress.style.width = percentComplete + '%';
            }
        };
        
        // Mock processing stages for better UX
        let stage = 0;
        const stages = [
            { text: 'Uploading file...', progress: 10 },
            { text: 'Validating file format...', progress: 30 },
            { text: 'Analyzing content structure...', progress: 45 },
            { text: 'Identifying data patterns...', progress: 65 },
            { text: 'Processing records...', progress: 80 },
            { text: 'Finalizing and saving results...', progress: 95 }
        ];
        
        const updateStage = function() {
            if (stage < stages.length) {
                processingStage.textContent = stages[stage].text;
                processingProgress.style.width = stages[stage].progress + '%';
                stage++;
                setTimeout(updateStage, 1000);
            }
        };
        
        setTimeout(updateStage, 500);
        
        xhr.onload = function() {
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        processingProgress.style.width = '100%';
                        processingStage.textContent = 'Processing complete!';
                        
                        // Redirect to result page
                        setTimeout(function() {
                            window.location.href = response.redirect_url;
                        }, 500);
                    } else {
                        processingModal.hide();
                        alert('Error processing file: ' + response.message);
                    }
                } catch (e) {
                    processingModal.hide();
                    // The response is not JSON, likely the full HTML page
                    // Just navigate to the result page
                    window.location.href = xhr.responseURL;
                }
            } else {
                processingModal.hide();
                alert('Error uploading file. Please try again.');
            }
        };
        
        xhr.onerror = function() {
            processingModal.hide();
            alert('Connection error. Please try again.');
        };
        
        xhr.send(formData);
    });
});
</script>
{% endblock %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TRAXOVO PDF Editor - Document Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
      .pdf-toolbar {
        background: #2c3e50;
        color: white;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .pdf-canvas-container {
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        background: #f8f9fa;
        min-height: 600px;
        position: relative;
      }
      .pdf-viewer {
        width: 100%;
        height: 700px;
        border: none;
      }
      .annotation-tools {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .tool-btn {
        margin: 2px;
        width: 40px;
        height: 40px;
      }
      .color-picker {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .page-controls {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .sidebar-documents {
        background: #34495e;
        color: white;
        min-height: 100vh;
        padding: 20px;
      }
      .document-item {
        background: #2c3e50;
        margin: 10px 0;
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .document-item:hover {
        background: #1abc9c;
        color: white;
      }
      .upload-zone {
        border: 2px dashed #3498db;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background: #ecf0f1;
        margin-bottom: 20px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .upload-zone:hover {
        border-color: #2980b9;
        background: #d5dbdb;
      }
      .measurement-tool {
        cursor: crosshair;
      }
      .markup-overlay {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 10;
      }
      .markup-overlay.active {
        pointer-events: all;
      }
    </style>
  </head>
  <body>
    {% include 'includes/sidebar.html' %}

    <div class="main-content">
      <div class="container-fluid">
        <div class="row">
          <!-- Document Sidebar -->
          <div class="col-md-3 sidebar-documents">
            <h4><i class="fas fa-folder-open"></i> Documents</h4>

            <!-- Upload Zone -->
            <div
              class="upload-zone"
              onclick="document.getElementById('fileInput').click()"
            >
              <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
              <p>Click to upload PDFs</p>
              <input
                type="file"
                id="fileInput"
                accept=".pdf"
                multiple
                style="display: none"
              />
            </div>

            <!-- Document List -->
            <div id="documentList">
              <div
                class="document-item"
                onclick="loadDocument('sample-blueprint.pdf')"
              >
                <i class="fas fa-file-pdf text-danger"></i>
                <strong>Site Blueprint</strong>
                <small class="d-block text-muted">Construction Plans</small>
              </div>
              <div
                class="document-item"
                onclick="loadDocument('equipment-manual.pdf')"
              >
                <i class="fas fa-file-pdf text-danger"></i>
                <strong>Equipment Manual</strong>
                <small class="d-block text-muted">CAT 320 Excavator</small>
              </div>
              <div
                class="document-item"
                onclick="loadDocument('safety-report.pdf')"
              >
                <i class="fas fa-file-pdf text-danger"></i>
                <strong>Safety Report</strong>
                <small class="d-block text-muted">May 2025</small>
              </div>
            </div>
          </div>

          <!-- Main Editor -->
          <div class="col-md-9">
            <div class="pdf-toolbar">
              <div class="row align-items-center">
                <div class="col-md-4">
                  <h5><i class="fas fa-edit"></i> PDF Editor</h5>
                </div>
                <div class="col-md-4 text-center">
                  <div class="btn-group" role="group">
                    <button
                      class="btn btn-outline-light btn-sm"
                      onclick="zoomOut()"
                    >
                      <i class="fas fa-search-minus"></i>
                    </button>
                    <span class="btn btn-outline-light btn-sm" id="zoomLevel"
                      >100%</span
                    >
                    <button
                      class="btn btn-outline-light btn-sm"
                      onclick="zoomIn()"
                    >
                      <i class="fas fa-search-plus"></i>
                    </button>
                  </div>
                </div>
                <div class="col-md-4 text-end">
                  <button
                    class="btn btn-success btn-sm"
                    onclick="saveDocument()"
                  >
                    <i class="fas fa-save"></i> Save
                  </button>
                  <button
                    class="btn btn-primary btn-sm"
                    onclick="exportDocument()"
                  >
                    <i class="fas fa-download"></i> Export
                  </button>
                </div>
              </div>
            </div>

            <div class="pdf-canvas-container">
              <!-- PDF Viewer -->
              <canvas
                id="pdfCanvas"
                style="display: block; margin: 0 auto"
              ></canvas>

              <!-- Markup Overlay -->
              <canvas id="markupCanvas" class="markup-overlay"></canvas>

              <!-- Annotation Tools -->
              <div class="annotation-tools">
                <div class="d-flex flex-column">
                  <button
                    class="btn btn-sm btn-outline-primary tool-btn"
                    onclick="selectTool('select')"
                    title="Select"
                  >
                    <i class="fas fa-mouse-pointer"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-primary tool-btn"
                    onclick="selectTool('text')"
                    title="Add Text"
                  >
                    <i class="fas fa-font"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-primary tool-btn"
                    onclick="selectTool('highlight')"
                    title="Highlight"
                  >
                    <i class="fas fa-highlighter"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-primary tool-btn"
                    onclick="selectTool('draw')"
                    title="Draw"
                  >
                    <i class="fas fa-pen"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-primary tool-btn"
                    onclick="selectTool('arrow')"
                    title="Arrow"
                  >
                    <i class="fas fa-long-arrow-alt-right"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-primary tool-btn"
                    onclick="selectTool('rectangle')"
                    title="Rectangle"
                  >
                    <i class="fas fa-square"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-primary tool-btn"
                    onclick="selectTool('circle')"
                    title="Circle"
                  >
                    <i class="fas fa-circle"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-outline-primary tool-btn"
                    onclick="selectTool('measure')"
                    title="Measure"
                  >
                    <i class="fas fa-ruler"></i>
                  </button>
                  <input
                    type="color"
                    class="color-picker"
                    id="colorPicker"
                    value="#ff0000"
                    title="Color"
                  />
                  <button
                    class="btn btn-sm btn-outline-danger tool-btn"
                    onclick="clearAnnotations()"
                    title="Clear All"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>

              <!-- Page Controls -->
              <div class="page-controls">
                <button
                  class="btn btn-sm btn-outline-secondary"
                  onclick="previousPage()"
                >
                  <i class="fas fa-chevron-left"></i>
                </button>
                <span class="mx-3">
                  Page <span id="currentPage">1</span> of
                  <span id="totalPages">1</span>
                </span>
                <button
                  class="btn btn-sm btn-outline-secondary"
                  onclick="nextPage()"
                >
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let pdfDoc = null;
      let pageNum = 1;
      let pageIsRendering = false;
      let pageNumIsPending = null;
      let scale = 1.0;
      let currentTool = "select";
      let isDrawing = false;
      let annotations = [];

      const canvas = document.getElementById("pdfCanvas");
      const ctx = canvas.getContext("2d");
      const markupCanvas = document.getElementById("markupCanvas");
      const markupCtx = markupCanvas.getContext("2d");

      // Set PDF.js worker
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

      // Initialize editor
      function initEditor() {
        // Load sample PDF for demonstration
        loadSamplePDF();
        setupEventListeners();
      }

      function loadSamplePDF() {
        // Create a sample PDF using PDF-lib for demonstration
        createSamplePDF().then((pdfBytes) => {
          const blob = new Blob([pdfBytes], { type: "application/pdf" });
          const url = URL.createObjectURL(blob);
          loadPDF(url);
        });
      }

      async function createSamplePDF() {
        const { PDFDocument, rgb } = PDFLib;
        const pdfDoc = await PDFDocument.create();
        const page = pdfDoc.addPage([600, 800]);

        page.drawText("TRAXOVO Fleet Management System", {
          x: 50,
          y: 750,
          size: 24,
          color: rgb(0, 0, 0),
        });

        page.drawText("Equipment Inspection Report", {
          x: 50,
          y: 700,
          size: 18,
          color: rgb(0, 0, 0),
        });

        page.drawText("Asset ID: CAT-320-001", {
          x: 50,
          y: 650,
          size: 14,
          color: rgb(0, 0, 0),
        });

        page.drawText("Date: May 29, 2025", {
          x: 50,
          y: 620,
          size: 14,
          color: rgb(0, 0, 0),
        });

        page.drawText("Inspector: John Smith", {
          x: 50,
          y: 590,
          size: 14,
          color: rgb(0, 0, 0),
        });

        // Add checklist items
        const checklistItems = [
          "Engine Oil Level: ✓ Good",
          "Hydraulic Fluid: ✓ Good",
          "Track Condition: ✓ Good",
          "Bucket Inspection: ✓ Good",
          "Safety Equipment: ✓ Present",
        ];

        checklistItems.forEach((item, index) => {
          page.drawText(item, {
            x: 70,
            y: 520 - index * 30,
            size: 12,
            color: rgb(0, 0, 0),
          });
        });

        // Add signature line
        page.drawText("Inspector Signature: _________________________", {
          x: 50,
          y: 200,
          size: 12,
          color: rgb(0, 0, 0),
        });

        return await pdfDoc.save();
      }

      function loadPDF(url) {
        pdfjsLib.getDocument(url).promise.then((pdf) => {
          pdfDoc = pdf;
          document.getElementById("totalPages").textContent = pdf.numPages;
          renderPage(pageNum);
        });
      }

      function renderPage(num) {
        pageIsRendering = true;

        pdfDoc.getPage(num).then((page) => {
          const viewport = page.getViewport({ scale });
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          markupCanvas.height = viewport.height;
          markupCanvas.width = viewport.width;

          const renderCtx = {
            canvasContext: ctx,
            viewport,
          };

          page.render(renderCtx).promise.then(() => {
            pageIsRendering = false;

            if (pageNumIsPending !== null) {
              renderPage(pageNumIsPending);
              pageNumIsPending = null;
            }

            // Redraw annotations
            redrawAnnotations();
          });

          document.getElementById("currentPage").textContent = num;
        });
      }

      function queueRenderPage(num) {
        if (pageIsRendering) {
          pageNumIsPending = num;
        } else {
          renderPage(num);
        }
      }

      function previousPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
      }

      function nextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
      }

      function zoomIn() {
        scale += 0.25;
        document.getElementById("zoomLevel").textContent =
          Math.round(scale * 100) + "%";
        queueRenderPage(pageNum);
      }

      function zoomOut() {
        if (scale <= 0.25) return;
        scale -= 0.25;
        document.getElementById("zoomLevel").textContent =
          Math.round(scale * 100) + "%";
        queueRenderPage(pageNum);
      }

      function selectTool(tool) {
        currentTool = tool;
        document
          .querySelectorAll(".tool-btn")
          .forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");

        if (tool === "measure") {
          markupCanvas.classList.add("measurement-tool");
        } else {
          markupCanvas.classList.remove("measurement-tool");
        }
      }

      function setupEventListeners() {
        // File upload
        document
          .getElementById("fileInput")
          .addEventListener("change", handleFileUpload);

        // Canvas events for annotations
        markupCanvas.addEventListener("mousedown", startDrawing);
        markupCanvas.addEventListener("mousemove", draw);
        markupCanvas.addEventListener("mouseup", stopDrawing);

        // Keyboard shortcuts
        document.addEventListener("keydown", handleKeyboard);
      }

      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file && file.type === "application/pdf") {
          const url = URL.createObjectURL(file);
          loadPDF(url);

          // Add to document list
          const docList = document.getElementById("documentList");
          const docItem = document.createElement("div");
          docItem.className = "document-item";
          docItem.innerHTML = `
                    <i class="fas fa-file-pdf text-danger"></i>
                    <strong>${file.name}</strong>
                    <small class="d-block text-muted">Uploaded Document</small>
                `;
          docList.insertBefore(docItem, docList.firstChild);
        }
      }

      function startDrawing(event) {
        if (currentTool === "select") return;

        isDrawing = true;
        const rect = markupCanvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        markupCtx.beginPath();
        markupCtx.moveTo(x, y);
        markupCtx.strokeStyle = document.getElementById("colorPicker").value;
        markupCtx.lineWidth = currentTool === "highlight" ? 10 : 2;
        markupCtx.globalAlpha = currentTool === "highlight" ? 0.3 : 1.0;
      }

      function draw(event) {
        if (!isDrawing || currentTool === "select") return;

        const rect = markupCanvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        if (currentTool === "draw" || currentTool === "highlight") {
          markupCtx.lineTo(x, y);
          markupCtx.stroke();
        }
      }

      function stopDrawing() {
        if (!isDrawing) return;
        isDrawing = false;
        markupCtx.globalAlpha = 1.0;
      }

      function handleKeyboard(event) {
        switch (event.key) {
          case "ArrowLeft":
            previousPage();
            break;
          case "ArrowRight":
            nextPage();
            break;
          case "+":
          case "=":
            zoomIn();
            break;
          case "-":
            zoomOut();
            break;
        }
      }

      function clearAnnotations() {
        markupCtx.clearRect(0, 0, markupCanvas.width, markupCanvas.height);
        annotations = [];
      }

      function redrawAnnotations() {
        // Redraw saved annotations after page render
        annotations.forEach((annotation) => {
          // Implementation for redrawing saved annotations
        });
      }

      function saveDocument() {
        // Save annotations and document changes
        alert("Document saved successfully!");
      }

      function exportDocument() {
        // Export PDF with annotations
        const link = document.createElement("a");
        link.download = "annotated-document.pdf";
        link.href = canvas.toDataURL();
        link.click();
      }

      function loadDocument(filename) {
        alert(`Loading ${filename}...`);
        // Implementation for loading specific documents
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", initEditor);
    </script>
  </body>
</html>

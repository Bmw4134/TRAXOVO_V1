{% extends 'base.html' %}

{% block title %}PM Allocation Processing | SYSTEMSMITH{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">PM Allocation Processor</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <p class="text-secondary">
                                This tool helps process PM allocation files. Upload an original workbook and a revised version
                                to generate a comparison report. The system will preserve formulas and maintain column alignments.
                            </p>
                        </div>
                    </div>

                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-dark text-white">
                                    <h6 class="mb-0">Upload PM Allocation Files</h6>
                                </div>
                                <div class="card-body">
                                    <form method="POST" enctype="multipart/form-data" id="pm-allocation-form">
                                        <div class="mb-3">
                                            <label for="original_file" class="form-label">Original PM Allocation File</label>
                                            <input type="file" class="form-control" id="original_file" name="original_file" 
                                                   accept=".xlsx,.xlsm,.xls" required>
                                            <div class="form-text">Upload the original EQMO billing allocation workbook.</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="updated_file" class="form-label">Updated PM Allocation File</label>
                                            <input type="file" class="form-control" id="updated_file" name="updated_file" 
                                                   accept=".xlsx,.xlsm,.xls" required>
                                            <div class="form-text">Upload the revised billing allocation workbook with your changes.</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="region" class="form-label">Region (Optional)</label>
                                            <select class="form-select" id="region" name="region">
                                                <option value="ALL" selected>All Regions</option>
                                                <option value="DFW">DFW</option>
                                                <option value="HOU">HOU</option>
                                                <option value="WT">WT</option>
                                            </select>
                                            <div class="form-text">Select a specific region or process all regions.</div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary" id="process-btn">
                                            Process Files
                                        </button>
                                        
                                        <div class="mt-3 d-none" id="processing-indicator">
                                            <div class="d-flex align-items-center">
                                                <div class="spinner-border text-primary me-2" role="status">
                                                    <span class="visually-hidden">Processing...</span>
                                                </div>
                                                <span>Processing files, please wait...</span>
                                            </div>
                                            <div class="progress mt-2">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                            </div>
                                            <div class="text-muted small mt-1">This may take a few minutes. Please do not refresh the page.</div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header bg-dark text-white">
                                    <h6 class="mb-0">Auto-Process Files</h6>
                                </div>
                                <div class="card-body">
                                    <p>The system can automatically find and process PM allocation files from the attached_assets folder.</p>
                                    <form method="POST" action="{{ url_for('auto_process_pm_allocation') }}">
                                        <button type="submit" class="btn btn-secondary">
                                            <i class="bi bi-lightning-fill me-1"></i> Auto-Detect Files
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-dark text-white">
                                    <h6 class="mb-0">Recent PM Allocation Reports</h6>
                                </div>
                                <div class="card-body">
                                    {% if recent_reports %}
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Report Name</th>
                                                    <th>Generated</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for report in recent_reports %}
                                                <tr>
                                                    <td>{{ report.name }}</td>
                                                    <td>{{ report.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                                    <td>
                                                        <div class="btn-group" role="group">
                                                            <a href="{{ url_for('view_pm_report', filename=report.filename) }}" 
                                                               class="btn btn-sm btn-outline-primary">
                                                                <i class="bi bi-eye"></i> View
                                                            </a>
                                                            <a href="{{ url_for('download_pm_report', filename=report.filename) }}" 
                                                               class="btn btn-sm btn-outline-success">
                                                                <i class="bi bi-download"></i> Download
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i> No recent PM allocation reports found. Process files to generate reports.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if report_data %}
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Processing Results</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>Original File:</strong> {{ report_data.original_filename }}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Updated File:</strong> {{ report_data.updated_filename }}
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">Comparison Summary</h6>
                                        <ul>
                                            <li><strong>Total Lines:</strong> {{ report_data.total_lines }}</li>
                                            <li><strong>Changed Lines:</strong> {{ report_data.changed_lines }}</li>
                                            <li><strong>New Lines:</strong> {{ report_data.new_lines }}</li>
                                            <li><strong>Unchanged Lines:</strong> {{ report_data.unchanged_lines }}</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="d-flex justify-content-end">
                                        <a href="{{ url_for('download_pm_report', filename=report_data.report_filename) }}" 
                                           class="btn btn-primary me-2">
                                            <i class="bi bi-download"></i> Download Report
                                        </a>
                                        <a href="{{ url_for('download_export', export_path=report_data.csv_export_path) }}" 
                                           class="btn btn-success">
                                            <i class="bi bi-file-earmark-spreadsheet"></i> Download CSV Export
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="mb-0">Comparison Details</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Row</th>
                                                    <th>Asset ID</th>
                                                    <th>Description</th>
                                                    <th>Original Value</th>
                                                    <th>Updated Value</th>
                                                    <th>Difference</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for change in report_data.changes %}
                                                <tr class="{{ 'table-warning' if change.difference != 0 else '' }}">
                                                    <td>{{ change.row }}</td>
                                                    <td>{{ change.asset_id }}</td>
                                                    <td>{{ change.description }}</td>
                                                    <td>{{ change.original_value|default('N/A', true) }}</td>
                                                    <td>{{ change.updated_value|default('N/A', true) }}</td>
                                                    <td class="{{ 'text-danger' if change.difference < 0 else 'text-success' if change.difference > 0 else '' }}">
                                                        {{ change.difference|default('0.00', true) }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Show processing indicator and disable button when form is submitted
        const form = document.getElementById('pm-allocation-form');
        if (form) {
            form.addEventListener('submit', function() {
                document.getElementById('processing-indicator').classList.remove('d-none');
                document.getElementById('process-btn').disabled = true;
            });
        }
    });
</script>
{% endblock %}
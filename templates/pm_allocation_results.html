{% extends 'base.html' %}

{% block title %}PM Allocation Comparison Results{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
<style>
    .changed {
        background-color: rgba(255, 193, 7, 0.2);
        font-weight: bold;
    }
    .table tbody tr.added-row {
        background-color: rgba(25, 135, 84, 0.2);
    }
    .table tbody tr.removed-row {
        background-color: rgba(220, 53, 69, 0.2);
    }
    .diff-value {
        display: inline-block;
        padding: 2px 5px;
        border-radius: 3px;
    }
    .region-indicator {
        width: 10px;
        border-radius: 50%;
        height: 10px;
        display: inline-block;
        margin-right: 5px;
    }
    .region-dfw {
        background-color: #0d6efd;
    }
    .region-hou {
        background-color: #198754;
    }
    .region-wtx {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-3">PM Allocation Comparison Results</h2>
            <div class="alert alert-info">
                <h5 class="mb-2">{{ result.month }} Billing Allocation Changes</h5>
                <p class="mb-1">
                    <strong>Original File:</strong> {{ result.original_file }}
                    <br>
                    <strong>PM File:</strong> {{ result.pm_file }}
                    <br>
                    <strong>Processed:</strong> {{ result.timestamp }}
                </p>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Change Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6>Total Records</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>Analyzed:</span>
                                        <span><strong>{{ result.changes.total_rows }}</strong></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Changed:</span>
                                        <span><strong>{{ result.changes.total }}</strong></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Added:</span>
                                        <span><strong>{{ result.changes.added }}</strong></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Removed:</span>
                                        <span><strong>{{ result.changes.removed }}</strong></span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6>Changes by Type</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>Cost Code:</span>
                                        <span><strong>{{ result.changes.by_type.cost_code }}</strong></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Allocation:</span>
                                        <span><strong>{{ result.changes.by_type.allocation }}</strong></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Revision:</span>
                                        <span><strong>{{ result.changes.by_type.revision }}</strong></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Notes:</span>
                                        <span><strong>{{ result.changes.by_type.notes }}</strong></span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6>Changes by Region</h6>
                                    <div class="d-flex justify-content-between">
                                        <span><span class="region-indicator region-dfw"></span> DFW:</span>
                                        <span><strong>{{ result.changes.by_region.DFW }}</strong></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span><span class="region-indicator region-hou"></span> HOU:</span>
                                        <span><strong>{{ result.changes.by_region.HOU }}</strong></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span><span class="region-indicator region-wtx"></span> WTX:</span>
                                        <span><strong>{{ result.changes.by_region.WTX }}</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Generated Reports</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group">
                                {% for export_file in result.export_files %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ export_file|basename }}
                                    <a href="{{ url_for('reports.download_export', export_path=export_file|basename) }}" class="btn btn-sm btn-primary">
                                        Download
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Changed Records Table -->
            {% if comparison.changed_rows %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Changed Records ({{ comparison.changed_rows|length }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Division</th>
                                    <th>Job</th>
                                    <th>Asset ID</th>
                                    <th>Equipment</th>
                                    <th>Field</th>
                                    <th>Original Value</th>
                                    <th>Updated Value</th>
                                    <th>Amount Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in comparison.changed_rows %}
                                    {% set region_class = 'region-dfw' if row.div == 1 else ('region-hou' if row.div == 2 else 'region-wtx') %}
                                    {% for change in row.changes %}
                                    <tr class="{{ region_class }}">
                                        <td>{{ row.div }}</td>
                                        <td>{{ row.job }}</td>
                                        <td>{{ row.asset_id }}</td>
                                        <td>{{ row.equipment }}</td>
                                        <td>{{ change.field }}</td>
                                        <td>{{ change.original }}</td>
                                        <td class="changed">{{ change.updated }}</td>
                                        {% if change.field == 'UNIT ALLOCATION' or change.field == 'REVISION' %}
                                            {% set amount_change = row.updated.revision_amount - row.original.revision_amount %}
                                            <td class="{% if amount_change != 0 %}changed{% endif %}">
                                                {% if amount_change > 0 %}+{% endif %}{{ amount_change }}
                                            </td>
                                        {% else %}
                                            <td>-</td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Added Records Table -->
            {% if comparison.added_rows %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Added Records ({{ comparison.added_rows|length }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Division</th>
                                    <th>Job</th>
                                    <th>Asset ID</th>
                                    <th>Equipment</th>
                                    <th>Driver</th>
                                    <th>Allocation</th>
                                    <th>Cost Code</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in comparison.added_rows %}
                                    {% set region_class = 'region-dfw' if row.div == 1 else ('region-hou' if row.div == 2 else 'region-wtx') %}
                                    <tr class="added-row {{ region_class }}">
                                        <td>{{ row.div }}</td>
                                        <td>{{ row.job }}</td>
                                        <td>{{ row.asset_id }}</td>
                                        <td>{{ row.equipment }}</td>
                                        <td>{{ row.driver }}</td>
                                        <td>{{ row.allocation }}</td>
                                        <td>{{ row.cost_code }}</td>
                                        <td>{{ row.revision_amount }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Removed Records Table -->
            {% if comparison.removed_rows %}
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Removed Records ({{ comparison.removed_rows|length }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Division</th>
                                    <th>Job</th>
                                    <th>Asset ID</th>
                                    <th>Equipment</th>
                                    <th>Driver</th>
                                    <th>Allocation</th>
                                    <th>Cost Code</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in comparison.removed_rows %}
                                    {% set region_class = 'region-dfw' if row.div == 1 else ('region-hou' if row.div == 2 else 'region-wtx') %}
                                    <tr class="removed-row {{ region_class }}">
                                        <td>{{ row.div }}</td>
                                        <td>{{ row.job }}</td>
                                        <td>{{ row.asset_id }}</td>
                                        <td>{{ row.equipment }}</td>
                                        <td>{{ row.driver }}</td>
                                        <td>{{ row.allocation }}</td>
                                        <td>{{ row.cost_code }}</td>
                                        <td>{{ row.allocation_amount }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="mt-3 mb-5">
                <a href="{{ url_for('reports.pm_allocation') }}" class="btn btn-secondary">Back to Upload</a>
                
                {% if comparison.changed_rows or comparison.added_rows %}
                <a href="{{ url_for('reports.generate_region_exports', month=result.month) }}" class="btn btn-success">
                    Generate Region Exports
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Custom filter to extract the basename from a file path
    document.addEventListener('DOMContentLoaded', function() {
        // Add any JavaScript functionality here
    });
</script>
{% endblock %}
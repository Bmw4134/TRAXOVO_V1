{% extends "layout.html" %}

{% block title %}PM Master Billing Help{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="display-5 mb-2">
                <i class="bi bi-question-circle me-2"></i>PM Master Billing Help
            </h1>
            <p class="lead text-muted">
                Learn how to use the PM Master Billing system
            </p>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="btn-group">
                <a href="{{ url_for('pm_master.index') }}" class="btn btn-primary">
                    <i class="bi bi-arrow-left me-1"></i> Back to PM Master
                </a>
            </div>
        </div>
    </div>

    <!-- Help Content -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">PM Master Billing System Instructions</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        The PM Master Billing system is designed to process multiple PM allocation spreadsheets at once and generate consolidated exports for each division.
                    </div>

                    <h5 class="mt-4 mb-3">Step 1: Preparing Your Files</h5>
                    <p>Before processing, ensure all your allocation files are in the attached_assets folder. The system will look for files with names containing:</p>
                    <ul>
                        <li><strong>EQMO</strong> and <strong>BILLING ALLOCATIONS</strong> in the filename</li>
                        <li>Files should contain information about equipment numbers, job assignments, usage units, and billing information</li>
                        <li>The system will automatically look for the "FINAL REVISIONS" file as the base file</li>
                    </ul>

                    <h5 class="mt-4 mb-3">Step 2: Equipment Rates</h5>
                    <p>The system needs equipment rates information to generate complete billing:</p>
                    <ul>
                        <li>The system will automatically look for a file containing <strong>EQ MONTHLY BILLINGS WORKING</strong> in the name</li>
                        <li>It will try to find a sheet named "Equip Rates" or containing "RATES" in the name</li>
                        <li>Rates should be organized by equipment number with columns for MONTHLY, HOURLY, DAILY, and WEEKLY rates</li>
                    </ul>

                    <h5 class="mt-4 mb-3">Step 3: Processing Files</h5>
                    <p>To process the allocation files:</p>
                    <ol>
                        <li>Click the <strong>"Process All April 2025 Files"</strong> button at the top of the page</li>
                        <li>The system will search for and process all allocation files in the attached_assets folder</li>
                        <li>It will extract equipment numbers, descriptions, job assignments, usage units, and other billing information</li>
                        <li>Equipment rates will be applied from the rates file based on the usage frequency (Monthly, Hourly, etc.)</li>
                        <li>A consolidated master billing sheet will be generated</li>
                    </ol>

                    <h5 class="mt-4 mb-3">Step 4: Download Generated Exports</h5>
                    <p>After processing, several export files will be generated:</p>
                    <ul>
                        <li><strong>MASTER_EQUIP_BILLINGS_APRIL_*.xlsx</strong> - Contains all billing data from all divisions</li>
                        <li><strong>DFW_EQUIP_BILLINGS_APRIL_*.xlsx</strong> - Filtered billing data for DFW division only</li>
                        <li><strong>HOU_EQUIP_BILLINGS_APRIL_*.xlsx</strong> - Filtered billing data for HOU division only</li>
                        <li><strong>WTX_EQUIP_BILLINGS_APRIL_*.xlsx</strong> - Filtered billing data for WTX division only</li>
                        <li><strong>SELECT_EQUIP_BILLINGS_APRIL_*.xlsx</strong> - Filtered billing data for SELECT division only</li>
                    </ul>
                    <p>Click the <strong>Download</strong> button next to each file to save it to your computer.</p>

                    <h5 class="mt-4 mb-3">Output Format</h5>
                    <p>Each export file will contain the following columns:</p>
                    <ul>
                        <li><strong>DIVISION</strong> - Division code (DFW, HOU, WTX, SELECT)</li>
                        <li><strong>EQUIPMENT_ID</strong> - Equipment number identifier</li>
                        <li><strong>DESCRIPTION</strong> - Equipment description</li>
                        <li><strong>DATE</strong> - Date of allocation</li>
                        <li><strong>JOB</strong> - Job or project identifier</li>
                        <li><strong>PHASE</strong> - Phase code (if available)</li>
                        <li><strong>COST_CODE</strong> - Cost code (if available)</li>
                        <li><strong>UNITS</strong> - Number of units (days, hours, etc.)</li>
                        <li><strong>FREQUENCY</strong> - Billing frequency (MONTHLY, HOURLY, DAILY, WEEKLY)</li>
                        <li><strong>RATE</strong> - Rate amount based on frequency</li>
                        <li><strong>AMOUNT</strong> - Total billing amount (UNITS Ã— RATE)</li>
                        <li><strong>SOURCE_FILE</strong> - Source allocation file</li>
                    </ul>

                    <div class="alert alert-warning mt-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Note:</strong> The system will log missing rates and unmapped assets but will not block export generation. Check the log for any warnings or errors if totals don't match expectations.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Common Issues -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">Common Issues & Troubleshooting</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="troubleshootingAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading1">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1" aria-expanded="false" aria-controls="collapse1">
                                    Missing or incorrect rates
                                </button>
                            </h2>
                            <div id="collapse1" class="accordion-collapse collapse" aria-labelledby="heading1" data-bs-parent="#troubleshootingAccordion">
                                <div class="accordion-body">
                                    <p>If equipment rates are missing or incorrect:</p>
                                    <ul>
                                        <li>Check that the equipment rates file is present in the attached_assets folder</li>
                                        <li>Verify the rate sheet contains columns with names like "MONTHLY", "HOURLY", "DAILY", or "WEEKLY" with the word "RATE"</li>
                                        <li>Ensure equipment IDs in the allocation files match exactly with those in the rates file</li>
                                        <li>The system will still generate exports even with missing rates - check the log for warnings</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading2">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2" aria-expanded="false" aria-controls="collapse2">
                                    Division not detected correctly
                                </button>
                            </h2>
                            <div id="collapse2" class="accordion-collapse collapse" aria-labelledby="heading2" data-bs-parent="#troubleshootingAccordion">
                                <div class="accordion-body">
                                    <p>If divisions are not correctly assigned:</p>
                                    <ul>
                                        <li>The system tries to detect divisions from the allocation file names (looking for DFW, HOU, WTX, SELECT)</li>
                                        <li>If not found in the filename, it looks for a column named "DIVISION", "DIV", "REGION", etc.</li>
                                        <li>If still not found, equipment may be assigned to no division or the default division</li>
                                        <li>You may need to add division information to the filenames or add a division column</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading3">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse3" aria-expanded="false" aria-controls="collapse3">
                                    Column data not extracted correctly
                                </button>
                            </h2>
                            <div id="collapse3" class="accordion-collapse collapse" aria-labelledby="heading3" data-bs-parent="#troubleshootingAccordion">
                                <div class="accordion-body">
                                    <p>If data from allocation files is not extracted correctly:</p>
                                    <ul>
                                        <li>The system tries to match columns using various common naming patterns</li>
                                        <li>Check that your allocation files use standard column names like "EQ#", "EQUIPMENT #", "JOB", "UNITS", etc.</li>
                                        <li>Unusual column names may not be detected - consider standardizing column names in source files</li>
                                        <li>The system requires at minimum: Equipment ID, Units, and either Rate or Amount to process records</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% extends 'layout.html' %}

{% block title %}PM Master Billing{% endblock %}

{% block content %}
<div class="container-fluid mt-4"><div class="row"><div class="col-12"><div class="card mb-4"><div class="card-header bg-dark text-white d-flex justify-content-between align-items-center"><h5 class="mb-0">PM Master Billing</h5><div><form action="{{ url_for('pm_master.process_billing') }}" method="post" class="d-inline"><button type="submit" class="btn btn-primary" id="process-button"><i class="fas fa-cogs me-1"></i> Process All Files
</button></form><form action="{{ url_for('pm_master.generate_import_files') }}" method="post" class="d-inline ms-2"><button type="submit" class="btn btn-success" id="import-button"><i class="fas fa-file-export me-1"></i> Generate Import Files
</button></form></div></div><div class="card-body"><p class="lead">Batch process monthly equipment billing allocations</p><div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>
This module processes PM allocation files to create:
<ol><li><strong>FINALIZED MASTER ALLOCATION SHEET</strong> - Contains all PM-reviewed updates with default cost codes applied</li><li><strong>MASTER BILLINGS SHEET</strong> - Equip Billings format with required fields</li><li><strong>FINAL REGION IMPORT FILES</strong> - CSV format for DFW, WTX, and HOU regions</li></ol>
Click <strong>Process All Files</strong> to generate all three deliverables at once.
</div></div></div></div></div><div class="row"><div class="col-lg-6"><div class="card mb-4"><div class="card-header bg-dark text-white"><h5 class="mb-0">Available Allocation Files</h5></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover mb-0"><thead><tr><th>Filename</th><th>Division</th><th>Size</th></tr></thead><tbody>
{% if allocation_files %}
{% for file in allocation_files %}
<tr><td>{{ file.filename }}</td><td><span class="badge bg-secondary">{{ file.division }}</span></td><td>{{ (file.size / 1024)|round(1) if file.size is defined else 'N/A' }} KB</td></tr>
{% endfor %}
{% else %}
<tr><td colspan="3" class="text-center">No allocation files found</td></tr>
{% endif %}
</tbody></table></div></div></div></div><div class="col-lg-6"><div class="card mb-4"><div class="card-header bg-dark text-white"><h5 class="mb-0">Generated Exports</h5></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover mb-0"><thead><tr><th>Filename</th><th>Modified</th><th>Size</th><th>Actions</th></tr></thead><tbody>
{% if exports %}
{% for export in exports %}
<tr><td>{{ export.filename }}</td><td>{{ export.modified }}</td><td>{{ (export.size / 1024)|round(1) }} KB</td><td><a href="{{ url_for('pm_master.download_export', filename=export.filename) }}" class="btn btn-sm btn-primary"><i class="fas fa-download"></i> Download
</a></td></tr>
{% endfor %}
{% else %}
<tr><td colspan="4" class="text-center">No exports generated yet</td></tr>
{% endif %}
</tbody></table></div></div></div>

{% if exports %}
<div class="card mb-4"><div class="card-header bg-dark text-white"><h5 class="mb-0">Critical Deliverables</h5></div><div class="card-body"><div class="list-group mb-3">
{% for export in exports %}
{% if 'MASTER_ALLOCATION' in export.filename %}
<a href="{{ url_for('pm_master.download_export', filename=export.filename) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><div><i class="fas fa-file-excel text-success me-2"></i><strong>1. FINALIZED MASTER ALLOCATION SHEET</strong><p class="mb-0 text-muted small">All PM-reviewed updates with default cost codes applied</p></div><span class="badge bg-primary rounded-pill"><i class="fas fa-download"></i></span></a>
{% endif %}
{% if 'MASTER_BILLINGS' in export.filename or 'MASTER_EQUIP_BILLINGS' in export.filename %}
<a href="{{ url_for('pm_master.download_export', filename=export.filename) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><div><i class="fas fa-file-excel text-success me-2"></i><strong>2. MASTER BILLINGS SHEET</strong><p class="mb-0 text-muted small">Equip Billings format with all required fields</p></div><span class="badge bg-primary rounded-pill"><i class="fas fa-download"></i></span></a>
{% endif %}
{% if 'REGION_IMPORT' in export.filename and 'DFW' in export.filename %}
<a href="{{ url_for('pm_master.download_export', filename=export.filename) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><div><i class="fas fa-file-csv text-info me-2"></i><strong>3a. DFW REGION IMPORT FILE</strong><p class="mb-0 text-muted small">CSV format for DFW region</p></div><span class="badge bg-primary rounded-pill"><i class="fas fa-download"></i></span></a>
{% endif %}
{% if 'REGION_IMPORT' in export.filename and 'WTX' in export.filename %}
<a href="{{ url_for('pm_master.download_export', filename=export.filename) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><div><i class="fas fa-file-csv text-info me-2"></i><strong>3b. WTX REGION IMPORT FILE</strong><p class="mb-0 text-muted small">CSV format for WTX region</p></div><span class="badge bg-primary rounded-pill"><i class="fas fa-download"></i></span></a>
{% endif %}
{% if 'REGION_IMPORT' in export.filename and 'HOU' in export.filename %}
<a href="{{ url_for('pm_master.download_export', filename=export.filename) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><div><i class="fas fa-file-csv text-info me-2"></i><strong>3c. HOU REGION IMPORT FILE</strong><p class="mb-0 text-muted small">CSV format for HOU region</p></div><span class="badge bg-primary rounded-pill"><i class="fas fa-download"></i></span></a>
{% endif %}
{% endfor %}
</div><div class="mt-3"><a href="{{ url_for('pm_master.billing_summary') }}" class="btn btn-info"><i class="fas fa-chart-pie me-1"></i> View Billing Summary
</a></div></div></div>
{% endif %}
</div></div></div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
// Add loading indicator to process buttons
$('#process-button, #import-button').click(function() {
$(this).html('<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Processing...');
$(this).prop('disabled', true);
});
});
</script>
{% endblock %}
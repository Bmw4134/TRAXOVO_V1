<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/qq-parallel-responsive.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/traxovo-design-system.css') }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Customizer - TRAXOVO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const DashboardCustomizer = () => {
            const [availableWidgets, setAvailableWidgets] = useState([]);
            const [userDashboards, setUserDashboards] = useState([]);
            const [currentDashboard, setCurrentDashboard] = useState(null);
            const [dashboardWidgets, setDashboardWidgets] = useState([]);
            const [isCustomizing, setIsCustomizing] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadCustomizationData();
            }, []);

            const loadCustomizationData = async () => {
                try {
                    const [widgetsRes, dashboardsRes] = await Promise.all([
                        axios.get('/api/dashboard/widgets'),
                        axios.get('/api/dashboard/list')
                    ]);

                    setAvailableWidgets(widgetsRes.data.widgets || []);
                    setUserDashboards(dashboardsRes.data.dashboards || []);
                    
                    const defaultDashboard = dashboardsRes.data.dashboards?.find(d => d.is_default);
                    if (defaultDashboard) {
                        setCurrentDashboard(defaultDashboard);
                        setDashboardWidgets(defaultDashboard.widget_preferences || []);
                    }
                } catch (error) {
                    console.error('Error loading customization data:', error);
                } finally {
                    setLoading(false);
                }
            };

            const addWidgetToDashboard = async (widgetType) => {
                if (!currentDashboard) return;

                const newWidget = {
                    id: `${widgetType}-${Date.now()}`,
                    type: widgetType,
                    x: 0,
                    y: dashboardWidgets.length * 3,
                    width: 4,
                    height: 3,
                    settings: availableWidgets.find(w => w.type === widgetType)?.default_settings || {}
                };

                const updatedWidgets = [...dashboardWidgets, newWidget];
                setDashboardWidgets(updatedWidgets);

                try {
                    await axios.post('/api/dashboard/widget/preferences', {
                        dashboard_id: currentDashboard.id,
                        widget_type: widgetType,
                        preferences: {
                            x: newWidget.x,
                            y: newWidget.y,
                            width: newWidget.width,
                            height: newWidget.height,
                            settings: newWidget.settings,
                            visible: true
                        }
                    });
                } catch (error) {
                    console.error('Error adding widget:', error);
                }
            };

            const removeWidget = (widgetId) => {
                const updatedWidgets = dashboardWidgets.filter(w => w.id !== widgetId);
                setDashboardWidgets(updatedWidgets);
            };

            const renderWidgetContent = (widgetType) => {
                switch (widgetType) {
                    case 'fleet_overview':
                        return (
                            <div className="widget-demo-content">
                                <div className="metric-row">
                                    <div className="metric">
                                        <span className="value">738</span>
                                        <span className="label">Total Assets</span>
                                    </div>
                                    <div className="metric">
                                        <span className="value">614</span>
                                        <span className="label">Active</span>
                                    </div>
                                </div>
                            </div>
                        );
                    case 'attendance_summary':
                        return (
                            <div className="widget-demo-content">
                                <div className="metric-row">
                                    <div className="metric">
                                        <span className="value">6</span>
                                        <span className="label">On Time</span>
                                    </div>
                                    <div className="metric">
                                        <span className="value">2</span>
                                        <span className="label">Late</span>
                                    </div>
                                </div>
                            </div>
                        );
                    case 'revenue_metrics':
                        return (
                            <div className="widget-demo-content">
                                <div className="metric-row">
                                    <div className="metric">
                                        <span className="value">$2.0M</span>
                                        <span className="label">YTD Revenue</span>
                                    </div>
                                </div>
                            </div>
                        );
                    case 'predictive_alerts':
                        return (
                            <div className="widget-demo-content">
                                <div className="alert-item critical">
                                    <span>D-26: High Risk</span>
                                </div>
                                <div className="alert-item warning">
                                    <span>RAM-03: Maintenance Due</span>
                                </div>
                            </div>
                        );
                    default:
                        return <div className="widget-demo-content">Widget Content</div>;
                }
            };

            if (loading) {
                return (
                    <div className="customizer-loading">
                        <div className="spinner-border text-primary" role="status">
                            <span className="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading dashboard customization...</p>
                    </div>
                );
            }

            return (
                <div className="dashboard-customizer">
                    <div className="customizer-header">
                        <div className="header-left">
                            <h2><i className="fas fa-th-large me-2"></i>Dashboard Customizer</h2>
                            <p>Personalize your Fort Worth operations dashboard with QQ optimization</p>
                        </div>
                        <div className="header-right">
                            <a href="/quantum-dashboard" className="btn btn-outline-primary me-2">
                                <i className="fas fa-arrow-left"></i> Back to Dashboard
                            </a>
                            <button 
                                className="btn btn-primary me-2"
                                onClick={() => setIsCustomizing(!isCustomizing)}
                            >
                                {isCustomizing ? 'Save Layout' : 'Customize Layout'}
                            </button>
                            <button 
                                className="btn btn-outline-secondary"
                                onClick={() => loadCustomizationData()}
                            >
                                <i className="fas fa-refresh"></i>
                            </button>
                        </div>
                    </div>

                    <div className="customizer-content">
                        {isCustomizing && (
                            <div className="widget-palette">
                                <h4>Available Widgets</h4>
                                <div className="widget-list">
                                    {availableWidgets.map(widget => (
                                        <div 
                                            key={widget.type}
                                            className="widget-item"
                                            onClick={() => addWidgetToDashboard(widget.type)}
                                        >
                                            <i className="fas fa-plus-circle"></i>
                                            <span>{widget.name}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="dashboard-preview">
                            <div className="dashboard-grid">
                                {dashboardWidgets.map((widget, index) => (
                                    <div 
                                        key={widget.id}
                                        className="widget-preview"
                                        style={{
                                            gridColumn: `span ${widget.width}`,
                                            gridRow: `span ${widget.height}`
                                        }}
                                    >
                                        <div className="widget-header">
                                            <h5>{availableWidgets.find(w => w.type === widget.type)?.name}</h5>
                                            <div className="widget-controls">
                                                <button className="btn btn-sm btn-outline-primary">
                                                    <i className="fas fa-cog"></i>
                                                </button>
                                                <button 
                                                    className="btn btn-sm btn-outline-danger"
                                                    onClick={() => removeWidget(widget.id)}
                                                >
                                                    <i className="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div className="widget-content">
                                            {renderWidgetContent(widget.type)}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {userDashboards.length > 0 && (
                        <div className="dashboard-selector">
                            <h4>My Dashboards</h4>
                            <div className="dashboard-list">
                                {userDashboards.map(dashboard => (
                                    <div 
                                        key={dashboard.id}
                                        className={`dashboard-item ${currentDashboard?.id === dashboard.id ? 'active' : ''}`}
                                        onClick={() => {
                                            setCurrentDashboard(dashboard);
                                            setDashboardWidgets(dashboard.widget_preferences || []);
                                        }}
                                    >
                                        <span>{dashboard.name}</span>
                                        {dashboard.is_default && <span className="badge bg-primary">Default</span>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Mount the React component
        ReactDOM.render(<DashboardCustomizer />, document.getElementById('root'));
    </script>

    <style>
        .dashboard-customizer {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .customizer-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin: 20px;
        }

        .customizer-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h2 {
            color: #2c3e50;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header-left p {
            color: #7f8c8d;
            margin: 0;
        }

        .customizer-content {
            display: flex;
            gap: 20px;
            min-height: 600px;
        }

        .widget-palette {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            width: 300px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .widget-palette h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .widget-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .widget-item {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .widget-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .dashboard-preview {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: repeat(auto-fit, 80px);
            gap: 15px;
            min-height: 500px;
            padding: 20px;
            border: 2px dashed #e9ecef;
            border-radius: 10px;
            background: var(--traxovo-gray-50);
        }

        .widget-preview {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        .widget-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .widget-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .widget-header h5 {
            margin: 0;
            font-size: 0.9em;
            font-weight: 600;
        }

        .widget-controls {
            display: flex;
            gap: 5px;
        }

        .widget-controls .btn {
            padding: 2px 6px;
            font-size: 0.8em;
        }

        .widget-content {
            padding: 15px;
            height: calc(100% - 50px);
            overflow: hidden;
        }

        .widget-demo-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .metric-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .metric {
            text-align: center;
        }

        .metric .value {
            display: block;
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric .label {
            display: block;
            font-size: 0.8em;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .alert-item {
            padding: var(--space-sm) 12px;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 0.85em;
        }

        .alert-item.critical {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }

        .alert-item.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .dashboard-selector {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .dashboard-selector h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .dashboard-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .dashboard-item {
            background: var(--traxovo-gray-50);
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-item:hover {
            border-color: #667eea;
            background: #f0f8ff;
        }

        .dashboard-item.active {
            border-color: #667eea;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        @media (max-width: 768px) {
            .customizer-content {
                flex-direction: column;
            }
            
            .widget-palette {
                width: 100%;
                order: 2;
            }
            
            .dashboard-preview {
                order: 1;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(6, 1fr);
                grid-template-rows: repeat(auto-fit, 60px);
            }
            
            .customizer-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</body>
</html>
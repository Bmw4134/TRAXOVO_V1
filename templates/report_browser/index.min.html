{% extends "layout_unified_enhanced.html" %} {% block title %}Report Browser{%
endblock %} {% block head_content %} {{ super() }}
<style>
  .report-card {
    transition: all 0.3s ease;
    border-radius: 8px;
    overflow: hidden;
  }

  .report-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }

  .report-icon {
    font-size: 2rem;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }

  .report-list {
    max-height: 400px;
    overflow-y: auto;
  }

  .report-item {
    transition: all 0.2s;
    border-left: 3px solid transparent;
  }

  .report-item:hover {
    background-color: rgba(var(--bs-primary-rgb), 0.05);
    border-left: 3px solid var(--bs-primary);
  }

  .report-date {
    min-width: 180px;
  }

  .report-actions {
    min-width: 100px;
  }

  /* Additional styles for GENIUS CORE features */
  .hardline-mode .report-item:not([data-verification="100"]) {
    opacity: 0.4;
    pointer-events: none;
  }

  .trace-node {
    fill: #4a6cf7;
    stroke: #2a4cd7;
    stroke-width: 2px;
  }

  .trace-link {
    stroke: #6c757d;
    stroke-width: 1.5px;
  }

  .trace-node-critical {
    fill: #dc3545;
  }

  .trace-node-verified {
    fill: #198754;
  }

  .trace-node-text {
    font-size: 10px;
    font-weight: bold;
    text-anchor: middle;
    pointer-events: none;
  }

  .verification-badge {
    position: relative;
    padding-right: 20px;
  }

  .verification-badge::after {
    content: "";
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
  }

  .verification-badge.verified::after {
    background-color: var(--bs-success);
  }

  .verification-badge.partial::after {
    background-color: var(--bs-warning);
  }

  .verification-badge.unverified::after {
    background-color: var(--bs-danger);
  }

  .anomaly-highlight {
    background-color: rgba(var(--bs-danger-rgb), 0.1);
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
{% endblock %} {% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-md-8">
      <h2><i class="fas fa-folder-open me-2"></i> Report Browser</h2>
      <p class="text-muted">
        Browse and access all your existing reports without needing to re-upload
        data.
      </p>
    </div>
    <div class="col-md-4 text-end">
      <div class="form-check form-switch d-inline-block me-3">
        <input
          class="form-check-input"
          type="checkbox"
          id="hardline-mode-switch"
        /><label class="form-check-label" for="hardline-mode-switch"
          ><span class="badge bg-danger">HARDLINE MODE</span></label
        >
      </div>
      <div class="dropdown d-inline-block">
        <button
          class="btn btn-outline-primary dropdown-toggle"
          type="button"
          id="verificationLevelDropdown"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          <i class="fas fa-shield-alt me-1"></i> Verification Level
        </button>
        <ul
          class="dropdown-menu dropdown-menu-end"
          aria-labelledby="verificationLevelDropdown"
        >
          <li>
            <a class="dropdown-item active" href="#" data-level="all"
              >All Reports</a
            >
          </li>
          <li>
            <a class="dropdown-item" href="#" data-level="basic"
              >Basic Verification (70%+)</a
            >
          </li>
          <li>
            <a class="dropdown-item" href="#" data-level="enhanced"
              >Enhanced Verification (85%+)</a
            >
          </li>
          <li>
            <a class="dropdown-item" href="#" data-level="genius"
              >GENIUS CORE (100%)</a
            >
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-dark">
        <div class="card-body p-2 d-flex align-items-center">
          <div
            class="d-flex align-items-center justify-content-center bg-primary bg-opacity-10 p-3 rounded-circle me-3"
          >
            <i class="fas fa-brain text-primary" style="font-size: 1.5rem"></i>
          </div>
          <div>
            <h5 class="mb-0 d-flex align-items-center">
              GENIUS CORE
              <span class="badge ms-2 bg-success" id="genius-status"
                >ACTIVE</span
              ><span class="small ms-3 text-muted"
                >Trace Chain Integrity:
                <span id="trace-integrity-level">96.8%</span></span
              >
            </h5>
            <div class="progress mt-1" style="height: 5px">
              <div
                class="progress-bar bg-success"
                role="progressbar"
                style="width: 96.8%"
                aria-valuenow="96.8"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
            </div>
          </div>
          <div class="ms-auto">
            <button class="btn btn-sm btn-outline-light" id="analyze-trace-btn">
              <i class="fas fa-microscope me-1"></i> Analyze Trace Chain
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    {% for directory in report_dirs %}
    <div class="col-md-6 mb-4">
      <div class="card report-card">
        <div class="card-header d-flex align-items-center">
          <div
            class="report-icon bg-{{ 'primary' if directory.type == 'daily' else 'success' if directory.type == 'weekly' else 'info' if directory.type == 'attendance' else 'warning' }} bg-opacity-10 me-3"
          >
            <i
              class="fas fa-{{ directory.icon }} text-{{ 'primary' if directory.type == 'daily' else 'success' if directory.type == 'weekly' else 'info' if directory.type == 'attendance' else 'warning' }}"
            ></i>
          </div>
          <div>
            <h4 class="mb-0">{{ directory.name }}</h4>
            <span class="text-muted"
              >{{ directory.reports|length }} reports available</span
            >
          </div>
          <div class="ms-auto text-end">
            {% set verification_score = 85 if directory.type == 'daily' else 92
            if directory.type == 'weekly' else 76 if directory.type ==
            'attendance' else 88 %}
            <div class="d-flex align-items-center">
              <span
                class="badge {{ 'bg-success' if verification_score >= 90 else 'bg-warning' if verification_score >= 75 else 'bg-danger' }} me-2"
                ><i class="fas fa-shield-alt me-1"></i> {{ verification_score
                }}%
              </span>
              <div class="dropdown">
                <button
                  class="btn btn-sm btn-outline-secondary"
                  type="button"
                  id="traceOptions{{ loop.index }}"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <i class="fas fa-code-branch"></i>
                </button>
                <ul
                  class="dropdown-menu dropdown-menu-end"
                  aria-labelledby="traceOptions{{ loop.index }}"
                >
                  <li>
                    <a
                      class="dropdown-item"
                      href="#"
                      data-trace-action="view"
                      data-dir-type="{{ directory.type }}"
                      ><i class="fas fa-eye me-2"></i>View Trace Chain</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item"
                      href="#"
                      data-trace-action="analyze"
                      data-dir-type="{{ directory.type }}"
                      ><i class="fas fa-microscope me-2"></i>Analyze
                      Integrity</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item"
                      href="#"
                      data-trace-action="export"
                      data-dir-type="{{ directory.type }}"
                      ><i class="fas fa-download me-2"></i>Export Trace Data</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="report-list">
            {% if directory.reports %}
            <ul class="list-group list-group-flush">
              {% for report in directory.reports %}
              <li
                class="list-group-item report-item d-flex align-items-center justify-content-between"
              >
                <div class="report-date">
                  <strong>{{ report.formatted_date }}</strong>
                </div>
                <div class="flex-grow-1">
                  <small class="text-muted">{{ report.filename }}</small>
                </div>
                <div class="report-actions">
                  <div class="btn-group btn-group-sm">
                    {% if directory.type == 'daily' %}
                    <a
                      href="{{ url_for('report_browser.view_daily_driver_report', date=report.date.strftime('%Y-%m-%d')) }}"
                      class="btn btn-outline-primary"
                      ><i class="fas fa-eye"></i
                    ></a>
                    {% endif %}
                    <a
                      href="{{ url_for('report_browser.download_report', report_type=directory.type, filename=report.filename) }}"
                      class="btn btn-outline-secondary"
                      ><i class="fas fa-download"></i
                    ></a>
                  </div>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="p-4 text-center">
              <i
                class="fas fa-folder-open text-muted mb-3"
                style="font-size: 3rem"
              ></i>
              <p class="mb-0">No reports found in this directory</p>
            </div>
            {% endif %}
          </div>
        </div>
        <div class="card-footer bg-transparent">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted small">{{ directory.path }}</span>
            {% if directory.type == 'daily' %}
            <a
              href="{{ url_for('daily_driver_report.dashboard') }}"
              class="btn btn-sm btn-outline-primary"
              ><i class="fas fa-plus me-1"></i> Create New Report
            </a>
            {% elif directory.type == 'weekly' %}
            <a
              href="{{ url_for('enhanced_weekly_report_bp.dashboard') }}"
              class="btn btn-sm btn-outline-success"
              ><i class="fas fa-plus me-1"></i> Create New Report
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-dark">
          <h5 class="mb-0">
            <i class="fas fa-chart-line me-2"></i> Cross-Report Analytics
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="startDate" class="form-label">Start Date</label
                ><input
                  type="date"
                  class="form-control"
                  id="startDate"
                  value="2025-05-01"
                />
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="endDate" class="form-label">End Date</label
                ><input
                  type="date"
                  class="form-control"
                  id="endDate"
                  value="2025-05-25"
                />
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="analyticType" class="form-label"
                  >Analysis Type</label
                ><select class="form-select" id="analyticType">
                  <option value="attendance">Attendance Trends</option>
                  <option value="verification">Verification Metrics</option>
                  <option value="anomalies">Anomaly Detection</option>
                  <option value="trace">Trace Chain Integrity</option>
                </select>
              </div>
            </div>
          </div>
          <div class="text-center">
            <button id="generateAnalytics" class="btn btn-primary">
              <i class="fas fa-cogs me-1"></i> Generate Analytics
            </button>
          </div>
          <div id="analyticsResults" class="mt-4" style="display: none">
            <div class="alert alert-info mb-3">
              <i class="fas fa-info-circle me-2"></i
              ><span id="analyticsStatus"
                >Analyzing data across
                <span id="reportCount">12</span> reports...</span
              >
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-body">
                    <h6 class="card-title">Driver Verification Trend</h6>
                    <canvas id="verificationChart" height="200"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-body">
                    <h6 class="card-title">
                      Attendance Classification Distribution
                    </h6>
                    <canvas id="attendanceChart" height="200"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header bg-dark">
                <h6 class="mb-0">Anomaly Detection Results</h6>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Driver</th>
                        <th>Anomaly Type</th>
                        <th>Confidence</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="anomalyTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row mt-3">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5><i class="fas fa-lightbulb me-2 text-warning"></i> Quick Tips</h5>
          <ul class="mb-0">
            <li>
              Daily Driver Reports show detailed driver attendance with
              identification verification
            </li>
            <li>
              Reports are automatically saved when generated, so you can access
              them later
            </li>
            <li>
              Use the download button to get the Excel version of any report
            </li>
            <li>
              For Daily Driver Reports, use the eye icon to view the enhanced
              report with driver verification stats
            </li>
            <li>
              Enable <span class="badge bg-danger">HARDLINE MODE</span> for the
              strictest verification requirements
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div
    class="modal fade"
    id="traceChainModal"
    tabindex="-1"
    aria-labelledby="traceChainModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-dark">
          <h5 class="modal-title" id="traceChainModalLabel">
            <i class="fas fa-code-branch me-2"></i> Trace Chain Visualization
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-primary">
            <i class="fas fa-info-circle me-2"></i> Displaying trace chain for
            <span id="traceReportType">Daily Driver Reports</span>
          </div>
          <div
            class="trace-chain-container"
            style="height: 400px; overflow-y: auto"
          >
            <div id="traceChainGraph" style="width: 100%; height: 350px"></div>
          </div>
          <div class="mt-3">
            <h6>Trace Chain Integrity Details</h6>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>Source</th>
                    <th>Transformation</th>
                    <th>Destination</th>
                    <th>Integrity Score</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="traceDetailsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Close</button
          ><button
            type="button"
            class="btn btn-primary"
            id="exportTraceChainBtn"
          >
            <i class="fas fa-download me-1"></i> Export Trace Data
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // HARDLINE MODE toggle functionality
    const hardlineModeSwitch = document.getElementById("hardline-mode-switch");
    const reportContainer = document.querySelector(".row");

    hardlineModeSwitch.addEventListener("change", function () {
      if (this.checked) {
        reportContainer.classList.add("hardline-mode");
        document.getElementById("genius-status").textContent = "HARDLINE";
        document.getElementById("genius-status").classList.remove("bg-success");
        document.getElementById("genius-status").classList.add("bg-danger");
      } else {
        reportContainer.classList.remove("hardline-mode");
        document.getElementById("genius-status").textContent = "ACTIVE";
        document.getElementById("genius-status").classList.remove("bg-danger");
        document.getElementById("genius-status").classList.add("bg-success");
      }
    });

    // Verification level dropdown
    document
      .querySelectorAll(".dropdown-menu .dropdown-item")
      .forEach((item) => {
        item.addEventListener("click", function (e) {
          e.preventDefault();

          // Remove active class from all items
          document
            .querySelectorAll(".dropdown-menu .dropdown-item")
            .forEach((el) => {
              el.classList.remove("active");
            });

          // Add active class to clicked item
          this.classList.add("active");

          // Update dropdown button text
          const verificationLevel = this.getAttribute("data-level");
          const dropdownButton = document.getElementById(
            "verificationLevelDropdown",
          );

          switch (verificationLevel) {
            case "all":
              dropdownButton.innerHTML =
                '<i class="fas fa-shield-alt me-1"></i> All Reports';
              filterReportsByVerification(0);
              break;
            case "basic":
              dropdownButton.innerHTML =
                '<i class="fas fa-shield-alt me-1"></i> Basic (70%+)';
              filterReportsByVerification(70);
              break;
            case "enhanced":
              dropdownButton.innerHTML =
                '<i class="fas fa-shield-alt me-1"></i> Enhanced (85%+)';
              filterReportsByVerification(85);
              break;
            case "genius":
              dropdownButton.innerHTML =
                '<i class="fas fa-shield-alt me-1"></i> GENIUS CORE';
              filterReportsByVerification(100);
              break;
          }
        });
      });

    // Filter reports by verification level
    function filterReportsByVerification(minLevel) {
      document.querySelectorAll(".report-item").forEach((item) => {
        const verificationScore = parseInt(
          item.getAttribute("data-verification") || 0,
        );

        if (verificationScore >= minLevel) {
          item.style.display = "";
        } else {
          item.style.display = "none";
        }
      });
    }

    // Trace Chain Visualization
    document.querySelectorAll("[data-trace-action]").forEach((item) => {
      item.addEventListener("click", function (e) {
        e.preventDefault();

        const action = this.getAttribute("data-trace-action");
        const reportType = this.getAttribute("data-dir-type");

        if (action === "view") {
          showTraceChainModal(reportType);
        } else if (action === "analyze") {
          analyzeTraceIntegrity(reportType);
        } else if (action === "export") {
          exportTraceData(reportType);
        }
      });
    });

    // Show Trace Chain Modal
    function showTraceChainModal(reportType) {
      document.getElementById("traceReportType").textContent =
        capitalizeFirstLetter(reportType) + " Reports";

      // Create sample trace chain data
      const nodes = [
        { id: "source_1", name: "Driving History", type: "source" },
        { id: "source_2", name: "Asset List", type: "source" },
        { id: "source_3", name: "Activity Detail", type: "source" },
        { id: "transform_1", name: "Driver Matcher", type: "transform" },
        { id: "transform_2", name: "Time Extractor", type: "transform" },
        { id: "transform_3", name: "Location Mapper", type: "transform" },
        { id: "verification", name: "GENIUS Verifier", type: "critical" },
        {
          id: "classification",
          name: "Attendance Classifier",
          type: "transform",
        },
        { id: "output", name: reportType + " Report", type: "output" },
      ];

      const links = [
        { source: "source_1", target: "transform_1", value: 1 },
        { source: "source_2", target: "transform_1", value: 1 },
        { source: "source_1", target: "transform_2", value: 1 },
        { source: "source_3", target: "transform_3", value: 1 },
        { source: "transform_1", target: "verification", value: 1 },
        { source: "transform_2", target: "verification", value: 1 },
        { source: "transform_3", target: "verification", value: 1 },
        { source: "verification", target: "classification", value: 1 },
        { source: "classification", target: "output", value: 1 },
      ];

      // Create trace details table
      const traceDetails = [
        {
          source: "Driving History",
          transformation: "Driver Matcher",
          destination: "GENIUS Verifier",
          integrity: 98,
          status: "Verified",
        },
        {
          source: "Asset List",
          transformation: "Driver Matcher",
          destination: "GENIUS Verifier",
          integrity: 100,
          status: "Verified",
        },
        {
          source: "Driving History",
          transformation: "Time Extractor",
          destination: "GENIUS Verifier",
          integrity: 96,
          status: "Verified",
        },
        {
          source: "Activity Detail",
          transformation: "Location Mapper",
          destination: "GENIUS Verifier",
          integrity: 93,
          status: "Verified",
        },
        {
          source: "GENIUS Verifier",
          transformation: "Attendance Classifier",
          destination: reportType + " Report",
          integrity: 97,
          status: "Verified",
        },
      ];

      populateTraceDetailsTable(traceDetails);

      // Initialize visualization
      renderTraceChainGraph(nodes, links);

      // Show modal
      const traceChainModal = new bootstrap.Modal(
        document.getElementById("traceChainModal"),
      );
      traceChainModal.show();
    }

    // Populate trace details table
    function populateTraceDetailsTable(traceDetails) {
      const tableBody = document.getElementById("traceDetailsTableBody");
      tableBody.innerHTML = "";

      traceDetails.forEach((detail) => {
        const row = document.createElement("tr");

        row.innerHTML = `
<td>${detail.source}</td><td>${detail.transformation}</td><td>${detail.destination}</td><td><div class="d-flex align-items-center"><div class="progress flex-grow-1 me-2" style="height: 5px;"><div class="progress-bar ${detail.integrity >= 95 ? "bg-success" : detail.integrity >= 80 ? "bg-warning" : "bg-danger"}"
role="progressbar" style="width: ${detail.integrity}%;"
aria-valuenow="${detail.integrity}" aria-valuemin="0" aria-valuemax="100"></div></div><span>${detail.integrity}%</span></div></td><td><span class="badge ${detail.status === "Verified" ? "bg-success" : "bg-warning"}">
${detail.status}
</span></td>
`;

        tableBody.appendChild(row);
      });
    }

    // Render trace chain graph
    function renderTraceChainGraph(nodes, links) {
      // Clear previous graph
      document.getElementById("traceChainGraph").innerHTML = "";

      const width = document.getElementById("traceChainGraph").clientWidth;
      const height = 350;

      const svg = d3
        .select("#traceChainGraph")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const simulation = d3
        .forceSimulation(nodes)
        .force(
          "link",
          d3
            .forceLink(links)
            .id((d) => d.id)
            .distance(100),
        )
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2));

      // Add links
      const link = svg
        .append("g")
        .selectAll("line")
        .data(links)
        .enter()
        .append("line")
        .attr("class", "trace-link");

      // Add nodes
      const node = svg
        .append("g")
        .selectAll("circle")
        .data(nodes)
        .enter()
        .append("circle")
        .attr(
          "class",
          (d) =>
            `trace-node ${d.type === "critical" ? "trace-node-critical" : d.type === "output" ? "trace-node-verified" : ""}`,
        )
        .attr("r", 20)
        .call(
          d3
            .drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended),
        );

      // Add node labels
      const label = svg
        .append("g")
        .selectAll("text")
        .data(nodes)
        .enter()
        .append("text")
        .attr("class", "trace-node-text")
        .text((d) => d.name.split(" ")[0])
        .attr("dy", 30);

      // Update positions on simulation tick
      simulation.on("tick", () => {
        link
          .attr("x1", (d) => d.source.x)
          .attr("y1", (d) => d.source.y)
          .attr("x2", (d) => d.target.x)
          .attr("y2", (d) => d.target.y);

        node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);

        label.attr("x", (d) => d.x).attr("y", (d) => d.y);
      });

      // Drag functions
      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    }

    // Analyze trace integrity
    function analyzeTraceIntegrity(reportType) {
      // Show loading indicator
      document.getElementById("analyze-trace-btn").innerHTML =
        '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Analyzing...';
      document.getElementById("analyze-trace-btn").disabled = true;

      // Simulate analysis process with timeout
      setTimeout(() => {
        // Update integrity level
        document.getElementById("trace-integrity-level").textContent = "96.8%";
        document.querySelector(".progress-bar").style.width = "96.8%";

        // Reset button
        document.getElementById("analyze-trace-btn").innerHTML =
          '<i class="fas fa-microscope me-1"></i> Analyze Trace Chain';
        document.getElementById("analyze-trace-btn").disabled = false;

        // Show success message
        alert(
          "Trace Chain Integrity Analysis Complete: 96.8% integrity verified.",
        );
      }, 1500);
    }

    // Export trace data
    function exportTraceData(reportType) {
      // Create a sample trace data object
      const traceData = {
        reportType: reportType,
        timestamp: new Date().toISOString(),
        integrity: 96.8,
        nodes: [
          { id: "source_1", name: "Driving History", type: "source" },
          { id: "source_2", name: "Asset List", type: "source" },
          { id: "source_3", name: "Activity Detail", type: "source" },
          { id: "transform_1", name: "Driver Matcher", type: "transform" },
          { id: "transform_2", name: "Time Extractor", type: "transform" },
          { id: "transform_3", name: "Location Mapper", type: "transform" },
          { id: "verification", name: "GENIUS Verifier", type: "critical" },
          {
            id: "classification",
            name: "Attendance Classifier",
            type: "transform",
          },
          { id: "output", name: reportType + " Report", type: "output" },
        ],
        links: [
          { source: "source_1", target: "transform_1", value: 1 },
          { source: "source_2", target: "transform_1", value: 1 },
          { source: "source_1", target: "transform_2", value: 1 },
          { source: "source_3", target: "transform_3", value: 1 },
          { source: "transform_1", target: "verification", value: 1 },
          { source: "transform_2", target: "verification", value: 1 },
          { source: "transform_3", target: "verification", value: 1 },
          { source: "verification", target: "classification", value: 1 },
          { source: "classification", target: "output", value: 1 },
        ],
      };

      // Convert to JSON string
      const jsonString = JSON.stringify(traceData, null, 2);

      // Create download link
      const dataStr =
        "data:text/json;charset=utf-8," + encodeURIComponent(jsonString);
      const downloadAnchorNode = document.createElement("a");
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute(
        "download",
        `trace_chain_${reportType}_${new Date().toISOString().slice(0, 10)}.json`,
      );
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }

    // Cross-Report Analytics
    const generateAnalyticsBtn = document.getElementById("generateAnalytics");

    if (generateAnalyticsBtn) {
      generateAnalyticsBtn.addEventListener("click", function () {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        const analyticType = document.getElementById("analyticType").value;

        // Show analytics results section
        document.getElementById("analyticsResults").style.display = "block";

        // Set report count
        const reportCount = Math.floor(Math.random() * 10) + 8; // Random number between 8-17
        document.getElementById("reportCount").textContent = reportCount;

        // Generate charts based on analytic type
        if (analyticType === "attendance" || analyticType === "verification") {
          generateVerificationChart();
          generateAttendanceChart();
        }

        // Generate anomaly data
        if (analyticType === "anomalies") {
          generateAnomalyTable();
        }
      });
    }

    // Generate verification chart
    function generateVerificationChart() {
      const ctx = document.getElementById("verificationChart").getContext("2d");

      // Destroy existing chart if it exists
      if (window.verificationChart) {
        window.verificationChart.destroy();
      }

      // Generate random data
      const dates = [];
      const data = [];

      // Generate dates and random data for the past 10 days
      for (let i = 9; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(
          date.toLocaleDateString("en-US", { month: "short", day: "numeric" }),
        );

        // Random value between 80-100
        const value = Math.floor(Math.random() * 20) + 80;
        data.push(value);
      }

      // Create chart
      window.verificationChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: dates,
          datasets: [
            {
              label: "Driver Verification %",
              data: data,
              backgroundColor: "rgba(74, 108, 247, 0.2)",
              borderColor: "rgba(74, 108, 247, 1)",
              borderWidth: 2,
              tension: 0.3,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: 70,
              max: 100,
              ticks: {
                stepSize: 5,
              },
            },
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function (context) {
                  return `Verification: ${context.raw}%`;
                },
              },
            },
          },
        },
      });
    }

    // Generate attendance chart
    function generateAttendanceChart() {
      const ctx = document.getElementById("attendanceChart").getContext("2d");

      // Destroy existing chart if it exists
      if (window.attendanceChart) {
        window.attendanceChart.destroy();
      }

      // Create chart
      window.attendanceChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["On Time", "Late Start", "Early End", "Not On Job"],
          datasets: [
            {
              label: "Count",
              data: [65, 15, 12, 8],
              backgroundColor: [
                "rgba(40, 167, 69, 0.7)",
                "rgba(255, 193, 7, 0.7)",
                "rgba(23, 162, 184, 0.7)",
                "rgba(220, 53, 69, 0.7)",
              ],
              borderColor: [
                "rgba(40, 167, 69, 1)",
                "rgba(255, 193, 7, 1)",
                "rgba(23, 162, 184, 1)",
                "rgba(220, 53, 69, 1)",
              ],
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
          },
        },
      });
    }

    // Generate anomaly table
    function generateAnomalyTable() {
      const tableBody = document.getElementById("anomalyTableBody");
      if (!tableBody) return;

      tableBody.innerHTML = "";

      // Sample anomaly data
      const anomalies = [
        {
          date: "2025-05-22",
          driver: "Carter, William R",
          type: "Inconsistent Location",
          confidence: 87,
        },
        {
          date: "2025-05-20",
          driver: "Rodriguez, Maria T",
          type: "Pattern Deviation",
          confidence: 92,
        },
        {
          date: "2025-05-19",
          driver: "Johnson, Robert L",
          type: "Multiple Assets",
          confidence: 78,
        },
        {
          date: "2025-05-15",
          driver: "Patel, Anita K",
          type: "Inconsistent Location",
          confidence: 95,
        },
        {
          date: "2025-05-12",
          driver: "Wilson, James D",
          type: "Pattern Deviation",
          confidence: 81,
        },
      ];

      // Populate table
      anomalies.forEach((anomaly) => {
        const row = document.createElement("tr");
        row.classList.add(anomaly.confidence > 90 ? "anomaly-highlight" : "");

        row.innerHTML = `
<td>${anomaly.date}</td><td>${anomaly.driver}</td><td>${anomaly.type}</td><td><div class="d-flex align-items-center"><div class="progress flex-grow-1 me-2" style="height: 5px;"><div class="progress-bar ${anomaly.confidence > 90 ? "bg-danger" : "bg-warning"}"
role="progressbar" style="width: ${anomaly.confidence}%;"
aria-valuenow="${anomaly.confidence}" aria-valuemin="0" aria-valuemax="100"></div></div><span>${anomaly.confidence}%</span></div></td><td><button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="tooltip" title="View Details"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Validate"><i class="fas fa-check"></i></button></td>
`;

        tableBody.appendChild(row);
      });

      // Initialize tooltips
      const tooltipTriggerList = document.querySelectorAll(
        '[data-bs-toggle="tooltip"]',
      );
      if (tooltipTriggerList.length) {
        Array.from(tooltipTriggerList).map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      }
    }

    // Helper function to capitalize first letter
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    // Add random verification scores to report items
    document.querySelectorAll(".report-item").forEach((item) => {
      // Generate random verification score between 75 and 100
      const score = Math.floor(Math.random() * 26) + 75;
      item.setAttribute("data-verification", score);
    });
  });
</script>
{% endblock %}

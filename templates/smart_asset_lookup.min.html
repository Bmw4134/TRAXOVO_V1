{% extends "dashboard.html" %}

{% block title %}Smart Asset Lookup{% endblock %}

{% block content %}
<div class="container-fluid"><div class="row"><div class="col-12"><div class="card mb-4"><div class="card-body"><h2><i class="bi bi-search me-3"></i>Smart Asset Lookup</h2><p class="text-muted">Real-time search of 717 assets using GAUGE API integration</p></div></div><div class="card mb-4"><div class="card-body"><div class="row"><div class="col-md-6"><div class="search-container mb-3"><i class="bi bi-search search-icon"></i><input type="text" id="assetSearch" class="form-control search-input" placeholder="Search assets by ID or name..."></div></div><div class="col-md-3"><select id="assetType" class="form-select"><option value="">All Types</option><option value="excavator">Excavator</option><option value="truck">Truck</option><option value="loader">Loader</option><option value="dozer">Dozer</option></select></div><div class="col-md-3"><select id="assetStatus" class="form-select"><option value="">All Status</option><option value="active">Active</option><option value="maintenance">Maintenance</option><option value="idle">Idle</option></select></div></div></div></div><div class="card"><div class="card-header"><h5 class="mb-0">Search Results</h5><small id="resultCount" class="text-muted">Search to see results</small></div><div class="card-body"><div id="searchResults" class="row"><div class="col-12 text-center text-muted"><i class="bi bi-search display-1"></i><p class="mt-3">Enter search criteria to find assets</p></div></div></div></div></div></div></div><script>
let searchTimeout;

function performSearch() {
const query = document.getElementById('assetSearch').value;
const type = document.getElementById('assetType').value;
const status = document.getElementById('assetStatus').value;

const params = new URLSearchParams();
if (query) params.append('query', query);
if (type) params.append('type', type);
if (status) params.append('status', status);

fetch(`/api/search-assets?${params}`)
.then(response => response.json())
.then(data => {
displayResults(data);
})
.catch(error => {
console.error('Search error:', error);
displayError();
});
}

function displayResults(data) {
const resultsDiv = document.getElementById('searchResults');
const countDiv = document.getElementById('resultCount');

if (data.error) {
resultsDiv.innerHTML = `
<div class="col-12 text-center text-danger"><i class="bi bi-exclamation-triangle display-1"></i><p class="mt-3">${data.error}</p></div>
`;
countDiv.textContent = 'Search error';
return;
}

if (!data.assets || data.assets.length === 0) {
resultsDiv.innerHTML = `
<div class="col-12 text-center text-muted"><i class="bi bi-search display-1"></i><p class="mt-3">No assets found matching your criteria</p></div>
`;
countDiv.textContent = '0 results';
return;
}

countDiv.textContent = `${data.assets.length} result(s) found`;

resultsDiv.innerHTML = data.assets.map(asset => `
<div class="col-md-6 col-lg-4 mb-3"><div class="card h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-start mb-3"><h6 class="card-title mb-0">${asset.name}</h6><span class="badge bg-${asset.status === 'active' ? 'success' : asset.status === 'maintenance' ? 'warning' : 'secondary'}">${asset.status}</span></div><p class="text-muted small mb-2">ID: ${asset.id}</p><p class="text-muted small mb-2">Type: ${asset.type}</p><p class="text-muted small mb-2">Location: ${asset.location}</p><div class="row text-center mt-3"><div class="col-4"><small class="text-muted">Hours</small><div class="fw-bold">${asset.operating_hours || 0}</div></div><div class="col-4"><small class="text-muted">Fuel</small><div class="fw-bold">${asset.fuel_level || 0}%</div></div><div class="col-4"><small class="text-muted">Util</small><div class="fw-bold">${asset.utilization || 0}%</div></div></div></div></div></div>
`).join('');
}

function displayError() {
document.getElementById('searchResults').innerHTML = `
<div class="col-12 text-center text-danger"><i class="bi bi-exclamation-triangle display-1"></i><p class="mt-3">Unable to connect to GAUGE API. Please check your connection.</p></div>
`;
}

// Event listeners
document.getElementById('assetSearch').addEventListener('input', () => {
clearTimeout(searchTimeout);
searchTimeout = setTimeout(performSearch, 300);
});

document.getElementById('assetType').addEventListener('change', performSearch);
document.getElementById('assetStatus').addEventListener('change', performSearch);

// Initial search on page load
document.addEventListener('DOMContentLoaded', () => {
performSearch();
});
</script>
{% endblock %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Risk Analytics - TRAXOVO</title>
    <link
      href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .risk-score-display {
        font-size: 2rem;
        font-weight: bold;
      }
      .risk-critical {
        color: #dc3545;
      }
      .risk-high {
        color: #fd7e14;
      }
      .risk-moderate {
        color: #0dcaf0;
      }
      .risk-low {
        color: #198754;
      }
      .prediction-item {
        background: #f8f9fa;
        border-left: 4px solid #0dcaf0;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
      }
      .driver-card {
        transition: transform 0.2s;
        cursor: pointer;
      }
      .driver-card:hover {
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/"
          ><i class="fas fa-brain me-2"></i>TRAXOVO Smart Analytics
        </a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/"
            ><i class="fas fa-home me-1"></i>Dashboard</a
          ><a class="nav-link" href="/daily-driver-authentic"
            ><i class="fas fa-users me-1"></i>Attendance</a
          >
        </div>
      </div>
    </nav>
    <div class="container-fluid mt-4">
      <div class="row mb-4">
        <div class="col-md-2">
          <div class="card bg-danger text-white">
            <div class="card-body text-center">
              <h4>{{ summary_stats.critical_risk }}</h4>
              <small>Critical Risk</small>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-warning text-dark">
            <div class="card-body text-center">
              <h4>{{ summary_stats.high_risk }}</h4>
              <small>High Risk</small>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <h4>{{ summary_stats.moderate_risk }}</h4>
              <small>Moderate Risk</small>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h4>{{ summary_stats.low_risk }}</h4>
              <small>Low Risk</small>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-primary text-white">
            <div class="card-body text-center">
              <h4>{{ summary_stats.total_drivers }}</h4>
              <small>Total Drivers</small>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-secondary text-white">
            <div class="card-body text-center">
              <h4>{{ summary_stats.avg_risk_score }}%</h4>
              <small>Avg Risk Score</small>
            </div>
          </div>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-4">
          <select class="form-select" onchange="filterByDivision(this.value)">
            <option value="all">All Divisions</option>
            <option
              value="DFW"
              {%
              if
              division_filter=""
              ="DFW"
              %}selected{%
              endif
              %}
            >
              DFW Division
            </option>
            <option
              value="Houston"
              {%
              if
              division_filter=""
              ="Houston"
              %}selected{%
              endif
              %}
            >
              Houston Division
            </option>
            <option
              value="WTX"
              {%
              if
              division_filter=""
              ="WTX"
              %}selected{%
              endif
              %}
            >
              West Texas Division
            </option>
          </select>
        </div>
        <div class="col-md-4">
          <input
            type="text"
            class="form-control"
            placeholder="Search drivers..."
            onkeyup="searchDrivers(this.value)"
          />
        </div>
        <div class="col-md-4">
          <button class="btn btn-outline-primary" onclick="refreshAnalysis()">
            <i class="fas fa-sync me-1"></i>Refresh Analysis
          </button>
        </div>
      </div>
      <div class="row" id="driverContainer">
        {% for driver in analyzed_drivers %}
        <div
          class="col-md-6 col-lg-4 mb-3 driver-item"
          data-division="{{ driver.division }}"
          data-name="{{ driver.driver_name.lower() }}"
        >
          <div
            class="card driver-card h-100"
            onclick="showDriverDetail('{{ driver.driver_id }}')"
          >
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <strong>{{ driver.driver_name }}</strong
              ><span class="badge bg-{{ driver.risk_class }}"
                >{{ driver.risk_level }}</span
              >
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-6">
                  <div
                    class="risk-score-display risk-{{ driver.risk_class.replace('danger', 'critical').replace('warning', 'high').replace('info', 'moderate').replace('success', 'low') }}"
                  >
                    {{ driver.risk_score }}%
                  </div>
                  <small class="text-muted">Risk Score</small>
                </div>
                <div class="col-6">
                  <small><strong>ID:</strong> {{ driver.employee_id }}</small
                  ><br /><small
                    ><strong>Asset:</strong> {{ driver.asset_id }}</small
                  ><br /><small
                    ><strong>Division:</strong> {{ driver.division }}</small
                  >
                </div>
              </div>

              {% if driver.predictions %}
              <div class="mt-3">
                <small class="text-muted"><strong>Predictions:</strong></small>
                {% for prediction in driver.predictions[:2] %}
                <div class="prediction-item">
                  <small>{{ prediction }}</small>
                </div>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="modal fade" id="driverDetailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Driver Risk Analysis</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="driverDetailContent">Loading...</div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function filterByDivision(division) {
        const items = document.querySelectorAll(".driver-item");
        items.forEach((item) => {
          if (division === "all" || item.dataset.division === division) {
            item.style.display = "";
          } else {
            item.style.display = "none";
          }
        });
      }

      function searchDrivers(searchTerm) {
        const items = document.querySelectorAll(".driver-item");
        const term = searchTerm.toLowerCase();

        items.forEach((item) => {
          const name = item.dataset.name;
          if (!term || name.includes(term)) {
            item.style.display = "";
          } else {
            item.style.display = "none";
          }
        });
      }

      function showDriverDetail(driverId) {
        const modal = new bootstrap.Modal(
          document.getElementById("driverDetailModal"),
        );

        fetch(`/api/driver-risk/${driverId}`)
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("driverDetailContent").innerHTML =
              generateDetailHTML(data);
            modal.show();
          })
          .catch((error) => {
            document.getElementById("driverDetailContent").innerHTML =
              "Error loading driver details.";
            modal.show();
          });
      }

      function generateDetailHTML(data) {
        let html = `
<div class="row"><div class="col-md-6"><h6>Risk Score: <span class="text-danger">${data.risk_score}%</span></h6><p><strong>Risk Level:</strong> ${data.risk_level}</p></div></div><h6>Risk Factors:</h6><ul>
`;

        for (const [factor, value] of Object.entries(data.risk_factors)) {
          html += `<li><strong>${factor.replace(/_/g, " ")}:</strong> ${(value * 100).toFixed(1)}%</li>`;
        }

        html += `</ul>`;

        if (data.predictions && data.predictions.length > 0) {
          html += `<h6>Predictions:</h6><ul>`;
          data.predictions.forEach((prediction) => {
            html += `<li>${prediction}</li>`;
          });
          html += `</ul>`;
        }

        if (data.recommendations && data.recommendations.length > 0) {
          html += `<h6>Recommendations:</h6><ul>`;
          data.recommendations.forEach((rec) => {
            html += `<li>${rec}</li>`;
          });
          html += `</ul>`;
        }

        return html;
      }

      function refreshAnalysis() {
        location.reload();
      }
    </script>
  </body>
</html>

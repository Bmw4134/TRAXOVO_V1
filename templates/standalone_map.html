<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Map - TRAXORA</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1e2124;
            color: white;
        }
        
        .page-container {
            display: flex;
            flex-direction: row;
            height: calc(100vh - 56px); /* Subtract navbar height */
        }
        
        .sidebar {
            width: 280px;
            min-width: 280px;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background-color: #1e2124;
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-content {
            flex: 1;
        }
        
        .map-container {
            flex: 1;
            height: 100%;
            position: relative;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-active {
            background-color: #28a745;
        }
        
        .status-idle {
            background-color: #ffc107;
        }
        
        .status-maintenance {
            background-color: #dc3545;
        }
        
        .status-inactive {
            background-color: #6c757d;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .footer {
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 1rem;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            text-align: center;
        }
        
        .leaflet-container {
            background-color: #303030 !important;
        }
        
        .section {
            margin-bottom: 1.5rem;
        }
        
        .section h5 {
            margin-bottom: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3 py-2">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">TRAXORA</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/map"><i class="bi bi-geo-alt me-1"></i> Asset Map</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/driver-reports/"><i class="bi bi-person-badge me-1"></i> Driver Reports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/billing/"><i class="bi bi-receipt me-1"></i> PM Allocation</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="page-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-content">
                <h3 class="mb-1">Asset Map</h3>
                <p class="text-muted mb-4">Real-time Fleet Tracking</p>
                
                <!-- Filters Section -->
                <div class="section">
                    <h5>Filters</h5>
                    <div class="form-group">
                        <label>Asset Type</label>
                        <select id="type-filter" class="form-select form-select-sm">
                            <option value="">All Types</option>
                            <option value="Truck">Trucks</option>
                            <option value="Excavator">Excavators</option>
                            <option value="Loader">Loaders</option>
                            <option value="Dozer">Dozers</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Job Site</label>
                        <select id="job-site-filter" class="form-select form-select-sm">
                            <option value="">All Job Sites</option>
                            <option value="1">Downtown Dallas</option>
                            <option value="2">Houston Central</option>
                            <option value="3">Austin Highway</option>
                        </select>
                    </div>
                    
                    <button id="refresh-map" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-arrow-clockwise me-1"></i> Refresh Map
                    </button>
                </div>
                
                <!-- Legend Section -->
                <div class="section">
                    <h5>Map Legend</h5>
                    <div class="mb-2"><span class="status-indicator status-active"></span> Active</div>
                    <div class="mb-2"><span class="status-indicator status-idle"></span> Idle</div>
                    <div class="mb-2"><span class="status-indicator status-maintenance"></span> Maintenance</div>
                    <div class="mb-2"><span class="status-indicator status-inactive"></span> Inactive</div>
                </div>
                
                <!-- System Status Section -->
                <div class="section">
                    <h5>System Status</h5>
                    <div id="api-status" class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="bi bi-cloud me-1"></i> API Connection</span>
                        <span class="badge bg-warning">Connecting...</span>
                    </div>
                    <div id="update-time" class="small text-muted">
                        Last update: <span id="last-update-time">Not yet updated</span>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="footer">
                Â© 2025 TRAXORA Fleet Management System<br>
                GENIUS CORE CONTINUITY MODE ACTIVE
            </div>
        </div>
        
        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    
    <!-- Required Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing map');
            
            // Initialize map with a dark theme
            var map = L.map('map', {
                center: [32.7767, -96.7970],
                zoom: 8,
                zoomControl: true,
                attributionControl: true
            });
            
            // Create base map layers
            var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '&copy; <a href="https://www.esri.com/">Esri</a>',
                maxZoom: 19
            });
            
            var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            });
            
            var topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors',
                maxZoom: 17
            });
            
            var darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            });
            
            // Add satellite layer by default
            satelliteLayer.addTo(map);
            
            // Create layer control
            var baseMaps = {
                "Satellite": satelliteLayer,
                "Streets": streetLayer,
                "Topographic": topoLayer,
                "Dark Mode": darkLayer
            };
            
            // Add layer control to the map
            L.control.layers(baseMaps, null, {position: 'topright'}).addTo(map);
            
            // Force a map refresh to prevent rendering issues
            setTimeout(function() {
                map.invalidateSize(true);
                console.log('Map size invalidated for proper rendering');
            }, 500);
            
            // Storage for markers
            var assetMarkers = {};
            var jobSiteMarkers = {};
            
            // Create custom icons for assets
            function createAssetIcon(status) {
                var color = "#28a745"; // Default: active
                
                if (status === "idle") {
                    color = "#ffc107";
                } else if (status === "maintenance") {
                    color = "#dc3545";
                } else if (status === "inactive") {
                    color = "#6c757d";
                }
                
                return L.divIcon({
                    className: 'asset-marker-icon',
                    html: `<div style="background-color:${color};width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
            }
            
            // Create job site icon
            function createJobSiteIcon(name) {
                return L.divIcon({
                    className: 'job-site-marker',
                    html: `<div style="background:#343a40;color:white;padding:3px 8px;border-radius:4px;font-size:12px;white-space:nowrap;">${name}</div>`,
                    iconSize: [120, 20],
                    iconAnchor: [60, 10]
                });
            }
            
            // Create site overlay group
            var jobSiteOverlay = L.layerGroup().addTo(map);
            
            // Create asset overlay group
            var assetOverlay = L.layerGroup().addTo(map);
            
            // Create overlay controls
            var overlays = {
                "Assets": assetOverlay,
                "Job Sites": jobSiteOverlay
            };
            
            // Update layer control to include overlays
            L.control.layers(baseMaps, overlays, {position: 'topright'}).addTo(map);
            
            // Load assets from API
            function loadAssets() {
                updateApiStatus('loading');
                
                var typeFilter = document.getElementById('type-filter').value;
                var jobSiteFilter = document.getElementById('job-site-filter').value;
                
                var params = [];
                if (typeFilter) params.push('type=' + encodeURIComponent(typeFilter));
                if (jobSiteFilter) params.push('job_site=' + encodeURIComponent(jobSiteFilter));
                var queryString = params.length > 0 ? '?' + params.join('&') : '';
                
                fetch('/map/api/assets' + queryString)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(function(data) {
                        console.log('Assets loaded:', data);
                        updateApiStatus('success');
                        
                        // Clear existing markers
                        Object.values(assetMarkers).forEach(function(marker) {
                            map.removeLayer(marker);
                        });
                        assetMarkers = {};
                        
                        // Add markers for assets
                        data.forEach(function(asset) {
                            if (!asset.latitude || !asset.longitude) return;
                            
                            var marker = L.marker([asset.latitude, asset.longitude], {
                                icon: createAssetIcon(asset.status)
                            }).addTo(assetOverlay);
                            
                            var popupContent = `
                                <div style="min-width:200px">
                                    <h5>${asset.name || asset.id || 'Asset'}</h5>
                                    <div><strong>ID:</strong> ${asset.asset_id || asset.id}</div>
                                    <div><strong>Type:</strong> ${asset.type || 'Unknown'}</div>
                                    <div><strong>Driver:</strong> ${asset.driver || 'None'}</div>
                                    <div><strong>Status:</strong> ${asset.status || 'Unknown'}</div>
                                    <div><strong>Last Update:</strong> ${asset.last_update ? new Date(asset.last_update).toLocaleString() : 'Unknown'}</div>
                                </div>
                            `;
                            
                            marker.bindPopup(popupContent);
                            assetMarkers[asset.id] = marker;
                        });
                        
                        document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString();
                    })
                    .catch(function(error) {
                        console.error('Error loading assets:', error);
                        updateApiStatus('error');
                    });
            }
            
            // Load job sites
            function loadJobSites() {
                fetch('/map/api/job-sites')
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(function(data) {
                        console.log('Job sites loaded:', data);
                        
                        // Clear existing markers
                        Object.values(jobSiteMarkers).forEach(function(marker) {
                            map.removeLayer(marker);
                        });
                        jobSiteMarkers = {};
                        
                        // Add markers for job sites
                        data.forEach(function(site) {
                            if (!site.latitude || !site.longitude) return;
                            
                            var marker = L.marker([site.latitude, site.longitude], {
                                icon: createJobSiteIcon(site.name)
                            }).addTo(jobSiteOverlay);
                            
                            var popupContent = `
                                <div>
                                    <h5>${site.name}</h5>
                                    <div><strong>Job Number:</strong> ${site.job_number || 'None'}</div>
                                    <div><strong>Address:</strong> ${site.address || 'Unknown'}</div>
                                </div>
                            `;
                            
                            marker.bindPopup(popupContent);
                            jobSiteMarkers[site.id] = marker;
                        });
                    })
                    .catch(function(error) {
                        console.error('Error loading job sites:', error);
                    });
            }
            
            // Update API status indicator
            function updateApiStatus(status) {
                var statusElement = document.getElementById('api-status');
                if (status === 'loading') {
                    statusElement.innerHTML = '<span><i class="bi bi-cloud me-1"></i> API Connection</span><span class="badge bg-info">Loading...</span>';
                } else if (status === 'success') {
                    statusElement.innerHTML = '<span><i class="bi bi-cloud me-1"></i> API Connection</span><span class="badge bg-success">Connected</span>';
                } else if (status === 'error') {
                    statusElement.innerHTML = '<span><i class="bi bi-cloud me-1"></i> API Connection</span><span class="badge bg-danger">Error</span>';
                }
            }
            
            // Load initial data
            loadAssets();
            loadJobSites();
            
            // Set up auto-refresh every 60 seconds
            setInterval(loadAssets, 60000);
            
            // Set up event listeners
            document.getElementById('refresh-map').addEventListener('click', function() {
                loadAssets();
                loadJobSites();
            });
            
            document.getElementById('type-filter').addEventListener('change', loadAssets);
            document.getElementById('job-site-filter').addEventListener('change', loadAssets);
        });
    </script>
</body>
</html>
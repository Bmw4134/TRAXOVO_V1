{% extends "base.html" %}

{% block title %}Data Upload - TRAXOVO{% endblock %}

{% block extra_css %}
<style>
.upload-header {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.upload-zones {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.upload-zone {
    border: 3px dashed #d1d5db;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    background: white;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.upload-zone:hover {
    border-color: var(--primary-blue);
    background: #f0f9ff;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(30, 64, 175, 0.15);
}

.upload-zone.dragover {
    border-color: var(--success-green);
    background: #f0fdf4;
}

.upload-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--dark-gray);
}

.upload-zone:hover .upload-icon {
    color: var(--primary-blue);
}

.upload-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary-blue);
    margin-bottom: 0.5rem;
}

.upload-description {
    color: var(--dark-gray);
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.upload-formats {
    font-size: 0.8rem;
    color: var(--dark-gray);
    background: #f8fafc;
    padding: 0.5rem;
    border-radius: 6px;
    margin-top: 1rem;
}

.progress-container {
    margin-top: 2rem;
    display: none;
}

.file-list {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: none;
}

.file-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 1rem;
    background: #f9fafb;
}

.file-info {
    flex-grow: 1;
}

.file-name {
    font-weight: 600;
    color: var(--primary-blue);
}

.file-size {
    font-size: 0.8rem;
    color: var(--dark-gray);
}

.file-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-processing {
    background: #fef3c7;
    color: #92400e;
}

.status-success {
    background: #dcfce7;
    color: #166534;
}

.status-error {
    background: #fee2e2;
    color: #991b1b;
}

.recent-uploads {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.recent-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f5f9;
}

.recent-item:last-child {
    border-bottom: none;
}

.hidden {
    display: none !important;
}
</style>
{% endblock %}

{% block content %}
<!-- Upload Header -->
<div class="upload-header">
    <h1><i class="fas fa-upload me-2"></i>Data Upload Center</h1>
    <p>Upload GAUGE reports, driving history, activity detail, and RAGLE billing files for processing</p>
</div>

<!-- Upload Zones -->
<div class="upload-zones">
    <!-- Attendance Data Upload -->
    <div class="upload-zone" onclick="triggerFileInput('attendance')" ondrop="handleDrop(event, 'attendance')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
        <div class="upload-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="upload-title">Attendance Data</div>
        <div class="upload-description">
            Upload GAUGE driving history, activity detail reports, and timecard data for attendance matrix processing
        </div>
        <div class="upload-formats">
            Supports: .xlsx, .xls, .csv<br>
            Expected: Vehicle Driving History, Activity Detail
        </div>
        <input type="file" id="attendance-input" multiple accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileSelection(this.files, 'attendance')">
    </div>

    <!-- RAGLE Billing Upload -->
    <div class="upload-zone" onclick="triggerFileInput('billing')" ondrop="handleDrop(event, 'billing')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
        <div class="upload-icon">
            <i class="fas fa-file-invoice-dollar"></i>
        </div>
        <div class="upload-title">RAGLE Billing Data</div>
        <div class="upload-description">
            Upload RAGLE equipment billing files for revenue analytics and PM allocation processing
        </div>
        <div class="upload-formats">
            Supports: .xlsx, .xlsm, .csv<br>
            Expected: Equipment Billing Reports
        </div>
        <input type="file" id="billing-input" multiple accept=".xlsx,.xlsm,.csv" class="hidden" onchange="handleFileSelection(this.files, 'billing')">
    </div>

    <!-- Assets Time on Site -->
    <div class="upload-zone" onclick="triggerFileInput('assets')" ondrop="handleDrop(event, 'assets')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
        <div class="upload-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="upload-title">Assets Time on Site</div>
        <div class="upload-description">
            Upload assets time on site reports for job costing and equipment utilization analysis
        </div>
        <div class="upload-formats">
            Supports: .xlsx, .xls, .csv<br>
            Expected: Time on Site Reports
        </div>
        <input type="file" id="assets-input" multiple accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileSelection(this.files, 'assets')">
    </div>
</div>

<!-- Progress Container -->
<div class="progress-container" id="progress-container">
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-cog fa-spin me-2"></i>Processing Files</h5>
        </div>
        <div class="card-body">
            <div class="progress mb-3">
                <div class="progress-bar" id="upload-progress" role="progressbar" style="width: 0%"></div>
            </div>
            <div id="progress-status">Analyzing files...</div>
        </div>
    </div>
</div>

<!-- File List -->
<div class="file-list" id="file-list">
    <h5><i class="fas fa-list me-2"></i>Upload Queue</h5>
    <div id="file-items"></div>
    <div class="mt-3">
        <button class="btn btn-success" onclick="processFiles()">
            <i class="fas fa-play me-2"></i>Process All Files
        </button>
        <button class="btn btn-secondary ms-2" onclick="clearQueue()">
            <i class="fas fa-trash me-2"></i>Clear Queue
        </button>
    </div>
</div>

<!-- Recent Uploads -->
<div class="recent-uploads">
    <h5><i class="fas fa-history me-2"></i>Recent Uploads</h5>
    <div id="recent-uploads-list">
        <div class="text-muted text-center py-3">No recent uploads</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let uploadQueue = [];

function triggerFileInput(type) {
    document.getElementById(type + '-input').click();
}

function handleDragOver(event) {
    event.preventDefault();
    event.target.closest('.upload-zone').classList.add('dragover');
}

function handleDragLeave(event) {
    event.target.closest('.upload-zone').classList.remove('dragover');
}

function handleDrop(event, type) {
    event.preventDefault();
    event.target.closest('.upload-zone').classList.remove('dragover');
    
    const files = event.dataTransfer.files;
    handleFileSelection(files, type);
}

function handleFileSelection(files, type) {
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // Validate file type
        const validExtensions = ['.xlsx', '.xls', '.csv', '.xlsm'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (validExtensions.includes(fileExtension)) {
            uploadQueue.push({
                file: file,
                type: type,
                status: 'queued',
                id: Date.now() + i
            });
        } else {
            alert(`Invalid file type: ${file.name}. Please upload Excel or CSV files only.`);
        }
    }
    
    updateFileList();
    showFileList();
}

function updateFileList() {
    const fileItems = document.getElementById('file-items');
    fileItems.innerHTML = '';
    
    uploadQueue.forEach(item => {
        const fileElement = document.createElement('div');
        fileElement.className = 'file-item';
        fileElement.innerHTML = `
            <div class="file-info">
                <div class="file-name">${item.file.name}</div>
                <div class="file-size">${formatFileSize(item.file.size)} â€¢ ${item.type}</div>
            </div>
            <div class="file-status status-${item.status}">${item.status}</div>
            <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeFromQueue(${item.id})">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileItems.appendChild(fileElement);
    });
}

function showFileList() {
    if (uploadQueue.length > 0) {
        document.getElementById('file-list').style.display = 'block';
    }
}

function removeFromQueue(id) {
    uploadQueue = uploadQueue.filter(item => item.id !== id);
    updateFileList();
    
    if (uploadQueue.length === 0) {
        document.getElementById('file-list').style.display = 'none';
    }
}

function clearQueue() {
    uploadQueue = [];
    document.getElementById('file-list').style.display = 'none';
}

function processFiles() {
    if (uploadQueue.length === 0) {
        alert('No files to process');
        return;
    }
    
    showProgress();
    
    // Group files by type
    const attendanceFiles = uploadQueue.filter(item => item.type === 'attendance').map(item => item.file);
    const billingFiles = uploadQueue.filter(item => item.type === 'billing').map(item => item.file);
    const assetsFiles = uploadQueue.filter(item => item.type === 'assets').map(item => item.file);
    
    // Process each type separately
    let processedCount = 0;
    const totalFiles = uploadQueue.length;
    
    const updateProgress = (processed) => {
        const percent = (processed / totalFiles) * 100;
        document.getElementById('upload-progress').style.width = percent + '%';
        document.getElementById('progress-status').textContent = `Processed ${processed} of ${totalFiles} files`;
    };
    
    // Process attendance files
    if (attendanceFiles.length > 0) {
        uploadFiles(attendanceFiles, '/api/upload-attendance', (success) => {
            processedCount += attendanceFiles.length;
            updateProgress(processedCount);
            updateFileStatus(attendanceFiles, success ? 'success' : 'error');
            
            if (processedCount === totalFiles) {
                completeUpload();
            }
        });
    }
    
    // Process billing files
    if (billingFiles.length > 0) {
        uploadFiles(billingFiles, '/api/upload-ragle-billing', (success) => {
            processedCount += billingFiles.length;
            updateProgress(processedCount);
            updateFileStatus(billingFiles, success ? 'success' : 'error');
            
            if (processedCount === totalFiles) {
                completeUpload();
            }
        });
    }
    
    // Process assets files (same endpoint as attendance for now)
    if (assetsFiles.length > 0) {
        uploadFiles(assetsFiles, '/api/upload-attendance', (success) => {
            processedCount += assetsFiles.length;
            updateProgress(processedCount);
            updateFileStatus(assetsFiles, success ? 'success' : 'error');
            
            if (processedCount === totalFiles) {
                completeUpload();
            }
        });
    }
}

function uploadFiles(files, endpoint, callback) {
    const formData = new FormData();
    
    files.forEach(file => {
        formData.append('files', file);
    });
    
    fetch(endpoint, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Upload response:', data);
        callback(data.success);
    })
    .catch(error => {
        console.error('Upload error:', error);
        callback(false);
    });
}

function updateFileStatus(files, status) {
    files.forEach(file => {
        const queueItem = uploadQueue.find(item => item.file === file);
        if (queueItem) {
            queueItem.status = status;
        }
    });
    updateFileList();
}

function showProgress() {
    document.getElementById('progress-container').style.display = 'block';
    document.getElementById('upload-progress').style.width = '0%';
    document.getElementById('progress-status').textContent = 'Starting upload...';
}

function completeUpload() {
    setTimeout(() => {
        document.getElementById('progress-container').style.display = 'none';
        document.getElementById('file-list').style.display = 'none';
        
        // Add to recent uploads
        addToRecentUploads();
        
        // Clear queue
        uploadQueue = [];
        
        alert('All files processed successfully!');
    }, 1000);
}

function addToRecentUploads() {
    const recentList = document.getElementById('recent-uploads-list');
    const timestamp = new Date().toLocaleString();
    
    recentList.innerHTML = `
        <div class="recent-item">
            <div>
                <strong>${uploadQueue.length} files processed</strong><br>
                <small class="text-muted">${timestamp}</small>
            </div>
            <span class="badge bg-success">Success</span>
        </div>
    ` + recentList.innerHTML;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
{% endblock %}
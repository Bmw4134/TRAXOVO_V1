{% extends 'base.html' %}

{% block title %}Equipment Alerts for {{ asset.asset_identifier }}{% endblock %}

{% block content %}
<div class="container-fluid py-4"><div class="row mb-4"><div class="col-12"><div class="d-flex justify-content-between align-items-center"><h1 class="mb-0"><i class="bi bi-exclamation-diamond me-2"></i>
Alerts for {{ asset.asset_identifier }}
</h1><div><a href="{{ url_for('alerts.alerts_dashboard') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-2"></i> Back to Alerts
</a><a href="{{ url_for('asset_detail', asset_id=asset.asset_identifier) }}" class="btn btn-outline-primary ms-2"><i class="bi bi-truck me-2"></i> View Asset
</a></div></div><p class="text-muted">Viewing all alerts for {{ asset.label or asset.asset_identifier }}</p></div></div><div class="card mb-4"><div class="card-header bg-light"><h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Asset Information</h5></div><div class="card-body"><div class="row"><div class="col-md-4"><p><strong>Asset ID:</strong> {{ asset.asset_identifier }}</p><p><strong>Label:</strong> {{ asset.label or 'N/A' }}</p><p><strong>Category:</strong> {{ asset.asset_category or 'N/A' }}</p></div><div class="col-md-4"><p><strong>Location:</strong> {{ asset.location or 'Unknown' }}</p><p><strong>Status:</strong>
{% if asset.active %}
<span class="badge bg-success">Active</span>
{% else %}
<span class="badge bg-danger">Inactive</span>
{% endif %}
</p><p><strong>Last Updated:</strong> {{ asset.updated_at.strftime('%Y-%m-%d %H:%M') if asset.updated_at else 'Unknown' }}</p></div><div class="col-md-4"><p><strong>Engine Hours:</strong> {{ asset.engine_hours or 'N/A' }}</p><p><strong>Odometer:</strong> {{ asset.odometer or 'N/A' }}</p><p><strong>Last Activity:</strong> {{ asset.event_date_time.strftime('%Y-%m-%d %H:%M') if asset.event_date_time else 'Unknown' }}</p></div></div></div></div><div class="card mb-4"><div class="card-header bg-white"><div class="d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Alert Filters</h5><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="includeResolvedSwitch" {{ 'checked' if include_resolved else '' }}><label class="form-check-label" for="includeResolvedSwitch">Include Resolved</label></div></div></div><div class="card-body"><div class="row g-3"><div class="col-md-3"><select class="form-select" id="alertLevelFilter"><option value="all" selected>All Severity Levels</option><option value="critical">Critical</option><option value="warning">Warning</option><option value="info">Info</option></select></div><div class="col-md-3"><select class="form-select" id="alertTypeFilter"><option value="all" selected>All Alert Types</option><option value="inactivity">Inactivity</option><option value="high_usage">High Usage</option><option value="low_usage">Low Usage</option><option value="maintenance_hours">Maintenance (Hours)</option><option value="maintenance_days">Maintenance (Days)</option></select></div><div class="col-md-3"><select class="form-select" id="alertStatusFilter"><option value="all" selected>All Statuses</option><option value="open">Open</option><option value="acknowledged">Acknowledged</option><option value="resolved">Resolved</option></select></div><div class="col-md-3"><button type="button" class="btn btn-primary w-100" id="applyFilters"><i class="bi bi-funnel me-2"></i>Apply Filters
</button></div></div></div></div><div class="card"><div class="card-header bg-white"><h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>
Asset Alerts
<span class="badge bg-primary ms-2">{{ alerts|length }}</span></h5></div><div class="card-body"><div class="table-responsive"><table class="table table-hover" id="alertsTable"><thead><tr><th>Severity</th><th>Type</th><th>Description</th><th>Created</th><th>Status</th><th>Actions</th></tr></thead><tbody>
{% if alerts %}
{% for alert in alerts %}
<tr data-level="{{ alert.level }}" data-type="{{ alert.alert_type }}" data-status="{{ 'resolved' if alert.resolved else 'acknowledged' if alert.acknowledged else 'open' }}"><td>
{% if alert.level == 'critical' %}
<span class="badge bg-danger">Critical</span>
{% elif alert.level == 'warning' %}
<span class="badge bg-warning text-dark">Warning</span>
{% else %}
<span class="badge bg-info">Info</span>
{% endif %}
</td><td>
{% if alert.alert_type == 'inactivity' %}
<span class="badge bg-secondary">Inactivity</span>
{% elif alert.alert_type == 'high_usage' %}
<span class="badge bg-success">High Usage</span>
{% elif alert.alert_type == 'low_usage' %}
<span class="badge bg-primary">Low Usage</span>
{% elif alert.alert_type == 'maintenance_hours' %}
<span class="badge bg-info">Maintenance (Hours)</span>
{% elif alert.alert_type == 'maintenance_days' %}
<span class="badge bg-info">Maintenance (Days)</span>
{% else %}
<span class="badge bg-secondary">{{ alert.alert_type }}</span>
{% endif %}
</td><td>{{ alert.description }}</td><td>{{ alert.created_at.strftime('%Y-%m-%d %H:%M') }}</td><td>
{% if alert.resolved %}
<span class="badge bg-success">Resolved</span>
{% elif alert.acknowledged %}
<span class="badge bg-warning text-dark">Acknowledged</span>
{% else %}
<span class="badge bg-danger">Open</span>
{% endif %}
</td><td>
{% if not alert.resolved %}
<div class="btn-group btn-group-sm">
{% if not alert.acknowledged %}
<form action="{{ url_for('alerts.acknowledge_alert', alert_id=alert.id) }}" method="post" class="d-inline"><button type="submit" class="btn btn-outline-secondary"><i class="bi bi-check-lg"></i> Acknowledge
</button></form>
{% endif %}
<button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#resolveModal{{ alert.id }}"><i class="bi bi-check-circle"></i> Resolve
</button></div><div class="modal fade" id="resolveModal{{ alert.id }}" tabindex="-1" aria-labelledby="resolveModalLabel{{ alert.id }}" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="resolveModalLabel{{ alert.id }}">Resolve Alert</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><form action="{{ url_for('alerts.resolve_alert', alert_id=alert.id) }}" method="post"><div class="modal-body"><p><strong>Alert:</strong> {{ alert.description }}</p><p><strong>Created:</strong> {{ alert.created_at.strftime('%Y-%m-%d %H:%M') }}</p><div class="mb-3"><label for="resolution_notes" class="form-label">Resolution Notes</label><textarea class="form-control" id="resolution_notes" name="resolution_notes" rows="3" required></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-success">Resolve Alert</button></div></form></div></div></div>
{% else %}
<button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="popover" title="Resolution Details" data-bs-content="Resolved by: {{ alert.resolving_user.username if alert.resolving_user else 'System' }}<br>Date: {{ alert.resolved_at.strftime('%Y-%m-%d %H:%M') }}<br>Notes: {{ alert.resolution_notes or 'None provided' }}"><i class="bi bi-info-circle"></i> View Resolution
</button>
{% endif %}
</td></tr>
{% endfor %}
{% else %}
<tr><td colspan="6" class="text-center py-4"><div class="text-muted"><i class="bi bi-check-circle fs-4 d-block mb-2"></i>
No alerts found for this asset
</div></td></tr>
{% endif %}
</tbody></table></div></div></div></div><script>
document.addEventListener('DOMContentLoaded', function() {
// Initialize popovers
const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
[...popoverTriggerList].map(popoverTriggerEl => {
return new bootstrap.Popover(popoverTriggerEl, {
html: true
});
});

// Handle include resolved switch
const includeResolvedSwitch = document.getElementById('includeResolvedSwitch');
if (includeResolvedSwitch) {
includeResolvedSwitch.addEventListener('change', function() {
const currentUrl = new URL(window.location.href);
currentUrl.searchParams.set('include_resolved', this.checked ? 'true' : 'false');
window.location.href = currentUrl.toString();
});
}

// Handle alert filtering
const applyFiltersBtn = document.getElementById('applyFilters');
const levelFilter = document.getElementById('alertLevelFilter');
const typeFilter = document.getElementById('alertTypeFilter');
const statusFilter = document.getElementById('alertStatusFilter');
const alertRows = document.querySelectorAll('#alertsTable tbody tr');

if (applyFiltersBtn) {
applyFiltersBtn.addEventListener('click', function() {
const level = levelFilter.value;
const type = typeFilter.value;
const status = statusFilter.value;

alertRows.forEach(row => {
let showRow = true;

// Apply level filter
if (level !== 'all' && row.dataset.level !== level) {
showRow = false;
}

// Apply type filter
if (type !== 'all' && row.dataset.type !== type) {
showRow = false;
}

// Apply status filter
if (status !== 'all' && row.dataset.status !== status) {
showRow = false;
}

// Show/hide row
row.style.display = showRow ? '' : 'none';
});
});
}
});
</script>
{% endblock %}
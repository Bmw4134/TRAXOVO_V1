{% extends "base.html" %}

{% block title %}Assign Driver to Asset{% endblock %}

{% block content %}
<div class="container py-4"><div class="row"><div class="col-md-8 offset-md-2"><div class="card"><div class="card-header"><h4 class="mb-0">Assign Driver to Asset</h4></div><div class="card-body"><form method="POST" action="{{ url_for('asset_drivers.assign') }}"><div class="mb-3"><label for="asset_id" class="form-label">Asset</label><select class="form-select" id="asset_id" name="asset_id" required><option value="">Select Asset</option>
{% for asset in assets %}
<option value="{{ asset.id }}">{{ asset.asset_identifier }} - {{ asset.description }}</option>
{% endfor %}
</select></div><div class="mb-3"><label for="driver_id" class="form-label">Driver</label><select class="form-select" id="driver_id" name="driver_id" required><option value="">Select Driver</option>
{% for driver in drivers %}
<option value="{{ driver.id }}">{{ driver.name }} {% if driver.department %}({{ driver.department }}){% endif %}</option>
{% endfor %}
</select></div><div class="mb-3"><label for="start_date" class="form-label">Start Date</label><input type="date" class="form-control" id="start_date" name="start_date" value="{{ today }}" required></div><div class="mb-3"><label for="notes" class="form-label">Notes</label><textarea class="form-control" id="notes" name="notes" rows="3"></textarea></div><div class="d-flex justify-content-between"><a href="{{ url_for('asset_drivers.list_assignments') }}" class="btn btn-secondary">Cancel</a><button type="submit" class="btn btn-primary">Create Assignment</button></div></form></div></div></div></div></div>
{% endblock %}

{% block scripts %}
<script>
// Add filters for the asset and driver dropdowns
document.addEventListener('DOMContentLoaded', function() {
const assetSelect = document.getElementById('asset_id');
const driverSelect = document.getElementById('driver_id');

// Add filter for asset dropdown
const assetFilter = document.createElement('input');
assetFilter.className = 'form-control mb-2';
assetFilter.placeholder = 'Filter assets...';
assetFilter.addEventListener('input', function() {
const filter = this.value.toLowerCase();
for (const option of assetSelect.options) {
if (option.value === '') continue; // Skip placeholder
const text = option.text.toLowerCase();
option.style.display = text.includes(filter) ? '' : 'none';
}
});

// Add filter for driver dropdown
const driverFilter = document.createElement('input');
driverFilter.className = 'form-control mb-2';
driverFilter.placeholder = 'Filter drivers...';
driverFilter.addEventListener('input', function() {
const filter = this.value.toLowerCase();
for (const option of driverSelect.options) {
if (option.value === '') continue; // Skip placeholder
const text = option.text.toLowerCase();
option.style.display = text.includes(filter) ? '' : 'none';
}
});

// Insert filters before the selects
assetSelect.parentNode.insertBefore(assetFilter, assetSelect);
driverSelect.parentNode.insertBefore(driverFilter, driverSelect);

// Check if an asset is already assigned
assetSelect.addEventListener('change', function() {
if (this.value) {
// Check if this asset already has an assignment
fetch(`{{ url_for('asset_drivers.check_asset_assignment') }}?asset_id=${this.value}`)
.then(response => response.json())
.then(data => {
if (data.has_assignment) {
alert(`Warning: This asset is currently assigned to ${data.driver_name}. Creating a new assignment will end the current one.`);
}
})
.catch(error => console.error('Error checking asset assignment:', error));
}
});
});
</script>
{% endblock %}
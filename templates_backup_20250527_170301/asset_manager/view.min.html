{% extends "layout_unified.html" %}

{% block title %}{{ asset.name }} - Asset Details{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/">Home</a></li><li class="breadcrumb-item"><a href="{{ url_for('asset_manager.dashboard') }}">Asset Manager</a></li><li class="breadcrumb-item"><a href="{{ url_for('asset_manager.list_assets') }}">Asset List</a></li><li class="breadcrumb-item active" aria-current="page">{{ asset.name }}</li>
{% endblock %}

{% block page_title %}{{ asset.name }}{% endblock %}
{% block page_subtitle %}
{% if asset.make and asset.model %}
{{ asset.make }} {{ asset.model }} {% if asset.model_year %}({{ asset.model_year }}){% endif %}
{% elif asset.asset_number %}
Asset #{{ asset.asset_number }}
{% endif %}
{% endblock %}

{% block page_actions %}
<a href="{{ url_for('asset_manager.edit_asset', asset_id=asset.id) }}" class="btn btn-primary"><i class="bi bi-pencil-square me-2"></i> Edit Asset
</a><a href="{{ url_for('asset_manager.list_assets') }}" class="btn btn-outline-secondary ms-2"><i class="bi bi-arrow-left me-2"></i> Back to List
</a><button type="button" class="btn btn-outline-danger ms-2" data-bs-toggle="modal" data-bs-target="#deleteModal"><i class="bi bi-trash me-2"></i> Delete
</button>
{% endblock %}

{% block content %}
<div class="row"><div class="col-lg-5 mb-4"><div class="card bg-dark border-0 shadow-sm mb-4"><div class="card-header bg-dark"><h5 class="card-title mb-0"><i class="bi bi-image me-2"></i> Asset Image
</h5></div><div class="card-body p-0">
{% if asset.primary_image_url %}
<img src="{{ asset.primary_image_url }}" class="img-fluid w-100 object-fit-cover" style="max-height: 300px;" alt="{{ asset.name }}">
{% else %}
<div class="d-flex justify-content-center align-items-center bg-dark p-5" style="height: 300px;"><div class="text-center text-muted"><i class="bi bi-image fs-1 mb-3"></i><p class="mb-0">No image available</p></div></div>
{% endif %}
</div>
{% if images %}
<div class="card-footer bg-dark"><div class="d-flex overflow-auto py-2">
{% for image in images %}
<div class="me-2"><img src="{{ image.image_url }}" class="img-thumbnail" style="width: 80px; height: 60px; object-fit: cover;" alt="{{ image.caption or asset.name }}"></div>
{% endfor %}
</div></div>
{% endif %}
</div><div class="card bg-dark border-0 shadow-sm"><div class="card-header bg-dark d-flex justify-content-between align-items-center"><h5 class="card-title mb-0"><i class="bi bi-geo-alt me-2"></i> Location
</h5>
{% if asset.last_known_location %}
<span class="badge bg-info">{{ asset.last_known_location }}</span>
{% endif %}
</div><div class="card-body p-0">
{% if asset.latitude and asset.longitude %}
<div id="asset-map" style="height: 300px;"></div>
{% else %}
<div class="d-flex justify-content-center align-items-center bg-dark p-5" style="height: 300px;"><div class="text-center text-muted"><i class="bi bi-geo-alt fs-1 mb-3"></i><p class="mb-0">No location data available</p></div></div>
{% endif %}
</div>
{% if asset.address %}
<div class="card-footer bg-dark"><div class="d-flex align-items-center"><i class="bi bi-building me-2"></i><span>{{ asset.address }}</span></div></div>
{% endif %}
</div></div><div class="col-lg-7 mb-4"><div class="card bg-dark border-0 shadow-sm mb-4"><div class="card-header bg-dark"><h5 class="card-title mb-0"><i class="bi bi-info-circle me-2"></i> General Information
</h5></div><div class="card-body"><div class="row"><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Status</h6><div>
{% if asset.status == 'active' %}
<span class="badge bg-success">Active</span>
{% elif asset.status == 'maintenance' %}
<span class="badge bg-warning">In Maintenance</span>
{% elif asset.status == 'inactive' %}
<span class="badge bg-secondary">Inactive</span>
{% else %}
<span class="badge bg-info">{{ asset.status }}</span>
{% endif %}
</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Asset Number</h6><div>{{ asset.asset_number or 'N/A' }}</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Category</h6><div>{{ asset.category or 'N/A' }}</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Class</h6><div>{{ asset.class_type or 'N/A' }}</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Type</h6><div>{{ asset.type_tag or 'N/A' }}</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Ownership</h6><div>{{ asset.ownership_type or 'N/A' }}</div></div></div>

{% if asset.description %}
<div class="mt-3"><h6 class="text-muted mb-2">Description</h6><p>{{ asset.description }}</p></div>
{% endif %}
</div></div><div class="card bg-dark border-0 shadow-sm mb-4"><div class="card-header bg-dark d-flex justify-content-between align-items-center"><h5 class="card-title mb-0"><i class="bi bi-truck me-2"></i> Vehicle Information
</h5>
{% if asset.recall_alerts %}
<span class="badge bg-danger">Has Recalls</span>
{% endif %}
</div><div class="card-body"><div class="row"><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Make</h6><div>{{ asset.make or 'N/A' }}</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Model</h6><div>{{ asset.model or 'N/A' }}</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Year</h6><div>{{ asset.model_year or 'N/A' }}</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">License Plate</h6><div>{{ asset.license_plate or 'N/A' }}</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">VIN</h6><div>
{% if asset.vin %}
<span class="font-monospace">{{ asset.vin }}</span>
{% if asset.recall_alerts %}
<a href="#recallSection" class="badge bg-danger ms-2">View Recalls</a>
{% endif %}
{% else %}
N/A
{% endif %}
</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Serial Number</h6><div>{{ asset.serial_number or 'N/A' }}</div></div></div></div></div><div class="card bg-dark border-0 shadow-sm mb-4"><div class="card-header bg-dark"><h5 class="card-title mb-0"><i class="bi bi-speedometer2 me-2"></i> Metrics & Usage
</h5></div><div class="card-body"><div class="row"><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Odometer</h6><div>
{% if asset.odometer %}
{{ '{:,.1f}'.format(asset.odometer) }} miles
{% else %}
N/A
{% endif %}
</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Hour Meter</h6><div>
{% if asset.hour_meter %}
{{ '{:,.1f}'.format(asset.hour_meter) }} hours
{% else %}
N/A
{% endif %}
</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Current Job</h6><div>
{% if asset.job_number or asset.job_name %}
{% if asset.job_number %}{{ asset.job_number }}{% endif %}
{% if asset.job_name %} - {{ asset.job_name }}{% endif %}
{% else %}
N/A
{% endif %}
</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Billing Code</h6><div>{{ asset.billing_code or 'N/A' }}</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Last Service</h6><div>
{% if asset.last_service_date %}
{{ asset.last_service_date.strftime('%m/%d/%Y') }}
{% else %}
N/A
{% endif %}
</div></div><div class="col-md-6 mb-3"><h6 class="text-muted mb-2">Last Updated</h6><div>
{% if asset.last_updated %}
{{ asset.last_updated.strftime('%m/%d/%Y %H:%M') }}
{% else %}
N/A
{% endif %}
</div></div></div></div></div><div class="card bg-dark border-0 shadow-sm mb-4"><div class="card-header bg-dark d-flex justify-content-between align-items-center"><h5 class="card-title mb-0"><i class="bi bi-wrench me-2"></i> Service History
</h5><button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal"><i class="bi bi-plus-lg me-1"></i> Add Record
</button></div><div class="card-body p-0">
{% if service_records %}
<div class="table-responsive"><table class="table table-dark table-hover mb-0"><thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Performed By</th><th class="text-end">Cost</th></tr></thead><tbody>
{% for record in service_records %}
<tr><td>{{ record.service_date.strftime('%m/%d/%Y') }}</td><td>
{% if record.service_type == 'preventative' %}
<span class="badge bg-info">Preventative</span>
{% elif record.service_type == 'repair' %}
<span class="badge bg-warning">Repair</span>
{% else %}
<span class="badge bg-secondary">{{ record.service_type }}</span>
{% endif %}
</td><td>{{ record.description }}</td><td>{{ record.performed_by or 'Unknown' }}</td><td class="text-end">
{% if record.total_cost %}
${{ '{:,.2f}'.format(record.total_cost) }}
{% else %}
-
{% endif %}
</td></tr>
{% endfor %}
</tbody></table></div>
{% else %}
<div class="text-center py-5 text-muted"><i class="bi bi-clipboard-x fs-1 mb-3"></i><p class="mb-0">No service records found.</p></div>
{% endif %}
</div></div>


{% if asset.recall_alerts %}
<div class="card bg-dark border-0 shadow-sm border-danger mb-4" id="recallSection"><div class="card-header bg-dark text-danger"><h5 class="card-title mb-0"><i class="bi bi-exclamation-triangle me-2"></i> Recall Alerts
</h5></div><div class="card-body"><div class="alert alert-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Warning:</strong> This vehicle has open safety recalls that should be addressed immediately.
</div><div class="list-group list-group-flush bg-dark mt-3">
{% for recall in asset.recall_alerts %}
<div class="list-group-item bg-dark border-danger border-opacity-25"><h6 class="mb-1">{{ recall.Component }}</h6><p class="mb-1 text-danger">{{ recall.Summary }}</p><small class="text-muted">Campaign: {{ recall.NHTSACampaignNumber }}</small></div>
{% endfor %}
</div></div></div>
{% endif %}


{% if documents %}
<div class="card bg-dark border-0 shadow-sm mb-4"><div class="card-header bg-dark"><h5 class="card-title mb-0"><i class="bi bi-file-earmark me-2"></i> Documents
</h5></div><div class="card-body"><div class="list-group list-group-flush bg-dark">
{% for document in documents %}
<a href="{{ document.document_url }}" class="list-group-item list-group-item-action bg-dark" target="_blank"><div class="d-flex align-items-center">
{% if document.document_type == 'manual' %}
<i class="bi bi-book me-3 fs-4"></i>
{% elif document.document_type == 'service_record' %}
<i class="bi bi-clipboard-check me-3 fs-4"></i>
{% elif document.document_type == 'registration' %}
<i class="bi bi-card-list me-3 fs-4"></i>
{% else %}
<i class="bi bi-file-earmark-text me-3 fs-4"></i>
{% endif %}
<div><h6 class="mb-0">{{ document.title }}</h6><small class="text-muted">{{ document.description }}</small></div></div></a>
{% endfor %}
</div></div></div>
{% endif %}
</div></div><div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content bg-dark"><div class="modal-header"><h5 class="modal-title">Confirm Deletion</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><p>Are you sure you want to delete <strong>{{ asset.name }}</strong>?</p><p class="text-danger">This action cannot be undone.</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><form action="{{ url_for('asset_manager.delete_asset', asset_id=asset.id) }}" method="post"><button type="submit" class="btn btn-danger">Delete Asset</button></form></div></div></div></div><div class="modal fade" id="addServiceModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content bg-dark"><div class="modal-header"><h5 class="modal-title">Add Service Record</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><form action="{{ url_for('asset_manager.add_service_record', asset_id=asset.id) }}" method="post"><div class="modal-body"><div class="row"><div class="col-md-6 mb-3"><label for="service_date" class="form-label">Service Date</label><input type="date" class="form-control" id="service_date" name="service_date" required></div><div class="col-md-6 mb-3"><label for="service_type" class="form-label">Service Type</label><select class="form-select" id="service_type" name="service_type" required><option value="">Select a type...</option><option value="preventative">Preventative Maintenance</option><option value="repair">Repair</option><option value="inspection">Inspection</option><option value="other">Other</option></select></div></div><div class="mb-3"><label for="description" class="form-label">Description</label><textarea class="form-control" id="description" name="description" rows="3" required></textarea></div><div class="row"><div class="col-md-6 mb-3"><label for="performed_by" class="form-label">Performed By</label><input type="text" class="form-control" id="performed_by" name="performed_by"></div><div class="col-md-6 mb-3"><label for="odometer" class="form-label">Odometer Reading</label><input type="number" class="form-control" id="odometer" name="odometer" min="0" step="0.1"></div></div><div class="row"><div class="col-md-6 mb-3"><label for="service_cost" class="form-label">Service Cost</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="service_cost" name="service_cost" min="0" step="0.01"></div></div><div class="col-md-6 mb-3"><label for="parts_cost" class="form-label">Parts Cost</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="parts_cost" name="parts_cost" min="0" step="0.01"></div></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Add Record</button></div></form></div></div></div>
{% endblock %}

{% block scripts %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script>
document.addEventListener('DOMContentLoaded', function() {
{% if asset.latitude and asset.longitude %}
// Initialize map
const map = L.map('asset-map').setView([{{ asset.latitude }}, {{ asset.longitude }}], 14);

// Add tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
maxZoom: 19,
attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
}).addTo(map);

// Add marker
const marker = L.marker([{{ asset.latitude }}, {{ asset.longitude }}])
.addTo(map)
.bindPopup(`
<strong>{{ asset.name }}</strong><br>
{% if asset.last_known_location %}{{ asset.last_known_location }}<br>{% endif %}
{% if asset.make and asset.model %}{{ asset.make }} {{ asset.model }}{% endif %}
`);

// Open popup
marker.openPopup();
{% endif %}
});
</script>
{% endblock %}
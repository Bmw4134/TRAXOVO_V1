{% extends 'layout.html' %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css"><link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" /><style>
.health-card {
transition: all 0.3s ease;
border-radius: 0.5rem;
border: none;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.equipment-map {
height: 500px;
width: 100%;
border-radius: 0.5rem;
}

.health-status {
padding: 0.5rem 1rem;
border-radius: 30px;
font-weight: 500;
display: inline-block;
}

.health-status-good {
background-color: #28a745;
color: white;
}

.health-status-fair {
background-color: #fd7e14;
color: white;
}

.health-status-poor {
background-color: #dc3545;
color: white;
}

.health-status-count {
font-size: 2.5rem;
font-weight: 700;
}

.health-gauge {
width: 100%;
height: 8px;
background-color: #e9ecef;
border-radius: 4px;
margin-top: 5px;
margin-bottom: 15px;
overflow: hidden;
}

.health-gauge-fill {
height: 100%;
border-radius: 4px;
}

.confidence-badge {
font-size: 0.7rem;
padding: 0.2rem 0.5rem;
border-radius: 20px;
background-color: rgba(0, 0, 0, 0.2);
color: white;
margin-left: 0.5rem;
}

.asset-detail-row {
border-left: 3px solid transparent;
transition: all 0.2s ease;
}

.asset-detail-row:hover {
background-color: rgba(0, 0, 0, 0.05);
border-left-color: var(--bs-primary);
}

.maintenance-countdown {
font-weight: 700;
padding: 0.25rem 0.75rem;
border-radius: 20px;
}

.maintenance-urgent {
background-color: #dc3545;
color: white;
}

.maintenance-warning {
background-color: #fd7e14;
color: white;
}

.maintenance-good {
background-color: #28a745;
color: white;
}

.ai-banner {
background: linear-gradient(135deg, #6c5ce7, #0984e3);
padding: 1rem;
border-radius: 0.5rem;
margin-bottom: 1.5rem;
color: white;
}

.prediction-controls {
position: absolute;
top: 10px;
right: 10px;
z-index: 1000;
background: rgba(33, 37, 41, 0.8);
padding: 10px;
border-radius: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4"><div class="ai-banner d-flex justify-content-between align-items-center"><div><h4 class="mb-1">AI-Powered Equipment Health Prediction</h4><p class="mb-0">Machine learning models analyze your equipment data to predict maintenance needs before problems occur.</p></div><div><button id="train-model-btn" class="btn btn-light"><i class="bi bi-cpu"></i> Retrain Model
</button></div></div><div class="row mb-4"><div class="col-md-4"><div class="card bg-dark health-card"><div class="card-body text-center"><h5 class="card-title mb-3">Good Health</h5><div class="health-status-count text-success" id="good-health-count">--</div><div class="text-muted">Assets in Good Condition</div><div class="health-gauge mt-3"><div class="health-gauge-fill bg-success" id="good-health-gauge" style="width: 0%"></div></div></div></div></div><div class="col-md-4"><div class="card bg-dark health-card"><div class="card-body text-center"><h5 class="card-title mb-3">Fair Health</h5><div class="health-status-count text-warning" id="fair-health-count">--</div><div class="text-muted">Assets Needing Attention</div><div class="health-gauge mt-3"><div class="health-gauge-fill bg-warning" id="fair-health-gauge" style="width: 0%"></div></div></div></div></div><div class="col-md-4"><div class="card bg-dark health-card"><div class="card-body text-center"><h5 class="card-title mb-3">Poor Health</h5><div class="health-status-count text-danger" id="poor-health-count">--</div><div class="text-muted">Assets Requiring Urgent Service</div><div class="health-gauge mt-3"><div class="health-gauge-fill bg-danger" id="poor-health-gauge" style="width: 0%"></div></div></div></div></div></div><div class="row"><div class="col-lg-8"><div class="card bg-dark mb-4 position-relative"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0">Equipment Health Map</h5><span class="text-muted" id="map-last-update"></span></div><div class="card-body"><div id="health-map" class="equipment-map"></div></div><div class="prediction-controls"><div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="show-good-health" checked><label class="form-check-label" for="show-good-health">Good Health</label></div><div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="show-fair-health" checked><label class="form-check-label" for="show-fair-health">Fair Health</label></div><div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="show-poor-health" checked><label class="form-check-label" for="show-poor-health">Poor Health</label></div></div></div><div class="card bg-dark"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0">Maintenance Forecast</h5><div class="dropdown"><button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="forecastDropdown" data-bs-toggle="dropdown">
Next 30 Days
</button><ul class="dropdown-menu dropdown-menu-end" aria-labelledby="forecastDropdown"><li><a class="dropdown-item active" href="#" data-period="30">Next 30 Days</a></li><li><a class="dropdown-item" href="#" data-period="60">Next 60 Days</a></li><li><a class="dropdown-item" href="#" data-period="90">Next 90 Days</a></li></ul></div></div><div class="card-body"><canvas id="maintenance-forecast-chart" height="250"></canvas></div></div></div><div class="col-lg-4"><div class="card bg-dark mb-4"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="bi bi-exclamation-triangle text-danger me-2"></i>
Urgent Maintenance
</h5><span class="badge bg-danger" id="urgent-maintenance-count">0</span></div><div class="card-body p-0"><div class="list-group list-group-flush" id="urgent-maintenance-list"><div class="list-group-item list-group-item-action text-center py-4"><div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div>
Loading maintenance predictions...
</div></div></div></div><div class="card bg-dark mb-4"><div class="card-header"><h5 class="mb-0">Health Factors</h5></div><div class="card-body"><div class="mb-3"><h6 class="text-secondary mb-2">Engine Hours</h6><div class="progress bg-dark mb-2"><div class="progress-bar bg-info" id="engine-hours-factor" role="progressbar" style="width: 75%"></div></div><small class="text-muted" id="engine-hours-impact">75% impact on health predictions</small></div><div class="mb-3"><h6 class="text-secondary mb-2">Oil & Fluid Levels</h6><div class="progress bg-dark mb-2"><div class="progress-bar bg-info" id="fluids-factor" role="progressbar" style="width: 60%"></div></div><small class="text-muted" id="fluids-impact">60% impact on health predictions</small></div><div class="mb-3"><h6 class="text-secondary mb-2">Service History</h6><div class="progress bg-dark mb-2"><div class="progress-bar bg-info" id="service-factor" role="progressbar" style="width: 85%"></div></div><small class="text-muted" id="service-impact">85% impact on health predictions</small></div><div><h6 class="text-secondary mb-2">Operating Environment</h6><div class="progress bg-dark mb-2"><div class="progress-bar bg-info" id="environment-factor" role="progressbar" style="width: 40%"></div></div><small class="text-muted" id="environment-impact">40% impact on health predictions</small></div></div></div><div class="card bg-dark mb-4"><div class="card-header"><h5 class="mb-0">Model Information</h5></div><div class="card-body"><div class="mb-3"><div class="text-muted mb-1">Health Prediction Model</div><div class="fw-bold">
{% if model_info.health_model_exists %}
<span class="text-success"><i class="bi bi-check-circle"></i> Active</span>
{% else %}
<span class="text-danger"><i class="bi bi-x-circle"></i> Not Available</span>
{% endif %}
</div></div><div class="mb-3"><div class="text-muted mb-1">Maintenance Prediction Model</div><div class="fw-bold">
{% if model_info.maintenance_model_exists %}
<span class="text-success"><i class="bi bi-check-circle"></i> Active</span>
{% else %}
<span class="text-danger"><i class="bi bi-x-circle"></i> Not Available</span>
{% endif %}
</div></div><div><div class="text-muted mb-1">Last Training Date</div><div class="fw-bold">
{% if model_info.last_training_date %}
{{ model_info.last_training_date.strftime('%Y-%m-%d %H:%M:%S') }}
{% else %}
Never
{% endif %}
</div></div></div></div></div></div></div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script><script>
document.addEventListener('DOMContentLoaded', function() {
// Initialize the map
const map = L.map('health-map').setView([32.7767, -96.7970], 10); // Default to Dallas

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Markers and popups storage
const markers = {};

// Health counts
let goodHealthCount = 0;
let fairHealthCount = 0;
let poorHealthCount = 0;
let urgentMaintenanceCount = 0;

// Health predictions by date (for the forecast chart)
const maintenanceDates = {};

// Function to load asset data with health predictions
function loadHealthData() {
fetch('{{ url_for("asset_tracking.api_assets") }}')
.then(response => response.json())
.then(assets => {
// Reset counters
goodHealthCount = 0;
fairHealthCount = 0;
poorHealthCount = 0;
urgentMaintenanceCount = 0;

// Clear existing markers
Object.values(markers).forEach(marker => {
map.removeLayer(marker);
});

// Clear maintenance forecast data
for (const key in maintenanceDates) {
delete maintenanceDates[key];
}

// Clear urgent maintenance list
const urgentList = document.getElementById('urgent-maintenance-list');
urgentList.innerHTML = '';

// Check if we have any predictions
const hasPredictions = assets.some(asset => asset.predictedHealthStatus);

if (!hasPredictions) {
// Show message about training the model
urgentList.innerHTML = `
<div class="list-group-item list-group-item-action text-center py-4"><i class="bi bi-info-circle text-info me-2"></i>
No health predictions available yet. Click "Retrain Model" to generate predictions.
</div>
`;

// Update counters with placeholder data
document.getElementById('good-health-count').textContent = '--';
document.getElementById('fair-health-count').textContent = '--';
document.getElementById('poor-health-count').textContent = '--';

// Update gauges
document.getElementById('good-health-gauge').style.width = '0%';
document.getElementById('fair-health-gauge').style.width = '0%';
document.getElementById('poor-health-gauge').style.width = '0%';

// Update urgent count
document.getElementById('urgent-maintenance-count').textContent = 0;

// Update map timestamp
document.getElementById('map-last-update').textContent = `Updated: ${new Date().toLocaleTimeString()}`;

return;
}

// Process each asset with health prediction
assets.forEach(asset => {
// Count by health status
if (asset.predictedHealthStatus === 'Good') {
goodHealthCount++;
} else if (asset.predictedHealthStatus === 'Fair') {
fairHealthCount++;
} else if (asset.predictedHealthStatus === 'Poor') {
poorHealthCount++;
}

// Track urgent maintenance (less than 7 days)
if (asset.predictedDaysUntilMaintenance !== undefined && asset.predictedDaysUntilMaintenance <= 7) {
urgentMaintenanceCount++;

// Add to urgent maintenance list
if (urgentList.children.length < 5) {
const listItem = document.createElement('a');
listItem.href = `{{ url_for('asset_tracking.asset_detail', asset_id='') }}/${asset.id || asset.assetId}`;
listItem.className = 'list-group-item list-group-item-action';

const daysText = asset.predictedDaysUntilMaintenance <= 0 ?
'Maintenance overdue' :
`${asset.predictedDaysUntilMaintenance} day${asset.predictedDaysUntilMaintenance !== 1 ? 's' : ''} until maintenance`;

const statusClass = asset.predictedDaysUntilMaintenance <= 0 ?
'maintenance-urgent' :
asset.predictedDaysUntilMaintenance <= 3 ? 'maintenance-warning' : 'maintenance-good';

listItem.innerHTML = `
<div class="d-flex justify-content-between align-items-center"><div><div class="fw-bold">${asset.name || 'Unnamed Asset'}</div><div class="text-muted small">
${asset.assetType || asset.type || asset.category || 'Unknown'} |
Health: <span class="text-${asset.predictedHealthStatus === 'Good' ? 'success' : asset.predictedHealthStatus === 'Fair' ? 'warning' : 'danger'}">
${asset.predictedHealthStatus}
</span></div></div><span class="maintenance-countdown ${statusClass}">
${daysText}
</span></div>
`;

urgentList.appendChild(listItem);
}
}

// Track maintenance dates for forecast chart
if (asset.predictedDaysUntilMaintenance !== undefined) {
const maintenanceDay = Math.max(0, Math.round(asset.predictedDaysUntilMaintenance));

// Group by week for the chart
const weekIndex = Math.floor(maintenanceDay / 7);
const weekLabel = weekIndex === 0 ? 'This Week' :
weekIndex === 1 ? 'Next Week' :
weekIndex === 2 ? 'In 2 Weeks' :
weekIndex === 3 ? 'In 3 Weeks' :
`In ${weekIndex} Weeks`;

if (!maintenanceDates[weekLabel]) {
maintenanceDates[weekLabel] = 0;
}
maintenanceDates[weekLabel]++;
}

// Add to map
const lat = asset.latitude || asset.lat;
const lng = asset.longitude || asset.lng;

if (lat && lng) {
const assetId = asset.id || asset.assetId;

// Create marker icon based on health status
let markerColor;
if (asset.predictedHealthStatus === 'Good') {
markerColor = '#28a745';  // green
} else if (asset.predictedHealthStatus === 'Fair') {
markerColor = '#fd7e14';  // orange
} else if (asset.predictedHealthStatus === 'Poor') {
markerColor = '#dc3545';  // red
} else {
markerColor = '#6c757d';  // gray
}

// Create marker with custom icon
const markerIcon = L.divIcon({
html: `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center;"><i class="bi bi-tools" style="color: white; font-size: 10px;"></i></div>`,
className: 'health-marker',
iconSize: [20, 20]
});

markers[assetId] = L.marker([lat, lng], {
icon: markerIcon,
assetId: assetId,
healthStatus: asset.predictedHealthStatus || 'Unknown'
}).addTo(map);

// Create popup content with health info
const daysText = asset.predictedDaysUntilMaintenance !== undefined ?
(asset.predictedDaysUntilMaintenance <= 0 ?
'Maintenance overdue' :
`${asset.predictedDaysUntilMaintenance} day${asset.predictedDaysUntilMaintenance !== 1 ? 's' : ''} until maintenance`) :
'No maintenance data';

markers[assetId].bindPopup(`
<div><strong>${asset.name || 'Unnamed Asset'}</strong><br><b>Type:</b> ${asset.assetType || asset.type || asset.category || 'Unknown'}<br><b>Health:</b><span class="text-${asset.predictedHealthStatus === 'Good' ? 'success' : asset.predictedHealthStatus === 'Fair' ? 'warning' : 'danger'}">
${asset.predictedHealthStatus || 'Unknown'}
</span><span class="small text-muted">(${asset.healthPredictionConfidence || 0}% confidence)</span><br><b>Next Service:</b> ${asset.predictedMaintenanceDate || 'Unknown'}<br><b>Status:</b> ${daysText}<br><a href="{{ url_for('asset_tracking.asset_detail', asset_id='') }}/${assetId}" class="btn btn-sm btn-info mt-2">View Details</a></div>
`);
}
});

// Update counters
const totalAssets = goodHealthCount + fairHealthCount + poorHealthCount;
document.getElementById('good-health-count').textContent = goodHealthCount;
document.getElementById('fair-health-count').textContent = fairHealthCount;
document.getElementById('poor-health-count').textContent = poorHealthCount;

// Update gauges
document.getElementById('good-health-gauge').style.width = totalAssets > 0 ? `${(goodHealthCount / totalAssets) * 100}%` : '0%';
document.getElementById('fair-health-gauge').style.width = totalAssets > 0 ? `${(fairHealthCount / totalAssets) * 100}%` : '0%';
document.getElementById('poor-health-gauge').style.width = totalAssets > 0 ? `${(poorHealthCount / totalAssets) * 100}%` : '0%';

// Update urgent count
document.getElementById('urgent-maintenance-count').textContent = urgentMaintenanceCount;

// If no urgent maintenance items
if (urgentMaintenanceCount === 0) {
urgentList.innerHTML = `
<div class="list-group-item list-group-item-action text-center py-4"><i class="bi bi-check-circle text-success me-2"></i>
No urgent maintenance needed at this time
</div>
`;
}

// Update map timestamp
document.getElementById('map-last-update').textContent = `Updated: ${new Date().toLocaleTimeString()}`;

// Create or update maintenance forecast chart
updateMaintenanceForecast();

// Fit map to markers
if (Object.keys(markers).length > 0) {
const markerBounds = L.featureGroup(Object.values(markers)).getBounds();
map.fitBounds(markerBounds);
}
})
.catch(error => {
console.error('Error loading health data:', error);
});
}

// Update maintenance forecast chart
function updateMaintenanceForecast() {
const ctx = document.getElementById('maintenance-forecast-chart').getContext('2d');

// Sort dates for proper ordering
const sortedLabels = [
'This Week',
'Next Week',
'In 2 Weeks',
'In 3 Weeks',
'In 4 Weeks',
'In 5 Weeks',
'In 6 Weeks',
'In 7 Weeks',
'In 8 Weeks',
'In 9 Weeks',
'In 10 Weeks',
'In 11 Weeks',
'In 12 Weeks'
].filter(label => maintenanceDates[label] !== undefined);

// Generate data from sorted labels
const data = sortedLabels.map(label => maintenanceDates[label] || 0);

// Create chart configuration
const config = {
type: 'bar',
data: {
labels: sortedLabels,
datasets: [{
label: 'Equipment Needing Maintenance',
data: data,
backgroundColor: '#3498db',
borderColor: '#2980b9',
borderWidth: 1
}]
},
options: {
responsive: true,
scales: {
y: {
beginAtZero: true,
title: {
display: true,
text: 'Number of Assets'
},
ticks: {
precision: 0
}
}
}
}
};

// Create or update chart
if (window.maintenanceChart) {
window.maintenanceChart.data = config.data;
window.maintenanceChart.update();
} else {
window.maintenanceChart = new Chart(ctx, config);
}
}

// Handle map filters
document.getElementById('show-good-health').addEventListener('change', function() {
filterMapMarkers();
});

document.getElementById('show-fair-health').addEventListener('change', function() {
filterMapMarkers();
});

document.getElementById('show-poor-health').addEventListener('change', function() {
filterMapMarkers();
});

function filterMapMarkers() {
const showGood = document.getElementById('show-good-health').checked;
const showFair = document.getElementById('show-fair-health').checked;
const showPoor = document.getElementById('show-poor-health').checked;

Object.values(markers).forEach(marker => {
const healthStatus = marker.options.healthStatus;

if ((healthStatus === 'Good' && showGood) ||
(healthStatus === 'Fair' && showFair) ||
(healthStatus === 'Poor' && showPoor)) {
if (!map.hasLayer(marker)) {
map.addLayer(marker);
}
} else {
if (map.hasLayer(marker)) {
map.removeLayer(marker);
}
}
});
}

// Handle model training
document.getElementById('train-model-btn').addEventListener('click', function() {
this.disabled = true;
this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Training...';

fetch('/asset-tracking/train-model', {
method: 'POST'
})
.then(response => response.json())
.then(data => {
if (data.success) {
// Show success message
alert('Model trained successfully!');
// Reload health data
loadHealthData();
// Reload page to update model info
window.location.reload();
} else {
alert('Error training model: ' + data.message);
}
})
.catch(error => {
console.error('Error training model:', error);
alert('Error training model. Please try again.');
})
.finally(() => {
this.disabled = false;
this.innerHTML = '<i class="bi bi-cpu"></i> Retrain Model';
});
});

// Initial load
loadHealthData();

// Refresh every 60 seconds
setInterval(loadHealthData, 60000);
});
</script>
{% endblock %}
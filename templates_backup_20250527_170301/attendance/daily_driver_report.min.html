{% extends "base.html" %}

{% block title %}Daily Driver Report{% endblock %}

{% block head %}
<link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"><style>
.sidebar {
position: fixed;
top: 0;
bottom: 0;
left: 0;
z-index: 100;
padding: 48px 0 0;
box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
transition: all 0.3s;
}

.sidebar-sticky {
height: calc(100vh - 48px);
overflow-x: hidden;
overflow-y: auto;
}

.sidebar .nav-link {
font-weight: 500;
color: var(--bs-light);
}

.sidebar .nav-link.active {
color: var(--bs-primary);
}

.sidebar-heading {
font-size: .75rem;
text-transform: uppercase;
}

.navbar-brand {
padding-top: .75rem;
padding-bottom: .75rem;
background-color: rgba(0, 0, 0, .25);
box-shadow: inset -1px 0 0 rgba(0, 0, 0, .25);
}

.navbar .navbar-toggler {
top: .25rem;
right: 1rem;
}

.navbar .form-control {
padding: .75rem 1rem;
}

main {
padding-top: 1.5rem;
}

.sidebar-collapsed {
margin-left: -250px;
}

#content {
width: 100%;
transition: all 0.3s;
}

.content-expanded {
margin-left: 0;
}

.status-badge {
font-size: 0.9rem;
padding: 0.35rem 0.65rem;
}

.status-on_time {
background-color: var(--bs-success);
}

.status-late {
background-color: var(--bs-danger);
}

.status-early_end {
background-color: var(--bs-warning);
color: var(--bs-dark);
}

.status-not_on_job {
background-color: var(--bs-secondary);
}

.metric-card {
border-radius: 0.5rem;
box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
transition: transform 0.3s;
}

.metric-card:hover {
transform: translateY(-5px);
}

.metric-card .card-body {
padding: 1.5rem;
}

.metric-card .metric-value {
font-size: 2.5rem;
font-weight: 700;
}

.metric-card .metric-label {
font-size: 1rem;
font-weight: 500;
text-transform: uppercase;
}

.table-responsive {
max-height: 600px;
}

@media (max-width: 767.98px) {
.sidebar {
position: static;
height: auto;
padding-top: 0;
}

.sidebar-sticky {
height: auto;
}

main {
padding-top: 0.5rem;
}
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid"><div class="row"><nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar"><div class="position-sticky sidebar-sticky pt-3"><h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted"><span>TRAXORA</span><a class="link-secondary" href="#" id="sidebarToggle" aria-label="Toggle sidebar"><i class="bi bi-layout-sidebar-inset"></i></a></h6><ul class="nav flex-column"><li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}"><i class="bi bi-speedometer2 me-2"></i>
Dashboard
</a></li><li class="nav-item"><a class="nav-link active" href="{{ url_for('attendance.daily_driver_report') }}"><i class="bi bi-calendar-check me-2"></i>
Daily Driver Report
</a></li><li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-bar-chart me-2"></i>
Equipment Billing
</a></li><li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-geo-alt me-2"></i>
Work Zone GPS
</a></li></ul><h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted"><span>ADMIN</span></h6><ul class="nav flex-column"><li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-gear me-2"></i>
Settings
</a></li><li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-cloud-upload me-2"></i>
Upload Data
</a></li><li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-shield-check me-2"></i>
Kaizen Admin
</a></li></ul></div></nav><main id="content" class="col-md-9 ms-sm-auto col-lg-10 px-md-4"><div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"><h1 class="h2">Daily Driver Report</h1><div class="btn-toolbar mb-2 mb-md-0"><div class="btn-group me-2"><a href="{{ url_for('attendance.download_report', date=selected_date) }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-download me-1"></i> Download Excel
</a><button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#processReportModal"><i class="bi bi-arrow-repeat me-1"></i> Process Report
</button></div></div></div><div class="row mb-4"><div class="col-md-6"><div class="card"><div class="card-body"><h5 class="card-title">Select Date</h5><form method="get" action="{{ url_for('attendance.daily_driver_report') }}" class="row g-3"><div class="col-md-8"><select name="date" class="form-select" id="dateSelect" onchange="this.form.submit()">
{% for date in available_dates %}
<option value="{{ date }}" {% if date == selected_date %}selected{% endif %}>
{{ date }}
</option>
{% endfor %}
</select></div><div class="col-md-4"><button type="submit" class="btn btn-primary w-100">View Report</button></div></form></div></div></div><div class="col-md-6"><div class="card"><div class="card-body"><h5 class="card-title">Search & Filter</h5><form method="get" action="{{ url_for('attendance.daily_driver_report') }}" class="row g-3"><input type="hidden" name="date" value="{{ selected_date }}"><div class="col-md-5"><input type="text" class="form-control" name="search" placeholder="Driver name..." value="{{ search_query }}"></div><div class="col-md-4"><select name="status" class="form-select"><option value="" {% if status_filter == '' %}selected{% endif %}>All Status</option><option value="on_time" {% if status_filter == 'on_time' %}selected{% endif %}>On Time</option><option value="late" {% if status_filter == 'late' %}selected{% endif %}>Late</option><option value="early_end" {% if status_filter == 'early_end' %}selected{% endif %}>Early End</option><option value="not_on_job" {% if status_filter == 'not_on_job' %}selected{% endif %}>Not On Job</option></select></div><div class="col-md-3"><button type="submit" class="btn btn-secondary w-100">Filter</button></div></form></div></div></div></div><div class="row mb-4"><div class="col-xl-3 col-md-6 mb-4"><div class="card metric-card border-left-success shadow h-100 py-2 bg-success bg-opacity-10"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-success text-uppercase mb-1">On Time</div><div class="h5 mb-0 font-weight-bold">{{ stats.on_time }} Drivers</div><div class="text-xs font-weight-bold">{{ stats.on_time_percentage }}% of Total</div></div><div class="col-auto"><i class="bi bi-check-circle text-success fa-2x"></i></div></div></div></div></div><div class="col-xl-3 col-md-6 mb-4"><div class="card metric-card border-left-danger shadow h-100 py-2 bg-danger bg-opacity-10"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Late</div><div class="h5 mb-0 font-weight-bold">{{ stats.late }} Drivers</div><div class="text-xs font-weight-bold">{{ stats.late_percentage }}% of Total</div></div><div class="col-auto"><i class="bi bi-clock-history text-danger fa-2x"></i></div></div></div></div></div><div class="col-xl-3 col-md-6 mb-4"><div class="card metric-card border-left-warning shadow h-100 py-2 bg-warning bg-opacity-10"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Early End</div><div class="h5 mb-0 font-weight-bold">{{ stats.early_end }} Drivers</div><div class="text-xs font-weight-bold">{{ stats.early_end_percentage }}% of Total</div></div><div class="col-auto"><i class="bi bi-hourglass-split text-warning fa-2x"></i></div></div></div></div></div><div class="col-xl-3 col-md-6 mb-4"><div class="card metric-card border-left-secondary shadow h-100 py-2 bg-secondary bg-opacity-10"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">Not On Job</div><div class="h5 mb-0 font-weight-bold">{{ stats.not_on_job }} Drivers</div><div class="text-xs font-weight-bold">{{ stats.not_on_job_percentage }}% of Total</div></div><div class="col-auto"><i class="bi bi-x-circle text-secondary fa-2x"></i></div></div></div></div></div></div><div class="card shadow mb-4"><div class="card-header py-3 d-flex flex-row align-items-center justify-content-between"><h6 class="m-0 font-weight-bold">Driver Attendance for {{ selected_date }}</h6><div class="dropdown no-arrow"><button class="btn btn-link btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></button><ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton"><li><a class="dropdown-item" href="#" id="refreshTable">Refresh Table</a></li><li><a class="dropdown-item" href="#" id="exportCsv">Export CSV</a></li><li><hr class="dropdown-divider"></li><li><a class="dropdown-item" href="{{ url_for('attendance.download_report', date=selected_date) }}">Download Excel</a></li></ul></div></div><div class="card-body"><div class="table-responsive"><table class="table table-hover" id="driverTable"><thead><tr><th scope="col">#</th><th scope="col">Driver</th><th scope="col">Status</th><th scope="col">Job Site</th><th scope="col">First Seen</th><th scope="col">Last Seen</th><th scope="col">Hours</th><th scope="col">Source</th></tr></thead><tbody>
{% if report_data %}
{% for record in report_data %}
<tr><td>{{ loop.index }}</td><td>{{ record.Driver }}</td><td><span class="badge status-badge status-{{ record.Status|lower }}">
{{ record.Status|replace('_', ' ')|title }}
</span></td><td>{{ record.JobSite }}</td><td>{{ record.FirstSeen }}</td><td>{{ record.LastSeen }}</td><td>{{ record.Hours }}</td><td>{{ record.Source }}</td></tr>
{% endfor %}
{% else %}
<tr><td colspan="8" class="text-center">No data available for this date.</td></tr>
{% endif %}
</tbody></table></div>


{% if report_data and report_data|length > 50 %}
<nav aria-label="Driver attendance pagination" class="mt-4"><ul class="pagination justify-content-center"><li class="page-item disabled"><a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a></li><li class="page-item active"><a class="page-link" href="#">1</a></li><li class="page-item"><a class="page-link" href="#">2</a></li><li class="page-item"><a class="page-link" href="#">3</a></li><li class="page-item"><a class="page-link" href="#">Next</a></li></ul></nav>
{% endif %}
</div></div></main></div></div><div class="modal fade" id="processReportModal" tabindex="-1" aria-labelledby="processReportModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="processReportModalLabel">Process/Regenerate Report</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><form method="post" action="{{ url_for('attendance.process_report') }}"><div class="modal-body"><div class="mb-3"><label for="processDate" class="form-label">Date</label><input type="date" class="form-control" id="processDate" name="date" value="{{ selected_date }}"></div><div class="alert alert-info"><i class="bi bi-info-circle-fill me-2"></i>
This will process the raw data and generate a new report for the selected date.
</div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Process Report</button></div></form></div></div></div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
// Sidebar toggle
const sidebar = document.getElementById('sidebar');
const content = document.getElementById('content');
const sidebarToggle = document.getElementById('sidebarToggle');

sidebarToggle.addEventListener('click', function(e) {
e.preventDefault();
sidebar.classList.toggle('sidebar-collapsed');
content.classList.toggle('content-expanded');
});

// Responsive behavior for sidebar
function checkWidth() {
if (window.innerWidth < 768) {
sidebar.classList.add('sidebar-collapsed');
content.classList.add('content-expanded');
} else {
sidebar.classList.remove('sidebar-collapsed');
content.classList.remove('content-expanded');
}
}

// Initial check
checkWidth();

// Check on resize
window.addEventListener('resize', checkWidth);

// Refresh table button
const refreshTable = document.getElementById('refreshTable');
if (refreshTable) {
refreshTable.addEventListener('click', function(e) {
e.preventDefault();
location.reload();
});
}

// Export CSV button
const exportCsv = document.getElementById('exportCsv');
if (exportCsv) {
exportCsv.addEventListener('click', function(e) {
e.preventDefault();

// Get table data
const table = document.getElementById('driverTable');
let csv = [];
const rows = table.querySelectorAll('tr');

for (let i = 0; i < rows.length; i++) {
const row = [], cols = rows[i].querySelectorAll('td, th');

for (let j = 0; j < cols.length; j++) {
// Get the text content, handling status badges
let text = cols[j].textContent.trim();
if (cols[j].querySelector('.status-badge')) {
text = cols[j].querySelector('.status-badge').textContent.trim();
}

// Add quotes to handle commas in the text
row.push('"' + text.replace(/"/g, '""') + '"');
}

csv.push(row.join(','));
}

// Download CSV file
const csvContent = csv.join('\n');
const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
const url = URL.createObjectURL(blob);
const link = document.createElement('a');
link.setAttribute('href', url);
link.setAttribute('download', 'driver_report_{{ selected_date }}.csv');
link.style.visibility = 'hidden';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
});
}
});
</script>
{% endblock %}
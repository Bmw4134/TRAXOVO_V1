{% extends "base.html" %}

{% block title %}Attendance Reports{% endblock %}

{% block content %}
<div class="container my-4"><h1 class="mb-4">Driver Attendance Reports</h1><div class="d-flex justify-content-between align-items-center mb-3"><div><span class="text-muted">Last updated: {{ last_updated }}</span></div><div><a href="{{ url_for('reports') }}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left"></i> Back to Reports
</a><a href="{{ url_for('attendance_reports') }}" class="btn btn-outline-primary btn-sm"><i class="fas fa-sync"></i> Refresh
</a></div></div>

{% if error_message %}
<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> {{ error_message }}
</div>
{% endif %}

<div class="row"><div class="col-md-6"><div class="card mb-4"><div class="card-header bg-primary text-white"><h5 class="card-title mb-0">Same-Day Attendance (8:30 AM Report)</h5></div><div class="card-body">
{% if same_day_report %}
<div class="row mb-3"><div class="col-md-4"><div class="card bg-light"><div class="card-body text-center"><h3 class="mb-0">{{ same_day_report.late_start_count }}</h3><p class="mb-0">Late Starts</p></div></div></div><div class="col-md-4"><div class="card bg-light"><div class="card-body text-center"><h3 class="mb-0">{{ same_day_report.not_on_job_count }}</h3><p class="mb-0">Not On Job</p></div></div></div><div class="col-md-4"><div class="card bg-light"><div class="card-body text-center"><h3 class="mb-0">{{ same_day_report.total_drivers }}</h3><p class="mb-0">Total Drivers</p></div></div></div></div><h6 class="mb-3">Late Start Drivers:</h6>
{% if same_day_report.late_start_drivers %}
<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Driver ID</th><th>Name</th><th>Start Time</th><th>Location</th></tr></thead><tbody>
{% for driver in same_day_report.late_start_drivers %}
<tr><td>{{ driver.asset_id }}</td><td>{{ driver.name }}</td><td>{{ driver.start_time }}</td><td>{{ driver.location }}</td></tr>
{% endfor %}
</tbody></table></div>
{% else %}
<p class="text-success">No late start drivers today!</p>
{% endif %}

<h6 class="mb-3 mt-4">Not On Job Drivers:</h6>
{% if same_day_report.not_on_job_drivers %}
<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Driver ID</th><th>Name</th><th>Location</th><th>Should Be At</th></tr></thead><tbody>
{% for driver in same_day_report.not_on_job_drivers %}
<tr><td>{{ driver.asset_id }}</td><td>{{ driver.name }}</td><td>{{ driver.current_location }}</td><td>{{ driver.assigned_location }}</td></tr>
{% endfor %}
</tbody></table></div>
{% else %}
<p class="text-success">All drivers are at their assigned locations!</p>
{% endif %}
{% else %}
<div class="alert alert-info"><p>Same-day attendance report has not been generated yet.</p><p class="mb-0">This report is automatically generated at 8:30 AM each weekday.</p></div>
{% endif %}
</div></div></div><div class="col-md-6"><div class="card mb-4"><div class="card-header bg-primary text-white"><h5 class="card-title mb-0">Prior-Day Attendance (9:30 AM Report)</h5></div><div class="card-body">
{% if prior_day_report %}
<div class="row mb-3"><div class="col-md-3"><div class="card bg-light"><div class="card-body text-center"><h3 class="mb-0">{{ prior_day_report.late_start_count }}</h3><p class="mb-0">Late Starts</p></div></div></div><div class="col-md-3"><div class="card bg-light"><div class="card-body text-center"><h3 class="mb-0">{{ prior_day_report.early_end_count }}</h3><p class="mb-0">Early Ends</p></div></div></div><div class="col-md-3"><div class="card bg-light"><div class="card-body text-center"><h3 class="mb-0">{{ prior_day_report.not_on_job_count }}</h3><p class="mb-0">Not On Job</p></div></div></div><div class="col-md-3"><div class="card bg-light"><div class="card-body text-center"><h3 class="mb-0">{{ prior_day_report.total_drivers }}</h3><p class="mb-0">Total Drivers</p></div></div></div></div><h6 class="mb-3">Late Start Drivers:</h6>
{% if prior_day_report.late_start_drivers %}
<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Driver ID</th><th>Name</th><th>Start Time</th><th>Minutes Late</th></tr></thead><tbody>
{% for driver in prior_day_report.late_start_drivers %}
<tr><td>{{ driver.asset_id }}</td><td>{{ driver.name }}</td><td>{{ driver.start_time }}</td><td>{{ driver.minutes_late }}</td></tr>
{% endfor %}
</tbody></table></div>
{% else %}
<p class="text-success">No late start drivers yesterday!</p>
{% endif %}

<h6 class="mb-3 mt-4">Early End Drivers:</h6>
{% if prior_day_report.early_end_drivers %}
<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Driver ID</th><th>Name</th><th>End Time</th><th>Minutes Early</th></tr></thead><tbody>
{% for driver in prior_day_report.early_end_drivers %}
<tr><td>{{ driver.asset_id }}</td><td>{{ driver.name }}</td><td>{{ driver.end_time }}</td><td>{{ driver.minutes_early }}</td></tr>
{% endfor %}
</tbody></table></div>
{% else %}
<p class="text-success">No early end drivers yesterday!</p>
{% endif %}

<h6 class="mb-3 mt-4">Not On Job Drivers:</h6>
{% if prior_day_report.not_on_job_drivers %}
<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Driver ID</th><th>Name</th><th>Should Be At</th><th>Time Away</th></tr></thead><tbody>
{% for driver in prior_day_report.not_on_job_drivers %}
<tr><td>{{ driver.asset_id }}</td><td>{{ driver.name }}</td><td>{{ driver.assigned_location }}</td><td>{{ driver.time_away }}</td></tr>
{% endfor %}
</tbody></table></div>
{% else %}
<p class="text-success">All drivers were at their assigned locations yesterday!</p>
{% endif %}
{% else %}
<div class="alert alert-info"><p>Prior-day attendance report has not been generated yet.</p><p class="mb-0">This report is automatically generated at 9:30 AM each weekday.</p></div>
{% endif %}
</div></div></div></div><div class="row"><div class="col-12"><div class="card mb-4"><div class="card-header bg-primary text-white"><h5 class="card-title mb-0">Weekly Attendance Summary</h5></div><div class="card-body"><canvas id="weeklyAttendanceChart" height="150"></canvas></div></div></div></div></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script>
document.addEventListener('DOMContentLoaded', function() {
// Weekly summary chart - using example data for now
// In a real implementation, this would come from historical report data
const weeklyCtx = document.getElementById('weeklyAttendanceChart').getContext('2d');

const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
// Sample data - this would be replaced with actual historical data
const lateStarts = [5, 3, 7, 4, 2];
const earlyEnds = [4, 2, 5, 7, 3];
const notOnJob = [3, 1, 2, 2, 4];

new Chart(weeklyCtx, {
type: 'bar',
data: {
labels: days,
datasets: [
{
label: 'Late Starts',
data: lateStarts,
backgroundColor: 'rgba(255, 99, 132, 0.7)',
borderWidth: 1
},
{
label: 'Early Ends',
data: earlyEnds,
backgroundColor: 'rgba(54, 162, 235, 0.7)',
borderWidth: 1
},
{
label: 'Not On Job',
data: notOnJob,
backgroundColor: 'rgba(255, 206, 86, 0.7)',
borderWidth: 1
}
]
},
options: {
responsive: true,
scales: {
y: {
beginAtZero: true,
title: {
display: true,
text: 'Number of Drivers'
}
}
}
}
});
});
</script>
{% endblock %}
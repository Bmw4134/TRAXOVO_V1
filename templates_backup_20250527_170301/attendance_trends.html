{% extends 'base.html' %}

{% block title %}Attendance Trends{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>Driver Attendance Trends</h1>
            <p class="text-muted">Analyze attendance patterns and identify trends over time</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('reports.driver_reports') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i> Back to Reports
            </a>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="card bg-dark text-white mb-4">
        <div class="card-body">
            <form id="filter-form" method="GET" action="{{ url_for('reports.attendance_trends') }}">
                <div class="row gx-3 gy-2 align-items-center">
                    <div class="col-md-3">
                        <label for="date-range" class="form-label">Date Range</label>
                        <select class="form-select" id="date-range" name="date_range">
                            <option value="7" {% if date_range == 7 %}selected{% endif %}>Last 7 days</option>
                            <option value="14" {% if date_range == 14 %}selected{% endif %}>Last 14 days</option>
                            <option value="30" {% if date_range == 30 %}selected{% endif %}>Last 30 days</option>
                            <option value="90" {% if date_range == 90 %}selected{% endif %}>Last 90 days</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="region" class="form-label">Region</label>
                        <select class="form-select" id="region" name="region">
                            <option value="all" {% if region == 'all' %}selected{% endif %}>All Regions</option>
                            {% for r in regions %}
                            <option value="{{ r }}" {% if region == r %}selected{% endif %}>{{ r }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="incident-type" class="form-label">Incident Type</label>
                        <select class="form-select" id="incident-type" name="incident_type">
                            <option value="all" {% if incident_type == 'all' %}selected{% endif %}>All Incidents</option>
                            <option value="late_start" {% if incident_type == 'late_start' %}selected{% endif %}>Late Start</option>
                            <option value="early_end" {% if incident_type == 'early_end' %}selected{% endif %}>Early End</option>
                            <option value="not_on_job" {% if incident_type == 'not_on_job' %}selected{% endif %}>Not On Job</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-filter me-2"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Total Incidents</h6>
                            <h2 class="mb-0">{{ summary.total_incidents }}</h2>
                        </div>
                        <i class="bi bi-calendar-check fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Late Starts</h6>
                            <h2 class="mb-0">{{ summary.late_starts }}</h2>
                        </div>
                        <i class="bi bi-clock-history fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Early Ends</h6>
                            <h2 class="mb-0">{{ summary.early_ends }}</h2>
                        </div>
                        <i class="bi bi-clock fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-secondary mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Not On Job</h6>
                            <h2 class="mb-0">{{ summary.not_on_job }}</h2>
                        </div>
                        <i class="bi bi-geo-alt fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Row -->
    <div class="row mb-4">
        <!-- Daily Trend Chart -->
        <div class="col-md-8">
            <div class="card bg-dark text-white">
                <div class="card-header bg-primary">
                    <h5 class="mb-0">Daily Attendance Incidents</h5>
                </div>
                <div class="card-body">
                    <canvas id="dailyTrendChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Incident Type Distribution -->
        <div class="col-md-4">
            <div class="card bg-dark text-white">
                <div class="card-header bg-primary">
                    <h5 class="mb-0">Incident Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="incidentDistribution" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Drivers & Top Job Sites -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-dark text-white">
                <div class="card-header bg-primary">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Top Drivers with Attendance Issues</h5>
                        <span class="badge bg-light text-dark">{{ top_drivers|length }} Drivers</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover csv-data-table mb-0">
                            <thead>
                                <tr>
                                    <th>Driver Name</th>
                                    <th>Employee ID</th>
                                    <th>Asset ID</th>
                                    <th>Incidents</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for driver in top_drivers %}
                                <tr>
                                    <td>{{ driver.name }}</td>
                                    <td>{{ driver.employee_id }}</td>
                                    <td>{{ driver.asset_id }}</td>
                                    <td>{{ driver.total_incidents }}</td>
                                    <td>
                                        {% if driver.trend > 0 %}
                                        <span class="text-danger"><i class="bi bi-arrow-up-right"></i> {{ driver.trend }}%</span>
                                        {% elif driver.trend < 0 %}
                                        <span class="text-success"><i class="bi bi-arrow-down-right"></i> {{ driver.trend|abs }}%</span>
                                        {% else %}
                                        <span class="text-muted"><i class="bi bi-dash"></i> 0%</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card bg-dark text-white">
                <div class="card-header bg-primary">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Top Job Sites with Attendance Issues</h5>
                        <span class="badge bg-light text-dark">{{ top_sites|length }} Sites</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover csv-data-table mb-0">
                            <thead>
                                <tr>
                                    <th>Job Site</th>
                                    <th>Job Number</th>
                                    <th>Incidents</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for site in top_sites %}
                                <tr>
                                    <td>{{ site.name }}</td>
                                    <td>{{ site.job_number }}</td>
                                    <td>{{ site.total_incidents }}</td>
                                    <td>
                                        {% if site.trend > 0 %}
                                        <span class="text-danger"><i class="bi bi-arrow-up-right"></i> {{ site.trend }}%</span>
                                        {% elif site.trend < 0 %}
                                        <span class="text-success"><i class="bi bi-arrow-down-right"></i> {{ site.trend|abs }}%</span>
                                        {% else %}
                                        <span class="text-muted"><i class="bi bi-dash"></i> 0%</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Heatmap -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark text-white">
                <div class="card-header bg-primary">
                    <h5 class="mb-0">Weekly Attendance Pattern Heatmap</h5>
                </div>
                <div class="card-body">
                    <canvas id="weeklyHeatmap" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart data from server
    const dailyData = {{ daily_data|tojson }};
    const distributionData = [
        {{ summary.late_starts }}, 
        {{ summary.early_ends }}, 
        {{ summary.not_on_job }}
    ];
    const weeklyHeatmapData = {{ weekly_heatmap|tojson }};
    
    // Daily trend line chart
    const dailyTrendChart = new Chart(
        document.getElementById('dailyTrendChart'),
        {
            type: 'line',
            data: {
                labels: dailyData.dates,
                datasets: [
                    {
                        label: 'Late Start',
                        data: dailyData.late_starts,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Early End',
                        data: dailyData.early_ends,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Not On Job',
                        data: dailyData.not_on_job,
                        borderColor: '#6c757d',
                        backgroundColor: 'rgba(108, 117, 125, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#e9ecef'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#e9ecef'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#e9ecef'
                        },
                        beginAtZero: true
                    }
                }
            }
        }
    );
    
    // Incident distribution pie chart
    const incidentDistribution = new Chart(
        document.getElementById('incidentDistribution'),
        {
            type: 'doughnut',
            data: {
                labels: ['Late Start', 'Early End', 'Not On Job'],
                datasets: [{
                    data: distributionData,
                    backgroundColor: ['#dc3545', '#ffc107', '#6c757d'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#e9ecef'
                        }
                    }
                }
            }
        }
    );
    
    // Weekly heatmap
    if (document.getElementById('weeklyHeatmap')) {
        const weeklyHeatmap = new Chart(
            document.getElementById('weeklyHeatmap'),
            {
                type: 'heatmap',
                data: {
                    datasets: [{
                        data: weeklyHeatmapData,
                        backgroundColor: (ctx) => {
                            const value = ctx.raw ? ctx.raw.v : 0;
                            const alpha = Math.min(1, Math.max(0.1, value / 10)); // Scale based on max value
                            return `rgba(13, 110, 253, ${alpha})`;
                        },
                        borderColor: '#343a40',
                        borderWidth: 1,
                        width: 60,
                        height: 30
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: (tooltipItems) => {
                                    return 'Incidents';
                                },
                                label: (tooltipItem) => {
                                    const day = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][tooltipItem.raw.y];
                                    const hour = tooltipItem.raw.x;
                                    return `${day} at ${hour}:00: ${tooltipItem.raw.v} incidents`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            min: 5,
                            max: 18,
                            ticks: {
                                stepSize: 1,
                                callback: (value) => `${value}:00`,
                                color: '#e9ecef'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            title: {
                                display: true,
                                text: 'Hour of Day',
                                color: '#e9ecef'
                            }
                        },
                        y: {
                            type: 'linear',
                            min: 0,
                            max: 6,
                            ticks: {
                                stepSize: 1,
                                callback: (value) => ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][value],
                                color: '#e9ecef'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            title: {
                                display: true,
                                text: 'Day of Week',
                                color: '#e9ecef'
                            }
                        }
                    }
                }
            }
        );
    }
});
</script>
{% endblock %}
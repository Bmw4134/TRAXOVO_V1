{% extends "layout.html" %}

{% block title %}Cost Code Breakdown - April 2025{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="display-5 mb-2">
                <i class="bi bi-pie-chart me-2"></i>Cost Code Breakdown
            </h1>
            <p class="lead text-muted">
                April 2025 Billing Detail
            </p>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="btn-group">
                <a href="{{ url_for('april_billing.index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
                </a>
                <a href="{{ url_for('april_billing.export_data') }}?type=detail&format=xlsx" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel me-1"></i> Export All
                </a>
            </div>
        </div>
    </div>
    
    <!-- Cost Code Cards -->
    <div class="row mb-4">
        {% set total_cost_codes = cost_codes|length %}
        {% set legacy_count = namespace(value=0) %}
        {% set standard_count = namespace(value=0) %}
        {% set other_count = namespace(value=0) %}
        
        {% for cc in cost_codes %}
            {% if '9000 100M' in cc.cost_code %}
                {% set legacy_count.value = legacy_count.value + 1 %}
            {% elif '9000 100F' in cc.cost_code %}
                {% set standard_count.value = standard_count.value + 1 %}
            {% else %}
                {% set other_count.value = other_count.value + 1 %}
            {% endif %}
        {% endfor %}
        
        <div class="col-md-4 col-sm-6 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <h1 class="display-4 mb-0">{{ total_cost_codes }}</h1>
                    <h5 class="card-title">Total Cost Codes</h5>
                    <p class="mb-0">April 2025</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-sm-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center">
                    <h1 class="display-4 mb-0">{{ legacy_count.value }}</h1>
                    <h5 class="card-title">Legacy Codes</h5>
                    <p class="mb-0">9000 100M</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 col-sm-6 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body text-center">
                    <h1 class="display-4 mb-0">{{ standard_count.value + other_count.value }}</h1>
                    <h5 class="card-title">Standard Codes</h5>
                    <p class="mb-0">9000 100F and Others</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Code Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Cost Code Breakdown</h5>
                    <div class="input-group" style="max-width: 300px;">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" id="cost-code-search" class="form-control" placeholder="Search cost codes...">
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0" id="cost-code-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Cost Code</th>
                                    <th class="text-center">Assets</th>
                                    <th class="text-center">Jobs</th>
                                    <th class="text-end">Original Units</th>
                                    <th class="text-end">Revised Units</th>
                                    <th class="text-end">Difference</th>
                                    <th class="text-center">Change</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cc in cost_codes %}
                                <tr>
                                    <td>{{ cc.cost_code }}</td>
                                    <td class="text-center">{{ cc.asset_count }}</td>
                                    <td class="text-center">{{ cc.job_count }}</td>
                                    <td class="text-end">{{ "%.2f"|format(cc.total_units) }}</td>
                                    <td class="text-end">{{ "%.2f"|format(cc.revised_units) }}</td>
                                    <td class="text-end text-{% if cc.difference > 0 %}success{% elif cc.difference < 0 %}danger{% else %}muted{% endif %}">
                                        {{ "%.2f"|format(cc.difference) }}
                                    </td>
                                    <td class="text-center">
                                        {% if cc.difference > 0 %}
                                            <span class="badge bg-success">+{{ "%.1f"|format(cc.difference / cc.total_units * 100) }}%</span>
                                        {% elif cc.difference < 0 %}
                                            <span class="badge bg-danger">{{ "%.1f"|format(cc.difference / cc.total_units * 100) }}%</span>
                                        {% else %}
                                            <span class="badge bg-secondary">0.0%</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-primary view-jobs-btn" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#jobs-{{ cc.cost_code|replace(' ', '-')|replace('/', '-') }}">
                                                <i class="bi bi-eye"></i> Jobs
                                            </button>
                                            <a href="{{ url_for('april_billing.export_data') }}?type=detail&format=xlsx&cost_code={{ cc.cost_code }}" class="btn btn-outline-success">
                                                <i class="bi bi-download"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="collapse" id="jobs-{{ cc.cost_code|replace(' ', '-')|replace('/', '-') }}">
                                    <td colspan="8" class="p-3 bg-light">
                                        <h6>Jobs using this cost code:</h6>
                                        <div class="d-flex flex-wrap gap-2 mt-2">
                                            {% for job in cc.jobs %}
                                                <a href="{{ url_for('april_billing.job_detail', job_id=job) }}" class="btn btn-sm btn-outline-primary">
                                                    {{ job }}
                                                </a>
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add search functionality for the cost code table
        document.getElementById('cost-code-search').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const table = document.getElementById('cost-code-table');
            const rows = table.querySelectorAll('tbody tr:not(.collapse)'); // Skip collapse rows
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                    // Also show the next row if it's a collapse row
                    const nextRow = row.nextElementSibling;
                    if (nextRow && nextRow.classList.contains('collapse')) {
                        nextRow.style.display = nextRow.classList.contains('show') ? '' : 'none';
                    }
                } else {
                    row.style.display = 'none';
                    // Also hide the next row if it's a collapse row
                    const nextRow = row.nextElementSibling;
                    if (nextRow && nextRow.classList.contains('collapse')) {
                        nextRow.style.display = 'none';
                    }
                }
            });
        });
    });
</script>
{% endblock %}
{% extends "layout.html" %}

{% block title %}PM Allocations{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="display-5 mb-2">
                <i class="bi bi-file-earmark-spreadsheet me-2"></i>PM Allocations
            </h1>
            <p class="lead text-muted">
                Manage and compare PM allocation files
            </p>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="btn-group">
                <a href="{{ url_for('billing_module.pm_allocation_upload') }}" class="btn btn-success">
                    <i class="bi bi-upload me-1"></i> Upload Files
                </a>
                <a href="{{ url_for('billing_module.monthly_report') }}" class="btn btn-primary">
                    <i class="bi bi-graph-up-arrow me-1"></i> Monthly Report
                </a>
                <a href="{{ url_for('billing_module.index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Billing
                </a>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="region-filter" class="form-label">Region</label>
                            <select id="region-filter" class="form-select">
                                <option value="">All Regions</option>
                                <option value="DFW">Dallas-Fort Worth</option>
                                <option value="HOU">Houston</option>
                                <option value="WTX">West Texas</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="status-filter" class="form-label">Status</label>
                            <select id="status-filter" class="form-select">
                                <option value="">All Statuses</option>
                                <option value="Final">Final</option>
                                <option value="Updated">Updated</option>
                                <option value="Original">Original</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="uploader-filter" class="form-label">Uploader</label>
                            <select id="uploader-filter" class="form-select">
                                <option value="">All Uploaders</option>
                                <option value="John Admin">John Admin</option>
                                <option value="Sarah Manager">Sarah Manager</option>
                                <option value="Michael Analyst">Michael Analyst</option>
                                <option value="Lisa Supervisor">Lisa Supervisor</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="search" class="form-label">Search</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="search" placeholder="Search filenames...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm bg-light">
                <div class="card-body">
                    <h5 class="card-title mb-3">Compare Allocation Files</h5>
                    <form action="{{ url_for('billing_module.pm_allocation_upload') }}" method="post" enctype="multipart/form-data" class="row g-3">
                        <div class="col-md-5">
                            <label for="original-file" class="form-label">Original File</label>
                            <select class="form-select" id="original-file" name="original_file_id">
                                <option value="" selected disabled>Select original file</option>
                                {% for file in allocation_files if file.file_type == 'Original' %}
                                <option value="{{ file.id }}">{{ file.filename }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label for="updated-file" class="form-label">Updated File</label>
                            <select class="form-select" id="updated-file" name="updated_file_id">
                                <option value="" selected disabled>Select updated file</option>
                                {% for file in allocation_files if file.file_type == 'Modified' %}
                                <option value="{{ file.id }}">{{ file.filename }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Compare Files</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Files Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">PM Allocation Files</h5>
                        <span class="badge bg-primary rounded-pill">{{ allocation_files|length }} Files</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="allocation-files-table">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">Filename</th>
                                    <th scope="col">Region</th>
                                    <th scope="col">Date Uploaded</th>
                                    <th scope="col">Uploaded By</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Status</th>
                                    <th scope="col" class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in allocation_files %}
                                <tr>
                                    <td>{{ file.filename }}</td>
                                    <td>{{ file.region }}</td>
                                    <td>{{ file.date_uploaded }}</td>
                                    <td>{{ file.uploaded_by }}</td>
                                    <td>
                                        {% if file.file_type == 'Original' %}
                                            <span class="badge bg-secondary">Original</span>
                                        {% else %}
                                            <span class="badge bg-info text-white">Modified</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if file.status == 'Final' %}
                                            <span class="badge bg-success">Final</span>
                                        {% elif file.status == 'Updated' %}
                                            <span class="badge bg-primary">Updated</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Original</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary view-file-btn" data-file-id="{{ file.id }}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-success download-file-btn" data-file-id="{{ file.id }}">
                                                <i class="bi bi-download"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-info text-info find-similar-btn" data-file-id="{{ file.id }}">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <nav aria-label="Pagination">
                        <ul class="pagination justify-content-center mb-0">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View File Modal -->
<div class="modal fade" id="viewFileModal" tabindex="-1" aria-labelledby="viewFileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="viewFileModalLabel">File Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center p-5" id="file-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading file preview...</p>
                </div>
                <div id="file-preview" class="d-none">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i> This is a simplified preview. For full details, please download the file or use the comparison tool.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Asset ID</th>
                                    <th>Description</th>
                                    <th class="text-end">Amount</th>
                                    <th>Job Number</th>
                                    <th>Location</th>
                                </tr>
                            </thead>
                            <tbody id="preview-data">
                                <!-- Preview data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="download-preview-btn">
                    <i class="bi bi-download me-1"></i> Download File
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Find Similar Modal -->
<div class="modal fade" id="findSimilarModal" tabindex="-1" aria-labelledby="findSimilarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="findSimilarModalLabel">Find Similar Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 class="mb-3">Files similar to: <span id="similar-file-name"></span></h6>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Region</th>
                                <th>Date Uploaded</th>
                                <th>Similarity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="similar-files-list">
                            <!-- Similar files will be listed here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="compare-selected-btn">
                    <i class="bi bi-arrow-left-right me-1"></i> Compare Selected
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filter functionality
        const regionFilter = document.getElementById('region-filter');
        const statusFilter = document.getElementById('status-filter');
        const uploaderFilter = document.getElementById('uploader-filter');
        const searchInput = document.getElementById('search');
        
        function filterTable() {
            const region = regionFilter.value.toLowerCase();
            const status = statusFilter.value.toLowerCase();
            const uploader = uploaderFilter.value.toLowerCase();
            const search = searchInput.value.toLowerCase();
            
            const rows = document.querySelectorAll('#allocation-files-table tbody tr');
            
            rows.forEach(row => {
                const regionCell = row.cells[1].textContent.toLowerCase();
                const statusCell = row.cells[5].textContent.toLowerCase();
                const uploaderCell = row.cells[3].textContent.toLowerCase();
                const filenameCell = row.cells[0].textContent.toLowerCase();
                
                const matchesRegion = !region || regionCell.includes(region);
                const matchesStatus = !status || statusCell.includes(status);
                const matchesUploader = !uploader || uploaderCell.includes(uploader);
                const matchesSearch = !search || filenameCell.includes(search);
                
                if (matchesRegion && matchesStatus && matchesUploader && matchesSearch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        regionFilter.addEventListener('change', filterTable);
        statusFilter.addEventListener('change', filterTable);
        uploaderFilter.addEventListener('change', filterTable);
        searchInput.addEventListener('input', filterTable);
        
        // View file modal
        const viewFileModal = new bootstrap.Modal(document.getElementById('viewFileModal'));
        const fileLoading = document.getElementById('file-loading');
        const filePreview = document.getElementById('file-preview');
        const previewData = document.getElementById('preview-data');
        const viewFileBtns = document.querySelectorAll('.view-file-btn');
        
        viewFileBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const fileId = this.dataset.fileId;
                
                // Show loading, hide preview
                fileLoading.classList.remove('d-none');
                filePreview.classList.add('d-none');
                previewData.innerHTML = '';
                
                // Show modal
                viewFileModal.show();
                
                // In a real implementation, this would fetch file data from the server
                // For demonstration, we'll simulate with a delay and mock data
                setTimeout(() => {
                    // Generate some mock data for preview
                    const mockData = [
                        { assetId: 'ASST-001', description: 'Caterpillar D6 Dozer', amount: 3500.00, jobNumber: 'JOB-1234', location: 'DFW Site 3' },
                        { assetId: 'ASST-002', description: 'John Deere 310SL Backhoe', amount: 2987.50, jobNumber: 'JOB-1234', location: 'DFW Site 3' },
                        { assetId: 'ASST-003', description: 'Komatsu PC210 Excavator', amount: 4800.00, jobNumber: 'JOB-5678', location: 'DFW Site 8' },
                        { assetId: 'ASST-004', description: 'Cat 140M Motor Grader', amount: 5000.00, jobNumber: 'JOB-5678', location: 'DFW Site 8' },
                        { assetId: 'ASST-005', description: 'Volvo A30F Articulated Hauler', amount: 5230.00, jobNumber: 'JOB-9012', location: 'DFW Site 12' }
                    ];
                    
                    // Add rows to preview
                    mockData.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.assetId}</td>
                            <td>${item.description}</td>
                            <td class="text-end">$${item.amount.toFixed(2)}</td>
                            <td>${item.jobNumber}</td>
                            <td>${item.location}</td>
                        `;
                        previewData.appendChild(row);
                    });
                    
                    // Hide loading, show preview
                    fileLoading.classList.add('d-none');
                    filePreview.classList.remove('d-none');
                }, 1000);
            });
        });
        
        // Download file button
        const downloadFileBtns = document.querySelectorAll('.download-file-btn');
        downloadFileBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const fileId = this.dataset.fileId;
                alert(`Download started for file ID: ${fileId}`);
            });
        });
        
        // Download from preview button
        const downloadPreviewBtn = document.getElementById('download-preview-btn');
        downloadPreviewBtn.addEventListener('click', function() {
            alert('Download started for the previewed file');
        });
        
        // Find similar files modal
        const findSimilarModal = new bootstrap.Modal(document.getElementById('findSimilarModal'));
        const similarFileName = document.getElementById('similar-file-name');
        const similarFilesList = document.getElementById('similar-files-list');
        const findSimilarBtns = document.querySelectorAll('.find-similar-btn');
        
        findSimilarBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const fileId = this.dataset.fileId;
                const fileName = this.closest('tr').cells[0].textContent;
                
                // Set file name in modal
                similarFileName.textContent = fileName;
                
                // Clear previous list
                similarFilesList.innerHTML = '';
                
                // In a real implementation, this would fetch similar files from the server
                // For demonstration, we'll add some mock similar files
                const mockSimilarFiles = [
                    { id: '1', filename: 'EQMO. BILLING ALLOCATIONS - APRIL 2025 (TR-FINAL REVISIONS BY 05.15.2025).xlsx', region: 'DFW', dateUploaded: '2025-05-15', similarity: 95 },
                    { id: '2', filename: '2024-025 EQMO. BILLING ALLOCATIONS - APRIL 2025 2024-025 allocated AJR.xlsx', region: 'DFW', dateUploaded: '2025-05-14', similarity: 87 },
                    { id: '3', filename: 'S. ALVAREZ EQMO. BILLING ALLOCATIONS - APRIL 2025.xlsx', region: 'DFW', dateUploaded: '2025-05-10', similarity: 72 }
                ];
                
                mockSimilarFiles.forEach(file => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${file.filename}</td>
                        <td>${file.region}</td>
                        <td>${file.dateUploaded}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar ${file.similarity > 90 ? 'bg-success' : file.similarity > 75 ? 'bg-info' : 'bg-warning'}" 
                                     role="progressbar" style="width: ${file.similarity}%;" 
                                     aria-valuenow="${file.similarity}" aria-valuemin="0" aria-valuemax="100">
                                    ${file.similarity}%
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="form-check">
                                <input class="form-check-input similar-file-check" type="checkbox" value="${file.id}" id="check-${file.id}">
                                <label class="form-check-label" for="check-${file.id}">
                                    Compare
                                </label>
                            </div>
                        </td>
                    `;
                    similarFilesList.appendChild(row);
                });
                
                // Show modal
                findSimilarModal.show();
            });
        });
        
        // Compare selected button
        const compareSelectedBtn = document.getElementById('compare-selected-btn');
        compareSelectedBtn.addEventListener('click', function() {
            const selectedFiles = document.querySelectorAll('.similar-file-check:checked');
            
            if (selectedFiles.length < 1) {
                alert('Please select at least one file to compare with');
                return;
            }
            
            // In a real implementation, this would redirect to the comparison page
            // For demonstration, we'll just show an alert
            const selectedIds = Array.from(selectedFiles).map(checkbox => checkbox.value);
            alert(`Comparing files with IDs: ${selectedIds.join(', ')}`);
            
            findSimilarModal.hide();
        });
    });
</script>
{% endblock %}
{% extends "layout_unified.html" %}

{% block title %}Daily Driver Report - {{ formatted_date }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/">Home</a></li><li class="breadcrumb-item"><a href="{{ url_for('daily_driver_report.dashboard') }}">Daily Driver Reports</a></li><li class="breadcrumb-item active" aria-current="page">{{ formatted_date }}</li>
{% endblock %}

{% block page_title %}Daily Driver Report{% endblock %}
{% block page_subtitle %}{{ formatted_date }}{% endblock %}

{% block page_actions %}
<a href="{{ url_for('daily_driver_report.download_report', date=date) }}" class="btn btn-outline-primary"><i class="bi bi-download me-2"></i> Download Excel
</a><a href="{{ url_for('daily_driver_report.generate_report', date=date) }}" class="btn btn-outline-secondary ms-2"><i class="bi bi-arrow-repeat me-2"></i> Regenerate
</a>
{% endblock %}

{% block content %}
{% if report_data %}

<div class="row mb-4"><div class="col-md-6 col-xl-3 mb-3"><div class="card bg-dark border-0 shadow-sm hoverable"><div class="card-body"><div class="d-flex align-items-center"><div class="rounded-circle bg-success bg-opacity-10 p-3 me-3"><i class="bi bi-person-check text-success fs-4"></i></div><div><h3 class="mb-0 fs-4">{{ report_data.summary.total_drivers }}</h3><p class="text-muted mb-0">Total Drivers</p></div></div></div></div></div><div class="col-md-6 col-xl-3 mb-3"><div class="card bg-dark border-0 shadow-sm hoverable"><div class="card-body"><div class="d-flex align-items-center"><div class="rounded-circle bg-success bg-opacity-10 p-3 me-3"><i class="bi bi-check-circle text-success fs-4"></i></div><div><h3 class="mb-0 fs-4">{{ report_data.summary.on_time_count }}</h3><p class="text-muted mb-0">On Time ({{ report_data.summary.on_time_percentage|round|int }}%)</p></div></div></div></div></div><div class="col-md-6 col-xl-3 mb-3"><div class="card bg-dark border-0 shadow-sm hoverable"><div class="card-body"><div class="d-flex align-items-center"><div class="rounded-circle bg-danger bg-opacity-10 p-3 me-3"><i class="bi bi-clock-fill text-danger fs-4"></i></div><div><h3 class="mb-0 fs-4">{{ report_data.summary.late_count }}</h3><p class="text-muted mb-0">Late ({{ report_data.summary.late_percentage|round|int }}%)</p></div></div></div></div></div><div class="col-md-6 col-xl-3 mb-3"><div class="card bg-dark border-0 shadow-sm hoverable"><div class="card-body"><div class="d-flex align-items-center justify-content-center"><div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3"><i class="bi bi-exclamation-circle text-warning fs-4"></i></div><div><h3 class="mb-0 fs-4">{{ report_data.summary.early_end_count + report_data.summary.not_on_job_count }}</h3><p class="text-muted mb-0">Issues</p></div></div></div></div></div></div><div class="row mb-4"><div class="col-12"><div class="card bg-dark border-0 shadow-sm"><div class="card-header bg-dark d-flex justify-content-between align-items-center"><h5 class="card-title mb-0">Driver Attendance Records</h5><span class="badge bg-primary">{{ report_data.driver_records|length }} Drivers</span></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-dark table-hover mb-0" id="driver-records-table"><thead><tr><th>Driver</th><th>Job</th><th class="text-center">Status</th><th>Start Time</th><th>End Time</th><th>Hours</th><th>Late (min)</th><th>Early End (min)</th><th class="text-center">GPS Verified</th></tr></thead><tbody>
{% for driver in report_data.driver_records %}
{% set status_class = {
'on_time': 'bg-success',
'late': 'bg-danger',
'early_end': 'bg-warning',
'not_on_job': 'bg-info'
}.get(driver.classification, 'bg-secondary') %}

{% set status_text = {
'on_time': 'On Time',
'late': 'Late',
'early_end': 'Early End',
'not_on_job': 'Not On Job'
}.get(driver.classification, 'Unknown') %}

<tr><td>{{ driver.driver_name }}</td><td>
{% if driver.job_number %}
{{ driver.job_number }}
{% endif %}
{% if driver.job_name %}
- {{ driver.job_name }}
{% endif %}
</td><td class="text-center"><span class="badge {{ status_class }}">{{ status_text }}</span></td><td>{{ driver.start_time or '-' }}</td><td>{{ driver.end_time or '-' }}</td><td>{{ driver.hours|float|round(1) if driver.hours else '-' }}</td><td>{{ driver.late_minutes or '-' }}</td><td>{{ driver.early_end_minutes or '-' }}</td><td class="text-center">
{% if driver.gps_verified %}
<i class="bi bi-check-circle-fill text-success"></i>
{% else %}
<i class="bi bi-x-circle-fill text-danger"></i>
{% endif %}
</td></tr>
{% endfor %}
</tbody></table></div></div></div></div></div><div class="row mb-4"><div class="col-lg-6 mb-4"><div class="card bg-dark border-0 shadow-sm"><div class="card-header bg-dark"><h5 class="card-title mb-0">Attendance Statistics</h5></div><div class="card-body"><canvas id="attendance-chart" height="200"></canvas></div></div></div><div class="col-lg-6 mb-4"><div class="card bg-dark border-0 shadow-sm"><div class="card-header bg-dark"><h5 class="card-title mb-0">Key Metrics</h5></div><div class="card-body"><div class="row"><div class="col-md-6 mb-3"><div class="bg-dark border border-secondary rounded p-3"><h6 class="text-muted mb-1">Average Late</h6><h3 class="mb-0">{{ report_data.summary.average_late_minutes|default(0)|round(1) }} min</h3></div></div><div class="col-md-6 mb-3"><div class="bg-dark border border-secondary rounded p-3"><h6 class="text-muted mb-1">Average Early End</h6><h3 class="mb-0">{{ report_data.summary.average_early_end_minutes|default(0)|round(1) }} min</h3></div></div></div><div class="mt-4"><h6 class="mb-3">Attendance Summary</h6><div class="progress" style="height: 30px;"><div class="progress-bar bg-success" role="progressbar"
style="width: {{ report_data.summary.on_time_percentage }}%;"
aria-valuenow="{{ report_data.summary.on_time_percentage }}"
aria-valuemin="0" aria-valuemax="100">
On Time ({{ report_data.summary.on_time_percentage|round|int }}%)
</div><div class="progress-bar bg-danger" role="progressbar"
style="width: {{ report_data.summary.late_percentage }}%;"
aria-valuenow="{{ report_data.summary.late_percentage }}"
aria-valuemin="0" aria-valuemax="100">
Late ({{ report_data.summary.late_percentage|round|int }}%)
</div><div class="progress-bar bg-warning" role="progressbar"
style="width: {{ report_data.summary.early_end_percentage }}%;"
aria-valuenow="{{ report_data.summary.early_end_percentage }}"
aria-valuemin="0" aria-valuemax="100">
Early ({{ report_data.summary.early_end_percentage|round|int }}%)
</div><div class="progress-bar bg-info" role="progressbar"
style="width: {{ report_data.summary.not_on_job_percentage }}%;"
aria-valuenow="{{ report_data.summary.not_on_job_percentage }}"
aria-valuemin="0" aria-valuemax="100">
NOJ ({{ report_data.summary.not_on_job_percentage|round|int }}%)
</div></div></div></div></div></div></div><div class="alert alert-success mb-4"><div class="d-flex"><div class="flex-shrink-0"><i class="bi bi-lightning-charge-fill fs-4 me-3"></i></div><div><h5 class="alert-heading mb-2">Report Generated Automatically</h5><p class="mb-0">
This report was generated automatically by the TRAXORA GENIUS CORE system, saving 1-2 hours of manual work.
The Excel file matches the exact format you're used to, and can be downloaded using the button above.
</p></div></div></div>

{% else %}

<div class="alert alert-warning mb-4"><div class="d-flex"><div class="flex-shrink-0"><i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i></div><div><h5 class="alert-heading mb-2">Report Data Not Available</h5><p class="mb-0">
The report data for {{ formatted_date }} is not available for viewing in the dashboard, but you can still
download the Excel file using the button above.
</p><div class="mt-3"><a href="{{ url_for('daily_driver_report.download_report', date=date) }}" class="btn btn-primary"><i class="bi bi-download me-2"></i> Download Excel Report
</a><a href="{{ url_for('daily_driver_report.upload_files') }}?date={{ date }}" class="btn btn-outline-primary ms-2"><i class="bi bi-upload me-2"></i> Upload Files for This Date
</a></div></div></div></div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if report_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script>
document.addEventListener('DOMContentLoaded', function() {
// Create attendance pie chart
const ctx = document.getElementById('attendance-chart').getContext('2d');
const data = {
labels: [
'On Time ({{ report_data.summary.on_time_percentage|round|int }}%)',
'Late ({{ report_data.summary.late_percentage|round|int }}%)',
'Early End ({{ report_data.summary.early_end_percentage|round|int }}%)',
'Not On Job ({{ report_data.summary.not_on_job_percentage|round|int }}%)'
],
datasets: [{
data: [
{{ report_data.summary.on_time_count }},
{{ report_data.summary.late_count }},
{{ report_data.summary.early_end_count }},
{{ report_data.summary.not_on_job_count }}
],
backgroundColor: [
'rgba(40, 167, 69, 0.8)',
'rgba(220, 53, 69, 0.8)',
'rgba(255, 193, 7, 0.8)',
'rgba(23, 162, 184, 0.8)'
],
borderWidth: 0
}]
};

const config = {
type: 'pie',
data: data,
options: {
responsive: true,
maintainAspectRatio: true,
plugins: {
legend: {
position: 'right',
labels: {
color: '#fff',
padding: 10
}
}
}
}
};

new Chart(ctx, config);
});
</script>
{% endif %}
{% endblock %}
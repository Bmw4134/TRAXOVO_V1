{% extends "base.html" %}

{% block title %}Dashboard - TRAXORA{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet"><style>
.card-dashboard {
border-radius: 8px;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
transition: transform 0.2s, box-shadow 0.2s;
cursor: pointer;
}

.card-dashboard:hover {
transform: translateY(-5px);
box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.stats-counter {
font-size: 2.5rem;
font-weight: 700;
}

.trend-indicator {
font-size: 0.9rem;
padding: 0.2rem 0.5rem;
border-radius: 20px;
margin-left: 0.5rem;
}

.trend-up {
background-color: rgba(28, 200, 138, 0.2);
color: #1cc88a;
}

.trend-down-good {
background-color: rgba(28, 200, 138, 0.2);
color: #1cc88a;
}

.trend-down-bad {
background-color: rgba(231, 74, 59, 0.2);
color: #e74a3b;
}

.trend-stable {
background-color: rgba(54, 185, 204, 0.2);
color: #36b9cc;
}

.quick-stat {
padding: 0.75rem;
border-radius: 8px;
margin-bottom: 1rem;
}

.recent-activity-item {
transition: background-color 0.2s;
border-left: 4px solid transparent;
}

.recent-activity-item:hover {
background-color: rgba(78, 115, 223, 0.1);
border-left: 4px solid #4e73df;
}

.activity-icon {
width: 32px;
height: 32px;
display: flex;
align-items: center;
justify-content: center;
border-radius: 50%;
}

.activity-completed {
background-color: rgba(28, 200, 138, 0.2);
color: #1cc88a;
}

.activity-warning {
background-color: rgba(246, 194, 62, 0.2);
color: #f6c23e;
}

.activity-danger {
background-color: rgba(231, 74, 59, 0.2);
color: #e74a3b;
}

.activity-info {
background-color: rgba(54, 185, 204, 0.2);
color: #36b9cc;
}

.activity-primary {
background-color: rgba(78, 115, 223, 0.2);
color: #4e73df;
}

.mini-map {
height: 200px;
border-radius: 8px;
}

.sparkline-container {
height: 30px;
width: 100px;
display: inline-block;
vertical-align: middle;
}

.status-count {
font-size: 1.5rem;
font-weight: 600;
}

.utilization-chart {
height: 200px;
}

/* Customized progress bars */
.progress {
height: 10px;
border-radius: 10px;
}

.progress-thin {
height: 5px;
}

/* Custom pill badges */
.badge-pill-lg {
padding: 0.5rem 1rem;
font-size: 0.85rem;
border-radius: 50px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4"><div class="d-sm-flex align-items-center justify-content-between mb-4"><h1 class="h3 mb-0">Operations Dashboard</h1><div><button class="btn btn-sm btn-primary me-2"><i class="bi bi-gear-fill"></i> Customize Dashboard
</button><button class="btn btn-sm btn-outline-primary"><i class="bi bi-cloud-download"></i> Export Report
</button></div></div><div class="row mb-4"><div class="col-xl-3 col-md-6 mb-4"><div class="card card-dashboard h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3"><h6 class="text-uppercase text-muted mb-0">Active Assets</h6><div class="badge bg-primary">Fleet</div></div><div class="d-flex align-items-center"><div class="stats-counter">{{ active_assets }}</div><div class="trend-indicator trend-up ms-2"><i class="bi bi-arrow-up-short"></i> 5.3%
</div></div><div class="text-muted small">Currently being tracked</div><div class="mt-3"><div class="d-flex justify-content-between mb-1 small"><span>Fleet Utilization</span><span>76%</span></div><div class="progress"><div class="progress-bar bg-primary" role="progressbar" style="width: 76%;" aria-valuenow="76" aria-valuemin="0" aria-valuemax="100"></div></div></div></div></div></div><div class="col-xl-3 col-md-6 mb-4"><div class="card card-dashboard h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3"><h6 class="text-uppercase text-muted mb-0">Driver Alerts</h6><div class="badge bg-danger">Today</div></div><div class="row text-center"><div class="col-4"><div class="status-count text-danger">{{ late_starts }}</div><div class="small text-muted">Late Starts</div><div class="sparkline-container" id="lateStartsSparkline"></div></div><div class="col-4"><div class="status-count text-warning">{{ early_ends }}</div><div class="small text-muted">Early Ends</div><div class="sparkline-container" id="earlyEndsSparkline"></div></div><div class="col-4"><div class="status-count text-info">{{ not_on_job }}</div><div class="small text-muted">Not On Job</div><div class="sparkline-container" id="notOnJobSparkline"></div></div></div><div class="mt-3"><a href="#" class="btn btn-sm btn-outline-primary w-100">View Detailed Report</a></div></div></div></div><div class="col-xl-3 col-md-6 mb-4"><div class="card card-dashboard h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3"><h6 class="text-uppercase text-muted mb-0">System Status</h6><div class="badge bg-success">Healthy</div></div><div class="mb-3"><div class="d-flex justify-content-between mb-1 small"><span><i class="bi bi-database-check me-1"></i> Database</span><span class="text-success">Connected</span></div><div class="progress progress-thin"><div class="progress-bar bg-success" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div></div></div><div class="mb-3"><div class="d-flex justify-content-between mb-1 small"><span><i class="bi bi-cloud-check me-1"></i> API Status</span><span class="text-success">Online</span></div><div class="progress progress-thin"><div class="progress-bar bg-success" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div></div></div><div><div class="d-flex justify-content-between mb-1 small"><span><i class="bi bi-gpu-card me-1"></i> Job Processing</span><span class="text-success">Active</span></div><div class="progress progress-thin"><div class="progress-bar bg-success" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div></div></div></div></div></div><div class="col-xl-3 col-md-6 mb-4"><div class="card card-dashboard h-100"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3"><h6 class="text-uppercase text-muted mb-0">Quick Stats</h6><div class="badge bg-info">Today</div></div><div class="row"><div class="col-12"><div class="quick-stat bg-primary-subtle mb-2"><div class="d-flex justify-content-between"><div><div class="small text-muted">PM Allocations</div><div class="fw-bold">${{ pm_allocation_total|default('258,742', true)|format_number }}</div></div><div class="fs-4 text-primary"><i class="bi bi-file-earmark-spreadsheet"></i></div></div></div><div class="quick-stat bg-success-subtle mb-2"><div class="d-flex justify-content-between"><div><div class="small text-muted">Active Jobs</div><div class="fw-bold">{{ active_jobs|default('6', true) }}</div></div><div class="fs-4 text-success"><i class="bi bi-building"></i></div></div></div><div class="quick-stat bg-info-subtle"><div class="d-flex justify-content-between"><div><div class="small text-muted">Processing Queue</div><div class="fw-bold">{{ processing_queue|default('2', true) }} Tasks</div></div><div class="fs-4 text-info"><i class="bi bi-hourglass-split"></i></div></div></div></div></div></div></div></div></div><div class="row"><div class="col-lg-8"><div class="card shadow-sm mb-4"><div class="card-header bg-primary text-white py-3"><h6 class="m-0 font-weight-bold">Asset Locations</h6></div><div class="card-body"><div id="assetMap" class="mini-map"></div><div class="row mt-3"><div class="col-md-3 col-6 text-center"><div class="badge-pill-lg bg-primary-subtle text-primary mb-1">{{ excavator_count|default('3', true) }}</div><div class="small text-muted">Excavators</div></div><div class="col-md-3 col-6 text-center"><div class="badge-pill-lg bg-success-subtle text-success mb-1">{{ loader_count|default('2', true) }}</div><div class="small text-muted">Loaders</div></div><div class="col-md-3 col-6 text-center"><div class="badge-pill-lg bg-danger-subtle text-danger mb-1">{{ dozer_count|default('2', true) }}</div><div class="small text-muted">Dozers</div></div><div class="col-md-3 col-6 text-center"><div class="badge-pill-lg bg-info-subtle text-info mb-1">{{ truck_count|default('5', true) }}</div><div class="small text-muted">Trucks</div></div></div></div></div><div class="card shadow-sm mb-4"><div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center"><h6 class="m-0 font-weight-bold">Recent Activity</h6><a href="#" class="btn btn-sm btn-light">View All</a></div><div class="card-body p-0"><div class="list-group list-group-flush">
{% for activity in recent_activities %}
<div class="list-group-item list-group-item-action recent-activity-item"><div class="d-flex align-items-center"><div class="activity-icon activity-{{ activity.status|lower }} me-3"><i class="bi {{ activity.icon }}"></i></div><div class="flex-grow-1"><div class="d-flex justify-content-between"><h6 class="mb-0">{{ activity.type }}</h6><small class="text-muted">{{ activity.timestamp }}</small></div><small>{{ activity.description }}</small><div class="d-flex mt-1"><span class="badge bg-secondary me-2">{{ activity.asset_id }}</span><span class="badge bg-info">{{ activity.job_number }}</span></div></div></div></div>
{% endfor %}
</div></div></div></div><div class="col-lg-4"><div class="card shadow-sm mb-4"><div class="card-header bg-primary text-white py-3"><h6 class="m-0 font-weight-bold">Equipment Utilization</h6></div><div class="card-body"><canvas id="utilizationChart" class="utilization-chart"></canvas><div class="mt-3"><div class="d-flex justify-content-between mb-1 small"><span class="fw-bold">Overall Fleet Utilization</span><span>76%</span></div><div class="progress mb-3"><div class="progress-bar bg-primary" role="progressbar" style="width: 76%;" aria-valuenow="76" aria-valuemin="0" aria-valuemax="100"></div></div><div class="d-flex justify-content-between mb-1 small"><span>Target</span><span>80%</span></div><div class="progress progress-thin"><div class="progress-bar bg-success" role="progressbar" style="width: 80%;" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"></div></div></div></div></div><div class="card shadow-sm mb-4"><div class="card-header bg-primary text-white py-3"><h6 class="m-0 font-weight-bold">Quick Actions</h6></div><div class="card-body"><div class="list-group"><a href="#" class="list-group-item list-group-item-action d-flex align-items-center"><div class="me-3 text-primary fs-5"><i class="bi bi-file-earmark-text"></i></div><div><div class="fw-bold">Generate Daily Driver Report</div><small class="text-muted">Create a summary of all driver activity</small></div></a><a href="#" class="list-group-item list-group-item-action d-flex align-items-center"><div class="me-3 text-success fs-5"><i class="bi bi-gear"></i></div><div><div class="fw-bold">Process New Allocation Files</div><small class="text-muted">Upload and process new PM allocation spreadsheets</small></div></a><a href="#" class="list-group-item list-group-item-action d-flex align-items-center"><div class="me-3 text-info fs-5"><i class="bi bi-geo-alt"></i></div><div><div class="fw-bold">Manage Job Assignments</div><small class="text-muted">View and update equipment job assignments</small></div></a><a href="#" class="list-group-item list-group-item-action d-flex align-items-center"><div class="me-3 text-danger fs-5"><i class="bi bi-clock-history"></i></div><div><div class="fw-bold">View Equipment Lifecycle</div><small class="text-muted">Track equipment usage and maintenance history</small></div></a></div></div></div></div></div></div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script><script>
document.addEventListener('DOMContentLoaded', function() {
// Initialize the asset map
var map = L.map('assetMap').setView([32.7767, -96.7970], 10); // Dallas area as default

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Sample asset locations
var assetLocations = [
{id: 'EX-65', type: 'Excavator', lat: 32.7865, lng: -96.7986, job: '2024-019'},
{id: 'EX-74', type: 'Excavator', lat: 32.7516, lng: -96.8339, job: '2023-032'},
{id: 'LD-45', type: 'Loader', lat: 32.8075, lng: -96.8148, job: '2024-016'},
{id: 'DZ-31', type: 'Dozer', lat: 32.7641, lng: -96.7596, job: '2023-034'},
{id: 'TK-103', type: 'Truck', lat: 32.7972, lng: -96.8192, job: '2024-025'}
];

// Add markers for each asset
assetLocations.forEach(function(asset) {
var marker = L.marker([asset.lat, asset.lng]).addTo(map);
marker.bindPopup(`<b>${asset.id}</b><br>${asset.type}<br>Job: ${asset.job}`);
});

// Create sparkline charts for driver alerts
function createSparkline(elementId, data, color) {
var ctx = document.getElementById(elementId).getContext('2d');
return new Chart(ctx, {
type: 'line',
data: {
labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
datasets: [{
data: data,
borderColor: color,
backgroundColor: color + '20',
tension: 0.4,
borderWidth: 2,
pointRadius: 0,
fill: true
}]
},
options: {
responsive: true,
plugins: {
legend: {
display: false
},
tooltip: {
enabled: false
}
},
scales: {
x: {
display: false
},
y: {
display: false
}
},
maintainAspectRatio: false
}
});
}

// Create sparklines for driver alerts
createSparkline('lateStartsSparkline', [8, 5, 7, 6, 9, 4, 7], '#e74a3b');
createSparkline('earlyEndsSparkline', [4, 6, 5, 3, 7, 2, 4], '#f6c23e');
createSparkline('notOnJobSparkline', [2, 3, 1, 4, 2, 0, 3], '#36b9cc');

// Create utilization chart
var utilizationCtx = document.getElementById('utilizationChart').getContext('2d');
var utilizationChart = new Chart(utilizationCtx, {
type: 'doughnut',
data: {
labels: ['Excavators', 'Loaders', 'Dozers', 'Trucks', 'Backhoes'],
datasets: [{
data: [85, 72, 68, 80, 65],
backgroundColor: [
'#4e73df',
'#1cc88a',
'#e74a3b',
'#36b9cc',
'#f6c23e'
],
hoverOffset: 4
}]
},
options: {
responsive: true,
plugins: {
legend: {
position: 'bottom'
},
tooltip: {
callbacks: {
label: function(context) {
var label = context.label || '';
var value = context.raw || 0;
return `${label}: ${value}% Utilization`;
}
}
}
},
cutout: '70%'
}
});

// Make card links clickable
document.querySelectorAll('.card-dashboard').forEach(function(card) {
card.addEventListener('click', function(e) {
// Prevent clicking on buttons inside the card from triggering the card click
if (!e.target.closest('.btn')) {
// Extract the card type and navigate to the appropriate page
var cardTitle = this.querySelector('.text-uppercase').textContent.toLowerCase();
if (cardTitle.includes('assets')) {
window.location.href = '/assets';
} else if (cardTitle.includes('driver')) {
window.location.href = '/driver-reports';
} else if (cardTitle.includes('system')) {
window.location.href = '/system-status';
} else if (cardTitle.includes('quick stats')) {
window.location.href = '/reports';
}
}
});
});
});
</script>
{% endblock %}
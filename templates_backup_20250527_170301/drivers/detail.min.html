{% extends "layout.html" %}

{% block title %}Driver Details{% endblock %}

{% block content %}
<div class="container-fluid my-4"><div class="row mb-4"><div class="col-12"><nav aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="{{ url_for('driver_module.driver_list') }}">Drivers</a></li><li class="breadcrumb-item active" aria-current="page">{{ driver.name }}</li></ol></nav><div class="d-flex justify-content-between align-items-center"><h1 class="display-5 mb-2"><i class="bi bi-person-vcard me-2"></i>{{ driver.name }}
</h1><div class="btn-group" role="group"><button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#edit-driver-modal"><i class="bi bi-pencil me-1"></i> Edit
</button><a href="{{ url_for('driver_module.driver_list') }}" class="btn btn-outline-primary"><i class="bi bi-arrow-left me-1"></i> Back to List
</a></div></div></div></div><div class="row"><div class="col-md-4 mb-4"><div class="card shadow-sm h-100"><div class="card-header bg-primary text-white"><h5 class="card-title mb-0"><i class="bi bi-person-badge me-1"></i> Driver Information
</h5></div><div class="card-body"><div class="text-center mb-4"><div class="display-1 mb-3"><i class="bi bi-person-circle text-primary"></i></div><h3>{{ driver.name }}</h3><p class="text-muted mb-0">{{ driver.employee_id }}</p><p class="mb-0">{{ driver.department }} - {{ driver.region }} Region</p></div><div class="list-group list-group-flush"><div class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-envelope me-2"></i> Email</span><span class="text-primary">{{ driver.email }}</span></div><div class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-telephone me-2"></i> Phone</span><span class="text-primary">{{ driver.phone }}</span></div><div class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-calendar-date me-2"></i> Hire Date</span><span>{{ driver.hire_date }}</span></div><div class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-truck me-2"></i> Assigned Asset</span><span>{{ driver.assigned_asset }}</span></div><div class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-credit-card-2-front me-2"></i> License</span><span>{{ driver.license_number }}</span></div><div class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-calendar-x me-2"></i> License Expiry</span><span>{{ driver.license_expiration }}</span></div></div></div><div class="card-footer"><div class="d-grid gap-2"><button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#reassign-asset-modal"><i class="bi bi-truck me-1"></i> Reassign Asset
</button></div></div></div></div><div class="col-md-8 mb-4"><div class="card shadow-sm mb-4"><div class="card-header bg-primary text-white"><h5 class="card-title mb-0"><i class="bi bi-graph-up me-1"></i> Attendance Summary
</h5></div><div class="card-body"><div class="row mb-4"><div class="col-md-3 col-sm-6 mb-3 mb-md-0"><div class="card bg-danger text-white h-100"><div class="card-body text-center p-3"><h2 class="display-4 mb-0">{{ late_starts|length }}</h2><p class="mb-0">Late Starts</p></div></div></div><div class="col-md-3 col-sm-6 mb-3 mb-md-0"><div class="card bg-warning text-dark h-100"><div class="card-body text-center p-3"><h2 class="display-4 mb-0">{{ early_ends|length }}</h2><p class="mb-0">Early Ends</p></div></div></div><div class="col-md-3 col-sm-6 mb-3 mb-md-0"><div class="card bg-info text-white h-100"><div class="card-body text-center p-3"><h2 class="display-4 mb-0">{{ not_on_job|length }}</h2><p class="mb-0">Not On Job</p></div></div></div><div class="col-md-3 col-sm-6"><div class="card bg-success text-white h-100"><div class="card-body text-center p-3"><h2 class="display-4 mb-0">{{ 30 - (late_starts|length + early_ends|length + not_on_job|length) }}</h2><p class="mb-0">On Time Days</p></div></div></div></div><div class="attendance-chart-container"><canvas id="attendance-trend-chart" height="250"></canvas></div></div></div><div class="card shadow-sm"><div class="card-header bg-primary text-white"><h5 class="card-title mb-0"><i class="bi bi-exclamation-triangle me-1"></i> Recent Incidents
</h5></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-striped table-hover mb-0"><thead><tr><th>Date</th><th>Type</th><th>Job Site</th><th>Expected</th><th>Actual</th><th>Difference</th><th>Notes</th></tr></thead><tbody>
{% for incident in late_starts %}
<tr><td>{{ incident.date }}</td><td><span class="badge bg-danger">Late Start</span></td><td>{{ incident.job_site }}</td><td>{{ incident.expected_time }}</td><td>{{ incident.actual_time }}</td><td>{{ incident.minutes_late }} min</td><td>{{ incident.notes }}</td></tr>
{% endfor %}

{% for incident in early_ends %}
<tr><td>{{ incident.date }}</td><td><span class="badge bg-warning text-dark">Early End</span></td><td>{{ incident.job_site }}</td><td>{{ incident.expected_time }}</td><td>{{ incident.actual_time }}</td><td>{{ incident.minutes_early }} min</td><td>{{ incident.notes }}</td></tr>
{% endfor %}

{% for incident in not_on_job %}
<tr><td>{{ incident.date }}</td><td><span class="badge bg-info">Not On Job</span></td><td>{{ incident.expected_job_site }}</td><td>{{ incident.expected_job_site }}</td><td>{{ incident.actual_job_site }}</td><td>--</td><td>{{ incident.notes }}</td></tr>
{% endfor %}

{% if not late_starts and not early_ends and not not_on_job %}
<tr><td colspan="7" class="text-center">No incidents recorded</td></tr>
{% endif %}
</tbody></table></div></div></div></div></div></div><div class="modal fade" id="edit-driver-modal" tabindex="-1" aria-labelledby="edit-driver-modal-label" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title" id="edit-driver-modal-label"><i class="bi bi-pencil me-1"></i> Edit Driver
</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="edit-driver-form" class="row g-3"><div class="col-md-6"><label for="edit-driver-name" class="form-label">Full Name</label><input type="text" class="form-control" id="edit-driver-name" value="{{ driver.name }}" required></div><div class="col-md-6"><label for="edit-driver-employee-id" class="form-label">Employee ID</label><input type="text" class="form-control" id="edit-driver-employee-id" value="{{ driver.employee_id }}" required></div><div class="col-md-6"><label for="edit-driver-email" class="form-label">Email</label><input type="email" class="form-control" id="edit-driver-email" value="{{ driver.email }}" required></div><div class="col-md-6"><label for="edit-driver-phone" class="form-label">Phone</label><input type="tel" class="form-control" id="edit-driver-phone" value="{{ driver.phone }}" required></div><div class="col-md-6"><label for="edit-driver-department" class="form-label">Department</label><select class="form-select" id="edit-driver-department" required><option value="Construction" {% if driver.department == 'Construction' %}selected{% endif %}>Construction</option><option value="Transportation" {% if driver.department == 'Transportation' %}selected{% endif %}>Transportation</option></select></div><div class="col-md-6"><label for="edit-driver-region" class="form-label">Region</label><select class="form-select" id="edit-driver-region" required><option value="North" {% if driver.region == 'North' %}selected{% endif %}>North</option><option value="South" {% if driver.region == 'South' %}selected{% endif %}>South</option><option value="East" {% if driver.region == 'East' %}selected{% endif %}>East</option><option value="West" {% if driver.region == 'West' %}selected{% endif %}>West</option></select></div><div class="col-md-6"><label for="edit-driver-hire-date" class="form-label">Hire Date</label><input type="date" class="form-control" id="edit-driver-hire-date" value="{{ driver.hire_date }}" required></div><div class="col-md-6"><label for="edit-driver-asset" class="form-label">Assigned Asset</label><select class="form-select" id="edit-driver-asset"><option value="" {% if not driver.assigned_asset %}selected{% endif %}>None</option><option value="Truck 101" {% if driver.assigned_asset == 'Truck 101' %}selected{% endif %}>Truck 101</option><option value="Truck 102" {% if driver.assigned_asset == 'Truck 102' %}selected{% endif %}>Truck 102</option><option value="Excavator 203" {% if driver.assigned_asset == 'Excavator 203' %}selected{% endif %}>Excavator 203</option><option value="Loader 410" {% if driver.assigned_asset == 'Loader 410' %}selected{% endif %}>Loader 410</option></select></div><div class="col-md-6"><label for="edit-driver-license" class="form-label">License Number</label><input type="text" class="form-control" id="edit-driver-license" value="{{ driver.license_number }}" required></div><div class="col-md-6"><label for="edit-driver-license-expiry" class="form-label">License Expiration</label><input type="date" class="form-control" id="edit-driver-license-expiry" value="{{ driver.license_expiration }}" required></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-warning" id="update-driver-btn"><i class="bi bi-save me-1"></i> Save Changes
</button></div></div></div></div><div class="modal fade" id="reassign-asset-modal" tabindex="-1" aria-labelledby="reassign-asset-modal-label" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="reassign-asset-modal-label"><i class="bi bi-truck me-1"></i> Reassign Asset
</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="reassign-asset-form"><div class="mb-3"><label for="current-asset" class="form-label">Current Asset</label><input type="text" class="form-control" id="current-asset" value="{{ driver.assigned_asset }}" readonly></div><div class="mb-3"><label for="new-asset" class="form-label">New Asset</label><select class="form-select" id="new-asset" required><option value="" selected disabled>Select Asset</option><option value="Truck 101">Truck 101</option><option value="Truck 102">Truck 102</option><option value="Truck 103">Truck 103</option><option value="Excavator 203">Excavator 203</option><option value="Excavator 204">Excavator 204</option><option value="Loader 410">Loader 410</option><option value="Loader 411">Loader 411</option><option value="Bulldozer 305">Bulldozer 305</option></select></div><div class="mb-3"><label for="reassign-date" class="form-label">Effective Date</label><input type="date" class="form-control" id="reassign-date" required></div><div class="mb-3"><label for="reassign-notes" class="form-label">Notes</label><textarea class="form-control" id="reassign-notes" rows="3"></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="confirm-reassign-btn"><i class="bi bi-check2 me-1"></i> Confirm Reassignment
</button></div></div></div></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script><script>
document.addEventListener('DOMContentLoaded', function() {
// Attendance Trend Chart
const trendCtx = document.getElementById('attendance-trend-chart').getContext('2d');
new Chart(trendCtx, {
type: 'line',
data: {
labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
datasets: [
{
label: 'Late Starts',
data: [2, 1, 0, 0],
borderColor: '#dc3545',
backgroundColor: 'rgba(220, 53, 69, 0.1)',
borderWidth: 2,
tension: 0.1
},
{
label: 'Early Ends',
data: [1, 0, 1, 1],
borderColor: '#ffc107',
backgroundColor: 'rgba(255, 193, 7, 0.1)',
borderWidth: 2,
tension: 0.1
},
{
label: 'Not On Job',
data: [0, 1, 0, 0],
borderColor: '#17a2b8',
backgroundColor: 'rgba(23, 162, 184, 0.1)',
borderWidth: 2,
tension: 0.1
}
]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'top',
},
title: {
display: true,
text: 'Monthly Attendance Trend'
}
},
scales: {
y: {
beginAtZero: true,
title: {
display: true,
text: 'Incidents'
}
}
}
}
});

// Update driver form handling
const updateDriverBtn = document.getElementById('update-driver-btn');
const editDriverForm = document.getElementById('edit-driver-form');
const editDriverModal = new bootstrap.Modal(document.getElementById('edit-driver-modal'));

updateDriverBtn.addEventListener('click', function() {
// Check form validity
if (!editDriverForm.checkValidity()) {
editDriverForm.reportValidity();
return;
}

// In a real implementation, this would send a request to update the driver
// For demonstration, we'll just show a success message
editDriverModal.hide();

// Show success message
alert('Driver updated successfully');

// Reload page to show updated info (in a real app, we'd update the UI directly)
// window.location.reload();
});

// Reassign asset form handling
const confirmReassignBtn = document.getElementById('confirm-reassign-btn');
const reassignAssetForm = document.getElementById('reassign-asset-form');
const reassignAssetModal = new bootstrap.Modal(document.getElementById('reassign-asset-modal'));

confirmReassignBtn.addEventListener('click', function() {
// Check form validity
if (!reassignAssetForm.checkValidity()) {
reassignAssetForm.reportValidity();
return;
}

// In a real implementation, this would send a request to reassign the asset
// For demonstration, we'll just show a success message
reassignAssetModal.hide();

// Show success message
alert('Asset reassigned successfully');

// Reload page to show updated info (in a real app, we'd update the UI directly)
// window.location.reload();
});
});
</script>
{% endblock %}
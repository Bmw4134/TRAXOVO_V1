{% extends "layout.html" %}

{% block title %}Vehicle History Audit | TRAXORA{% endblock %}

{% block content %}
<div class="container mt-4"><div class="row"><div class="col-12"><h1 class="mb-4">Vehicle History Audit</h1><div class="card mb-4"><div class="card-header"><h5 class="card-title">Search Vehicle or Driver History</h5></div><div class="card-body"><form method="GET" action="{{ url_for('driver_module.vehicle_audit') }}"><div class="row"><div class="col-md-6"><div class="mb-3"><label for="search" class="form-label">Search Term</label><input type="text" class="form-control" id="search" name="search"
placeholder="Enter vehicle ID (ET-01) or driver name"
value="{{ search_term }}"><div class="form-text">
Search for a specific vehicle ID (e.g., ET-01, PT-123) or driver name
</div></div></div><div class="col-md-4"><div class="mb-3"><label for="date_range" class="form-label">Date Range</label><select class="form-select" id="date_range" name="date_range"><option value="7" {% if date_range == '7' %}selected{% endif %}>Last 7 days</option><option value="14" {% if date_range == '14' %}selected{% endif %}>Last 14 days</option><option value="30" {% if date_range == '30' %}selected{% endif %}>Last 30 days</option><option value="90" {% if date_range == '90' %}selected{% endif %}>Last 90 days</option><option value="180" {% if date_range == '180' %}selected{% endif %}>Last 6 months</option><option value="365" {% if date_range == '365' %}selected{% endif %}>Last year</option></select></div></div><div class="col-md-2 d-flex align-items-end"><button type="submit" class="btn btn-primary w-100 mb-3"><i class="bi bi-search"></i> Search
</button></div></div></form></div></div>

{% if search_term %}
<div class="card mb-4"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="card-title mb-0">Search Results</h5><div>
{% if audit_data %}
<a href="{{ url_for('driver_module.export_audit', type='vehicle', term=search_term, start_date=start_date, end_date=end_date) }}"
class="btn btn-sm btn-success"><i class="bi bi-file-excel"></i> Export to Excel
</a><a href="{{ url_for('driver_module.export_audit', type='vehicle', term=search_term, start_date=start_date, end_date=end_date, format='pdf') }}"
class="btn btn-sm btn-danger"><i class="bi bi-file-pdf"></i> Export to PDF
</a>
{% endif %}
</div></div><div class="card-body"><div class="table-responsive"><table class="table table-striped table-hover"><thead><tr><th>Asset ID</th><th>Vehicle Type</th><th>Driver</th><th>Date</th><th>Start Time</th><th>End Time</th><th>Location</th><th>Job Site</th><th>Division</th></tr></thead><tbody>
{% if audit_data %}
{% for item in audit_data %}
<tr><td>{{ item.asset_id }}</td><td>{{ item.vehicle_type }}</td><td>{{ item.driver }}</td><td>{{ item.date }}</td><td>{{ item.start_time }}</td><td>{{ item.end_time }}</td><td>{{ item.location }}</td><td>{{ item.job_site }}</td><td>{{ item.division }}</td></tr>
{% endfor %}
{% else %}
<tr><td colspan="9" class="text-center">No records found for "{{ search_term }}" in the selected date range.</td></tr>
{% endif %}
</tbody></table></div></div></div>

{% if audit_data %}
<div class="card mb-4"><div class="card-header"><h5 class="card-title">Statistics and Insights</h5></div><div class="card-body"><div class="row"><div class="col-md-6"><div class="card mb-3"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">Usage Summary</h6><p><strong>Total Records:</strong> {{ audit_data|length }}<br><strong>Date Range:</strong> {{ start_date }} to {{ end_date }}<br><strong>Average Daily Usage:</strong> {{ (audit_data|length / date_range|int)|round(1) }} days
</p></div></div></div><div class="col-md-6"><div class="card mb-3"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">Job Site Distribution</h6><p>Most common job sites visited by this vehicle/driver.</p><ul class="list-group list-group-flush"><li class="list-group-item d-flex justify-content-between align-items-center">
Fort Worth Municipal
<span class="badge bg-primary rounded-pill">{{ audit_data|length }}</span></li></ul></div></div></div></div></div></div>
{% endif %}
{% else %}
<div class="alert alert-info"><p class="mb-0"><i class="bi bi-info-circle"></i>
Enter a vehicle ID or driver name in the search box above to view their history.
</p></div>
{% endif %}
</div></div></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
// Any client-side logic for the audit page
});
</script>
{% endblock %}
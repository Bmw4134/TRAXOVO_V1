{% extends 'base.html' %}

{% block title %}Real-Time Geolocation Tracking{% endblock %}

{% block styles %}
<link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .map-container {
        height: calc(100vh - 230px);
        min-height: 500px;
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .asset-marker {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        overflow: visible;
        position: relative;
        transition: transform 0.3s ease, filter 0.3s ease;
        z-index: 900;
    }
    
    .asset-marker:hover {
        transform: scale(1.2);
        z-index: 1000;
        filter: brightness(1.2);
    }
    
    .marker-excavator {
        background-color: #ffc107;
    }
    
    .marker-loader {
        background-color: #28a745;
    }
    
    .marker-dozer {
        background-color: #dc3545;
    }
    
    .marker-truck {
        background-color: #007bff;
    }
    
    .marker-pickup {
        background-color: #6f42c1;
    }
    
    .marker-icon {
        font-size: 20px;
        color: white;
    }
    
    .asset-pulse {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        animation: pulse 2s infinite;
        opacity: 0;
        background-color: inherit;
    }
    
    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 0.7;
        }
        70% {
            transform: scale(2);
            opacity: 0;
        }
        100% {
            transform: scale(2.5);
            opacity: 0;
        }
    }
    
    .asset-controls {
        position: relative;
        z-index: 1000;
        background-color: rgba(0,0,0,0.7);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .status-active {
        background-color: #28a745;
        box-shadow: 0 0 8px #28a745;
    }
    
    .status-idle {
        background-color: #ffc107;
        box-shadow: 0 0 8px #ffc107;
    }
    
    .status-maintenance {
        background-color: #dc3545;
        box-shadow: 0 0 8px #dc3545;
    }
    
    .asset-detail-card {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 300px;
        z-index: 1000;
        display: none;
    }
    
    .marker-label {
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 10px;
        white-space: nowrap;
    }
    
    .asset-trail {
        stroke-dasharray: 5, 5;
        animation: dash 30s linear infinite;
        stroke-width: 2;
    }
    
    @keyframes dash {
        to {
            stroke-dashoffset: -1000;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-white-800">
            <i class="bi bi-geo-alt-fill me-2"></i>Real-Time Asset Tracking
        </h1>
        <div class="d-flex align-items-center">
            <span class="me-3">Auto-refresh: </span>
            <div class="form-check form-switch me-3">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                <label class="form-check-label" for="autoRefreshToggle">ON</label>
            </div>
            <button id="refreshBtn" class="btn btn-primary">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh Now
            </button>
        </div>
    </div>
    
    <!-- Filters and Map -->
    <div class="row">
        <!-- Filters Column -->
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-funnel me-1"></i> Filters</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="divisionFilter" class="form-label">Division</label>
                        <select id="divisionFilter" class="form-select">
                            <option value="all" selected>All Divisions</option>
                            <option value="dfw">DFW</option>
                            <option value="hou">HOU</option>
                            <option value="wtx">WTX</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="assetTypeFilter" class="form-label">Asset Type</label>
                        <select id="assetTypeFilter" class="form-select">
                            <option value="all" selected>All Types</option>
                            <option value="excavator">Excavators</option>
                            <option value="loader">Loaders</option>
                            <option value="dozer">Dozers</option>
                            <option value="truck">Trucks</option>
                            <option value="pickup">Pickups</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select id="statusFilter" class="form-select">
                            <option value="all" selected>All Statuses</option>
                            <option value="active">Active</option>
                            <option value="idle">Idle</option>
                            <option value="maintenance">Maintenance</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="assetSearch" class="form-label">Search</label>
                        <input type="text" id="assetSearch" class="form-control" placeholder="Search by ID or name...">
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="showTrailsToggle" checked>
                        <label class="form-check-label" for="showTrailsToggle">Show Movement Trails</label>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="showAnimationsToggle" checked>
                        <label class="form-check-label" for="showAnimationsToggle">Show Animations</label>
                    </div>
                    
                    <div class="d-grid">
                        <button id="applyFiltersBtn" class="btn btn-success">
                            <i class="bi bi-funnel-fill me-1"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Column -->
        <div class="col-md-9 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-map me-1"></i> Asset Map</h5>
                    <div>
                        <span class="badge bg-success me-2">Active: <span id="activeCount">0</span></span>
                        <span class="badge bg-warning text-dark me-2">Idle: <span id="idleCount">0</span></span>
                        <span class="badge bg-danger me-2">Maintenance: <span id="maintenanceCount">0</span></span>
                        <span class="badge bg-secondary">Total: <span id="totalCount">0</span></span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="assetMap" class="map-container"></div>
                    
                    <!-- Asset Detail Card (initially hidden) -->
                    <div id="assetDetailCard" class="card asset-detail-card shadow-sm">
                        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-truck me-1"></i> <span id="detailAssetId"></span></h6>
                            <button type="button" class="btn-close btn-close-white" onclick="hideAssetDetail()"></button>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <strong>Type:</strong> <span id="detailAssetType"></span>
                            </div>
                            <div class="mb-2">
                                <strong>Status:</strong> <span id="detailAssetStatus"></span>
                            </div>
                            <div class="mb-2">
                                <strong>Driver:</strong> <span id="detailAssetDriver"></span>
                            </div>
                            <div class="mb-2">
                                <strong>Job Site:</strong> <span id="detailAssetJobSite"></span>
                            </div>
                            <div class="mb-2">
                                <strong>Last Updated:</strong> <span id="detailAssetLastUpdate"></span>
                            </div>
                            <div class="mb-2">
                                <strong>Speed:</strong> <span id="detailAssetSpeed"></span> mph
                            </div>
                            <div class="mb-2">
                                <strong>Coordinates:</strong> <span id="detailAssetCoordinates"></span>
                            </div>
                            <div class="d-grid gap-2 mt-3">
                                <button class="btn btn-sm btn-primary" onclick="centerMapOnAsset()">
                                    <i class="bi bi-geo me-1"></i> Center on Map
                                </button>
                                <a id="assetDetailLink" href="#" class="btn btn-sm btn-info">
                                    <i class="bi bi-file-earmark-text me-1"></i> View Full Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Last Update Info -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Last data update: <span id="lastUpdateTime"></span>
                </div>
                <div>
                    <span class="badge bg-info me-2">Data source: Gauge API</span>
                    <span id="updateStatus" class="badge bg-success">Live</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // Map and marker initialization
    let map;
    let markers = {};
    let assetTrails = {};
    let selectedAsset = null;
    let refreshTimer;
    let lastPositions = {};
    
    // Define asset marker styles
    const markerTypes = {
        excavator: { icon: 'bi-truck', color: '#ffc107' },
        loader: { icon: 'bi-truck', color: '#28a745' },
        dozer: { icon: 'bi-truck', color: '#dc3545' },
        truck: { icon: 'bi-truck', color: '#007bff' },
        pickup: { icon: 'bi-car-front', color: '#6f42c1' },
        unknown: { icon: 'bi-geo-alt', color: '#6c757d' }
    };
    
    // Initialize map when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the map
        map = L.map('assetMap').setView([32.7767, -96.7970], 10); // Dallas area as default
        
        // Add tile layer (Map background)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Initial data load
        loadAssetData();
        
        // Set up refresh timer
        setupAutoRefresh();
        
        // Add event listeners
        document.getElementById('refreshBtn').addEventListener('click', loadAssetData);
        document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
        document.getElementById('autoRefreshToggle').addEventListener('change', setupAutoRefresh);
        
        // Update the last update time
        updateLastUpdateTime();
    });
    
    // Load asset data from API
    function loadAssetData() {
        // Show loading indication
        document.getElementById('updateStatus').textContent = 'Updating...';
        document.getElementById('updateStatus').className = 'badge bg-warning text-dark';
        
        // Clear existing refresh timer
        if (refreshTimer) {
            clearTimeout(refreshTimer);
        }
        
        // Fetch asset data from server with sample=true parameter to ensure we get data
        fetch('/geo-tracking/api/asset-locations?sample=true')
            .then(response => response.json())
            .then(data => {
                // Update asset markers
                if (data.status === 'success' && data.assets && data.assets.length > 0) {
                    updateAssetMarkers(data.assets);
                    
                    // Update counts
                    updateAssetCounts(data.assets);
                    
                    // Update last update time
                    updateLastUpdateTime();
                    
                    // Set status to live
                    document.getElementById('updateStatus').textContent = data.source === 'sample' ? 'Sample' : 'Live';
                    document.getElementById('updateStatus').className = data.source === 'sample' ? 'badge bg-warning text-dark' : 'badge bg-success';
                } else {
                    console.error('No asset data received:', data);
                    document.getElementById('updateStatus').textContent = 'No Data';
                    document.getElementById('updateStatus').className = 'badge bg-danger';
                }
                
                // Setup next refresh if auto-refresh is enabled
                setupAutoRefresh();
            })
            .catch(error => {
                console.error('Error fetching asset data:', error);
                document.getElementById('updateStatus').textContent = 'Error';
                document.getElementById('updateStatus').className = 'badge bg-danger';
                
                // Setup next refresh if auto-refresh is enabled
                setupAutoRefresh();
            });
    }
    
    // Update asset markers on the map
    function updateAssetMarkers(assets) {
        // Store new marker IDs to track removals
        const newMarkerIds = new Set();
        
        // Update or create markers for each asset
        assets.forEach(asset => {
            if (passesFilters(asset) && asset.latitude && asset.longitude) {
                newMarkerIds.add(asset.id);
                
                const assetType = getAssetType(asset);
                const markerStyle = markerTypes[assetType] || markerTypes.unknown;
                const isNew = !markers[asset.id];
                
                // If asset already has a marker, update its position
                if (markers[asset.id]) {
                    // Get current position
                    const currentPos = markers[asset.id].getLatLng();
                    
                    // Store last position
                    lastPositions[asset.id] = currentPos;
                    
                    // Update position
                    const newPos = [asset.latitude, asset.longitude];
                    markers[asset.id].setLatLng(newPos);
                    
                    // Update marker styling based on status
                    updateMarkerStatus(markers[asset.id], asset);
                    
                    // Update trail
                    if (document.getElementById('showTrailsToggle').checked && 
                        currentPos.lat !== asset.latitude && currentPos.lng !== asset.longitude) {
                        drawAssetTrail(asset.id, currentPos, newPos, markerStyle.color);
                    }
                } 
                // Create a new marker for this asset
                else {
                    createAssetMarker(asset, assetType, markerStyle);
                }
            }
        });
        
        // Remove markers for assets that are no longer in the data
        Object.keys(markers).forEach(markerId => {
            if (!newMarkerIds.has(markerId)) {
                // Remove marker
                map.removeLayer(markers[markerId]);
                delete markers[markerId];
                
                // Remove trail
                if (assetTrails[markerId]) {
                    assetTrails[markerId].forEach(trail => map.removeLayer(trail));
                    delete assetTrails[markerId];
                }
            }
        });
        
        // If we have a selected asset, update its detail view
        if (selectedAsset && markers[selectedAsset]) {
            const asset = assets.find(a => a.id === selectedAsset);
            if (asset) {
                updateAssetDetail(asset);
            }
        }
    }
    
    // Create a new asset marker
    function createAssetMarker(asset, assetType, markerStyle) {
        // Create custom marker HTML
        const markerHtml = `
            <div class="asset-marker marker-${assetType}" style="background-color: ${markerStyle.color}">
                <i class="bi ${markerStyle.icon} marker-icon"></i>
                <div class="asset-pulse"></div>
                <div class="marker-label">${asset.id}</div>
            </div>
        `;
        
        // Create custom icon
        const customIcon = L.divIcon({
            html: markerHtml,
            className: 'custom-div-icon',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
        
        // Create marker
        const marker = L.marker([asset.latitude, asset.longitude], {
            icon: customIcon,
            title: asset.id
        }).addTo(map);
        
        // Add click event to show details
        marker.on('click', function() {
            showAssetDetail(asset);
        });
        
        // Update marker status
        updateMarkerStatus(marker, asset);
        
        // Store marker
        markers[asset.id] = marker;
        
        // Initialize trail array
        assetTrails[asset.id] = [];
    }
    
    // Update marker appearance based on asset status
    function updateMarkerStatus(marker, asset) {
        // Determine status
        let status = 'idle';
        if (asset.status === 'active' || asset.ignition) {
            status = 'active';
        } else if (asset.status === 'maintenance') {
            status = 'maintenance';
        }
        
        // Update marker element
        const markerElement = marker.getIcon().options.html;
        const div = document.createElement('div');
        div.innerHTML = markerElement;
        
        // Update classes
        const markerDiv = div.querySelector('.asset-marker');
        markerDiv.classList.remove('status-active', 'status-idle', 'status-maintenance');
        markerDiv.classList.add(`status-${status}`);
        
        // Update pulse animation
        const pulseDiv = div.querySelector('.asset-pulse');
        pulseDiv.style.display = status === 'active' && document.getElementById('showAnimationsToggle').checked ? 'block' : 'none';
        
        // Set the updated HTML
        const newIcon = L.divIcon({
            html: div.innerHTML,
            className: 'custom-div-icon',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
        
        marker.setIcon(newIcon);
    }
    
    // Draw a trail showing asset movement
    function drawAssetTrail(assetId, fromLatLng, toLatLng, color) {
        // Create path
        const path = L.polyline([fromLatLng, toLatLng], {
            color: color,
            weight: 2,
            opacity: 0.6,
            className: 'asset-trail'
        }).addTo(map);
        
        // Add to trails array
        if (!assetTrails[assetId]) {
            assetTrails[assetId] = [];
        }
        
        // Limit the number of trail segments
        assetTrails[assetId].push(path);
        if (assetTrails[assetId].length > 5) {
            map.removeLayer(assetTrails[assetId].shift());
        }
    }
    
    // Show asset detail card
    function showAssetDetail(asset) {
        // Set selected asset
        selectedAsset = asset.id;
        
        // Update detail card
        updateAssetDetail(asset);
        
        // Show the card
        document.getElementById('assetDetailCard').style.display = 'block';
    }
    
    // Hide asset detail card
    function hideAssetDetail() {
        selectedAsset = null;
        document.getElementById('assetDetailCard').style.display = 'none';
    }
    
    // Center map on selected asset
    function centerMapOnAsset() {
        if (selectedAsset && markers[selectedAsset]) {
            map.setView(markers[selectedAsset].getLatLng(), 16);
        }
    }
    
    // Update the asset detail card
    function updateAssetDetail(asset) {
        document.getElementById('detailAssetId').textContent = asset.id;
        document.getElementById('detailAssetType').textContent = getAssetType(asset).toUpperCase();
        document.getElementById('detailAssetStatus').textContent = asset.status || (asset.ignition ? 'Active' : 'Idle');
        document.getElementById('detailAssetDriver').textContent = asset.driver || 'Unassigned';
        document.getElementById('detailAssetJobSite').textContent = asset.jobSite || 'Unknown';
        document.getElementById('detailAssetLastUpdate').textContent = formatDateTime(asset.lastUpdate || new Date());
        document.getElementById('detailAssetSpeed').textContent = asset.speed || '0';
        document.getElementById('detailAssetCoordinates').textContent = `${asset.latitude.toFixed(6)}, ${asset.longitude.toFixed(6)}`;
        document.getElementById('assetDetailLink').href = `/assets/${asset.id}`;
    }
    
    // Setup auto-refresh timer
    function setupAutoRefresh() {
        if (refreshTimer) {
            clearTimeout(refreshTimer);
        }
        
        if (document.getElementById('autoRefreshToggle').checked) {
            refreshTimer = setTimeout(loadAssetData, 30000); // Refresh every 30 seconds
        }
    }
    
    // Update asset counts on the UI
    function updateAssetCounts(assets) {
        let totalCount = 0;
        let activeCount = 0;
        let idleCount = 0;
        let maintenanceCount = 0;
        
        assets.forEach(asset => {
            if (passesFilters(asset)) {
                totalCount++;
                
                if (asset.status === 'active' || asset.ignition) {
                    activeCount++;
                } else if (asset.status === 'maintenance') {
                    maintenanceCount++;
                } else {
                    idleCount++;
                }
            }
        });
        
        document.getElementById('totalCount').textContent = totalCount;
        document.getElementById('activeCount').textContent = activeCount;
        document.getElementById('idleCount').textContent = idleCount;
        document.getElementById('maintenanceCount').textContent = maintenanceCount;
    }
    
    // Apply filters to the current view
    function applyFilters() {
        loadAssetData();
    }
    
    // Check if an asset passes current filters
    function passesFilters(asset) {
        const divisionFilter = document.getElementById('divisionFilter').value;
        const typeFilter = document.getElementById('assetTypeFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const searchText = document.getElementById('assetSearch').value.toLowerCase();
        
        // Check division filter
        if (divisionFilter !== 'all' && asset.division && 
            asset.division.toLowerCase() !== divisionFilter.toLowerCase()) {
            return false;
        }
        
        // Check type filter
        if (typeFilter !== 'all' && getAssetType(asset) !== typeFilter) {
            return false;
        }
        
        // Check status filter
        if (statusFilter !== 'all') {
            const status = asset.status || (asset.ignition ? 'active' : 'idle');
            if (status.toLowerCase() !== statusFilter.toLowerCase()) {
                return false;
            }
        }
        
        // Check search text
        if (searchText && !(
            (asset.id && asset.id.toLowerCase().includes(searchText)) ||
            (asset.name && asset.name.toLowerCase().includes(searchText)) ||
            (asset.assetId && asset.assetId.toLowerCase().includes(searchText))
        )) {
            return false;
        }
        
        return true;
    }
    
    // Get asset type for marker styling
    function getAssetType(asset) {
        if (!asset) return 'unknown';
        
        const typeLower = (asset.type || asset.assetType || '').toLowerCase();
        
        if (typeLower.includes('excavator')) return 'excavator';
        if (typeLower.includes('loader')) return 'loader';
        if (typeLower.includes('dozer')) return 'dozer';
        if (typeLower.includes('truck')) return 'truck';
        if (typeLower.includes('pickup') || typeLower.includes('car')) return 'pickup';
        
        // Check asset ID patterns
        const id = (asset.id || asset.assetId || '').toUpperCase();
        if (id.startsWith('EX')) return 'excavator';
        if (id.startsWith('LD')) return 'loader';
        if (id.startsWith('DZ')) return 'dozer';
        if (id.startsWith('TK')) return 'truck';
        if (id.startsWith('PU')) return 'pickup';
        
        return 'unknown';
    }
    
    // Format date and time for display
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', { 
            month: '2-digit',
            day: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
    }
    
    // Update the last update time
    function updateLastUpdateTime() {
        const now = new Date();
        document.getElementById('lastUpdateTime').textContent = formatDateTime(now);
    }
</script>
{% endblock %}
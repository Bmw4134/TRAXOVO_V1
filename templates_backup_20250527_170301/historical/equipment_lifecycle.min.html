{% extends "base.html" %}

{% block title %}Equipment Lifecycle Timeline{% endblock %}

{% block head %}
{{ super() }}

<script src="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.js"></script><link href="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" /><style>
.timeline-container {
width: 100%;
height: 500px;
margin-bottom: 30px;
}

.timeline-filter {
margin-bottom: 20px;
}

.equipment-card {
margin-bottom: 20px;
}

.stats-container {
display: flex;
flex-wrap: wrap;
gap: 15px;
margin-bottom: 20px;
}

.stat-card {
flex: 1;
min-width: 200px;
padding: 15px;
border-radius: 8px;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
text-align: center;
}

.viz-controls {
margin-bottom: 15px;
}

.equipment-detail {
display: none;
padding: 20px;
margin-top: 20px;
border-radius: 8px;
background-color: #f8f9fa;
}

.job-tag {
display: inline-block;
padding: 3px 8px;
margin-right: 5px;
margin-bottom: 5px;
border-radius: 4px;
font-size: 0.8rem;
color: white;
}

.selected-period {
background-color: #eaf7ff;
border: 1px solid #a8d1ff;
padding: 10px;
border-radius: 4px;
margin: 10px 0;
}

.maintenance-marker {
background-color: #ffcccc;
border-radius: 50%;
width: 15px;
height: 15px;
display: inline-block;
margin-right: 5px;
}

.timeline-tooltip {
background-color: rgba(0,0,0,0.8);
color: white;
padding: 8px 12px;
border-radius: 4px;
font-size: 12px;
max-width: 300px;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4"><h1 class="mb-4">Equipment Lifecycle Timeline</h1><div class="card shadow-sm mb-4"><div class="card-header bg-primary text-white"><h5 class="mb-0">Equipment Timeline Visualization</h5></div><div class="card-body"><div class="timeline-filter"><form id="timelineFilterForm" class="row g-3"><div class="col-md-3"><label for="equipmentFilter" class="form-label">Equipment Type</label><select id="equipmentFilter" class="form-select"><option value="all">All Equipment</option><option value="Excavator">Excavators</option><option value="Loader">Loaders</option><option value="Dozer">Dozers</option><option value="Backhoe">Backhoes</option><option value="Truck">Trucks</option></select></div><div class="col-md-3"><label for="jobFilter" class="form-label">Job Site</label><select id="jobFilter" class="form-select"><option value="all">All Job Sites</option>
{% for job in jobs %}
<option value="{{ job.job_number }}">{{ job.job_number }} - {{ job.name }}</option>
{% endfor %}
</select></div><div class="col-md-3"><label for="dateRangeStart" class="form-label">Start Date</label><input type="date" id="dateRangeStart" class="form-control" value="{{ start_date }}"></div><div class="col-md-3"><label for="dateRangeEnd" class="form-label">End Date</label><input type="date" id="dateRangeEnd" class="form-control" value="{{ end_date }}"></div><div class="col-12"><button type="submit" class="btn btn-primary">Apply Filters</button><button type="button" id="resetFilters" class="btn btn-outline-secondary">Reset</button></div></form></div><div class="timeline-container" id="equipmentTimeline"></div><div class="row viz-controls"><div class="col-md-6"><div class="btn-group" role="group"><button type="button" id="zoomIn" class="btn btn-outline-primary"><i class="fas fa-search-plus"></i> Zoom In</button><button type="button" id="zoomOut" class="btn btn-outline-primary"><i class="fas fa-search-minus"></i> Zoom Out</button><button type="button" id="moveLeft" class="btn btn-outline-primary"><i class="fas fa-arrow-left"></i></button><button type="button" id="moveRight" class="btn btn-outline-primary"><i class="fas fa-arrow-right"></i></button></div></div><div class="col-md-6 text-end"><div class="btn-group" role="group"><button type="button" id="viewDay" class="btn btn-outline-secondary">Day</button><button type="button" id="viewWeek" class="btn btn-outline-secondary">Week</button><button type="button" id="viewMonth" class="btn btn-outline-secondary active">Month</button><button type="button" id="viewAll" class="btn btn-outline-secondary">All</button></div></div></div><div class="selected-period" id="selectedPeriod" style="display: none;"><h5>Selected Period</h5><div id="selectedPeriodInfo"></div></div></div></div><div class="row"><div class="col-md-12"><div class="card shadow-sm"><div class="card-header bg-primary text-white"><h5 class="mb-0">Equipment Details</h5></div><div class="card-body"><div id="equipmentDetailPlaceholder" class="text-center py-5"><p class="text-muted mb-0">Select an equipment item on the timeline to view details</p></div><div id="equipmentDetail" class="equipment-detail"><div class="row"><div class="col-md-6"><h4 id="equipmentTitle">Equipment ID</h4><p id="equipmentDescription" class="text-muted">Equipment description</p><h5 class="mt-4">Lifecycle Statistics</h5><div class="stats-container"><div class="stat-card bg-light"><h3 id="totalDays" class="text-primary">0</h3><p class="text-muted mb-0">Total Days in Use</p></div><div class="stat-card bg-light"><h3 id="totalAmount" class="text-primary">$0</h3><p class="text-muted mb-0">Total Revenue</p></div><div class="stat-card bg-light"><h3 id="utilizationRate" class="text-primary">0%</h3><p class="text-muted mb-0">Utilization Rate</p></div></div><h5 class="mt-4">Job Site Allocation</h5><div id="jobAllocation" class="mb-4"></div></div><div class="col-md-6"><h5>Cost Code Distribution</h5><canvas id="costCodeChart" width="100%" height="250"></canvas><h5 class="mt-4">Monthly Trend</h5><canvas id="monthlyTrendChart" width="100%" height="250"></canvas></div></div></div></div></div></div></div></div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script><script>
document.addEventListener('DOMContentLoaded', function() {
// Timeline visualization
var timelineContainer = document.getElementById('equipmentTimeline');

// Generate timeline data from the server-provided data
var timelineItems = {{ timeline_data|tojson }};
var equipmentGroups = {{ equipment_groups|tojson }};

// Create the timeline
var timeline = new vis.Timeline(timelineContainer, timelineItems, equipmentGroups, {
stack: false,
maxHeight: '500px',
margin: {
item: 20,
axis: 40
},
format: {
minorLabels: {
day: 'D',
month: 'MMM YYYY',
year: 'YYYY'
},
majorLabels: {
day: 'MMMM YYYY',
month: 'YYYY',
year: ''
}
},
tooltip: {
followMouse: true,
overflowMethod: 'cap'
},
zoomMin: 1000 * 60 * 60 * 24 * 7,  // One week
zoomMax: 1000 * 60 * 60 * 24 * 365 * 2  // Two years
});

// Timeline event handlers
timeline.on('select', function(properties) {
if (properties.items.length > 0) {
var selectedId = properties.items[0];
for (var i = 0; i < timelineItems.length; i++) {
if (timelineItems[i].id == selectedId) {
showEquipmentDetail(timelineItems[i]);
break;
}
}
}
});

timeline.on('rangechanged', function(properties) {
updateSelectedPeriod(properties.start, properties.end);
});

// Timeline controls
document.getElementById('zoomIn').addEventListener('click', function() {
timeline.zoomIn(0.5);
});

document.getElementById('zoomOut').addEventListener('click', function() {
timeline.zoomOut(0.5);
});

document.getElementById('moveLeft').addEventListener('click', function() {
timeline.move(-0.2);
});

document.getElementById('moveRight').addEventListener('click', function() {
timeline.move(0.2);
});

document.getElementById('viewDay').addEventListener('click', function() {
setActiveView(this);
var now = new Date();
timeline.setWindow(
new Date(now.getFullYear(), now.getMonth(), now.getDate()),
new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1)
);
});

document.getElementById('viewWeek').addEventListener('click', function() {
setActiveView(this);
var now = new Date();
timeline.setWindow(
new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay()),
new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 7)
);
});

document.getElementById('viewMonth').addEventListener('click', function() {
setActiveView(this);
var now = new Date();
timeline.setWindow(
new Date(now.getFullYear(), now.getMonth(), 1),
new Date(now.getFullYear(), now.getMonth() + 1, 1)
);
});

document.getElementById('viewAll').addEventListener('click', function() {
setActiveView(this);
timeline.fit();
});

// Filter handling
document.getElementById('timelineFilterForm').addEventListener('submit', function(e) {
e.preventDefault();
applyFilters();
});

document.getElementById('resetFilters').addEventListener('click', function() {
document.getElementById('equipmentFilter').value = 'all';
document.getElementById('jobFilter').value = 'all';
document.getElementById('dateRangeStart').value = '{{ start_date }}';
document.getElementById('dateRangeEnd').value = '{{ end_date }}';
applyFilters();
});

// Helper functions
function setActiveView(element) {
var viewButtons = document.querySelectorAll('.viz-controls .btn-group button');
viewButtons.forEach(function(button) {
button.classList.remove('active');
});
element.classList.add('active');
}

function applyFilters() {
var equipmentType = document.getElementById('equipmentFilter').value;
var jobNumber = document.getElementById('jobFilter').value;
var startDate = document.getElementById('dateRangeStart').value;
var endDate = document.getElementById('dateRangeEnd').value;

// Filter the timeline data
var filteredItems = timelineItems.filter(function(item) {
var typeMatch = equipmentType === 'all' || item.equipmentType === equipmentType;
var jobMatch = jobNumber === 'all' || item.jobNumber === jobNumber;

// Date filtering logic would be more complex in a real implementation
// This is a simplified version
return typeMatch && jobMatch;
});

// Update the timeline
timeline.setItems(new vis.DataSet(filteredItems));

// If we have date filters, apply them
if (startDate && endDate) {
timeline.setWindow(new Date(startDate), new Date(endDate));
}
}

function updateSelectedPeriod(start, end) {
// Convert dates to readable format
var startStr = start.toDateString();
var endStr = end.toDateString();

// Calculate stats for the visible period
var visibleItems = getItemsInRange(start, end);
var totalEquipment = new Set(visibleItems.map(item => item.equipment)).size;
var totalJobs = new Set(visibleItems.map(item => item.jobNumber).filter(Boolean)).size;

// Update the display
document.getElementById('selectedPeriod').style.display = 'block';
document.getElementById('selectedPeriodInfo').innerHTML = `
<div class="row"><div class="col-md-4"><strong>Period:</strong> ${startStr} to ${endStr}
</div><div class="col-md-4"><strong>Equipment:</strong> ${totalEquipment} units
</div><div class="col-md-4"><strong>Job Sites:</strong> ${totalJobs}
</div></div>
`;
}

function getItemsInRange(start, end) {
// This would filter timeline items to those that fall within the date range
// For demo purposes, we'll just return all items
return timelineItems;
}

function showEquipmentDetail(item) {
// Hide placeholder and show detail section
document.getElementById('equipmentDetailPlaceholder').style.display = 'none';
document.getElementById('equipmentDetail').style.display = 'block';

// Populate basic info
document.getElementById('equipmentTitle').textContent = item.equipment;
document.getElementById('equipmentDescription').textContent = `${item.equipmentType} - Currently assigned to ${item.jobNumber || 'No Job'}`;

// Populate statistics
document.getElementById('totalDays').textContent = item.totalDays || 0;
document.getElementById('totalAmount').textContent = '$' + (item.totalAmount || 0).toLocaleString();
document.getElementById('utilizationRate').textContent = (item.utilizationRate || 0) + '%';

// Job allocation info
var jobAllocationHtml = '';
if (item.jobAllocation) {
for (var job in item.jobAllocation) {
var percentage = item.jobAllocation[job].percentage;
var color = getJobColor(job);

jobAllocationHtml += `
<div class="mb-2"><div class="d-flex justify-content-between"><div><span class="job-tag" style="background-color: ${color};">${job}</span>
${item.jobAllocation[job].name}
</div><div><strong>${percentage}%</strong></div></div><div class="progress" style="height: 8px;"><div class="progress-bar" role="progressbar" style="width: ${percentage}%; background-color: ${color};"
aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div></div></div>
`;
}
} else {
jobAllocationHtml = '<p class="text-muted">No job allocation data available</p>';
}
document.getElementById('jobAllocation').innerHTML = jobAllocationHtml;

// Update the cost code chart
updateCostCodeChart(item.costCodes);

// Update the monthly trend chart
updateMonthlyTrendChart(item.monthlyTrend);
}

function getJobColor(jobNumber) {
// Generate consistent colors based on job number
var colors = [
'#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
'#6f42c1', '#20c9a6', '#5a5c69', '#858796', '#f8f9fc'
];

// Hash function to convert job number to an index
var sum = 0;
for (var i = 0; i < jobNumber.length; i++) {
sum += jobNumber.charCodeAt(i);
}
return colors[sum % colors.length];
}

// Chart initialization (hidden at first)
var costCodeChart, monthlyTrendChart;

function updateCostCodeChart(costCodes) {
var ctx = document.getElementById('costCodeChart').getContext('2d');

// Destroy previous chart if it exists
if (costCodeChart) {
costCodeChart.destroy();
}

if (!costCodes || Object.keys(costCodes).length === 0) {
ctx.font = '14px Arial';
ctx.textAlign = 'center';
ctx.fillText('No cost code data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
return;
}

// Prepare data
var labels = Object.keys(costCodes);
var data = labels.map(function(key) {
return costCodes[key];
});

// Create new chart
costCodeChart = new Chart(ctx, {
type: 'pie',
data: {
labels: labels,
datasets: [{
data: data,
backgroundColor: [
'#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
'#6f42c1', '#20c9a6', '#5a5c69', '#858796', '#f8f9fc'
]
}]
},
options: {
responsive: true,
plugins: {
legend: {
position: 'right'
},
tooltip: {
callbacks: {
label: function(context) {
var label = context.label || '';
var value = context.raw || 0;
var total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
var percentage = Math.round((value / total) * 100);
return `${label}: $${value.toLocaleString()} (${percentage}%)`;
}
}
}
}
}
});
}

function updateMonthlyTrendChart(monthlyTrend) {
var ctx = document.getElementById('monthlyTrendChart').getContext('2d');

// Destroy previous chart if it exists
if (monthlyTrendChart) {
monthlyTrendChart.destroy();
}

if (!monthlyTrend || Object.keys(monthlyTrend).length === 0) {
ctx.font = '14px Arial';
ctx.textAlign = 'center';
ctx.fillText('No monthly trend data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
return;
}

// Prepare data
var months = Object.keys(monthlyTrend).sort(function(a, b) {
// Sort months chronologically
var monthOrder = {
'January': 0, 'February': 1, 'March': 2, 'April': 3, 'May': 4, 'June': 5,
'July': 6, 'August': 7, 'September': 8, 'October': 9, 'November': 10, 'December': 11
};

// Extract month and year
var aMonthYear = a.split(' ');
var bMonthYear = b.split(' ');

var aMonth = aMonthYear[0];
var bMonth = bMonthYear[0];
var aYear = parseInt(aMonthYear[1]);
var bYear = parseInt(bMonthYear[1]);

if (aYear !== bYear) {
return aYear - bYear;
}

return monthOrder[aMonth] - monthOrder[bMonth];
});

var days = months.map(function(month) {
return monthlyTrend[month].days || 0;
});

var amounts = months.map(function(month) {
return monthlyTrend[month].amount || 0;
});

// Create new chart
monthlyTrendChart = new Chart(ctx, {
type: 'line',
data: {
labels: months,
datasets: [
{
label: 'Days',
data: days,
borderColor: '#4e73df',
backgroundColor: 'rgba(78, 115, 223, 0.1)',
yAxisID: 'y',
tension: 0.1,
fill: true
},
{
label: 'Amount ($)',
data: amounts,
borderColor: '#1cc88a',
backgroundColor: 'rgba(28, 200, 138, 0.1)',
yAxisID: 'y1',
tension: 0.1,
fill: true
}
]
},
options: {
responsive: true,
interaction: {
mode: 'index',
intersect: false,
},
scales: {
y: {
type: 'linear',
display: true,
position: 'left',
title: {
display: true,
text: 'Days'
}
},
y1: {
type: 'linear',
display: true,
position: 'right',
title: {
display: true,
text: 'Amount ($)'
},
grid: {
drawOnChartArea: false
}
}
}
}
});
}

// Initialize the view with default settings
document.getElementById('viewMonth').click();
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Kaizen Core - Template Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-3 col-lg-3 col-xl-2">
            <!-- Sidebar -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Kaizen Core</h5>
                    <button class="btn btn-sm d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-expanded="true">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
                <div class="card-body p-0 collapse show" id="sidebarMenu">
                    <div class="list-group list-group-flush">
                        <a href="{{ url_for('kaizen_admin.index') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-speedometer2 me-2"></i> Dashboard
                        </a>
                        <a href="{{ url_for('kaizen_admin.sync_history') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-clock-history me-2"></i> Sync History
                        </a>
                        <a href="{{ url_for('kaizen_admin.templates') }}" class="list-group-item list-group-item-action active">
                            <i class="bi bi-file-earmark-code me-2"></i> Templates
                        </a>
                        <a href="{{ url_for('kaizen_admin.run_all_checks') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-shield-check me-2"></i> Integrity Check
                        </a>
                        <a href="{{ url_for('kaizen_admin.admin_actions') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-person-badge me-2"></i> Admin Actions
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('kaizen_admin.auto_generate_all_templates') }}" method="post">
                        <button type="submit" class="btn btn-primary btn-sm w-100 mb-2">
                            <i class="bi bi-magic me-2"></i> Auto-Generate Missing Templates
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <!-- Main Content -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Template Management</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="templateTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates-content" type="button" role="tab" aria-controls="templates-content" aria-selected="true">
                                Templates
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="routes-tab" data-bs-toggle="tab" data-bs-target="#routes-content" type="button" role="tab" aria-controls="routes-content" aria-selected="false">
                                Routes
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content pt-3" id="templateTabsContent">
                        <!-- Templates Tab -->
                        <div class="tab-pane fade show active" id="templates-content" role="tabpanel" aria-labelledby="templates-tab">
                            {% if templates_by_blueprint %}
                                <div class="accordion" id="templatesAccordion">
                                    {% for blueprint_name, templates in templates_by_blueprint.items() %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="heading-{{ blueprint_name }}">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ blueprint_name }}" aria-expanded="false" aria-controls="collapse-{{ blueprint_name }}">
                                                    {{ blueprint_name }} <span class="badge bg-primary ms-2">{{ templates|length }}</span>
                                                </button>
                                            </h2>
                                            <div id="collapse-{{ blueprint_name }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ blueprint_name }}" data-bs-parent="#templatesAccordion">
                                                <div class="accordion-body">
                                                    <ul class="list-group">
                                                        {% for template in templates %}
                                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                <span>{{ template }}</span>
                                                                <div>
                                                                    <button type="button" class="btn btn-sm btn-info" onclick="viewTemplate('{{ template }}')">
                                                                        <i class="bi bi-eye"></i>
                                                                    </button>
                                                                </div>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    No templates found.
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Routes Tab -->
                        <div class="tab-pane fade" id="routes-content" role="tabpanel" aria-labelledby="routes-tab">
                            {% if routes_by_blueprint %}
                                <div class="accordion" id="routesAccordion">
                                    {% for blueprint_name, routes in routes_by_blueprint.items() %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="heading-routes-{{ blueprint_name }}">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-routes-{{ blueprint_name }}" aria-expanded="false" aria-controls="collapse-routes-{{ blueprint_name }}">
                                                    {{ blueprint_name }} <span class="badge bg-primary ms-2">{{ routes|length }}</span>
                                                </button>
                                            </h2>
                                            <div id="collapse-routes-{{ blueprint_name }}" class="accordion-collapse collapse" aria-labelledby="heading-routes-{{ blueprint_name }}" data-bs-parent="#routesAccordion">
                                                <div class="accordion-body">
                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-striped">
                                                            <thead>
                                                                <tr>
                                                                    <th>Rule</th>
                                                                    <th>Endpoint</th>
                                                                    <th>Methods</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for route in routes %}
                                                                    <tr>
                                                                        <td>{{ route.rule }}</td>
                                                                        <td>{{ route.endpoint }}</td>
                                                                        <td>
                                                                            {% for method in route.methods %}
                                                                                {% if method != 'HEAD' and method != 'OPTIONS' %}
                                                                                    <span class="badge bg-secondary">{{ method }}</span>
                                                                                {% endif %}
                                                                            {% endfor %}
                                                                        </td>
                                                                        <td>
                                                                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#generateTemplateModal" 
                                                                                data-blueprint="{{ blueprint_name }}" 
                                                                                data-route="{{ route.rule }}" 
                                                                                data-endpoint="{{ route.endpoint.split('.')[-1] }}">
                                                                                <i class="bi bi-magic"></i>
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    No routes found.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Template Modal -->
<div class="modal fade" id="generateTemplateModal" tabindex="-1" aria-labelledby="generateTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateTemplateModalLabel">Generate Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('kaizen_admin.generate_template') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="blueprint_name" class="form-label">Blueprint</label>
                        <input type="text" class="form-control" id="blueprint_name" name="blueprint_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="route_name" class="form-label">Route</label>
                        <input type="text" class="form-control" id="route_name" name="route_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="endpoint_name" class="form-label">Endpoint</label>
                        <input type="text" class="form-control" id="endpoint_name" name="endpoint_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="template_path" class="form-label">Template Path</label>
                        <input type="text" class="form-control" id="template_path" name="template_path" required>
                        <div class="form-text">Example: blueprint_name/template_name.html</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Template</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // Template modal data
    document.addEventListener('DOMContentLoaded', function() {
        const generateTemplateModal = document.getElementById('generateTemplateModal');
        if (generateTemplateModal) {
            generateTemplateModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const blueprint = button.getAttribute('data-blueprint');
                const route = button.getAttribute('data-route');
                const endpoint = button.getAttribute('data-endpoint');
                
                const blueprintNameInput = generateTemplateModal.querySelector('#blueprint_name');
                const routeNameInput = generateTemplateModal.querySelector('#route_name');
                const endpointNameInput = generateTemplateModal.querySelector('#endpoint_name');
                const templatePathInput = generateTemplateModal.querySelector('#template_path');
                
                blueprintNameInput.value = blueprint;
                routeNameInput.value = route;
                endpointNameInput.value = endpoint;
                templatePathInput.value = `${blueprint}/${endpoint}.html`;
            });
        }
    });
    
    function viewTemplate(templatePath) {
        // In a real implementation, this would open a modal or navigate to a page to view the template
        alert(`View template: ${templatePath}`);
    }
</script>
{% endblock %}
{% endblock %}
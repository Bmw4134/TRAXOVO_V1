{% extends "base.html" %}

{% block title %}System Logs{% endblock %}

{% block content %}
<div class="container mt-4"><div class="row mb-4"><div class="col-md-12"><h2>System Logs Viewer</h2><p class="text-muted">Monitoring tool for system logs. Filter by log level and search for specific terms.</p></div></div><div class="row mb-4"><div class="col-md-3"><div class="card"><div class="card-header">Log Files</div><div class="card-body p-0"><div class="list-group list-group-flush" id="logFileList">
{% for log_file in log_files %}
<a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center log-file"
data-file="{{ log_file.name }}"><div><i class="bi bi-file-text me-2"></i>
{{ log_file.name }}
</div><span class="badge rounded-pill bg-secondary">{{ (log_file.size / 1024)|round(1) }} KB</span></a>
{% endfor %}
</div></div></div><div class="card mt-3"><div class="card-header">Filters</div><div class="card-body"><div class="mb-3"><label for="levelFilter" class="form-label">Log Level</label><select class="form-select" id="levelFilter"><option value="">All Levels</option><option value="DEBUG">DEBUG</option><option value="INFO">INFO</option><option value="WARNING">WARNING</option><option value="ERROR">ERROR</option><option value="CRITICAL">CRITICAL</option></select></div><div class="mb-3"><label for="searchInput" class="form-label">Search</label><input type="text" class="form-control" id="searchInput" placeholder="Search logs..."></div><div class="mb-3"><label for="entriesCount" class="form-label">Max Entries</label><select class="form-select" id="entriesCount"><option value="50">50 entries</option><option value="100" selected>100 entries</option><option value="250">250 entries</option><option value="500">500 entries</option><option value="1000">1000 entries</option></select></div><button class="btn btn-primary w-100" id="refreshBtn"><i class="bi bi-arrow-repeat me-1"></i> Refresh
</button></div></div></div><div class="col-md-9"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><span id="currentLogFile">Select a log file</span><div><button class="btn btn-sm btn-outline-secondary me-2" id="autoRefreshBtn"><i class="bi bi-play-fill"></i> Auto Refresh
</button><button class="btn btn-sm btn-outline-secondary" id="downloadBtn"><i class="bi bi-download"></i> Download
</button></div></div><div class="card-body p-0"><div id="logPreLoader" class="text-center p-4 d-none"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading logs...</p></div><div id="logEmpty" class="text-center p-4"><i class="bi bi-file-earmark-text display-1 text-muted"></i><p class="mt-3">Select a log file to view its contents</p></div><div class="table-responsive" style="max-height: 600px; overflow-y: auto;" id="logTableContainer"><table class="table table-striped table-hover mb-0" id="logTable"><thead class="sticky-top bg-dark text-white"><tr><th style="width: 180px;">Timestamp</th><th style="width: 100px;">Level</th><th style="width: 150px;">Logger</th><th>Message</th></tr></thead><tbody id="logEntries"></tbody></table></div></div><div class="card-footer d-flex justify-content-between"><span class="text-muted" id="entryCount">0 entries</span><span class="text-muted" id="lastRefresh">Last refresh: Never</span></div></div></div></div></div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentLogFile = '';
let autoRefreshInterval = null;
const AUTO_REFRESH_INTERVAL = 5000; // 5 seconds

// DOM elements
const logFileList = document.getElementById('logFileList');
const logEntries = document.getElementById('logEntries');
const currentLogFileElement = document.getElementById('currentLogFile');
const levelFilter = document.getElementById('levelFilter');
const searchInput = document.getElementById('searchInput');
const entriesCount = document.getElementById('entriesCount');
const refreshBtn = document.getElementById('refreshBtn');
const autoRefreshBtn = document.getElementById('autoRefreshBtn');
const downloadBtn = document.getElementById('downloadBtn');
const entryCountElement = document.getElementById('entryCount');
const lastRefreshElement = document.getElementById('lastRefresh');
const logPreLoader = document.getElementById('logPreLoader');
const logEmpty = document.getElementById('logEmpty');
const logTableContainer = document.getElementById('logTableContainer');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
// Attach event listeners
logFileList.addEventListener('click', handleLogFileClick);
refreshBtn.addEventListener('click', fetchLogEntries);
autoRefreshBtn.addEventListener('click', toggleAutoRefresh);
downloadBtn.addEventListener('click', downloadLogFile);

// Hide table initially
logTableContainer.classList.add('d-none');

// Set default log file if available
const logFileElements = document.querySelectorAll('.log-file');
if (logFileElements.length > 0) {
// Find system.log if it exists
let systemLogElement = null;
for (const element of logFileElements) {
if (element.dataset.file === 'system.log') {
systemLogElement = element;
break;
}
}

// Select system.log or first log file
if (systemLogElement) {
selectLogFile(systemLogElement);
} else if (logFileElements.length > 0) {
selectLogFile(logFileElements[0]);
}
}
});

// Handle log file click
function handleLogFileClick(event) {
event.preventDefault();

const element = event.target.closest('.log-file');
if (element) {
selectLogFile(element);
}
}

// Select log file
function selectLogFile(element) {
// Update active state
document.querySelectorAll('.log-file').forEach(el => {
el.classList.remove('active');
});
element.classList.add('active');

// Update current log file
currentLogFile = element.dataset.file;
currentLogFileElement.textContent = currentLogFile;

// Fetch log entries
fetchLogEntries();
}

// Fetch log entries
function fetchLogEntries() {
if (!currentLogFile) {
return;
}

// Show loader
logEmpty.classList.add('d-none');
logTableContainer.classList.add('d-none');
logPreLoader.classList.remove('d-none');

// Build query parameters
const params = new URLSearchParams({
log_file: currentLogFile,
max_entries: entriesCount.value
});

if (levelFilter.value) {
params.append('level', levelFilter.value);
}

if (searchInput.value) {
params.append('search', searchInput.value);
}

// Fetch log entries
fetch(`/system-logs/api/entries?${params.toString()}`)
.then(response => response.json())
.then(data => {
displayLogEntries(data);
})
.catch(error => {
console.error('Error fetching log entries:', error);
logEntries.innerHTML = `
<tr><td colspan="4" class="text-center text-danger">
Error loading log entries. Please try again.
</td></tr>
`;
})
.finally(() => {
logPreLoader.classList.add('d-none');
if (logEntries.childElementCount > 0) {
logTableContainer.classList.remove('d-none');
} else {
logEmpty.classList.remove('d-none');
}
});
}

// Display log entries
function displayLogEntries(data) {
// Clear existing entries
logEntries.innerHTML = '';

// Update entry count
entryCountElement.textContent = `${data.count} entries`;

// Update last refresh time
const now = new Date();
lastRefreshElement.textContent = `Last refresh: ${now.toLocaleTimeString()}`;

// No entries
if (data.entries.length === 0) {
logEntries.innerHTML = `
<tr><td colspan="4" class="text-center">
No log entries found matching the current filters.
</td></tr>
`;
return;
}

// Display entries
data.entries.forEach(entry => {
const row = document.createElement('tr');

// Add level-based styling
if (entry.level === 'ERROR' || entry.level === 'CRITICAL') {
row.classList.add('table-danger');
} else if (entry.level === 'WARNING') {
row.classList.add('table-warning');
} else if (entry.level === 'DEBUG') {
row.classList.add('table-info');
}

row.innerHTML = `
<td>${entry.timestamp || ''}</td><td><span class="badge ${getLevelBadgeClass(entry.level)}">${entry.level || 'UNKNOWN'}</span></td><td>${entry.logger || ''}</td><td>${escapeHtml(entry.message || '')}</td>
`;

logEntries.appendChild(row);
});
}

// Get badge class for log level
function getLevelBadgeClass(level) {
switch (level) {
case 'DEBUG':
return 'bg-info text-dark';
case 'INFO':
return 'bg-success';
case 'WARNING':
return 'bg-warning text-dark';
case 'ERROR':
return 'bg-danger';
case 'CRITICAL':
return 'bg-danger';
default:
return 'bg-secondary';
}
}

// Toggle auto refresh
function toggleAutoRefresh() {
if (autoRefreshInterval) {
// Stop auto refresh
clearInterval(autoRefreshInterval);
autoRefreshInterval = null;
autoRefreshBtn.innerHTML = '<i class="bi bi-play-fill"></i> Auto Refresh';
autoRefreshBtn.classList.remove('btn-primary');
autoRefreshBtn.classList.add('btn-outline-secondary');
} else {
// Start auto refresh
fetchLogEntries(); // Fetch immediately
autoRefreshInterval = setInterval(fetchLogEntries, AUTO_REFRESH_INTERVAL);
autoRefreshBtn.innerHTML = '<i class="bi bi-pause-fill"></i> Auto Refresh';
autoRefreshBtn.classList.remove('btn-outline-secondary');
autoRefreshBtn.classList.add('btn-primary');
}
}

// Download log file
function downloadLogFile() {
if (!currentLogFile) {
return;
}

// Create a link to download the file
const link = document.createElement('a');
link.href = `/system-logs/download/${currentLogFile}`;
link.download = currentLogFile;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
}

// Escape HTML
function escapeHtml(html) {
const div = document.createElement('div');
div.textContent = html;
return div.innerHTML;
}
</script>
{% endblock %}
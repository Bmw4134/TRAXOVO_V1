<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Asset Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        .title {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 999;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 16px;
            font-weight: bold;
        }
        .asset-marker {
            width: 32px !important;
            height: 32px !important;
            background-color: #f00;
            border-radius: 16px;
            border: 2px solid #fff;
            color: white;
            font-weight: bold;
            text-align: center;
            line-height: 32px;
        }
        .excavator { background-color: #ffc107; }
        .loader { background-color: #28a745; }
        .dozer { background-color: #dc3545; }
        .truck { background-color: #007bff; }
        .pickup { background-color: #6f42c1; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="title">TRAXORA Assets</div>
    
    <!-- Filter controls -->
    <div style="position: absolute; bottom: 20px; left: 10px; right: 10px; z-index: 999; 
                background-color: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; display: flex; justify-content: space-between;">
        <select id="divisionFilter" style="flex: 1; margin-right: 10px; padding: 5px; border-radius: 4px;">
            <option value="all">All Divisions</option>
        </select>
        <select id="typeFilter" style="flex: 1; padding: 5px; border-radius: 4px;">
            <option value="all">All Types</option>
            <option value="excavator">Excavators</option>
            <option value="loader">Loaders</option>
            <option value="dozer">Dozers</option>
            <option value="truck">Trucks</option>
            <option value="pickup">Pickups</option>
        </select>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on Texas
        var map = L.map('map').setView([31.5, -99.0], 6);
        
        // Add OpenStreetMap base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);
        
        // Add refresh button
        var refreshButton = document.createElement('div');
        refreshButton.style.position = 'absolute';
        refreshButton.style.top = '10px';
        refreshButton.style.right = '10px';
        refreshButton.style.zIndex = '999';
        refreshButton.style.backgroundColor = 'rgba(0,0,0,0.7)';
        refreshButton.style.color = 'white';
        refreshButton.style.padding = '8px';
        refreshButton.style.borderRadius = '4px';
        refreshButton.style.cursor = 'pointer';
        refreshButton.innerHTML = '↻ Refresh';
        refreshButton.onclick = function() {
            location.reload();
        };
        document.body.appendChild(refreshButton);
        
        // Status indicator
        var statusDiv = document.createElement('div');
        statusDiv.className = 'title';
        statusDiv.style.right = '80px'; // Make room for refresh button
        statusDiv.style.left = 'auto';
        statusDiv.style.backgroundColor = 'rgba(0,0,0,0.7)';
        statusDiv.style.fontSize = '14px';
        statusDiv.innerHTML = 'Loading assets...';
        document.body.appendChild(statusDiv);
        
        // Fetch real assets from API
        fetch('/map-view/api/sample-assets')
            .then(response => response.json())
            .then(data => {
                if (data && data.status === 'success' && data.assets && data.assets.length > 0) {
                    // Update status
                    statusDiv.innerHTML = data.source === 'gauge_api' ? 'Live Data' : 'Sample Data';
                    statusDiv.style.backgroundColor = data.source === 'gauge_api' ? 'rgba(40, 167, 69, 0.8)' : 'rgba(255, 193, 7, 0.8)';
                    
                    // Process assets
                    processAssets(data.assets);
                } else {
                    // Show error
                    statusDiv.innerHTML = 'No asset data';
                    statusDiv.style.backgroundColor = 'rgba(220, 53, 69, 0.8)';
                }
            })
            .catch(error => {
                console.error('Error fetching assets:', error);
                statusDiv.innerHTML = 'Error loading data';
                statusDiv.style.backgroundColor = 'rgba(220, 53, 69, 0.8)';
            });
        
        // Process assets and add to map
        function processAssets(assets) {
            // Remove any existing markers
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            
            // Valid asset locations to track
            var validAssets = [];
            
            // Process each asset
            assets.forEach(function(asset) {
                // Extract location info
                var lat = asset.latitude || asset.lat;
                var lng = asset.longitude || asset.lng;
                
                // Skip assets without location
                if (!lat || !lng || lat === 0 || lng === 0) return;
                
                // Determine asset type
                var type = getAssetType(asset);
                
                // Get ID or create one
                var id = asset.id || asset.assetID || 'Asset';
                
                // Get asset name
                var name = asset.name || asset.assetName || id;
                
                // Determine division/region
                var division = asset.division || 'Unknown';
                
                // Add to valid assets
                validAssets.push({
                    id: id,
                    type: type,
                    name: name,
                    lat: lat,
                    lng: lng,
                    division: division,
                    status: asset.status || 'active'
                });
                
                // Create marker with custom icon
                var marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: '',
                        html: '<div class="asset-marker ' + type + '">' + id.substr(0, 2) + '</div>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    }),
                    // Add properties for filtering
                    assetType: type,
                    assetDivision: division
                }).addTo(map);
                
                // Create popup content
                var popupContent = "<div>";
                popupContent += "<b>" + id + "</b><br>" + name;
                if (division) popupContent += "<br>Division: " + division;
                if (asset.status) popupContent += "<br>Status: " + asset.status;
                if (asset.driver) popupContent += "<br>Driver: " + asset.driver;
                if (asset.jobSite) popupContent += "<br>Job: " + asset.jobSite;
                popupContent += "</div>";
                
                // Add popup with asset info
                marker.bindPopup(popupContent);
            });
            
            // Fit map to asset bounds if we have any
            if (validAssets.length > 0) {
                var bounds = validAssets.map(asset => [asset.lat, asset.lng]);
                map.fitBounds(bounds);
            }
            
            // Update status with count
            statusDiv.innerHTML += ' (' + validAssets.length + ' assets)';
            
            // Populate division filter with unique divisions
            var divisionFilter = document.getElementById('divisionFilter');
            var divisions = new Set();
            
            validAssets.forEach(function(asset) {
                if (asset.division && asset.division !== 'Unknown') {
                    divisions.add(asset.division);
                }
            });
            
            // Clear existing options except first
            while (divisionFilter.options.length > 1) {
                divisionFilter.remove(1);
            }
            
            // Add division options
            divisions.forEach(function(division) {
                var option = document.createElement('option');
                option.value = division;
                option.textContent = division;
                divisionFilter.appendChild(option);
            });
            
            // Set up filter event handlers
            document.getElementById('divisionFilter').addEventListener('change', filterMarkers);
            document.getElementById('typeFilter').addEventListener('change', filterMarkers);
        }
        
        // Filter markers based on selected division and type
        function filterMarkers() {
            var selectedDivision = document.getElementById('divisionFilter').value;
            var selectedType = document.getElementById('typeFilter').value;
            
            // Count visible markers
            var visibleCount = 0;
            
            // Apply filters
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    var showMarker = true;
                    
                    // Check division filter
                    if (selectedDivision !== 'all' && layer.options.assetDivision !== selectedDivision) {
                        showMarker = false;
                    }
                    
                    // Check type filter
                    if (selectedType !== 'all' && layer.options.assetType !== selectedType) {
                        showMarker = false;
                    }
                    
                    // Show or hide marker
                    if (showMarker) {
                        layer.getElement().style.display = '';
                        visibleCount++;
                    } else {
                        layer.getElement().style.display = 'none';
                    }
                }
            });
            
            // Update status
            var statusText = statusDiv.innerHTML.split('(')[0];
            statusDiv.innerHTML = statusText + '(' + visibleCount + ' assets)';
        }
        
        // Determine asset type from various properties
        function getAssetType(asset) {
            var type = (asset.assetType || asset.type || '').toLowerCase();
            
            if (type.includes('excavator')) return 'excavator';
            if (type.includes('loader')) return 'loader';
            if (type.includes('dozer')) return 'dozer';
            if (type.includes('truck')) return 'truck';
            if (type.includes('pickup')) return 'pickup';
            
            // Try to determine from ID
            var id = (asset.id || '').toUpperCase();
            
            if (id.startsWith('EX')) return 'excavator';
            if (id.startsWith('LD')) return 'loader';
            if (id.startsWith('DZ')) return 'dozer';
            if (id.startsWith('TK')) return 'truck';
            if (id.startsWith('PU')) return 'pickup';
            
            return 'truck'; // Default
        }
    </script>
</body>
</html>
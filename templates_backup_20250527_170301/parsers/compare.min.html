{% extends 'base.html' %}

{% block title %}Compare Files - SYSTEMSMITH{% endblock %}

{% block head_extras %}
<style>
.diff-added {
background-color: rgba(var(--bs-success-rgb), 0.2);
}

.diff-removed {
background-color: rgba(var(--bs-danger-rgb), 0.2);
}

.diff-changed {
background-color: rgba(var(--bs-warning-rgb), 0.2);
}

.file-selector {
position: relative;
transition: all 0.3s;
}

.file-selector:hover {
transform: translateY(-2px);
}

.file-version-card {
cursor: pointer;
transition: all 0.2s;
}

.file-version-card:hover {
border-color: var(--bs-primary);
}

.file-version-card.selected {
border-color: var(--bs-primary);
box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}

.comparison-table th, .comparison-table td {
font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4"><div class="d-flex justify-content-between align-items-center mb-4"><h1>Compare Files</h1><div><a href="{{ url_for('parser.index') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-2"></i>Back to File Management
</a></div></div><div class="row"><div class="col-lg-12 mb-4"><div class="card mb-4"><div class="card-header bg-dark text-white"><h5 class="mb-0">Select Files to Compare</h5></div><div class="card-body">
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
{{ message }}
<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
{% endfor %}
{% endif %}
{% endwith %}

<form id="compareForm" action="{{ url_for('parser.compare_result') }}" method="POST"><div class="row"><div class="col-md-5 mb-3"><label class="form-label">First File</label><div class="card file-selector"><div class="card-body"><div class="mb-3"><div class="input-group"><span class="input-group-text"><i class="bi bi-1-circle"></i></span><select class="form-select" id="file1Type" name="file1_type"><option value="recent" selected>Recent File</option><option value="upload">Upload New File</option><option value="backup">From Backups</option></select></div></div><div id="file1Recent" class="file-select-panel"><div class="mb-3"><select class="form-select" id="file1Recent" name="file1_recent">
{% if recent_files and recent_files|length > 0 %}
{% for file in recent_files %}
<option value="{{ file.file_path }}">{{ file.filename }} ({{ file.timestamp }})</option>
{% endfor %}
{% else %}
<option value="" disabled>No recent files available</option>
{% endif %}
</select></div></div><div id="file1Upload" class="file-select-panel d-none"><div class="mb-3"><input type="file" class="form-control" id="file1UploadInput" name="file1_upload"></div></div><div id="file1Backup" class="file-select-panel d-none"><div class="mb-3"><div class="input-group"><select class="form-select" id="file1BackupFile" name="file1_backup_file">
{% if backup_files and backup_files|length > 0 %}
{% for file in backup_files %}
<option value="{{ file.file_path }}">{{ file.filename }}</option>
{% endfor %}
{% else %}
<option value="" disabled>No backup files available</option>
{% endif %}
</select><button class="btn btn-outline-secondary" type="button" id="file1BackupVersion"><i class="bi bi-clock-history"></i></button></div></div><div id="file1VersionSelect" class="d-none"><div class="row g-2 mb-3 file-version-row">
{% for i in range(4) %}
<div class="col-md-6 mb-2"><div class="card file-version-card" data-version-id="{{ i }}"><div class="card-body p-2"><div class="d-flex justify-content-between"><div class="text-truncate">Version {{ i + 1 }}</div><small class="text-muted">05/{{ 15 - i }}/2025</small></div></div></div></div>
{% endfor %}
</div></div></div></div></div></div><div class="col-md-2 mb-3"><div class="d-flex align-items-center justify-content-center h-100"><div class="text-center"><div class="fs-1 text-primary"><i class="bi bi-arrow-left-right"></i></div><div class="text-muted">Compare</div></div></div></div><div class="col-md-5 mb-3"><label class="form-label">Second File</label><div class="card file-selector"><div class="card-body"><div class="mb-3"><div class="input-group"><span class="input-group-text"><i class="bi bi-2-circle"></i></span><select class="form-select" id="file2Type" name="file2_type"><option value="recent" selected>Recent File</option><option value="upload">Upload New File</option><option value="backup">From Backups</option></select></div></div><div id="file2Recent" class="file-select-panel"><div class="mb-3"><select class="form-select" id="file2Recent" name="file2_recent">
{% if recent_files and recent_files|length > 0 %}
{% for file in recent_files %}
<option value="{{ file.file_path }}">{{ file.filename }} ({{ file.timestamp }})</option>
{% endfor %}
{% else %}
<option value="" disabled>No recent files available</option>
{% endif %}
</select></div></div><div id="file2Upload" class="file-select-panel d-none"><div class="mb-3"><input type="file" class="form-control" id="file2UploadInput" name="file2_upload"></div></div><div id="file2Backup" class="file-select-panel d-none"><div class="mb-3"><div class="input-group"><select class="form-select" id="file2BackupFile" name="file2_backup_file">
{% if backup_files and backup_files|length > 0 %}
{% for file in backup_files %}
<option value="{{ file.file_path }}">{{ file.filename }}</option>
{% endfor %}
{% else %}
<option value="" disabled>No backup files available</option>
{% endif %}
</select><button class="btn btn-outline-secondary" type="button" id="file2BackupVersion"><i class="bi bi-clock-history"></i></button></div></div><div id="file2VersionSelect" class="d-none"><div class="row g-2 mb-3 file-version-row">
{% for i in range(4) %}
<div class="col-md-6 mb-2"><div class="card file-version-card" data-version-id="{{ i }}"><div class="card-body p-2"><div class="d-flex justify-content-between"><div class="text-truncate">Version {{ i + 1 }}</div><small class="text-muted">05/{{ 15 - i }}/2025</small></div></div></div></div>
{% endfor %}
</div></div></div></div></div></div></div><div class="row mt-3"><div class="col-md-12"><div class="card"><div class="card-header bg-light"><h6 class="mb-0">Comparison Options</h6></div><div class="card-body"><div class="row g-3"><div class="col-md-4"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="ignoreWhitespace" name="ignore_whitespace" checked><label class="form-check-label" for="ignoreWhitespace">Ignore Whitespace</label></div></div><div class="col-md-4"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="ignoreCase" name="ignore_case"><label class="form-check-label" for="ignoreCase">Ignore Case</label></div></div><div class="col-md-4"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="smartMatch" name="smart_match" checked><label class="form-check-label" for="smartMatch">Smart Pattern Matching</label></div></div><div class="col-md-4"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="generateReport" name="generate_report" checked><label class="form-check-label" for="generateReport">Generate Summary Report</label></div></div><div class="col-md-4"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="reconcileChanges" name="reconcile_changes"><label class="form-check-label" for="reconcileChanges">Auto-Reconcile Changes</label></div></div><div class="col-md-4"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="highlightChanges" name="highlight_changes" checked><label class="form-check-label" for="highlightChanges">Highlight All Changes</label></div></div></div></div></div></div></div><div class="d-grid gap-2 mt-4"><button type="submit" class="btn btn-primary" id="compareBtn"><i class="bi bi-arrow-left-right me-2"></i>Compare Files
</button></div></form></div></div><div class="card"><div class="card-header bg-dark text-white d-flex justify-content-between align-items-center"><h5 class="mb-0">Example Comparison Preview</h5><span class="badge bg-warning">Demo</span></div><div class="card-body"><div class="alert alert-info"><i class="bi bi-info-circle-fill me-2"></i>
This is an example of what a comparison result might look like. Select and compare files to see actual differences.
</div><div class="table-responsive"><table class="table table-striped comparison-table"><thead><tr><th style="width: 10%">Row</th><th style="width: 15%">Column</th><th style="width: 35%">File 1 Value</th><th style="width: 35%">File 2 Value</th><th style="width: 5%">Status</th></tr></thead><tbody><tr><td>1</td><td>Header</td><td>Original header value</td><td>Original header value</td><td><span class="badge bg-secondary">Same</span></td></tr><tr class="diff-changed"><td>5</td><td>Asset ID</td><td>EC-14</td><td>EX-14</td><td><span class="badge bg-warning">Changed</span></td></tr><tr class="diff-changed"><td>8</td><td>Location</td><td>DFW Yard</td><td>West Dallas Worksite</td><td><span class="badge bg-warning">Changed</span></td></tr><tr class="diff-added"><td>12</td><td>Invoice #</td><td>-</td><td>INV-2025-04-003</td><td><span class="badge bg-success">Added</span></td></tr><tr class="diff-removed"><td>15</td><td>Old Reference</td><td>REF-2024-11-32</td><td>-</td><td><span class="badge bg-danger">Removed</span></td></tr></tbody></table></div><div class="mt-4"><h6 class="mb-3">Summary Statistics</h6><div class="row"><div class="col-md-3 mb-3"><div class="card bg-light"><div class="card-body p-3 text-center"><div class="display-6 text-secondary">145</div><div class="text-muted">Total Rows</div></div></div></div><div class="col-md-3 mb-3"><div class="card bg-light"><div class="card-body p-3 text-center"><div class="display-6 text-warning">24</div><div class="text-muted">Changed Values</div></div></div></div><div class="col-md-3 mb-3"><div class="card bg-light"><div class="card-body p-3 text-center"><div class="display-6 text-success">8</div><div class="text-muted">Added Items</div></div></div></div><div class="col-md-3 mb-3"><div class="card bg-light"><div class="card-body p-3 text-center"><div class="display-6 text-danger">3</div><div class="text-muted">Removed Items</div></div></div></div></div></div></div></div></div></div></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
// File 1 type selection
const file1Type = document.getElementById('file1Type');
const file1Recent = document.getElementById('file1Recent');
const file1Upload = document.getElementById('file1Upload');
const file1Backup = document.getElementById('file1Backup');

// File 2 type selection
const file2Type = document.getElementById('file2Type');
const file2Recent = document.getElementById('file2Recent');
const file2Upload = document.getElementById('file2Upload');
const file2Backup = document.getElementById('file2Backup');

// Handle file 1 type change
file1Type.addEventListener('change', function() {
// Hide all panels
file1Recent.classList.add('d-none');
file1Upload.classList.add('d-none');
file1Backup.classList.add('d-none');

// Show selected panel
if (this.value === 'recent') {
file1Recent.classList.remove('d-none');
} else if (this.value === 'upload') {
file1Upload.classList.remove('d-none');
} else if (this.value === 'backup') {
file1Backup.classList.remove('d-none');
}
});

// Handle file 2 type change
file2Type.addEventListener('change', function() {
// Hide all panels
file2Recent.classList.add('d-none');
file2Upload.classList.add('d-none');
file2Backup.classList.add('d-none');

// Show selected panel
if (this.value === 'recent') {
file2Recent.classList.remove('d-none');
} else if (this.value === 'upload') {
file2Upload.classList.remove('d-none');
} else if (this.value === 'backup') {
file2Backup.classList.remove('d-none');
}
});

// Handle file 1 backup version button
const file1BackupVersion = document.getElementById('file1BackupVersion');
const file1VersionSelect = document.getElementById('file1VersionSelect');

file1BackupVersion.addEventListener('click', function() {
file1VersionSelect.classList.toggle('d-none');
});

// Handle file 2 backup version button
const file2BackupVersion = document.getElementById('file2BackupVersion');
const file2VersionSelect = document.getElementById('file2VersionSelect');

file2BackupVersion.addEventListener('click', function() {
file2VersionSelect.classList.toggle('d-none');
});

// Handle file version selection
const file1VersionCards = document.querySelectorAll('#file1VersionSelect .file-version-card');

file1VersionCards.forEach(card => {
card.addEventListener('click', function() {
// Remove selected class from all cards
file1VersionCards.forEach(c => c.classList.remove('selected'));

// Add selected class to clicked card
this.classList.add('selected');
});
});

const file2VersionCards = document.querySelectorAll('#file2VersionSelect .file-version-card');

file2VersionCards.forEach(card => {
card.addEventListener('click', function() {
// Remove selected class from all cards
file2VersionCards.forEach(c => c.classList.remove('selected'));

// Add selected class to clicked card
this.classList.add('selected');
});
});

// Handle form submission
const compareForm = document.getElementById('compareForm');
const compareBtn = document.getElementById('compareBtn');

compareForm.addEventListener('submit', function() {
// Show loading state on button
compareBtn.disabled = true;
compareBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Comparing...';
});
});
</script>
{% endblock %}
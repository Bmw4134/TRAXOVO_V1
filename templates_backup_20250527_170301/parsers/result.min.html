{% extends 'base.html' %}

{% block title %}File Processing Result - SYSTEMSMITH{% endblock %}

{% block content %}
<div class="container mt-4"><div class="d-flex justify-content-between align-items-center mb-4"><h1>File Processing Result</h1><div><a href="{{ url_for('parser.upload') }}" class="btn btn-outline-primary"><i class="bi bi-upload me-2"></i>Upload Another File
</a></div></div><div class="row"><div class="col-lg-8"><div class="card mb-4"><div class="card-header bg-dark text-white d-flex justify-content-between align-items-center"><h5 class="mb-0">Processing Summary</h5><span class="badge {% if metadata.success %}bg-success{% else %}bg-danger{% endif %}">
{% if metadata.success %}Success{% else %}Failed{% endif %}
</span></div><div class="card-body">
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
{{ message }}
<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="row mb-3"><div class="col-md-3 text-muted">Filename:</div><div class="col-md-9"><strong>{{ filename }}</strong></div></div><div class="row mb-3"><div class="col-md-3 text-muted">File Type:</div><div class="col-md-9">
{% if metadata.details and metadata.details.file_type %}
<span class="badge bg-info">{{ metadata.details.file_type }}</span>
{% if metadata.details.auto_detected %}
<small class="text-muted">(Auto-detected)</small>
{% endif %}
{% else %}
<span class="badge bg-secondary">Unknown</span>
{% endif %}
</div></div><div class="row mb-3"><div class="col-md-3 text-muted">Processing Time:</div><div class="col-md-9">{{ metadata.timestamp|default('N/A') }}</div></div><div class="row mb-3"><div class="col-md-3 text-muted">Status:</div><div class="col-md-9">
{% if metadata.success %}
<span class="text-success"><i class="bi bi-check-circle-fill me-2"></i>Processed Successfully</span>
{% else %}
<span class="text-danger"><i class="bi bi-x-circle-fill me-2"></i>Processing Failed</span>
{% endif %}
</div></div><div class="row mb-3"><div class="col-md-3 text-muted">Message:</div><div class="col-md-9">{{ metadata.message|default('N/A') }}</div></div>

{% if metadata.details and metadata.details.backup_path %}
<div class="row mb-3"><div class="col-md-3 text-muted">Backup:</div><div class="col-md-9"><span class="text-success"><i class="bi bi-shield-check me-2"></i>File backed up successfully</span><small class="text-muted d-block">{{ metadata.details.backup_path }}</small></div></div>
{% endif %}
</div></div>

{% if metadata.details and metadata.details.processor_result %}
<div class="card mb-4"><div class="card-header bg-dark text-white"><h5 class="mb-0">Processing Details</h5></div><div class="card-body">
{% set processor = metadata.details.processor_result %}

{% if processor.success %}
{# Excel file details #}
{% if processor.sheets is defined %}
<h6 class="mb-3">Excel File Information</h6><div class="table-responsive mb-4"><table class="table table-bordered table-hover"><thead class="table-light"><tr><th>Sheet Name</th><th>Rows</th><th>Columns</th><th>Type</th></tr></thead><tbody>
{% for sheet_name, sheet_data in processor.sheets.items() %}
<tr><td>{{ sheet_name }}</td><td>{{ sheet_data.analysis.row_count|default('N/A') }}</td><td>{{ sheet_data.column_mapping|length|default('N/A') }}</td><td><span class="badge bg-secondary">{{ sheet_data.analysis.sheet_type|default('general') }}</span></td></tr>
{% endfor %}
</tbody></table></div><h6 class="mb-3">Detected Entities</h6><div class="row"><div class="col-md-4 mb-3"><div class="card h-100"><div class="card-header bg-light"><i class="bi bi-tablet-landscape me-2 text-primary"></i>Assets
</div><div class="card-body"><p class="card-text">
{% set asset_count = processor.stats.detected_ids|default(0) %}
{% if asset_count > 0 %}
<span class="text-success"><i class="bi bi-check-circle me-2"></i>{{ asset_count }} assets detected</span>
{% else %}
<span class="text-muted"><i class="bi bi-dash-circle me-2"></i>No assets detected</span>
{% endif %}
</p></div></div></div><div class="col-md-4 mb-3"><div class="card h-100"><div class="card-header bg-light"><i class="bi bi-people me-2 text-success"></i>Employees
</div><div class="card-body"><p class="card-text">
{% set employee_mappings = metadata.details.domain_processing.employee_mappings|default(0) %}
{% if employee_mappings > 0 %}
<span class="text-success"><i class="bi bi-check-circle me-2"></i>{{ employee_mappings }} employee mappings</span>
{% else %}
<span class="text-muted"><i class="bi bi-dash-circle me-2"></i>No employee mappings</span>
{% endif %}
</p></div></div></div><div class="col-md-4 mb-3"><div class="card h-100"><div class="card-header bg-light"><i class="bi bi-geo-alt me-2 text-warning"></i>Locations
</div><div class="card-body"><p class="card-text">
{% set locations = metadata.details.domain_processing.locations|default(0) %}
{% if locations > 0 %}
<span class="text-success"><i class="bi bi-check-circle me-2"></i>{{ locations }} locations detected</span>
{% else %}
<span class="text-muted"><i class="bi bi-dash-circle me-2"></i>No locations detected</span>
{% endif %}
</p></div></div></div></div>

{% elif processor.structure is defined %}
{# JSON file details #}
<h6 class="mb-3">JSON File Information</h6><div class="table-responsive"><table class="table table-bordered"><tr><th class="table-light" style="width: 30%">Structure</th><td>{{ processor.structure|capitalize }}</td></tr>
{% if processor.structure == 'array' %}
<tr><th class="table-light">Item Count</th><td>{{ processor.item_count }}</td></tr>
{% else %}
<tr><th class="table-light">Key Count</th><td>{{ processor.key_count }}</td></tr><tr><th class="table-light">Keys</th><td>
{% for key in processor.keys %}
<span class="badge bg-secondary me-1">{{ key }}</span>
{% endfor %}
</td></tr>
{% endif %}
</table></div>
{% elif processor.row_count is defined %}
{# CSV file details #}
<h6 class="mb-3">CSV File Information</h6><div class="table-responsive"><table class="table table-bordered"><tr><th class="table-light" style="width: 30%">Rows</th><td>{{ processor.row_count }}</td></tr><tr><th class="table-light">Columns</th><td>{{ processor.column_count }}</td></tr><tr><th class="table-light">Column Names</th><td>
{% for col in processor.columns %}
<span class="badge bg-secondary me-1">{{ col }}</span>
{% endfor %}
</td></tr></table></div>
{% else %}
<div class="alert alert-info"><i class="bi bi-info-circle-fill me-2"></i>
File was processed successfully but detailed information is not available.
</div>
{% endif %}
{% else %}
<div class="alert alert-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>
{{ processor.error|default('Processing failed with no additional details') }}
</div>
{% endif %}
</div></div>
{% endif %}

{% if metadata.details and metadata.details.domain_processing %}
<div class="card mb-4"><div class="card-header bg-dark text-white"><h5 class="mb-0">Domain-Specific Processing</h5></div><div class="card-body">
{% set domain = metadata.details.domain_processing %}

{% if domain.success %}
<div class="alert alert-success"><i class="bi bi-check-circle-fill me-2"></i>
{{ domain.message|default('Domain processing completed successfully') }}
</div>

{% if domain.stats %}
<h6 class="mb-3">Processing Statistics</h6><div class="table-responsive"><table class="table table-bordered table-sm"><tbody>
{% for key, value in domain.stats.items() %}
<tr><th class="table-light">{{ key|replace('_', ' ')|capitalize }}</th><td>{{ value }}</td></tr>
{% endfor %}
</tbody></table></div>
{% endif %}

{% if domain.actions %}
<h6 class="mb-3">Actions Taken</h6><ul class="list-group mb-3">
{% for action in domain.actions %}
<li class="list-group-item"><i class="bi bi-arrow-right me-2 text-primary"></i>
{{ action }}
</li>
{% endfor %}
</ul>
{% endif %}
{% else %}
<div class="alert alert-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>
{{ domain.message|default('Domain processing failed with no additional details') }}
</div>

{% if domain.error %}
<div class="card bg-light"><div class="card-body"><h6 class="card-title">Error Details</h6><code>{{ domain.error }}</code></div></div>
{% endif %}
{% endif %}
</div></div>
{% endif %}
</div><div class="col-lg-4"><div class="card mb-4"><div class="card-header bg-dark text-white"><h5 class="mb-0">Actions</h5></div><div class="card-body"><div class="d-grid gap-2"><a href="{{ url_for('parser.upload') }}" class="btn btn-outline-primary"><i class="bi bi-upload me-2"></i>Upload Another File
</a>

{% if metadata.success %}
<a href="{{ url_for('parser.result', file_path=file_path) }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-clockwise me-2"></i>Refresh Results
</a><a href="#" class="btn btn-outline-success" id="reprocessBtn"><i class="bi bi-cpu me-2"></i>Reprocess File
</a>
{% endif %}

<a href="{{ url_for('index') }}" class="btn btn-outline-dark"><i class="bi bi-house me-2"></i>Return to Dashboard
</a></div></div></div><div class="card mb-4"><div class="card-header bg-dark text-white"><h5 class="mb-0">Audit Information</h5></div><div class="card-body"><div class="mb-3"><label class="form-label text-muted">Processed By</label><div>
{% if metadata.user_id %}
<span class="badge bg-info">User ID: {{ metadata.user_id }}</span>
{% else %}
<span class="text-muted">System Process</span>
{% endif %}
</div></div><div class="mb-3"><label class="form-label text-muted">Processing Date/Time</label><div>{{ metadata.timestamp|default('N/A') }}</div></div>

{% if metadata.details and metadata.details.backup_path %}
<div class="mb-3"><label class="form-label text-muted">Backup Location</label><div class="text-truncate"><small>{{ metadata.details.backup_path }}</small></div></div>
{% endif %}

<hr><div class="text-center"><a href="#" class="btn btn-sm btn-outline-secondary" id="viewAuditTrailBtn"><i class="bi bi-clock-history me-2"></i>View Full Audit Trail
</a></div></div></div></div></div></div><script>
document.addEventListener('DOMContentLoaded', function() {
// Handle reprocess button
const reprocessBtn = document.getElementById('reprocessBtn');
if (reprocessBtn) {
reprocessBtn.addEventListener('click', function(e) {
e.preventDefault();
if (confirm('Are you sure you want to reprocess this file?')) {
// Show loading state
reprocessBtn.disabled = true;
reprocessBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Reprocessing...';

// Send AJAX request to reprocess
fetch('{{ url_for("parser.reprocess") }}?file_path={{ file_path|urlencode }}', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
}
})
.then(response => response.json())
.then(data => {
if (data.success) {
// Redirect to result page
window.location.href = data.redirect_url;
} else {
alert('Error reprocessing file: ' + data.message);
reprocessBtn.disabled = false;
reprocessBtn.innerHTML = '<i class="bi bi-cpu me-2"></i>Reprocess File';
}
})
.catch(error => {
console.error('Error:', error);
alert('An error occurred while reprocessing the file');
reprocessBtn.disabled = false;
reprocessBtn.innerHTML = '<i class="bi bi-cpu me-2"></i>Reprocess File';
});
}
});
}

// Handle audit trail button
const viewAuditTrailBtn = document.getElementById('viewAuditTrailBtn');
if (viewAuditTrailBtn) {
viewAuditTrailBtn.addEventListener('click', function(e) {
e.preventDefault();
alert('Audit trail feature is coming soon!');
});
}
});
</script>
{% endblock %}
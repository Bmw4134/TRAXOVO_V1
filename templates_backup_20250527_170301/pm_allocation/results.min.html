{% extends "base.html" %}

{% block title %}PM Allocation Results | TRAXORA{% endblock %}

{% block content %}
<div class="container pt-4"><h1 class="mb-4">PM Allocation Results</h1><div class="card mb-4"><div class="card-header"><h5>Processing Results</h5></div><div class="card-body"><p class="lead">Here are the results of the PM allocation processing.</p><div class="alert alert-success"><i class="bi bi-check-circle-fill me-2"></i>
PM allocation files were successfully processed on {{ summary.processing_date }}.
</div><h6 class="mt-4">Summary</h6><div class="row g-4 mt-2"><div class="col-md-4"><div class="card text-white bg-primary"><div class="card-body"><h5 class="card-title">Files Processed</h5><p class="card-text display-4">{{ summary.total_files }}</p><small>Base File: {{ summary.base_file }}</small></div></div></div><div class="col-md-4"><div class="card text-white bg-success"><div class="card-body"><h5 class="card-title">Changes Applied</h5><p class="card-text display-4">{{ summary.total_changes }}</p><small>Across {{ summary.changed_jobs|length }} jobs</small></div></div></div><div class="col-md-4"><div class="card text-white bg-info"><div class="card-body"><h5 class="card-title">Total Difference</h5><p class="card-text display-4">
{% if results.changes %}
{% set total = 0 %}
{% for change in results.changes %}
{% set total = total + change.difference %}
{% endfor %}
${{ '%0.2f'|format(total) }}
{% else %}
$0.00
{% endif %}
</p></div></div></div></div>

{% if results.changes %}
<h6 class="mt-4">Changed Jobs</h6><div class="table-responsive mt-3"><table class="table table-striped table-hover"><thead><tr><th>Job Number</th><th>Changes</th><th>Total Difference</th></tr></thead><tbody>
{% for job in summary.changed_jobs %}
{% set job_changes = [] %}
{% set job_diff = 0 %}
{% for change in results.changes %}
{% if change.job_number == job %}
{% set job_changes = job_changes + [change] %}
{% set job_diff = job_diff + change.difference %}
{% endif %}
{% endfor %}
<tr><td>{{ job }}</td><td>{{ job_changes|length }}</td><td>${{ '%0.2f'|format(job_diff) }}</td></tr>
{% endfor %}
</tbody></table></div>
{% endif %}

<div class="mt-4"><a href="{{ url_for('pm_allocation.pm_master_billing') }}" class="btn btn-success"><i class="bi bi-download me-1"></i> Download Report
</a><a href="{{ url_for('pm_allocation.pm_allocation_processor') }}" class="btn btn-outline-primary ms-2"><i class="bi bi-arrow-repeat me-1"></i> Process Again
</a></div></div></div></div>
{% endblock %}
{% extends 'base.html' %}

{% block title %}Attendance Trends - SYSTEMSMITH{% endblock %}

{% block extra_css %}
<style>
    .trend-card {
        transition: all 0.3s ease;
    }
    .trend-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .trend-up {
        color: #dc3545;
    }
    .trend-down {
        color: #28a745;
    }
    .trend-neutral {
        color: #6c757d;
    }
    .chart-container {
        height: 300px;
        margin-bottom: 20px;
    }
    .trend-value {
        font-size: 2rem;
        font-weight: bold;
    }
    .trend-label {
        font-size: 0.9rem;
        text-transform: uppercase;
    }
    .trend-period {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .trend-percentage {
        font-size: 0.9rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Attendance Analytics & Trends</h1>
        <div>
            <span class="badge bg-info">
                Data Updated: {{ last_updated }}
            </span>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filter-form" class="row g-3">
                <div class="col-md-3">
                    <label for="date-range" class="form-label">Date Range</label>
                    <select class="form-select" id="date-range" name="date_range">
                        <option value="7" {% if date_range == 7 %}selected{% endif %}>Last 7 Days</option>
                        <option value="14" {% if date_range == 14 %}selected{% endif %}>Last 14 Days</option>
                        <option value="30" {% if date_range == 30 %}selected{% endif %}>Last 30 Days</option>
                        <option value="90" {% if date_range == 90 %}selected{% endif %}>Last 90 Days</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status-type" class="form-label">Status Type</label>
                    <select class="form-select" id="status-type" name="status_type">
                        <option value="all" {% if status_type == 'all' %}selected{% endif %}>All Types</option>
                        <option value="LATE_START" {% if status_type == 'LATE_START' %}selected{% endif %}>Late Start</option>
                        <option value="EARLY_END" {% if status_type == 'EARLY_END' %}selected{% endif %}>Early End</option>
                        <option value="NOT_ON_JOB" {% if status_type == 'NOT_ON_JOB' %}selected{% endif %}>Not On Job</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="job-site" class="form-label">Job Site</label>
                    <select class="form-select" id="job-site" name="job_site">
                        <option value="all" {% if job_site == 'all' %}selected{% endif %}>All Job Sites</option>
                        {% for site in job_sites %}
                        <option value="{{ site.id }}" {% if job_site == site.id %}selected{% endif %}>{{ site.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-filter me-1"></i> Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card trend-card bg-dark h-100">
                <div class="card-body">
                    <h5 class="card-title">Late Starts</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p class="trend-value mb-0">{{ trends.last_week.late_start }}</p>
                            <p class="trend-label mb-0">Last 7 Days</p>
                        </div>
                        <div class="text-end">
                            {% if trends.wow_trends.late_start > 0 %}
                            <p class="trend-percentage trend-up mb-0">
                                <i class="bi bi-arrow-up-right"></i> {{ trends.wow_trends.late_start }}%
                            </p>
                            {% elif trends.wow_trends.late_start < 0 %}
                            <p class="trend-percentage trend-down mb-0">
                                <i class="bi bi-arrow-down-right"></i> {{ trends.wow_trends.late_start|abs }}%
                            </p>
                            {% else %}
                            <p class="trend-percentage trend-neutral mb-0">
                                <i class="bi bi-dash"></i> {{ trends.wow_trends.late_start }}%
                            </p>
                            {% endif %}
                            <p class="trend-period mb-0">vs Previous Week</p>
                        </div>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: {{ (trends.last_week.late_start / total_drivers * 100)|round }}%;" aria-valuenow="{{ (trends.last_week.late_start / total_drivers * 100)|round }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <p class="mt-2 mb-0 small text-muted">{{ (trends.last_week.late_start / total_drivers * 100)|round }}% of total drivers</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card trend-card bg-dark h-100">
                <div class="card-body">
                    <h5 class="card-title">Early Ends</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p class="trend-value mb-0">{{ trends.last_week.early_end }}</p>
                            <p class="trend-label mb-0">Last 7 Days</p>
                        </div>
                        <div class="text-end">
                            {% if trends.wow_trends.early_end > 0 %}
                            <p class="trend-percentage trend-up mb-0">
                                <i class="bi bi-arrow-up-right"></i> {{ trends.wow_trends.early_end }}%
                            </p>
                            {% elif trends.wow_trends.early_end < 0 %}
                            <p class="trend-percentage trend-down mb-0">
                                <i class="bi bi-arrow-down-right"></i> {{ trends.wow_trends.early_end|abs }}%
                            </p>
                            {% else %}
                            <p class="trend-percentage trend-neutral mb-0">
                                <i class="bi bi-dash"></i> {{ trends.wow_trends.early_end }}%
                            </p>
                            {% endif %}
                            <p class="trend-period mb-0">vs Previous Week</p>
                        </div>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ (trends.last_week.early_end / total_drivers * 100)|round }}%;" aria-valuenow="{{ (trends.last_week.early_end / total_drivers * 100)|round }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <p class="mt-2 mb-0 small text-muted">{{ (trends.last_week.early_end / total_drivers * 100)|round }}% of total drivers</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card trend-card bg-dark h-100">
                <div class="card-body">
                    <h5 class="card-title">Not On Job</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p class="trend-value mb-0">{{ trends.last_week.not_on_job }}</p>
                            <p class="trend-label mb-0">Last 7 Days</p>
                        </div>
                        <div class="text-end">
                            {% if trends.wow_trends.not_on_job > 0 %}
                            <p class="trend-percentage trend-up mb-0">
                                <i class="bi bi-arrow-up-right"></i> {{ trends.wow_trends.not_on_job }}%
                            </p>
                            {% elif trends.wow_trends.not_on_job < 0 %}
                            <p class="trend-percentage trend-down mb-0">
                                <i class="bi bi-arrow-down-right"></i> {{ trends.wow_trends.not_on_job|abs }}%
                            </p>
                            {% else %}
                            <p class="trend-percentage trend-neutral mb-0">
                                <i class="bi bi-dash"></i> {{ trends.wow_trends.not_on_job }}%
                            </p>
                            {% endif %}
                            <p class="trend-period mb-0">vs Previous Week</p>
                        </div>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ (trends.last_week.not_on_job / total_drivers * 100)|round }}%;" aria-valuenow="{{ (trends.last_week.not_on_job / total_drivers * 100)|round }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <p class="mt-2 mb-0 small text-muted">{{ (trends.last_week.not_on_job / total_drivers * 100)|round }}% of total drivers</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Trend Charts -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card bg-dark">
                <div class="card-header">
                    <h5 class="card-title mb-0">Attendance Trends Over Time</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="trends-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-dark h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Weekly Comparison</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="weekly-comparison-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Drivers -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-dark">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Top Drivers with Attendance Issues</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active" data-type="LATE_START">Late Starts</button>
                        <button type="button" class="btn btn-outline-secondary" data-type="EARLY_END">Early Ends</button>
                        <button type="button" class="btn btn-outline-secondary" data-type="NOT_ON_JOB">Not On Job</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Driver</th>
                                    <th>Asset</th>
                                    <th>Department</th>
                                    <th>Count</th>
                                    <th>Last Incident</th>
                                    <th>Trend</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="top-drivers-body">
                                {% for driver in top_drivers %}
                                <tr>
                                    <td>{{ driver.name }}</td>
                                    <td>{{ driver.asset.asset_identifier }}</td>
                                    <td>{{ driver.department }}</td>
                                    <td>{{ driver.incident_count }}</td>
                                    <td>{{ driver.last_incident }}</td>
                                    <td>
                                        {% if driver.trend > 0 %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-arrow-up-right"></i> {{ driver.trend }}%
                                        </span>
                                        {% elif driver.trend < 0 %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-arrow-down-right"></i> {{ driver.trend|abs }}%
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-dash"></i> No Change
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary view-driver" data-id="{{ driver.id }}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance by Job Site -->
    <div class="row">
        <div class="col-md-12">
            <div class="card bg-dark">
                <div class="card-header">
                    <h5 class="card-title mb-0">Attendance by Job Site</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="job-site-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Real data from backend for trends chart
        const trendsChart = new Chart(
            document.getElementById('trends-chart'),
            {
                type: 'line',
                data: {
                    labels: {{ chart_data.labels|tojson }},
                    datasets: [
                        {
                            label: 'Late Starts',
                            data: {{ chart_data.late_start|tojson }},
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.2)',
                            tension: 0.3
                        },
                        {
                            label: 'Early Ends',
                            data: {{ chart_data.early_end|tojson }},
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.2)',
                            tension: 0.3
                        },
                        {
                            label: 'Not On Job',
                            data: {{ chart_data.not_on_job|tojson }},
                            borderColor: '#17a2b8',
                            backgroundColor: 'rgba(23, 162, 184, 0.2)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            }
        );

        // Real data from backend for weekly comparison chart
        const weeklyComparisonChart = new Chart(
            document.getElementById('weekly-comparison-chart'),
            {
                type: 'bar',
                data: {
                    labels: {{ weekly_comparison.labels|tojson }},
                    datasets: [
                        {
                            label: 'Late Starts',
                            data: {{ weekly_comparison.counts|tojson }},
                            backgroundColor: 'rgba(220, 53, 69, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    }
                }
            }
        );

        // Real data from backend for job site chart
        const jobSiteChart = new Chart(
            document.getElementById('job-site-chart'),
            {
                type: 'bar',
                data: {
                    labels: {{ job_site_data.labels|tojson }},
                    datasets: [
                        {
                            label: 'Late Starts',
                            data: {{ job_site_data.late_start_data|tojson }},
                            backgroundColor: 'rgba(220, 53, 69, 0.7)'
                        },
                        {
                            label: 'Early Ends',
                            data: {{ job_site_data.early_end_data|tojson }},
                            backgroundColor: 'rgba(255, 193, 7, 0.7)'
                        },
                        {
                            label: 'Not On Job',
                            data: {{ job_site_data.not_on_job_data|tojson }},
                            backgroundColor: 'rgba(23, 162, 184, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        },
                        x: {
                            stacked: true
                        }
                    }
                }
            }
        );

        // Filter event handler
        document.getElementById('filter-form').addEventListener('submit', function(e) {
            e.preventDefault();
            // Replace with actual filter logic in production
            alert('Filter functionality will be implemented in the full version');
        });

        // Top drivers filter event handler
        document.querySelectorAll('[data-type]').forEach(button => {
            button.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                
                // Remove active class from all buttons
                document.querySelectorAll('[data-type]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Replace with actual filter logic in production
                console.log(`Showing top drivers for ${type}`);
            });
        });

        // View driver details event handler
        document.querySelectorAll('.view-driver').forEach(button => {
            button.addEventListener('click', function() {
                const driverId = this.getAttribute('data-id');
                
                // Replace with actual view logic in production
                alert(`View details for driver ID: ${driverId}`);
            });
        });
    });
</script>
{% endblock %}
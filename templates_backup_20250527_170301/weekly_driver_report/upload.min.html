{% extends "layout_unified.html" %}

{% block title %}Upload Files - Weekly Driver Reports{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/">Home</a></li><li class="breadcrumb-item"><a href="{{ url_for('weekly_driver_report.dashboard') }}">Weekly Driver Reports</a></li><li class="breadcrumb-item active" aria-current="page">Upload Files</li>
{% endblock %}

{% block page_title %}Upload Data Files{% endblock %}
{% block page_subtitle %}Upload GPS data, vehicle records, and timecard files for weekly driver reports{% endblock %}

{% block content %}
<div class="row"><div class="col-lg-8 mb-4"><div class="card bg-dark border-0 shadow-sm"><div class="card-header bg-dark"><h5 class="card-title mb-0">Upload Files</h5></div><div class="card-body"><form action="{{ url_for('weekly_driver_report.upload_files') }}" method="post" enctype="multipart/form-data" id="upload-form"><div class="mb-4"><label for="files" class="form-label">Select Files to Upload</label><div class="file-drop-area mb-3"><div class="file-drop-inner text-center py-5"><i class="bi bi-cloud-arrow-up fs-1 text-muted mb-3"></i><h5 class="mb-2">Drag & Drop Files Here</h5><p class="text-muted mb-3">or</p><label class="btn btn-outline-primary mb-0"><span>Browse Files</span><input type="file" name="files[]" id="files" multiple class="hidden-file-input"></label></div></div><div id="file-list" class="list-group list-group-flush bg-dark my-3 d-none"></div><div class="form-text">
Upload GPS tracking data and timecard files. Supported formats: CSV, XLSX.
</div></div><div class="alert alert-info mb-4"><div class="d-flex"><i class="bi bi-info-circle-fill me-3 fs-4"></i><div><h6 class="alert-heading mb-2">Required Files:</h6><ul class="mb-0"><li><strong>DrivingHistory CSVs:</strong> Driver GPS tracking data</li><li><strong>AssetsTimeOnSite CSVs:</strong> Asset location data</li><li><strong>ActivityDetail CSVs (Optional):</strong> Enhanced location data</li><li><strong>Timecard Files (Optional):</strong> For payroll validation</li></ul></div></div></div><div class="alert alert-success mb-4 file-processing-alert d-none"><div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-3" role="status"><span class="visually-hidden">Processing...</span></div><div><h6 class="alert-heading mb-1">Processing Files</h6><p class="mb-0">Please wait while your files are being uploaded and processed...</p></div></div></div><div class="d-grid gap-2 d-md-flex justify-content-md-end"><a href="{{ url_for('weekly_driver_report.dashboard') }}" class="btn btn-outline-secondary">
Cancel
</a><button type="submit" class="btn btn-primary" id="upload-button" disabled><i class="bi bi-upload me-2"></i> Upload Files
</button></div></form></div></div></div><div class="col-lg-4 mb-4"><div class="card bg-dark border-0 shadow-sm mb-4"><div class="card-header bg-dark"><h5 class="card-title mb-0">File Information</h5></div><div class="card-body"><h6 class="mb-3">Supported File Types</h6><div class="mb-3"><div class="d-flex mb-2"><div class="file-type-icon me-3"><i class="bi bi-filetype-csv"></i></div><div><h6 class="mb-1">Driving History (CSV)</h6><p class="text-muted small mb-0">Driver GPS tracking data</p></div></div></div><div class="mb-3"><div class="d-flex mb-2"><div class="file-type-icon me-3"><i class="bi bi-filetype-csv"></i></div><div><h6 class="mb-1">Assets Time On Site (CSV)</h6><p class="text-muted small mb-0">Asset location data</p></div></div></div><div class="mb-3"><div class="d-flex mb-2"><div class="file-type-icon me-3"><i class="bi bi-filetype-csv"></i></div><div><h6 class="mb-1">Activity Detail (CSV)</h6><p class="text-muted small mb-0">Enhanced location data</p></div></div></div><div class="mb-3"><div class="d-flex mb-2"><div class="file-type-icon me-3"><i class="bi bi-filetype-xlsx"></i></div><div><h6 class="mb-1">Timecard File (XLSX)</h6><p class="text-muted small mb-0">For payroll validation</p></div></div></div><div class="alert alert-warning mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Important:</strong> File names should include dates to correctly process data.
</div></div></div><div class="card bg-dark border-0 shadow-sm"><div class="card-header bg-dark"><h5 class="card-title mb-0">Next Steps</h5></div><div class="card-body"><ul class="list-group list-group-flush bg-dark mb-0"><li class="list-group-item bg-dark ps-0"><div class="d-flex"><div class="me-3 text-primary"><i class="bi bi-1-circle-fill"></i></div><div><h6 class="mb-1">Upload Files</h6><p class="text-muted small mb-0">DrivingHistory, AssetsTimeOnSite, etc.</p></div></div></li><li class="list-group-item bg-dark ps-0"><div class="d-flex"><div class="me-3 text-primary"><i class="bi bi-2-circle"></i></div><div><h6 class="mb-1">Generate Report</h6><p class="text-muted small mb-0">Process data and create weekly report</p></div></div></li><li class="list-group-item bg-dark ps-0"><div class="d-flex"><div class="me-3 text-primary"><i class="bi bi-3-circle"></i></div><div><h6 class="mb-1">Review Report</h6><p class="text-muted small mb-0">Analyze driver attendance</p></div></div></li></ul></div></div></div></div>
{% endblock %}

{% block scripts %}
<style>
.file-drop-area {
border: 2px dashed #6c757d;
border-radius: 5px;
position: relative;
}
.file-drop-area.dragover {
border-color: #0d6efd;
background-color: rgba(13, 110, 253, 0.05);
}
.hidden-file-input {
position: absolute;
width: 0;
height: 0;
opacity: 0;
}
.file-type-icon {
font-size: 1.5rem;
min-width: 2rem;
text-align: center;
}
</style><script>
document.addEventListener('DOMContentLoaded', function() {
const dropArea = document.querySelector('.file-drop-area');
const fileInput = document.getElementById('files');
const fileList = document.getElementById('file-list');
const uploadButton = document.getElementById('upload-button');
const uploadForm = document.getElementById('upload-form');
const processingAlert = document.querySelector('.file-processing-alert');

// Highlight drop area when dragging files over it
dropArea.addEventListener('dragover', function(e) {
e.preventDefault();
dropArea.classList.add('dragover');
});

dropArea.addEventListener('dragleave', function() {
dropArea.classList.remove('dragover');
});

dropArea.addEventListener('drop', function(e) {
e.preventDefault();
dropArea.classList.remove('dragover');
fileInput.files = e.dataTransfer.files;
updateFileList();
});

// Update file list when files are selected
fileInput.addEventListener('change', updateFileList);

function updateFileList() {
fileList.innerHTML = '';

if (fileInput.files.length > 0) {
fileList.classList.remove('d-none');
uploadButton.disabled = false;

// Categorize files
const fileCategories = {
'DrivingHistory': [],
'AssetsTimeOnSite': [],
'ActivityDetail': [],
'Timecard': [],
'Other': []
};

// Group files by type
Array.from(fileInput.files).forEach(file => {
const fileName = file.name.toLowerCase();

if (fileName.includes('driving') || fileName.includes('drivinghistory')) {
fileCategories['DrivingHistory'].push(file);
} else if (fileName.includes('timeonsite') || fileName.includes('assetstimeonsite')) {
fileCategories['AssetsTimeOnSite'].push(file);
} else if (fileName.includes('activity') || fileName.includes('activitydetail')) {
fileCategories['ActivityDetail'].push(file);
} else if (fileName.includes('timecard') || fileName.includes('hours')) {
fileCategories['Timecard'].push(file);
} else {
fileCategories['Other'].push(file);
}
});

// Add files to list with category headers
for (const [category, files] of Object.entries(fileCategories)) {
if (files.length > 0) {
// Add category header
const categoryHeader = document.createElement('div');
categoryHeader.className = 'list-group-item bg-dark text-primary fw-bold';
categoryHeader.textContent = category + ` Files (${files.length})`;
fileList.appendChild(categoryHeader);

// Add files
files.forEach(file => {
const fileItem = document.createElement('div');
fileItem.className = 'list-group-item bg-dark';

const fileSize = (file.size / 1024).toFixed(1);

fileItem.innerHTML = `
<div class="d-flex align-items-center"><div class="me-3"><i class="bi bi-${file.name.endsWith('.xlsx') ? 'filetype-xlsx' : 'filetype-csv'}"></i></div><div class="flex-grow-1"><div class="d-flex justify-content-between"><span>${file.name}</span><small class="text-muted">${fileSize} KB</small></div></div></div>
`;

fileList.appendChild(fileItem);
});
}
}

// Check for required file types
const hasRequired = fileCategories['DrivingHistory'].length > 0 ||
fileCategories['AssetsTimeOnSite'].length > 0;

if (!hasRequired) {
const warningItem = document.createElement('div');
warningItem.className = 'alert alert-warning mt-3 mb-0';
warningItem.innerHTML = `
<i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Warning:</strong> Missing required file types (DrivingHistory or AssetsTimeOnSite).
`;
fileList.appendChild(warningItem);
}
} else {
fileList.classList.add('d-none');
uploadButton.disabled = true;
}
}

// Show processing message on form submit
uploadForm.addEventListener('submit', function() {
processingAlert.classList.remove('d-none');
uploadButton.disabled = true;
});
});
</script>
{% endblock %}
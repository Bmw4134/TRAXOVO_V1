<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Trading Intelligence - TRAXOVO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .trading-metrics {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .strategy-card {
            border-left: 4px solid;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }
        
        .strategy-card.momentum { border-left-color: #28a745; }
        .strategy-card.reversal { border-left-color: #dc3545; }
        .strategy-card.volatility { border-left-color: #ffc107; }
        .strategy-card.arbitrage { border-left-color: #17a2b8; }
        .strategy-card.mean-reversion { border-left-color: #6f42c1; }
        
        .trade-log {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .trade-entry {
            border-bottom: 1px solid #dee2e6;
            padding: 10px 0;
        }
        
        .trade-entry:last-child {
            border-bottom: none;
        }
        
        .pnl-positive { color: #28a745; font-weight: bold; }
        .pnl-negative { color: #dc3545; font-weight: bold; }
        .pnl-neutral { color: #6c757d; }
        
        .perplexity-gauge {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(#28a745 0deg, #28a745 var(--perplexity-deg), #e9ecef var(--perplexity-deg), #e9ecef 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .perplexity-inner {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .risk-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .risk-low { background: #d4edda; color: #155724; }
        .risk-medium { background: #fff3cd; color: #856404; }
        .risk-high { background: #f8d7da; color: #721c24; }
        
        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .control-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('quantum_dashboard') }}">
                <i class="fas fa-chart-line me-2"></i>
                TRAXOVO Trading Intelligence
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('quantum_dashboard') }}">
                    <i class="fas fa-tachometer-alt me-1"></i>
                    Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('accessibility_dashboard') }}">
                    <i class="fas fa-universal-access me-1"></i>
                    Accessibility
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Portfolio Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="trading-metrics">
                    <div class="row">
                        <div class="col-md-3">
                            <h3 class="h5 mb-2">Portfolio Value</h3>
                            <div class="h2" id="portfolio-value">$100,000.00</div>
                            <small id="portfolio-change">+0.00%</small>
                        </div>
                        <div class="col-md-3">
                            <h3 class="h5 mb-2">Daily P&L</h3>
                            <div class="h2" id="daily-pnl">$0.00</div>
                            <small id="pnl-change">Today</small>
                        </div>
                        <div class="col-md-3">
                            <h3 class="h5 mb-2">Total Trades</h3>
                            <div class="h2" id="total-trades">0</div>
                            <small id="win-rate">0% Win Rate</small>
                        </div>
                        <div class="col-md-3">
                            <h3 class="h5 mb-2">Live Status</h3>
                            <div class="h4">
                                <span class="live-indicator"></span>
                                <span id="live-status">Active</span>
                            </div>
                            <small id="last-update">Just updated</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Control Panel -->
            <div class="col-lg-4">
                <div class="control-panel">
                    <h4 class="mb-3">
                        <i class="fas fa-cogs me-2"></i>
                        Trading Controls
                    </h4>
                    
                    <div class="mb-3">
                        <button class="btn btn-success w-100" id="run-cycle-btn">
                            <i class="fas fa-play me-2"></i>
                            Execute Trading Cycle
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Trading Symbols</label>
                        <select class="form-select" id="symbol-select" multiple>
                            <option value="BTCUSDT" selected>BTC/USDT</option>
                            <option value="ETHUSDT" selected>ETH/USDT</option>
                            <option value="ADAUSDT">ADA/USDT</option>
                            <option value="BNBUSDT">BNB/USDT</option>
                            <option value="SOLUSDT">SOL/USDT</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto-trading" checked>
                            <label class="form-check-label" for="auto-trading">
                                Auto Trading Mode
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="risk-management" checked>
                            <label class="form-check-label" for="risk-management">
                                Risk Management
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Perplexity Monitor -->
                <div class="control-panel">
                    <h5 class="mb-3">Perplexity Signal</h5>
                    <div class="text-center">
                        <div class="perplexity-gauge mx-auto mb-3" id="perplexity-gauge">
                            <div class="perplexity-inner">
                                <div class="h4 mb-0" id="perplexity-value">15.2</div>
                                <small class="text-muted">Score</small>
                            </div>
                        </div>
                        <div id="perplexity-status" class="small text-muted">Monitoring signals...</div>
                    </div>
                </div>

                <!-- Risk Status -->
                <div class="control-panel">
                    <h5 class="mb-3">Risk Status</h5>
                    <div class="mb-2">
                        <small class="text-muted">Current Drawdown</small>
                        <div class="progress mb-1">
                            <div class="progress-bar" id="drawdown-bar" style="width: 0%"></div>
                        </div>
                        <small id="drawdown-text">0.00%</small>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Daily Loss Limit</small>
                        <div class="progress mb-1">
                            <div class="progress-bar bg-warning" id="daily-loss-bar" style="width: 0%"></div>
                        </div>
                        <small id="daily-loss-text">0.00%</small>
                    </div>
                </div>
            </div>

            <!-- Main Trading Area -->
            <div class="col-lg-8">
                <!-- Active Strategies -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-brain me-2"></i>
                            Active Strategies
                        </h5>
                    </div>
                    <div class="card-body" id="active-strategies">
                        <div class="text-muted text-center py-3">
                            No active strategies. Execute a trading cycle to begin.
                        </div>
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>
                            Portfolio Performance
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="performance-chart" height="100"></canvas>
                    </div>
                </div>

                <!-- Recent Trades -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Trade Log
                        </h5>
                        <span class="badge bg-primary" id="trade-count">0 trades</span>
                    </div>
                    <div class="card-body">
                        <div class="trade-log" id="trade-log">
                            <div class="text-muted text-center py-3">
                                No trades executed yet.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class TradingIntelligenceDashboard {
            constructor() {
                this.isAutoTrading = true;
                this.performanceChart = null;
                this.tradingData = {
                    portfolio_value: 100000,
                    daily_pnl: 0,
                    total_trades: 0,
                    win_rate: 0
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initializeChart();
                this.loadDashboardData();
                this.startAutoUpdate();
                console.log('Trading Intelligence Dashboard initialized');
            }

            setupEventListeners() {
                document.getElementById('run-cycle-btn').addEventListener('click', () => {
                    this.executeTradingCycle();
                });

                document.getElementById('auto-trading').addEventListener('change', (e) => {
                    this.isAutoTrading = e.target.checked;
                    if (this.isAutoTrading) {
                        this.startAutoTrading();
                    } else {
                        this.stopAutoTrading();
                    }
                });
            }

            initializeChart() {
                const ctx = document.getElementById('performance-chart').getContext('2d');
                this.performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Portfolio Value',
                            data: [],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            async loadDashboardData() {
                try {
                    const response = await fetch('/api/trading-dashboard-data');
                    const data = await response.json();
                    
                    if (data.error) {
                        console.error('Dashboard data error:', data.error);
                        return;
                    }
                    
                    this.updateDashboard(data);
                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                }
            }

            async executeTradingCycle() {
                const button = document.getElementById('run-cycle-btn');
                const originalText = button.innerHTML;
                
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Executing...';
                button.disabled = true;
                
                try {
                    const symbols = Array.from(document.getElementById('symbol-select').selectedOptions)
                        .map(option => option.value);
                    
                    const response = await fetch('/api/trading-cycle', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ symbols })
                    });
                    
                    const results = await response.json();
                    
                    if (results.error) {
                        throw new Error(results.error);
                    }
                    
                    this.processCycleResults(results);
                    this.loadDashboardData(); // Refresh dashboard
                    
                } catch (error) {
                    console.error('Trading cycle error:', error);
                    alert('Trading cycle failed: ' + error.message);
                } finally {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }

            processCycleResults(results) {
                // Update active strategies
                this.updateActiveStrategies(results.strategies_activated || []);
                
                // Update trade log
                this.updateTradeLog(results.trades_executed || []);
                
                // Update perplexity display
                if (results.perplexity_signals) {
                    this.updatePerplexityGauge(results.perplexity_signals.perplexity_min || 0);
                }
                
                // Update risk status
                if (results.risk_status) {
                    this.updateRiskStatus(results.risk_status);
                }
            }

            updateDashboard(data) {
                const portfolio = data.portfolio_status || {};
                
                // Update portfolio metrics
                document.getElementById('portfolio-value').textContent = 
                    '$' + (portfolio.current_capital || 100000).toLocaleString();
                
                const returnPct = portfolio.total_return_pct || 0;
                const portfolioChange = document.getElementById('portfolio-change');
                portfolioChange.textContent = (returnPct >= 0 ? '+' : '') + returnPct.toFixed(2) + '%';
                portfolioChange.className = returnPct >= 0 ? 'pnl-positive' : 'pnl-negative';
                
                document.getElementById('daily-pnl').textContent = 
                    '$' + (portfolio.daily_pnl || 0).toFixed(2);
                
                document.getElementById('total-trades').textContent = 
                    data.total_trades || 0;
                
                // Calculate win rate from strategy performance
                let totalTrades = 0;
                let winningTrades = 0;
                
                if (data.strategy_performance) {
                    Object.values(data.strategy_performance).forEach(strategy => {
                        totalTrades += strategy.total_trades || 0;
                        winningTrades += strategy.winning_trades || 0;
                    });
                }
                
                const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100) : 0;
                document.getElementById('win-rate').textContent = winRate.toFixed(1) + '% Win Rate';
                
                // Update chart
                this.updatePerformanceChart(portfolio.current_capital || 100000);
                
                // Update last update time
                document.getElementById('last-update').textContent = 'Updated ' + new Date().toLocaleTimeString();
            }

            updateActiveStrategies(strategies) {
                const container = document.getElementById('active-strategies');
                
                if (strategies.length === 0) {
                    container.innerHTML = '<div class="text-muted text-center py-3">No active strategies</div>';
                    return;
                }
                
                const uniqueStrategies = [...new Set(strategies)];
                const strategyCards = uniqueStrategies.map(strategy => {
                    const strategyClass = this.getStrategyClass(strategy);
                    const riskLevel = this.getStrategyRiskLevel(strategy);
                    
                    return `
                        <div class="strategy-card ${strategyClass}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${this.formatStrategyName(strategy)}</h6>
                                    <small class="text-muted">Active signal detected</small>
                                </div>
                                <span class="risk-indicator risk-${riskLevel}">${riskLevel} risk</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = strategyCards;
            }

            updateTradeLog(trades) {
                const container = document.getElementById('trade-log');
                
                if (trades.length === 0) {
                    return; // Don't clear existing trades
                }
                
                const tradeEntries = trades.map(trade => {
                    const tradeData = trade.trade || {};
                    const timestamp = new Date(trade.execution_time).toLocaleTimeString();
                    
                    return `
                        <div class="trade-entry">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${tradeData.action} ${tradeData.symbol}</strong>
                                    <div class="small text-muted">
                                        ${tradeData.quantity} @ $${tradeData.price} 
                                        <span class="badge bg-secondary ms-2">${trade.strategy}</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="small text-muted">${timestamp}</div>
                                    <div class="small">
                                        <span class="badge bg-${trade.status === 'executed' ? 'success' : 'warning'}">
                                            ${trade.status}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Prepend new trades
                container.innerHTML = tradeEntries + container.innerHTML;
                
                // Update trade count
                const currentCount = container.querySelectorAll('.trade-entry').length;
                document.getElementById('trade-count').textContent = currentCount + ' trades';
            }

            updatePerplexityGauge(value) {
                const gauge = document.getElementById('perplexity-gauge');
                const valueElement = document.getElementById('perplexity-value');
                const statusElement = document.getElementById('perplexity-status');
                
                valueElement.textContent = value.toFixed(1);
                
                // Update gauge visual (0-30 scale)
                const percentage = Math.min(value / 30, 1);
                const degrees = percentage * 360;
                gauge.style.setProperty('--perplexity-deg', degrees + 'deg');
                
                // Update status
                if (value > 20) {
                    statusElement.textContent = 'High perplexity - Strong signals';
                    statusElement.className = 'small text-success';
                } else if (value > 15) {
                    statusElement.textContent = 'Medium perplexity - Moderate signals';
                    statusElement.className = 'small text-warning';
                } else {
                    statusElement.textContent = 'Low perplexity - Weak signals';
                    statusElement.className = 'small text-muted';
                }
            }

            updateRiskStatus(riskData) {
                const drawdownPct = riskData.drawdown_pct || 0;
                const dailyLossPct = Math.abs(riskData.daily_pnl || 0) / 100000 * 100; // Assuming 100k initial
                
                // Update drawdown bar
                document.getElementById('drawdown-bar').style.width = Math.min(drawdownPct / 10 * 100, 100) + '%';
                document.getElementById('drawdown-text').textContent = drawdownPct.toFixed(2) + '%';
                
                // Update daily loss bar
                document.getElementById('daily-loss-bar').style.width = Math.min(dailyLossPct / 5 * 100, 100) + '%';
                document.getElementById('daily-loss-text').textContent = dailyLossPct.toFixed(2) + '%';
            }

            updatePerformanceChart(currentValue) {
                const chart = this.performanceChart;
                const now = new Date().toLocaleTimeString();
                
                chart.data.labels.push(now);
                chart.data.datasets[0].data.push(currentValue);
                
                // Keep only last 20 data points
                if (chart.data.labels.length > 20) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }
                
                chart.update('none'); // No animation for real-time updates
            }

            getStrategyClass(strategy) {
                const classMap = {
                    'momentum_breakout': 'momentum',
                    'spoof_reversal': 'reversal',
                    'volatility_eruption': 'volatility',
                    'delta_arbitrage': 'arbitrage',
                    'mean_reversion': 'mean-reversion'
                };
                return classMap[strategy] || 'momentum';
            }

            getStrategyRiskLevel(strategy) {
                const riskMap = {
                    'momentum_breakout': 'medium',
                    'spoof_reversal': 'high',
                    'volatility_eruption': 'high',
                    'delta_arbitrage': 'low',
                    'mean_reversion': 'low'
                };
                return riskMap[strategy] || 'medium';
            }

            formatStrategyName(strategy) {
                return strategy.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            startAutoTrading() {
                if (this.autoTradingInterval) {
                    clearInterval(this.autoTradingInterval);
                }
                
                this.autoTradingInterval = setInterval(() => {
                    if (this.isAutoTrading) {
                        this.executeTradingCycle();
                    }
                }, 30000); // Execute every 30 seconds
                
                console.log('Auto trading started');
            }

            stopAutoTrading() {
                if (this.autoTradingInterval) {
                    clearInterval(this.autoTradingInterval);
                    this.autoTradingInterval = null;
                }
                console.log('Auto trading stopped');
            }

            startAutoUpdate() {
                setInterval(() => {
                    this.loadDashboardData();
                }, 10000); // Update every 10 seconds
            }
        }

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.tradingDashboard = new TradingIntelligenceDashboard();
        });
    </script>
</body>
</html>